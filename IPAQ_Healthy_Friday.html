
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuestionario IPAQ - Actividad Física</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100">
    <div id="root" class="min-h-screen"></div>

    <script type="text/babel">
        // --- Inicialización de Firebase ---
        const firebaseConfig = {
          apiKey: "AIzaSyA0N0xPkSDJwkj-BMq01THtK4fZFeSq4uk",
          authDomain: "cuestionario-ipaq.firebaseapp.com",
          projectId: "cuestionario-ipaq",
          storageBucket: "cuestionario-ipaq.firebasestorage.app",
          messagingSenderId: "368431872747",
          appId: "1:368431872747:web:c952fcc39f191fb24cdcae",
          measurementId: "G-DM6Z00NBWC"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // --- Fin de Inicialización ---

        const { useState, useEffect } = React;

        const App = () => {
            const [currentStep, setCurrentStep] = useState(0);
            const [userData, setUserData] = useState({
                nombre: '',
                edad: '',
                curso: '',
                sexo: '',
                peso: '',
                fecha: new Date().toISOString().split('T')[0],
                q1: '',
                q2Hours: '',
                q2Minutes: '',
                q3: '',
                q4Hours: '',
                q4Minutes: '',
                q5: '',
                q6Hours: '',
                q6Minutes: '',
                q7Hours: '',
                q7Minutes: ''
            });
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true); // Estado para manejar la carga de datos
            const [showReport, setShowReport] = useState(false);
            const [selectedUser, setSelectedUser] = useState(null);
            const [reportData, setReportData] = useState(null);
            const [filter, setFilter] = useState({ type: 'all', value: '' });
            const [showAnalysis, setShowAnalysis] = useState(false);
            const [analysisType, setAnalysisType] = useState('');
            const [analysisData, setAnalysisData] = useState(null);

            // Cargar datos desde Firestore al iniciar
            useEffect(() => {
                const unsubscribe = db.collection('encuestas').onSnapshot(
                    (snapshot) => {
                        const usersArray = [];
                        snapshot.forEach((doc) => {
                            usersArray.push({ id: doc.id, ...doc.data() });
                        });
                        setUsers(usersArray);
                        setLoading(false);
                    },
                    (error) => {
                        console.error("Error obteniendo documentos: ", error);
                        setLoading(false);
                    }
                );

                return () => unsubscribe();
            }, []);

            const handleInputChange = (field, value) => {
                setUserData(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const calculateReport = (data) => {
                // Cálculos según IPAQ
                const vpaDays = parseInt(data.q1) || 0;
                const vpaHours = parseInt(data.q2Hours) || 0;
                const vpaMinutes = parseInt(data.q2Minutes) || 0;
                const vpaTotalMinutes = vpaDays * (vpaHours * 60 + vpaMinutes);
                const vpaMET = 8 * vpaTotalMinutes;

                const mpaDays = parseInt(data.q3) || 0;
                const mpaHours = parseInt(data.q4Hours) || 0;
                const mpaMinutes = parseInt(data.q4Minutes) || 0;
                const mpaTotalMinutes = mpaDays * (mpaHours * 60 + mpaMinutes);
                const mpaMET = 4 * mpaTotalMinutes;

                const walkDays = parseInt(data.q5) || 0;
                const walkHours = parseInt(data.q6Hours) || 0;
                const walkMinutes = parseInt(data.q6Minutes) || 0;
                const walkTotalMinutes = walkDays * (walkHours * 60 + walkMinutes);
                const walkMET = 3.3 * walkTotalMinutes;

                const totalMET = vpaMET + mpaMET + walkMET;
                const totalKcal = totalMET * 0.0175; // Aproximación

                // Clasificación de nivel de actividad
                let level = 'BAJO';
                if (totalMET >= 3000 || (vpaDays >= 3 && vpaTotalMinutes >= 1500)) {
                    level = 'ALTO';
                } else if (
                    (vpaDays >= 3 && vpaHours >= 1/3) || 
                    (mpaDays >= 5 && mpaHours >= 1/2) || 
                    (mpaDays >= 5 && totalMET >= 600)
                ) {
                    level = 'MODERADO';
                }

                return {
                    vpaMET,
                    mpaMET,
                    walkMET,
                    totalMET,
                    totalKcal,
                    level,
                    vpaTotalMinutes,
                    mpaTotalMinutes,
                    walkTotalMinutes
                };
            };

            const handleNext = () => {
                if (currentStep < 7) {
                    setCurrentStep(currentStep + 1);
                } else {
                    // Finalizar encuesta
                    const calculatedReport = calculateReport(userData);
                    const newUser = {
                        ...userData,
                        id: Date.now(), // Este ID temporal se puede reemplazar con el ID de Firestore
                        report: calculatedReport
                    };
                    
                    // Guardar en Firestore
                    db.collection('encuestas').add(newUser)
                        .then((docRef) => {
                            console.log("Documento escrito con ID: ", docRef.id);
                        })
                        .catch((error) => {
                            console.error("Error al añadir el documento: ", error);
                        });
                    
                    setReportData(calculatedReport);
                    setShowReport(true);
                }
            };

            const handleBack = () => {
                if (currentStep > 0) {
                    setCurrentStep(currentStep - 1);
                }
            };

            const resetForm = () => {
                setUserData({
                    nombre: '',
                    edad: '',
                    curso: '',
                    sexo: '',
                    peso: '',
                    fecha: new Date().toISOString().split('T')[0],
                    q1: '',
                    q2Hours: '',
                    q2Minutes: '',
                    q3: '',
                    q4Hours: '',
                    q4Minutes: '',
                    q5: '',
                    q6Hours: '',
                    q6Minutes: '',
                    q7Hours: '',
                    q7Minutes: ''
                });
                setCurrentStep(0);
                setShowReport(false);
                setReportData(null);
            };

            const exportToCSV = (data = users) => {
                if (data.length === 0) return;

                const headers = [
                    'ID', 'Nombre', 'Edad', 'Curso', 'Sexo', 'Peso', 'Fecha',
                    'Días VPA', 'Minutos VPA', 'Días MPA', 'Minutos MPA',
                    'Días Caminar', 'Minutos Caminar', 'Minutos Sentado',
                    'VPA MET', 'MPA MET', 'Caminar MET', 'Total MET',
                    'Total Kcal', 'Nivel'
                ];

                const csvContent = [
                    headers.join(','),
                    ...data.map(user => [
                        user.id,
                        `"${user.nombre}"`,
                        user.edad,
                        user.curso,
                        user.sexo,
                        user.peso,
                        user.fecha,
                        user.q1,
                        (parseInt(user.q1) || 0) * ((parseInt(user.q2Hours) || 0) * 60 + (parseInt(user.q2Minutes) || 0)),
                        user.q3,
                        (parseInt(user.q3) || 0) * ((parseInt(user.q4Hours) || 0) * 60 + (parseInt(user.q4Minutes) || 0)),
                        user.q5,
                        (parseInt(user.q5) || 0) * ((parseInt(user.q6Hours) || 0) * 60 + (parseInt(user.q6Minutes) || 0)),
                        (parseInt(user.q7Hours) || 0) * 60 + (parseInt(user.q7Minutes) || 0),
                        user.report.vpaMET,
                        user.report.mpaMET,
                        user.report.walkMET,
                        user.report.totalMET,
                        user.report.totalKcal.toFixed(2),
                        user.report.level
                    ].join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'ipa_datos.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const getFilteredUsers = () => {
                switch (filter.type) {
                    case 'age':
                        return users.filter(user => {
                            const age = parseInt(user.edad);
                            const [min, max] = filter.value.split('-').map(Number);
                            return age >= min && age <= max;
                        });
                    case 'activity':
                        return users.filter(user => user.report.level === filter.value);
                    default:
                        return users;
                }
            };

            const performAnalysis = () => {
                if (!analysisType) return;

                let analysisResult = null;

                switch (analysisType) {
                    case 'ageRange':
                        const ageRanges = {
                            '15-25': users.filter(u => parseInt(u.edad) >= 15 && parseInt(u.edad) <= 25),
                            '26-35': users.filter(u => parseInt(u.edad) >= 26 && parseInt(u.edad) <= 35),
                            '36-45': users.filter(u => parseInt(u.edad) >= 36 && parseInt(u.edad) <= 45),
                            '46-59': users.filter(u => parseInt(u.edad) >= 46 && parseInt(u.edad) <= 59),
                            '60-69': users.filter(u => parseInt(u.edad) >= 60 && parseInt(u.edad) <= 69)
                        };
                        
                        analysisResult = Object.keys(ageRanges).map(range => ({
                            range,
                            count: ageRanges[range].length,
                            avgAge: ageRanges[range].length > 0 
                                ? (ageRanges[range].reduce((sum, u) => sum + parseInt(u.edad), 0) / ageRanges[range].length).toFixed(1) 
                                : 0,
                            avgWeight: ageRanges[range].length > 0 
                                ? (ageRanges[range].reduce((sum, u) => sum + parseFloat(u.peso), 0) / ageRanges[range].length).toFixed(1) 
                                : 0,
                            activityLevels: {
                                ALTO: ageRanges[range].filter(u => u.report.level === 'ALTO').length,
                                MODERADO: ageRanges[range].filter(u => u.report.level === 'MODERADO').length,
                                BAJO: ageRanges[range].filter(u => u.report.level === 'BAJO').length
                            }
                        }));
                        break;
                        
                    case 'course':
                        const courses = [...new Set(users.map(u => u.curso))];
                        analysisResult = courses.map(course => {
                            const courseUsers = users.filter(u => u.curso === course);
                            return {
                                course,
                                count: courseUsers.length,
                                avgAge: courseUsers.length > 0 
                                    ? (courseUsers.reduce((sum, u) => sum + parseInt(u.edad), 0) / courseUsers.length).toFixed(1) 
                                    : 0,
                                avgWeight: courseUsers.length > 0 
                                    ? (courseUsers.reduce((sum, u) => sum + parseFloat(u.peso), 0) / courseUsers.length).toFixed(1) 
                                    : 0,
                                activityLevels: {
                                    ALTO: courseUsers.filter(u => u.report.level === 'ALTO').length,
                                    MODERADO: courseUsers.filter(u => u.report.level === 'MODERADO').length,
                                    BAJO: courseUsers.filter(u => u.report.level === 'BAJO').length
                                }
                            };
                        });
                        break;
                        
                    case 'sex':
                        const sexes = [...new Set(users.map(u => u.sexo))];
                        analysisResult = sexes.map(sex => {
                            const sexUsers = users.filter(u => u.sexo === sex);
                            return {
                                sex,
                                count: sexUsers.length,
                                avgAge: sexUsers.length > 0 
                                    ? (sexUsers.reduce((sum, u) => sum + parseInt(u.edad), 0) / sexUsers.length).toFixed(1) 
                                    : 0,
                                avgWeight: sexUsers.length > 0 
                                    ? (sexUsers.reduce((sum, u) => sum + parseFloat(u.peso), 0) / sexUsers.length).toFixed(1) 
                                    : 0,
                                activityLevels: {
                                    ALTO: sexUsers.filter(u => u.report.level === 'ALTO').length,
                                    MODERADO: sexUsers.filter(u => u.report.level === 'MODERADO').length,
                                    BAJO: sexUsers.filter(u => u.report.level === 'BAJO').length
                                }
                            };
                        });
                        break;
                        
                    case 'ageSex':
                        const ageSexGroups = {};
                        users.forEach(u => {
                            const ageGroup = 
                                parseInt(u.edad) <= 25 ? '15-25' :
                                parseInt(u.edad) <= 35 ? '26-35' :
                                parseInt(u.edad) <= 45 ? '36-45' :
                                parseInt(u.edad) <= 59 ? '46-59' : '60-69';
                            const key = `${ageGroup}-${u.sexo}`;
                            
                            if (!ageSexGroups[key]) {
                                ageSexGroups[key] = [];
                            }
                            ageSexGroups[key].push(u);
                        });
                        
                        analysisResult = Object.keys(ageSexGroups).map(key => {
                            const [ageRange, sex] = key.split('-');
                            const groupUsers = ageSexGroups[key];
                            return {
                                ageRange,
                                sex,
                                count: groupUsers.length,
                                avgAge: groupUsers.length > 0 
                                    ? (groupUsers.reduce((sum, u) => sum + parseInt(u.edad), 0) / groupUsers.length).toFixed(1) 
                                    : 0,
                                avgWeight: groupUsers.length > 0 
                                    ? (groupUsers.reduce((sum, u) => sum + parseFloat(u.peso), 0) / groupUsers.length).toFixed(1) 
                                    : 0,
                                activityLevels: {
                                    ALTO: groupUsers.filter(u => u.report.level === 'ALTO').length,
                                    MODERADO: groupUsers.filter(u => u.report.level === 'MODERADO').length,
                                    BAJO: groupUsers.filter(u => u.report.level === 'BAJO').length
                                }
                            };
                        });
                        break;
                        
                    default:
                        analysisResult = null;
                }
                
                setAnalysisData(analysisResult);
                setShowAnalysis(true);
            };

            const renderStep = () => {
                switch (currentStep) {
                    case 0:
                        return (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-blue-700">Datos Personales</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Nombre y apellidos</label>
                                        <input
                                            type="text"
                                            value={userData.nombre}
                                            onChange={(e) => handleInputChange('nombre', e.target.value)}
                                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Edad</label>
                                        <input
                                            type="number"
                                            min="15"
                                            max="69"
                                            value={userData.edad}
                                            onChange={(e) => handleInputChange('edad', e.target.value)}
                                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Curso</label>
                                        <select
                                            value={userData.curso}
                                            onChange={(e) => handleInputChange('curso', e.target.value)}
                                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        >
                                            <option value="">Seleccionar curso</option>
                                            <option value="1º ESO">1º ESO</option>
                                            <option value="2º ESO">2º ESO</option>
                                            <option value="3º ESO">3º ESO</option>
                                            <option value="4º ESO">4º ESO</option>
                                            <option value="1º Bachiller">1º Bachiller</option>
                                            <option value="2º Bachiller">2º Bachiller</option>
                                            <option value="1º FP basica">1º FP básica</option>
                                            <option value="2º FP Basica">2º FP Básica</option>
                                            <option value="1º FP Superior">1º FP Superior</option>
                                            <option value="2º FP Superior">2º FP Superior</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Sexo</label>
                                        <select
                                            value={userData.sexo}
                                            onChange={(e) => handleInputChange('sexo', e.target.value)}
                                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        >
                                            <option value="">Seleccionar</option>
                                            <option value="Masculino">Masculino</option>
                                            <option value="Femenino">Femenino</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Peso (kilogramos)</label>
                                        <input
                                            type="number"
                                            min="30"
                                            max="175"
                                            step="0.5"
                                            value={userData.peso}
                                            onChange={(e) => handleInputChange('peso', e.target.value)}
                                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Fecha</label>
                                        <input
                                            type="date"
                                            value={userData.fecha}
                                            onChange={(e) => handleInputChange('fecha', e.target.value)}
                                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        />
                                    </div>
                                </div>
                            </div>
                        );
                    case 1:
                        return (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-blue-700">Pregunta 1: Actividades Vigorosas</h2>
                                <p className="text-gray-600">
                                    Durante los últimos 7 días, ¿Cuántos días realizó usted actividades físicas vigorosas como levantar objetos pesados, excavar, aeróbicos, o pedalear rápido en bicicleta?
                                </p>
                                <p className="text-sm text-gray-500">
                                    Actividades vigorosas son las que requieren un esfuerzo físico fuerte y le hacen respirar mucho más fuerte que lo normal. Piense solamente en esas actividades que usted hizo por lo menos 10 minutos continuos.
                                </p>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Días por semana</label>
                                    <input
                                        type="number"
                                        min="0"
                                        max="7"
                                        step="1"
                                        value={userData.q1}
                                        onChange={(e) => handleInputChange('q1', e.target.value)}
                                        className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                    />
                                </div>
                            </div>
                        );
                    case 2:
                        return (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-blue-700">Pregunta 2: Tiempo Actividades Vigorosas</h2>
                                <p className="text-gray-600">
                                    ¿Cuánto tiempo en total usualmente le tomó realizar actividades físicas vigorosas en uno de esos días que las realizó?
                                </p>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Horas por día</label>
                                        <input
                                            type="number"
                                            min="0"
                                            max="12"
                                            step="1"
                                            value={userData.q2Hours}
                                            onChange={(e) => handleInputChange('q2Hours', e.target.value)}
                                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Minutos por día</label>
                                        <input
                                            type="number"
                                            min="0"
                                            max="60"
                                            step="1"
                                            value={userData.q2Minutes}
                                            onChange={(e) => handleInputChange('q2Minutes', e.target.value)}
                                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        />
                                    </div>
                                </div>
                            </div>
                        );
                    case 3:
                        return (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-blue-700">Pregunta 3: Actividades Moderadas</h2>
                                <p className="text-gray-600">
                                    Durante los últimos 7 días, ¿Cuántos días hizo usted actividades físicas moderadas tal como cargar objetos livianos, pedalear en bicicleta a paso regular, o jugar dobles de tenis? No incluya caminatas.
                                </p>
                                <p className="text-sm text-gray-500">
                                    Actividades moderadas son aquellas que requieren un esfuerzo físico moderado y le hace respirar algo más fuerte que lo normal. Piense solamente en esas actividades que usted hizo por lo menos 10 minutos continuos.
                                </p>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Días por semana</label>
                                    <input
                                        type="number"
                                        min="0"
                                        max="7"
                                        step="1"
                                        value={userData.q3}
                                        onChange={(e) => handleInputChange('q3', e.target.value)}
                                        className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                    />
                                </div>
                            </div>
                        );
                    case 4:
                        return (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-blue-700">Pregunta 4: Tiempo Actividades Moderadas</h2>
                                <p className="text-gray-600">
                                    Usualmente, ¿Cuánto tiempo dedica usted en uno de esos días haciendo actividades físicas moderadas?
                                </p>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Horas por día</label>
                                        <input
                                            type="number"
                                            min="0"
                                            max="12"
                                            step="1"
                                            value={userData.q4Hours}
                                            onChange={(e) => handleInputChange('q4Hours', e.target.value)}
                                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Minutos por día</label>
                                        <input
                                            type="number"
                                            min="0"
                                            max="60"
                                            step="1"
                                            value={userData.q4Minutes}
                                            onChange={(e) => handleInputChange('q4Minutes', e.target.value)}
                                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        />
                                    </div>
                                </div>
                            </div>
                        );
                    case 5:
                        return (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-blue-700">Pregunta 5: Caminatas</h2>
                                <p className="text-gray-600">
                                    Durante los últimos 7 días, ¿Cuántos días caminó usted por al menos 10 minutos continuos?
                                </p>
                                <p className="text-sm text-gray-500">
                                    Esto incluye trabajo en la casa, caminatas para ir de un sitio a otro, o cualquier otra caminata que usted hizo únicamente por recreación, deporte, ejercicio, o placer.
                                </p>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Días por semana</label>
                                    <input
                                        type="number"
                                        min="0"
                                        max="7"
                                        step="1"
                                        value={userData.q5}
                                        onChange={(e) => handleInputChange('q5', e.target.value)}
                                        className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                    />
                                </div>
                            </div>
                        );
                    case 6:
                        return (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-blue-700">Pregunta 6: Tiempo Caminatas</h2>
                                <p className="text-gray-600">
                                    Usualmente, ¿Cuánto tiempo gastó usted en uno de esos días caminando?
                                </p>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Horas por día</label>
                                        <input
                                            type="number"
                                            min="0"
                                            max="12"
                                            step="1"
                                            value={userData.q6Hours}
                                            onChange={(e) => handleInputChange('q6Hours', e.target.value)}
                                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Minutos por día</label>
                                        <input
                                            type="number"
                                            min="0"
                                            max="60"
                                            step="1"
                                            value={userData.q6Minutes}
                                            onChange={(e) => handleInputChange('q6Minutes', e.target.value)}
                                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        />
                                    </div>
                                </div>
                            </div>
                        );
                    case 7:
                        return (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-blue-700">Pregunta 7: Tiempo Sentado</h2>
                                <p className="text-gray-600">
                                    Durante los últimos 7 días, ¿Cuánto tiempo permaneció sentado(a) en un día en la semana?
                                </p>
                                <p className="text-sm text-gray-500">
                                    Incluya el tiempo sentado en el trabajo, la casa, estudiando, y en su tiempo libre. Esto puede incluír tiempo sentado en un escritorio, visitando amigos(as), leyendo o permanecer sentado(a) o acostado(a) mirando television.
                                </p>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Horas por día</label>
                                        <input
                                            type="number"
                                            min="0"
                                            max="12"
                                            step="1"
                                            value={userData.q7Hours}
                                            onChange={(e) => handleInputChange('q7Hours', e.target.value)}
                                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700">Minutos por día</label>
                                        <input
                                            type="number"
                                            min="0"
                                            max="60"
                                            step="1"
                                            value={userData.q7Minutes}
                                            onChange={(e) => handleInputChange('q7Minutes', e.target.value)}
                                            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        />
                                    </div>
                                </div>
                            </div>
                        );
                    default:
                        return null;
                }
            };

            const renderReport = () => {
                if (!reportData) return null;

                return (
                    <div className="bg-white rounded-lg shadow-lg p-6">
                        <h2 className="text-2xl font-bold text-blue-700 mb-4">Informe de Actividad Física</h2>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <h3 className="text-lg font-semibold text-gray-700">Datos Personales</h3>
                                <p><strong>Nombre:</strong> {userData.nombre}</p>
                                <p><strong>Edad:</strong> {userData.edad} años</p>
                                <p><strong>Curso:</strong> {userData.curso}</p>
                                <p><strong>Sexo:</strong> {userData.sexo}</p>
                                <p><strong>Peso:</strong> {userData.peso} kg</p>
                            </div>
                            <div>
                                <h3 className="text-lg font-semibold text-gray-700">Resumen de Actividad</h3>
                                <p><strong>Nivel de Actividad:</strong> <span className={`font-bold ${reportData.level === 'ALTO' ? 'text-green-600' : reportData.level === 'MODERADO' ? 'text-yellow-600' : 'text-red-600'}`}>{reportData.level}</span></p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div className="bg-blue-50 p-4 rounded-lg">
                                <h4 className="font-semibold text-blue-700">Actividades Vigorosas</h4>
                                <p className="text-2xl font-bold text-blue-600">{reportData.vpaMET.toFixed(0)}</p>
                                <p className="text-sm">MET-min/semana</p>
                                <p className="text-sm">{reportData.vpaTotalMinutes} min/semana</p>
                            </div>
                            <div className="bg-green-50 p-4 rounded-lg">
                                <h4 className="font-semibold text-green-700">Actividades Moderadas</h4>
                                <p className="text-2xl font-bold text-green-600">{reportData.mpaMET.toFixed(0)}</p>
                                <p className="text-sm">MET-min/semana</p>
                                <p className="text-sm">{reportData.mpaTotalMinutes} min/semana</p>
                            </div>
                            <div className="bg-purple-50 p-4 rounded-lg">
                                <h4 className="font-semibold text-purple-700">Caminatas</h4>
                                <p className="text-2xl font-bold text-purple-600">{reportData.walkMET.toFixed(0)}</p>
                                <p className="text-sm">MET-min/semana</p>
                                <p className="text-sm">{reportData.walkTotalMinutes} min/semana</p>
                            </div>
                        </div>

                        <div className="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 className="font-semibold text-gray-700">Total</h4>
                            <p className="text-3xl font-bold text-gray-800">{reportData.totalMET.toFixed(0)} MET-min/semana</p>
                            <p className="text-lg text-gray-600">{reportData.totalKcal.toFixed(2)} Kcal/semana</p>
                        </div>

                        <div className="bg-yellow-50 p-4 rounded-lg">
                            <h4 className="font-semibold text-yellow-700">Recomendación</h4>
                            <p>
                                {reportData.level === 'BAJO' 
                                    ? 'Debe mejorar sus niveles de actividad física. Se recomienda dedicar de 60 a 75 minutos diarios a realizar actividad física a intensidad moderada o de 45 a 55 minutos diarios a actividad física moderada y vigorosa.' 
                                    : reportData.level === 'MODERADO' 
                                        ? 'Sus niveles de actividad física son adecuados. Continúe manteniendo esta rutina para promover un buen estado de salud.' 
                                        : '¡Felicidades! Sus niveles de actividad física son óptimos. Mantenga esta excelente rutina de actividad física.'}
                            </p>
                        </div>
                        
                        <div className="mt-6">
                            <button
                                onClick={() => exportToCSV([{
                                    ...userData,
                                    report: reportData
                                }])}
                                className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700"
                            >
                                Exportar Datos de este Informe a CSV
                            </button>
                        </div>
                    </div>
                );
            };

            const renderAnalysis = () => {
                if (!analysisData || !analysisType) return null;

                return (
                    <div className="bg-white rounded-lg shadow-lg p-6">
                        <h2 className="text-2xl font-bold text-blue-700 mb-4">
                            Análisis por {analysisType === 'ageRange' ? 'Rango de Edad' : 
                                        analysisType === 'course' ? 'Curso' : 
                                        analysisType === 'sex' ? 'Sexo' : 
                                        'Edad y Sexo'}
                        </h2>
                        
                        <div className="mb-4">
                            <button
                                onClick={() => exportToCSV()}
                                className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 mr-2"
                            >
                                Exportar Datos a CSV
                            </button>
                            <button
                                onClick={() => { setShowAnalysis(false); setAnalysisData(null); }}
                                className="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700"
                            >
                                Volver al Panel
                            </button>
                        </div>
                        
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            {analysisType === 'ageRange' ? 'Rango de Edad' : 
                                             analysisType === 'course' ? 'Curso' : 
                                             analysisType === 'sex' ? 'Sexo' : 'Grupo'}
                                        </th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Edad Promedio</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peso Promedio</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nivel Alto</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nivel Moderado</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nivel Bajo</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {analysisData.map((item, index) => (
                                        <tr key={index}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                {analysisType === 'ageRange' ? item.range : 
                                                 analysisType === 'course' ? item.course : 
                                                 analysisType === 'sex' ? item.sex : 
                                                 `${item.ageRange} - ${item.sex}`}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.count}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.avgAge}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{item.avgWeight} kg</td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                    {item.activityLevels.ALTO}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                                    {item.activityLevels.MODERADO}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                                    {item.activityLevels.BAJO}
                                                </span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        
                        {analysisType === 'course' && (
                            <div className="mt-6">
                                <h3 className="text-lg font-semibold text-gray-700 mb-2">Gráfica de Distribución por Curso</h3>
                                <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                                    {analysisData.map((item, index) => (
                                        <div key={index} className="flex flex-col items-center">
                                            <div className="text-sm font-medium text-gray-700 mb-1">{item.course}</div>
                                            <div className="w-full bg-gray-200 rounded-full h-4">
                                                <div 
                                                    className="bg-blue-600 h-4 rounded-full" 
                                                    style={{ width: `${(item.count / users.length) * 100}%` }}
                                                ></div>
                                            </div>
                                            <div className="text-xs text-gray-500 mt-1">{item.count} usuarios</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const renderDashboard = () => {
                if (loading) {
                    return <div className="text-center py-10">Cargando datos...</div>;
                }
                
                const filteredUsers = getFilteredUsers();
                
                // Estadísticas generales
                const avgAge = users.length > 0 ? (users.reduce((sum, user) => sum + parseInt(user.edad), 0) / users.length).toFixed(1) : 0;
                const avgWeight = users.length > 0 ? (users.reduce((sum, user) => sum + parseFloat(user.peso), 0) / users.length).toFixed(1) : 0;
                
                const activityLevels = {
                    ALTO: users.filter(u => u.report.level === 'ALTO').length,
                    MODERADO: users.filter(u => u.report.level === 'MODERADO').length,
                    BAJO: users.filter(u => u.report.level === 'BAJO').length
                };

                return (
                    <div className="space-y-6">
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-2xl font-bold text-blue-700 mb-4">Panel de Control - Estadísticas Generales</h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div className="bg-blue-100 p-4 rounded-lg">
                                    <h3 className="text-lg font-semibold text-blue-700">Total Usuarios</h3>
                                    <p className="text-3xl font-bold text-blue-600">{users.length}</p>
                                </div>
                                <div className="bg-green-100 p-4 rounded-lg">
                                    <h3 className="text-lg font-semibold text-green-700">Edad Promedio</h3>
                                    <p className="text-3xl font-bold text-green-600">{avgAge}</p>
                                </div>
                                <div className="bg-purple-100 p-4 rounded-lg">
                                    <h3 className="text-lg font-semibold text-purple-700">Peso Promedio</h3>
                                    <p className="text-3xl font-bold text-purple-600">{avgWeight} kg</p>
                                </div>
                                <div className="bg-yellow-100 p-4 rounded-lg">
                                    <h3 className="text-lg font-semibold text-yellow-700">Exportar Datos</h3>
                                    <button 
                                        onClick={() => exportToCSV()}
                                        className="text-xl font-bold text-yellow-600 bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600"
                                    >
                                        CSV
                                    </button>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div className="bg-red-100 p-4 rounded-lg">
                                    <h3 className="text-lg font-semibold text-red-700">Nivel Bajo</h3>
                                    <p className="text-3xl font-bold text-red-600">{activityLevels.BAJO}</p>
                                    <p className="text-sm">{users.length > 0 ? ((activityLevels.BAJO / users.length) * 100).toFixed(1) : 0}%</p>
                                </div>
                                <div className="bg-yellow-100 p-4 rounded-lg">
                                    <h3 className="text-lg font-semibold text-yellow-700">Nivel Moderado</h3>
                                    <p className="text-3xl font-bold text-yellow-600">{activityLevels.MODERADO}</p>
                                    <p className="text-sm">{users.length > 0 ? ((activityLevels.MODERADO / users.length) * 100).toFixed(1) : 0}%</p>
                                </div>
                                <div className="bg-green-100 p-4 rounded-lg">
                                    <h3 className="text-lg font-semibold text-green-700">Nivel Alto</h3>
                                    <p className="text-3xl font-bold text-green-600">{activityLevels.ALTO}</p>
                                    <p className="text-sm">{users.length > 0 ? ((activityLevels.ALTO / users.length) * 100).toFixed(1) : 0}%</p>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Filtrar Usuarios</label>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <select
                                            value={filter.type}
                                            onChange={(e) => setFilter({...filter, type: e.target.value, value: ''})}
                                            className="border border-gray-300 rounded-md p-2"
                                        >
                                            <option value="all">Todos</option>
                                            <option value="age">Por Edad</option>
                                            <option value="activity">Por Nivel de Actividad</option>
                                        </select>
                                        
                                        {filter.type === 'age' && (
                                            <select
                                                value={filter.value}
                                                onChange={(e) => setFilter({...filter, value: e.target.value})}
                                                className="border border-gray-300 rounded-md p-2"
                                            >
                                                <option value="">Seleccionar rango</option>
                                                <option value="15-25">15-25 años</option>
                                                <option value="26-35">26-35 años</option>
                                                <option value="36-45">36-45 años</option>
                                                <option value="46-55">46-55 años</option>
                                                <option value="56-69">56-69 años</option>
                                            </select>
                                        )}
                                        
                                        {filter.type === 'activity' && (
                                            <select
                                                value={filter.value}
                                                onChange={(e) => setFilter({...filter, value: e.target.value})}
                                                className="border border-gray-300 rounded-md p-2"
                                            >
                                                <option value="">Seleccionar nivel</option>
                                                <option value="BAJO">Bajo</option>
                                                <option value="MODERADO">Moderado</option>
                                                <option value="ALTO">Alto</option>
                                            </select>
                                        )}
                                    </div>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Análisis</label>
                                    <div className="flex space-x-2">
                                        <select
                                            value={analysisType}
                                            onChange={(e) => setAnalysisType(e.target.value)}
                                            className="border border-gray-300 rounded-md p-2 flex-grow"
                                        >
                                            <option value="">Seleccionar análisis</option>
                                            <option value="ageRange">Análisis por Rango de Edad</option>
                                            <option value="course">Análisis por Curso</option>
                                            <option value="sex">Análisis por Sexo</option>
                                            <option value="ageSex">Análisis por Edad y Sexo</option>
                                        </select>
                                        <button
                                            onClick={performAnalysis}
                                            disabled={!analysisType}
                                            className={`px-4 py-2 rounded-md ${
                                                analysisType 
                                                    ? 'bg-blue-600 text-white hover:bg-blue-700' 
                                                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                            }`}
                                        >
                                            Analizar
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Edad</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Curso</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sexo</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peso</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nivel</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {filteredUsers.map(user => (
                                            <tr key={user.id}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.id}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{user.nombre}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.edad}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.curso}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.sexo}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.peso} kg</td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                        user.report.level === 'ALTO' ? 'bg-green-100 text-green-800' :
                                                        user.report.level === 'MODERADO' ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-red-100 text-red-800'
                                                    }`}>
                                                        {user.report.level}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    <button
                                                        onClick={() => {
                                                            setSelectedUser(user);
                                                            setReportData(user.report);
                                                            setShowReport(true);
                                                        }}
                                                        className="text-blue-600 hover:text-blue-900 mr-2"
                                                    >
                                                        Ver Informe
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                    <header className="bg-white shadow">
                        <div className="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8 flex justify-between items-center">
                            <h1 className="text-3xl font-bold text-gray-900">
                                Cuestionario IPAQ - Actividad Física
                            </h1>
                            <button
                                onClick={() => setCurrentStep(0)}
                                className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
                            >
                                Nueva Encuesta
                            </button>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
                        {showReport ? (
                            <div className="space-y-6">
                                {renderReport()}
                                <div className="flex justify-between">
                                    <button
                                        onClick={() => setShowReport(false)}
                                        className="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700"
                                    >
                                        Volver al Panel
                                    </button>
                                    <button
                                        onClick={resetForm}
                                        className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
                                    >
                                        Nueva Encuesta
                                    </button>
                                </div>
                            </div>
                        ) : showAnalysis ? (
                            renderAnalysis()
                        ) : currentStep === -1 ? (
                            renderDashboard()
                        ) : (
                            <div className="bg-white rounded-lg shadow-lg p-6">
                                <div className="mb-6">
                                    <div className="w-full bg-gray-200 rounded-full h-2.5">
                                        <div 
                                            className="bg-blue-600 h-2.5 rounded-full transition-all duration-300" 
                                            style={{ width: `${(currentStep / 7) * 100}%` }}
                                        ></div>
                                    </div>
                                    <p className="text-sm text-gray-500 mt-2">Paso {currentStep + 1} de 8</p>
                                </div>

                                {renderStep()}

                                <div className="flex justify-between mt-8">
                                    <button
                                        onClick={handleBack}
                                        disabled={currentStep === 0}
                                        className={`px-4 py-2 rounded-md ${
                                            currentStep === 0 
                                                ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                                                : 'bg-gray-600 text-white hover:bg-gray-700'
                                        }`}
                                    >
                                        Anterior
                                    </button>
                                    
                                    <button
                                        onClick={handleNext}
                                        className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
                                    >
                                        {currentStep === 7 ? 'Finalizar' : 'Siguiente'}
                                    </button>
                                </div>
                            </div>
                        )}

                        {!showReport && !showAnalysis && currentStep === -1 && (
                            <div className="mt-6 bg-white rounded-lg shadow-lg p-6">
                                <h2 className="text-2xl font-bold text-blue-700 mb-4">Sobre el Cuestionario IPAQ</h2>
                                <p className="text-gray-600 mb-4">
                                    El Cuestionario Internacional de Actividad Física (IPAQ) es una herramienta estandarizada 
                                    utilizada para evaluar la actividad física en diferentes poblaciones. Este cuestionario 
                                    evalúa la actividad física en tres dominios: trabajo, transporte, hogar y ocio.
                                </p>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-blue-50 p-4 rounded-lg">
                                        <h3 className="font-semibold text-blue-700">Actividades Vigorosas</h3>
                                        <p className="text-sm">Requieren un esfuerzo físico intenso y hacen respirar mucho más fuerte que lo normal.</p>
                                    </div>
                                    <div className="bg-green-50 p-4 rounded-lg">
                                        <h3 className="font-semibold text-green-700">Actividades Moderadas</h3>
                                        <p className="text-sm">Requieren un esfuerzo físico moderado y hacen respirar algo más fuerte que lo normal.</p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
