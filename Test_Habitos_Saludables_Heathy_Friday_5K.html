<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Healthy Friday - Estaciones</title>
  <style>
   /* ===== VARIABLES DE COLOR Y TIPOGRAF√çA ===== */
:root {
  --color-primary: #2563eb;
  --color-primary-light: #dbeafe;
  --color-success: #16a34a;
  --color-warning: #d97706;
  --color-danger: #dc2626;
  --color-bg: #f8fafc;
  --color-surface: #ffffff;
  --color-text: #1e293b;
  --color-text-secondary: #475569;
  --border-radius: 12px;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif;
}

/* ===== ESTILOS BASE ===== */
* {
  box-sizing: border-box;
}

body {
  font-family: var(--font-main);
  background-color: var(--color-bg);
  color: var(--color-text);
  line-height: 1.6;
  margin: 0;
  padding: 0;
}

/* ===== ENCABEZADOS ===== */
header h1 {
  text-align: center;
  color: var(--color-primary);
  margin: 1.5rem 0;
  font-weight: 700;
  font-size: 1.8rem;
}

h2 {
  color: var(--color-primary);
  margin-top: 1.5rem;
  font-size: 1.5rem;
}

h3 {
  color: var(--color-text);
  margin-top: 1.2rem;
  font-size: 1.25rem;
}

/* ===== MEN√ö PRINCIPAL ===== */
.menu {
  max-width: 800px;
  margin: 0 auto;
  padding: 0 1rem;
}

.menu ul {
  list-style: none;
  padding: 0;
  display: grid;
  gap: 12px;
}

.menu a {
  display: block;
  padding: 16px;
  background: var(--color-surface);
  color: var(--color-primary);
  text-decoration: none;
  border-radius: var(--border-radius);
  font-weight: 600;
  text-align: center;
  box-shadow: var(--shadow);
  transition: all 0.2s ease;
  border: 2px solid transparent;
}

.menu a:hover,
.menu a:focus {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px -2px rgba(0, 0, 0, 0.12);
  outline: 2px solid var(--color-primary);
  outline-offset: 2px;
}

.btn-informe {
  background: var(--color-primary);
  color: white;
  border: none;
  border-radius: var(--border-radius);
  padding: 14px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  margin-top: 1.5rem;
  box-shadow: var(--shadow);
  transition: background 0.2s;
}

.btn-informe:hover,
.btn-informe:focus {
  background: #1d4ed8;
  outline: 2px solid white;
  outline-offset: 2px;
}

/* ===== FORMULARIO DE DATOS PERSONALES ===== */
.test-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 0 1rem;
}

.test-container label {
  display: block;
  margin: 1.2rem 0 0.5rem;
  font-weight: 600;
  color: var(--color-text);
}

.test-container input,
.test-container select {
  width: 100%;
  padding: 12px;
  font-size: 1rem;
  border: 2px solid #cbd5e1;
  border-radius: 8px;
  background: var(--color-surface);
  transition: border-color 0.2s;
}

.test-container input:focus,
.test-container select:focus {
  border-color: var(--color-primary);
  outline: none;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
}

/* ===== PREGUNTAS ===== */
.pregunta-item {
  background: var(--color-surface);
  padding: 18px;
  border-radius: var(--border-radius);
  margin: 1.2rem 0;
  box-shadow: var(--shadow);
  border-left: 4px solid var(--color-primary);
}

.pregunta-item p {
  margin: 0 0 12px;
  font-weight: 600;
  font-size: 1.1rem;
}

.opcion {
  display: block;
  margin: 8px 0;
}

.opcion input {
  margin-right: 10px;
  width: auto;
  accent-color: var(--color-primary);
}

.opcion label {
  font-weight: normal;
  color: var(--color-text-secondary);
  cursor: pointer;
}

/* ===== BOTONES ===== */
.btn {
  background: var(--color-success);
  color: white;
  border: none;
  border-radius: var(--border-radius);
  padding: 12px 24px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  margin-top: 1rem;
  box-shadow: var(--shadow);
  transition: background 0.2s;
}

.btn:hover,
.btn:focus {
  background: #15803d;
  outline: 2px solid white;
  outline-offset: 2px;
}

.btn-volver {
  display: inline-block;
  background: #64748b;
  color: white;
  text-decoration: none;
  padding: 10px 20px;
  border-radius: var(--border-radius);
  margin-top: 1.5rem;
  font-weight: 600;
  box-shadow: var(--shadow);
  transition: background 0.2s;
}

.btn-volver:hover,
.btn-volver:focus {
  background: #475569;
  outline: 2px solid white;
  outline-offset: 2px;
}

/* ===== RESULTADOS ===== */
#resultado {
  display: none;
  background: var(--color-primary-light);
  padding: 24px;
  border-radius: var(--border-radius);
  margin-top: 24px;
  box-shadow: var(--shadow);
  border: 1px solid #bfdbfe;
}

#resultado h2 {
  margin-top: 0;
  color: var(--color-primary);
}

#recomendaciones h3 {
  margin-top: 1.2rem;
  color: var(--color-text);
}

#recomendaciones p {
  background: white;
  padding: 16px;
  border-radius: 8px;
  border-left: 4px solid var(--color-warning);
  font-style: italic;
}

/* ===== INFORME GLOBAL (en nueva ventana) ===== */
.informe-global {
  font-family: var(--font-main);
  padding: 20px;
  background: var(--color-bg);
  color: var(--color-text);
}

.informe-global h2 {
  text-align: center;
  color: var(--color-primary);
  margin-bottom: 20px;
}

.informe-global h3 {
  background: var(--color-surface);
  padding: 12px;
  border-radius: 8px;
  margin: 20px 0 12px;
  box-shadow: var(--shadow);
}

.informe-global ul {
  padding-left: 20px;
}

.informe-global li {
  margin-bottom: 12px;
  line-height: 1.6;
}

.informe-global .alerta {
  color: var(--color-danger);
  font-weight: 600;
}

.informe-global .positivo {
  color: var(--color-success);
  font-weight: 600;
}

/* ===== ACCESIBILIDAD Y ENFOQUE ===== */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* ===== IMPRESI√ìN ===== */
@media print {
  .btn,
  .btn-volver,
  .menu a {
    display: none !important;
  }

  body,
  .test-container,
  #resultado {
    background: white !important;
    color: black !important;
    box-shadow: none !important;
  }

  #resultado {
    padding: 15px;
    border: 1px solid #ccc;
  }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 600px) {
  header h1 {
    font-size: 1.5rem;
  }

  .opcion label {
    font-size: 0.95rem;
  }

  .btn, .btn-informe, .btn-volver {
    width: 100%;
    padding: 14px;
  }
}
  </style>

  <!-- Firebase SDK (versi√≥n 8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>

  <!-- Men√∫ principal -->
  <div id="menu" class="menu">
    <header><h1>Healthy Friday - Estaciones</h1></header>
    <main>
      <h2>Selecciona el test de esta estaci√≥n:</h2>
      <ul>
        <li><a href="#" onclick="cargarTest('postura')">Higiene Postural</a></li>
        <li><a href="#" onclick="cargarTest('actividad')">Actividad F√≠sica</a></li>
        <li><a href="#" onclick="cargarTest('azucar')">Az√∫car y Alimentaci√≥n</a></li>
        <li><a href="#" onclick="cargarTest('alimentacion')">H√°bitos Alimenticios</a></li>
        <li><a href="#" onclick="cargarTest('composicion')">Composici√≥n Corporal</a></li>
        <li><a href="#" onclick="cargarTest('medioambiente')">Cuidado Medioambiental</a></li>
        <li><a href="#" onclick="cargarTest('espalda')">Higiene de la Espalda</a></li>
        <li><a href="#" onclick="cargarTest('fuerza')">Deporte y Fuerza</a></li>
        <li><a href="#" onclick="cargarTest('sueno')">H√°bitos de Sue√±o (Padres)</a></li>
        <li><a href="#" onclick="cargarTest('relajacion')">Relajaci√≥n</a></li>
      </ul>
      <button class="btn" onclick="generarInformeAnalitico()" style="width:100%; margin-top:20px;">üìä Informe Global por Curso y Sexo</button>
    </main>
  </div>

  <!-- Formulario de test -->
  <div id="test" style="display:none;" class="test-container">
    <header><h1 id="titulo-test">Test</h1></header>
    
    <form id="form-datos">
      <label>C√≥digo de alumno: <input type="text" id="codigoAlumno" required placeholder="Ej: ALU-2025-001" autocomplete="off"></label>
      <label>
		  Curso:
		  <select id="curso" required>
			<option value="">-- Selecciona --</option>
			<option value="1¬∫ ESO">1¬∫ ESO</option>
			<option value="2¬∫ ESO">2¬∫ ESO</option>
			<option value="3¬∫ ESO">3¬∫ ESO</option>
			<option value="4¬∫ ESO">4¬∫ ESO</option>
			<option value="1¬∫ BACHILLER">1¬∫ BACHILLER</option>
		  </select>
		</label>
      <label>Edad: <input type="number" id="edad" min="10" max="18" required></label>
      <label>
        Sexo:
        <select id="sexo" required>
          <option value="masculino">Masculino</option>
          <option value="femenino">Femenino</option>
		  <option value="nobinario">No binario</option>
        </select>
      </label>
    </form>

    <form id="form-preguntas"></form>

    <button class="btn" onclick="calcularResultado()">Calcular Resultado</button>
    <a href="#" class="btn-volver" onclick="mostrarMenu()">‚Üê Volver al men√∫</a>

    <div id="resultado">
      <h2>Resultados</h2>
      <p><strong>Puntuaci√≥n total:</strong> <span id="puntaje"></span></p>
      <p><strong>Nivel:</strong> <span id="nivel"></span></p>
      <div id="recomendaciones"></div>
      <br />
      <button class="btn" onclick="window.print()">üñ®Ô∏è Imprimir Resultados</button>
    </div>
  </div>

  <script>
    // === Configuraci√≥n de Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyChC7s5NN-z-dSjqeXDaks7gaNaVCJAu7Q",
      authDomain: "nutriplanv2.firebaseapp.com",
      projectId: "nutriplanv2",
      storageBucket: "nutriplanv2.firebasestorage.app",
      messagingSenderId: "653707489758",
      appId: "1:653707489758:web:9133d1d1620825c385ed4f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

     // === DATOS DE LOS TESTS (5 preguntas clave cada uno) ===
    const tests = {
      postura: {
        titulo: "Higiene Postural",
        preguntas: [
          "¬øMantienes una postura erguida en clase, con espalda apoyada y pies en el suelo?",
          "¬øLlevas la mochila correctamente, con ambas correas y ajustada a la espalda, sin exceder el 10% de tu peso?",
          "¬øUsas ordenadores o tel√©fonos con la pantalla a la altura de los ojos, evitando encorvarte?",
          "¬øHaces pausas para estirarte durante sesiones prolongadas en clase o frente a pantallas?",
          "¬øEvitas posturas asim√©tricas, como cruzar piernas o inclinarte al usar dispositivos?"
        ],
        recomendaciones: [
          "Comienza con lo b√°sico: Pesa tu mochila y aseg√∫rate de no exceder el 10% de tu peso; ajusta correas. Corrige postura en clase y eleva pantallas.",
          "Enf√≥cate en rutina: Usa soportes para evitar encorvamiento. Haz pausas activas cada hora.",
          "Avanza: Incorpora estiramientos diarios y corrige posturas asim√©tricas. Monitorea tu mochila semanalmente.",
          "Refina: Ense√±a a otros sobre higiene postural. Usa recordatorios visuales.",
          "Excelente: Lidera talleres y comparte buenos h√°bitos."
        ]
      },
      actividad: {
        titulo: "Actividad F√≠sica",
        preguntas: [
          "¬øRealizas al menos 60 minutos de actividad f√≠sica diaria (caminar, bailar, etc.)?",
          "¬øEvitas periodos prolongados de sedentarismo, levant√°ndote cada hora?",
          "¬øParticipas en juegos divertidos como Just Dance u otros para hacer AF?",
          "¬øIncluyes variedad: fuerza, flexibilidad y cardio en tu AF semanal?",
          "¬øPriorizas AF para mantener un cuerpo en forma y una mente calmada?"
        ],
        recomendaciones: [
          "Comienza: Camina 30 min + juega 30 min. Usa Just Dance para motivarte.",
          "Enf√≥cate: Rompe el sedentarismo cada hora. Apunta a 60 min diarios.",
          "Avanza: Var√≠a con fuerza y flexibilidad. √önete a grupos.",
          "Refina: Usa apps para tracking. Ense√±a a otros.",
          "Excelente: Lidera sesiones y explora yoga o ciclismo."
        ]
      },
      azucar: {
        titulo: "Az√∫car y Alimentaci√≥n",
        preguntas: [
          "¬øEvitas bebidas azucaradas como refrescos, energ√©ticas o jugos procesados?",
          "¬øReemplazas golosinas o bebidas dulces por opciones naturales como fruta?",
          "¬øLees etiquetas de productos para verificar el contenido de az√∫cares a√±adidos?",
          "¬øConsumes menos de una bebida azucarada por semana?",
          "¬øSigues gu√≠as como las de la OMS para limitar az√∫cares libres?"
        ],
        recomendaciones: [
          "Comienza: Elimina una bebida azucarada diaria. Reemplaza por agua o fruta.",
          "Enf√≥cate: Limita a 1 bebida azucarada/semana. Lee etiquetas.",
          "Avanza: Elige productos con 0g az√∫car a√±adido. Monitorea tu consumo.",
          "Refina: Organiza chequeos de salud. Ense√±a sobre equivalentes de az√∫car.",
          "Excelente: Lidera campa√±as contra bebidas azucaradas."
        ]
      },
      alimentacion: {
        titulo: "H√°bitos Alimenticios",
        preguntas: [
          "¬øConsumes al menos cinco piezas de fruta o raciones de verdura al d√≠a?",
          "¬øReemplazas golosinas o snacks procesados por opciones naturales como fruta?",
          "¬øEliges comida real (frutas, verduras, prote√≠nas frescas) sobre sustancias comestibles?",
          "¬øSigues el Plato de Harvard: mitad vegetales, cuarto granos, cuarto prote√≠nas?",
          "¬øIncorporas frutas como postre o snack saludable en tu rutina diaria?"
        ],
        recomendaciones: [
          "Comienza: Cambia una golosina por fruta. A√±ade una ensalada diaria.",
          "Enf√≥cate: Prepara snacks de fruta. Agrega verduras a cada comida.",
          "Avanza: Cocina platos reales. Evita bebidas azucaradas.",
          "Refina: Experimenta con recetas del Plato de Harvard.",
          "Excelente: Lidera grupos de alimentaci√≥n saludable."
        ]
      },
      composicion: {
        titulo: "Composici√≥n Corporal",
        preguntas: [
          "¬øConsumes una dieta equilibrada con al menos 5 porciones de frutas y verduras al d√≠a?",
          "¬øControlas las porciones de comida y evitas comer en exceso?",
          "¬øRealizas actividad f√≠sica regular (al menos 150 minutos semanales)?",
          "¬øBebes suficiente agua (al menos 2 litros al d√≠a) y limitas bebidas azucaradas?",
          "¬øDuermes entre 7-9 horas por noche?"
        ],
        recomendaciones: [
          "Comienza: Calcula tu IMC. Camina 30 min diarios. Reduce porciones.",
          "Enf√≥cate: Registra tu ingesta. Agrega fuerza 2-3 veces/semana.",
          "Avanza: Mide circunferencias. Integra dieta mediterr√°nea.",
          "Refina: Haz chequeos anuales. Ense√±a sobre sobrepeso en Espa√±a.",
          "Excelente: Lidera grupos de nutrici√≥n."
        ]
      },
      medioambiente: {
        titulo: "Cuidado Medioambiental",
        preguntas: [
          "¬øRecoges papeles o basura del suelo y los tiras a la papelera?",
          "¬øEvitas tirar basura en el suelo, incluso si no hay papelera cerca?",
          "¬øSeparas residuos reciclables (papel, pl√°stico) antes de desecharlos?",
          "¬øUsas productos reutilizables (botellas, bolsas) en lugar de desechables?",
          "¬øParticipas en actividades de limpieza o brigadas verdes?"
        ],
        recomendaciones: [
          "Comienza: Lleva siempre la basura a la papelera. Recoge 5 papeles diarios.",
          "Enf√≥cate: Separa reciclables. Organiza limpiezas semanales.",
          "Avanza: Crea carteles ambientales. Reporta papeleras llenas.",
          "Refina: Lidera plantaciones. Ense√±a sobre impacto del littering.",
          "Excelente: Organiza eventos de Brigada Verde mensuales."
        ]
      },
      espalda: {
        titulo: "Higiene de la Espalda",
        preguntas: [
          "¬øRealizas estiramientos diarios para los isquiotibiales y la espalda?",
          "¬øMantienes una postura correcta al sentarte o estar de pie?",
          "¬øEvitas cargar mochilas pesadas o distribuir el peso de manera desigual?",
          "¬øRealizas pausas para estirarte durante periodos largos sentado?",
          "¬øDuermes en una posici√≥n que apoye la curvatura natural de la espalda?"
        ],
        recomendaciones: [
          "Comienza: Estira isquios diarios. Evita mochilas pesadas.",
          "Enf√≥cate: Corrige postura con recordatorios. Haz pausas activas.",
          "Avanza: Mide flexibilidad semanal. Usa almohadas de apoyo al dormir.",
          "Refina: Organiza chequeos posturales. Ense√±a sobre acortamiento de isquios.",
          "Excelente: Lidera grupos de higiene postural."
        ]
      },
      fuerza: {
        titulo: "Deporte y Fuerza",
        preguntas: [
          "¬øPracticas ejercicios de fuerza (flexiones, sentadillas) al menos 2-3 veces por semana?",
          "¬øIncorporas deporte en tu rutina diaria para mejorar la fuerza?",
          "¬øEvitas el sedentarismo prolongado?",
          "¬øSigues una dieta que apoye el desarrollo de fuerza, con prote√≠nas adecuadas?",
          "¬øParticipas en actividades que reduzcan el estr√©s, como el deporte?"
        ],
        recomendaciones: [
          "Comienza: Haz 10 flexiones diarias. Camina 30 min.",
          "Enf√≥cate: Agrega 20 min de fuerza, 3 veces/semana.",
          "Avanza: Usa normogramas AVENA. Var√≠a con cardio y fuerza.",
          "Refina: Ajusta dieta. Ense√±a sobre fuerza y salud mental.",
          "Excelente: Lidera grupos de deporte."
        ]
      },
      sueno: {
        titulo: "H√°bitos de Sue√±o (Padres)",
        preguntas: [
          "¬øSe acuesta m√°s o menos a la misma hora todas las noches?",
          "¬øLe cuesta mucho dormirse (m√°s de 30 min)?",
          "¬øDuerme entre 9 y 12 horas por noche?",
          "¬øSe despierta varias veces sin raz√≥n?",
          "¬øUsa pantallas menos de 1 hora antes de dormir?"
        ],
        recomendaciones: [
          "Es urgente mejorar: Establece horario fijo, elimina pantallas 1h antes. Consulta al pediatra si no mejora.",
          "Vas por buen camino: Reduce pantallas, asegura 9‚Äì12 h de sue√±o.",
          "¬°Muy bien! Solo ajusta detalles: mant√©n rutina sin pantallas.",
          "Tu hijo/a tiene h√°bitos ejemplares. ¬°Sigue as√≠!"
        ],
        tipo: "binario",
        invertidas: [1, 3, 4] // √≠ndices base 0: preguntas 2, 4, 5 ‚Üí favorables = "No"
      },
      relajacion: {
        titulo: "Relajaci√≥n",
        preguntas: [
          "¬øDedicas al menos 30 minutos al d√≠a a actividades sin pantallas?",
          "¬øEvitas el uso de dispositivos electr√≥nicos al menos 1 hora antes de dormir?",
          "¬øPracticas t√©cnicas de respiraci√≥n profunda o meditaci√≥n diaria?",
          "¬øLimitas el tiempo en redes sociales para evitar el estr√©s?",
          "¬øBuscas entornos naturales o tranquilos, lejos de pantallas?"
        ],
        recomendaciones: [
          "Comienza: Establece 30 min diarios sin pantallas. Prueba respiraci√≥n 4-6 seg.",
          "Enf√≥cate: Silencia notificaciones despu√©s de las 8 PM. Usa journaling.",
          "Avanza: Crea zonas sin pantallas en casa. Apunta a <2h recreativas/d√≠a.",
          "Refina: Organiza 'd√≠as offline'. Ense√±a sobre luz azul y melatonina.",
          "Excelente: Lidera grupos de relajaci√≥n. Promueve alternativas anal√≥gicas."
        ]
      }
    };

    let testActual = null;

    function mostrarMenu() {
      document.getElementById('menu').style.display = 'block';
      document.getElementById('test').style.display = 'none';
    }

    function cargarTest(tipo) {
      const test = tests[tipo];
      if (!test) return;

      testActual = tipo;
      document.getElementById('titulo-test').textContent = test.titulo;
      document.getElementById('form-preguntas').innerHTML = '';

      if (test.tipo === 'binario') {
        document.querySelector('.sueno-nota')?.remove();
        const nota = document.createElement('div');
        nota.className = 'sueno-nota';
        nota.innerHTML = '<strong>¬°Importante!</strong> En las preguntas 2, 8 y 10, la respuesta favorable es ‚ÄúNo‚Äù. En las dem√°s, es ‚ÄúS√≠‚Äù.';
        document.getElementById('form-datos').after(nota);
      }

      test.preguntas.forEach((pregunta, i) => {
        const div = document.createElement('div');
        div.className = 'pregunta-item';
        div.innerHTML = `<p><strong>${i + 1}.</strong> ${pregunta}</p>`;

        if (test.tipo === 'binario') {
          div.innerHTML += `
            <div class="opcion">
              <label><input type="radio" name="q${i}" value="si" required> S√≠</label>
            </div>
            <div class="opcion">
              <label><input type="radio" name="q${i}" value="no" required> No</label>
            </div>
          `;
        } else {
          const opciones = ['Nunca', 'Rara vez', 'A veces', 'Frecuentemente', 'Siempre'];
          opciones.forEach((texto, idx) => {
            div.innerHTML += `
              <div class="opcion">
                <label><input type="radio" name="q${i}" value="${idx + 1}" required> ${idx + 1}: ${texto}</label>
              </div>
            `;
          });
        }

        document.getElementById('form-preguntas').appendChild(div);
      });

      document.getElementById('menu').style.display = 'none';
      document.getElementById('test').style.display = 'block';
      document.getElementById('resultado').style.display = 'none';
    }

    async function calcularResultado() {
      const test = tests[testActual];
      let total = 0;
      const respuestas = {};

      if (test.tipo === 'binario') {
        test.preguntas.forEach((_, i) => {
          const si = document.querySelector(`input[name="q${i}"][value="si"]:checked`);
          const no = document.querySelector(`input[name="q${i}"][value="no"]:checked`);
          if (!si && !no) {
            alert("Por favor responde todas las preguntas.");
            return;
          }
          const valor = si ? 'si' : 'no';
          respuestas[`q${i + 1}`] = valor;
          const esInvertida = test.invertidas.includes(i);
          if ((si && !esInvertida) || (no && esInvertida)) {
            total += 1;
          }
        });
        let nivel, recIndex;
        if (total <= 2) { nivel = "Mal h√°bito"; recIndex = 0; }
        else if (total <= 3) { nivel = "A mejorar"; recIndex = 1; }
        else if (total <= 4) { nivel = "Bueno"; recIndex = 2; }
        else { nivel = "Excelente"; recIndex = 3; }
        document.getElementById('puntaje').textContent = `${total} / 5`;
        document.getElementById('nivel').textContent = nivel;
        document.getElementById('recomendaciones').innerHTML = `<h3>Recomendaciones:</h3><p>${test.recomendaciones[recIndex]}</p>`;
      } else {
        test.preguntas.forEach((_, i) => {
          const selected = document.querySelector(`input[name="q${i}"]:checked`);
          if (!selected) {
            alert("Por favor responde todas las preguntas.");
            return;
          }
          const valor = parseInt(selected.value);
          respuestas[`q${i + 1}`] = valor;
          total += valor;
        });
		   // Escala ajustada a 5 preguntas ‚Üí m√°ximo 25
        let nivel, recIndex;
        if (total <= 7) { nivel = "Mal h√°bito"; recIndex = 0; }
        else if (total <= 12) { nivel = "Regular"; recIndex = 1; }
        else if (total <= 17) { nivel = "Bueno"; recIndex = 2; }
        else if (total <= 22) { nivel = "Muy bueno"; recIndex = 3; }
        else { nivel = "Excelente"; recIndex = 4; }
        document.getElementById('puntaje').textContent = `${total} / 25`;
        document.getElementById('nivel').textContent = nivel;
        document.getElementById('recomendaciones').innerHTML = `<h3>Recomendaciones:</h3><p>${test.recomendaciones[recIndex]}</p>`;
      }

      // === Guardar en Firestore ===
      const codigoAlumno = document.getElementById('codigoAlumno').value.trim().toUpperCase();
      const curso = document.getElementById('curso').value.trim();
      const edad = parseInt(document.getElementById('edad').value);
      const sexo = document.getElementById('sexo').value;

      if (!codigoAlumno || !curso || !edad || !sexo) {
        alert("Por favor completa todos los datos.");
        return;
      }

      const resultado = {
        codigoAlumno,
        testId: testActual,
        titulo: test.titulo,
        curso,
        edad,
        sexo,
        respuestas,
        puntaje: total,
        nivel: document.getElementById('nivel').textContent,
        fecha: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection('resultadosHealthyFriday').add(resultado);
        console.log("‚úÖ Resultado guardado para:", codigoAlumno, "en test:", testActual);
      } catch (error) {
        console.error("‚ùå Error al guardar:", error);
        alert("Error al guardar. ¬øHay conexi√≥n a internet?");
        return;
      }

      document.getElementById('resultado').style.display = 'block';
    }

    async function generarInformeAnalitico() {
  try {
    const snapshot = await db.collection('resultadosHealthyFriday').get();
    if (snapshot.empty) {
      alert("No hay resultados a√∫n.");
      return;
    }

    // Recopilar todos los resultados
    const todos = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      // Normalizar puntaje a escala 0-100 para comparabilidad
      let puntajeNormalizado;
      if (data.testId === 'sueno') {
        // Test binario: max 5 puntos ‚Üí escala a 100
        puntajeNormalizado = (data.puntaje / 5) * 100;
      } else {
        // Tests de 5 preguntas: max 25 puntos ‚Üí escala a 100
        puntajeNormalizado = (data.puntaje / 25) * 100;
      }
      todos.push({ ...data, puntaje100: puntajeNormalizado });
    });

    // === 1. Agrupar por alumno para obtener promedio global por alumno ===
    const alumnos = {};
    todos.forEach(r => {
      if (!alumnos[r.codigoAlumno]) {
        alumnos[r.codigoAlumno] = {
          codigo: r.codigoAlumno,
          curso: r.curso,
          sexo: r.sexo,
          puntajes: [],
          tests: new Set()
        };
      }
      // Evitar duplicados si un alumno repite un test
      if (!alumnos[r.codigoAlumno].tests.has(r.testId)) {
        alumnos[r.codigoAlumno].puntajes.push(r.puntaje100);
        alumnos[r.codigoAlumno].tests.add(r.testId);
      }
    });

    // Calcular promedio por alumno
    const alumnosConPromedio = Object.values(alumnos).map(a => {
      const promedio = a.puntajes.reduce((sum, p) => sum + p, 0) / a.puntajes.length;
      return {
        codigo: a.codigo,
        curso: a.curso,
        sexo: a.sexo,
        promedio,
        completados: a.puntajes.length
      };
    }).filter(a => a.completados >= 5); // Solo alumnos con al menos 5 tests

    if (alumnosConPromedio.length === 0) {
      alert("No hay alumnos con suficientes tests completados.");
      return;
    }

    // === 2. Mejores y peores cursos (por promedio de alumnos en ese curso) ===
    const cursos = {};
    alumnosConPromedio.forEach(a => {
      if (!cursos[a.curso]) cursos[a.curso] = [];
      cursos[a.curso].push(a.promedio);
    });

    const promedioCurso = {};
    for (const [curso, promedios] of Object.entries(cursos)) {
      promedioCurso[curso] = promedios.reduce((sum, p) => sum + p, 0) / promedios.length;
    }

    const cursosOrdenados = Object.entries(promedioCurso)
      .sort((a, b) => b[1] - a[1]);
    const mejorCurso = cursosOrdenados[0];
    const peorCurso = cursosOrdenados[cursosOrdenados.length - 1];

    // === 3. Comparativa global por g√©nero ===
    const genero = { masculino: [], femenino: [], nobinario: [] };
    alumnosConPromedio.forEach(a => {
      if (genero[a.sexo]) genero[a.sexo].push(a.promedio);
    });

    const promedioGenero = {};
    for (const [g, promedios] of Object.entries(genero)) {
      if (promedios.length > 0) {
        promedioGenero[g] = promedios.reduce((sum, p) => sum + p, 0) / promedios.length;
      }
    }

    // Determinar g√©nero con mejor promedio
    let mejorGenero = null;
    let mejorPromedio = -1;
    for (const [g, prom] of Object.entries(promedioGenero)) {
      if (prom > mejorPromedio) {
        mejorPromedio = prom;
        mejorGenero = g;
      }
    }

    // === 4. Diferencias por g√©nero dentro de cada curso ===
    const comparativaPorCurso = {};
    for (const curso of Object.keys(cursos)) {
      const datos = alumnosConPromedio.filter(a => a.curso === curso);
      const generosEnCurso = { masculino: [], femenino: [], nobinario: [] };
      datos.forEach(a => {
        if (generosEnCurso[a.sexo]) generosEnCurso[a.sexo].push(a.promedio);
      });

      comparativaPorCurso[curso] = {};
      for (const [g, promedios] of Object.entries(generosEnCurso)) {
        if (promedios.length > 0) {
          comparativaPorCurso[curso][g] = (promedios.reduce((sum, p) => sum + p, 0) / promedios.length).toFixed(1);
        }
      }
    }

    // === 5. Top 3 alumnos con mejor promedio ===
    const top3 = alumnosConPromedio
      .sort((a, b) => b.promedio - a.promedio)
      .slice(0, 3);

    // === 6. Generar HTML del informe ===
    let html = `<h2>üìä Informe Anal√≠tico Healthy Friday</h2>`;
    html += `<p><em>Generado: ${new Date().toLocaleString()}</em></p><hr>`;

    // Mejor y peor curso
    html += `<h3>üèÜ Mejor y Peor Curso</h3>`;
    html += `<p><strong>Mejor curso:</strong> ${mejorCurso[0]} (${mejorCurso[1].toFixed(1)}%)</p>`;
    html += `<p><strong>Peor curso:</strong> ${peorCurso[0]} (${peorCurso[1].toFixed(1)}%)</p><hr>`;

    // Comparativa por g√©nero
    html += `<h3>üë• Comparativa por G√©nero (Global)</h3>`;
    for (const [g, prom] of Object.entries(promedioGenero)) {
      const nombre = g === 'masculino' ? 'Chicos' : g === 'femenino' ? 'Chicas' : 'No binario';
      html += `<p><strong>${nombre}:</strong> ${prom.toFixed(1)}%</p>`;
    }
    const nombreMejorGenero = mejorGenero === 'masculino' ? 'Chicos' : mejorGenero === 'femenino' ? 'Chicas' : 'No binario';
    html += `<p><strong>‚úÖ Grupo con mejor desempe√±o:</strong> ${nombreMejorGenero}</p><hr>`;

    // Diferencias por curso y g√©nero
    html += `<h3>üîç Comparativa por Curso y G√©nero</h3>`;
    for (const [curso, generos] of Object.entries(comparativaPorCurso)) {
      html += `<h4>${curso}</h4><ul>`;
      for (const [g, prom] of Object.entries(generos)) {
        const nombre = g === 'masculino' ? 'Chicos' : g === 'femenino' ? 'Chicas' : 'No binario';
        html += `<li>${nombre}: ${prom}%</li>`;
      }
      html += `</ul>`;
    }
    html += `<hr>`;

    // Top 3 alumnos
    html += `<h3>ü•á Top 3 Alumnos Destacados</h3>`;
    top3.forEach((alumno, i) => {
      const posicion = ['1¬∫', '2¬∫', '3¬∫'][i];
      const generoTexto = alumno.sexo === 'masculino' ? 'Chico' : alumno.sexo === 'femenino' ? 'Chica' : 'No binario';
      html += `<p><strong>${posicion}:</strong> ${alumno.codigo} (${generoTexto}, ${alumno.curso}) ‚Äì ${alumno.promedio.toFixed(1)}%</p>`;
    });

    // Abrir en nueva ventana
    const win = window.open('', '_blank');
    win.document.write(`
      <html>
      <head>
        <title>Informe Anal√≠tico Healthy Friday</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
          h2 { color: #2563eb; text-align: center; }
          h3 { color: #1e293b; margin-top: 24px; }
          h4 { color: #475569; margin-top: 16px; }
          ul { padding-left: 20px; }
          li { margin-bottom: 8px; }
          hr { margin: 24px 0; border: 0; border-top: 1px solid #e2e8f0; }
        </style>
      </head>
      <body>${html}</body>
      </html>
    `);
    win.document.close();

  } catch (error) {
    console.error("Error en informe anal√≠tico:", error);
    alert("No se pudo generar el informe anal√≠tico.");
  }
}
  </script>
</body>
</html>
