<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Healthy Friday - Estaciones</title>
  <style>
   /* ===== VARIABLES DE COLOR Y TIPOGRAFÍA ===== */
:root {
  --color-primary: #2563eb;
  --color-primary-light: #dbeafe;
  --color-success: #16a34a;
  --color-warning: #d97706;
  --color-danger: #dc2626;
  --color-bg: #f8fafc;
  --color-surface: #ffffff;
  --color-text: #1e293b;
  --color-text-secondary: #475569;
  --border-radius: 18px;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif;
}

/* ===== ESTILOS BASE ===== */
* {
  box-sizing: border-box;
}

body {
  font-family: var(--font-main);
  background-color: var(--color-bg);
  color: var(--color-text);
  line-height: 1.6;
  margin: 0;
  padding: 0;
}

/* ===== ENCABEZADOS ===== */
header h1 {
  text-align: center;
  color: var(--color-primary);
  margin: 1.5rem 0;
  font-weight: 700;
  font-size: 1.8rem;
}

h2 {
  color: var(--color-primary);
  margin-top: 1.5rem;
  font-size: 1.5rem;
}

h3 {
  color: var(--color-text);
  margin-top: 1.2rem;
  font-size: 1.25rem;
}

/* ===== MENÚ PRINCIPAL ===== */
.menu {
  max-width: 800px;
  margin: 0 auto;
  padding: 0 1rem;
}

.menu ul {
  list-style: none;
  padding: 0;
  display: grid;
  gap: 12px;
}

.menu a {
  display: block;
  padding: 16px;
  background: var(--color-surface);
  color: var(--color-primary);
  text-decoration: none;
  border-radius: var(--border-radius);
  font-weight: 600;
  text-align: center;
  box-shadow: var(--shadow);
  transition: all 0.2s ease;
  border: 1px solid transparent;
}

.menu a:hover,
.menu a:focus {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px -2px rgba(0, 0, 0, 0.12);
  outline: 2px solid var(--color-primary);
  outline-offset: 2px;
}

.btn-informe {
  background: var(--color-primary);
  color: white;
  border: none;
  border-radius: var(--border-radius);
  padding: 14px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  margin-top: 1.5rem;
  box-shadow: var(--shadow);
  transition: background 0.2s;
}

.btn-informe:hover,
.btn-informe:focus {
  background: #1d4ed8;
  outline: 2px solid white;
  outline-offset: 2px;
}

/* ===== FORMULARIO DE DATOS PERSONALES ===== */
.test-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 0 1rem;
}

.test-container label {
  display: block;
  margin: 1.2rem 0 0.5rem;
  font-weight: 600;
  color: var(--color-text);
}

.test-container input,
.test-container select {
  width: 100%;
  padding: 12px;
  font-size: 1rem;
  border: 2px solid #cbd5e1;
  border-radius: 8px;
  background: var(--color-surface);
  transition: border-color 0.2s;
}

.test-container input:focus,
.test-container select:focus {
  border-color: var(--color-primary);
  outline: none;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
}

/* ===== PREGUNTAS ===== */
.pregunta-item {
  background: var(--color-surface);
  padding: 18px;
  border-radius: var(--border-radius);
  margin: 1.2rem 0;
  box-shadow: var(--shadow);
  border-left: 4px solid var(--color-primary);
}

.pregunta-item p {
  margin: 0 0 12px;
  font-weight: 600;
  font-size: 1.1rem;
}

.opcion {
  display: block;
  margin: 8px 0;
}

.opcion input {
  margin-right: 10px;
  width: auto;
  accent-color: var(--color-primary);
}

.opcion label {
  font-weight: normal;
  color: var(--color-text-secondary);
  cursor: pointer;
}

/* ===== BOTONES ===== */
.btn {
  background: var(--color-success);
  color: white;
  border: none;
  border-radius: var(--border-radius);
  padding: 12px 24px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  margin-top: 1rem;
  box-shadow: var(--shadow);
  transition: background 0.2s;
}

.btn:hover,
.btn:focus {
  background: #15803d;
  outline: 2px solid white;
  outline-offset: 2px;
}

.btn-volver {
  display: inline-block;
  background: #64748b;
  color: white;
  text-decoration: none;
  padding: 10px 20px;
  border-radius: var(--border-radius);
  margin-top: 1.5rem;
  font-weight: 600;
  box-shadow: var(--shadow);
  transition: background 0.2s;
}

.btn-volver:hover,
.btn-volver:focus {
  background: #475569;
  outline: 2px solid white;
  outline-offset: 2px;
}

/* ===== RESULTADOS ===== */
#resultado {
  display: none;
  background: var(--color-primary-light);
  padding: 24px;
  border-radius: var(--border-radius);
  margin-top: 24px;
  box-shadow: var(--shadow);
  border: 1px solid #bfdbfe;
}

#resultado h2 {
  margin-top: 0;
  color: var(--color-primary);
}

#recomendaciones h3 {
  margin-top: 1.2rem;
  color: var(--color-text);
}

#recomendaciones p {
  background: white;
  padding: 16px;
  border-radius: 8px;
  border-left: 4px solid var(--color-warning);
  font-style: italic;
}

/* ===== INFORME GLOBAL (en nueva ventana) ===== */
.informe-global {
  font-family: var(--font-main);
  padding: 20px;
  background: var(--color-bg);
  color: var(--color-text);
}

.informe-global h2 {
  text-align: center;
  color: var(--color-primary);
  margin-bottom: 20px;
}

.informe-global h3 {
  background: var(--color-surface);
  padding: 12px;
  border-radius: 8px;
  margin: 20px 0 12px;
  box-shadow: var(--shadow);
}

.informe-global ul {
  padding-left: 20px;
}

.informe-global li {
  margin-bottom: 12px;
  line-height: 1.6;
}

.informe-global .alerta {
  color: var(--color-danger);
  font-weight: 600;
}

.informe-global .positivo {
  color: var(--color-success);
  font-weight: 600;
}

/* ===== ACCESIBILIDAD Y ENFOQUE ===== */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* ===== IMPRESIÓN ===== */
@media print {
  .btn,
  .btn-volver,
  .menu a {
    display: none !important;
  }

  body,
  .test-container,
  #resultado {
    background: white !important;
    color: black !important;
    box-shadow: none !important;
  }

  #resultado {
    padding: 15px;
    border: 1px solid #ccc;
  }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 600px) {
  header h1 {
    font-size: 1.5rem;
  }

  .opcion label {
    font-size: 0.95rem;
  }

  .btn, .btn-informe, .btn-volver {
    width: 100%;
    padding: 14px;
  }
}

.btn-volver{
  display: block;
  width: 100%;
  padding: 12px 15px;
  background: #0d9488; /* Verde esmeralda suave - asociado a salud */
  color: white;
  text-align: center;
  text-decoration: none;
  border-radius: var(--border-radius);
  font-weight: 600;
  font-size: 1.05rem;
  margin-top: 20px;
  box-shadow: var(--shadow);
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.btn-volver:hover,
.btn-volver:focus {
color : white;
  background: #30baaf; /* Verde más oscuro al pasar el ratón */
  transform: translateY(-2px);
  box-shadow: 0 6px 12px -2px rgba(0, 0, 0, 0.12);
  outline: 2px solid white;
  outline-offset: 2px;
}

/* Añadir después de las variables :root o al final del bloque <style> */

/* Estilo específico para el botón de importar CSV */
#btn-importar-csv { /* Selecciona el botón dentro del form-datos */
  background: #0d9488; /* Verde esmeralda suave */
  color: white;
  border: none;
  border-radius: var(--border-radius); /* Usa la variable definida */
  padding: 12px 16px; /* Un poco más relleno */
  font-size: 1rem; /* Tamaño de fuente consistente */
  font-weight: 600; /* Fuente en negrita */
  cursor: pointer;
  margin-top: 10px; /* Espacio encima */
  margin-bottom: 15px; /* Espacio debajo */
  box-shadow: var(--shadow); /* Usa la variable de sombra */
  transition: all 0.2s ease; /* Transición suave para hover */
  width: 100%; /* Opcional: para que ocupe todo el ancho del contenedor */
  max-width: 300px; /* Opcional: para limitar el ancho máximo */
  display: block; /* Opcional: para que el margin auto funcione si se centra */
  margin-left: auto; /* Opcional: para centrar el botón */
  margin-right: auto; /* Opcional: para centrar el botón */
}

#btn-importar-csv :hover,
#btn-importar-csv :focus {
  background: #30baaf; /* Verde más oscuro al pasar el ratón */
  transform: translateY(-2px); /* Pequeño efecto de elevación */
  box-shadow: 0 6px 12px -2px rgba(0, 0, 0, 0.12); /* Sombra más pronunciada al hacer hover */
  outline: 2px solid white; /* Borde blanco al hacer foco */
  outline-offset: 2px; /* Espacio entre el borde y el botón */
}

/* Opcional: Si prefieres un estilo más similar al botón .btn existente */
/*
#form-datos button[type="button"] {
  background: #16a34a; // Verde éxito
  color: white;
  border: none;
  border-radius: var(--border-radius);
  padding: 12px 24px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  margin-top: 1rem;
  box-shadow: var(--shadow);
  transition: background 0.2s;
  width: 100%;
}

#form-datos button[type="button"]:hover,
#form-datos button[type="button"]:focus {
  background: #15803d; // Verde más oscuro
  outline: 2px solid white;
  outline-offset: 2px;
}
*/
  </style>

  <!-- Firebase SDK (versión 8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>

  <!-- Menú principal -->
  <!-- 🔗 Botón de navegación añadido -->

  <div id="menu" class="menu">
    <header><h1>Healthy Friday - Estaciones</h1></header>
	  
    <main>
		 <!-- Botón para importar CSV -->
		
		<!-- Dentro del <form id="form-datos"> -->
		<!-- Antes del resto de campos -->
		<div id="import-csv-section" style="display: none;"> <!-- Oculto por defecto -->
		<!-- Dentro del <form id="form-datos">, antes del resto de campos o justo después del botón de importar si ya lo tienes -->
		<input type="file" id="filePickerCSV" accept=".csv" style="display: none;">
		<button type="button" id="btn-importar-csv" onclick="abrirSelectorYVerificarContraseña()">🔐 Importar Lista de Alumnos (CSV)</button>
		</div>
<!-- ... resto de campos (curso, edad, sexo) ... -->
      <h2>Selecciona el test de esta estación:</h2>
      <ul>
        <li><a href="#" onclick="cargarTest('postura')">Estacion 1: Higiene Postural</a></li>
        <li><a href="#" onclick="cargarTest('actividad')">Estacion 2: Actividad Física</a></li>
        <li><a href="#" onclick="cargarTest('azucar')">Estacion 3: Azúcar y Alimentación</a></li>
        <li><a href="#" onclick="cargarTest('alimentacion')">Estacion 4: Hábitos Alimenticios</a></li>
        <li><a href="#" onclick="cargarTest('composicion')">Estación 5: Composición Corporal</a></li>
        <li><a href="#" onclick="cargarTest('medioambiente')">Estacion 6: Cuidado Medioambiental</a></li>
        <li><a href="#" onclick="cargarTest('espalda')">Estación 7: Higiene de la Espalda</a></li>
        <li><a href="#" onclick="cargarTest('fuerza')">Estación 8: Deporte y Fuerza</a></li>
        <li><a href="#" onclick="cargarTest('sueno')">Estación 9: Hábitos de Sueño (Padres)</a></li>
        <li><a href="#" onclick="cargarTest('relajacion')">Estación 10: Relajación</a></li>
      </ul>
      <button class="btn" onclick="generarInformeAnalitico()" style="width:100%; margin-top:20px;">📊 Informe Global por Curso y Sexo</button>
	      <a href="https://fermagil.github.io/Nutri_Plan_v2/salud-escolar.html" target="_blank" class="btn-volver" style="display: block; text-align: center; margin-top: 20px; text-decoration: none; width: 100%;">
      🏫 Ir a Programa Salud Escolar
    </a>
    </main>
  </div>

  <!-- Formulario de test -->
  <div id="test" style="display:none;" class="test-container">
    <header><h1 id="titulo-test">Test</h1></header>
    
   <form id="form-datos">
	  <label for="codigoAlumno">Código de alumno:</label>
	  <select id="codigoAlumno" required>
	    <option value="">-- Importa la lista de alumnos --</option>
	    <!-- Las opciones se llenarán dinámicamente -->
	  </select>
	 
	
	  <label for="curso">Curso:</label>
	  <select id="curso" required>
	    <option value="">-- Selecciona --</option>
	    <option value="1º ESO">1º ESO</option>
	    <option value="2º ESO">2º ESO</option>
	    <option value="3º ESO">3º ESO</option>
	    <option value="4º ESO">4º ESO</option>
	    <option value="1º BACHILLER">1º BACHILLER</option> <!-- Puede mantenerse si es necesario -->
	  </select>
	
	  <label for="edad">Edad:</label>
	  <input type="number" id="edad" min="10" max="18" required>
	
	  <label for="sexo">Sexo:</label>
	  <select id="sexo" required>
	    <option value="masculino">Masculino</option>
	    <option value="femenino">Femenino</option>
	    <option value="nobinario">No binario</option>
	  </select>
</form>

    <form id="form-preguntas"></form>

    <button class="btn" onclick="calcularResultado()">Calcular Resultado</button>
    <a href="#" class="btn-volver" onclick="mostrarMenu()">← Volver al menú</a>

    <div id="resultado">
      <h2>Resultados</h2>
      <p><strong>Puntuación total:</strong> <span id="puntaje"></span></p>
      <p><strong>Nivel:</strong> <span id="nivel"></span></p>
      <div id="recomendaciones"></div>
      <br />
      <button class="btn" onclick="window.print()">🖨️ Imprimir Resultados</button>
    </div>
  </div>

<script type="module">
  // 1. Importar Firebase
 
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, query, where, orderBy, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; // Asegúrate de que 'doc', 'getDoc', 'setDoc' estén aquí


  // 2. Configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyChC7s5NN-z-dSjqeXDaks7gaNaVCJAu7Q",
    authDomain: "nutriplanv2.firebaseapp.com",
    projectId: "nutriplanv2",
    storageBucket: "nutriplanv2.firebasestorage.app",
    messagingSenderId: "653707489758",
    appId: "1:653707489758:web:9133d1d1620825c385ed4f",
    measurementId: "G-NWER69E8B6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // 3. Datos de los tests (sin cambios)
  const tests = {
    postura: {
      titulo: "Higiene Postural",
      preguntas: [
        "¿Mantienes una postura erguida en clase, con espalda apoyada y pies en el suelo?",
        "¿Llevas la mochila correctamente, con ambas correas y ajustada a la espalda, sin exceder el 10% de tu peso?",
        "¿Usas ordenadores o teléfonos con la pantalla a la altura de los ojos, evitando encorvarte?",
        "¿Haces pausas para estirarte durante sesiones prolongadas en clase o frente a pantallas?",
        "¿Evitas posturas asimétricas, como cruzar piernas o inclinarte al usar dispositivos?"
      ],
      recomendaciones: [
        "Comienza con lo básico: Pesa tu mochila y asegúrate de no exceder el 10% de tu peso; ajusta correas. Corrige postura en clase y eleva pantallas.",
        "Enfócate en rutina: Usa soportes para evitar encorvamiento. Haz pausas activas cada hora.",
        "Avanza: Incorpora estiramientos diarios y corrige posturas asimétricas. Monitorea tu mochila semanalmente.",
        "Refina: Enseña a otros sobre higiene postural. Usa recordatorios visuales.",
        "Excelente: Lidera talleres y comparte buenos hábitos."
      ]
    },
    actividad: {
      titulo: "Actividad Física",
      preguntas: [
        "¿Realizas al menos 60 minutos de actividad física diaria (caminar, bailar, etc.)?",
        "¿Evitas periodos prolongados de sedentarismo, levantándote cada hora?",
        "¿Participas en juegos divertidos como Just Dance u otros para hacer AF?",
        "¿Incluyes variedad: fuerza, flexibilidad y cardio en tu AF semanal?",
        "¿Priorizas AF para mantener un cuerpo en forma y una mente calmada?"
      ],
      recomendaciones: [
        "Comienza: Camina 30 min + juega 30 min. Usa Just Dance para motivarte.",
        "Enfócate: Rompe el sedentarismo cada hora. Apunta a 60 min diarios.",
        "Avanza: Varía con fuerza y flexibilidad. Únete a grupos.",
        "Refina: Usa apps para tracking. Enseña a otros.",
        "Excelente: Lidera sesiones y explora yoga o ciclismo."
      ]
    },
    azucar: {
      titulo: "Azúcar y Alimentación",
      preguntas: [
        "¿Evitas bebidas azucaradas como refrescos, energéticas o jugos procesados?",
        "¿Reemplazas golosinas o bebidas dulces por opciones naturales como fruta?",
        "¿Lees etiquetas de productos para verificar el contenido de azúcares añadidos?",
        "¿Consumes menos de una bebida azucarada por semana?",
        "¿Sigues guías como las de la OMS para limitar azúcares libres?"
      ],
      recomendaciones: [
        "Comienza: Elimina una bebida azucarada diaria. Reemplaza por agua o fruta.",
        "Enfócate: Limita a 1 bebida azucarada/semana. Lee etiquetas.",
        "Avanza: Elige productos con 0g azúcar añadido. Monitorea tu consumo.",
        "Refina: Organiza chequeos de salud. Enseña sobre equivalentes de azúcar.",
        "Excelente: Lidera campañas contra bebidas azucaradas."
      ]
    },
    alimentacion: {
      titulo: "Hábitos Alimenticios",
      preguntas: [
        "¿Consumes al menos cinco piezas de fruta o raciones de verdura al día?",
        "¿Reemplazas golosinas o snacks procesados por opciones naturales como fruta?",
        "¿Eliges comida real (frutas, verduras, proteínas frescas) sobre sustancias comestibles?",
        "¿Sigues el Plato de Harvard: mitad vegetales, cuarto granos, cuarto proteínas?",
        "¿Incorporas frutas como postre o snack saludable en tu rutina diaria?"
      ],
      recomendaciones: [
        "Comienza: Cambia una golosina por fruta. Añade una ensalada diaria.",
        "Enfócate: Prepara snacks de fruta. Agrega verduras a cada comida.",
        "Avanza: Cocina platos reales. Evita bebidas azucaradas.",
        "Refina: Experimenta con recetas del Plato de Harvard.",
        "Excelente: Lidera grupos de alimentación saludable."
      ]
    },
    composicion: {
      titulo: "Composición Corporal",
      preguntas: [
        "¿Consumes una dieta equilibrada con al menos 5 porciones de frutas y verduras al día?",
        "¿Controlas las porciones de comida y evitas comer en exceso?",
        "¿Realizas actividad física regular (al menos 150 minutos semanales)?",
        "¿Bebes suficiente agua (al menos 2 litros al día) y limitas bebidas azucaradas?",
        "¿Duermes entre 7-9 horas por noche?"
      ],
      recomendaciones: [
        "Comienza: Calcula tu IMC. Camina 30 min diarios. Reduce porciones.",
        "Enfócate: Registra tu ingesta. Agrega fuerza 2-3 veces/semana.",
        "Avanza: Mide circunferencias. Integra dieta mediterránea.",
        "Refina: Haz chequeos anuales. Enseña sobre sobrepeso en España.",
        "Excelente: Lidera grupos de nutrición."
      ]
    },
    medioambiente: {
      titulo: "Cuidado Medioambiental",
      preguntas: [
        "¿Recoges papeles o basura del suelo y los tiras a la papelera?",
        "¿Evitas tirar basura en el suelo, incluso si no hay papelera cerca?",
        "¿Separas residuos reciclables (papel, plástico) antes de desecharlos?",
        "¿Usas productos reutilizables (botellas, bolsas) en lugar de desechables?",
        "¿Participas en actividades de limpieza o brigadas verdes?"
      ],
      recomendaciones: [
        "Comienza: Lleva siempre la basura a la papelera. Recoge 5 papeles diarios.",
        "Enfócate: Separa reciclables. Organiza limpiezas semanales.",
        "Avanza: Crea carteles ambientales. Reporta papeleras llenas.",
        "Refina: Lidera plantaciones. Enseña sobre impacto del littering.",
        "Excelente: Organiza eventos de Brigada Verde mensuales."
      ]
    },
    espalda: {
      titulo: "Higiene de la Espalda",
      preguntas: [
        "¿Realizas estiramientos diarios para los isquiotibiales y la espalda?",
        "¿Mantienes una postura correcta al sentarte o estar de pie?",
        "¿Evitas cargar mochilas pesadas o distribuir el peso de manera desigual?",
        "¿Realizas pausas para estirarte durante periodos largos sentado?",
        "¿Duermes en una posición que apoye la curvatura natural de la espalda?"
      ],
      recomendaciones: [
        "Comienza: Estira isquios diarios. Evita mochilas pesadas.",
        "Enfócate: Corrige postura con recordatorios. Haz pausas activas.",
        "Avanza: Mide flexibilidad semanal. Usa almohadas de apoyo al dormir.",
        "Refina: Organiza chequeos posturales. Enseña sobre acortamiento de isquios.",
        "Excelente: Lidera grupos de higiene postural."
      ]
    },
    fuerza: {
      titulo: "Deporte y Fuerza",
      preguntas: [
        "¿Practicas ejercicios de fuerza (flexiones, sentadillas) al menos 2-3 veces por semana?",
        "¿Incorporas deporte en tu rutina diaria para mejorar la fuerza?",
        "¿Evitas el sedentarismo prolongado?",
        "¿Sigues una dieta que apoye el desarrollo de fuerza, con proteínas adecuadas?",
        "¿Participas en actividades que reduzcan el estrés, como el deporte?"
      ],
      recomendaciones: [
        "Comienza: Haz 10 flexiones diarias. Camina 30 min.",
        "Enfócate: Agrega 20 min de fuerza, 3 veces/semana.",
        "Avanza: Usa normogramas AVENA. Varía con cardio y fuerza.",
        "Refina: Ajusta dieta. Enseña sobre fuerza y salud mental.",
        "Excelente: Lidera grupos de deporte."
      ]
    },
    sueno: {
      titulo: "Hábitos de Sueño (Padres)",
      preguntas: [
        "¿Se acuesta más o menos a la misma hora todas las noches?",
        "¿Le cuesta mucho dormirse (más de 30 min)?",
        "¿Duerme entre 9 y 12 horas por noche?",
        "¿Se despierta varias veces sin razón?",
        "¿Usa pantallas menos de 1 hora antes de dormir?"
      ],
      recomendaciones: [
        "Es urgente mejorar: Establece horario fijo, elimina pantallas 1h antes. Consulta al pediatra si no mejora.",
        "Vas por buen camino: Reduce pantallas, asegura 9–12 h de sueño.",
        "¡Muy bien! Solo ajusta detalles: mantén rutina sin pantallas.",
        "Tu hijo/a tiene hábitos ejemplares. ¡Sigue así!"
      ],
      tipo: "binario",
      invertidas: [1, 3, 4] // índices base 0: preguntas 2, 4, 5 → favorables = "No"
    },
    relajacion: {
      titulo: "Relajación",
      preguntas: [
        "¿Dedicas al menos 30 minutos al día a actividades sin pantallas?",
        "¿Evitas el uso de dispositivos electrónicos al menos 1 hora antes de dormir?",
        "¿Practicas técnicas de respiración profunda o meditación diaria?",
        "¿Limitas el tiempo en redes sociales para evitar el estrés?",
        "¿Buscas entornos naturales o tranquilos, lejos de pantallas?"
      ],
      recomendaciones: [
        "Comienza: Establece 30 min diarios sin pantallas. Prueba respiración 4-6 seg.",
        "Enfócate: Silencia notificaciones después de las 8 PM. Usa journaling.",
        "Avanza: Crea zonas sin pantallas en casa. Apunta a <2h recreativas/día.",
        "Refina: Organiza 'días offline'. Enseña sobre luz azul y melatonina.",
        "Excelente: Lidera grupos de relajación. Promueve alternativas analógicas."
      ]
    }
  };

  // 4. Variables globales
  let testActual = null;

  // 5. Función para cargar contadores (solo si el usuario tiene rol)
  async function loadCounters() {
    // Verificar rol antes de leer
    const user = auth.currentUser;
    if (!user) return;
    const token = await user.getIdTokenResult();
    if (token.claims.rol !== "salud_escolar") return;

    try {
      const snapshot = await getDocs(collection(db, "resultadosHealthyFriday"));
      const count = snapshot.size;
      // Si tienes un elemento en tu HTML para mostrar este contador, descomenta y cámbialo:
      // document.getElementById('contadorHF').textContent = count; // Asume que tienes <span id="contadorHF">0</span>
      console.log(`Total resultados Healthy Friday: ${count}`); // Opcional: para debug
    } catch (error) {
      console.error("Error al cargar contadores de Healthy Friday:", error);
    }
  }

  // 6. Funciones de UI (sin cambios en lógica, solo expuestas globalmente)
  function mostrarMenu() {
    document.getElementById('menu').style.display = 'block';
    document.getElementById('test').style.display = 'none';
  }

  function cargarTest(tipo) {
    const test = tests[tipo];
    if (!test) return;

    testActual = tipo;
    document.getElementById('titulo-test').textContent = test.titulo;
    document.getElementById('form-preguntas').innerHTML = '';

    if (test.tipo === 'binario') {
      document.querySelector('.sueno-nota')?.remove();
      const nota = document.createElement('div');
      nota.className = 'sueno-nota';
      nota.innerHTML = '<strong>¡Importante!</strong> En las preguntas 2, 8 y 10, la respuesta favorable es “No”. En las demás, es “Sí”.';
      document.getElementById('form-datos').after(nota);
    }

    test.preguntas.forEach((pregunta, i) => {
      const div = document.createElement('div');
      div.className = 'pregunta-item';
      div.innerHTML = `<p><strong>${i + 1}.</strong> ${pregunta}</p>`;

      if (test.tipo === 'binario') {
        div.innerHTML += `
          <div class="opcion">
            <label><input type="radio" name="q${i}" value="si" required> Sí</label>
          </div>
          <div class="opcion">
            <label><input type="radio" name="q${i}" value="no" required> No</label>
          </div>
        `;
      } else {
        const opciones = ['Nunca', 'Rara vez', 'A veces', 'Frecuentemente', 'Siempre'];
        opciones.forEach((texto, idx) => {
          div.innerHTML += `
            <div class="opcion">
              <label><input type="radio" name="q${i}" value="${idx + 1}" required> ${idx + 1}: ${texto}</label>
            </div>
          `;
        });
      }

      document.getElementById('form-preguntas').appendChild(div);
    });

    document.getElementById('menu').style.display = 'none';
    document.getElementById('test').style.display = 'block';
    document.getElementById('resultado').style.display = 'none';
  }

  // 7. Función para calcular y guardar resultados (actualizada)
  async function calcularResultado() {
    const test = tests[testActual];
    let total = 0;
    const respuestas = {};

    if (test.tipo === 'binario') {
      test.preguntas.forEach((_, i) => {
        const si = document.querySelector(`input[name="q${i}"][value="si"]:checked`);
        const no = document.querySelector(`input[name="q${i}"][value="no"]:checked`);
        if (!si && !no) {
          alert("Por favor responde todas las preguntas.");
          return;
        }
        const valor = si ? 'si' : 'no';
        respuestas[`q${i + 1}`] = valor;
        const esInvertida = test.invertidas.includes(i);
        if ((si && !esInvertida) || (no && esInvertida)) {
          total += 1;
        }
      });
      let nivel, recIndex;
      if (total <= 2) { nivel = "Mal hábito"; recIndex = 0; }
      else if (total <= 3) { nivel = "A mejorar"; recIndex = 1; }
      else if (total <= 4) { nivel = "Bueno"; recIndex = 2; }
      else { nivel = "Excelente"; recIndex = 3; }
      document.getElementById('puntaje').textContent = `${total} / 5`;
      document.getElementById('nivel').textContent = nivel;
      document.getElementById('recomendaciones').innerHTML = `<h3>Recomendaciones:</h3><p>${test.recomendaciones[recIndex]}</p>`;
    } else {
      test.preguntas.forEach((_, i) => {
        const selected = document.querySelector(`input[name="q${i}"]:checked`);
        if (!selected) {
          alert("Por favor responde todas las preguntas.");
          return;
        }
        const valor = parseInt(selected.value);
        respuestas[`q${i + 1}`] = valor;
        total += valor;
      });
      let nivel, recIndex;
      if (total <= 7) { nivel = "Mal hábito"; recIndex = 0; }
      else if (total <= 12) { nivel = "Regular"; recIndex = 1; }
      else if (total <= 17) { nivel = "Bueno"; recIndex = 2; }
      else if (total <= 22) { nivel = "Muy bueno"; recIndex = 3; }
      else { nivel = "Excelente"; recIndex = 4; }
      document.getElementById('puntaje').textContent = `${total} / 25`;
      document.getElementById('nivel').textContent = nivel;
      document.getElementById('recomendaciones').innerHTML = `<h3>Recomendaciones:</h3><p>${test.recomendaciones[recIndex]}</p>`;
    }

    // === Guardar en Firestore ===
    const codigoAlumno = document.getElementById('codigoAlumno').value.trim().toUpperCase();
    const curso = document.getElementById('curso').value.trim();
    const edad = parseInt(document.getElementById('edad').value);
    const sexo = document.getElementById('sexo').value;

    if (!codigoAlumno || !curso || !edad || !sexo) {
      alert("Por favor completa todos los datos.");
      return;
    }

    const resultado = {
      codigoAlumno,
      testId: testActual,
      titulo: test.titulo,
      curso,
      edad,
      sexo,
      respuestas,
      puntaje: total,
      nivel: document.getElementById('nivel').textContent,
      fecha: serverTimestamp() // Usar hora del servidor
    };

    try {
      await addDoc(collection(db, "resultadosHealthyFriday"), resultado);
      console.log("✅ Resultado guardado para:", codigoAlumno, "en test:", testActual);
      // --- Actualizar contadores inmediatamente después de guardar ---
      await loadCounters(); // <- Llama a la función para actualizar
      // ------------------------------------------------------------
    } catch (error) {
      console.error("❌ Error al guardar:", error);
      alert("Error al guardar. ¿Hay conexión a internet?");
      return;
    }

    document.getElementById('resultado').style.display = 'block';
  }

  // 8. Función para generar informe analítico (actualizada y completada)
  async function generarInformeAnalitico() {
    // Verificar rol antes de leer
    const user = auth.currentUser;
    if (!user) {
        alert("Usuario no autenticado.");
        window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
        return;
    }
    const token = await user.getIdTokenResult();
    if (token.claims.rol !== "salud_escolar") {
        alert("Acceso denegado: solo profesores autorizados.");
        signOut(auth).then(() => {
            window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
        });
        return;
    }

    try {
      const snapshot = await getDocs(collection(db, "resultadosHealthyFriday"));
      if (snapshot.empty) {
        alert("No hay resultados aún.");
        return;
      }

      // Recopilar todos los resultados
      const todos = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        // Normalizar puntaje a escala 0-100 para comparabilidad
        let puntajeNormalizado;
        if (data.testId === 'sueno') {
          // Test binario: max 5 puntos → escala a 100
          puntajeNormalizado = (data.puntaje / 5) * 100;
        } else {
          // Tests de 5 preguntas: max 25 puntos → escala a 100
          puntajeNormalizado = (data.puntaje / 25) * 100;
        }
        todos.push({ ...data, puntaje100: puntajeNormalizado });
      });

      // [Misma lógica de cálculo del informe analítico que tenías antes]
      // --- Inicio de la lógica de cálculo del informe ---
      const alumnos = {};
      todos.forEach(r => {
        if (!alumnos[r.codigoAlumno]) {
          alumnos[r.codigoAlumno] = {
            codigo: r.codigoAlumno,
            curso: r.curso,
            sexo: r.sexo,
            puntajes: [],
            tests: new Set()
          };
        }
        // Evitar duplicados si un alumno repite un test
        if (!alumnos[r.codigoAlumno].tests.has(r.testId)) {
          alumnos[r.codigoAlumno].puntajes.push(r.puntaje100);
          alumnos[r.codigoAlumno].tests.add(r.testId);
        }
      });

      // Calcular promedio por alumno
      const alumnosConPromedio = Object.values(alumnos).map(a => {
        const promedio = a.puntajes.reduce((sum, p) => sum + p, 0) / a.puntajes.length;
        return {
          codigo: a.codigo,
          curso: a.curso,
          sexo: a.sexo,
          promedio,
          completados: a.puntajes.length
        };
      }).filter(a => a.completados >= 5); // Solo alumnos con al menos 5 tests

      if (alumnosConPromedio.length === 0) {
        alert("No hay alumnos con suficientes tests completados.");
        return;
      }

      // === 2. Mejores y peores cursos (por promedio de alumnos en ese curso) ===
      const cursos = {};
      alumnosConPromedio.forEach(a => {
        if (!cursos[a.curso]) cursos[a.curso] = [];
        cursos[a.curso].push(a.promedio);
      });

      const promedioCurso = {};
      for (const [curso, promedios] of Object.entries(cursos)) {
        promedioCurso[curso] = promedios.reduce((sum, p) => sum + p, 0) / promedios.length;
      }

      const cursosOrdenados = Object.entries(promedioCurso)
        .sort((a, b) => b[1] - a[1]);
      const mejorCurso = cursosOrdenados[0];
      const peorCurso = cursosOrdenados[cursosOrdenados.length - 1];

      // === 3. Comparativa global por género ===
      const genero = { masculino: [], femenino: [], nobinario: [] };
      alumnosConPromedio.forEach(a => {
        if (genero[a.sexo]) genero[a.sexo].push(a.promedio);
      });

      const promedioGenero = {};
      for (const [g, promedios] of Object.entries(genero)) {
        if (promedios.length > 0) {
          promedioGenero[g] = promedios.reduce((sum, p) => sum + p, 0) / promedios.length;
        }
      }

      // Determinar género con mejor promedio
      let mejorGenero = null;
      let mejorPromedio = -1;
      for (const [g, prom] of Object.entries(promedioGenero)) {
        if (prom > mejorPromedio) {
          mejorPromedio = prom;
          mejorGenero = g;
        }
      }

      // === 4. Diferencias por género dentro de cada curso ===
      const comparativaPorCurso = {};
      for (const curso of Object.keys(cursos)) {
        const datos = alumnosConPromedio.filter(a => a.curso === curso);
        const generosEnCurso = { masculino: [], femenino: [], nobinario: [] };
        datos.forEach(a => {
          if (generosEnCurso[a.sexo]) generosEnCurso[a.sexo].push(a.promedio);
        });

        comparativaPorCurso[curso] = {};
        for (const [g, promedios] of Object.entries(generosEnCurso)) {
          if (promedios.length > 0) {
            comparativaPorCurso[curso][g] = (promedios.reduce((sum, p) => sum + p, 0) / promedios.length).toFixed(1);
          }
        }
      }

      // === 5. Top 3 alumnos con mejor promedio ===
      const top3 = alumnosConPromedio
        .sort((a, b) => b.promedio - a.promedio)
        .slice(0, 3);
      // --- Fin de la lógica de cálculo del informe ---

      // === 6. Generar HTML del informe ===
      let html = `<h2>📊 Informe Analítico Healthy Friday</h2>`;
      html += `<p><em>Generado: ${new Date().toLocaleString()}</em></p><hr>`;

      // Mejor y peor curso
      html += `<h3>🏆 Mejor y Peor Curso</h3>`;
      html += `<p><strong>Mejor curso:</strong> ${mejorCurso[0]} (${mejorCurso[1].toFixed(1)}%)</p>`;
      html += `<p><strong>Peor curso:</strong> ${peorCurso[0]} (${peorCurso[1].toFixed(1)}%)</p><hr>`;

      // Comparativa por género
      html += `<h3>👥 Comparativa por Género (Global)</h3>`;
      for (const [g, prom] of Object.entries(promedioGenero)) {
        const nombre = g === 'masculino' ? 'Chicos' : g === 'femenino' ? 'Chicas' : 'No binario';
        html += `<p><strong>${nombre}:</strong> ${prom.toFixed(1)}%</p>`;
      }
      const nombreMejorGenero = mejorGenero === 'masculino' ? 'Chicos' : mejorGenero === 'femenino' ? 'Chicas' : 'No binario';
      html += `<p><strong>✅ Grupo con mejor desempeño:</strong> ${nombreMejorGenero}</p><hr>`;

      // Diferencias por curso y género
      html += `<h3>🔍 Comparativa por Curso y Género</h3>`;
      for (const [curso, generos] of Object.entries(comparativaPorCurso)) {
        html += `<h4>${curso}</h4><ul>`;
        for (const [g, prom] of Object.entries(generos)) {
          const nombre = g === 'masculino' ? 'Chicos' : g === 'femenino' ? 'Chicas' : 'No binario';
          html += `<li>${nombre}: ${prom}%</li>`;
        }
        html += `</ul>`;
      }
      html += `<hr>`;

      // Top 3 alumnos
      html += `<h3>🥇 Top 3 Alumnos Destacados</h3>`;
      top3.forEach((alumno, i) => {
        const posicion = ['1º', '2º', '3º'][i];
        const generoTexto = alumno.sexo === 'masculino' ? 'Chico' : alumno.sexo === 'femenino' ? 'Chica' : 'No binario';
        html += `<p><strong>${posicion}:</strong> ${alumno.codigo} (${generoTexto}, ${alumno.curso}) – ${alumno.promedio.toFixed(1)}%</p>`;
      });

      // Abrir en nueva ventana
      const win = window.open('', '_blank');
      win.document.write(`
        <html>
        <head>
          <title>Informe Analítico Healthy Friday</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
            h2 { color: #2563eb; text-align: center; }
            h3 { color: #1e293b; margin-top: 24px; }
            h4 { color: #475569; margin-top: 16px; }
            ul { padding-left: 20px; }
            li { margin-bottom: 8px; }
            hr { margin: 24px 0; border: 0; border-top: 1px solid #e2e8f0; }
          </style>
        </head>
        <body>${html}</body>
        </html>
      `);
      win.document.close();

    } catch (error) {
      console.error("Error en informe analítico:", error);
      alert("No se pudo generar el informe analítico.");
    }
  }
// --- NUEVAS FUNCIONES PARA GESTIÓN DE ALUMNOS ---

// --- FUNCIONES MODIFICADAS PARA USAR FIRESTORE ---

// 1. Función para importar CSV (con contraseña y guardado en Firestore)
let archivoPendiente = null;

// --- FUNCIÓN PARA ABRIR EL SELECTOR DE ARCHIVOS INMEDIATAMENTE ---
function abrirSelectorYVerificarContraseña() {
  // Al hacer clic en el botón, inmediatamente se abre el selector de archivos
  // Esto garantiza "user activation".
  const input = document.getElementById('filePickerCSV');
  input.click(); // <-- Este click ocurre inmediatamente tras el click del usuario
}
// --- FUNCIÓN PARA PROCESAR EL ARCHIVO SELECCIONADO (ahora con verificación de contraseña) ---
// Esta función se define una sola vez y se asigna al onchange del input oculto
// Idealmente, esto debería suceder una vez al inicializar la página, si el rol es correcto.
async function procesarArchivoCSVSeleccionado(event) {
  const file = event.target.files[0];
  if (!file) {
      console.log("No se seleccionó ningún archivo (posiblemente cancelado por el usuario).");
      return; // El usuario canceló la selección
  }
// Verificar la contraseña *después* de que se haya seleccionado un archivo
  const CONTRASENA_CSV = "healthy_Friday_2025";
  const pass = prompt("Introduzca la contraseña para importar la lista de alumnos:");
  if (pass !== CONTRASENA_CSV) {
    alert("Contraseña incorrecta. Importación cancelada.");
    return; // Detener la ejecución si la contraseña no es válida
  }
	
  try {
    const csvText = await file.text();
    const alumnos = parseCSV(csvText); // Asumiendo que parseCSV está definida como antes

    // --- GUARDAR EN FIRESTORE ---
    // Usar 'db' y 'doc' que deben estar importados en el scope del módulo
    // Asegúrate de que 'db' sea accesible aquí (debe estar definido en el scope superior del módulo)
    await setDoc(doc(db, "resultadosHealthyFriday", "global"), { alumnosCSV: alumnos }, { merge: true });
    console.log(`✅ ${alumnos.length} alumnos guardados en Firestore.`);

    // Actualizar la variable local y el select inmediatamente después de guardar
    listaDeAlumnos = alumnos; // Actualizar la lista en memoria
    actualizarSelectCodigos(alumnos);
    alert(`Importados y guardados ${alumnos.length} alumnos correctamente.`);
  } catch (error) {
    console.error("Error al importar o guardar CSV:", error);
    alert(`Error al leer, procesar o guardar el archivo CSV: ${error.message}`);
  }
}


	
let listaDeAlumnos = []; // Variable global (o de módulo) para almacenar la lista cargada
// 2. Función para cargar alumnos desde Firestore (en lugar de localStorage)
// --- FUNCIÓN PARA CARGAR DESDE FIRESTORE (una sola vez) ---
async function cargarAlumnosDesdeFirestore() {
  try {
    const docRef = doc(db, "resultadosHealthyFriday", "global");
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
      const data = docSnap.data();
      // Actualizar la variable global con los datos obtenidos
      listaDeAlumnos = data.alumnosCSV || [];
      console.log(`✅ ${listaDeAlumnos.length} alumnos cargados en memoria desde Firestore.`);
      actualizarSelectCodigos(listaDeAlumnos);
      return listaDeAlumnos;
    } else {
      console.log("_firestore: No se encontró el documento de configuración global._");
      const select = document.getElementById('codigoAlumno');
      select.innerHTML = '<option value="">-- No hay alumnos disponibles --</option>';
      listaDeAlumnos = []; // Asegurar que la lista local también esté vacía
      return listaDeAlumnos;
    }
  } catch (error) {
    console.error("Error al cargar alumnos desde Firestore:", error);
    const select = document.getElementById('codigoAlumno');
    select.innerHTML = '<option value="">-- Error al cargar alumnos --</option>';
    listaDeAlumnos = []; // Asegurar que la lista local también esté vacía
    return listaDeAlumnos;
  }
}

// 3. Función para actualizar el select de códigos (sin cambios)
function actualizarSelectCodigos(alumnos) {
  const select = document.getElementById('codigoAlumno');
  select.innerHTML = '<option value="">-- Selecciona un alumno --</option>'; // Limpiar
  alumnos.forEach(alumno => {
    const option = document.createElement('option');
    option.value = alumno.NRE;
    option.textContent = `${alumno.NRE} - ${alumno.name || ''} ${alumno.ap1 || ''} ${alumno.ap2 || ''} (${alumno.curso || 'Curso no especificado'})`;
    select.appendChild(option);
  });
}

// 4. Función para manejar el cambio de selección de alumno (sin cambios)
function onCodigoAlumnoChange() {
  const codigoSeleccionado = document.getElementById('codigoAlumno').value;
  if (!codigoSeleccionado) {
    document.getElementById('curso').value = '';
    document.getElementById('edad').value = '';
    return;
  }
  // Cargar alumnos para encontrar el seleccionado
  // Para mejorar eficiencia, guarda la lista de alumnos en una variable global o en el scope del módulo
  // después de cargarla una vez, y úsala aquí.
  // Buscar el alumno en la lista almacenada en memoria, NO en Firestore
  const alumno = listaDeAlumnos.find(a => a.NRE === codigoSeleccionado);
     
     if (alumno) {
     document.getElementById('curso').value = alumno.curso;
     let edadCalculada = '';
     switch(alumno.curso) {
       case '1º ESO':
         edadCalculada = 11;
         break;
       case '2º ESO':
         edadCalculada = 12;
         break;
       case '3º ESO':
         edadCalculada = 13;
         break;
       case '4º ESO':
         edadCalculada = 15;
         break;
       default:
         break;
     }
     if (edadCalculada) {
         document.getElementById('edad').value = edadCalculada;
     }
  } else {
     // Opcional: Limpiar si no se encuentra (aunque debería existir si está en el select)
     document.getElementById('curso').value = '';
     document.getElementById('edad').value = '';
  }
}

// --- FIN NUEVAS FUNCIONES ---
  // 9. Protección principal: verificar autenticación y rol
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const token = await user.getIdTokenResult();
      if (token.claims.rol === "salud_escolar") {
        // ✅ Acceso permitido: mostrar menú y cargar contadores
        document.getElementById('menu').style.display = 'block'; // Mostrar menú inicial
		 
		  document.getElementById('import-csv-section').style.display = 'block'; // Mostrar el botón de importar
        await loadCounters(); // Cargar contadores al inicio
		  // --- Añadir nuevas funcionalidades ---
			await cargarAlumnosDesdeFirestore(); // Cargar lista desde Firestore
			// Añadir listener al select de código de alumno
			document.getElementById('codigoAlumno').addEventListener('change', onCodigoAlumnoChange);
			// --- Fin nuevas funcionalidades ---
        // Exponer funciones globales para onclick en HTML
		
        window.cargarTest = cargarTest;
        window.calcularResultado = calcularResultado;
        window.generarInformeAnalitico = generarInformeAnalitico;
        window.mostrarMenu = mostrarMenu;
		 window.abrirSelectorYVerificarContraseña = abrirSelectorYVerificarContraseña; 
		document.getElementById('filePickerCSV').onchange = procesarArchivoCSVSeleccionado;
		document.getElementById('filePickerCSV').onchange = procesarArchivoCSVSeleccionado;
		  
        window.logout = () => {
          signOut(auth).then(() => {
            window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
          });
        };
      } else {
        // ❌ Sin rol
		document.getElementById('import-csv-section').style.display = 'none'; // Asegurar que esté oculto
        alert("Acceso denegado: solo profesores autorizados.");
        signOut(auth).then(() => {
          window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
        });
      }
    } else {
      // ❌ No autenticado
		document.getElementById('import-csv-section').style.display = 'none'; // Asegurar que esté oculto
      window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
    }
  });

  // 10. Alerta de bases (sin cambios)
  window.addEventListener('DOMContentLoaded', () => {
    const bases = `🏆 BASES DEL CONCURSO HEALTHY FRIDAY 🏆

• Cada alumno debe completar los 10 tests (uno por estación).
• Para participar en el ranking, se requiere haber completado al menos 5 tests.
• Los 3 alumnos con el promedio más alto (de 0 a 100) recibirán un premio.
• El código de alumno es personal e intransferible.
• Los resultados se basan en respuestas honestas y responsables.
• El jurado (equipo docente) se reserva el derecho de verificar la validez de los datos.

¡Participa con compromiso y gana reconociendo tus hábitos saludables!`;

    alert(bases);
  });
</script>
</body>
</html>
