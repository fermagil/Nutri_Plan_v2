<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Healthy Friday - Estaciones</title>
  <style>
/* ===== VARIABLES DE COLOR Y TIPOGRAFÍA (Modernas y accesibles) ===== */
:root {
  /* Colores de Acceso Rápido */
  --hf-blue-primary: #2563eb; /* Azul estándar */
  --hf-blue-primary-hover: #1d4ed8; /* Hover del azul */
  --hf-green-accent: #0d9488; /* Verde saludable principal */
  --hf-green-accent-hover: #30baaf; /* Hover del verde */
  --hf-green-accent-active: #0a7c72; /* Active del verde */
  --hf-red-error: #dc2626; /* Error */
  --hf-orange-warning: #d97706; /* Advertencia */

  /* Paleta de Colores (más accesible) */
  --color-primary: var(--hf-blue-primary);
  --color-primary-hover: var(--hf-blue-primary-hover);
  --color-success: var(--hf-green-accent);
  --color-success-hover: var(--hf-green-accent-hover);
  --color-success-active: var(--hf-green-accent-active);
  --color-warning: var(--hf-orange-warning);
  --color-danger: var(--hf-red-error);
  --color-bg: #f9fafb; /* Fondo más cálido */
  --color-surface: #ffffff;
  --color-text: #111827; /* Negro más oscuro para mejor contraste */
  --color-text-secondary: #4b5563; /* Gris oscuro para secundario */
  --color-text-tertiary: #6b7280; /* Gris medio para terciario */
  --color-border: #d1d5db; /* Gris claro para bordes */
  --color-outline-focus: rgba(37, 99, 235, 0.5); /* Borde de enfoque */

  /* Bordes y Sombras */
  --border-radius: 16px; /* Ligeramente menos redondeado */
  --border-radius-sm: 8px;
  --border-radius-btn: 12px; /* Bordes de botones */
  --border: 1px solid var(--color-border);
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Sombra muy sutil */
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Sombra media */
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Sombra más pronunciada */
  --shadow-hover: var(--shadow-lg); /* Sombra al hacer hover */

  /* Tipografía */
  --font-main: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  --font-heading: var(--font-main); /* Misma fuente para encabezados */
  --font-size-xs: 0.75rem; /* 12px */
  --font-size-sm: 0.875rem; /* 14px */
  --font-size-base: 1rem; /* 16px */
  --font-size-lg: 1.125rem; /* 18px */
  --font-size-xl: 1.25rem; /* 20px */
  --font-size-2xl: 1.5rem; /* 24px */
  --font-size-3xl: 1.875rem; /* 30px */
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 600;
  --font-weight-bold: 700;

  /* Espaciado */
  --spacing-xs: 0.5rem; /* 8px */
  --spacing-sm: 0.75rem; /* 12px */
  --spacing-md: 1rem; /* 16px */
  --spacing-lg: 1.5rem; /* 24px */
  --spacing-xl: 2rem; /* 32px */
  --spacing-2xl: 3rem; /* 48px */

  /* Contenido Máximo */
  --max-width-container: 800px;
  --max-width-content: 768px; /* Para páginas internas */
}

/* ===== REINICIO Y ESTILOS BASE ===== */
/* Reset simplificado y moderno */
*,
*::before,
*::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  /* Establece el tamaño base de la fuente para usar 'rem' */
  font-size: 16px;
  /* Mejora la legibilidad del texto */
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  font-feature-settings: "kern" 1, "liga" 1, "clig" 1, "calt" 1;
  /* Evita el ajuste de fuente por el navegador */
  -moz-text-size-adjust: none;
  -webkit-text-size-adjust: none;
  text-size-adjust: none;
}

body {
  font-family: var(--font-main);
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-normal);
  line-height: 1.6;
  color: var(--color-text);
  background-color: var(--color-bg);
  /* Espacio inferior para evitar que el contenido quede pegado al footer */
  padding-bottom: env(safe-area-inset-bottom, 0);
  /* Transición suave para cambios de tema o modo oscuro si se implementa */
  transition: background-color 0.2s ease, color 0.2s ease;
}

/* ===== ENCABEZADOS ===== */
header h1 {
  text-align: center;
  color: var(--color-primary);
  margin: var(--spacing-xl) 0 var(--spacing-lg); /* Espacio arriba y abajo */
  font-weight: var(--font-weight-bold);
  font-size: var(--font-size-2xl); /* Tamaño más grande */
  line-height: 1.2; /* Línea más ajustada para títulos grandes */
  letter-spacing: -0.025em; /* Ligeramente más ajustado para títulos grandes */
  padding: 0 var(--spacing-md); /* Espacio lateral */
}

h2 {
  color: var(--color-primary);
  margin-top: var(--spacing-lg);
  margin-bottom: var(--spacing-md);
  font-weight: var(--font-weight-semibold);
  font-size: var(--font-size-xl);
  line-height: 1.3;
}

h3 {
  color: var(--color-text);
  margin-top: var(--spacing-md);
  margin-bottom: var(--spacing-sm);
  font-weight: var(--font-weight-semibold);
  font-size: var(--font-size-lg);
  line-height: 1.4;
}

/* ===== MENÚ PRINCIPAL (Healthy Friday - Estaciones) ===== */
.menu {
  max-width: var(--max-width-container);
  margin: 0 auto;
  padding: 0 var(--spacing-md) var(--spacing-xl); /* Espacio inferior extra */
}

.menu > main {
  /* Espaciado interno para el contenido principal del menú */
  padding: var(--spacing-md) 0;
}

/* Estilo para el botón de importación CSV */
#import-csv-section {
  margin-bottom: var(--spacing-lg);
}

#import-csv-section[style*="display: none"] {
  /* Asegura que si está oculto, no ocupe espacio */
  display: none !important;
}

#btn-importar-csv {
  background-color: var(--color-success);
  color: white;
  border: none;
  border-radius: var(--border-radius-btn);
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-semibold);
  cursor: pointer;
  width: 100%;
  max-width: 320px; /* Ancho máximo */
  margin: 0 auto; /* Centrado */
  box-shadow: var(--shadow-md);
  transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
  display: flex; /* Centrado interno */
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs); /* Espacio entre ícono y texto */
}

#btn-importar-csv:hover,
#btn-importar-csv:focus {
  background-color: var(--color-success-hover);
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
}

#btn-importar-csv:focus {
  /* Borde de enfoque accesible */
  outline: 2px solid var(--color-outline-focus);
  outline-offset: 2px;
  /* Asegura visibilidad del estado de enfoque */
  z-index: 1;
}

/* Estilo para el encabezado de selección de test */
.menu > main > h2 {
  text-align: center;
  margin-bottom: var(--spacing-lg);
  color: var(--color-text-secondary);
  font-weight: var(--font-weight-medium);
  font-size: var(--font-size-lg);
}

/* Estilo para la lista de tests */
.menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
  /* Diseño en cuadrícula para mejor uso del espacio */
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Mínimo 280px por columna */
  gap: var(--spacing-md);
}

.menu li {
  /* Opcional: para controlar el espaciado de los items */
  margin: 0;
}

.menu a {
  display: block;
  padding: var(--spacing-md);
  background: var(--color-surface);
  color: var(--color-primary);
  text-decoration: none;
  border-radius: var(--border-radius);
  font-weight: var(--font-weight-semibold);
  text-align: center;
  box-shadow: var(--shadow-md);
  transition: all 0.2s ease;
  border: var(--border);
  /* Asegura que el enlace ocupe todo el contenedor */
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  /* Ajuste de texto para que no se desborde */
  word-break: break-word;
  hyphens: auto;
}

.menu a:hover,
.menu a:focus {
  background-color: var(--color-surface); /* Mantiene el fondo */
  color: var(--color-primary-hover); /* Cambia el color del texto */
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
  border-color: var(--color-primary); /* Borde más oscuro al hacer hover */
  /* Borde de enfoque accesible */
  outline: 2px solid var(--color-outline-focus);
  outline-offset: -2px; /* Dentro del borde del elemento */
}

.menu a:focus {
  /* Asegura visibilidad del estado de enfoque */
  z-index: 1;
}

/* Estilo para el botón de informe global */
.btn-informe {
  background-color: var(--color-primary);
  color: white;
  border: none;
  border-radius: var(--border-radius-btn);
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  cursor: pointer;
  width: 100%;
  margin-top: var(--spacing-xl);
  box-shadow: var(--shadow-md);
  transition: background-color 0.2s ease, transform 0.2s ease;
  display: flex; /* Centrado interno */
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs); /* Espacio entre ícono y texto */
}

.btn-informe:hover,
.btn-informe:focus {
  background-color: var(--color-primary-hover);
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
}

.btn-informe:focus {
  /* Borde de enfoque accesible */
  outline: 2px solid var(--color-outline-focus);
  outline-offset: 2px;
  z-index: 1; /* Asegura visibilidad */
}
/* ===== ESTILOS PARA EL BOTÓN DE INFORME GLOBAL (Healthy Friday) ===== */

/* Selecciona el botón específico dentro del menú principal */
.menu main .btn-informe-global {
  /* Utiliza variables CSS definidas en :root */
  background-color: var(--color-primary);
  color: white;
  border: none;
  border-radius: var(--border-radius-btn); /* Usa la variable de borde redondeado */
  padding: var(--spacing-sm) var(--spacing-md); /* Espaciado consistente */
  font-size: var(--font-size-lg); /* Tamaño de fuente legible */
  font-weight: var(--font-weight-semibold); /* Peso de fuente medio-fuerte */
  cursor: pointer;
  width: 100%; /* Ancho completo como en tu HTML */
  margin-top: var(--spacing-lg); /* Margen superior consistente */
  box-shadow: var(--shadow-md); /* Sombra sutil */
  transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease; /* Transición suave */
  display: flex; /* Centrado interno de ícono y texto */
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs); /* Espacio entre ícono y texto */
  text-decoration: none; /* Por si acaso se convierte en enlace en el futuro */
  max-width: var(--max-width-content); /* Ancho máximo si es necesario */
  margin-left: auto; /* Centrado horizontal si el contenedor es más ancho */
  margin-right: auto;
  margin-top: var(--spacing-lg); /* Espacio superior */
}

/* Estado de hover */
.menu main .btn-informe-global:hover {
  background-color: var(--color-primary-hover); /* Color de hover */
  transform: translateY(-2px); /* Ligero efecto de elevación */
  box-shadow: var(--shadow-hover); /* Sombra más pronunciada al hacer hover */
}

/* Estado de foco (importante para accesibilidad) */
.menu main .btn-informe-global:focus {
  /* Borde de enfoque accesible */
  outline: 2px solid var(--color-outline-focus);
  outline-offset: 2px;
  /* Asegura que el botón esté por encima de otros elementos si tiene sombra */
  z-index: 1;
  /* Opcional: Mantener el estilo de hover también en foco */
  background-color: var(--color-primary-hover);
  box-shadow: var(--shadow-hover);
}

/* Opcional: Estado activo (cuando se mantiene presionado) */
.menu main .btn-informe-global:active {
  transform: translateY(0); /* Elimina la elevación */
  box-shadow: var(--shadow-md); /* Vuelve a la sombra base */
}
/* Estilo para el botón de volver */
.btn-volver {
  display: block;
  width: 100%;
  max-width: 320px; /* Ancho máximo */
  margin: var(--spacing-lg) auto 0; /* Margen superior y centrado */
  padding: var(--spacing-sm) var(--spacing-md);
  background-color: var(--hf-green-accent); /* Verde saludable */
  color: white;
  text-align: center;
  text-decoration: none;
  border-radius: var(--border-radius-btn);
  font-weight: var(--font-weight-semibold);
  font-size: var(--font-size-base);
  box-shadow: var(--shadow-md);
  transition: background-color 0.2s ease, transform 0.2s ease;
  border: none;
  cursor: pointer;
  display: flex; /* Centrado interno */
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs); /* Espacio entre ícono y texto */
}

.btn-volver:hover,
.btn-volver:focus {
  background-color: var(--hf-green-accent-hover); /* Verde más oscuro */
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
}

.btn-volver:focus {
  /* Borde de enfoque accesible */
  outline: 2px solid var(--color-outline-focus);
  outline-offset: 2px;
  z-index: 1; /* Asegura visibilidad */
}

/* ===== ACCESIBILIDAD Y PREFERENCIAS DEL USUARIO ===== */
/* Reduce la animación si el usuario lo prefiere */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
  .menu a,
  .btn-informe,
  .btn-volver,
  #btn-importar-csv {
    transform: none !important;
    box-shadow: var(--shadow-md) !important; /* Mantiene sombra base */
  }
}

/* ===== IMPRESIÓN ===== */
@media print {
  .btn-informe,
  .btn-volver,
  .menu a,
  #btn-importar-csv,
  #import-csv-section {
    display: none !important;
  }

  body,
  .menu,
  .menu ul {
    background: white !important;
    color: black !important;
    box-shadow: none !important;
  }
}

/* ===== RESPONSIVE ===== */
/* Ajustes para pantallas medianas */
@media (max-width: 768px) {
  :root {
    --font-size-2xl: 1.375rem; /* 22px */
    --font-size-xl: 1.125rem; /* 18px */
    --font-size-lg: 1rem; /* 16px */
    --spacing-xl: 1.75rem;
    --spacing-2xl: 2.5rem;
  }

  header h1 {
    font-size: var(--font-size-xl);
    margin: var(--spacing-lg) 0 var(--spacing-md);
  }

  .menu {
    padding: 0 var(--spacing-sm) var(--spacing-lg);
  }

  .menu ul {
    grid-template-columns: 1fr; /* Una columna en móvil */
    gap: var(--spacing-sm);
  }

  .menu a {
    padding: var(--spacing-md);
    font-size: var(--font-size-base); /* Ligeramente más grande en móvil */
  }

  .btn-informe,
  .btn-volver,
  #btn-importar-csv {
    max-width: 100%; /* Ancho completo en móvil */
    padding: var(--spacing-sm) var(--spacing-md);
  }
}

/* Ajustes para pantallas pequeñas */
@media (max-width: 480px) {
  :root {
    --font-size-xl: 1.125rem; /* 18px */
    --font-size-lg: 0.9375rem; /* 15px */
    --font-size-base: 0.9375rem; /* 15px */
    --spacing-lg: var(--spacing-md);
    --spacing-xl: var(--spacing-lg);
  }

  header h1 {
    font-size: var(--font-size-xl);
    margin: var(--spacing-md) 0 var(--spacing-sm);
  }

  .menu {
    padding: 0 var(--spacing-xs) var(--spacing-md);
  }

  .menu a {
    padding: var(--spacing-sm);
    font-size: var(--font-size-base);
  }

  .btn-informe,
  .btn-volver,
  #btn-importar-csv {
    font-size: var(--font-size-base); /* Asegura legibilidad */
  }
}
/* ===== FORMULARIO DE DATOS PERSONALES ===== */
.test-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 0 1rem;
}

.test-container label {
  display: block;
  margin: 1.2rem 0 0.5rem;
  font-weight: 600;
  color: var(--color-text);
}

.test-container input,
.test-container select {
  width: 100%;
  padding: 12px;
  font-size: 1rem;
  border: 2px solid #cbd5e1;
  border-radius: 8px;
  background: var(--color-surface);
  transition: border-color 0.2s;
}

.test-container input:focus,
.test-container select:focus {
  border-color: var(--color-primary);
  outline: none;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
}
/* ===== PREGUNTAS (Modernas, Visuales e Inclusivas) ===== */

/* Contenedor de cada pregunta */
.pregunta-item {
  background: var(--color-surface);
  padding: var(--spacing-lg); /* Más espacio interno */
  border-radius: var(--border-radius); /* Bordes redondeados consistentes */
  margin: var(--spacing-lg) 0; /* Espacio superior/inferior más generoso */
  /* Sombra más pronunciada para destacar la tarjeta */
  box-shadow: var(--shadow-md);
  /* Borde sutil en lugar de solo una línea lateral */
  border: var(--border);
  /* Transición suave para efectos de hover si se agregan */
  transition: box-shadow 0.2s ease, transform 0.1s ease;
}

.pregunta-item:hover {
  /* Opcional: efecto sutil al pasar el ratón por toda la tarjeta */
  box-shadow: var(--shadow-hover);
  /* transform: translateY(-1px); */ /* Ligeramente elevada (opcional) */
}

/* Título de la pregunta */
.pregunta-item > p {
  margin: 0 0 var(--spacing-md) 0; /* Espacio solo debajo del título */
  font-weight: var(--font-weight-semibold); /* Peso de fuente medio-fuerte */
  font-size: var(--font-size-lg); /* Tamaño ligeramente mayor */
  color: var(--color-text); /* Color de texto principal */
  line-height: 1.4; /* Línea más ajustada para mejor lectura */
  /* Opcional: Añadir un ícono o número de pregunta aquí */
  /* padding-left: var(--spacing-sm); */
  /* border-left: 3px solid var(--color-primary); */
}

/* Contenedor de cada opción de respuesta (radio o checkbox) */
.opcion {
  display: flex; /* Disposición horizontal */
  align-items: center; /* Centrado vertical */
  margin: var(--spacing-sm) 0; /* Espaciado vertical entre opciones */
  padding: var(--spacing-xs); /* Espacio interno pequeño para el área de click */
  border-radius: var(--border-radius-sm); /* Bordes ligeramente redondeados para la opción */
  /* Transición suave para efectos de hover/focus */
  transition: background-color 0.15s ease, outline 0.15s ease;
  /* Asegura que el cursor indique que es clickable */
  cursor: pointer;
}

/* Efecto hover en la opción completa (label) */
.opcion:hover {
  background-color: color-mix(in srgb, var(--color-primary) 10%, transparent); /* Fondo muy sutil al hacer hover */
}

/* Estado de foco en la opción completa (label) - MUY IMPORTANTE para a11y */
.opcion:focus-within {
  /* Borde de enfoque claro alrededor de la opción completa */
  outline: 2px solid var(--color-outline-focus);
  outline-offset: 2px;
  /* Asegura visibilidad del estado de enfoque */
  z-index: 1;
  position: relative; /* Asegura que z-index funcione si hay otros elementos */
}

/* Input (radio o checkbox) dentro de la opción */
.opcion input[type="radio"],
.opcion input[type="checkbox"] {
  /* Tamaño ligeramente mayor para mejor usabilidad */
  width: 1.25em; /* 20px si font-size base es 16px */
  height: 1.25em;
  margin-right: var(--spacing-sm); /* Espacio entre input y label */
  /* Color de énfasis para el input seleccionado */
  accent-color: var(--color-primary);
  /* Asegura que el input sea parte del área de click del label */
  cursor: pointer;
  flex-shrink: 0; /* No se encoge si el texto es largo */
}

/* Estado de foco en el input (radio/checkbox) */
.opcion input[type="radio"]:focus,
.opcion input[type="checkbox"]:focus {
  /* No necesitas outline aquí si .opcion:focus-within lo maneja todo */
  /* outline: 2px solid var(--color-outline-focus); */
  /* outline-offset: 2px; */
  /* Es mejor depender del focus en el label padre (.opcion:focus-within) */
}

/* Label de la opción (el texto descriptivo) */
.opcion label {
  font-weight: var(--font-weight-normal); /* Peso de fuente normal */
  color: var(--color-text-secondary); /* Color secundario */
  cursor: pointer; /* Muestra que es clickable */
  /* Permite que el texto ocupe el resto del espacio disponible */
  flex-grow: 1;
  line-height: 1.5; /* Línea más cómoda para lectura */
  user-select: none; /* Evita seleccionar texto accidentalmente al hacer click */
}

/* Opcional: Efecto visual en el label cuando el input asociado está seleccionado */
.opcion input[type="radio"]:checked + label,
.opcion input[type="checkbox"]:checked + label {
  color: var(--color-primary); /* Cambia el color del texto al seleccionar */
  font-weight: var(--font-weight-medium); /* Opcional: Ponerlo en negrita */
}
/* ===== PREGUNTAS ===== */
.pregunta-item {
  background: var(--color-surface);
  padding: 18px;
  border-radius: var(--border-radius);
  margin: 1.2rem 0;
  box-shadow: var(--shadow);
  border-left: 4px solid var(--color-primary);
}

.pregunta-item p {
  margin: 0 0 12px;
  font-weight: 600;
  font-size: 1.1rem;
}

.opcion {
  display: block;
  margin: 8px 0;
}

.opcion input {
  margin-right: 10px;
  width: auto;
  accent-color: var(--color-primary);
}

.opcion label {
  font-weight: normal;
  color: var(--color-text-secondary);
  cursor: pointer;
}

/* ===== ESTILO ESPECÍFICO PARA EL BOTÓN "CALCULAR RESULTADO" ===== */

/* Selecciona el botón con clase 'btn' que esté dentro del contenedor de test */
.test-container .btn[type="button"]:not(.btn-volver):not(.btn-informe-global),
/* O también si solo se basa en la clase 'btn' y la función onclick (menos recomendado si hay otros .btn) */
/* .btn[onclick^="calcularResultado"] { */
.test-container button.btn {
  /* Utiliza variables CSS definidas en :root */
  background-color: var(--color-success); /* Verde como indicador de acción positiva/continuar */
  color: white;
  border: none;
  border-radius: var(--border-radius-btn); /* Usa la variable de borde redondeado de botones */
  padding: var(--spacing-sm) var(--spacing-lg); /* Espaciado consistente */
  font-size: var(--font-size-lg); /* Tamaño de fuente legible */
  font-weight: var(--font-weight-semibold); /* Peso de fuente medio-fuerte */
  cursor: pointer;
  width: 100%; /* Ancho completo por defecto */
  max-width: 320px; /* Ancho máximo */
  margin: var(--spacing-lg) auto 0; /* Margen superior, centrado horizontal, sin margen inferior */
  box-shadow: var(--shadow-md); /* Sombra sutil */
  transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease; /* Transición suave */
  display: flex; /* Centrado interno de ícono y texto (si se añade) */
  align-items: center;
  justify-content: center;
  gap: var(--spacing-xs); /* Espacio entre ícono y texto (si aplica) */
  text-decoration: none; /* Por si acaso se convierte en enlace en el futuro */
}

/* Estado de hover */
.test-container button.btn:hover {
  background-color: var(--color-success-hover); /* Verde más oscuro al hacer hover */
  transform: translateY(-2px); /* Ligero efecto de elevación */
  box-shadow: var(--shadow-hover); /* Sombra más pronunciada al hacer hover */
}

/* Estado de foco (importante para accesibilidad) */
.test-container button.btn:focus {
  /* Borde de enfoque accesible */
  outline: 2px solid var(--color-outline-focus);
  outline-offset: 2px;
  /* Asegura que el botón esté por encima de otros elementos si tiene sombra */
  z-index: 1;
  /* Opcional: Mantener el estilo de hover también en foco */
  background-color: var(--color-success-hover);
  box-shadow: var(--shadow-hover);
}

/* Opcional: Estado activo (cuando se mantiene presionado) */
.test-container button.btn:active {
  transform: translateY(0); /* Elimina la elevación */
  box-shadow: var(--shadow-md); /* Vuelve a la sombra base */
  background-color: var(--color-success-active); /* Verde aún más oscuro al hacer click */
}

/* Opcional: Estado deshabilitado (si se añade el atributo disabled dinámicamente) */
.test-container button.btn:disabled {
  background-color: var(--color-text-tertiary); /* Gris */
  cursor: not-allowed; /* Cursor de no permitido */
  opacity: 0.6; /* Ligeramente transparente */
  transform: none; /* Sin elevación */
  box-shadow: var(--shadow-sm); /* Sombra más suave o ninguna */
}

	  /* ===== ESTILO PARA BOTONES DE ACCIÓN (Calcular y Reset) ===== */

/* Contenedor flexible para los botones */
.test-container [style*="display: flex; gap: 10px;"] { /* Selector genérico para el contenedor que creamos */
  display: flex !important; /* Asegura el layout flexible */
  gap: var(--spacing-sm); /* Espacio entre botones usando variable */
  margin-top: var(--spacing-md); /* Espacio superior */
  justify-content: center; /* Centrado horizontal */
  flex-wrap: wrap; /* Permite que se envuelvan en pantallas pequeñas */
  align-items: center; /* Alineación vertical centrada */
}

/* Estilo base para botones de acción */
.btn-calcular,
.btn-reset {
  /* Utiliza variables CSS definidas en :root */
  color: white;
  border: none;
  border-radius: var(--border-radius-btn); /* Bordes redondeados */
  padding: var(--spacing-sm) var(--spacing-md); /* Espaciado interno */
  font-size: var(--font-size-base); /* Tamaño de fuente */
  font-weight: var(--font-weight-semibold); /* Peso de fuente */
  cursor: pointer;
  box-shadow: var(--shadow-md); /* Sombra sutil */
  transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease; /* Transición suave */
  display: flex; /* Centrado interno */
  align-items: center;
  justify-content: center;
  min-width: 140px; /* Ancho mínimo para consistencia */
  text-align: center; /* Asegura texto centrado */
  flex: 1; /* Opcional: para que ocupen el mismo ancho si hay espacio */
  max-width: 200px; /* Ancho máximo opcional */
}

/* Botón "Calcular Resultado" - Color principal */
.btn-calcular {
  background-color: var(--color-success); /* Verde para acción principal */
}

/* Botón "Nuevo Test" - Color secundario (puedes cambiarlo) */
.btn-reset {
  background-color: #64748b; /* Gris azulado, puedes usar var(--color-surface) con borde si prefieres */
}

/* Efectos hover */
.btn-calcular:hover,
.btn-reset:hover {
  transform: translateY(-2px); /* Efecto de elevación */
  box-shadow: var(--shadow-hover); /* Sombra más pronunciada al hacer hover */
}

.btn-calcular:hover {
  background-color: var(--color-success-hover); /* Hover del verde */
}

.btn-reset:hover {
  background-color: #475569; /* Hover del gris azulado */
}

/* Estado de foco (importante para accesibilidad) */
.btn-calcular:focus,
.btn-reset:focus {
  /* Borde de enfoque accesible */
  outline: 2px solid var(--color-outline-focus);
  outline-offset: 2px;
  /* Asegura visibilidad del estado de enfoque */
  z-index: 1;
  /* Mantiene el estilo de hover o el color base */
  box-shadow: var(--shadow-hover);
}

/* Opcional: Estado activo (cuando se mantiene presionado) */
.btn-calcular:active,
.btn-reset:active {
  transform: translateY(0); /* Elimina la elevación */
  box-shadow: var(--shadow-md); /* Vuelve a la sombra base */
}

/* Ajustes para pantallas pequeñas */
@media (max-width: 480px) {
  .btn-calcular,
  .btn-reset {
    width: 100%; /* Ancho completo en móvil */
    max-width: none; /* Elimina el ancho máximo */
    padding: var(--spacing-sm) var(--spacing-md); /* Ajusta padding */
  }
  .test-container [style*="display: flex; gap: 10px;"] {
    flex-direction: column; /* Apila botones verticalmente en móvil */
    align-items: stretch; /* Estira botones al ancho del contenedor */
  }
}
	  /* ===== RESULTADOS (Modernos, Visuales e Inclusivos) ===== */

/* Contenedor principal de los resultados */
#resultado {
  display: none; /* Se mostrará con JS */
  background: var(--color-surface); /* Fondo blanco para contraste */
  padding: var(--spacing-xl); /* Espacio interno generoso */
  border-radius: var(--border-radius); /* Bordes redondeados consistentes */
  margin: var(--spacing-xl) 0; /* Espacio superior/inferior */
  /* Sombra para destacar la tarjeta */
  box-shadow: var(--shadow-md);
  /* Borde sutil con color de énfasis */
  border: var(--border);
  /* Transición suave si se anima al aparecer */
  transition: opacity 0.3s ease, transform 0.2s ease;
  /* Opcional: Agregar una animación de aparición */
  animation: fadeInUp 0.4s ease-out;
}

/* Animación para la aparición del resultado */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Título de la sección de resultados */
#resultado > h2 {
  margin-top: 0; /* Elimina margen superior predeterminado */
  margin-bottom: var(--spacing-md); /* Espacio inferior */
  color: var(--color-primary); /* Color de énfasis */
  font-weight: var(--font-weight-bold); /* Fuente más fuerte */
  font-size: var(--font-size-xl); /* Tamaño mayor */
  text-align: center; /* Centrado */
  border-bottom: 2px solid var(--color-primary); /* Línea decorativa */
  padding-bottom: var(--spacing-xs); /* Espacio bajo el título */
}

/* Contenedor específico para las recomendaciones */
#recomendaciones {
  margin-top: var(--spacing-lg); /* Espacio superior */
}

/* Subtítulo dentro de recomendaciones */
#recomendaciones h3 {
  margin-top: 0; /* No hay margen superior si es el primer elemento */
  margin-bottom: var(--spacing-sm); /* Espacio inferior */
  color: var(--color-text); /* Color de texto principal */
  font-weight: var(--font-weight-semibold); /* Fuente medio-fuerte */
  font-size: var(--font-size-lg); /* Tamaño mayor */
  padding-bottom: var(--spacing-xs); /* Espacio bajo el subtítulo */
  border-bottom: 1px dashed var(--color-border); /* Línea divisoria sutil */
}

/* Párrafo de recomendación individual */
#recomendaciones p {
  background-color: color-mix(in srgb, var(--color-warning) 10%, transparent); /* Fondo muy sutil con tono de advertencia */
  color: var(--color-text); /* Color de texto principal */
  padding: var(--spacing-md); /* Espacio interno */
  border-radius: var(--border-radius-sm); /* Bordes ligeramente redondeados */
  /* Borde izquierdo con color de advertencia para destacar */
  border-left: 4px solid var(--color-warning);
  font-style: normal; /* Elimina la cursiva */
  line-height: 1.6; /* Altura de línea cómoda */
  margin-bottom: var(--spacing-sm); /* Espacio inferior entre párrafos */
  /* Opcional: Icono al inicio */
  /* padding-left: calc(var(--spacing-md) + 1.5em); */
  /* position: relative; */
  /* &::before { content: "💡"; position: absolute; left: var(--spacing-md); top: var(--spacing-md); } */
}

/* Opcional: Estilo específico si la recomendación es positiva */
#recomendaciones p.positiva {
  background-color: color-mix(in srgb, var(--color-success) 10%, transparent);
  border-left-color: var(--color-success);
}

/* Opcional: Estilo específico si la recomendación es crítica */
#recomendaciones p.critica {
  background-color: color-mix(in srgb, var(--color-danger) 10%, transparent);
  border-left-color: var(--color-danger);
  color: var(--color-danger);
  font-weight: var(--font-weight-medium);
}


/* ===== INFORME GLOBAL (en nueva ventana - Estilo consistente con Healthy Friday) ===== */
/* Este CSS se aplica a la ventana emergente generada por JS */
.informe-global {
  font-family: var(--font-main); /* Tipografía consistente */
  padding: var(--spacing-lg); /* Espacio interno */
  background: var(--color-bg); /* Fondo consistente */
  color: var(--color-text); /* Color de texto consistente */
  /* Opcional: Ancho máximo para mejor lectura en pantallas grandes */
  max-width: var(--max-width-content);
  margin: 0 auto;
  /* Asegura que el fondo se extienda */
  min-height: 100vh;
}

.informe-global h2 {
  text-align: center; /* Centrado */
  color: var(--color-primary); /* Color de énfasis */
  margin-bottom: var(--spacing-lg); /* Espacio inferior */
  font-weight: var(--font-weight-bold); /* Fuente más fuerte */
  font-size: var(--font-size-2xl); /* Tamaño mayor */
  padding-bottom: var(--spacing-xs); /* Espacio bajo el título */
  border-bottom: 3px solid var(--color-primary); /* Línea decorativa */
}

.informe-global h3 {
  background: var(--color-surface); /* Fondo blanco para el encabezado de sección */
  color: var(--color-text); /* Color de texto */
  padding: var(--spacing-sm) var(--spacing-md); /* Espacio interno */
  border-radius: var(--border-radius-sm); /* Bordes ligeramente redondeados */
  margin: var(--spacing-lg) 0 var(--spacing-md) 0; /* Espacio alrededor */
  /* Sombra sutil para destacar */
  box-shadow: var(--shadow-sm);
  font-weight: var(--font-weight-semibold); /* Fuente medio-fuerte */
  font-size: var(--font-size-lg); /* Tamaño mayor */
  border-left: 3px solid var(--color-primary); /* Línea de énfasis */
}

.informe-global ul {
  padding-left: var(--spacing-lg); /* Sangría para la lista */
  margin: var(--spacing-md) 0; /* Espacio arriba y abajo */
}

.informe-global li {
  margin-bottom: var(--spacing-sm); /* Espacio entre elementos de la lista */
  line-height: 1.6; /* Altura de línea cómoda */
  padding: var(--spacing-xs) 0; /* Espacio vertical pequeño */
}

/* Estilo para elementos de alerta dentro del informe */
.informe-global .alerta {
  color: var(--color-danger); /* Color rojo para alertas */
  font-weight: var(--font-weight-semibold); /* Fuente medio-fuerte */
  display: inline-block; /* Opcional: para que el color no ocupe toda la línea */
  margin-top: var(--spacing-xs); /* Espacio superior si es necesario */
}

/* Estilo para elementos positivos dentro del informe */
.informe-global .positivo {
  color: var(--color-success); /* Color verde para positivos */
  font-weight: var(--font-weight-semibold); /* Fuente medio-fuerte */
  display: inline-block; /* Opcional: para que el color no ocupe toda la línea */
  margin-top: var(--spacing-xs); /* Espacio superior si es necesario */
}

/* ===== ACCESIBILIDAD Y ENFOQUE ===== */
@media (prefers-reduced-motion: reduce) {
  #resultado,
  #resultado * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
  .informe-global,
  .informe-global * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* ===== IMPRESIÓN ===== */
@media print {
  .btn,
  .btn-volver,
  .menu a,
  .btn-informe-global, /* Asegura ocultar también el botón de informe global */
  #btn-importar-csv /* Y el botón de importar CSV */
  {
    display: none !important;
  }

  body,
  .test-container,
  #resultado,
  .informe-global /* Aplica a la ventana de informe también */
  {
    background: white !important;
    color: black !important;
    box-shadow: none !important;
    border: 1px solid #000 !important; /* Opcional: borde nítido en impresión */
  }

  #resultado,
  .informe-global {
    padding: var(--spacing-md); /* Ajustar padding para impresión */
    margin: var(--spacing-sm) 0; /* Ajustar margen para impresión */
    /* Romper página antes de cada sección de resultado (opcional) */
    /* page-break-before: always; */
  }

  /* Opcional: Evitar que se corte una sección en medio al imprimir */
  .informe-global h3 {
    page-break-after: avoid;
  }
  .informe-global ul,
  .informe-global p {
    page-break-inside: avoid;
  }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 600px) {
  /* Ajustes para la sección de resultados */
  #resultado {
    padding: var(--spacing-lg); /* Menos padding en móvil */
    margin: var(--spacing-lg) var(--spacing-sm); /* Margen lateral */
  }

  #resultado > h2 {
    font-size: var(--font-size-xl); /* Título ligeramente más pequeño */
  }

  #recomendaciones h3 {
    font-size: var(--font-size-base); /* Subtítulo más pequeño */
  }

  #recomendaciones p {
    padding: var(--spacing-sm); /* Menos padding */
    font-size: var(--font-size-sm); /* Texto ligeramente más pequeño */
  }

  /* Ajustes para el informe global */
  .informe-global {
    padding: var(--spacing-md); /* Menos padding */
  }

  .informe-global h2 {
    font-size: var(--font-size-xl); /* Título más pequeño */
  }

  .informe-global h3 {
    font-size: var(--font-size-lg); /* Subtítulo más pequeño */
    padding: var(--spacing-xs) var(--spacing-sm); /* Menos padding */
  }

  .informe-global ul {
    padding-left: var(--spacing-md); /* Menos sangría */
  }
}
	  /* ===== CONTENEDOR DE ACCIONES DEL TEST ===== */
.acciones-test-container {
  display: flex;
  gap: var(--spacing-sm);
  margin-top: var(--spacing-md);
  justify-content: center;
  flex-wrap: wrap;
}

/* ===== ESTILO PARA BOTONES DE ACCIÓN (Calcular y Reset) ===== */
.btn-calcular,
.btn-reset {
  color: white;
  border: none;
  border-radius: var(--border-radius-btn);
  padding: var(--spacing-sm) var(--spacing-md);
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-semibold);
  cursor: pointer;
  box-shadow: var(--shadow-md);
  transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 140px;
  text-align: center;
  flex: 1;
  max-width: 200px;
}

/* Botón "Calcular Resultado" */
.btn-calcular {
  background-color: var(--color-success);
}

/* Botón "Nuevo Test" */
.btn-reset {
  background-color: #64748b; /* Gris azulado */
}

/* Efectos hover */
.btn-calcular:hover {
  background-color: var(--color-success-hover);
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
}

.btn-reset:hover {
  background-color: #475569; /* Hover del gris azulado */
  transform: translateY(-2px);
  box-shadow: var(--shadow-hover);
}

/* Estado de foco (importante para accesibilidad) */
.btn-calcular:focus,
.btn-reset:focus {
  outline: 2px solid var(--color-outline-focus);
  outline-offset: 2px;
  z-index: 1;
  box-shadow: var(--shadow-hover);
}

/* Estado activo */
.btn-calcular:active,
.btn-reset:active {
  transform: translateY(0);
  box-shadow: var(--shadow-md);
}

/* Ajustes para pantallas pequeñas */
@media (max-width: 480px) {
  .btn-calcular,
  .btn-reset {
    width: 100%;
    max-width: none;
    padding: var(--spacing-sm) var(--spacing-md);
  }
  .acciones-test-container {
    flex-direction: column;
    align-items: stretch;
  }
}


	  /* ===== CONTENEDOR DE CARGA (Spinner) ===== */
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5); /* Fondo semitransparente */
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 10000; /* Asegura que esté por encima de todo */
}

#loading-content {
  background-color: white;
  padding: 30px;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 5px solid #f3f3f3; /* Gris claro */
  border-top: 5px solid #3498db; /* Azul */
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}




	/* Añadir al final de tu bloque <style> */

/* ===== ESTILO PARA PÁGINA DURANTE CARGA ===== */

/* Clase para aplicar un fondo oscuro al body durante la carga */
body.loading-active {
  /* Opcional: Oscurece el fondo */
  background-color: rgba(0, 0, 0, 0.7); /* Fondo negro semitransparente */
  /* Opcional: Agrega un filtro para desenfocar el contenido de fondo */
  /* filter: blur(2px); */ /* Desenfoca el contenido (puede ser costoso) */
  /* Asegura que el spinner esté por encima de cualquier cosa */
  overflow: hidden; /* Evita scroll mientras carga */
}

/* Asegura que el overlay esté por encima de todo, incluso con loading-active */
#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  /* background-color ya está definido, no se repite aquí a menos que quieras otro color */
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 10000; /* Un z-index muy alto para asegurar que esté encima de todo */
}
	  /* ===== ESTILOS PARA TRANSICIÓN DE PÁGINA (Fade Out) ===== */

/* Definir la transición de opacidad para el body */
body {
  /* Asegura que la transición se aplique suavemente */
  transition: opacity 1s ease-in-out;
}

/* Clase para aplicar el fade-out */
body.fade-out {
  opacity: 0;
  /* Opcional: También puedes añadir un transform para un efecto más dramático */
  /* transform: scale(0.95); */
  /* transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; */
}
/* ===== TRANSICIÓN DE ENTRADA (Fade-in) ===== */

/* Contenedor principal que se va a animar (ajusta el ID o clase si es diferente) */
/* Puede ser el body o un div contenedor general */
body,
#menu, /* Ajusta este ID al contenedor real de tu contenido */
.main-content,

{
  /* Estado inicial: invisible */
  opacity: 0;
  /* Transición de opacidad con una duración y función de temporización suaves */
  transition: opacity 3s ease-in-out; /* Puedes ajustar la duración (0.5s) y la función (ease-in-out) */
}

/* Clase que se aplicará para iniciar la animación */
.transicion-fade-in {
  opacity: 1; /* Cambia a visible */
}	  
  </style>

  <!-- Firebase SDK (versión 8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>

  <!-- Menú principal -->
  <!-- 🔗 Botón de navegación añadido -->

  <div id="menu" class="menu">
    <header><h1>Healthy Friday - Estaciones</h1></header>
	  
    <main>
		 <!-- Botón para importar CSV -->
		
		<!-- Dentro del <form id="form-datos"> -->
		<!-- Antes del resto de campos -->
		<div id="import-csv-section" style="display: none;"> <!-- Oculto por defecto -->
		<!-- Dentro del <form id="form-datos">, antes del resto de campos o justo después del botón de importar si ya lo tienes -->
		<input type="file" id="filePickerCSV" accept=".csv" style="display: none;">
		<button type="button" id="btn-importar-csv" onclick="abrirSelectorYVerificarContraseña()">🔐 Importar Lista de Alumnos (CSV)</button>
		</div>
<!-- ... resto de campos (curso, edad, sexo) ... -->
      <h2>Selecciona el test de esta estación:</h2>
      <ul>
        <li><a href="#" onclick="cargarTest('postura')">Estacion 1: Higiene Postural</a></li>
        <li><a href="#" onclick="cargarTest('actividad')">Estacion 2: Actividad Física</a></li>
        <li><a href="#" onclick="cargarTest('azucar')">Estacion 3: Azúcar y Alimentación</a></li>
        <li><a href="#" onclick="cargarTest('alimentacion')">Estacion 4: Hábitos Alimenticios</a></li>
        <li><a href="#" onclick="cargarTest('composicion')">Estación 5: Composición Corporal</a></li>
        <li><a href="#" onclick="cargarTest('medioambiente')">Estacion 6: Cuidado Medioambiental</a></li>
        <li><a href="#" onclick="cargarTest('espalda')">Estación 7: Higiene de la Espalda</a></li>
        <li><a href="#" onclick="cargarTest('fuerza')">Estación 8: Deporte y Fuerza</a></li>
        <li><a href="#" onclick="cargarTest('sueno')">Estación 9: Hábitos de Sueño (Padres)</a></li>
        <li><a href="#" onclick="cargarTest('relajacion')">Estación 10: Relajación</a></li>
      </ul>
     <button class="btn btn-informe-global" onclick="generarInformeAnalitico()">📊 Informe Global por Curso y Sexo</button>
	     <button type="button" class="btn-volver" onclick="redirigirASaludEscolarConCarga()">
		  🏫 Ir a Programa Salud Escolar
		</button>
    </main>
  </div>

  <!-- Formulario de test -->
  <div id="test" style="display:none;" class="test-container">
    <header><h1 id="titulo-test">Test</h1></header>
    
   <form id="form-datos">
	  <label for="codigoAlumno">Código de alumno:</label>
	  <select id="codigoAlumno" required>
	    <option value="">-- Importa la lista de alumnos --</option>
	    <!-- Las opciones se llenarán dinámicamente -->
	  </select>
	 
	
	  <label for="curso">Curso:</label>
	  <select id="curso" required>
	    <option value="">-- Selecciona --</option>
	    <option value="1º ESO">1º ESO</option>
	    <option value="2º ESO">2º ESO</option>
	    <option value="3º ESO">3º ESO</option>
	    <option value="4º ESO">4º ESO</option>
	    <option value="1º BACHILLER">1º BACHILLER</option> <!-- Puede mantenerse si es necesario -->
	  </select>
	
	  <label for="edad">Edad:</label>
	  <input type="number" id="edad" min="10" max="18" required>
	
	  <label for="sexo">Sexo:</label>
	  <select id="sexo" required>
	    <option value="masculino">Masculino</option>
	    <option value="femenino">Femenino</option>
	    <option value="nobinario">No binario</option>
	  </select>
</form>

    <form id="form-preguntas"></form>

   <div class="acciones-test-container">
    <button class="btn btn-calcular" onclick="calcularResultado()">Calcular Resultado</button>
    <button class="btn btn-reset" onclick="resetTest()">Nuevo Test</button>
  </div>
    <a href="#" class="btn-volver" onclick="mostrarMenu()">← Volver al menú</a>

    <div id="resultado">
      <h2>Resultados</h2>
      <p><strong>Puntuación total:</strong> <span id="puntaje"></span></p>
      <p><strong>Nivel:</strong> <span id="nivel"></span></p>
      <div id="recomendaciones"></div>
      <br />
      <button class="btn" onclick="window.print()">🖨️ Imprimir Resultados</button>
    </div>
  </div>

<script type="module">
  // 1. Importar Firebase
 
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, query, where, orderBy, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"; // Asegúrate de que 'doc', 'getDoc', 'setDoc' estén aquí


  // 2. Configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyChC7s5NN-z-dSjqeXDaks7gaNaVCJAu7Q",
    authDomain: "nutriplanv2.firebaseapp.com",
    projectId: "nutriplanv2",
    storageBucket: "nutriplanv2.firebasestorage.app",
    messagingSenderId: "653707489758",
    appId: "1:653707489758:web:9133d1d1620825c385ed4f",
    measurementId: "G-NWER69E8B6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // 3. Datos de los tests (sin cambios)
  const tests = {
    postura: {
      titulo: "Higiene Postural",
      preguntas: [
        "¿Mantienes una postura erguida en clase, con espalda apoyada y pies en el suelo?",
        "¿Llevas la mochila correctamente, con ambas correas y ajustada a la espalda, sin exceder el 10% de tu peso?",
        "¿Usas ordenadores o teléfonos con la pantalla a la altura de los ojos, evitando encorvarte?",
        "¿Haces pausas para estirarte durante sesiones prolongadas en clase o frente a pantallas?",
        "¿Evitas posturas asimétricas, como cruzar piernas o inclinarte al usar dispositivos?"
      ],
      recomendaciones: [
        "Comienza con lo básico: Pesa tu mochila y asegúrate de no exceder el 10% de tu peso; ajusta correas. Corrige postura en clase y eleva pantallas.",
        "Enfócate en rutina: Usa soportes para evitar encorvamiento. Haz pausas activas cada hora.",
        "Avanza: Incorpora estiramientos diarios y corrige posturas asimétricas. Monitorea tu mochila semanalmente.",
        "Refina: Enseña a otros sobre higiene postural. Usa recordatorios visuales.",
        "Excelente: Lidera talleres y comparte buenos hábitos."
      ]
    },
    actividad: {
      titulo: "Actividad Física",
      preguntas: [
        "¿Realizas al menos 60 minutos de actividad física diaria (caminar, bailar, etc.)?",
        "¿Evitas periodos prolongados de sedentarismo, levantándote cada hora?",
        "¿Participas en juegos divertidos como Just Dance u otros para hacer AF?",
        "¿Incluyes variedad: fuerza, flexibilidad y cardio en tu AF semanal?",
        "¿Priorizas AF para mantener un cuerpo en forma y una mente calmada?"
      ],
      recomendaciones: [
        "Comienza: Camina 30 min + juega 30 min. Usa Just Dance para motivarte.",
        "Enfócate: Rompe el sedentarismo cada hora. Apunta a 60 min diarios.",
        "Avanza: Varía con fuerza y flexibilidad. Únete a grupos.",
        "Refina: Usa apps para tracking. Enseña a otros.",
        "Excelente: Lidera sesiones y explora yoga o ciclismo."
      ]
    },
    azucar: {
      titulo: "Azúcar y Alimentación",
      preguntas: [
        "¿Evitas bebidas azucaradas como refrescos, energéticas o jugos procesados?",
        "¿Reemplazas golosinas o bebidas dulces por opciones naturales como fruta?",
        "¿Lees etiquetas de productos para verificar el contenido de azúcares añadidos?",
        "¿Consumes menos de una bebida azucarada por semana?",
        "¿Sigues guías como las de la OMS para limitar azúcares libres?"
      ],
      recomendaciones: [
        "Comienza: Elimina una bebida azucarada diaria. Reemplaza por agua o fruta.",
        "Enfócate: Limita a 1 bebida azucarada/semana. Lee etiquetas.",
        "Avanza: Elige productos con 0g azúcar añadido. Monitorea tu consumo.",
        "Refina: Organiza chequeos de salud. Enseña sobre equivalentes de azúcar.",
        "Excelente: Lidera campañas contra bebidas azucaradas."
      ]
    },
    alimentacion: {
      titulo: "Hábitos Alimenticios",
      preguntas: [
        "¿Consumes al menos cinco piezas de fruta o raciones de verdura al día?",
        "¿Reemplazas golosinas o snacks procesados por opciones naturales como fruta?",
        "¿Eliges comida real (frutas, verduras, proteínas frescas) sobre sustancias comestibles?",
        "¿Sigues el Plato de Harvard: mitad vegetales, cuarto granos, cuarto proteínas?",
        "¿Incorporas frutas como postre o snack saludable en tu rutina diaria?"
      ],
      recomendaciones: [
        "Comienza: Cambia una golosina por fruta. Añade una ensalada diaria.",
        "Enfócate: Prepara snacks de fruta. Agrega verduras a cada comida.",
        "Avanza: Cocina platos reales. Evita bebidas azucaradas.",
        "Refina: Experimenta con recetas del Plato de Harvard.",
        "Excelente: Lidera grupos de alimentación saludable."
      ]
    },
    composicion: {
      titulo: "Composición Corporal",
      preguntas: [
        "¿Consumes una dieta equilibrada con al menos 5 porciones de frutas y verduras al día?",
        "¿Controlas las porciones de comida y evitas comer en exceso?",
        "¿Realizas actividad física regular (al menos 150 minutos semanales)?",
        "¿Bebes suficiente agua (al menos 2 litros al día) y limitas bebidas azucaradas?",
        "¿Duermes entre 7-9 horas por noche?"
      ],
      recomendaciones: [
        "Comienza: Calcula tu IMC. Camina 30 min diarios. Reduce porciones.",
        "Enfócate: Registra tu ingesta. Agrega fuerza 2-3 veces/semana.",
        "Avanza: Mide circunferencias. Integra dieta mediterránea.",
        "Refina: Haz chequeos anuales. Enseña sobre sobrepeso en España.",
        "Excelente: Lidera grupos de nutrición."
      ]
    },
    medioambiente: {
      titulo: "Cuidado Medioambiental",
      preguntas: [
        "¿Recoges papeles o basura del suelo y los tiras a la papelera?",
        "¿Evitas tirar basura en el suelo, incluso si no hay papelera cerca?",
        "¿Separas residuos reciclables (papel, plástico) antes de desecharlos?",
        "¿Usas productos reutilizables (botellas, bolsas) en lugar de desechables?",
        "¿Participas en actividades de limpieza o brigadas verdes?"
      ],
      recomendaciones: [
        "Comienza: Lleva siempre la basura a la papelera. Recoge 5 papeles diarios.",
        "Enfócate: Separa reciclables. Organiza limpiezas semanales.",
        "Avanza: Crea carteles ambientales. Reporta papeleras llenas.",
        "Refina: Lidera plantaciones. Enseña sobre impacto del littering.",
        "Excelente: Organiza eventos de Brigada Verde mensuales."
      ]
    },
    espalda: {
      titulo: "Higiene de la Espalda",
      preguntas: [
        "¿Realizas estiramientos diarios para los isquiotibiales y la espalda?",
        "¿Mantienes una postura correcta al sentarte o estar de pie?",
        "¿Evitas cargar mochilas pesadas o distribuir el peso de manera desigual?",
        "¿Realizas pausas para estirarte durante periodos largos sentado?",
        "¿Duermes en una posición que apoye la curvatura natural de la espalda?"
      ],
      recomendaciones: [
        "Comienza: Estira isquios diarios. Evita mochilas pesadas.",
        "Enfócate: Corrige postura con recordatorios. Haz pausas activas.",
        "Avanza: Mide flexibilidad semanal. Usa almohadas de apoyo al dormir.",
        "Refina: Organiza chequeos posturales. Enseña sobre acortamiento de isquios.",
        "Excelente: Lidera grupos de higiene postural."
      ]
    },
    fuerza: {
      titulo: "Deporte y Fuerza",
      preguntas: [
        "¿Practicas ejercicios de fuerza (flexiones, sentadillas) al menos 2-3 veces por semana?",
        "¿Incorporas deporte en tu rutina diaria para mejorar la fuerza?",
        "¿Evitas el sedentarismo prolongado?",
        "¿Sigues una dieta que apoye el desarrollo de fuerza, con proteínas adecuadas?",
        "¿Participas en actividades que reduzcan el estrés, como el deporte?"
      ],
      recomendaciones: [
        "Comienza: Haz 10 flexiones diarias. Camina 30 min.",
        "Enfócate: Agrega 20 min de fuerza, 3 veces/semana.",
        "Avanza: Usa normogramas AVENA. Varía con cardio y fuerza.",
        "Refina: Ajusta dieta. Enseña sobre fuerza y salud mental.",
        "Excelente: Lidera grupos de deporte."
      ]
    },
    sueno: {
      titulo: "Hábitos de Sueño (Padres)",
      preguntas: [
        "¿Se acuesta más o menos a la misma hora todas las noches?",
        "¿Le cuesta mucho dormirse (más de 30 min)?",
        "¿Duerme entre 9 y 12 horas por noche?",
        "¿Se despierta varias veces sin razón?",
        "¿Usa pantallas menos de 1 hora antes de dormir?"
      ],
      recomendaciones: [
        "Es urgente mejorar: Establece horario fijo, elimina pantallas 1h antes. Consulta al pediatra si no mejora.",
        "Vas por buen camino: Reduce pantallas, asegura 9–12 h de sueño.",
        "¡Muy bien! Solo ajusta detalles: mantén rutina sin pantallas.",
        "Tu hijo/a tiene hábitos ejemplares. ¡Sigue así!"
      ],
      tipo: "binario",
      invertidas: [1, 3, 4] // índices base 0: preguntas 2, 4, 5 → favorables = "No"
    },
    relajacion: {
      titulo: "Relajación",
      preguntas: [
        "¿Dedicas al menos 30 minutos al día a actividades sin pantallas?",
        "¿Evitas el uso de dispositivos electrónicos al menos 1 hora antes de dormir?",
        "¿Practicas técnicas de respiración profunda o meditación diaria?",
        "¿Limitas el tiempo en redes sociales para evitar el estrés?",
        "¿Buscas entornos naturales o tranquilos, lejos de pantallas?"
      ],
      recomendaciones: [
        "Comienza: Establece 30 min diarios sin pantallas. Prueba respiración 4-6 seg.",
        "Enfócate: Silencia notificaciones después de las 8 PM. Usa journaling.",
        "Avanza: Crea zonas sin pantallas en casa. Apunta a <2h recreativas/día.",
        "Refina: Organiza 'días offline'. Enseña sobre luz azul y melatonina.",
        "Excelente: Lidera grupos de relajación. Promueve alternativas analógicas."
      ]
    }
  };

  // 4. Variables globales
  let testActual = null;
let listaDeAlumnos = [];
// --- FUNCIÓN parseCSV DEFINIDA DENTRO DEL MÓDULO ---
  function parseCSV(csvText) {
    // Asumiendo estructura fija: NRE, nº, curso, ap1, ap2, name
    const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
    if (lines.length < 2) {
      throw new Error("El archivo CSV está vacío o no tiene encabezados.");
    }
    const headers = lines[0].split(',').map(h => h.trim());

    // Opcional: Validar encabezados
    const expectedHeaders = ['NRE', 'nº', 'curso', 'ap1', 'ap2', 'name'];
    // if (!expectedHeaders.every(h => headers.includes(h))) {
    //    throw new Error("El archivo CSV no tiene las columnas esperadas: " + expectedHeaders.join(', '));
    // }

    const alumnos = [];
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(',').map(v => v.trim());
      const alumno = {};
      headers.forEach((header, index) => {
        alumno[header] = values[index] || '';
      });
      alumnos.push(alumno);
    }
    return alumnos;
  }
	
  // 5. Función para cargar contadores (solo si el usuario tiene rol)
  async function loadCounters() {
    // Verificar rol antes de leer
    const user = auth.currentUser;
    if (!user) return;
    const token = await user.getIdTokenResult();
    if (token.claims.rol !== "salud_escolar") return;

    try {
      const snapshot = await getDocs(collection(db, "resultadosHealthyFriday"));
      const count = snapshot.size;
      // Si tienes un elemento en tu HTML para mostrar este contador, descomenta y cámbialo:
      // document.getElementById('contadorHF').textContent = count; // Asume que tienes <span id="contadorHF">0</span>
      console.log(`Total resultados Healthy Friday: ${count}`); // Opcional: para debug
    } catch (error) {
      console.error("Error al cargar contadores de Healthy Friday:", error);
    }
  }

  // 6. Funciones de UI (sin cambios en lógica, solo expuestas globalmente)
  function mostrarMenu() {
    document.getElementById('menu').style.display = 'block';
    document.getElementById('test').style.display = 'none';
  }

  function cargarTest(tipo) {
    const test = tests[tipo];
    if (!test) return;

    testActual = tipo;
    document.getElementById('titulo-test').textContent = test.titulo;
    document.getElementById('form-preguntas').innerHTML = '';

    if (test.tipo === 'binario') {
      document.querySelector('.sueno-nota')?.remove();
      const nota = document.createElement('div');
      nota.className = 'sueno-nota';
      nota.innerHTML = '<strong>¡Importante!</strong> En las preguntas 2, 8 y 10, la respuesta favorable es “No”. En las demás, es “Sí”.';
      document.getElementById('form-datos').after(nota);
    }

    test.preguntas.forEach((pregunta, i) => {
      const div = document.createElement('div');
      div.className = 'pregunta-item';
      div.innerHTML = `<p><strong>${i + 1}.</strong> ${pregunta}</p>`;

      if (test.tipo === 'binario') {
        div.innerHTML += `
          <div class="opcion">
            <label><input type="radio" name="q${i}" value="si" required> Sí</label>
          </div>
          <div class="opcion">
            <label><input type="radio" name="q${i}" value="no" required> No</label>
          </div>
        `;
      } else {
        const opciones = ['Nunca', 'Rara vez', 'A veces', 'Frecuentemente', 'Siempre'];
        opciones.forEach((texto, idx) => {
          div.innerHTML += `
            <div class="opcion">
              <label><input type="radio" name="q${i}" value="${idx + 1}" required> ${idx + 1}: ${texto}</label>
            </div>
          `;
        });
      }

      document.getElementById('form-preguntas').appendChild(div);
    });

    document.getElementById('menu').style.display = 'none';
    document.getElementById('test').style.display = 'block';
    document.getElementById('resultado').style.display = 'none';
  }

  // 7. Función para calcular y guardar resultados (actualizada)
  async function calcularResultado() {
    const test = tests[testActual];
    let total = 0;
    const respuestas = {};

    if (test.tipo === 'binario') {
      test.preguntas.forEach((_, i) => {
        const si = document.querySelector(`input[name="q${i}"][value="si"]:checked`);
        const no = document.querySelector(`input[name="q${i}"][value="no"]:checked`);
        if (!si && !no) {
          alert("Por favor responde todas las preguntas.");
          return;
        }
        const valor = si ? 'si' : 'no';
        respuestas[`q${i + 1}`] = valor;
        const esInvertida = test.invertidas.includes(i);
        if ((si && !esInvertida) || (no && esInvertida)) {
          total += 1;
        }
      });
      let nivel, recIndex;
      if (total <= 2) { nivel = "Mal hábito"; recIndex = 0; }
      else if (total <= 3) { nivel = "A mejorar"; recIndex = 1; }
      else if (total <= 4) { nivel = "Bueno"; recIndex = 2; }
      else { nivel = "Excelente"; recIndex = 3; }
      document.getElementById('puntaje').textContent = `${total} / 5`;
      document.getElementById('nivel').textContent = nivel;
      document.getElementById('recomendaciones').innerHTML = `<h3>Recomendaciones:</h3><p>${test.recomendaciones[recIndex]}</p>`;
    } else {
      test.preguntas.forEach((_, i) => {
        const selected = document.querySelector(`input[name="q${i}"]:checked`);
        if (!selected) {
          alert("Por favor responde todas las preguntas.");
          return;
        }
        const valor = parseInt(selected.value);
        respuestas[`q${i + 1}`] = valor;
        total += valor;
      });
      let nivel, recIndex;
      if (total <= 7) { nivel = "Mal hábito"; recIndex = 0; }
      else if (total <= 12) { nivel = "Regular"; recIndex = 1; }
      else if (total <= 17) { nivel = "Bueno"; recIndex = 2; }
      else if (total <= 22) { nivel = "Muy bueno"; recIndex = 3; }
      else { nivel = "Excelente"; recIndex = 4; }
      document.getElementById('puntaje').textContent = `${total} / 25`;
      document.getElementById('nivel').textContent = nivel;
      document.getElementById('recomendaciones').innerHTML = `<h3>Recomendaciones:</h3><p>${test.recomendaciones[recIndex]}</p>`;
    }

    // === Guardar en Firestore ===
    const codigoAlumno = document.getElementById('codigoAlumno').value.trim().toUpperCase();
    const curso = document.getElementById('curso').value.trim();
    const edad = parseInt(document.getElementById('edad').value);
    const sexo = document.getElementById('sexo').value;

    if (!codigoAlumno || !curso || !edad || !sexo) {
      alert("Por favor completa todos los datos.");
      return;
    }

    const resultado = {
      codigoAlumno,
      testId: testActual,
      titulo: test.titulo,
      curso,
      edad,
      sexo,
      respuestas,
      puntaje: total,
      nivel: document.getElementById('nivel').textContent,
      fecha: serverTimestamp() // Usar hora del servidor
    };

    try {
      await addDoc(collection(db, "resultadosHealthyFriday"), resultado);
      console.log("✅ Resultado guardado para:", codigoAlumno, "en test:", testActual);
      // --- Actualizar contadores inmediatamente después de guardar ---
      await loadCounters(); // <- Llama a la función para actualizar
      // ------------------------------------------------------------
    } catch (error) {
      console.error("❌ Error al guardar:", error);
      alert("Error al guardar. ¿Hay conexión a internet?");
      return;
    }

    document.getElementById('resultado').style.display = 'block';
  }

  // 8. Función para generar informe analítico (actualizada y completada)
  async function generarInformeAnalitico() {
    // Verificar rol antes de leer
    const user = auth.currentUser;
    if (!user) {
        alert("Usuario no autenticado.");
        window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
        return;
    }
    const token = await user.getIdTokenResult();
    if (token.claims.rol !== "salud_escolar") {
        alert("Acceso denegado: solo profesores autorizados.");
        signOut(auth).then(() => {
            window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
        });
        return;
    }

    try {
      const snapshot = await getDocs(collection(db, "resultadosHealthyFriday"));
      if (snapshot.empty) {
        alert("No hay resultados aún.");
        return;
      }

      // Recopilar todos los resultados
      const todos = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        // Normalizar puntaje a escala 0-100 para comparabilidad
        let puntajeNormalizado;
        if (data.testId === 'sueno') {
          // Test binario: max 5 puntos → escala a 100
          puntajeNormalizado = (data.puntaje / 5) * 100;
        } else {
          // Tests de 5 preguntas: max 25 puntos → escala a 100
          puntajeNormalizado = (data.puntaje / 25) * 100;
        }
        todos.push({ ...data, puntaje100: puntajeNormalizado });
      });

      // [Misma lógica de cálculo del informe analítico que tenías antes]
      // --- Inicio de la lógica de cálculo del informe ---
      const alumnos = {};
      todos.forEach(r => {
        if (!alumnos[r.codigoAlumno]) {
          alumnos[r.codigoAlumno] = {
            codigo: r.codigoAlumno,
            curso: r.curso,
            sexo: r.sexo,
            puntajes: [],
            tests: new Set()
          };
        }
        // Evitar duplicados si un alumno repite un test
        if (!alumnos[r.codigoAlumno].tests.has(r.testId)) {
          alumnos[r.codigoAlumno].puntajes.push(r.puntaje100);
          alumnos[r.codigoAlumno].tests.add(r.testId);
        }
      });

      // Calcular promedio por alumno
      const alumnosConPromedio = Object.values(alumnos).map(a => {
        const promedio = a.puntajes.reduce((sum, p) => sum + p, 0) / a.puntajes.length;
        return {
          codigo: a.codigo,
          curso: a.curso,
          sexo: a.sexo,
          promedio,
          completados: a.puntajes.length
        };
      }).filter(a => a.completados >= 5); // Solo alumnos con al menos 5 tests

      if (alumnosConPromedio.length === 0) {
        alert("No hay alumnos con suficientes tests completados.");
        return;
      }

      // === 2. Mejores y peores cursos (por promedio de alumnos en ese curso) ===
      const cursos = {};
      alumnosConPromedio.forEach(a => {
        if (!cursos[a.curso]) cursos[a.curso] = [];
        cursos[a.curso].push(a.promedio);
      });

      const promedioCurso = {};
      for (const [curso, promedios] of Object.entries(cursos)) {
        promedioCurso[curso] = promedios.reduce((sum, p) => sum + p, 0) / promedios.length;
      }

      const cursosOrdenados = Object.entries(promedioCurso)
        .sort((a, b) => b[1] - a[1]);
      const mejorCurso = cursosOrdenados[0];
      const peorCurso = cursosOrdenados[cursosOrdenados.length - 1];

      // === 3. Comparativa global por género ===
      const genero = { masculino: [], femenino: [], nobinario: [] };
      alumnosConPromedio.forEach(a => {
        if (genero[a.sexo]) genero[a.sexo].push(a.promedio);
      });

      const promedioGenero = {};
      for (const [g, promedios] of Object.entries(genero)) {
        if (promedios.length > 0) {
          promedioGenero[g] = promedios.reduce((sum, p) => sum + p, 0) / promedios.length;
        }
      }

      // Determinar género con mejor promedio
      let mejorGenero = null;
      let mejorPromedio = -1;
      for (const [g, prom] of Object.entries(promedioGenero)) {
        if (prom > mejorPromedio) {
          mejorPromedio = prom;
          mejorGenero = g;
        }
      }

      // === 4. Diferencias por género dentro de cada curso ===
      const comparativaPorCurso = {};
      for (const curso of Object.keys(cursos)) {
        const datos = alumnosConPromedio.filter(a => a.curso === curso);
        const generosEnCurso = { masculino: [], femenino: [], nobinario: [] };
        datos.forEach(a => {
          if (generosEnCurso[a.sexo]) generosEnCurso[a.sexo].push(a.promedio);
        });

        comparativaPorCurso[curso] = {};
        for (const [g, promedios] of Object.entries(generosEnCurso)) {
          if (promedios.length > 0) {
            comparativaPorCurso[curso][g] = (promedios.reduce((sum, p) => sum + p, 0) / promedios.length).toFixed(1);
          }
        }
      }

      // === 5. Top 3 alumnos con mejor promedio ===
      const top3 = alumnosConPromedio
        .sort((a, b) => b.promedio - a.promedio)
        .slice(0, 3);
      // --- Fin de la lógica de cálculo del informe ---

      // === 6. Generar HTML del informe ===
      let html = `<h2>📊 Informe Analítico Healthy Friday</h2>`;
      html += `<p><em>Generado: ${new Date().toLocaleString()}</em></p><hr>`;

      // Mejor y peor curso
      html += `<h3>🏆 Mejor y Peor Curso</h3>`;
      html += `<p><strong>Mejor curso:</strong> ${mejorCurso[0]} (${mejorCurso[1].toFixed(1)}%)</p>`;
      html += `<p><strong>Peor curso:</strong> ${peorCurso[0]} (${peorCurso[1].toFixed(1)}%)</p><hr>`;

      // Comparativa por género
      html += `<h3>👥 Comparativa por Género (Global)</h3>`;
      for (const [g, prom] of Object.entries(promedioGenero)) {
        const nombre = g === 'masculino' ? 'Chicos' : g === 'femenino' ? 'Chicas' : 'No binario';
        html += `<p><strong>${nombre}:</strong> ${prom.toFixed(1)}%</p>`;
      }
      const nombreMejorGenero = mejorGenero === 'masculino' ? 'Chicos' : mejorGenero === 'femenino' ? 'Chicas' : 'No binario';
      html += `<p><strong>✅ Grupo con mejor desempeño:</strong> ${nombreMejorGenero}</p><hr>`;

      // Diferencias por curso y género
      html += `<h3>🔍 Comparativa por Curso y Género</h3>`;
      for (const [curso, generos] of Object.entries(comparativaPorCurso)) {
        html += `<h4>${curso}</h4><ul>`;
        for (const [g, prom] of Object.entries(generos)) {
          const nombre = g === 'masculino' ? 'Chicos' : g === 'femenino' ? 'Chicas' : 'No binario';
          html += `<li>${nombre}: ${prom}%</li>`;
        }
        html += `</ul>`;
      }
      html += `<hr>`;

      // Top 3 alumnos
      html += `<h3>🥇 Top 3 Alumnos Destacados</h3>`;
      top3.forEach((alumno, i) => {
        const posicion = ['1º', '2º', '3º'][i];
        const generoTexto = alumno.sexo === 'masculino' ? 'Chico' : alumno.sexo === 'femenino' ? 'Chica' : 'No binario';
        html += `<p><strong>${posicion}:</strong> ${alumno.codigo} (${generoTexto}, ${alumno.curso}) – ${alumno.promedio.toFixed(1)}%</p>`;
      });

      // Abrir en nueva ventana
      const win = window.open('', '_blank');
      win.document.write(`
        <html>
        <head>
          <title>Informe Analítico Healthy Friday</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
            h2 { color: #2563eb; text-align: center; }
            h3 { color: #1e293b; margin-top: 24px; }
            h4 { color: #475569; margin-top: 16px; }
            ul { padding-left: 20px; }
            li { margin-bottom: 8px; }
            hr { margin: 24px 0; border: 0; border-top: 1px solid #e2e8f0; }
          </style>
        </head>
        <body>${html}</body>
        </html>
      `);
      win.document.close();

    } catch (error) {
      console.error("Error en informe analítico:", error);
      alert("No se pudo generar el informe analítico.");
    }
  }
// --- NUEVAS FUNCIONES PARA GESTIÓN DE ALUMNOS ---

// --- FUNCIONES MODIFICADAS PARA USAR FIRESTORE ---

// 1. Función para importar CSV (con contraseña y guardado en Firestore)
let archivoPendiente = null;

// --- FUNCIÓN PARA ABRIR EL SELECTOR DE ARCHIVOS INMEDIATAMENTE ---
function abrirSelectorYVerificarContraseña() {
  // Al hacer clic en el botón, inmediatamente se abre el selector de archivos
  // Esto garantiza "user activation".
  const input = document.getElementById('filePickerCSV');
  input.click(); // <-- Este click ocurre inmediatamente tras el click del usuario
}
// --- FUNCIÓN PARA PROCESAR EL ARCHIVO SELECCIONADO (ahora con verificación de contraseña) ---
// Esta función se define una sola vez y se asigna al onchange del input oculto
// Idealmente, esto debería suceder una vez al inicializar la página, si el rol es correcto.
async function procesarArchivoCSVSeleccionado(event) {
  const file = event.target.files[0];
  if (!file) {
      console.log("No se seleccionó ningún archivo (posiblemente cancelado por el usuario).");
      return; // El usuario canceló la selección
  }
// Verificar la contraseña *después* de que se haya seleccionado un archivo
  const CONTRASENA_CSV = "healthy_Friday_2025";
  const pass = prompt("Introduzca la contraseña para importar la lista de alumnos:");
  if (pass !== CONTRASENA_CSV) {
    alert("Contraseña incorrecta. Importación cancelada.");
    return; // Detener la ejecución si la contraseña no es válida
  }
	
  try {
    const csvText = await file.text();
    const alumnos = parseCSV(csvText); // Asumiendo que parseCSV está definida como antes

    // --- GUARDAR EN FIRESTORE ---
    // Usar 'db' y 'doc' que deben estar importados en el scope del módulo
    // Asegúrate de que 'db' sea accesible aquí (debe estar definido en el scope superior del módulo)
    await setDoc(doc(db, "resultadosHealthyFriday", "global"), { alumnosCSV: alumnos }, { merge: true });
    console.log(`✅ ${alumnos.length} alumnos guardados en Firestore.`);

    // Actualizar la variable local y el select inmediatamente después de guardar
    listaDeAlumnos = alumnos; // Actualizar la lista en memoria
    actualizarSelectCodigos(alumnos);
    alert(`Importados y guardados ${alumnos.length} alumnos correctamente.`);
  } catch (error) {
    console.error("Error al importar o guardar CSV:", error);
    alert(`Error al leer, procesar o guardar el archivo CSV: ${error.message}`);
  }
}


	
//let listaDeAlumnos = []; // Variable global (o de módulo) para almacenar la lista cargada
// 2. Función para cargar alumnos desde Firestore (en lugar de localStorage)
// --- FUNCIÓN PARA CARGAR DESDE FIRESTORE (una sola vez) ---
async function cargarAlumnosDesdeFirestore() {
  try {
    const docRef = doc(db, "resultadosHealthyFriday", "global");
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
      const data = docSnap.data();
      // Actualizar la variable global con los datos obtenidos
      listaDeAlumnos = data.alumnosCSV || [];
      console.log(`✅ ${listaDeAlumnos.length} alumnos cargados en memoria desde Firestore.`);
      actualizarSelectCodigos(listaDeAlumnos);
      return listaDeAlumnos;
    } else {
      console.log("_firestore: No se encontró el documento de configuración global._");
      const select = document.getElementById('codigoAlumno');
      select.innerHTML = '<option value="">-- No hay alumnos disponibles --</option>';
      listaDeAlumnos = []; // Asegurar que la lista local también esté vacía
      return listaDeAlumnos;
    }
  } catch (error) {
    console.error("Error al cargar alumnos desde Firestore:", error);
    const select = document.getElementById('codigoAlumno');
    select.innerHTML = '<option value="">-- Error al cargar alumnos --</option>';
    listaDeAlumnos = []; // Asegurar que la lista local también esté vacía
    return listaDeAlumnos;
  }
}

// 3. Función para actualizar el select de códigos (sin cambios)
function actualizarSelectCodigos(alumnos) {
  const select = document.getElementById('codigoAlumno');
  select.innerHTML = '<option value="">-- Selecciona un alumno --</option>'; // Limpiar
  alumnos.forEach(alumno => {
    const option = document.createElement('option');
    option.value = alumno.NRE;
    option.textContent = `${alumno.NRE} - ${alumno.name || ''} ${alumno.ap1 || ''} ${alumno.ap2 || ''} (${alumno.curso || 'Curso no especificado'})`;
    select.appendChild(option);
  });
}

// 4. Función para manejar el cambio de selección de alumno (sin cambios)
function onCodigoAlumnoChange() {
  const codigoSeleccionado = document.getElementById('codigoAlumno').value;
  if (!codigoSeleccionado) {
    document.getElementById('curso').value = '';
    document.getElementById('edad').value = '';
    return;
  }
  // Cargar alumnos para encontrar el seleccionado
  // Para mejorar eficiencia, guarda la lista de alumnos en una variable global o en el scope del módulo
  // después de cargarla una vez, y úsala aquí.
  // Buscar el alumno en la lista almacenada en memoria, NO en Firestore
  const alumno = listaDeAlumnos.find(a => a.NRE === codigoSeleccionado);
     
     if (alumno) {
     document.getElementById('curso').value = alumno.curso;
     let edadCalculada = '';
     switch(alumno.curso) {
       case '1º ESO':
         edadCalculada = 11;
         break;
       case '2º ESO':
         edadCalculada = 12;
         break;
       case '3º ESO':
         edadCalculada = 13;
         break;
       case '4º ESO':
         edadCalculada = 15;
         break;
       default:
         break;
     }
     if (edadCalculada) {
         document.getElementById('edad').value = edadCalculada;
     }
  } else {
     // Opcional: Limpiar si no se encuentra (aunque debería existir si está en el select)
     document.getElementById('curso').value = '';
     document.getElementById('edad').value = '';
  }
}

// --- FUNCIÓN PARA REINICIAR EL TEST ---
function resetTest() {
  console.log("Iniciando reinicio del test...");

  // 1. Limpiar formulario de datos personales
  // El select de alumnos se deja en la opción por defecto (la primera)
  const codigoAlumnoSelect = document.getElementById('codigoAlumno');
  if (codigoAlumnoSelect) {
    codigoAlumnoSelect.selectedIndex = 0; // Selecciona la primera opción ("-- Importa la lista de alumnos --" o "-- Selecciona un alumno --")
    // Opcional: Si quieres limpiarlo por completo y dejar solo la opción por defecto:
    // codigoAlumnoSelect.innerHTML = '<option value="">-- Importa la lista de alumnos --</option>';
  }
  const cursoSelect = document.getElementById('curso');
  if (cursoSelect) {
    cursoSelect.value = ''; // Selecciona la opción vacía o por defecto
  }
  const edadInput = document.getElementById('edad');
  if (edadInput) {
    edadInput.value = ''; // Limpia el campo de edad
  }
  const sexoSelect = document.getElementById('sexo');
  if (sexoSelect) {
    sexoSelect.value = 'masculino'; // O el valor por defecto que desees
  }

  // 2. Limpiar y ocultar la sección de resultados
  const resultadoDiv = document.getElementById('resultado');
  if (resultadoDiv) {
    resultadoDiv.style.display = 'none';
    // Opcional: Limpiar el contenido interno por si acaso
    // resultadoDiv.innerHTML = '<h2>Resultados</h2><p><strong>Puntuación total:</strong> <span id="puntaje"></span></p>... (resto del HTML original del resultado)';
  }

  // 3. Ocultar botones que aparecen tras calcular (si los tienes con IDs específicos)
  // Ajusta estos IDs si en tu HTML original usas otros nombres
  const exportBtn = document.getElementById('exportBtn');
  const exportAllBtn = document.getElementById('exportAllBtn');
  const reportBtn = document.getElementById('reportBtn');
  const resetBtn = document.getElementById('resetBtn');
  // if (exportBtn) exportBtn.classList.add('hidden'); // Asume que tienes una clase .hidden { display: none; }
  // if (exportAllBtn) exportAllBtn.classList.add('hidden');
  // if (reportBtn) reportBtn.classList.add('hidden');
  // if (resetBtn) resetBtn.classList.add('hidden');

	// 3. LIMPIAR PREGUNTAS: Deseleccionar todos los radios y checkboxes
  // Selecciona todos los inputs de tipo radio y checkbox dentro del formulario de preguntas
  // Asumiendo que el contenedor de preguntas tiene el ID 'form-preguntas'
  const formPreguntas = document.getElementById('form-preguntas');
  if (formPreguntas) {
    const allRadiosAndCheckboxes = formPreguntas.querySelectorAll('input[type="radio"], input[type="checkbox"]');
    allRadiosAndCheckboxes.forEach(input => {
      input.checked = false; // Deseleccionar cada radio/checkbox
    });
  }
  // 4. Volver a la sección de datos personales (o al menú si prefieres)
  // Asumiendo que el contenedor principal del test es #test y el formulario de datos es #form-datos
  // Y que el menú principal es #menu
  // document.getElementById('menu').style.display = 'none'; // Ocultar menú si estaba visible
  document.getElementById('test').style.display = 'block'; // Asegurar que el contenedor del test esté visible
  // Si hay otras secciones del test activas (como las preguntas), hay que ocultarlas.
  // Por ejemplo, si tienes un div para las preguntas:
  // document.getElementById('form-preguntas').style.display = 'none'; // Ocultar preguntas si están visibles

  // 5. Opcional: Reiniciar variables internas si las tienes
  testActual = null; // Reiniciar la variable global que indica el test actual

  console.log("Test reiniciado correctamente.");
	// 6. DESPLAZARSE AL TOP DE LA PÁGINA
  window.scrollTo({ top: 0, behavior: 'smooth' }); // Desplazamiento suave al inicio

  // 7. PONER FOCO EN EL SELECT DE CÓDIGO DE ALUMNO
  if (codigoAlumnoSelect) {
    // Opcional: Añadir un pequeño delay para asegurar que el scroll se complete antes de enfocar
    // Esto puede mejorar la experiencia en navegadores más lentos
    setTimeout(() => {
      codigoAlumnoSelect.focus();
      // Opcional: Si también quieres seleccionar el texto (aunque aquí no hay texto para seleccionar, solo cambia el índice)
      // codigoAlumnoSelect.select(); // Esto no aplica a 'select', pero sí a 'input'
    }, 100); // 100 milisegundos de delay pueden ser suficientes
}
}

	// --- FUNCIÓN PARA REDIRIGIR CON SPINNER (Mostrar spinner y redirigir) ---
function redirigirASaludEscolarConCarga() {
  // 1. Crear el contenedor de overlay y contenido
  const overlay = document.createElement('div');
  overlay.id = 'loading-overlay';

  const content = document.createElement('div');
  content.id = 'loading-content';

  const spinner = document.createElement('div');
  spinner.className = 'spinner';

  const message = document.createElement('p');
  message.textContent = 'Cargando Programa Salud Escolar...';

  content.appendChild(spinner);
  content.appendChild(message);
  overlay.appendChild(content);
  document.body.appendChild(overlay);

  // 2. Esperar 3 segundos y luego REDIRIGIR la pestaña actual
  //    Durante este tiempo, el usuario solo ve el spinner en esta página.
  setTimeout(() => {
    // Redirigir la pestaña actual a salud-escolar.html
    // La nueva página se encargará de mostrar su propio spinner si es necesario
    // y de ocultarlo cuando esté lista.
    window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/salud-escolar.html';
  }, 3000); // 3000 milisegundos = 3 segundos
}
// --- FIN FUNCIÓN ---

// --- FIN NUEVAS FUNCIONES ---

	
  // 9. Protección principal: verificar autenticación y rol
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const token = await user.getIdTokenResult();
      if (token.claims.rol === "salud_escolar") {
        // ✅ Acceso permitido: mostrar menú y cargar contadores
        document.getElementById('menu').style.display = 'block'; // Mostrar menú inicial
		 
		  document.getElementById('import-csv-section').style.display = 'block'; // Mostrar el botón de importar
       		 await loadCounters(); // Cargar contadores al inicio
		  	// --- Añadir nuevas funcionalidades ---
			await cargarAlumnosDesdeFirestore(); // Cargar lista desde Firestore
			// Añadir listener al select de código de alumno
			document.getElementById('codigoAlumno').addEventListener('change', onCodigoAlumnoChange);
			// --- Fin nuevas funcionalidades ---
        	// Exponer funciones globales para onclick en HTML
		
        window.cargarTest = cargarTest;
        window.calcularResultado = calcularResultado;
        window.generarInformeAnalitico = generarInformeAnalitico;
        window.mostrarMenu = mostrarMenu;
		 window.abrirSelectorYVerificarContraseña = abrirSelectorYVerificarContraseña; 
		document.getElementById('filePickerCSV').onchange = procesarArchivoCSVSeleccionado;
		document.getElementById('filePickerCSV').onchange = procesarArchivoCSVSeleccionado;
		  
        window.logout = () => {
          signOut(auth).then(() => {
            window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
          });
        };
		  // --- Añadir la clase para el fade-in ---
			const contenedorPrincipal = document.querySelector('body'); // O el contenedor real
			if (contenedorPrincipal) {
			  contenedorPrincipal.classList.add('transicion-fade-in');
			} else {
			  document.body.classList.add('transicion-fade-in'); // Fallback
			}
		  	// --- Añadir esta línea para exponer resetTest ---
			window.resetTest = resetTest; // <-- ESTO PERMITE onclick="resetTest()"
		  window.redirigirASaludEscolarConCarga = redirigirASaludEscolarConCarga; 
      } else {
        // ❌ Sin rol
		document.getElementById('import-csv-section').style.display = 'none'; // Asegurar que esté oculto
        alert("Acceso denegado: solo profesores autorizados.");
        signOut(auth).then(() => {
          window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
        });
      }
    } else {
      // ❌ No autenticado
		document.getElementById('import-csv-section').style.display = 'none'; // Asegurar que esté oculto
      window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
    }
  });

// 10. Mostrar bases del concurso con retraso y cierre automático (modificado)
window.addEventListener('DOMContentLoaded', () => {
  const bases = `🏆 BASES DEL CONCURSO HEALTHY FRIDAY 🏆

• Cada alumno debe completar los 10 tests (uno por estación).
• Para participar en el ranking, se requiere haber completado al menos 5 tests.
• Los 3 alumnos con el promedio más alto (de 0 a 100) recibirán un premio.
• El código de alumno es personal e intransferible.
• Los resultados se basan en respuestas honestas y responsables.
• El jurado (equipo docente) se reserva el derecho de verificar la validez de los datos.

¡Participa con compromiso y gana reconociendo tus hábitos saludables!`;

  // Crear el contenedor del mensaje
  const basesDiv = document.createElement('div');
  basesDiv.id = 'bases-concurso';
  basesDiv.innerHTML = `
    <div class="bases-content">
      <h3>🏆 BASES DEL CONCURSO HEALTHY FRIDAY 🏆</h3>
      <p>${bases.split('\n').map(line => `<span>${line}</span>`).join('<br/>')}</p>
      <button id="cerrar-bases" type="button">&times;</button>
    </div>
  `;
  document.body.appendChild(basesDiv);

  // Estilos para el contenedor superpuesto (deben aplicarse antes de mostrarlo)
  const style = document.createElement('style');
  style.textContent = `
    #bases-concurso {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7); /* Fondo oscuro semitransparente */
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000; /* Asegura que esté por encima de todo */
      opacity: 0; /* Inicialmente invisible */
      transition: opacity 0.5s ease-in-out; /* Transición suave para fade */
      pointer-events: none; /* Inicialmente no recibe eventos de mouse */
    }

    #bases-concurso.show {
      opacity: 1; /* Visible */
      pointer-events: auto; /* Recibe eventos de mouse cuando está visible */
    }

    .bases-content {
      background-color: white;
      padding: 24px;
      border-radius: 12px;
      max-width: 80%;
      max-height: 80%;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      position: relative; /* Para posicionar el botón de cierre */
      text-align: left;
    }

    .bases-content h3 {
      margin-top: 0;
      color: #2563eb; /* Color primario */
      text-align: center;
    }

    .bases-content p {
      margin-bottom: 0;
      line-height: 1.5;
    }

    #cerrar-bases {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }

    #cerrar-bases:hover {
      color: #000;
    }
  `;
  document.head.appendChild(style);

  // Función para mostrar el mensaje
  const mostrarBases = () => {
    basesDiv.classList.add('show');
  };

  // Función para ocultar el mensaje
  const ocultarBases = () => {
    basesDiv.classList.remove('show');
    // Opcional: eliminar el div del DOM después de la transición de salida
    // Esto impide que se intente ocultar de nuevo si se llama varias veces
    setTimeout(() => {
      if (basesDiv.parentNode) {
        basesDiv.parentNode.removeChild(basesDiv);
        document.head.removeChild(style); // Limpiar el estilo también
      }
    }, 800); // Esperar a que termine la transición de fade-out (0.5s)
  };

  // Configurar el botón de cierre para que llame a ocultarBases
  document.getElementById('cerrar-bases').addEventListener('click', ocultarBases);

  // Mostrar el mensaje después de 3 segundos
  setTimeout(mostrarBases, 1500); // 3000 ms = 3 segundos

  // Cerrar el mensaje automáticamente 3 segundos *después* de haber aparecido
  // Es decir, a los 3s (mostrar) + 3s (cerrar automático) = 6s desde la carga
  setTimeout(ocultarBases, 5000); // 6000 ms = 6 segundos
});

</script>
</body>
</html>
