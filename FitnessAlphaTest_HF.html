
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPHA Fitness Test - Sistema de Evaluación</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <style>
   
   :root {
    /* ... tus variables existentes ... */
    /* Variables del ejemplo */
    --masculino-1: #4CAF50; /* Verde - Muy Deficiente */
    --masculino-2: #FFC107; /* Amarillo - Deficiente */
    --masculino-3: #FF9800; /* Naranja - Adecuado */
    --masculino-4: #FF5722; /* Naranja rojizo - Bueno */
    --masculino-5: #F44336; /* Rojo - Excelente */
    --femenino-1: #5B8DF1; /* Azul brillante - Muy Deficiente */
    --femenino-2: #3A6BC7; /* Azul medio - Deficiente */
    --femenino-3: #2A4D9E; /* Azul oscuro - Adecuado */
    --femenino-4: #6B52AE; /* Azul violeta - Bueno */
    --femenino-5: #8A3EB7; /* Violeta - Excelente */
    --neutral-light: #f8f9fa;
    --neutral-dark: #343a40;
    --accent-color: #6f42c1;
    --text-primary: #212529;
    --text-secondary: #6c757d;
    --border-radius: 12px;
    --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
    /* ... tus variables existentes ... */
}
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        overflow: hidden;
    }
    .header {
        background: linear-gradient(90deg, #2c3e50, #3498db);
        color: white;
        padding: 20px;
        text-align: center;
    }
    .nav-tabs {
        display: flex;
        background: #ecf0f1;
        border-bottom: 2px solid #bdc3c7;
    }
    .tab-btn {
        flex: 1;
        padding: 15px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
    }
    .tab-btn.active {
        background: #3498db;
        color: white;
    }
    .tab-content {
        display: none;
        padding: 30px;
    }
    .tab-content.active {
        display: block;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .form-group input, .form-group select {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
    }
    .btn {
        background: #3498db;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
    }
    .btn:hover {
        background: #2980b9;
    }
    .btn-success {
        background: #27ae60;
    }
    .btn-warning {
        background: #f39c12;
    }
    .btn-danger {
        background: #e74c3c;
    }
    .result-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 20px;
        margin: 10px 0;
    }
    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    .stat-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 18px;
        padding: 15px;
    }
	
    .hidden {
        display: none;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
    }
    th {
        background-color: #3498db;
        color: white;
    }
    tr:nth-child(even) {
        background-color: #f2f2f2;
    }
    .login-section {
        max-width: 400px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .login-section input {
        width: 100%;
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    .recommendations {
        background: #e8f5e8;
        border: 1px solid #27ae60;
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
    }
    .health-info {
        background: #f0f8ff;
        border: 1px solid #3498db;
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
    }
    .comparison-chart {
        height: 300px;
        margin: 20px 0;
    }
	
	/* CHAERTs*/
/* Contenedores específicos para cada gráfico */
.chart-container:has(#analisisEdadChart, #comparacionGeneroChart) {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.08),
        0 4px 12px rgba(0, 0, 0, 0.04);
    padding: 24px;
    margin: 20px 0;
    border: 1px solid #f1f5f9;
    position: relative;
    overflow: hidden;
    animation: fadeInUp 0.6s ease-out;
}
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.08),
        0 4px 12px rgba(0, 0, 0, 0.04);
    padding: 24px;
    margin: 20px 0;
    border: 1px solid #f1f5f9;
    position: relative;
    overflow: hidden;
    animation: fadeInUp 0.6s ease-out;
}

/* Gráfico de análisis por edad - Estilo específico */
.chart-container:has(#analisisEdadChart) {
    border-top: 4px solid #10b981;
}

.chart-container:has(#analisisEdadChart)::before {
    content: '📈 Análisis Temporal';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #10b981, #059669, #047857);
    opacity: 0.9;
    font-size: 0;
}

/* Gráfico de comparación por género - Estilo específico */
.chart-container:has(#comparacionGeneroChart) {
    border-top: 4px solid #6366f1;
}

.chart-container:has(#comparacionGeneroChart)::before {
    content: '👥 Comparativa';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #6366f1, #8b5cf6, #a855f7);
    opacity: 0.9;
    font-size: 0;
}

/* Canvas específicos para cada gráfico */
#analisisEdadChart {
    border-radius: 12px;
    background: white;
    padding: 15px;
    border: 1px solid #e2e8f0;
    width: 100% !important;
    height: 400px !important;
}

#comparacionGeneroChart {
    border-radius: 12px;
    background: white;
    padding: 15px;
    border: 1px solid #e2e8f0;
    width: 100% !important;
    height: 400px !important;
}

/* Filtros específicos para análisis */
.filtros-analisis {
    display: flex;
    gap: 20px;
    margin: 20px 0;
    padding: 20px;
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    flex-wrap: wrap;
}

.filtro-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 200px;
}

.filtro-label {
    font-weight: 600;
    color: #475569;
    font-size: 0.9rem;
}

.filtro-select {
    padding: 10px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    background: white;
    color: #334155;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.filtro-select:hover {
    border-color: #cbd5e1;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.filtro-select:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

/* Leyendas personalizadas para cada gráfico */
/* Leyenda para análisis por edad */
.chart-container:has(#analisisEdadChart) .chartjs-legend {
    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
    border: 1px solid #bbf7d0;
    border-radius: 12px;
    padding: 16px;
    margin-top: 20px;
}

/* Leyenda para comparación por género */
.chart-container:has(#comparacionGeneroChart) .chartjs-legend {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    border: 1px solid #bae6fd;
    border-radius: 12px;
    padding: 16px;
    margin-top: 20px;
}

/* Tooltips específicos */
.chart-container:has(#analisisEdadChart) .chartjs-tooltip {
    background: linear-gradient(135deg, #064e3b, #065f46) !important;
    border: 1px solid #047857 !important;
    border-radius: 12px !important;
}

.chart-container:has(#comparacionGeneroChart) .chartjs-tooltip {
    background: linear-gradient(135deg, #3730a3, #312e81) !important;
    border: 1px solid #4f46e5 !important;
    border-radius: 12px !important;
}

/* Estados hover específicos */
.chart-container:has(#analisisEdadChart):hover {
    box-shadow: 
        0 12px 40px rgba(16, 185, 129, 0.15),
        0 6px 20px rgba(16, 185, 129, 0.08);
    transform: translateY(-2px);
}

.chart-container:has(#comparacionGeneroChart):hover {
    box-shadow: 
        0 12px 40px rgba(99, 102, 241, 0.15),
        0 6px 20px rgba(99, 102, 241, 0.08);
    transform: translateY(-2px);
}

/* Títulos personalizados para cada gráfico */
.chart-container:has(#analisisEdadChart)::after {
    content: 'Evolución del Rendimiento por Edad';
    position: absolute;
    top: 15px;
    left: 24px;
    font-size: 1.25rem;
    font-weight: 700;
    color: #064e3b;
    background: rgba(16, 185, 129, 0.1);
    padding: 8px 16px;
    border-radius: 8px;
}

.chart-container:has(#comparacionGeneroChart)::after {
    content: 'Comparativa de Rendimiento por Género';
    position: absolute;
    top: 15px;
    left: 24px;
    font-size: 1.25rem;
    font-weight: 700;
    color: #312e81;
    background: rgba(99, 102, 241, 0.1);
    padding: 8px 16px;
    border-radius: 8px;
}

/* Responsive design específico */
@media (max-width: 768px) {
    .chart-container {
        padding: 16px;
        margin: 15px 0;
    }
    
    #analisisEdadChart,
    #comparacionGeneroChart {
        height: 350px !important;
        padding: 10px;
    }
    
    .chart-container:has(#analisisEdadChart)::after,
    .chart-container:has(#comparacionGeneroChart)::after {
        position: relative;
        top: 0;
        left: 0;
        margin-bottom: 15px;
        display: block;
        text-align: center;
    }
    
    .filtros-analisis {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
    }
    
    .filtro-group {
        min-width: auto;
    }
}

@media (max-width: 480px) {
    #analisisEdadChart,
    #comparacionGeneroChart {
        height: 300px !important;
        padding: 8px;
    }
    
    .chart-container:has(#analisisEdadChart)::after,
    .chart-container:has(#comparacionGeneroChart)::after {
        font-size: 1.1rem;
        padding: 6px 12px;
    }
}



/* Animaciones */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Estados de carga específicos */
.chart-container:has(#analisisEdadChart.loading)::before,
.chart-container:has(#comparacionGeneroChart.loading)::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 40px;
    height: 40px;
    border: 3px solid #e2e8f0;
    border-top: 3px solid;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    transform: translate(-50%, -50%);
    z-index: 10;
}

.chart-container:has(#analisisEdadChart.loading)::before {
    border-top-color: #10b981;
}

.chart-container:has(#comparacionGeneroChart.loading)::before {
    border-top-color: #6366f1;
}

@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Mejoras de accesibilidad */
@media (prefers-reduced-motion: reduce) {
    .chart-container {
        animation: none;
    }
    
    .chart-container:hover {
        transform: none;
    }
}
	
	
	
	
	
/* === Estilos base === */
/* === Estilos base para el Resultado del Test === */
.test-result {
    display: flex;
    align-items: center;
    margin: 15px 0;
    padding: 18px 20px;
    border-radius: 14px;
    background: linear-gradient(145deg, #ffffff, #f6f6f6);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    flex-wrap: wrap;
    box-sizing: border-box; /* Asegura que padding/border no aumenten el ancho/altura */
}
.test-result:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
}
/* === Información del test === */
.test-info {
    flex: 1;
    min-width: 250px;
    padding-right: 25px;
    box-sizing: border-box; /* Asegura que padding/border no aumenten el ancho/altura */
}
.test-value {
    font-size: 26px;
    font-weight: 700;
    color: #222;
}
/* === Barra principal de progreso === */
.test-scale {
    flex: 2;
    position: relative;
    height: 30px; /* CORRECCIÓN: Altura reducida */
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 5px; /* CORRECCIÓN: Bordes más redondeados para la nueva altura */
    overflow: visible; /* Cambiado a 'visible' para que los elementos encima y debajo no se recorten */
    margin-bottom: 5px; /* CORRECCIÓN: Reducido el margen inferior */
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
    box-sizing: border-box; /* Asegura que padding/border no aumenten el ancho/altura */
}

/* === Contenedor para los segmentos de color === */
.progress-segments {
    display: flex;
    height: 100%;
    border-radius: 5px; /* CORRECCIÓN: Ajustado al nuevo borde */
    overflow: hidden;
    box-sizing: border-box; /* Asegura que padding/border no aumenten el ancho/altura */
}

/* === Estilo para cada segmento === */
.segment {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    transition: all 0.3s ease;
    position: relative;
    font-size: 0.8rem; /* CORRECCIÓN: Tamaño de fuente reducido */
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    box-sizing: border-box; /* Asegura que padding/border no aumenten el ancho/altura */
}
/* Colores específicos para cada categoría */
.segment.muy-bajo { background-color: #e74c3c; } /* Rojo - Muy Bajo */
.segment.bajo { background-color: #f39c12; } /* Naranja - Bajo */
.segment.promedio { background-color: #8bc34a; } /* Verde - Promedio */
.segment.alto { background-color: #81d4fa; } /* Azul Claro - Alto */
.segment.muy-alto { background-color: #1e88e5; } /* Azul Fuerte - Muy Alto */

/* Estilo para los límites (etiquetas debajo de la barra) */
.segment-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 3px; /* CORRECCIÓN: Espacio reducido entre la barra y las etiquetas */
    margin-bottom: 5px; /* CORRECCIÓN: Margen inferior para separar de la zona de salud */
    font-size: 0.9rem; /* CORRECCIÓN: Tamaño de fuente reducido */
    box-sizing: border-box; /* Asegura que padding/border no aumenten el ancho/altura */
}
.segment-label {
    text-align: center;
    font-weight: bold;
    flex: 1;
    color: #333; /* Color del texto */
    box-sizing: border-box; /* Asegura que padding/border no aumenten el ancho/altura */
}

/* === Indicador de flecha (puntero del usuario) === */
.arrow-indicator {
    position: absolute;
    top: -20px; /* CORRECCIÓN: Posición encima de la barra, ajustada a la nueva altura */
    width: 100%;
    height: 50px; /* CORRECCIÓN: Altura suficiente para flecha y valor, ajustada */
    pointer-events: none; /* No interfiera con otros eventos */
    color: black;
    z-index: 10; /* Asegura que esté por encima de otros elementos */
    box-sizing: border-box; /* Asegura que padding/border no aumenten el ancho/altura */
}

/* Flecha invertida */
.arrow {
    width: 0;
    height: 0;
    border-left: 10px solid transparent; /* CORRECCIÓN: Tamaño reducido */
    border-right: 10px solid transparent; /* CORRECCIÓN: Tamaño reducido */
    border-top: 15px solid #080808; /* Color negro, tamaño ajustado */
    position: absolute;
    top: 0;
    left: 0;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
    transition: left 0.5s ease;
    z-index: 10; /* Asegura que esté por encima de la barra */
    box-sizing: border-box; /* Asegura que padding/border no aumenten el ancho/altura */
}

/* Valor del usuario encima de la flecha */
.arrow-value {
    position: absolute;
    top: -30px; /* CORRECCIÓN: Ajusta la posición vertical del valor */
    left: 50%; /* Centrado horizontalmente respecto a la flecha */
    transform: translateX(-50%);
    background-color: #ffffff;
    color: #333;
    padding: 2px 6px; /* CORRECCIÓN: Padding reducido */
    border-radius: 4px; /* CORRECCIÓN: Bordes redondeados ajustados */
    font-weight: bold;
    font-size: 0.8rem; /* CORRECCIÓN: Tamaño de fuente reducido */
    white-space: nowrap;
    z-index: 11; /* Mayor que la flecha */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    box-sizing: border-box; /* Asegura que padding/border no aumenten el ancho/altura */
}

/* Línea que baja desde la flecha (opcional, puede eliminarse si no se desea) */
.arrow-line {
    position: absolute;
    top: 15px; /* CORRECCIÓN: Parte inferior de la flecha ajustada */
    left: 50%;
    transform: translateX(-50%);
    width: 2px; /* CORRECCIÓN: Ancho reducido */
    height: 35px; /* CORRECCIÓN: Longitud de la línea ajustada */
    background: linear-gradient(to bottom, #080808, transparent); /* Color que va desapareciendo */
    z-index: 5; /* Detrás de la flecha y el valor */
    box-sizing: border-box; /* Asegura que padding/border no aumenten el ancho/altura */
}

/* === Zona de salud (Categoría y Puntos) - Ajustar posición si es necesario === */
/* (Mantener los estilos anteriores para .zone-indicator, .score-box, etc.) */
/* === Indicadores de zona === */
.zone-indicator {
    display: inline-block;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    margin-right: 6px;
    box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
    box-sizing: border-box; /* Asegura que padding/border no aumenten el ancho/altura */
}
/* === Indicadores de zona (5 niveles) === */
.zone-muy-bajo { background: #e74c3c; }      /* rojo */
.zone-bajo { background: #f39c12; }         /* naranja */
.zone-promedio { background: #8bc34a; }     /* verde */
.zone-alto { background: #81d4fa; }         /* azul claro */
.zone-muy-alto { background: #1e88e5; }     /* azul fuerte */
.category-badge { /* (Mantener estilos anteriores) */
    display: inline-block;
    padding: 3px 8px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 8px;
    color: white;
    min-width: 80px;
    text-align: center;
    box-sizing: border-box; /* Asegura que padding/border no aumenten el ancho/altura */
}
.category-muy-bajo  { background: #e74c3c; }  /* rojo */
.category-bajo      { background: #f39c12; }  /* naranja */
.category-promedio  { background: #8bc34a; }  /* verde */
.category-alto      { background: #81d4fa; }  /* azul claro */
.category-muy-alto  { background: #1e88e5; }  /* azul fuerte */


/* CHART INFORME RESULTS*/

.chart-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 30px;
            transition: var(--transition);
        }

        .chart-card:hover {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
        }

        /* --- Estilo específico para el encabezado dentro de .chart-card --- */
.chart-card .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start; /* Alinea al inicio para que el subtítulo quede arriba */
    margin-bottom: 15px; /* Reduce el espacio antes del gráfico */
    flex-wrap: wrap;
    gap: 10px; /* Menor separación entre título y elementos laterales (si los hubiera) */
}

/* --- Estilo específico para el título dentro del .chart-card .chart-header --- */
.chart-card .chart-header .chart-title {
    font-size: 1.4rem; /* Tamaño de fuente ligeramente más pequeño para integrarse */
    font-weight: 600;
    color: #1a365d;    /* Color consistente con el texto principal */
    margin: 0;         /* Sin márgenes */
    /* Aplicar degradado azul/marino como en otros títulos importantes */
    background: linear-gradient(2deg, rgba(90, 146, 184, 1) 0%, rgba(9, 104, 121, 1) 85%, rgba(0, 212, 255, 1) 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-align: left; /* Alineado a la izquierda dentro del header */
    flex: 1; /* Ocupa el espacio disponible */
    min-width: 200px; /* Asegura un ancho mínimo para el título */
}

/* --- Estilo específico para el subtítulo dentro del .chart-card .chart-header --- */
.chart-card .chart-header .chart-subtitle {
    font-size: 0.85rem;      /* Tamaño de fuente más pequeño */
    color: #64748b;         /* Color de texto secundario */
    margin: 3px 0 0 0;      /* Pequeño margen superior */
    text-align: left;       /* Alineado a la izquierda */
    font-style: italic;     /* Opcional: itálica para diferenciar */
    max-width: 100%;        /* Asegura que no se salga del contenedor */
    color: #475569;         /* Color ligeramente más oscuro para mejor contraste */
}

       .chart-card  .chart-container {
            position: relative;
            height: 500px;
            width: 100%;
        }

        .chart-card .legend-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

       .chart-card  .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

       .chart-card  .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .user-color {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        }

       .chart-card  .reference-color {
            background: linear-gradient(135deg, var(--secondary-color), #ff6b95);
        }

.chart-card .data-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            background-color: rgba(67, 97, 238, 0.05);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            position: relative;
            overflow: hidden;
        }

        .data-item.reference {
            background-color: rgba(247, 37, 133, 0.05);
            border-left-color: var(--secondary-color);
        }

        .data-label {
            font-weight: 500;
        }

        .data-value {
            font-weight: 600;
        }

        .category-badge {
            position: absolute;
            top: 0;
            right: 0;
            padding: 4px 8px;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 0 8px 0 8px;
            color: white;
        }

        .category-muy-bajo {
            background-color: var(--muy-bajo);
        }

        .category-bajo {
            background-color: var(--bajo);
        }

        .category-medio {
            background-color: var(--medio);
        }

        .category-alto {
            background-color: var(--alto);
        }

        .category-muy-alto {
            background-color: var(--muy-alto);
        }

        .category-legend {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .category-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chart-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .chart-container {
                height: 400px;
            }
            
            .data-summary {
                grid-template-columns: 1fr;
            }
        }       

/* Contenedor principal para resultados */
/* === INFORME DE EVALUACIÓN INICIAL - NUEVO DISEÑO PROFESIONAL === */
#resultadoDetallado {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    max-width: 850px;
    margin: 2rem auto;
    padding: 2.2rem;
    background: white;
    border-radius: 18px;
    box-shadow:
        0 10px 30px rgba(0, 0, 0, 0.08),
        0 4px 12px rgba(90, 146, 184, 0.12);
    line-height: 1.65;
    color: #2c3e50;
    border: 1px solid #e2e8f0;
    position: relative;
    overflow: hidden;
}

#resultadoDetallado::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: linear-gradient(90deg, #5a92b8, #096879, #00d4ff);
    z-index: 2;
}

/* === Títulos principales del informe === */
#resultadoDetallado h4 {
    font-weight: 700;
    font-size: 1.35rem;
    color: #1a365d;
    margin: 1.8rem 0 1.1rem 0;
    padding-bottom: 0.6rem;
    border-bottom: 2px solid #e2e8f0;
    position: relative;
}

/* === Evaluación de: [Nombre] - Encabezado principal === */
#resultadoDetallado h4:first-child {
    background: linear-gradient(2deg, rgba(90, 146, 184, 1) 0%, rgba(9, 104, 121, 1) 85%, rgba(0, 212, 255, 1) 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    margin-top: 0;
    padding: 0.8rem 0 0.8rem 0;
    border: none;
    font-size: 1.6rem;
    text-align: center;
    letter-spacing: -0.02em;
}

#resultadoDetallado h4:first-child::before {
    content: "📄 ";
}

/* === Resultados y Clasificaciones === */
#resultadoDetallado h4:nth-of-type(2) {
    background: linear-gradient(2deg, rgba(90, 146, 184, 1) 0%, rgba(9, 104, 121, 1) 85%, rgba(0, 212, 255, 1) 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    font-size: 1.5rem;
    text-align: center;
    margin-top: 2.2rem;
    padding-bottom: 0.8rem;
    border: none;
}

#resultadoDetallado h4:nth-of-type(2)::before {
    content: "📊 ";
}

/* === Items de resultados individuales (Resultados y Clasificaciones) === */
#resultadoDetallado h4:nth-of-type(2) ~ p {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.1rem 1.3rem;
    margin: 0.6rem 0;
    background: #f8fbff;
    border-radius: 14px;
    border: 1px solid #e6f0f7;
    transition: all 0.25s ease;
    box-shadow: 0 2px 6px rgba(90, 146, 184, 0.04);
}

#resultadoDetallado h4:nth-of-type(2) ~ p:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(90, 146, 184, 0.08);
    border-color: #cbd5e1;
}

#resultadoDetallado h4:nth-of-type(2) ~ p strong:first-child {
    color: #2d5a7a;
    font-weight: 600;
    font-size: 1.05rem;
    margin-right: 1rem; /* Espacio entre la prueba y el valor */
    flex-shrink: 0; /* Evita que el nombre de la prueba se encoja */
}

/* === Valor del resultado (número + unidad) - AHORA EN NEGRITA === */
#resultadoDetallado h4:nth-of-type(2) ~ p strong:last-child {
    color: #1e293b; /* Color neutro para el valor */
    font-weight: 700; /* ESTE CAMBIO LO HACE NEGRITA */
    font-size: 1.1rem;
    margin-right: auto; /* Empuja el badge hacia la derecha */
    padding-right: 1rem; /* Espacio antes del badge */
}

/* === Valoración General - Destacado === */
#resultadoDetallado h4:contains("Valoración General") {
    background: linear-gradient(135deg, #1e40af, #096879);
    color: white;
    margin-top: 2.5rem;
    padding: 1.4rem;
    border-radius: 16px;
    text-align: center;
    border: none;
    font-size: 1.5rem;
    box-shadow: 0 4px 15px rgba(9, 104, 121, 0.15);
}

/* === Párrafo de Valoración General: Contiene el badge === */
#resultadoDetallado h4:contains("Valoración General") + p {
    background: linear-gradient(135deg, #dbeafe, #f0f9ff);
    color: #1e3a8a;
    padding: 1.8rem !important;
    border-radius: 16px;
    margin-top: 0;
    border: 1px solid #bfdbfe;
    display: flex; /* Cambiado a flex para alinear el texto y el badge */
    justify-content: center; /* Centrado horizontal */
    align-items: center; /* Centrado vertical */
    gap: 1rem; /* Espacio entre el texto y el badge */
    font-size: 1.25rem;
    font-weight: 600;
    box-shadow: inset 0 0 0 1px rgba(90, 146, 184, 0.2);
}

/* === Estilo del texto dentro del párrafo de Valoración General === */
#resultadoDetallado h4:contains("Valoración General") + p strong {
    color: #1e3a8a;
    background: none !important;
    padding: 0 !important;
    font-size: 1.35rem;
    font-weight: 700;
    text-align: center;
}

/* === Responsive para Resultados y Clasificaciones === */
@media (max-width: 768px) {
    #resultadoDetallado h4:nth-of-type(2) ~ p {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }

    #resultadoDetallado h4:nth-of-type(2) ~ p strong:first-child {
        margin-right: 0;
    }

    #resultadoDetallado h4:nth-of-type(2) ~ p strong:last-child {
        padding-right: 0;
        align-self: stretch; /* Ocupa todo el ancho */
    }

    .categoria-badge {
        align-self: flex-end; /* Badge alineado a la derecha en la parte inferior */
    }

    /* Responsive para Valoración General */
    #resultadoDetallado h4:contains("Valoración General") + p {
        flex-direction: column;
        gap: 1rem;
    }
}
/* === Estilo para los badges de categoría en Resultados y Clasificaciones === */
.categoria-badge {
    display: inline-block;
    padding: 0.4rem 0.9rem;
    border-radius: 18px; /* Más redondeado */
    font-size: 0.85rem;
    font-weight: 600;
    color: white;
    text-align: center;
    min-width: 90px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    /* Aplica un degradado basado en el color base */
    background: linear-gradient(135deg, var(--badge-start), var(--badge-end));
}

/* Define variables CSS para cada categoría */
.categoria-badge.muy-bajo {
    --badge-start: #c0392b; /* Rojo más oscuro */
    --badge-end: #e74c3c;   /* Rojo estándar */
}
.categoria-badge.bajo {
    --badge-start: #d35400; /* Naranja más oscuro */
    --badge-end: #f39c12;   /* Naranja estándar */
}
.categoria-badge.promedio {
    --badge-start: #27ae60; /* Verde más oscuro */
    --badge-end: #8bc34a;   /* Verde estándar */
}
.categoria-badge.alto {
    --badge-start: #0288d1; /* Azul claro más oscuro */
    --badge-end: #81d4fa;   /* Azul claro estándar */
}
.categoria-badge.muy-alto {
    --badge-start: #1565c0; /* Azul fuerte más oscuro */
    --badge-end: #1e88e5;   /* Azul fuerte estándar */
}

.advice-box {
            background: llinear-gradient(90deg,rgba(228, 235, 235, 1) 0%, rgba(203, 212, 211, 1) 100%);
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 15px 0;
            border-radius: 14px;
			color: #072B2B;
        }
        .advice-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .score-box {
            display: inline-block;
            background: #eee;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-left: 10px;
        }


/*BOTONES*/

	/* Botón "Nuevo Test" - ya proporcionado */
#btnNuevoTest {
    background: linear-gradient(90deg, rgba(47, 125, 163, 1) 0%, rgba(9, 104, 121, 1) 91%, rgba(0, 212, 255, 1) 100%);
    color: white;
    border: none;
}
#btnNuevoTest:hover {
    background: linear-gradient(90deg, rgba(37, 100, 130, 1) 0%, rgba(7, 83, 97, 1) 91%, rgba(0, 180, 215, 1) 100%);
    color: white;
}

/* Botón "Limpiar Todo" - nuevo con gradiente acorde a su función (tonos de alerta/limpieza) */
#btnLimpiarTodo {
    background: linear-gradient(90deg, rgba(220, 53, 69, 1) 0%, rgba(180, 20, 40, 1) 90%, rgba(255, 90, 90, 1) 100%);
    color: white;
    border: none;
}
#btnLimpiarTodo:hover {
    background: linear-gradient(90deg, rgba(190, 40, 55, 1) 0%, rgba(150, 15, 30, 1) 90%, rgba(255, 120, 120, 1) 100%);
    color: white;
}

/* Botón "Imprimir Informe" - con el mismo gradiente que "Nuevo Test" */
#btnImprimirInforme {
    background: linear-gradient(90deg, rgba(47, 125, 163, 1) 0%, rgba(9, 104, 121, 1) 91%, rgba(0, 212, 255, 1) 100%);
    color: white;
    border: none;
}
#btnImprimirInforme:hover {
    background: linear-gradient(90deg, rgba(37, 100, 130, 1) 0%, rgba(7, 83, 97, 1) 91%, rgba(0, 180, 215, 1) 100%);
    color: white;
}
/* Botón "Imprimir Informe" - con el mismo gradiente que "Nuevo Test" */
#btnGenerarPDF {
    background: linear-gradient(90deg, rgba(47, 125, 163, 1) 0%, rgba(9, 104, 121, 1) 91%, rgba(0, 212, 255, 1) 100%);
    color: white;
    border: none;
}
#btnGenerarPDF:hover {
    background: linear-gradient(90deg, rgba(37, 100, 130, 1) 0%, rgba(7, 83, 97, 1) 91%, rgba(0, 180, 215, 1) 100%);
    color: white;
}

#btnGenerarPDF2 {
    background: linear-gradient(90deg, rgba(47, 125, 163, 1) 0%, rgba(9, 104, 121, 1) 91%, rgba(0, 212, 255, 1) 100%);
    color: white;
    border: none;
}
#btnGenerarPDF2:hover {
    background: linear-gradient(90deg, rgba(37, 100, 130, 1) 0%, rgba(7, 83, 97, 1) 91%, rgba(0, 180, 215, 1) 100%);
    color: white;
}

/* Botón "Exportar CSV" - con el mismo gradiente que "Nuevo Test" */
#btnexportcsv{
    
background: linear-gradient(90deg, rgba(105, 23, 105, 1) 0%, rgba(98, 29, 117, 1) 100%, rgba(245, 235, 235, 1) 100%);
    color: white;
    border: none;
}

/* Botón "Exportar CSV" - con el mismo gradiente que "Nuevo Test" */
#btnImportar{
    
background: linear-gradient(90deg, rgba(105, 23, 105, 1) 0%, rgba(98, 29, 117, 1) 100%, rgba(245, 235, 235, 1) 100%);
    color: white;
    border: none;
}

/* Botón "Descargar Modelo CSV" - con el mismo gradiente que "Nuevo Test" */
#btndescargar{
    
background: linear-gradient(90deg, rgba(105, 23, 105, 1) 0%, rgba(98, 29, 117, 1) 100%, rgba(245, 235, 235, 1) 100%);
    color: white;
    border: none;
}




/* Estilos para la lista de autocompletado */
.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-bottom: none;
  border-top: none;
  z-index: 99;
  /* Posición relativa al input */
  top: 100%;
  left: 0;
  right: 0;
  max-height: 200px;
  overflow-y: auto;
}

.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  background-color: #fff;
  border-bottom: 1px solid #d4d4d4;
}

.autocomplete-items div:hover {
  background-color: #e9e9e9;
}

.autocomplete-active {
  background-color: DodgerBlue !important;
  color: #ffffff;
}

/* MODAL*/
/* --- Estilo para el Modal de Selección de Usuario --- */
.modal {
    display: none; /* Oculto por defecto */
    position: fixed; /* Fijo en la pantalla */
    z-index: 1000; /* Siempre encima de otros elementos */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Fondo oscuro semitransparente */
    backdrop-filter: blur(4px); /* Opcional: efecto de vidrio */
}

.modal-content {
    background-color: white; /* Fondo blanco */
    margin: 15% auto; /* Centrado vertical y horizontal */
    padding: 20px;
    border: 1px solid #dee2e6; /* Borde suave */
    width: 80%;
    max-width: 600px;
    border-radius: 12px; /* Bordes redondeados */
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); /* Sombra */
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; /* Tipografía consistente */
    position: relative; /* Para el botón de cerrar */
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px; /* Espacio debajo del encabezado */
}

.modal-header h3 {
    margin: 0;
    color: #2c3e50; /* Color de texto oscuro */
    font-weight: 600;
    font-size: 1.4rem;
}

.close-modal {
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    color: #aaa; /* Color del botón de cerrar */
    background: none;
    border: none;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s ease;
}

.close-modal:hover {
    color: #333; /* Color al pasar el mouse */
    background-color: #f1f5f9; /* Fondo al pasar el mouse */
}

#filtroUsuarios {
    width: 100%;
    padding: 10px 15px;
    border: 2px solid #e2e8f0; /* Borde suave */
    border-radius: 8px; /* Bordes redondeados */
    font-size: 16px;
    margin-bottom: 15px; /* Espacio debajo del filtro */
    box-sizing: border-box; /* Incluye padding en el ancho */
    transition: border-color 0.3s ease;
}

#filtroUsuarios:focus {
    outline: none;
    border-color: #3498db; /* Color del borde al enfocar */
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); /* Sombra al enfocar */
}

#listaUsuarios {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e2e8f0; /* Borde suave */
    border-radius: 8px; /* Bordes redondeados */
    padding: 5px;
    background-color: #f8fafc; /* Fondo ligeramente grisáceo */
}

.lista-usuarios-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #e2e8f0; /* Separador entre items */
    transition: background-color 0.2s ease;
    color: #334155; /* Color de texto */
}

.lista-usuarios-item:last-child {
    border-bottom: none; /* Quitar borde del último item */
}

.lista-usuarios-item:hover {
    background-color: #e2e8f0; /* Color al pasar el mouse */
    color: #1e293b; /* Color de texto al pasar el mouse */
}

.lista-usuarios-item strong {
    color: #1e40af; /* Color para el ID */
    font-weight: 600;
}

/* Responsive */
@media (max-width: 768px) {
    .modal-content {
        margin: 20% auto;
        width: 95%;
        padding: 15px;
    }
    .modal-header h3 {
        font-size: 1.2rem;
    }
    #filtroUsuarios {
        padding: 8px 12px;
        font-size: 15px;
    }
    .lista-usuarios-item {
        padding: 8px 12px;
        font-size: 15px;
    }
}



/* --- Estilos para el Dashboard de Rendimiento --- */
:root {
    /* Asegúrate de que estas variables estén definidas en tu :root principal */
    --primary-color: #3498db;
    --secondary-color: #2ecc71;
    --accent-color: #e74c3c;
    --neutral-light: #f8f9fa;
    --neutral-dark: #343a40;
    --text-primary: #2c3e50;
    --text-secondary: #7f8c8d;
    --border-radius: 12px;
    --box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s ease;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
    margin-bottom: 30px;
}

@media (max-width: 1100px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
}

.card {
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    padding: 25px;
    transition: var(--transition);
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
}

.card-title {
    font-size: 1.4rem;
    color: var(--primary-color);
}

.card-actions {
    display: flex;
    gap: 10px;
}

.btn {
    padding: 8px 15px;
    border: none;
    border-radius: 6px;
    background-color: var(--neutral-light);
    color: var(--text-primary);
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
}

.btn:hover {
    background-color: var(--primary-color);
    color: white;
}

.btn.active {
    background-color: var(--primary-color);
    color: white;
}

.chart-container {
    position: relative;
    height: 400px; /* Ajusta según sea necesario */
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: 20px;
}

.metric-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 16px;
    padding: 15px;
    text-align: center;
    transition: var(--transition);
}

.metric-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
}

.metric-value {
    font-size: 1.2rem;
    font-weight: bold;
    margin: 10px 0;
}

.metric-title {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.metric-good {
    color: #27ae60;
}

.metric-average {
    color: #f39c12;
}

.metric-poor {
    color: #e74c3c;
}

.insights {
    margin-top: 30px;
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    padding: 25px;
}

.insights-title {
    font-size: 1.3rem;
    margin-bottom: 15px;
    color: var(--primary-color);
}

.insight-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px;
    border-left: 4px solid var(--secondary-color);
    background-color: #f8f9fa;
    margin-bottom: 10px;
    border-radius: 0 8px 8px 0;
}

.insight-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: var(--secondary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

/* Responsive */
@media (max-width: 768px) {
    .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
/* --- Estilo para las tarjetas de estadísticas generales --- */
.stat-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 10px;
    padding: 15px;
    text-align: center; /* Centrar todo el contenido de la tarjeta */
    transition: transform 0.2s ease, box-shadow 0.2s ease; /* Transición suave para hover */
    display: flex;
    flex-direction: column; /* Organizar elementos en columna */
    justify-content: center; /* Centrar verticalmente el contenido */
    align-items: center; /* Centrar horizontalmente el contenido */
    box-sizing: border-box; /* Incluir padding/border en el ancho */
}

.stat-card:hover {
    transform: translateY(-3px); /* Elevar ligeramente la tarjeta al pasar el mouse */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Aumentar la sombra al pasar el mouse */
}

/* --- Estilo para la etiqueta (e.g., "Total Evaluaciones") --- */
.stat-card h3 {
    margin: 0 0 10px 0; /* Eliminar margen superior, añadir margen inferior */
    padding: 0;
    font-size: 1.5rem; /* Tamaño de fuente para la etiqueta */
    font-weight: 600; /* Peso de fuente normal */
    color: #295a8a /* Color de texto gris para la etiqueta */
    flex-shrink: 0; /* Evitar que la etiqueta se encoja */
    text-align: center; /* Centrar el texto de la etiqueta */
}

/* --- Estilo para el valor (e.g., "50") --- */
.stat-card p {
    margin: 0; /* Eliminar márgenes */
    padding: 0;
    font-size: 1.8rem; /* Tamaño de fuente más grande para el valor */
    font-weight: bold; /* Peso de fuente en negrita para el valor */
    color: #212529; /* Color de texto más oscuro para el valor */
    flex-shrink: 0; /* Evitar que el valor se encoja */
    text-align: center; /* Centrar el texto del valor */
    line-height: 1.2; /* Altura de línea para mejor legibilidad */
}

/* --- Variaciones de color para el valor según el tipo de estadística (opcional) --- */
/* Puedes aplicar clases específicas a los <p> si deseas colores diferentes */
.stat-card.total-evaluaciones p { color: #2c3e50; } /* Azul muy oscuro para Total Evaluaciones */
.stat-card.hombres p { color: #3498db; } /* Azul para Hombres */
.stat-card.mujeres p { color: #e91e63; } /* Rosa para Mujeres */
.stat-card.edad-promedio p { color: #27ae60; } /* Verde para Edad Promedio */
.stat-card.imc-promedio p { color: #f39c12; } /* Naranja para IMC Promedio */
.stat-card.cardio-promedio p { color: #9b59b6; } /* Púrpura para Cardio Promedio */
.stat-card.salto-promedio p { color: #1abc9c; } /* Turquesa para Salto Promedio */
.stat-card.fuerza-promedio p { color: #e74c3c; } /* Rojo para Fuerza Promedio */
.stat-card.shuttle-promedio p { color: #34495e; } /* Gris azulado para Shuttle 4x10m Promedio */




/* CHART ESTADISTICAS */
/* --- Estilo específico para el contenedor del gráfico de distribución por edad y sexo --- */
/* Selecciona el div con id="EdadChart" que contiene el canvas con id="distribucionEdadChart" */
/* Esto es más específico que usar .chart-container:has(#distribucionEdadChart) */

#EdadChart {
    /* Aplicar estilo de tarjeta (.card del ejemplo) */
    background-color: var(--neutral-light); /* Fondo claro */
    border-radius: var(--border-radius); /* Bordes redondeados */
    box-shadow: var(--box-shadow); /* Sombra suave */
    padding: 25px; /* Padding consistente */
    margin-bottom: 30px; /* Margen inferior */
    transition: var(--transition); /* Transición para hover */
    position: relative; /* Necesario para elementos posicionados dentro */
    overflow: hidden; /* Evita desbordes */
    /* Asegurar que se comporte como un bloque */
    display: block;
    width: 100%;
    box-sizing: border-box; /* Incluir padding/border en el ancho */
}

/* Hover para el contenedor del gráfico (opcional, basado en el ejemplo) */
#EdadChart:hover {
    transform: translateY(-5px); /* Levantar ligeramente */
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); /* Sombra más pronunciada al hacer hover */
}

/* Canvas del gráfico de distribución por edad y sexo dentro de #EdadChart */
#distribucionEdadChart {
    border-radius: var(--border-radius); /* Bordes redondeados */
    background: white; /* Fondo blanco para el área del gráfico */
    padding: 10px; /* Padding interno */
    width: 100% !important;
    height: 390px !important; /* Ajustar la altura si es necesario */
    position: relative; /* Posición relativa para posibles tooltips */
    box-sizing: border-box; /* Incluir padding y border en el ancho/alto */
}

/* Estilos para encabezado, título, subtítulo (si los usas dentro del contenedor) */
/* Si usas .chart-header dentro de #EdadChart, puedes aplicar estilos aquí */
/*
#EdadChart .chart-header {
    margin-bottom: 15px;
}
#EdadChart .chart-header .chart-title {
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}
*/

/* Leyenda personalizada (opcional, si decides implementarla fuera del gráfico) */
#EdadChart .chartjs-legend {
    background: var(--neutral-light); /* Fondo claro */
    border: 1px solid rgba(0, 0, 0, 0.1); /* Borde sutil */
    border-radius: var(--border-radius); /* Bordes redondeados */
    padding: 15px; /* Padding interno */
    margin-top: 20px; /* Margen superior */
    box-shadow: var(--box-shadow); /* Sombra suave */
}

/* Tooltips específicos para este gráfico */
#EdadChart .chartjs-tooltip {
    background: #1f2937 !important; /* Fondo oscuro */
    border: 1px solid #374151 !important;
    border-radius: 6px !important;
    color: white !important;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); /* Sombra al tooltip */
    backdrop-filter: none; /* Quitar glassmorphism para consistencia */
    font-size: 0.75rem; /* Tamaño de fuente del tooltip */
}

/* Responsive */
@media (max-width: 768px) {
    #EdadChart {
        padding: 20px; /* Ajustar padding en móviles */
        margin-bottom: 25px; /* Ajustar margen en móviles */
    }
    #distribucionEdadChart {
        height: 390px !important; /* Ajustar altura en móviles */
    }
}
.legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem; /* Tamaño de fuente consistente */
    color: var(--text-secondary); /* Color de texto secundario */
}

.legend-color {
    width: 16px; /* Ancho del color */
    height: 16px; /* Alto del color */
    border-radius: 4px; /* Bordes redondeados */
}
/* Estilo para alinear los botones en la sección de Estadísticas */
    .estadisticas-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .estadisticas-buttons {
        display: flex;
        gap: 10px; /* Espacio entre botones */
        margin-left: auto; /* Empuja los botones hacia la derecha */
    }
	
	
	    /* ... (otros estilos) ... */

    /* Estilos para el Spinner */
    .spinner-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* Fondo semi-transparente */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999; /* Asegura que esté por encima de otros elementos */
    }

    .spinner {
        border: 8px solid #f3f3f3; /* Color del borde (fondo) */
        border-top: 8px solid #3498db; /* Color del borde superior (activo) */
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite; /* Animación de giro */
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .spinner-container p {
        color: white;
        margin-top: 20px;
        font-size: 18px;
        font-weight: bold;
    }



    /* Estilos para la vista de impresión de estadísticas */
    @media print {
        body {
            margin: 0;
            padding: 20px;
            background: white; /* Fondo blanco para impresión */
            color: black; /* Texto negro para impresión */
        }
        /* Ocultar todos los elementos excepto el contenedor de impresión */
        .container, .header, .nav-tabs, .tab-content:not(#estadisticas-imprimir-temp) {
            display: none !important;
        }
        /* Mostrar solo el contenedor temporal */
        #estadisticas-imprimir-temp {
            display: block !important;
            width: 100%;
            max-width: none; /* Eliminar restricciones de ancho */
            margin: 0;
            padding: 20px;
            box-shadow: none; /* Quitar sombras para impresión */
            border: none; /* Quitar bordes para impresión */
            background: white; /* Asegurar fondo blanco */
        }
        /* Ajustar estilos dentro del contenedor temporal para impresión */
        #estadisticas-imprimir-temp .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Ajustar ancho de tarjetas */
            gap: 15px; /* Reducir espacio */
            margin: 15px 0;
        }
        #estadisticas-imprimir-temp .stat-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px; /* Reducir bordes */
            padding: 10px; /* Reducir padding */
            page-break-inside: avoid; /* Evitar cortar tarjetas entre páginas */
        }
        #estadisticas-imprimir-temp .chart-container {
            margin: 20px 0;
            text-align: center;
            page-break-inside: avoid; /* Evitar cortar gráficos entre páginas */
        }
        #estadisticas-imprimir-temp .chart-container img {
            width: 100%;
            max-width: 600px; /* Limitar ancho máximo */
            height: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        #estadisticas-imprimir-temp .additional-sections {
            margin: 20px 0;
            padding: 10px; /* Reducir padding */
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            page-break-inside: avoid; /* Evitar cortar secciones entre páginas */
        }
        #estadisticas-imprimir-temp h2, #estadisticas-imprimir-temp h3, #estadisticas-imprimir-temp h4 {
            color: #2c3e50;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        #estadisticas-imprimir-temp ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        #estadisticas-imprimir-temp li {
            margin: 5px 0;
        }
    }


<style>
    /* ... tus estilos existentes ... */

    /* Estilos para la vista de impresión de estadísticas */
    @media print {
        body {
            margin: 0;
            padding: 20px;
            background: white; /* Fondo blanco para impresión */
            color: black; /* Texto negro para impresión */
        }
        /* Ocultar todos los elementos excepto el contenedor de impresión */
        .container, .header, .nav-tabs, .tab-content:not(#analisis-imprimir-temp) {
            display: none !important;
        }
        /* Mostrar solo el contenedor temporal */
        #analisis-imprimir-temp {
            display: block !important;
            width: 100%;
            max-width: none; /* Eliminar restricciones de ancho */
            margin: 0;
            padding: 20px;
            box-shadow: none; /* Quitar sombras para impresión */
            border: none; /* Quitar bordes para impresión */
            background: white; /* Asegurar fondo blanco */
        }
        /* Ajustar estilos dentro del contenedor temporal para impresión */
        #analisis-imprimir-temp .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Ajustar ancho de tarjetas */
            gap: 15px; /* Reducir espacio */
            margin: 15px 0;
        }
        #analisis-imprimir-temp .stat-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px; /* Reducir bordes */
            padding: 10px; /* Reducir padding */
            page-break-inside: avoid; /* Evitar cortar tarjetas entre páginas */
        }
        #analisis-imprimir-temp .chart-container {
            margin: 20px 0;
            text-align: center;
            page-break-inside: avoid; /* Evitar cortar gráficos entre páginas */
        }
        #analisis-imprimir-temp .chart-container img {
            width: 100%;
            max-width: 600px; /* Limitar ancho máximo */
            height: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        #analisis-imprimir-temp .additional-sections {
            margin: 20px 0;
            padding: 10px; /* Reducir padding */
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            page-break-inside: avoid; /* Evitar cortar secciones entre páginas */
        }
        #analisis-imprimir-temp h2, #analisis-imprimir-temp h3, #analisis-imprimir-temp h4 {
            color: #2c3e50;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        #analisis-imprimir-temp ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        #analisis-imprimir-temp li {
            margin: 5px 0;
        }
    }

    /* Estilos para la vista de impresión de análisis (nuevo) */
    @media print {
        /* Asegurar que el contenedor de análisis temporal también se muestre */
        #analisis-imprimir-temp {
            display: block !important;
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 20px;
            box-shadow: none;
            border: none;
            background: white;
        }
        /* Ocultar otros contenedores de impresión si existen */
        #estadisticas-imprimir-temp {
            display: none !important;
        }
        /* Ajustes específicos para análisis */
        #analisis-imprimir-temp .form-group {
            margin-bottom: 10px;
        }
        #analisis-imprimir-temp select {
            width: auto; /* Permitir que el select se ajuste al contenido */
        }
    }
</style>
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ALPHA Fitness Test Eurpeo- Valoracion CF Salud</h1>
            <p>Sistema de evaluación de condición física para niños y adolescentes</p>
        </div>
        <!--<div id="loginSection" class="login-section">
            <h2>Inicio de Sesión (Admin)</h2>
            <input type="password" id="adminPassword" placeholder="Contraseña de administrador">
            <button class="btn" onclick="loginAdmin()">Iniciar Sesión</button> 
        </div>-->
        <div id="mainContent"  class="block">
            <div class="nav-tabs">
                <button class="tab-btn active" onclick="showTab('registro')">Registro</button>
                <button class="tab-btn" onclick="showTab('resultados')">Resultados</button>
                <button class="tab-btn" onclick="showTab('estadisticas')">Estadísticas</button>
                <button class="tab-btn" onclick="showTab('analisis')">Análisis Detallado</button>
            </div>
            <!-- Pestaña de Registro -->
            <div id="registro" class="tab-content active">
				<div style="display: flex; justify-content: space-between; align-items: center;">
					<h2>Registro de Evaluación Física</h2>
					<div>
						<button id="btndescargar" class="btn btn-warning" onclick="descargarModeloCSV()">Descargar Modelo CSV</button>
						<button id="btnImportar" class="btn btn-warning" onclick="importardata()">Importar CSV</button>
						<button id="btnNuevoTest" class="btn btn-warning" onclick="resetFormularioYResultados()">Nuevo Test</button>
						<button id="btnLimpiarTodo" class="btn btn-danger" onclick="resetFormularioYResultados()">Limpiar Todo</button>
					</div>
				</div>
                <form id="fitnessForm">
                    <div class="form-group">
						<label>Nombre (ID):</label>
						<span id="contadorSiguienteID" style="font-size: 0.9em; color: #777; white-space: nowrap;"></span>
						<div style="display: flex; align-items: center; gap: 10px;">
						
							<input type="text" id="nombre" maxlength="30" placeholder="Opcional - Se generará ID automático si está vacío">
							
						</div>
					
						<div id="autocompleteList" class="autocomplete-items" style="display: none; position: absolute; border: 1px solid #d4d4d4; z-index: 99; background: #fff; max-height: 200px; overflow-y: auto; width: calc(100% - 22px); /* Ajusta al ancho del input - padding */"></div>
    
					</div>
                    <div class="form-group">
                        <label>Fecha de Nacimiento:</label>
                        <input type="date" id="fechaNacimiento" required>
                    </div>
                    <div class="form-group">
                        <label>Género:</label>
                        <select id="genero" required>
                            <option value="">Seleccionar</option>
                            <option value="masculino">Masculino</option>
                            <option value="femenino">Femenino</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha de Evaluación:</label>
                        <input type="date" id="fechaEvaluacion" required>
                    </div>
                    <div class="form-group">
                        <label>Altura (cm):</label>
                        <input type="number" id="altura" step="0.1" min="80" max="220" required>
                    </div>
                    <div class="form-group">
                        <label>Peso (kg):</label>
                        <input type="number" id="peso" step="0.1" min="8" max="200" required>
                    </div>
                    <div class="form-group">
                        <label>Perímetro de Cintura (cm):</label>
                        <input type="number" id="cintura" step="0.1" min="40" max="130" required>
                    </div>
                    <div class="form-group">
                        <label>Test de 20m (etapas):</label>
                        <input type="number" id="shuttle20m" step="0.5" min="0" max="21" required>
                    </div>
                    <div class="form-group">
                        <label>Salto Horizontal (cm):</label>
                        <input type="number" id="salto" min="15" max="330" required>
                    </div>
                    <div class="form-group">
                        <label>Fuerza de Presión Manual (kg):</label>
                        <input type="number" id="fuerza" step="0.1" min="0" max="80" required>
                    </div>
                    <div class="form-group">
                        <label>4x10m Shuttle Run (seg):</label>
                        <input type="number" id="shuttle4x10m" step="0.1" min="10" max="30" required>
                    </div>
                    <button type="submit" class="btn btn-success">Guardar Evaluación</button>
                </form>
            </div>
            <!-- Pestaña de Resultados -->
                <div id="resultados" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
						<h2>Resultados de Evaluación</h2>
						<button id="btnImprimirInforme" class="btn btn-info" onclick="generarPDFInforme()">Imprimir Informe</button>
					</div>
                    <div id="resultadosIndividuales" class="result-card">
                        <h3>Evaluación Individual</h3>
                        <div id="resultadoDetallado"></div>
                        <!-- Añadir este canvas para el gráfico de comparación -->
                        <div class="container">
						<div class="chart-card">
							<div class="chart-header">
								<div>
									<h2 class="chart-title">Comparación de Resultados ALPHA-Fitness</h2>
									<p class="chart-subtitle">Resultados del usuario vs. valores de referencia según el manual ALPHA-Fitness</p>
								</div>
							</div>
							<div class="chart-container">
								<canvas id="comparacionResultadosChart"></canvas>
							</div>
							<div class="legend-container">
								<div class="legend-item">
									<div class="legend-color user-color"></div>
									<span>Resultado del Usuario</span>
								</div>
								<div class="legend-item">
									<div class="legend-color reference-color"></div>
									<span>Valor de Referencia (Medio)</span>
								</div>
							</div>
							<div class="category-legend">
								<div class="category-legend-item category-muy-bajo">Muy Bajo</div>
								<div class="category-legend-item category-bajo">Bajo</div>
								<div class="category-legend-item category-medio">Medio</div>
								<div class="category-legend-item category-alto">Alto</div>
								<div class="category-legend-item category-muy-alto">Muy Alto</div>
							</div>
						</div>
					</div>
						
                        <div id="testResultsContainer"></div>
                        <div id="recomendaciones" class="recommendations"></div>
                        <div id="infoSalud" class="health-info"></div>
                    </div>
                </div>
            <!-- Pestaña de Estadísticas -->
            <div id="estadisticas" class="tab-content">
			<div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Estadísticas Generales</h2>
				<div style="display: flex; justify-content: space-between; align-items: center;">
				 <button id="btnGenerarPDF" class="btn btn-info" onclick="generarPDFEstadisticasV2()">Generar PDF Estadisticas</button>
                <button id="btnexportcsv" class="btn btn-warning" onclick="exportToCSV()">Exportar a CSV</button>
				</div>
				</div>
				
                <div class="stats-grid" id="statsGrid"></div>
				
				
				 
					
				<div style="display: flex; justify-content: left; align-items: center; padding: 0.3rem;">
					<header style="text-align: left; max-width: 800px; width: 100%;">
						<h2 style="color: #00000; font-weight: 700;">Resultados Generales por Edad y Sexo</h2>
						<p class="subtitle" style="color: #00000	; font-weight: normal; font-style: italic;">
							Análisis integral de métricas de por edad y genero
						</p>
					</header>
				</div>
		
				<div class="chart-container" id="EdadChart">
					<canvas id="distribucionEdadChart"></canvas>
				</div>
				<!-- Leyenda personalizada -->
				<div class="legend">
					<div class="legend-item">
						<div class="legend-color" style="background-color: rgba(76, 175, 80, 0.8);"></div>
						<span>Hombres - Muy Bajo</span>
					</div>
					<div class="legend-item">
						<div class="legend-color" style="background-color: rgba(255, 193, 7, 0.8);"></div>
						<span>Hombres - Bajo</span>
					</div>
					<div class="legend-item">
						<div class="legend-color" style="background-color: rgba(255, 152, 0, 0.8);"></div>
						<span>Hombres - Adecuado</span>
					</div>
					<div class="legend-item">
						<div class="legend-color" style="background-color: rgba(255, 87, 34, 0.8);"></div>
						<span>Hombres - Bueno</span>
					</div>
					<div class="legend-item">
						<div class="legend-color" style="background-color: rgba(244, 67, 54, 0.8);"></div>
						<span>Hombres - Excelente</span>
					</div>
					<div class="legend-item">
						<div class="legend-color" style="background-color: rgba(91, 141, 241, 0.8);"></div>
						<span>Mujeres - Muy Bajo</span>
					</div>
					<div class="legend-item">
						<div class="legend-color" style="background-color: rgba(58, 107, 199, 0.8);"></div>
						<span>Mujeres - Bajo</span>
					</div>
					<div class="legend-item">
						<div class="legend-color" style="background-color: rgba(42, 77, 158, 0.8);"></div>
						<span>Mujeres - Adecuado</span>
					</div>
					<div class="legend-item">
						<div class="legend-color" style="background-color: rgba(107, 82, 174, 0.8);"></div>
						<span>Mujeres - Bueno</span>
					</div>
					<div class="legend-item">
						<div class="legend-color" style="background-color: rgba(138, 62, 183, 0.8);"></div>
						<span>Mujeres - Excelente</span>
					</div>
				</div>

		<div style="display: flex; justify-content: left; align-items: center; padding: 0.5rem;">
			<header style="text-align: left; max-width: 800px; width: 100%;">
				<h2 style="color: #00000; font-weight: 700;">Panel de Rendimiento Físico </h2>
				<p class="subtitle" style="color: #00000; font-weight: normal; font-style: italic;">
					Análisis integral de métricas de condición física
				</p>
			</header>
		</div>

				<!-- NUEVA SECCIÓN: Dashboard de Rendimiento -->
				<div class="dashboard-grid">

					<div class="card">
						<div class="card-header">
							<h2 class="card-title">Rendimiento General</h2>
							<!-- Opcional: Botones de filtro como en el ejemplo -->
							
							<div class="card-actions">
								<button class="btn active" id="btnPromedio">Promedio</button>
								<button class="btn" id="btnHombres">Hombres</button>
								<button class="btn" id="btnMujeres">Mujeres</button>
							</div>
							
						</div>
						<div class="chart-container">
							<canvas id="rendimientoChart"></canvas> <!-- Reutilizamos el radar -->
						</div>
						<div class="metrics-grid">
							<div class="metric-card">
								<div class="metric-title">Puntuación General</div>
								<div class="metric-value metric-good" id="puntuacionGeneral">Calculando...</div>
								<div class="metric-title">Sobre 100</div>
							</div>
							<div class="metric-card">
								<div class="metric-title">Fortaleza Principal</div>
								<div class="metric-value" id="fortalezaPrincipal">Calculando...</div>
								<div class="metric-title">Área más desarrollada</div>
							</div>
							<div class="metric-card">
								<div class="metric-title">Área a Mejorar</div>
								<div class="metric-value" id="areaMejorar">Calculando...</div>
								<div class="metric-title">Necesita atención</div>
							</div>
						</div>
					</div>

					<div class="card">
						<div class="card-header">
							<h2 class="card-title">Distribución por Categorías</h2>
						</div>
						<div class="chart-container">
							<canvas id="categoriasChart"></canvas> <!-- Nuevo canvas para el gráfico de donut -->
						</div>
						<div class="metrics-grid">
							<div class="metric-card">
								<div class="metric-title">Mejor Categoría</div>
								<div class="metric-value metric-good" id="mejorCategoria">Calculando...</div>
								<div class="metric-title">Porcentaje de Testados</div>
							</div>
							<div class="metric-card">
								<div class="metric-title">Categoría Crítica</div>
								<div class="metric-value metric-poor" id="categoriaCritica">Calculando...</div>
								<div class="metric-title">Porcentaje de Testados</div>
							</div>
							<div class="metric-card">
								<div class="metric-title">Evaluaciones</div>
								<div class="metric-value" id="totalEvaluaciones">Calculando...</div>
								<div class="metric-title">Personas evaluadas</div>
							</div>
						</div>
					</div>
				</div>

				<!-- NUEVA SECCIÓN: Insights y Recomendaciones -->
				<div class="insights">
					<h2 class="insights-title">Insights y Recomendaciones</h2>
					<div id="insightsContainer">
						<!-- Aquí se insertarán los insights dinámicamente -->
					</div>
				</div>
				<!-- Fin de la nueva sección -->
            </div>
            <!-- Pestaña de Análisis -->
            <div id="analisis" class="tab-content">
			<div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Análisis Detallado</h2>
				<div style="display: flex; justify-content: space-between; align-items: center;">
				<button id="btnGenerarPDF2" class="btn btn-info" onclick="generarPDFAnalisisV3()">Generar PDF Analisis</button>
			</div>
			</div>
				
				
				
                <div class="form-group">
                    <label>Filtrar por Género:</label>
                    <select id="filtroGenero" onchange="actualizarAnalisis()">
                        <option value="todos">Todos</option>
                        <option value="masculino">Masculino</option>
                        <option value="femenino">Femenino</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="analisisEdadChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="comparacionGeneroChart"></canvas>
                </div>
            </div>
        </div>
    </div>
   <script>
    // Función para obtener la fecha actual en formato YYYY-MM-DD
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Los meses en JavaScript son base 0
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Establecer la fecha actual en el campo de fecha cuando la página se cargue
        window.onload = function() {
            const fechaEvaluacion = document.getElementById('fechaEvaluacion');
            fechaEvaluacion.value = getTodayDate();
        };
		
		
    // Inicializar Firebase
    const firebaseConfig = {
  apiKey: "AIzaSyChC7s5NN-z-dSjqeXDaks7gaNaVCJAu7Q",
  authDomain: "nutriplanv2.firebaseapp.com",
  
  projectId: "nutriplanv2",
  storageBucket: "nutriplanv2.firebasestorage.app",
  messagingSenderId: "653707489758",
  appId: "1:653707489758:web:9133d1d1620825c385ed4f",
  measurementId: "G-NWER69E8B6"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let evaluaciones = [];
    let distribucionEdadChart, rendimientoChart, analisisEdadChart, comparacionGeneroChart, comparacionResultadosChart;
	let categoriasChart;
    //let isAdmin = false;
    // Función de login
    //function loginAdmin() {
        //const password = document.getElementById('adminPassword').value;
        // Contraseña de ejemplo - en producción usar autenticación segura
        //if (password === 'admin123') {
            //isAdmin = true;
            //document.getElementById('loginSection').style.display = 'none';
//document.getElementById('mainContent').classList.remove('hidden');
            cargarEvaluaciones();
        //} else {
            //alert('Contraseña incorrecta');
        //}
   // }
        function generarID() {
    const idsNumericos = evaluaciones
        .map(e => e.nombre)
        .filter(n => n && /^\d{5}$/.test(n))
        .map(n => parseInt(n, 10))
        .filter(n => !isNaN(n));

    const ultimoID = idsNumericos.length > 0 
        ? Math.max(...idsNumericos) 
        : 0;

    return String(ultimoID + 1).padStart(5, '0');
}


   
   
   function calcularIMC(peso, altura) {
		const alturaM = altura / 100;
		const imc = peso / (alturaM * alturaM);
		return parseFloat(imc.toFixed(1));
	}
    // Cálculo de la clasificación de IMC según el documento
    function getClasificacionIMC(imc, genero, edad) {
        // Si la edad es menor a 13, usar los valores de 13
        const edadParaClasificacion = Math.max(edad, 13);
        const clasificaciones = {
            'masculino': {
                13: { muy_bajo_max: 16.7, bajo_max: 18.0, promedio_max: 22.2, alto_max: 25.7 },
                14: { muy_bajo_max: 17.5, bajo_max: 19.0, promedio_max: 23.3, alto_max: 26.5 },
                15: { muy_bajo_max: 17.9, bajo_max: 19.5, promedio_max: 23.8, alto_max: 26.7 },
                16: { muy_bajo_max: 18.0, bajo_max: 19.6, promedio_max: 23.7, alto_max: 26.4 },
                17: { muy_bajo_max: 19.0, bajo_max: 20.5, promedio_max: 24.6, alto_max: 27.5 }
            },
            'femenino': {
                13: { muy_bajo_max: 17.5, bajo_max: 19.0, promedio_max: 23.2, alto_max: 26.4 },
                14: { muy_bajo_max: 17.6, bajo_max: 18.9, promedio_max: 22.8, alto_max: 25.6 },
                15: { muy_bajo_max: 18.1, bajo_max: 19.4, promedio_max: 23.0, alto_max: 25.6 },
                16: { muy_bajo_max: 18.3, bajo_max: 19.6, promedio_max: 23.1, alto_max: 25.8 },
                17: { muy_bajo_max: 18.2, bajo_max: 19.5, promedio_max: 23.2, alto_max: 25.8 }
            }
        };

        if (!clasificaciones[genero] || !clasificaciones[genero][edadParaClasificacion]) {
            // Valor por defecto si no hay datos para la edad/género específicos
            return 'No clasificado';
        }
        const lim = clasificaciones[genero][edadParaClasificacion];
        if (imc <= lim.muy_bajo_max) return 'Muy Bajo';
        if (imc <= lim.bajo_max) return 'Bajo';
        if (imc <= lim.promedio_max) return 'Promedio';
        if (imc <= lim.alto_max) return 'Alto';
        return 'Muy Alto';
    }
    // Cálculo de la clasificación del perímetro de cintura
    function getClasificacionCintura(valor, genero, edad) {
        // Si la edad es menor a 13, usar los valores de 13
        const edadParaClasificacion = Math.max(edad, 13);
        const clasificaciones = {
            'masculino': {
                13: { muy_bajo_max: 62, bajo_max: 66, promedio_max: 78, alto_max: 87 },
                14: { muy_bajo_max: 65, bajo_max: 69, promedio_max: 80, alto_max: 88 },
                15: { muy_bajo_max: 67, bajo_max: 71, promedio_max: 81, alto_max: 89 },
                16: { muy_bajo_max: 67, bajo_max: 71, promedio_max: 81, alto_max: 88 },
                17: { muy_bajo_max: 70, bajo_max: 73, promedio_max: 83, alto_max: 91 }
            },
            'femenino': {
                13: { muy_bajo_max: 61, bajo_max: 65, promedio_max: 75, alto_max: 83 },
                14: { muy_bajo_max: 61, bajo_max: 64, promedio_max: 73, alto_max: 80 },
                15: { muy_bajo_max: 63, bajo_max: 66, promedio_max: 75, alto_max: 81 },
                16: { muy_bajo_max: 63, bajo_max: 66, promedio_max: 75, alto_max: 81 },
                17: { muy_bajo_max: 62, bajo_max: 65, promedio_max: 74, alto_max: 80 }
            }
        };

        if (!clasificaciones[genero] || !clasificaciones[genero][edadParaClasificacion]) {
            return 'No clasificado';
        }
        const lim = clasificaciones[genero][edadParaClasificacion];
        if (valor <= lim.muy_bajo_max) return 'Muy Bajo';
        if (valor <= lim.bajo_max) return 'Bajo';
        if (valor <= lim.promedio_max) return 'Promedio';
        if (valor <= lim.alto_max) return 'Alto';
        return 'Muy Alto';
    }
    // Cálculo de la clasificación del test de cardio
    function getClasificacionCardio(valor, genero, edad) {
        // Si la edad es menor a 13, usar los valores de 13
        const edadParaClasificacion = Math.max(edad, 13);
        const clasificaciones = {
            'masculino': {
                13: { muy_bajo_max: 3.0, bajo_max: 4.5, promedio_max: 6.0, alto_max: 7.5 },
                14: { muy_bajo_max: 3.5, bajo_max: 5.5, promedio_max: 6.5, alto_max: 8.5 },
                15: { muy_bajo_max: 4.0, bajo_max: 5.5, promedio_max: 7.0, alto_max: 8.5 },
                16: { muy_bajo_max: 4.0, bajo_max: 5.5, promedio_max: 7.0, alto_max: 8.5 },
                17: { muy_bajo_max: 4.5, bajo_max: 6.0, promedio_max: 7.5, alto_max: 9.0 }
            },
            'femenino': {
                13: { muy_bajo_max: 2.0, bajo_max: 2.5, promedio_max: 3.5, alto_max: 4.5 },
                14: { muy_bajo_max: 2.0, bajo_max: 3.0, promedio_max: 4.0, alto_max: 5.0 },
                15: { muy_bajo_max: 2.0, bajo_max: 3.0, promedio_max: 4.0, alto_max: 5.0 },
                16: { muy_bajo_max: 2.0, bajo_max: 3.0, promedio_max: 4.0, alto_max: 5.0 },
                17: { muy_bajo_max: 2.0, bajo_max: 3.0, promedio_max: 4.0, alto_max: 5.0 }
            }
        };

        if (!clasificaciones[genero] || !clasificaciones[genero][edadParaClasificacion]) {
            return 'No clasificado';
        }
        const lim = clasificaciones[genero][edadParaClasificacion];
        if (valor <= lim.muy_bajo_max) return 'Muy Bajo';
        if (valor <= lim.bajo_max) return 'Bajo';
        if (valor <= lim.promedio_max) return 'Promedio';
        if (valor <= lim.alto_max) return 'Alto';
        return 'Muy Alto';
    }
    // Cálculo de la clasificación de fuerza manual
    function getClasificacionFuerza(valor, genero, edad) {
        // Si la edad es menor a 13, usar los valores de 13
        const edadParaClasificacion = Math.max(edad, 13);
        const clasificaciones = {
            'masculino': {
                13: { muy_bajo_max: 21.4, bajo_max: 24.7, promedio_max: 27.8, alto_max: 31.8 },
                14: { muy_bajo_max: 26.3, bajo_max: 30.4, promedio_max: 34.0, alto_max: 38.5 },
                15: { muy_bajo_max: 31.3, bajo_max: 35.7, promedio_max: 39.7, alto_max: 44.3 },
                16: { muy_bajo_max: 35.9, bajo_max: 40.0, promedio_max: 43.7, alto_max: 48.1 },
                17: { muy_bajo_max: 39.9, bajo_max: 43.5, promedio_max: 46.7, alto_max: 50.6 }
            },
            'femenino': {
                13: { muy_bajo_max: 19.9, bajo_max: 22.5, promedio_max: 24.8, alto_max: 27.6 },
                14: { muy_bajo_max: 21.5, bajo_max: 24.1, promedio_max: 26.4, alto_max: 29.2 },
                15: { muy_bajo_max: 22.5, bajo_max: 25.1, promedio_max: 27.4, alto_max: 30.3 },
                16: { muy_bajo_max: 22.9, bajo_max: 25.4, promedio_max: 27.8, alto_max: 30.8 },
                17: { muy_bajo_max: 23.9, bajo_max: 26.4, promedio_max: 28.9, alto_max: 32.1 }
            }
        };

        if (!clasificaciones[genero] || !clasificaciones[genero][edadParaClasificacion]) {
            return 'No clasificado';
        }
        const lim = clasificaciones[genero][edadParaClasificacion];
        if (valor <= lim.muy_bajo_max) return 'Muy Bajo';
        if (valor <= lim.bajo_max) return 'Bajo';
        if (valor <= lim.promedio_max) return 'Promedio';
        if (valor <= lim.alto_max) return 'Alto';
        return 'Muy Alto';
    }
    // Cálculo de la clasificación del salto
    function getClasificacionSalto(valor, genero, edad) {
        // Si la edad es menor a 13, usar los valores de 13
        const edadParaClasificacion = Math.max(edad, 13);
        const clasificaciones = {
            'masculino': {
                13: { muy_bajo_max: 135, bajo_max: 152, promedio_max: 167, alto_max: 184 },
                14: { muy_bajo_max: 151, bajo_max: 169, promedio_max: 183, alto_max: 200 },
                15: { muy_bajo_max: 165, bajo_max: 182, promedio_max: 196, alto_max: 212 },
                16: { muy_bajo_max: 175, bajo_max: 192, promedio_max: 206, alto_max: 221 },
                17: { muy_bajo_max: 184, bajo_max: 201, promedio_max: 215, alto_max: 229 }
            },
            'femenino': {
                13: { muy_bajo_max: 118, bajo_max: 133, promedio_max: 147, alto_max: 163 },
                14: { muy_bajo_max: 121, bajo_max: 137, promedio_max: 151, alto_max: 167 },
                15: { muy_bajo_max: 123, bajo_max: 138, promedio_max: 151, alto_max: 167 },
                16: { muy_bajo_max: 126, bajo_max: 141, promedio_max: 154, alto_max: 169 },
                17: { muy_bajo_max: 129, bajo_max: 144, promedio_max: 157, alto_max: 172 }
            }
        };

        if (!clasificaciones[genero] || !clasificaciones[genero][edadParaClasificacion]) {
            return 'No clasificado';
        }
        const lim = clasificaciones[genero][edadParaClasificacion];
        if (valor <= lim.muy_bajo_max) return 'Muy Bajo';
        if (valor <= lim.bajo_max) return 'Bajo';
        if (valor <= lim.promedio_max) return 'Promedio';
        if (valor <= lim.alto_max) return 'Alto';
        return 'Muy Alto';
    }
    // Cálculo de la clasificación del shuttle 4x10m (menores tiempos son mejores)
    function getClasificacionShuttle4x10(valor, genero, edad) {
        // Si la edad es menor a 13, usar los valores de 13
        const edadParaClasificacion = Math.max(edad, 13);
        const clasificaciones = {
            'masculino': {
                13: { muy_bajo_min: 13.0, bajo_min: 12.3, promedio_min: 11.8, alto_min: 11.2 },
                14: { muy_bajo_min: 12.6, bajo_min: 11.9, promedio_min: 11.4, alto_min: 10.9 },
                15: { muy_bajo_min: 12.1, bajo_min: 11.5, promedio_min: 11.0, alto_min: 10.5 },
                16: { muy_bajo_min: 11.8, bajo_min: 11.1, promedio_min: 10.7, alto_min: 10.2 },
                17: { muy_bajo_min: 11.8, bajo_min: 11.1, promedio_min: 10.7, alto_min: 10.2 }
            },
            'femenino': {
                13: { muy_bajo_min: 13.9, bajo_min: 13.1, promedio_min: 12.5, alto_min: 11.9 },
                14: { muy_bajo_min: 13.8, bajo_min: 13.0, promedio_min: 12.4, alto_min: 11.8 },
                15: { muy_bajo_min: 13.7, bajo_min: 13.0, promedio_min: 12.4, alto_min: 11.8 },
                16: { muy_bajo_min: 13.6, bajo_min: 12.9, promedio_min: 12.3, alto_min: 11.7 },
                17: { muy_bajo_min: 13.5, bajo_min: 12.9, promedio_min: 12.4, alto_min: 11.8 }
            }
        };

        if (!clasificaciones[genero] || !clasificaciones[genero][edadParaClasificacion]) {
            return 'No clasificado';
        }
        const lim = clasificaciones[genero][edadParaClasificacion];
        if (valor >= lim.muy_bajo_min) return 'Muy Bajo';
        if (valor >= lim.bajo_min) return 'Bajo';
        if (valor >= lim.promedio_min) return 'Promedio';
        if (valor >= lim.alto_min) return 'Alto';
        return 'Muy Alto';
    }
    // Obtener edad a partir de fecha de nacimiento
    function getEdad(fechaNacimiento) {
        const nacimiento = new Date(fechaNacimiento);
        const hoy = new Date();
        let edad = hoy.getFullYear() - nacimiento.getFullYear();
        const mes = hoy.getMonth() - nacimiento.getMonth();
        if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
            edad--;
        }
        return edad;
    }
    // Función para obtener la edad de referencia (mínimo 13 años)
    function getEdadReferencia(edad) {
        return Math.max(edad, 13);
    }
    // Procesar y mostrar resultados
   // Procesar y mostrar resultados
   
function procesarResultados(datos) {
    const edad = getEdad(datos.fechaNacimiento);
    const edadRef = Math.max(edad, 13); // <-- NUEVO: mapear a 13 si es menor
    const imc = calcularIMC(datos.peso, datos.altura);
    const clasificacionIMC = getClasificacionIMC(imc, datos.genero, edadRef);
    const clasificacionCintura = getClasificacionCintura(datos.cintura, datos.genero, edadRef);
    const clasificacionCardio = getClasificacionCardio(datos.shuttle20m, datos.genero, edadRef);
    const clasificacionSalto = getClasificacionSalto(datos.salto, datos.genero, edadRef);
    const clasificacionFuerza = getClasificacionFuerza(datos.fuerza, datos.genero, edadRef);
    const clasificacionShuttle4x10 = getClasificacionShuttle4x10(datos.shuttle4x10m, datos.genero, edadRef);
	const clasificacionGeneral= evaluarEstadoFisico(clasificacionCardio, clasificacionSalto, clasificacionFuerza, clasificacionIMC);

		// Guardar los datos y la edadRef utilizados para generar los resultados
		window.datosParaImpresion = datos;
		window.edadRefParaImpresion = edadRef;

	   const resultado = `
        <h4>Evaluación de: ${datos.nombre}</h4>
        <p><strong>Edad: ${edad} años</strong></p>
        <p><strong>Género: ${datos.genero}</strong></p>
        <h4>Resultados y Clasificaciones:</h4>
        <p><strong>IMC:</strong> ${imc.toFixed(2)} <span class="categoria-badge ${getClassForCategoria(clasificacionIMC)}">${clasificacionIMC}</span></p>
        <p><strong>Perímetro de Cintura:</strong> ${datos.cintura} cm <span class="categoria-badge ${getClassForCategoria(clasificacionCintura)}">${clasificacionCintura}</span></p>
        <p><strong>Cardiorespiratorio:</strong> ${datos.shuttle20m} etapas <span class="categoria-badge ${getClassForCategoria(clasificacionCardio)}">${clasificacionCardio}</span></p>
        <p><strong>Salto Horizontal:</strong> ${datos.salto} cm <span class="categoria-badge ${getClassForCategoria(clasificacionSalto)}">${clasificacionSalto}</span></p>
        <p><strong>Fuerza Manual:</strong> ${datos.fuerza} kg <span class="categoria-badge ${getClassForCategoria(clasificacionFuerza)}">${clasificacionFuerza}</span></p>
        <p><strong>Shuttle 4x10m:</strong> ${datos.shuttle4x10m} s <span class="categoria-badge ${getClassForCategoria(clasificacionShuttle4x10)}">${clasificacionShuttle4x10}</span></p>
        <h4>Valoración General:</h4>
        <p><strong>Resultado Final:</strong>  <span class="categoria-badge ${getClassForCategoria(clasificacionGeneral)}">${clasificacionGeneral}</span></p>
    
    `;
    document.getElementById('resultadoDetallado').innerHTML = resultado;
    // Mostrar gráfico de comparación (usando edadRef)
    mostrarGraficoComparacion(datos, edadRef);
    mostrarRecomendaciones(datos, clasificacionCardio, clasificacionSalto, clasificacionFuerza, clasificacionIMC, clasificacionCintura, clasificacionShuttle4x10);
    mostrarInfoSalud(datos, clasificacionCardio, clasificacionSalto, clasificacionFuerza, clasificacionIMC, clasificacionCintura, clasificacionShuttle4x10);
    // Mostrar resultados detallados (usando edadRef)
    mostrarResultadosDetallados(datos, edadRef);
}

// Función auxiliar para mapear la categoría a la clase CSS del badge
function getClassForCategoria(categoria) {
    switch(categoria) {
        case 'Muy Bajo': return 'muy-bajo';
        case 'Bajo': return 'bajo';
        case 'Promedio': return 'promedio';
        case 'Alto': return 'alto';
        case 'Muy Alto': return 'muy-alto';
        default: return 'promedio'; // Clase por defecto si no coincide
    }
}

    // Mostrar resultados detallados con barras de progreso
    function mostrarResultadosDetallados(datos, edadRef) {
        const container = document.getElementById('testResultsContainer');
        container.innerHTML = '';
        const genero = datos.genero;
        // Test de 20m Shuttle Run
        const cardioResult = crearResultadoTest(
            '20-m Shuttle run',
            '20 metros de ida y vuelta',
            datos.shuttle20m,
            'etapas',
            genero,
            edadRef,
            'cardio'
        );
        container.appendChild(cardioResult);
        // Salto Horizontal
        const saltoResult = crearResultadoTest(
            'Standing long jump',
            'Salto de longitud a pies juntos',
            datos.salto,
            'cm',
            genero,
            edadRef,
            'salto'
        );
        container.appendChild(saltoResult);
        // Fuerza de prensión manual
        const fuerzaResult = crearResultadoTest(
            'Handgrip',
            'Fuerza de presión manual',
            datos.fuerza,
            'kg',
            genero,
            edadRef,
            'fuerza'
        );
        container.appendChild(fuerzaResult);
        // Perímetro de cintura
        const cinturaResult = crearResultadoTest(
            'Waist circumference',
            'Perímetro de cintura',
            datos.cintura,
            'cm',
            genero,
            edadRef,
            'cintura'
        );
        container.appendChild(cinturaResult);
        // IMC
        const imcResult = crearResultadoTest(
            'Body Mass Index',
            'Índice de Masa Corporal',
            calcularIMC(datos.peso, datos.altura),
            '',
            genero,
            edadRef,
            'imc'
        );
        container.appendChild(imcResult);
        // Shuttle 4x10m
        const shuttle4x10Result = crearResultadoTest(
            '4x10m shuttle run',
            'Test de velocidad/agilidad',
            datos.shuttle4x10m,
            'seg',
            genero,
            edadRef,
            'shuttle4x10'
        );
        container.appendChild(shuttle4x10Result);
    }
    // Crear elemento de resultado de test con escala visual precisa
function crearResultadoTest(nombre, descripcion, valor, unidad, genero, edad, tipo) {
    const div = document.createElement('div');
    div.className = 'test-result';
    // Información del test
    const infoDiv = document.createElement('div');
    infoDiv.className = 'test-info';
    const titulo = document.createElement('h4');
    titulo.textContent = nombre;
    infoDiv.appendChild(titulo);
    const desc = document.createElement('p');
    desc.textContent = descripcion;
    infoDiv.appendChild(desc);
    const valorDiv = document.createElement('div');
    valorDiv.className = 'test-value';
    valorDiv.innerHTML = `${valor} ${unidad}`;
    infoDiv.appendChild(valorDiv);
    // === Edad de referencia (mapear <13 a 13) ===
    const edadRef = Math.max(edad, 13);
    // === Obtener clasificación y límites reales ===
    let clasificacion = '';
    let limites = null;
    switch (tipo) {
        case 'cardio':
            clasificacion = getClasificacionCardio(valor, genero, edadRef);
            if (genero === 'masculino') {
                limites = { muy_bajo: 3.0, bajo: 4.5, promedio: 6.0, alto: 7.5, muy_alto: 9.0 };
                switch(edadRef) {
                    case 14: limites = { muy_bajo: 3.5, bajo: 5.5, promedio: 6.5, alto: 8.5, muy_alto: 9.0 }; break;
                    case 15: case 16: limites = { muy_bajo: 4.0, bajo: 5.5, promedio: 7.0, alto: 8.5, muy_alto: 9.0 }; break;
                    case 17: limites = { muy_bajo: 4.5, bajo: 6.0, promedio: 7.5, alto: 9.0, muy_alto: 9.5 }; break;
                }
            } else {
                limites = { muy_bajo: 2.0, bajo: 2.5, promedio: 3.5, alto: 4.5, muy_alto: 5.0 };
                switch(edadRef) {
                    case 14: case 15: case 16: case 17:
                        limites = { muy_bajo: 2.0, bajo: 3.0, promedio: 4.0, alto: 5.0, muy_alto: 5.5 }; break;
                }
            }
            break;
        case 'salto':
            clasificacion = getClasificacionSalto(valor, genero, edadRef);
            if (genero === 'masculino') {
                limites = { muy_bajo: 135, bajo: 152, promedio: 167, alto: 184, muy_alto: 185 };
                switch(edadRef) {
                    case 14: limites = { muy_bajo: 151, bajo: 169, promedio: 183, alto: 200, muy_alto: 201 }; break;
                    case 15: limites = { muy_bajo: 165, bajo: 182, promedio: 196, alto: 212, muy_alto: 213 }; break;
                    case 16: limites = { muy_bajo: 175, bajo: 192, promedio: 206, alto: 221, muy_alto: 222 }; break;
                    case 17: limites = { muy_bajo: 184, bajo: 201, promedio: 215, alto: 229, muy_alto: 230 }; break;
                }
            } else {
                limites = { muy_bajo: 118, bajo: 133, promedio: 147, alto: 163, muy_alto: 164 };
                switch(edadRef) {
                    case 14: limites = { muy_bajo: 121, bajo: 137, promedio: 151, alto: 167, muy_alto: 168 }; break;
                    case 15: limites = { muy_bajo: 123, bajo: 138, promedio: 151, alto: 167, muy_alto: 168 }; break;
                    case 16: limites = { muy_bajo: 126, bajo: 141, promedio: 154, alto: 169, muy_alto: 170 }; break;
                    case 17: limites = { muy_bajo: 129, bajo: 144, promedio: 157, alto: 172, muy_alto: 173 }; break;
                }
            }
            break;
        case 'fuerza':
            clasificacion = getClasificacionFuerza(valor, genero, edadRef);
            if (genero === 'masculino') {
                limites = { muy_bajo: 21.4, bajo: 24.7, promedio: 27.8, alto: 31.8, muy_alto: 31.9 };
                switch(edadRef) {
                    case 14: limites = { muy_bajo: 26.3, bajo: 30.4, promedio: 34.0, alto: 38.5, muy_alto: 38.6 }; break;
                    case 15: limites = { muy_bajo: 31.3, bajo: 35.7, promedio: 39.7, alto: 44.3, muy_alto: 44.4 }; break;
                    case 16: limites = { muy_bajo: 35.9, bajo: 40.0, promedio: 43.7, alto: 48.1, muy_alto: 48.2 }; break;
                    case 17: limites = { muy_bajo: 39.9, bajo: 43.5, promedio: 46.7, alto: 50.6, muy_alto: 50.7 }; break;
                }
            } else {
                limites = { muy_bajo: 19.9, bajo: 22.5, promedio: 24.8, alto: 27.6, muy_alto: 27.7 };
                switch(edadRef) {
                    case 14: limites = { muy_bajo: 21.5, bajo: 24.1, promedio: 26.4, alto: 29.2, muy_alto: 29.3 }; break;
                    case 15: limites = { muy_bajo: 22.5, bajo: 25.1, promedio: 27.4, alto: 30.3, muy_alto: 30.4 }; break;
                    case 16: limites = { muy_bajo: 22.9, bajo: 25.4, promedio: 27.8, alto: 30.8, muy_alto: 30.9 }; break;
                    case 17: limites = { muy_bajo: 23.9, bajo: 26.4, promedio: 28.9, alto: 32.1, muy_alto: 32.2 }; break;
                }
            }
            break;
        case 'cintura':
            clasificacion = getClasificacionCintura(valor, genero, edadRef);
            if (genero === 'masculino') {
                limites = { muy_bajo: 62, bajo: 66, promedio: 78, alto: 87, muy_alto: 88 };
                switch(edadRef) {
                    case 14: limites = { muy_bajo: 65, bajo: 69, promedio: 80, alto: 88, muy_alto: 89 }; break;
                    case 15: limites = { muy_bajo: 67, bajo: 71, promedio: 81, alto: 89, muy_alto: 90 }; break;
                    case 16: limites = { muy_bajo: 67, bajo: 71, promedio: 81, alto: 88, muy_alto: 88 }; break;
                    case 17: limites = { muy_bajo: 70, bajo: 73, promedio: 83, alto: 91, muy_alto: 92 }; break;
                }
            } else {
                limites = { muy_bajo: 61, bajo: 65, promedio: 75, alto: 83, muy_alto: 84 };
                switch(edadRef) {
                    case 14: limites = { muy_bajo: 61, bajo: 64, promedio: 73, alto: 80, muy_alto: 81 }; break;
                    case 15: case 16: limites = { muy_bajo: 63, bajo: 66, promedio: 75, alto: 81, muy_alto: 82 }; break;
                    case 17: limites = { muy_bajo: 62, bajo: 65, promedio: 74, alto: 80, muy_alto: 81 }; break;
                }
            }
            break;
        case 'imc':
            clasificacion = getClasificacionIMC(valor, genero, edadRef);
            if (genero === 'masculino') {
                limites = { muy_bajo: 16.7, bajo: 18.0, promedio: 22.2, alto: 25.7, muy_alto: 25.8 };
                switch(edadRef) {
                    case 14: limites = { muy_bajo: 17.5, bajo: 19.0, promedio: 23.3, alto: 26.5, muy_alto: 26.6 }; break;
                    case 15: limites = { muy_bajo: 17.9, bajo: 19.5, promedio: 23.8, alto: 26.7, muy_alto: 26.8 }; break;
                    case 16: limites = { muy_bajo: 18.0, bajo: 19.6, promedio: 23.7, alto: 26.4, muy_alto: 26.5 }; break;
                    case 17: limites = { muy_bajo: 19.0, bajo: 20.5, promedio: 24.6, alto: 27.5, muy_alto: 27.6 }; break;
                }
            } else {
                limites = { muy_bajo: 17.5, bajo: 19.0, promedio: 23.2, alto: 26.4, muy_alto: 26.5 };
                switch(edadRef) {
                    case 14: limites = { muy_bajo: 17.6, bajo: 18.9, promedio: 22.8, alto: 25.6, muy_alto: 25.7 }; break;
                    case 15: limites = { muy_bajo: 18.1, bajo: 19.4, promedio: 23.0, alto: 25.6, muy_alto: 25.7 }; break;
                    case 16: limites = { muy_bajo: 18.3, bajo: 19.6, promedio: 23.1, alto: 25.8, muy_alto: 25.9 }; break;
                    case 17: limites = { muy_bajo: 18.2, bajo: 19.5, promedio: 23.2, alto: 25.8, muy_alto: 25.9 }; break;
                }
            }
            break;
        case 'shuttle4x10':
            clasificacion = getClasificacionShuttle4x10(valor, genero, edadRef);
            if (genero === 'masculino') {
                limites = { muy_bajo: 13.0, bajo: 12.3, promedio: 11.8, alto: 11.2, muy_alto: 11.2 };
                switch(edadRef) {
                    case 14: limites = { muy_bajo: 12.6, bajo: 11.9, promedio: 11.4, alto: 10.9, muy_alto: 10.9 }; break;
                    case 15: limites = { muy_bajo: 12.1, bajo: 11.5, promedio: 11.0, alto: 10.5, muy_alto: 10.5 }; break;
                    case 16: case 17: limites = { muy_bajo: 11.8, bajo: 11.1, promedio: 10.7, alto: 10.2, muy_alto: 10.2 }; break;
                }
            } else {
                limites = { muy_bajo: 13.9, bajo: 13.1, promedio: 12.5, alto: 11.9, muy_alto: 11.9 };
                switch(edadRef) {
                    case 14: limites = { muy_bajo: 13.8, bajo: 13.0, promedio: 12.4, alto: 11.8, muy_alto: 11.8 }; break;
                    case 15: limites = { muy_bajo: 13.7, bajo: 13.0, promedio: 12.4, alto: 11.8, muy_alto: 11.8 }; break;
                    case 16: limites = { muy_bajo: 13.6, bajo: 12.9, promedio: 12.3, alto: 11.7, muy_alto: 11.7 }; break;
                    case 17: limites = { muy_bajo: 13.5, bajo: 12.9, promedio: 12.4, alto: 11.8, muy_alto: 11.8 }; break;
                }
            }
            break;
        default:
            clasificacion = 'No clasificado';
            limites = { muy_bajo: 0, bajo: 25, promedio: 50, alto: 75, muy_alto: 100 };
    }



// ... (dentro de crearResultadoTest, después de obtener limites y clasificacion)

// Badge y zone-indicator con lógica ajustada
// CORRECCIÓN: Incluir 'shuttle4x10' en la lógica de "menos es mejor"
const isMenorEsMejor = (tipo === 'cintura' || tipo === 'shuttle4x10'); // <-- Añadido 'shuttle4x10'
const isIMC = (tipo === 'imc'); // <-- Identificar IMC por separado

let claseBadgeMap = {
    'Muy Bajo': 'muy-bajo',
    'Bajo': 'bajo',
    'Promedio': 'promedio',
    'Alto': 'alto',
    'Muy Alto': 'muy-alto'
};

if (isMenorEsMejor) {
    if (tipo === 'shuttle4x10') {
         // Para shuttle4x10: "Alto" y "Muy Alto" (buen rendimiento) se visualizan como "bajo" (naranja)
         // "Bajo" y "Muy Bajo" (mal rendimiento) se visualizan como "Alto" y "Muy Alto" respectivamente
         claseBadgeMap = {
             'Muy Bajo': 'muy-alto', // Mal rendimiento -> muy alto visual
             'Bajo': 'alto',         // Mal rendimiento -> alto visual
             'Promedio': 'promedio', // Igual
             'Alto': 'bajo',         // Buen rendimiento -> bajo visual (naranja en imagen)
             'Muy Alto': 'bajo'      // Buen rendimiento -> bajo visual (naranja en imagen) -> CORREGIDO
         };
    } else { // cintura
         // Para tests donde "menos es mejor", invertir la clasificación visual
         claseBadgeMap = {
             'Muy Bajo': 'muy-alto', // El valor más bajo (mejor) se ve como "muy alto"
             'Bajo': 'alto',
             'Promedio': 'promedio',
             'Alto': 'bajo',
             'Muy Alto': 'muy-bajo' // El valor más alto (peor) se ve como "muy bajo"
         };
    }
} else if (isIMC) {
    // Para IMC, solo "Promedio" es bueno, los extremos son malos
    claseBadgeMap = {
        'Muy Bajo': 'muy-bajo', // Malo
        'Bajo': 'bajo',         // Malo
        'Promedio': 'promedio', // Bueno
        'Alto': 'bajo',         // Malo
        'Muy Alto': 'muy-bajo'  // Malo
    };
}
// Aplicar el mapeo para obtener la clase visual del badge
const claseBadge = claseBadgeMap[clasificacion] || 'muy-bajo';
const badge = document.createElement('span');
badge.className = `category-badge category-${claseBadge}`;
badge.textContent = clasificacion;
infoDiv.appendChild(badge);
div.appendChild(infoDiv);

// === Nueva Escala visual con flecha y etiquetas ===
const scaleDiv = document.createElement('div');
scaleDiv.className = 'test-scale';

// Crear contenedor para los segmentos
const progressSegments = document.createElement('div');
progressSegments.className = 'progress-segments';

// Calcular anchos reales de los segmentos basados en límites
const totalRango = limites.muy_alto - limites.muy_bajo;
const segmentWidths = [
    ((limites.bajo - limites.muy_bajo) / totalRango) * 100, // Muy Bajo
    ((limites.promedio - limites.bajo) / totalRango) * 100, // Bajo
    ((limites.alto - limites.promedio) / totalRango) * 100, // Promedio
    ((limites.muy_alto - limites.alto) / totalRango) * 100  // Alto (Muy Alto se maneja aparte si es necesario)
];

// Definir clases de colores para los segmentos
// La lógica de colores debe reflejar la calidad del rendimiento en la escala visual
let segmentClasses = ['muy-bajo', 'bajo', 'promedio', 'alto', 'muy-alto'];
if (isMenorEsMejor) {
    // Para tests "menos es mejor", el rango "muy_bajo" (numérico) es el mejor, por lo tanto, debe ser "muy-alto" visual
    // Invertir el orden de las clases de color
    segmentClasses = ['muy-alto', 'alto', 'promedio', 'bajo', 'muy-bajo'];
} else if (isIMC) {
    // Para IMC, "Promedio" es el mejor, los extremos son peores
    segmentClasses = ['muy-bajo', 'bajo', 'promedio', 'bajo', 'muy-bajo']; // Verde en el centro, rojo en extremos
}

// Crear cada segmento visual
segmentClasses.forEach((segClass, index) => {
    const segDiv = document.createElement('div');
    segDiv.className = `segment ${segClass}`;
    segDiv.style.width = `${segmentWidths[index] || 0}%`;
    segDiv.title = segClass; // Etiqueta interna (puede ser útil para tooltips)
    progressSegments.appendChild(segDiv);
});

// Añadir los segmentos a la barra
scaleDiv.appendChild(progressSegments);

// Crear contenedor para el indicador de flecha (puntero del usuario)
const arrowIndicator = document.createElement('div');
arrowIndicator.className = 'arrow-indicator';

const arrow = document.createElement('div');
arrow.className = 'arrow';

const arrowValue = document.createElement('div');
arrowValue.className = 'arrow-value';
arrowValue.textContent = `${valor.toFixed(1)}${unidad ? ' ' + unidad : ''}`; // Mostrar valor con unidad si existe

// CORRECCIÓN DE LÓGICA DE POSICIÓN DEL PUNTERO
let minReal = limites.muy_bajo;
let maxReal = limites.muy_alto;

// Ajustar minReal y maxReal para tests donde "menos es mejor"
// La escala visual debe mostrar el rango de valores, pero el puntero debe moverse opuestamente al valor numérico
// Por lo tanto, si el test es "menos es mejor", intercambiamos minReal y maxReal para la escala visual
if (isMenorEsMejor) {
     const temp = minReal;
     minReal = maxReal; // El mejor valor (numéricamente más bajo) ahora es el "mínimo" visual
     maxReal = temp;    // El peor valor (numérico más alto) ahora es el "máximo" visual
}

// Calcular posición exacta del puntero (0-100%)
// La fórmula (valor - minReal) / (maxReal - minReal) asume que minReal es el valor más bajo y maxReal el más alto
// Si isMenorEsMejor, minReal y maxReal ya están intercambiados, por lo que la fórmula funcionará correctamente
// para que un valor numérico más bajo (mejor) resulte en una posición más a la derecha (zona azul).
let posicion = ((valor - minReal) / (maxReal - minReal)) * 100;
// Asegurar que la posición esté entre 0% y 100%
posicion = Math.max(0, Math.min(100, posicion));

// Aplicar la posición al puntero
arrow.style.left = `${posicion}%`;
arrowValue.style.left = `${posicion}%`;

arrowIndicator.appendChild(arrow);
arrowIndicator.appendChild(arrowValue);
// Opcional: Añadir la línea
const arrowLine = document.createElement('div');
arrowLine.className = 'arrow-line';
arrowLine.style.left = `${posicion}%`;
arrowIndicator.appendChild(arrowLine);

// Añadir el indicador de flecha a la barra
scaleDiv.appendChild(arrowIndicator);

// Etiquetas debajo de la barra (límites de categoría)
const labelsDiv = document.createElement('div');
labelsDiv.className = 'segment-labels';

// Mostrar las etiquetas con los valores reales de los límites
labelsDiv.innerHTML = `
    <span class="segment-label">${limites.muy_bajo}</span>
    <span class="segment-label">${limites.bajo}</span>
    <span class="segment-label">${limites.promedio}</span>
    <span class="segment-label">${limites.alto}</span>
    <span class="segment-label">${limites.muy_alto}</span>
`;

// CORRECCIÓN: Para tests "menos es mejor", invertir el orden de las etiquetas visualmente
if (isMenorEsMejor) {
    const labels = labelsDiv.querySelectorAll('.segment-label');
    const labelsArray = Array.from(labels);
    labelsArray.reverse(); // Invierte el array
    labelsDiv.innerHTML = ''; // Limpia el contenedor
    labelsArray.forEach(label => labelsDiv.appendChild(label)); // Vuelve a añadirlos en orden invertido
}

scaleDiv.appendChild(labelsDiv);

// Añadir la barra de progreso al contenedor principal
div.appendChild(scaleDiv);

// Zona de salud (mantener el código existente para esta parte)
const zonaDiv = document.createElement('div');
zonaDiv.style.display = 'flex';
zonaDiv.style.alignItems = 'center';
zonaDiv.style.marginTop = '10px';
const zonaIndicator = document.createElement('div');
zonaIndicator.className = `zone-indicator zone-${claseBadge}`; // CORRECCIÓN: Usar claseBadge
const zonaText = document.createElement('span');
zonaText.textContent = `Categoría: ${clasificacion}`;

// CORRECCIÓN: Calcular el score basado en la clase visual del badge, no en la clasificación original
const scoreMap = { 'muy-bajo': 0, 'bajo': 25, 'promedio': 50, 'alto': 75, 'muy-alto': 100 };
const score = scoreMap[claseBadge] || 0; // Usar claseBadge en lugar de clasificacion

const scoreSpan = document.createElement('span');
scoreSpan.className = 'score-box';
scoreSpan.textContent = `${score} Puntos`;
zonaDiv.appendChild(zonaIndicator);
zonaDiv.appendChild(zonaText);
zonaDiv.appendChild(scoreSpan);
div.appendChild(zonaDiv);

// ... (resto del código para consejos sigue igual)
// ... (resto del código para consejos sigue igual)



    // Consejo
    const adviceDiv = document.createElement('div');
    adviceDiv.className = 'advice-box';
    const adviceTitle = document.createElement('div');
    adviceTitle.className = 'advice-title';
    adviceTitle.textContent = 'Consejo:';
    let adviceText = '';
    if (tipo === 'imc') {
        if (clasificacion === 'Muy Bajo' || clasificacion === 'Bajo') {
            adviceText = 'Tu IMC indica bajo peso. Asegúrate de tener una alimentación nutritiva y equilibrada para apoyar tu crecimiento. Consulta con un nutricionista para obtener consejos personalizados.';
        } else if (clasificacion === 'Promedio') {
            adviceText = 'Tu IMC está en un rango saludable. ¡Excelente! Continúa con hábitos alimenticios equilibrados y actividad física regular para mantenerlo.';
        } else {
            adviceText = 'Tu IMC sugiere sobrepeso u obesidad. Es recomendable consultar con un profesional de la salud para recibir orientación sobre dieta y ejercicio adaptados a ti.';
        }
    } else if (tipo === 'cintura') {
        if (clasificacion === 'Muy Alto' || clasificacion === 'Alto') {
            adviceText = 'Tu perímetro de cintura es alto, lo que puede indicar un mayor riesgo de problemas de salud. Considera mejorar tu dieta, reducir el consumo de azúcares y aumentar la actividad física. Habla con un profesional para un plan personalizado.';
        } else if (clasificacion === 'Promedio') {
            adviceText = 'Tu perímetro de cintura está en un rango saludable. Mantén un estilo de vida activo y una alimentación equilibrada para conservarlo.';
        } else {
            adviceText = 'Tu perímetro de cintura es bajo, lo cual es positivo para tu salud. Sigue con hábitos saludables para mantener estos buenos resultados.';
        }
    } else if (tipo === 'shuttle4x10') {
         if (clasificacion === 'Muy Bajo' || clasificacion === 'Bajo') {
             adviceText = 'Tu tiempo en el test de agilidad es alto (lento), lo que indica un área de mejora. Practicar ejercicios de velocidad y coordinación puede ayudarte a mejorar. Habla con tu profesor/a de Educación Física para sugerencias.';
         } else if (clasificacion === 'Promedio') {
             adviceText = 'Tu tiempo en el test de agilidad es adecuado. ¡Sigue practicando para mejorar aún más tu velocidad y coordinación!';
         } else {
             adviceText = '¡Excelente! Tu tiempo en el test de agilidad es bajo (rápido), lo cual es muy positivo. Sigue con actividades que desafíen tu velocidad y agilidad.';
         }
    } else { // Otros tests (cardio, salto, fuerza)
        if (clasificacion === 'Muy Bajo' || clasificacion === 'Bajo') {
            adviceText = 'Tu puntuación está en la zona de mejora. Es importante trabajar en este componente de la condición física. Habla con tu profesor/a de Educación Física para diseñar un plan de mejora personalizado.';
        } else if (clasificacion === 'Promedio') {
            adviceText = 'Tu puntuación es adecuada. ¡Sigue practicando actividades físicas regularmente para mantener y mejorar tu nivel!';
        } else {
            adviceText = '¡Excelente! Has obtenido una puntuación alta en este componente. Sigue así y considera retos más avanzados para seguir progresando.';
        }
    }
    const adviceContent = document.createElement('div');
    adviceContent.textContent = adviceText;
    adviceDiv.appendChild(adviceTitle);
    adviceDiv.appendChild(adviceContent);
    div.appendChild(adviceDiv);

    return div;
}
     // Valores de referencia según el manual ALPHA-Fitness
        const valoresReferencia = {
            masculino: {
                13: {
                    IMC: { muyBajo: [0, 16.7], bajo: [16.8, 18.0], medio: [18.1, 22.2], alto: [22.3, 25.7], muyAlto: [25.8, 100] },
                    cintura: { muyBajo: [0, 62], bajo: [63, 66], medio: [67, 78], alto: [79, 87], muyAlto: [88, 200] },
                    cardio: { muyBajo: [0, 3.0], bajo: [3.5, 4.5], medio: [5.0, 6.0], alto: [6.5, 7.5], muyAlto: [8.0, 100] },
                    salto: { muyBajo: [0, 135], bajo: [136, 152], medio: [153, 167], alto: [168, 184], muyAlto: [185, 300] },
                    fuerza: { muyBajo: [0, 21.4], bajo: [21.5, 24.7], medio: [24.8, 27.8], alto: [27.9, 31.8], muyAlto: [31.9, 100] },
                    shuttle4x10m: { muyBajo: [13.0, 100], bajo: [12.3, 12.9], medio: [11.8, 12.2], alto: [11.2, 11.7], muyAlto: [0, 11.1] }
                },
                14: {
                    IMC: { muyBajo: [0, 17.5], bajo: [17.6, 19.0], medio: [19.1, 23.3], alto: [23.4, 26.5], muyAlto: [26.6, 100] },
                    cintura: { muyBajo: [0, 65], bajo: [66, 69], medio: [70, 80], alto: [81, 88], muyAlto: [89, 200] },
                    cardio: { muyBajo: [0, 3.5], bajo: [4.0, 5.5], medio: [6.0, 6.5], alto: [7.0, 8.5], muyAlto: [9.0, 100] },
                    salto: { muyBajo: [0, 151], bajo: [152, 169], medio: [170, 183], alto: [184, 200], muyAlto: [201, 300] },
                    fuerza: { muyBajo: [0, 26.3], bajo: [26.4, 30.4], medio: [30.5, 34.0], alto: [34.1, 38.5], muyAlto: [38.6, 100] },
                    shuttle4x10m: { muyBajo: [12.6, 100], bajo: [11.9, 12.5], medio: [11.4, 11.8], alto: [10.9, 11.3], muyAlto: [0, 10.8] }
                },
                15: {
                    IMC: { muyBajo: [0, 17.9], bajo: [18.0, 19.5], medio: [19.6, 23.8], alto: [23.9, 26.7], muyAlto: [26.8, 100] },
                    cintura: { muyBajo: [0, 67], bajo: [68, 71], medio: [72, 81], alto: [82, 89], muyAlto: [90, 200] },
                    cardio: { muyBajo: [0, 4.0], bajo: [4.5, 5.5], medio: [6.0, 7.0], alto: [7.5, 8.5], muyAlto: [9.0, 100] },
                    salto: { muyBajo: [0, 165], bajo: [166, 182], medio: [183, 196], alto: [197, 212], muyAlto: [213, 300] },
                    fuerza: { muyBajo: [0, 31.3], bajo: [31.4, 35.7], medio: [35.8, 39.7], alto: [39.8, 44.3], muyAlto: [44.4, 100] },
                    shuttle4x10m: { muyBajo: [12.1, 100], bajo: [11.5, 12.0], medio: [11.0, 11.4], alto: [10.5, 10.9], muyAlto: [0, 10.4] }
                },
                16: {
                    IMC: { muyBajo: [0, 18.0], bajo: [18.1, 19.6], medio: [19.7, 23.7], alto: [23.8, 26.4], muyAlto: [26.5, 100] },
                    cintura: { muyBajo: [0, 67], bajo: [68, 71], medio: [72, 81], alto: [82, 88], muyAlto: [89, 200] },
                    cardio: { muyBajo: [0, 4.0], bajo: [4.5, 5.5], medio: [6.0, 7.0], alto: [7.5, 8.5], muyAlto: [9.0, 100] },
                    salto: { muyBajo: [0, 175], bajo: [176, 192], medio: [193, 206], alto: [207, 221], muyAlto: [222, 300] },
                    fuerza: { muyBajo: [0, 35.9], bajo: [36.0, 40.0], medio: [40.1, 43.7], alto: [43.8, 48.1], muyAlto: [48.2, 100] },
                    shuttle4x10m: { muyBajo: [11.8, 100], bajo: [11.1, 11.7], medio: [10.7, 11.0], alto: [10.2, 10.6], muyAlto: [0, 10.1] }
                },
                17: {
                    IMC: { muyBajo: [0, 19.0], bajo: [19.1, 20.5], medio: [20.6, 24.6], alto: [24.7, 27.5], muyAlto: [27.6, 100] },
                    cintura: { muyBajo: [0, 70], bajo: [71, 73], medio: [74, 83], alto: [84, 91], muyAlto: [92, 200] },
                    cardio: { muyBajo: [0, 4.5], bajo: [5.0, 6.0], medio: [6.5, 7.5], alto: [8.0, 9.0], muyAlto: [9.5, 100] },
                    salto: { muyBajo: [0, 184], bajo: [185, 201], medio: [202, 215], alto: [216, 229], muyAlto: [230, 300] },
                    fuerza: { muyBajo: [0, 39.9], bajo: [40.0, 43.5], medio: [43.6, 46.7], alto: [46.8, 50.6], muyAlto: [50.7, 100] },
                    shuttle4x10m: { muyBajo: [11.8, 100], bajo: [11.1, 11.7], medio: [10.7, 11.0], alto: [10.2, 10.6], muyAlto: [0, 10.1] }
                }
            },
            femenino: {
                13: {
                    IMC: { muyBajo: [0, 17.5], bajo: [17.6, 19.0], medio: [19.1, 23.2], alto: [23.3, 26.4], muyAlto: [26.5, 100] },
                    cintura: { muyBajo: [0, 61], bajo: [62, 65], medio: [66, 75], alto: [76, 83], muyAlto: [84, 200] },
                    cardio: { muyBajo: [0, 2.0], bajo: [2.5, 2.5], medio: [3.0, 3.5], alto: [4.0, 4.5], muyAlto: [5.0, 100] },
                    salto: { muyBajo: [0, 118], bajo: [119, 133], medio: [134, 147], alto: [148, 163], muyAlto: [164, 300] },
                    fuerza: { muyBajo: [0, 19.9], bajo: [20.0, 22.5], medio: [22.6, 24.8], alto: [24.9, 27.6], muyAlto: [27.7, 100] },
                    shuttle4x10m: { muyBajo: [13.9, 100], bajo: [13.1, 13.8], medio: [12.5, 13.0], alto: [11.9, 12.4], muyAlto: [0, 11.8] }
                },
                14: {
                    IMC: { muyBajo: [0, 17.6], bajo: [17.7, 18.9], medio: [19.0, 22.8], alto: [22.9, 25.6], muyAlto: [25.7, 100] },
                    cintura: { muyBajo: [0, 61], bajo: [62, 64], medio: [65, 73], alto: [74, 80], muyAlto: [81, 200] },
                    cardio: { muyBajo: [0, 2.0], bajo: [2.5, 3.0], medio: [3.5, 4.0], alto: [4.5, 5.0], muyAlto: [5.5, 100] },
                    salto: { muyBajo: [0, 121], bajo: [122, 137], medio: [138, 151], alto: [152, 167], muyAlto: [168, 300] },
                    fuerza: { muyBajo: [0, 21.5], bajo: [21.6, 24.1], medio: [24.2, 26.4], alto: [26.5, 29.2], muyAlto: [29.3, 100] },
                    shuttle4x10m: { muyBajo: [13.8, 100], bajo: [13.0, 13.7], medio: [12.4, 12.9], alto: [11.8, 12.3], muyAlto: [0, 11.7] }
                },
                15: {
                    IMC: { muyBajo: [0, 18.1], bajo: [18.2, 19.4], medio: [19.5, 23.0], alto: [23.1, 25.6], muyAlto: [25.7, 100] },
                    cintura: { muyBajo: [0, 63], bajo: [64, 66], medio: [67, 75], alto: [76, 81], muyAlto: [82, 200] },
                    cardio: { muyBajo: [0, 2.0], bajo: [2.5, 3.0], medio: [3.5, 4.0], alto: [4.5, 5.0], muyAlto: [5.5, 100] },
                    salto: { muyBajo: [0, 123], bajo: [124, 138], medio: [139, 151], alto: [152, 167], muyAlto: [168, 300] },
                    fuerza: { muyBajo: [0, 22.5], bajo: [22.6, 25.1], medio: [25.2, 27.4], alto: [27.5, 30.3], muyAlto: [30.4, 100] },
                    shuttle4x10m: { muyBajo: [13.7, 100], bajo: [13.0, 13.6], medio: [12.4, 12.9], alto: [11.8, 12.3], muyAlto: [0, 11.7] }
                },
                16: {
                    IMC: { muyBajo: [0, 18.3], bajo: [18.4, 19.6], medio: [19.7, 23.1], alto: [23.2, 25.8], muyAlto: [25.9, 100] },
                    cintura: { muyBajo: [0, 63], bajo: [64, 66], medio: [67, 75], alto: [76, 81], muyAlto: [82, 200] },
                    cardio: { muyBajo: [0, 2.0], bajo: [2.5, 3.0], medio: [3.5, 4.0], alto: [4.5, 5.0], muyAlto: [5.5, 100] },
                    salto: { muyBajo: [0, 126], bajo: [127, 141], medio: [142, 154], alto: [155, 169], muyAlto: [170, 300] },
                    fuerza: { muyBajo: [0, 22.9], bajo: [23.0, 25.4], medio: [25.5, 27.8], alto: [27.9, 30.8], muyAlto: [30.9, 100] },
                    shuttle4x10m: { muyBajo: [13.6, 100], bajo: [12.9, 13.5], medio: [12.3, 12.8], alto: [11.7, 12.2], muyAlto: [0, 11.6] }
                },
                17: {
                    IMC: { muyBajo: [0, 18.2], bajo: [18.3, 19.5], medio: [19.6, 23.2], alto: [23.3, 25.8], muyAlto: [25.9, 100] },
                    cintura: { muyBajo: [0, 62], bajo: [63, 65], medio: [66, 74], alto: [75, 80], muyAlto: [81, 200] },
                    cardio: { muyBajo: [0, 2.0], bajo: [2.5, 3.0], medio: [3.5, 4.0], alto: [4.5, 5.0], muyAlto: [5.5, 100] },
                    salto: { muyBajo: [0, 129], bajo: [130, 144], medio: [145, 157], alto: [158, 172], muyAlto: [173, 300] },
                    fuerza: { muyBajo: [0, 23.9], bajo: [24.0, 26.4], medio: [26.5, 28.9], alto: [29.0, 32.1], muyAlto: [32.2, 100] },
                    shuttle4x10m: { muyBajo: [13.5, 100], bajo: [12.9, 13.4], medio: [12.4, 12.8], alto: [11.8, 12.3], muyAlto: [0, 11.7] }
                }
            }
        };
        
        // Función para determinar la categoría según los valores de referencia del manual
        function determinarCategoria(valorUsuario, prueba, genero, edad) {
            const ref = valoresReferencia[genero][edad][prueba];
            
            // Para Shuttle 4x10m, valores más bajos son mejores (invertimos la lógica)
            if (prueba === 'shuttle4x10m') {
                if (valorUsuario >= ref.muyBajo[0] && valorUsuario <= ref.muyBajo[1]) return { categoria: 'Muy Bajo', color: 'category-muy-bajo' };
                if (valorUsuario >= ref.bajo[0] && valorUsuario <= ref.bajo[1]) return { categoria: 'Bajo', color: 'category-bajo' };
                if (valorUsuario >= ref.medio[0] && valorUsuario <= ref.medio[1]) return { categoria: 'Medio', color: 'category-medio' };
                if (valorUsuario >= ref.alto[0] && valorUsuario <= ref.alto[1]) return { categoria: 'Alto', color: 'category-alto' };
                if (valorUsuario >= ref.muyAlto[0] && valorUsuario <= ref.muyAlto[1]) return { categoria: 'Muy Alto', color: 'category-muy-alto' };
            } else {
                // Para las demás pruebas, valores más altos son mejores (excepto IMC y cintura)
                if (valorUsuario >= ref.muyBajo[0] && valorUsuario <= ref.muyBajo[1]) return { categoria: 'Muy Bajo', color: 'category-muy-bajo' };
                if (valorUsuario >= ref.bajo[0] && valorUsuario <= ref.bajo[1]) return { categoria: 'Bajo', color: 'category-bajo' };
                if (valorUsuario >= ref.medio[0] && valorUsuario <= ref.medio[1]) return { categoria: 'Medio', color: 'category-medio' };
                if (valorUsuario >= ref.alto[0] && valorUsuario <= ref.alto[1]) return { categoria: 'Alto', color: 'category-alto' };
                if (valorUsuario >= ref.muyAlto[0] && valorUsuario <= ref.muyAlto[1]) return { categoria: 'Muy Alto', color: 'category-muy-alto' };
            }
            
            return { categoria: 'Fuera de rango', color: 'category-medio' };
        }
        
        // Mostrar gráfico de comparación de resultados
        function mostrarGraficoComparacion(datos, edadRef) {
            const ctx = document.getElementById('comparacionResultadosChart').getContext('2d');
            //let comparacionResultadosChart = null;
            
            if (comparacionResultadosChart) comparacionResultadosChart.destroy();
            const genero = datos.genero;
            
            // Incluir shuttle4x10m en los resultados
            const resultados = [
                calcularIMC(datos.peso, datos.altura),
                datos.cintura,
                datos.shuttle20m,
                datos.salto,
                datos.fuerza,
                datos.shuttle4x10m
            ];
            
            // Obtener valores de referencia para la edad y género
            const valoresRef = [
                (valoresReferencia[genero][edadRef].IMC.medio[0] + valoresReferencia[genero][edadRef].IMC.medio[1]) / 2,
                (valoresReferencia[genero][edadRef].cintura.medio[0] + valoresReferencia[genero][edadRef].cintura.medio[1]) / 2,
                (valoresReferencia[genero][edadRef].cardio.medio[0] + valoresReferencia[genero][edadRef].cardio.medio[1]) / 2,
                (valoresReferencia[genero][edadRef].salto.medio[0] + valoresReferencia[genero][edadRef].salto.medio[1]) / 2,
                (valoresReferencia[genero][edadRef].fuerza.medio[0] + valoresReferencia[genero][edadRef].fuerza.medio[1]) / 2,
                (valoresReferencia[genero][edadRef].shuttle4x10m.medio[0] + valoresReferencia[genero][edadRef].shuttle4x10m.medio[1]) / 2
            ];
            
            // Determinar categorías para cada resultado
            const categorias = [
                determinarCategoria(resultados[0], 'IMC', genero, edadRef),
                determinarCategoria(resultados[1], 'cintura', genero, edadRef),
                determinarCategoria(resultados[2], 'cardio', genero, edadRef),
                determinarCategoria(resultados[3], 'salto', genero, edadRef),
                determinarCategoria(resultados[4], 'fuerza', genero, edadRef),
                determinarCategoria(resultados[5], 'shuttle4x10m', genero, edadRef)
            ];
            
            comparacionResultadosChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [
                        'IMC (kg/m²)',
                        'Perímetro Cintura (cm)',
                        'Cardiorespiratorio (niveles)',
                        'Salto Horizontal (cm)',
                        'Fuerza Manual (kg)',
                        'Shuttle 4x10m (s)'
                    ],
                    datasets: [
                        {
                            label: 'Resultado del Usuario',
                            data: resultados,
                            backgroundColor: 'rgba(67, 97, 238, 0.7)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 1,
                            borderRadius: 6,
                            borderSkipped: false,
                        },
                        {
                            label: 'Valor de Referencia (Medio)',
                            data: valoresRef,
                            backgroundColor: 'rgba(247, 37, 133, 0.7)',
                            borderColor: 'rgba(247, 37, 133, 1)',
                            borderWidth: 1,
                            borderRadius: 6,
                            borderSkipped: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Comparación para ${genero === 'masculino' ? 'varón' : 'mujer'} de ${edadRef} años - ALPHA-Fitness`,
                            font: {
                                size: 16,
                                weight: '600'
                            },
                            padding: {
                                bottom: 20
                            }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#212529',
                            bodyColor: '#6c757d',
                            borderColor: 'rgba(0, 0, 0, 0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2);
                                        // Añadir unidades según la métrica
                                        const index = context.dataIndex;
                                        if (index === 0) label += ' kg/m²';
                                        else if (index === 1) label += ' cm';
                                        else if (index === 2) label += ' niveles';
                                        else if (index === 3) label += ' cm';
                                        else if (index === 4) label += ' kg';
                                        else if (index === 5) label += ' s';
                                    }
                                    return label;
                                },
                                afterLabel: function(context) {
                                    // Mostrar categoría solo para el dataset del usuario
                                    if (context.datasetIndex === 0) {
                                        return `Categoría: ${categorias[context.dataIndex].categoria}`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                },
                plugins: [{
                    id: 'datalabels',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        const meta = chart.getDatasetMeta(0);
                        
                        meta.data.forEach((bar, index) => {
                            const valor = chart.data.datasets[0].data[index];
                            const categoria = categorias[index];
                            
                            // Posicionamiento del texto
                            const x = bar.x;
                            const y = bar.y - 10;
                            
                            // Configuración del texto
                            ctx.font = 'bold 12px sans-serif';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';
                            ctx.fillStyle = '#212529';
                            
                            // Dibujar el valor
                            ctx.fillText(valor.toFixed(2), x, y);
                            
                            // Dibujar la categoría
                            ctx.font = 'bold 10px sans-serif';
                            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue(`--${categoria.color.replace('category-', '')}`);
                            ctx.fillText(categoria.categoria, x, y + 15);
                        });
                    }
                }]
            });
        }
        
      
		
		
		
		
		
    // Mostrar recomendaciones
    function mostrarRecomendaciones(datos, cardio, salto, fuerza, imc, cintura, shuttle4x10) {
        let recomendaciones = '<h4>Recomendaciones:</h4><ul>';
        if (cardio.includes('Muy Bajo') || cardio.includes('Bajo')) {
            recomendaciones += '<li><strong>Capacidad Cardiorespiratoria:</strong> Realizar actividades aeróbicas como correr, nadar o andar en bicicleta 3-4 veces por semana para mejorar la resistencia cardiovascular. Un bajo nivel de capacidad aeróbica es un predictor independiente del desarrollo futuro de síndrome metabólico, diabetes tipo 2 y enfermedades cardiovasculares. Mejorar la capacidad cardiorrespiratoria te permitirá mantenerte activo todo el día sin cansarte demasiado, disfrutar más de juegos y deportes con amigos y alcanzar metas deportivas que te importan.</li>';
        }
        if (salto.includes('Muy Bajo') || salto.includes('Bajo')) {
            recomendaciones += '<li><strong>Potencia Muscular:</strong> Practicar ejercicios de salto y plyometría para mejorar la fuerza explosiva de las piernas. La fuerza muscular está asociada inversamente con factores de riesgo cardiovascular y dolor lumbar. Mejorar la potencia muscular te ayudará en actividades diarias como subir escaleras, correr o jugar deportes, fortalecerá huesos y músculos, y mejorará tu salud general.</li>';
        }
        if (fuerza.includes('Muy Bajo') || fuerza.includes('Bajo')) {
            recomendaciones += '<li><strong>Fuerza Muscular:</strong> Incluir ejercicios de fuerza con peso corporal como flexiones, dominadas y agarres para mejorar la fuerza de brazos y manos. La fuerza muscular está asociada con mejor salud cardiovascular y menor mortalidad. Entrenar fuerza regularmente te ayudará a realizar actividades de vida diaria con mayor facilidad, mejorarás el desarrollo de habilidades motrices, aumentarás tu rendimiento deportivo y evitarás lesiones.</li>';
        }
        if (imc.includes('Muy Alto') || imc.includes('Alto') || cintura.includes('Muy Alto') || cintura.includes('Alto')) {
            recomendaciones += '<li><strong>Composición Corporal:</strong> Mantener una dieta equilibrada y aumentar la actividad física para lograr un peso saludable. El IMC elevado junto con el perímetro de cintura indican mayor riesgo cardiometabólico. Para mejorar la composición corporal, se recomienda fijar metas realistas y pequeñas, quemar más calorías con actividad física (hacer al menos 1 hora diaria de actividad física variada), comer menos calorías y seguir una dieta saludable, reducir el tiempo frente a pantallas y dormir lo suficiente.</li>';
        }
        if (imc.includes('Muy Bajo') || imc.includes('Bajo')) {
            recomendaciones += '<li><strong>Composición Corporal:</strong> Consultar con un nutricionista para asegurar una nutrición adecuada y un crecimiento saludable.</li>';
        }
        if (shuttle4x10.includes('Muy Bajo') || shuttle4x10.includes('Bajo')) {
            recomendaciones += '<li><strong>Velocidad/Agilidad:</strong> Mejorar la velocidad y agilidad a través de ejercicios de coordinación y desplazamiento. Las mejoras en velocidad/agilidad tienen un efecto positivo en la salud esquelética. Se recomienda combinar actividades divertidas y sociales, incorporar actividad en la rutina diaria y practicar entrenamientos que incluyan intervalos de alta intensidad.</li>';
        }
        recomendaciones += '</ul>';
        document.getElementById('recomendaciones').innerHTML = recomendaciones;
    }
    // Mostrar información sobre salud
    function mostrarInfoSalud(datos, cardio, salto, fuerza, imc, cintura, shuttle4x10) {
        const info = `
            <h4>Importancia de los Tests para la Salud:</h4>
            <p><strong>Importancia General:</strong> Un bajo fitness se asocia con una peor salud cardiovascular, con una peor salud ósea y una mayor probabilidad de una enfermedad incapacitante en el futuro (Henriksson et al., 2019). Cálculos recientes revelan que los costes sanitarios directos de la inactividad física en Europa ascienden a 11.685 millones de euros al año, y que se pierden otros 3.795 millones de euros debido a la disminución de la productividad (Ding et al., 2016). La condición física es un marcador muy importante relacionado con la salud a lo largo de la vida (García-Hermoso et al., 2019). Conseguir un alto nivel de condición física es beneficioso para la salud física y mental, así como para la salud cerebral (Ortega et al., 2008).</p>
            <p><strong>Test de Resistencia Cardiorespiratoria:</strong> La capacidad aeróbica está fuertemente asociada con una mejor salud cardiovascular actual y futura. Niveles bajos se relacionan con riesgo aumentado de enfermedades cardiovasculares, síndrome metabólico y diabetes tipo 2. La condición física es la capacidad de llevar a cabo las tareas diarias con vigor y agilidad, sin fatiga y con energía suficiente para disfrutar de las actividades de ocio y para hacer frente a emergencias inesperadas (Clarke, 1979).</p>
            <p><strong>Test de Salto Horizontal:</strong> Mide la fuerza explosiva de las piernas, importante para la salud ósea y muscular. La fuerza muscular está inversamente asociada con factores de riesgo cardiovascular y dolor lumbar. La potencia muscular se define como la capacidad de generar fuerza rápidamente, y mejorarla requiere entrenamiento progresivo, técnica correcta y velocidad en los movimientos.</p>
            <p><strong>Test de Fuerza de Prehensión Manual:</strong> Indicador de la fuerza general y salud muscular. Se ha relacionado con mejores resultados en salud cardiovascular y menor mortalidad por todas las causas. La fuerza muscular es la capacidad de ejercer fuerza o resistir una resistencia externa, y entrenarla regularmente mejora la capacidad de realizar actividades de vida diaria.</p>
            <p><strong>Índice de Masa Corporal (IMC) y Perímetro de Cintura:</strong> Indicadores de composición corporal. El IMC es útil pero el perímetro de cintura es un marcador directo de grasa visceral, que es metabólicamente activa y se asocia con inflamación sistémica y resistencia a la insulina. La composición corporal está estrechamente relacionada con el rendimiento físico y la salud.</p>
            <p><strong>Test de Shuttle 4x10m:</strong> Evalúa velocidad, agilidad y coordinación, aspectos importantes para la salud esquelética. Las mejoras en velocidad/agilidad parecen tener un efecto positivo en la salud esquelética. Este test mide la capacidad de cambiar de dirección rápidamente, lo cual es importante para prevenir lesiones y mejorar el rendimiento deportivo.</p>
            <p><strong>Proyecto ALPHA:</strong> En 2003, la Comisión Europea financió el proyecto ALPHA con el objetivo de disponer de una batería de test válida y fiable para medir la condición física de forma armonizada internacionalmente. La batería final recomendaba el test de carrera de ida y vuelta de 20m, los tests de prensión manual y salto de longitud, y el IMC y perímetro de cintura como indicadores de obesidad total y central.</p>
        `;
        document.getElementById('infoSalud').innerHTML = info;
    }
    // Evaluar estado físico general
    function evaluarEstadoFisico(cardio, salto, fuerza, imc) {
        const clasificaciones = [cardio, salto, fuerza, imc];
        let muyBajo = 0, bajo = 0, promedio = 0, alto = 0, muyAlto = 0;
        clasificaciones.forEach(cat => {
            if (cat.includes('Muy Bajo')) muyBajo++;
            else if (cat.includes('Bajo')) bajo++;
            else if (cat.includes('Promedio')) promedio++;
            else if (cat.includes('Alto')) alto++;
            else if (cat.includes('Muy Alto')) muyAlto++;
        });

        if (muyBajo >= 2) return 'Muy Deficiente';
        if (muyBajo + bajo >= 3) return 'Deficiente';
        if (muyAlto + alto >= 3) return 'Excelente';
        if (muyAlto + alto >= 2) return 'Bueno';
        return 'Adecuado';
    }
	
    // Cargar evaluaciones desde Firestore
    async function cargarEvaluaciones() {
    try {
        const snapshot = await db.collection('evaluaciones').get();
        evaluaciones = [];
        snapshot.forEach(doc => {
            evaluaciones.push({ id: doc.id, ...doc.data() });
        });
        // --- AÑADIR ESTA LÍNEA ---
        actualizarContadorSiguienteID();
        // --------------------------
    } catch (error) {
        console.error("Error al cargar evaluaciones: ", error);
    }
}
    // Guardar evaluación en Firestore
    document.getElementById('fitnessForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        // Obtener el nombre o generar ID
        let nombre = document.getElementById('nombre').value.trim();
        if (!nombre) {
            nombre = generarID();
        }
        const datos = {
            nombre: nombre,
            fechaNacimiento: document.getElementById('fechaNacimiento').value,
            genero: document.getElementById('genero').value,
            fechaEvaluacion: document.getElementById('fechaEvaluacion').value,
            altura: parseFloat(document.getElementById('altura').value),
            peso: parseFloat(document.getElementById('peso').value),
            cintura: parseFloat(document.getElementById('cintura').value),
            shuttle20m: parseFloat(document.getElementById('shuttle20m').value),
            salto: parseInt(document.getElementById('salto').value),
            fuerza: parseFloat(document.getElementById('fuerza').value),
            shuttle4x10m: parseFloat(document.getElementById('shuttle4x10m').value)
        };
        try {
            const docRef = await db.collection('evaluaciones').add(datos);
            datos.id = docRef.id;
            evaluaciones.push(datos);
            procesarResultados(datos);
            alert(`Evaluación registrada exitosamente! ID: ${nombre}`);
			actualizarContadorSiguienteID();
        } catch (error) {
            console.error("Error al guardar evaluación: ", error);
            alert('Error al guardar la evaluación');
        }
    });
    function showTab(tabId) {
			// Verificar si se intenta ir a la pestaña de resultados
			if (tabId === 'resultados') {
				if (!esFormularioRegistroCompleto()) {
					alert('Por favor, completa todos los campos obligatorios en la pestaña de Registro antes de ver los resultados.');
					return; // Detener la ejecución de showTab para no cambiar a 'resultados'
				}
			}

			// Cambiar pestaña
			document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
			document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
			document.getElementById(tabId).classList.add('active');

			// Encontrar y activar el botón correspondiente
			// Buscar el botón que tiene onclick="showTab('...')"
			const clickedButton = Array.from(document.querySelectorAll('.tab-btn')).find(
				btn => btn.getAttribute('onclick') === `showTab('${tabId}')`
			);
			if (clickedButton) {
				clickedButton.classList.add('active');
			}

			// Actualizar contenido dinámico si es necesario
			if (tabId === 'estadisticas') {
				actualizarEstadisticas(); // <-- Asegura que se llame aquí
			}
			if (tabId === 'analisis') {
				actualizarAnalisis(); // <-- Asegura que se llame aquí
			}
		}
    // Actualizar estadísticas
    function actualizarEstadisticas() {
        if (evaluaciones.length === 0) return;
		
		// Actualizar estadísticas
// Actualizar estadísticas
// Actualizar estadísticas
function actualizarEstadisticas() {
    if (evaluaciones.length === 0) {
        // Opcional: Limpiar contenedores si no hay datos
        document.getElementById('statsGrid').innerHTML = '<p>No hay datos para mostrar estadísticas.</p>';
        // Limpiar métricas específicas del dashboard
        document.getElementById('puntuacionGeneral').textContent = 'N/A';
        document.getElementById('puntuacionGeneral').className = 'metric-value'; // Resetear clase
        document.getElementById('fortalezaPrincipal').textContent = 'N/A';
        document.getElementById('areaMejorar').textContent = 'N/A';
        document.getElementById('mejorCategoria').textContent = 'N/A';
        document.getElementById('categoriaCritica').textContent = 'N/A';
        document.getElementById('totalEvaluaciones').textContent = '0';
        document.getElementById('insightsContainer').innerHTML = '<p>No hay datos para generar insights.</p>';
        // Asegurar que los gráficos estén destruidos si no hay datos
        if (distribucionEdadChart) {
            distribucionEdadChart.destroy();
            distribucionEdadChart = null;
        }
        if (rendimientoChart) {
            rendimientoChart.destroy();
            rendimientoChart = null;
        }
        if (categoriasChart) {
            categoriasChart.destroy();
            categoriasChart = null;
        }
        return; // Salir si no hay datos
    }

    // Calcular estadísticas generales (como antes)
    const total = evaluaciones.length;
    const masculino = evaluaciones.filter(e => e.genero === 'masculino').length;
    const femenino = evaluaciones.filter(e => e.genero === 'femenino').length;
    const edadPromedio = evaluaciones.reduce((sum, e) => sum + getEdad(e.fechaNacimiento), 0) / total;
    const imcPromedio = evaluaciones.reduce((sum, e) => sum + calcularIMC(e.peso, e.altura), 0) / total;
    const cinturaPromedio = evaluaciones.reduce((sum, e) => sum + e.cintura, 0) / total;
    const shuttle20mPromedio = evaluaciones.reduce((sum, e) => sum + e.shuttle20m, 0) / total;
    const saltoPromedio = evaluaciones.reduce((sum, e) => sum + e.salto, 0) / total;
    const fuerzaPromedio = evaluaciones.reduce((sum, e) => sum + e.fuerza, 0) / total;
    const shuttle4x10mPromedio = evaluaciones.reduce((sum, e) => sum + e.shuttle4x10m, 0) / total;

    // Actualizar HTML de estadísticas generales (como antes)
    document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card"><h3>Total Evaluaciones</h3><p>${total}</p></div>
        <div class="stat-card"><h3>Género Masculino</h3><p>${masculino}</p></div>
        <div class="stat-card"><h3>Género Femenino</h3><p>${femenino}</p></div>
       
        <div class="stat-card"><h3>IMC Promedio</h3><p>${imcPromedio.toFixed(1)}</p></div>
        <div class="stat-card"><h3>Cintura Promedio</h3><p>${cinturaPromedio.toFixed(1)} cm</p></div>
        <div class="stat-card"><h3>Cardio Promedio</h3><p>${shuttle20mPromedio.toFixed(1)} etapas</p></div>
        <div class="stat-card"><h3>Salto Promedio</h3><p>${saltoPromedio.toFixed(1)} cm</p></div>
        <div class="stat-card"><h3>Fuerza Promedio</h3><p>${fuerzaPromedio.toFixed(1)} kg</p></div>
        <div class="stat-card"><h3>Shuttle 4x10m Promedio</h3><p>${shuttle4x10mPromedio.toFixed(1)} seg</p></div>
    `;

    // Actualizar total evaluaciones en la tarjeta correspondiente
    document.getElementById('totalEvaluaciones').textContent = total;

    // Actualizar gráficos
    actualizarGraficos(total); // <-- Pasamos 'total' como parámetro para usarlo en el cálculo de la puntuación general
}        // Calcular estadísticas
        const total = evaluaciones.length;
        const masculino = evaluaciones.filter(e => e.genero === 'masculino').length;
        const femenino = evaluaciones.filter(e => e.genero === 'femenino').length;
        //const promedioEdad = evaluaciones.reduce((sum, e) => sum + getEdad(e.fechaNacimiento), 0) / total;
        const promedioIMC = evaluaciones.reduce((sum, e) => sum + calcularIMC(e.peso, e.altura), 0) / total;
        const promedioCardio = evaluaciones.reduce((sum, e) => sum + e.shuttle20m, 0) / total;
        const promedioSalto = evaluaciones.reduce((sum, e) => sum + e.salto, 0) / total;
        const promedioFuerza = evaluaciones.reduce((sum, e) => sum + e.fuerza, 0) / total;
        const promedioShuttle4x10 = evaluaciones.reduce((sum, e) => sum + e.shuttle4x10m, 0) / total;
        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card">
                <h3>Total Evaluaciones</h3>
                <p>${total}</p>
            </div>
            <div class="stat-card">
                <h3>Hombres</h3>
                <p>${masculino}</p>
            </div>
            <div class="stat-card">
                <h3>Mujeres</h3>
                <p>${femenino}</p>
            </div>
            
            <div class="stat-card">
                <h3>IMC Promedio</h3>
                <p>${promedioIMC.toFixed(2)}</p>
            </div>
            <div class="stat-card">
                <h3>Cardio Promedio</h3>
                <p>${promedioCardio.toFixed(1)} etapas</p>
            </div>
            <div class="stat-card">
                <h3>Salto Promedio</h3>
                <p>${promedioSalto.toFixed(1)} cm</p>
            </div>
            <div class="stat-card">
                <h3>Fuerza Promedio</h3>
                <p>${promedioFuerza.toFixed(1)} kg</p>
            </div>
            <div class="stat-card">
                <h3>Shuttle 4x10m Promedio</h3>
                <p>${promedioShuttle4x10.toFixed(1)} seg</p>
            </div>
        `;
        // Actualizar gráficos
        actualizarGraficos();
    }
	
	// --- Función global para calcular la Valoración General ---
		// Asegura que las funciones auxiliares como getClasificacionIMC, getClasificacionCintura, etc.
		// estén definidas antes de esta función o sean accesibles desde aquí.
		function obtenerClasificacionGeneral(
			clasificacionCardio,
			clasificacionSalto,
			clasificacionFuerza,
			clasificacionIMC,
			clasificacionCintura,
			clasificacionShuttle4x10
		) {
			const clasificaciones = [clasificacionCardio, clasificacionSalto, clasificacionFuerza, clasificacionIMC, clasificacionCintura, clasificacionShuttle4x10];
			let muyBajo = 0, bajo = 0, promedio = 0, alto = 0, muyAlto = 0;

			clasificaciones.forEach(cat => {
				if (cat.includes('Muy Bajo')) muyBajo++;
				else if (cat.includes('Bajo')) bajo++;
				else if (cat.includes('Promedio')) promedio++;
				else if (cat.includes('Alto')) alto++;
				else if (cat.includes('Muy Alto')) muyAlto++;
			});

			if (muyBajo >= 2) return 'Muy Deficiente';
			if (muyBajo + bajo >= 3) return 'Deficiente';
			if (muyAlto + alto >= 3) return 'Excelente';
			if (muyAlto + alto >= 2) return 'Bueno';
			return 'Adecuado';
		}
		
		// --- Función auxiliar para calcular la puntuación (0-100) de una prueba ---
// --- Función auxiliar para calcular la puntuación (0-100) de una prueba ---
function calcularPuntuacionPrueba(valorPrueba, nombrePrueba, genero, edadRef) {
    // Asegurarse de que la edad de referencia esté definida
    const edadParaRef = getEdadReferencia(edadRef);

    // Obtener los límites de referencia para la prueba, género y edad
    const refs = valoresReferencia?.[genero]?.[edadParaRef]?.[nombrePrueba];

    // Verificar si los referencias existen
    if (!refs) {
        console.warn(`No se encontraron referencias para ${nombrePrueba}, ${genero}, ${edadParaRef}`);
        // Devolver una puntuación por defecto (p.ej., 50) o NaN si prefieres
        return 50; // O puedes retornar 0 o usar una puntuación basada en el valor bruto
    }

    // Extraer los límites numéricos con verificación adicional
    // Para evitar errores, asignamos valores por defecto si los límites no están definidos
    const muyBajoMax = refs.muy_bajo?.[1] ?? 0;
    const bajoMax = refs.bajo?.[1] ?? muyBajoMax + 10; // Valor por defecto
    const promedioMax = refs.promedio?.[1] ?? bajoMax + 10;
    const altoMax = refs.alto?.[1] ?? promedioMax + 10;
    const muyAltoMax = refs.muy_alto?.[1] ?? altoMax + 10;

    // Para pruebas donde "menos es mejor" (shuttle4x10m, IMC, cintura), la lógica se invierte
    const isMenorEsMejor = (nombrePrueba === 'shuttle4x10m' || nombrePrueba === 'IMC' || nombrePrueba === 'cintura');

    let puntuacion = 0;

    if (isMenorEsMejor) {
        // Lógica invertida para shuttle4x10m, IMC, cintura
        // Suponiendo que muy_bajo es el mejor valor (tiempo más bajo, IMC/Cintura más bajos)
        if (valorPrueba <= muyBajoMax) {
            puntuacion = 100;
        } else if (valorPrueba <= bajoMax) {
            // Interpolar entre 100 (muyBajoMax) y ~80 (bajoMax)
            puntuacion = 100 - ((valorPrueba - muyBajoMax) / (bajoMax - muyBajoMax)) * 20;
        } else if (valorPrueba <= promedioMax) {
            // Interpolar entre ~80 (bajoMax) y 50 (promedioMax)
            puntuacion = 80 - ((valorPrueba - bajoMax) / (promedioMax - bajoMax)) * 30;
        } else if (valorPrueba <= altoMax) {
            // Interpolar entre 50 (promedioMax) y ~20 (altoMax)
            puntuacion = 50 - ((valorPrueba - promedioMax) / (altoMax - promedioMax)) * 30;
        } else {
            // Interpolar entre ~20 (altoMax) y 0 (muyAltoMax o más)
            const range = muyAltoMax - altoMax;
            if (range > 0) {
                puntuacion = 20 - Math.min(((valorPrueba - altoMax) / range) * 20, 20);
            } else {
                // Si no hay rango definido para "muy alto", asumir 0
                puntuacion = 0;
            }
            puntuacion = Math.max(0, puntuacion); // Asegurar que no sea negativo
        }
    } else {
        // Lógica normal para shuttle20m, salto, fuerza (más es mejor)
        if (valorPrueba >= muyAltoMax) {
            puntuacion = 100;
        } else if (valorPrueba >= altoMax) {
            // Interpolar entre 100 (muyAltoMax) y ~80 (altoMax)
            puntuacion = 100 - ((muyAltoMax - valorPrueba) / (muyAltoMax - altoMax)) * 20;
        } else if (valorPrueba >= promedioMax) {
            // Interpolar entre ~80 (altoMax) y 50 (promedioMax)
            puntuacion = 80 - ((altoMax - valorPrueba) / (altoMax - promedioMax)) * 30;
        } else if (valorPrueba >= bajoMax) {
            // Interpolar entre 50 (promedioMax) y ~20 (bajoMax)
            puntuacion = 50 - ((promedioMax - valorPrueba) / (promedioMax - bajoMax)) * 30;
        } else {
            // Interpolar entre ~20 (bajoMax) y 0 (muyBajoMax o menos)
            const range = bajoMax - muyBajoMax;
            if (range > 0) {
                puntuacion = 20 - Math.min(((bajoMax - valorPrueba) / range) * 20, 20);
            } else {
                // Si no hay rango definido para "muy bajo", asumir 0
                puntuacion = 0;
            }
            puntuacion = Math.max(0, puntuacion); // Asegurar que no sea negativo
        }
    }

    // Asegurar que la puntuación esté entre 0 y 100
    return Math.max(0, Math.min(100, parseFloat(puntuacion.toFixed(1))));
}
		
   // Actualizar gráficos y métricas
// Actualizar gráficos y métricas del Dashboard de Estadísticas
function actualizarGraficos() {
    if (evaluaciones.length === 0) {
        // Manejar caso sin datos: Limpiar gráficos y métricas
        if (distribucionEdadChart) { distribucionEdadChart.destroy(); distribucionEdadChart = null; }
        if (rendimientoChart) { rendimientoChart.destroy(); rendimientoChart = null; }
        if (categoriasChart) { categoriasChart.destroy(); categoriasChart = null; }

        document.getElementById('puntuacionGeneral').textContent = 'N/A';
        document.getElementById('fortalezaPrincipal').textContent = 'N/A';
        document.getElementById('areaMejorar').textContent = 'N/A';
        document.getElementById('mejorCategoria').textContent = 'N/A';
        document.getElementById('categoriaCritica').textContent = 'N/A';
        document.getElementById('totalEvaluaciones').textContent = '0';
        document.getElementById('insightsContainer').innerHTML = '<p>No hay datos suficientes para generar insights.</p>';
        return;
    }

    // --- 1. GRÁFICO DE BARRAS: Distribución por Edad y Sexo ---
    // (Manteniendo la lógica existente de apilado por género y clasificación general)
    const datosAgrupados = {};
    evaluaciones.forEach(e => {
        const edad = getEdad(e.fechaNacimiento);
        const genero = e.genero;
        const imc = calcularIMC(e.peso, e.altura);
        const edadRef = getEdadReferencia(edad);
        const clasificacionGeneral = obtenerClasificacionGeneral(
            getClasificacionCardio(e.shuttle20m, e.genero, edadRef),
            getClasificacionSalto(e.salto, e.genero, edadRef),
            getClasificacionFuerza(e.fuerza, e.genero, edadRef),
            getClasificacionIMC(imc, e.genero, edadRef),
            getClasificacionCintura(e.cintura, e.genero, edadRef),
            getClasificacionShuttle4x10(e.shuttle4x10m, e.genero, edadRef)
        );

        if (!datosAgrupados[edad]) {
            datosAgrupados[edad] = { 'masculino': {}, 'femenino': {} };
        }
        if (!datosAgrupados[edad][genero][clasificacionGeneral]) {
            datosAgrupados[edad][genero][clasificacionGeneral] = 0;
        }
        datosAgrupados[edad][genero][clasificacionGeneral]++;
    });

    const edadesUnicas = Object.keys(datosAgrupados).sort((a, b) => parseInt(a) - parseInt(b));
    const clasificacionesUnicas = [...new Set(evaluaciones.flatMap(e => {
        const imc = calcularIMC(e.peso, e.altura);
        const edadRef = getEdadReferencia(getEdad(e.fechaNacimiento));
        return obtenerClasificacionGeneral(
            getClasificacionCardio(e.shuttle20m, e.genero, edadRef),
            getClasificacionSalto(e.salto, e.genero, edadRef),
            getClasificacionFuerza(e.fuerza, e.genero, edadRef),
            getClasificacionIMC(imc, e.genero, edadRef),
            getClasificacionCintura(e.cintura, e.genero, edadRef),
            getClasificacionShuttle4x10(e.shuttle4x10m, e.genero, edadRef)
        );
    }))].sort();

    const mapaClasificacionIndice = { 'Muy Deficiente': 1, 'Deficiente': 2, 'Adecuado': 3, 'Bueno': 4, 'Excelente': 5 };
    const colorMapBarras = {
        'masculino': { 1: 'rgba(76, 175, 80, 0.8)', 2: 'rgba(255, 193, 7, 0.8)', 3: 'rgba(255, 152, 0, 0.8)', 4: 'rgba(255, 87, 34, 0.8)', 5: 'rgba(244, 67, 54, 0.8)' },
        'femenino': { 1: 'rgba(91, 141, 241, 0.8)', 2: 'rgba(58, 107, 199, 0.8)', 3: 'rgba(42, 77, 158, 0.8)', 4: 'rgba(107, 82, 174, 0.8)', 5: 'rgba(138, 62, 183, 0.8)' }
    };

    const datasetsBarras = [];
    ['masculino', 'femenino'].forEach(genero => {
        clasificacionesUnicas.forEach(categoria => {
            const data = edadesUnicas.map(edad => datosAgrupados[edad]?.[genero]?.[categoria] || 0);
            const indice = mapaClasificacionIndice[categoria];
            let backgroundColor = 'rgba(200, 200, 200, 0.7)';
            let borderColor = backgroundColor.replace('0.7', '1');
            if (indice !== undefined && colorMapBarras[genero]?.[indice]) {
                backgroundColor = colorMapBarras[genero][indice];
                borderColor = backgroundColor.replace('0.8', '1');
            }
            datasetsBarras.push({
                label: `${genero === 'masculino' ? 'Hombres' : 'Mujeres'} - ${categoria}`,
                data,
                backgroundColor,
                borderColor,
                borderWidth: 1,
                stack: genero === 'masculino' ? 'Hombres' : 'Mujeres',
                datalabels: {
                    display: true,
                    color: '#fff',
                    font: { weight: 'bold', size: 10 },
                    formatter: function(value, context) {
                        const dataIndex = context.dataIndex;
                        const stack = context.dataset.stack;
                        let totalStack = 0;
                        datasetsBarras.forEach(ds => {
                            if (ds.stack === stack && ds.data[dataIndex] !== undefined) {
                                totalStack += ds.data[dataIndex];
                            }
                        });
                        const esUltimaCategoriaDelGenero = context.datasetIndex % 5 === 4;
                        return esUltimaCategoriaDelGenero && totalStack > 0 ? totalStack : '';
                    }
                }
            });
        });
    });

    const ctx1 = document.getElementById('distribucionEdadChart').getContext('2d');
    if (distribucionEdadChart) { distribucionEdadChart.destroy(); }
    distribucionEdadChart = new Chart(ctx1, {
        type: 'bar',
        data: { labels: edadesUnicas, datasets: datasetsBarras },
        options: {
            indexAxis: 'x', responsive: true, maintainAspectRatio: false,
            plugins: {
                title: {
					  display: true,
					  text: 'Distribución de Resultados por Edad y Género',
					  font: {
						weight: 'bold', // Hace que el texto esté en negrita
						size: 24         // Aumenta el tamaño del texto (puedes ajustar este valor)
					  }
					},
                legend: { display: false },
                tooltip: {
                    mode: 'nearest', intersect: true,
                    callbacks: {
                        title: context => `Edad: ${context[0].label}`,
                        label: context => {
                            const [genero, categoria] = context.dataset.label.split(' - ');
                            const generoDisplay = genero === 'Hombres' ? 'Nº Hombres' : 'Nº Mujeres';
                            return `${generoDisplay} (${categoria}): ${context.raw}`;
                        },
                        footer: context => {
                            const dataIndex = context[0].dataIndex;
                            let totalCombinado = 0;
                            datasetsBarras.forEach(ds => {
                                if (ds.data[dataIndex] !== undefined) totalCombinado += ds.data[dataIndex];
                            });
                            return `Nº Usuarios Totales: ${totalCombinado}`;
                        }
                    }
                },
                datalabels: { display: true, color: '#fff', font: { weight: 'bold', size: 11 } }
            },
            scales: {
                x: { stacked: true, title: { display: true, text: 'Edad' }, grid: { display: false } },
                y: {
                    stacked: true, title: { display: true, text: 'Número de Evaluaciones' },
                    beginAtZero: true, ticks: { stepSize: 1 },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                }
            }
        },
        plugins: [ChartDataLabels]
    });


    // --- 2. GRÁFICO DE RADAR: Rendimiento General ---
    if (evaluaciones.length === 0) {
        // Si no hay evaluaciones, destruir el gráfico si existe
        if (rendimientoChart) {
            rendimientoChart.destroy();
            rendimientoChart = null;
        }
        // Opcional: Mostrar mensaje en el canvas o contenedor
        return; // Salir si no hay datos
    }
    // Arrays para almacenar las puntuaciones de cada usuario por prueba
    const puntuacionesCardio = [];
    const puntuacionesSalto = [];
    const puntuacionesFuerza = [];
    const puntuacionesAgilidad = [];
    const puntuacionesIMC = [];
    const puntuacionesCintura = [];
	// Calcular puntuaciones para cada evaluación
    evaluaciones.forEach(e => {
        const edadRef = getEdadReferencia(getEdad(e.fechaNacimiento)); // Asegura edad mínima de 13
        const genero = e.genero;

        // Calcular puntuación para cada prueba y almacenarla
        puntuacionesCardio.push(calcularPuntuacionPrueba(e.shuttle20m, 'shuttle20m', genero, edadRef));
        puntuacionesSalto.push(calcularPuntuacionPrueba(e.salto, 'salto', genero, edadRef));
        puntuacionesFuerza.push(calcularPuntuacionPrueba(e.fuerza, 'fuerza', genero, edadRef));
        puntuacionesAgilidad.push(calcularPuntuacionPrueba(e.shuttle4x10m, 'shuttle4x10m', genero, edadRef));
        puntuacionesIMC.push(calcularPuntuacionPrueba(calcularIMC(e.peso, e.altura), 'IMC', genero, edadRef));
        puntuacionesCintura.push(calcularPuntuacionPrueba(e.cintura, 'cintura', genero, edadRef));
    });
	
	// Calcular promedios de las puntuaciones
    const cardioPromPuntos = puntuacionesCardio.reduce((sum, p) => sum + p, 0) / puntuacionesCardio.length;
    const saltoPromPuntos = puntuacionesSalto.reduce((sum, p) => sum + p, 0) / puntuacionesSalto.length;
    const fuerzaPromPuntos = puntuacionesFuerza.reduce((sum, p) => sum + p, 0) / puntuacionesFuerza.length;
    const agilidadPromPuntos = puntuacionesAgilidad.reduce((sum, p) => sum + p, 0) / puntuacionesAgilidad.length;
    const imcPromPuntos = puntuacionesIMC.reduce((sum, p) => sum + p, 0) / puntuacionesIMC.length;
    const cinturaPromPuntos = puntuacionesCintura.reduce((sum, p) => sum + p, 0) / puntuacionesCintura.length;

    // Valores Objetivo Ideal (pueden ser 100 para todas o valores específicos si tienes un objetivo)
    // Por ejemplo, objetivo sería puntuación >= 80 en todas
    const objetivoIdealPuntos = [80, 80, 80, 80, 80, 80]; // Ejemplo: Excelente en todas


    const ctx2 = document.getElementById('rendimientoChart').getContext('2d');
    if (rendimientoChart) { rendimientoChart.destroy(); }
    
	rendimientoChart = new Chart(ctx2, {
        type: 'radar',
        data: {
            labels: ['Resistencia Cardio', 'Potencia Salto', 'Fuerza Máxima', 'Agilidad 4x10m', 'Composición IMC', 'Perímetro Cintura'],
            datasets: [{
                label: 'Rendimiento Actual (Puntos)',
                data: [cardioPromPuntos, saltoPromPuntos, fuerzaPromPuntos, agilidadPromPuntos, imcPromPuntos, cinturaPromPuntos],
                
                backgroundColor: 'rgba(46, 204, 113, 0.2)',
                borderColor: 'rgba(46, 204, 113, 1)',
                borderWidth: 3,
                pointBackgroundColor: 'rgba(46, 204, 113, 1)',
                pointBorderColor: '#fff',
                pointRadius: 7,
                pointHoverRadius: 9
            }, {
                label: 'Objetivo Ideal',
                data: objetivoIdealPuntos,
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderColor: 'rgba(52, 152, 219, 0.7)',
                borderWidth: 2,
                borderDash: [5, 5],
                pointBackgroundColor: 'rgba(52, 152, 219, 0.7)',
                pointBorderColor: '#fff',
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: false // Titulo ya está en el .card-header
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += parseFloat(context.raw).toFixed(1) + ' pts'; // Mostrar puntos
                            return label;
                        }
                    }
                }
            },
            scales: {
                r: {
                    angleLines: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    // --- MODIFICACIÓN: Controlar las líneas radiales ---
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)',
                        // Limitar el número de líneas radiales (anillos concéntricos)
                        // Chart.js no permite directamente limitar las radiales,
                        // pero puedes controlar el número de ticks, lo que influye indirectamente.
                        // Si defines 'stepSize' o 'maxTicksLimit', Chart.js ajustará las líneas.
                        // Por ejemplo, si el maximo valor es 60, y quieres aprox 7 lineas:
                        // ticks: { stepSize: 10 } // Esto daría 0, 10, 20, 30, 40, 50, 60 (7 líneas)
                        // O puedes dejar que Chart.js lo maneje automáticamente con un límite.
                        // maxTicksLimit: 8 // (7 espacios entre 8 ticks) suele funcionar bien
                        // ---
                        // Para un control más fino, combina con ticks:
                        // ---
                        circular: {
                            // Esto controla las líneas circulares (los anillos)
                             color: 'rgba(0, 0, 0, 0.05)' // Color diferente si se desea
                        }
                        
                    },
                    // --- MODIFICACIÓN: Configurar ticks para controlar líneas ---
                    ticks: {
                        display: false, // Mostrar los ticks del eje radial
                        // stepSize: 10, // Descomenta y ajusta para forzar espaciado (ej: 10, 20, 30...)
                        maxTicksLimit: 6, // Limitar el número total de ticks (y por ende, anillos)
                        // callback: function(value) { return value; } // Formatear ticks si se desea
                    },
                    pointLabels: {
                        font: {
                            size: 12,
                            weight: 'bold'
                        },
                        color: '#2c3e50'
                    },
                     min: 0,   // Establecer mínimo del eje radial
                    max: 100, // Establecer máximo del eje radial
                    ticks: {
                        display: true, // Mostrar ticks (números en los anillos)
                        stepSize: 20,  // Mostrar ticks cada 20 (0, 20, 40, 60, 80, 100)
                        // callback: function(value) { return value + ' pts'; } // Opcional: añadir 'pts'
                    }
                }
            },
            // --- MODIFICACIÓN: Ocultar puntos en las líneas del dataset ---
            elements: {
                line: {
                    tension: 0.1 // Suavizado de la línea (0 = recta, 1 = muy curvada)
                },
                point: {
                    radius: 0, // Establecer el radio del punto a 0 para ocultarlo
                    hitRadius: 0, // Radio para detección de clics/touch también a 0
                    hoverRadius: 0 // Radio al pasar el mouse también a 0
                }
            }
            // ---
        }
    });

    // --- CÁLCULOS PARA MÉTRICAS DEL DASHBOARD ---
    const valoresRadarActual = [cardioPromPuntos, saltoPromPuntos, fuerzaPromPuntos, agilidadPromPuntos, imcPromPuntos, cinturaPromPuntos];
    const nombresPruebasRadar = ['Resistencia Cardio', 'Potencia Salto', 'Fuerza Máxima', 'Agilidad 4x10m', 'Composición IMC', 'Perímetro Cintura'];

    // --- CÁLCULO DE PUNTUACIÓN GENERAL (basado en el radar) ---
    // Normalización simple (ajusta según tus criterios de puntuación)
    const minValues = [0, 0, 0, 0, 0, 0]; // Mínimos posibles
    const maxValues = [100, 3.5, 50, 15, 30, 100]; // Máximos posibles (ajusta)
    let puntuacionGeneralSuma = 0;
    for (let i = 0; i < valoresRadarActual.length; i++) {
        let valorNormalizado = 0;
        if (i === 3 || i === 4 || i === 5) { // shuttle4x10m, IMC, cintura: "menos es mejor"
            valorNormalizado = ((maxValues[i] - valoresRadarActual[i]) / (maxValues[i] - minValues[i])) * 100;
        } else { // cardio, salto, fuerza: "más es mejor"
            valorNormalizado = ((valoresRadarActual[i] - minValues[i]) / (maxValues[i] - minValues[i])) * 100;
        }
        // Asegurar que el valor esté dentro del rango 0-100
        valorNormalizado = Math.max(0, Math.min(100, valorNormalizado));
        puntuacionGeneralSuma += valorNormalizado;
    }
    const puntuacionGeneralPromedio = parseFloat((puntuacionGeneralSuma / valoresRadarActual.length).toFixed(1));

    // --- CÁLCULO DE FORTALEZA PRINCIPAL Y ÁREA A MEJORAR (basado en el radar) ---
    let fortalezaPrincipalIndex = 0;
    let maxValorRadar = valoresRadarActual[0];
    let areaMejorarIndex = 0;
    let minValorRadar = valoresRadarActual[0];

    for (let i = 1; i < valoresRadarActual.length; i++) {
        // Para Shuttle 4x10m, IMC, Cintura, el valor más bajo es mejor
        if (i === 3 || i === 4 || i === 5) {
            if (valoresRadarActual[i] < minValorRadar) { minValorRadar = valoresRadarActual[i]; areaMejorarIndex = i; } // Mejor tiempo
            if (valoresRadarActual[i] > maxValorRadar) { maxValorRadar = valoresRadarActual[i]; fortalezaPrincipalIndex = i; } // Peor tiempo
        } else {
            if (valoresRadarActual[i] > maxValorRadar) { maxValorRadar = valoresRadarActual[i]; fortalezaPrincipalIndex = i; }
            if (valoresRadarActual[i] < minValorRadar) { minValorRadar = valoresRadarActual[i]; areaMejorarIndex = i; }
        }
    }

    const fortalezaPrincipal = nombresPruebasRadar[fortalezaPrincipalIndex];
    const areaMejorar = nombresPruebasRadar[areaMejorarIndex];

    // --- CÁLCULO DE DISTRIBUCIÓN POR CATEGORÍAS (gráfico doughnut y métricas) ---
    const clasificacionesGenerales = evaluaciones.map(e => {
        const imc = calcularIMC(e.peso, e.altura);
        const edadRef = getEdadReferencia(getEdad(e.fechaNacimiento));
        return obtenerClasificacionGeneral(
            getClasificacionCardio(e.shuttle20m, e.genero, edadRef),
            getClasificacionSalto(e.salto, e.genero, edadRef),
            getClasificacionFuerza(e.fuerza, e.genero, edadRef),
            getClasificacionIMC(imc, e.genero, edadRef),
            getClasificacionCintura(e.cintura, e.genero, edadRef),
            getClasificacionShuttle4x10(e.shuttle4x10m, e.genero, edadRef)
        );
    });

    const conteoClasificaciones = {};
    clasificacionesGenerales.forEach(cat => conteoClasificaciones[cat] = (conteoClasificaciones[cat] || 0) + 1);

    const ordenCategorias = ['Excelente', 'Bueno', 'Adecuado', 'Deficiente', 'Muy Deficiente'];
    const colorMapCategorias = {
        'Excelente': 'rgba(46, 204, 113, 0.8)', 'Bueno': 'rgba(52, 152, 219, 0.8)',
        'Adecuado': 'rgba(241, 196, 15, 0.8)', 'Deficiente': 'rgba(230, 126, 34, 0.8)',
        'Muy Deficiente': 'rgba(231, 76, 60, 0.8)'
    };
    const borderColorMap = {
        'Excelente': 'rgba(46, 204, 113, 1)', 'Bueno': 'rgba(52, 152, 219, 1)',
        'Adecuado': 'rgba(241, 196, 15, 1)', 'Deficiente': 'rgba(230, 126, 34, 1)',
        'Muy Deficiente': 'rgba(231, 76, 60, 1)'
    };

    const labels = ordenCategorias;
    const data = ordenCategorias.map(cat => conteoClasificaciones[cat] || 0);
    const backgroundColors = labels.map(cat => colorMapCategorias[cat]);
    const borderColors = labels.map(cat => borderColorMap[cat]);

    const total = data.reduce((a, b) => a + b, 0);
    const porcentajes = data.map(value => total > 0 ? ((value / total) * 100).toFixed(0) : 0);

    // --- CÁLCULO DE MEJOR CATEGORÍA Y CATEGORÍA CRÍTICA (basado en imagen: Excelente y Muy Deficiente) ---
    let mejorCategoriaTexto = 'N/A';
    let categoriaCriticaTexto = 'N/A';
    let mejorPorcentaje = 0;
    let criticaPorcentaje = 0;

    labels.forEach((cat, index) => {
        if (cat === 'Excelente') {
            mejorPorcentaje = porcentajes[index];
            mejorCategoriaTexto = `${cat} (${porcentajes[index]}%)`;
        } else if (cat === 'Muy Deficiente') {
            criticaPorcentaje = porcentajes[index];
            categoriaCriticaTexto = `${cat} (${porcentajes[index]}%)`;
        }
    });

    // --- ACTUALIZACIÓN DE ELEMENTOS HTML ---
    // Métricas del Dashboard
    document.getElementById('puntuacionGeneral').textContent = puntuacionGeneralPromedio;
    const puntuacionGeneralElement = document.getElementById('puntuacionGeneral');
    puntuacionGeneralElement.className = 'metric-value';
    if (puntuacionGeneralPromedio > 70) puntuacionGeneralElement.classList.add('metric-good');
    else if (puntuacionGeneralPromedio > 50) puntuacionGeneralElement.classList.add('metric-average');
    else puntuacionGeneralElement.classList.add('metric-poor');

    document.getElementById('fortalezaPrincipal').textContent = fortalezaPrincipal;
    document.getElementById('areaMejorar').textContent = areaMejorar;
    document.getElementById('mejorCategoria').textContent = mejorCategoriaTexto;
    document.getElementById('categoriaCritica').textContent = categoriaCriticaTexto;
    document.getElementById('totalEvaluaciones').textContent = total;

    // --- INSIGHTS Y RECOMENDACIONES ---
    const insightsContainer = document.getElementById('insightsContainer');
    insightsContainer.innerHTML = ''; // Limpiar contenedor

    let insightIndex = 1;
    const crearInsight = (titulo, descripcion) => {
        const insight = document.createElement('div');
        insight.className = 'insight-item';
        insight.innerHTML = `<div class="insight-icon">${insightIndex++}</div><div><strong>${titulo}:</strong> ${descripcion}</div>`;
        return insight;
    };

    // Insight 1: Basado en la Fortaleza Principal (imagen)
    if (fortalezaPrincipal) {
        insightsContainer.appendChild(crearInsight(
            `Fortaleza en ${fortalezaPrincipal}`,
            `El grupo muestra un rendimiento destacado en ${fortalezaPrincipal}, lo cual es positivo para su desarrollo físico.`
        ));
    }

    // Insight 2: Basado en el Área a Mejorar (imagen)
    if (areaMejorar) {
        insightsContainer.appendChild(crearInsight(
            `Oportunidad en ${areaMejorar}`,
            `El rendimiento en ${areaMejorar} presenta una oportunidad de mejora. Se recomienda enfocar intervenciones específicas en esta área.`
        ));
    }

    // Insight 3: Basado en la Mejor Categoría (imagen: Excelente)
    if (mejorPorcentaje > 0) {
        insightsContainer.appendChild(crearInsight(
            `Mayor Nivel General`,
            `El ${mejorPorcentaje}% del grupo alcanza la categoría de condición física "${ordenCategorias[0]}".`
        ));
    }

    // Insight 4: Basado en la Categoría Crítica (imagen: Muy Deficiente)
    if (criticaPorcentaje > 0) {
        insightsContainer.appendChild(crearInsight(
            `Área General a Reforzar`,
            `Solo un ${criticaPorcentaje}% del grupo se encuentra en la categoría "${ordenCategorias[4]}". Es fundamental trabajar para mejorar este porcentaje.`
        ));
    }

    // Insight por defecto si no se generaron otros específicos
    if (insightIndex === 1) {
        insightsContainer.appendChild(crearInsight(
            'Equilibrio General',
            'La distribución de categorías generales del grupo es relativamente equilibrada.'
        ));
    }


    // --- GRÁFICO DOUGHNUT: Distribución por Categorías ---
    const ctx3 = document.getElementById('categoriasChart').getContext('2d');
    if (categoriasChart) { categoriasChart.destroy(); }
    categoriasChart = new Chart(ctx3, {
        type: 'doughnut',
        data: { labels, datasets: [{ data, backgroundColor: backgroundColors, borderColor: borderColors, borderWidth: 2 }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw;
                            const total = context.chart.getDatasetMeta(0).total;
                            const percentage = total ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '65%'
        }
    });
}
    // Actualizar análisis detallado
// Actualizar análisis detallado
function actualizarAnalisis() {
    const filtroGenero = document.getElementById('filtroGenero').value;
    const datosFiltrados = filtroGenero === 'todos' ? evaluaciones : evaluaciones.filter(e => e.genero === filtroGenero);

    if (datosFiltrados.length === 0) {
        // Opcional: Mensaje si no hay datos con el filtro
        document.getElementById('analisisEdadChart').replaceWith(document.getElementById('analisisEdadChart').cloneNode(true)); // Reiniciar canvas
        document.getElementById('comparacionGeneroChart').replaceWith(document.getElementById('comparacionGeneroChart').cloneNode(true)); // Reiniciar canvas
        // Destruir instancias anteriores si existen
        if (analisisEdadChart) {
            analisisEdadChart.destroy();
            analisisEdadChart = null;
        }
        if (comparacionGeneroChart) {
            comparacionGeneroChart.destroy();
            comparacionGeneroChart = null;
        }
        return; // Salir si no hay datos filtrados
    }

    // Gráfico por edad para todas las pruebas
    const edades = [...new Set(datosFiltrados.map(e => getEdad(e.fechaNacimiento)))].sort();
    const cardioPorEdad = edades.map(edad => {
        const datosEdad = datosFiltrados.filter(e => getEdad(e.fechaNacimiento) === edad);
        return datosEdad.reduce((sum, e) => sum + e.shuttle20m, 0) / datosEdad.length;
    });
    const saltoPorEdad = edades.map(edad => {
        const datosEdad = datosFiltrados.filter(e => getEdad(e.fechaNacimiento) === edad);
        return datosEdad.reduce((sum, e) => sum + e.salto, 0) / datosEdad.length;
    });
    const fuerzaPorEdad = edades.map(edad => {
        const datosEdad = datosFiltrados.filter(e => getEdad(e.fechaNacimiento) === edad);
        return datosEdad.reduce((sum, e) => sum + e.fuerza, 0) / datosEdad.length;
    });

    const ctx3 = document.getElementById('analisisEdadChart').getContext('2d');
    // Destruir gráfico anterior si existe
    if (analisisEdadChart) {
        analisisEdadChart.destroy();
    }
    // Crear nuevo gráfico y asignarlo a la variable global
    analisisEdadChart = new Chart(ctx3, {
        type: 'line',
        data: {
            labels: edades,
            datasets: [
                {
                    label: 'Rendimiento Cardiorespiratorio',
                    data: cardioPorEdad,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                },
                {
                    label: 'Salto Horizontal',
                    data: saltoPorEdad,
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1
                },
                {
                    label: 'Fuerza Manual',
                    data: fuerzaPorEdad,
                    borderColor: 'rgb(54, 162, 235)',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Evolución del Rendimiento por Edad'
                }
            }
        }
    });

    // Gráfico de comparación por género (si filtro es "todos")
    if (filtroGenero === 'todos') {
        const generos = ['masculino', 'femenino'];
        const promediosGenero = generos.map(genero => {
            const datosGen = evaluaciones.filter(e => e.genero === genero);
            if (datosGen.length === 0) return { cardio: 0, salto: 0, fuerza: 0, imc: 0, cintura: 0, shuttle4x10m: 0 };
            return {
                cardio: datosGen.reduce((sum, e) => sum + e.shuttle20m, 0) / datosGen.length,
                salto: datosGen.reduce((sum, e) => sum + e.salto, 0) / datosGen.length,
                fuerza: datosGen.reduce((sum, e) => sum + e.fuerza, 0) / datosGen.length,
                imc: datosGen.reduce((sum, e) => sum + calcularIMC(e.peso, e.altura), 0) / datosGen.length,
                cintura: datosGen.reduce((sum, e) => sum + e.cintura, 0) / datosGen.length,
                shuttle4x10m: datosGen.reduce((sum, e) => sum + e.shuttle4x10m, 0) / datosGen.length
            };
        });

        const ctx4 = document.getElementById('comparacionGeneroChart').getContext('2d');
        // Destruir gráfico anterior si existe
        if (comparacionGeneroChart) {
            comparacionGeneroChart.destroy();
        }
        // Crear nuevo gráfico y asignarlo a la variable global
        comparacionGeneroChart = new Chart(ctx4, {
            type: 'bar',
            data: {
                labels: ['Cardio', 'Salto', 'Fuerza', 'IMC', 'Cintura', 'Shuttle 4x10m'],
                datasets: [
                    {
                        label: 'Masculino',
                        data: [promediosGenero[0].cardio, promediosGenero[0].salto, promediosGenero[0].fuerza, promediosGenero[0].imc, promediosGenero[0].cintura, promediosGenero[0].shuttle4x10m],
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Femenino',
                        data: [promediosGenero[1].cardio, promediosGenero[1].salto, promediosGenero[1].fuerza, promediosGenero[1].imc, promediosGenero[1].cintura, promediosGenero[1].shuttle4x10m],
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Comparación de Rendimiento por Género'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    } else {
        // Si se filtra por un género específico, el gráfico de género no tiene sentido.
        // Podríamos limpiarlo o dejarlo como está si no se cambia el filtro.
        // Para claridad, lo destruimos si no es 'todos'.
        if (comparacionGeneroChart) {
            comparacionGeneroChart.destroy();
            comparacionGeneroChart = null;
        }
        // Opcional: Mostrar un mensaje en el canvas indicando que el gráfico no aplica con el filtro
        const ctx4 = document.getElementById('comparacionGeneroChart').getContext('2d');
        ctx4.clearRect(0, 0, ctx4.canvas.width, ctx4.canvas.height);
        ctx4.font = "14px Arial";
        ctx4.fillStyle = "#999";
        ctx4.textAlign = "center";
        ctx4.fillText("Gráfico no disponible con filtro de género.", ctx4.canvas.width / 2, ctx4.canvas.height / 2);
    }
}
    // Exportar a CSV
    function exportToCSV() {
        if (evaluaciones.length === 0) {
            alert('No hay datos para exportar');
            return;
        }
            const headers = ['ID', 'Nombre', 'Fecha Nacimiento', 'Género', 'Fecha Evaluación', 
                           'Altura', 'Peso', 'Cintura', 'Shuttle 20m', 'Salto', 'Fuerza', 'Shuttle 4x10m', 
                           'IMC', 'Edad', 'Clasificación IMC', 'Clasificación Cintura', 
                           'Clasificación Cardiorespiratorio', 'Clasificación Salto', 
                           'Clasificación Fuerza', 'Clasificación Shuttle 4x10m'];
            const csvContent = [
                headers.join(','),
                ...evaluaciones.map(e => {
                    const edad = getEdad(e.fechaNacimiento);
                    const imc = calcularIMC(e.peso, e.altura);
                    return [
                        e.id,
                        e.nombre,
                        e.fechaNacimiento,
                        e.genero,
                        e.fechaEvaluacion,
                        e.altura,
                        e.peso,
                        e.cintura,
                        e.shuttle20m,
                        e.salto,
                        e.fuerza,
                        e.shuttle4x10m,
                        imc.toFixed(2),
                        edad,
                        getClasificacionIMC(imc, e.genero, edad),
                        getClasificacionCintura(e.cintura, e.genero, edad),
                        getClasificacionCardio(e.shuttle20m, e.genero, edad),
                        getClasificacionSalto(e.salto, e.genero, edad),
                        getClasificacionFuerza(e.fuerza, e.genero, edad),
                        getClasificacionShuttle4x10(e.shuttle4x10m, e.genero, edad)
                    ].join(',');
                })
            ].join('');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'evaluaciones_fitness.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        // Inicializar
        actualizarGraficos();
		
		// Limpiar solo el formulario
		function resetFormulario() {
			document.getElementById('fitnessForm').reset();
			// Restablecer la fecha de evaluación a hoy
			document.getElementById('fechaEvaluacion').value = getTodayDate();
		}

		// Limpiar formulario + resultados + gráficos
		function resetFormularioYResultados() {
			resetFormulario();
			
			// Limpiar resultados detallados
			document.getElementById('resultadoDetallado').innerHTML = '';
			document.getElementById('testResultsContainer').innerHTML = '';
			document.getElementById('recomendaciones').innerHTML = '';
			document.getElementById('infoSalud').innerHTML = '';

			// Destruir gráficos si existen
			if (typeof comparacionResultadosChart !== 'undefined' && comparacionResultadosChart !== null) {
				comparacionResultadosChart.destroy();
				comparacionResultadosChart = null;
			}
			
			actualizarContadorSiguienteID();
		}
		
// Asegúrate de que jsPDF esté disponible globalmente
const { jsPDF } = window.jspdf;

// Función para generar el PDF del informe individual (Mejorada con estilos CSS)
async function generarPDFInforme() {
    // Mostrar el spinner (opcional, si tienes el contenedor de spinner)
    // document.getElementById('pdf-spinner-container').style.display = 'flex';
 // Mostrar el spinner INMEDIATAMENTE
    document.getElementById('pdf-spinner-container').style.display = 'flex';
	
    try {
        const resultadoDetalladoElement = document.getElementById('resultadoDetallado');
        const testResultsContainerElement = document.getElementById('testResultsContainer');
        const comparacionChartCanvas = document.getElementById('comparacionResultadosChart');

        // Verificar si hay contenido en al menos el informe detallado
        if (!resultadoDetalladoElement || !resultadoDetalladoElement.innerHTML.trim()) {
            alert('No hay informe para generar PDF. Por favor, registre una evaluación primero.');
            return; // Salir de la función si no hay contenido en el informe
        }

        // Capturar la imagen del gráfico si está renderizado
        let chartDataURL = null;
        if (comparacionChartCanvas && comparacionChartCanvas.getContext('2d')) {
            // Asegurar que el gráfico haya terminado de renderizar (puede necesitar un pequeño delay)
            await new Promise(resolve => setTimeout(resolve, 500)); // Espera 500ms
            try {
                chartDataURL = comparacionChartCanvas.toDataURL('image/png');
            } catch (e) {
                console.error("Error capturando imagen del gráfico de comparación:", e);
            }
        }

        // Construir el contenido HTML para el PDF, incluyendo estilos CSS
        let contenidoHTML = `
            <html>
            <head>
                <title>Informe de Evaluación - ALPHA Fitness</title>
                <style>
                    /* Estilos básicos para la impresión y el PDF */
                    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                    h2 { color: #2c3e50; }
                    h3 { color: #34495e; }
                    /* Estilos específicos para el contenedor principal del informe */
                    #resultadoDetallado {
                        max-width: 850px;
                        margin: 2rem auto;
                        padding: 2.2rem;
                        background: white;
                        border-radius: 18px;
                        line-height: 1.65;
                        color: #2c3e50;
                        border: 1px solid #e2e8f0;
                        position: relative;
                        overflow: hidden;
                    }
                    #resultadoDetallado::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 6px;
                        background: linear-gradient(90deg, #5a92b8, #096879, #00d4ff);
                        z-index: 2;
                    }
                    #resultadoDetallado h4 {
                        font-weight: 700;
                        font-size: 1.35rem;
                        color: #1a365d;
                        margin: 1.8rem 0 1.1rem 0;
                        padding-bottom: 0.6rem;
                        border-bottom: 2px solid #e2e8f0;
                    }
                    #resultadoDetallado h4:first-child {
                        background: linear-gradient(2deg, rgba(90, 146, 184, 1) 0%, rgba(9, 104, 121, 1) 85%, rgba(0, 212, 255, 1) 100%);
                        -webkit-background-clip: text;
                        background-clip: text;
                        color: transparent;
                        margin-top: 0;
                        padding: 0.8rem 0 0.8rem 0;
                        border: none;
                        font-size: 1.6rem;
                        text-align: center;
                        letter-spacing: -0.02em;
                    }
                    #resultadoDetallado h4:nth-of-type(2) {
                        background: linear-gradient(2deg, rgba(90, 146, 184, 1) 0%, rgba(9, 104, 121, 1) 85%, rgba(0, 212, 255, 1) 100%);
                        -webkit-background-clip: text;
                        background-clip: text;
                        color: transparent;
                        font-size: 1.5rem;
                        text-align: center;
                        margin-top: 2.2rem;
                        padding-bottom: 0.8rem;
                        border: none;
                    }
                    #resultadoDetallado h4:nth-of-type(2) ~ p {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 1.1rem 1.3rem;
                        margin: 0.6rem 0;
                        background: #f8fbff;
                        border-radius: 14px;
                        border: 1px solid #e6f0f7;
                        box-shadow: 0 2px 6px rgba(90, 146, 184, 0.04);
                    }
                    #resultadoDetallado h4:nth-of-type(2) ~ p:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 10px rgba(90, 146, 184, 0.08);
                        border-color: #cbd5e1;
                    }
                    #resultadoDetallado h4:nth-of-type(2) ~ p strong:first-child {
                        color: #2d5a7a;
                        font-weight: 600;
                        font-size: 1.05rem;
                        margin-right: 1rem;
                        flex-shrink: 0;
                    }
                    #resultadoDetallado h4:nth-of-type(2) ~ p strong:last-child {
                        color: #1e293b;
                        font-weight: 700;
                        font-size: 1.1rem;
                        margin-right: auto;
                        padding-right: 1rem;
                    }
                    #resultadoDetallado h4:contains("Valoración General") {
                        background: linear-gradient(135deg, #1e40af, #096879);
                        color: white;
                        margin-top: 2.5rem;
                        padding: 1.4rem;
                        border-radius: 16px;
                        text-align: center;
                        border: none;
                        font-size: 1.5rem;
                        box-shadow: 0 4px 15px rgba(9, 104, 121, 0.15);
                    }
                    #resultadoDetallado h4:contains("Valoración General") + p {
                        background: linear-gradient(135deg, #dbeafe, #f0f9ff);
                        color: #1e3a8a;
                        padding: 1.8rem !important;
                        border-radius: 16px;
                        margin-top: 0;
                        border: 1px solid #bfdbfe;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        gap: 1rem;
                        font-size: 1.25rem;
                        font-weight: 600;
                        box-shadow: inset 0 0 0 1px rgba(90, 146, 184, 0.2);
                    }
                    #resultadoDetallado h4:contains("Valoración General") + p strong {
                        color: #1e3a8a;
                        background: none !important;
                        padding: 0 !important;
                        font-size: 1.35rem;
                        font-weight: 700;
                        text-align: center;
                    }
                    .categoria-badge {
                        display: inline-block;
                        padding: 0.4rem 0.9rem;
                        border-radius: 18px;
                        font-size: 0.85rem;
                        font-weight: 600;
                        color: white;
                        text-align: center;
                        min-width: 90px;
                        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
                        background: linear-gradient(135deg, var(--badge-start), var(--badge-end));
                    }
                    .categoria-badge.muy-bajo { --badge-start: #c0392b; --badge-end: #e74c3c; }
                    .categoria-badge.bajo { --badge-start: #d35400; --badge-end: #f39c12; }
                    .categoria-badge.promedio { --badge-start: #27ae60; --badge-end: #8bc34a; }
                    .categoria-badge.alto { --badge-start: #0288d1; --badge-end: #81d4fa; }
                    .categoria-badge.muy-alto { --badge-start: #1565c0; --badge-end: #1e88e5; }
                    /* Estilos para el gráfico */
                    .container { max-width: 100%; margin: 2rem auto; }
                    .chart-card {
                        background: white;
                        border-radius: 12px; /* var(--border-radius, 12px); */
                        box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* var(--shadow, 0 4px 12px rgba(0,0,0,0.1)); */
                        padding: 24px;
                        margin-bottom: 30px;
                    }
                    .chart-header { margin-bottom: 20px; }
                    .chart-title { font-size: 1.5rem; font-weight: 600; color: #1e293b; } /* var(--text-primary, #1e293b); */
                    .chart-subtitle { font-size: 0.9rem; color: #64748b; } /* var(--text-secondary, #64748b); */
                    .chart-container { height: 400px; display: flex; align-items: center; justify-content: center; }
                    /* Estilos para resultados detallados (si se incluyen) */
                    .test-result {
                        display: flex;
                        align-items: center;
                        margin: 15px 0;
                        padding: 18px 20px;
                        border-radius: 14px;
                        background: linear-gradient(145deg, #ffffff, #f6f6f6);
                        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                        flex-wrap: wrap;
                    }
                    .test-info { flex: 1; min-width: 250px; padding-right: 25px; }
                    .test-value { font-size: 26px; font-weight: 700; color: #222; }
                    .test-scale { flex: 2; height: 30px; background-color: rgba(255, 255, 255, 0.2); border-radius: 5px; overflow: visible; margin-bottom: 5px; box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2); }
                    .progress-segments { display: flex; height: 100%; border-radius: 5px; overflow: hidden; }
                    .segment { height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; transition: all 0.3s ease; position: relative; font-size: 0.8rem; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); }
                    .segment-labels { display: flex; justify-content: space-between; margin-top: 3px; margin-bottom: 5px; font-size: 0.9rem; }
                    .segment-label { text-align: center; font-weight: bold; flex: 1; color: #333; }
                    .arrow-indicator { position: absolute; top: -20px; width: 100%; height: 50px; pointer-events: none; color: black; z-index: 10; }
                    .arrow { width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 15px solid #080808; position: absolute; top: 0; filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5)); z-index: 10; }
                    .arrow-value { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background-color: #ffffff; color: #333; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; white-space: nowrap; z-index: 11; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }
                    .zone-indicator { display: inline-block; width: 14px; height: 14px; border-radius: 50%; margin-right: 6px; box-shadow: 0 0 3px rgba(0, 0, 0, 0.2); }
                    .category-badge { display: inline-block; padding: 3px 8px; border-radius: 15px; font-size: 12px; font-weight: bold; margin-left: 8px; color: white; min-width: 80px; text-align: center; }
                    .category-muy-bajo  { background: #e74c3c; }
                    .category-bajo      { background: #f39c12; }
                    .category-promedio  { background: #8bc34a; }
                    .category-alto      { background: #81d4fa; }
                    .category-muy-alto  { background: #1e88e5; }
                </style>
            </head>
            <body>
                <h2>Resultados de Evaluación</h2>
                <h3>Evaluación Individual</h3>
                <div id="resultadoDetallado">
                    ${resultadoDetalladoElement.innerHTML}
                </div>
        `;

        // Añadir el gráfico de comparación si existe una imagen capturada
        if (chartDataURL) {
            contenidoHTML += `
                <div class="container">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div>
                                <h2 class="chart-title">Comparación de Resultados ALPHA-Fitness</h2>
                                <p class="chart-subtitle">Resultados del usuario vs. valores de referencia según el manual ALPHA-Fitness</p>
                            </div>
                        </div>
                        <div class="chart-container">
                            <img src="${chartDataURL}" alt="Gráfico de Comparación de Resultados" style="width: 100%; height: auto;">
                        </div>
                    </div>
                </div>
            `;
        } else {
            contenidoHTML += `<p style="text-align: center; color: red;">(Gráfico de Comparación no disponible)</p>`;
        }

        // Añadir los resultados visuales detallados si existen
        if (testResultsContainerElement && testResultsContainerElement.innerHTML.trim() !== "") {
             contenidoHTML += `<div id="testResultsContainer">${testResultsContainerElement.innerHTML}</div>`;
        }

        // Cerrar las etiquetas de body y html
        contenidoHTML += `
            </body>
            </html>
        `;

        // Crear un contenedor temporal para html2canvas
        const tempContainer = document.createElement('div');
        tempContainer.id = 'temp-pdf-content';
        tempContainer.style.position = 'absolute';
        tempContainer.style.left = '-9999px'; // Ocultar fuera de la vista
        tempContainer.style.top = '0';
        tempContainer.style.width = '210mm'; // Ancho A4
        tempContainer.style.backgroundColor = 'white';
        tempContainer.style.padding = '20px';
        tempContainer.style.boxSizing = 'border-box';
        // Importante: innerHTML no interpreta las etiquetas <style> y <html> de la misma manera que un navegador.
        // Lo que necesitamos es *solo* el contenido que va dentro del <body>, pero con los estilos <style> aplicados.
        // Por lo tanto, construiremos el tempContainer de forma diferente.
        // Añadimos la etiqueta <style> directamente al contenedor temporal.
        const styleTag = document.createElement('style');
        styleTag.textContent = `
                    /* Estilos básicos para la impresión y el PDF */
                    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                    h2 { color: #2c3e50; }
                    h3 { color: #34495e; }
                    /* Estilos específicos para el contenedor principal del informe */
                    #resultadoDetallado {
                        max-width: 850px;
                        margin: 2rem auto;
                        padding: 2.2rem;
                        background: white;
                        border-radius: 18px;
                        line-height: 1.65;
                        color: #2c3e50;
                        border: 1px solid #e2e8f0;
                        position: relative;
                        overflow: hidden;
                    }
                    #resultadoDetallado::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 6px;
                        background: linear-gradient(90deg, #5a92b8, #096879, #00d4ff);
                        z-index: 2;
                    }
                    #resultadoDetallado h4 {
                        font-weight: 700;
                        font-size: 1.35rem;
                        color: #1a365d;
                        margin: 1.8rem 0 1.1rem 0;
                        padding-bottom: 0.6rem;
                        border-bottom: 2px solid #e2e8f0;
                    }
                    #resultadoDetallado h4:first-child {
                        background: linear-gradient(2deg, rgba(90, 146, 184, 1) 0%, rgba(9, 104, 121, 1) 85%, rgba(0, 212, 255, 1) 100%);
                        -webkit-background-clip: text;
                        background-clip: text;
                        color: transparent;
                        margin-top: 0;
                        padding: 0.8rem 0 0.8rem 0;
                        border: none;
                        font-size: 1.6rem;
                        text-align: center;
                        letter-spacing: -0.02em;
                    }
                    #resultadoDetallado h4:nth-of-type(2) {
                        background: linear-gradient(2deg, rgba(90, 146, 184, 1) 0%, rgba(9, 104, 121, 1) 85%, rgba(0, 212, 255, 1) 100%);
                        -webkit-background-clip: text;
                        background-clip: text;
                        color: transparent;
                        font-size: 1.5rem;
                        text-align: center;
                        margin-top: 2.2rem;
                        padding-bottom: 0.8rem;
                        border: none;
                    }
                    #resultadoDetallado h4:nth-of-type(2) ~ p {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 1.1rem 1.3rem;
                        margin: 0.6rem 0;
                        background: #f8fbff;
                        border-radius: 14px;
                        border: 1px solid #e6f0f7;
                        box-shadow: 0 2px 6px rgba(90, 146, 184, 0.04);
                    }
                    #resultadoDetallado h4:nth-of-type(2) ~ p:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 10px rgba(90, 146, 184, 0.08);
                        border-color: #cbd5e1;
                    }
                    #resultadoDetallado h4:nth-of-type(2) ~ p strong:first-child {
                        color: #2d5a7a;
                        font-weight: 600;
                        font-size: 1.05rem;
                        margin-right: 1rem;
                        flex-shrink: 0;
                    }
                    #resultadoDetallado h4:nth-of-type(2) ~ p strong:last-child {
                        color: #1e293b;
                        font-weight: 700;
                        font-size: 1.1rem;
                        margin-right: auto;
                        padding-right: 1rem;
                    }
                    #resultadoDetallado h4:contains("Valoración General") {
                        background: linear-gradient(135deg, #1e40af, #096879);
                        color: white;
                        margin-top: 2.5rem;
                        padding: 1.4rem;
                        border-radius: 16px;
                        text-align: center;
                        border: none;
                        font-size: 1.5rem;
                        box-shadow: 0 4px 15px rgba(9, 104, 121, 0.15);
                    }
                    #resultadoDetallado h4:contains("Valoración General") + p {
                        background: linear-gradient(135deg, #dbeafe, #f0f9ff);
                        color: #1e3a8a;
                        padding: 1.8rem !important;
                        border-radius: 16px;
                        margin-top: 0;
                        border: 1px solid #bfdbfe;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        gap: 1rem;
                        font-size: 1.25rem;
                        font-weight: 600;
                        box-shadow: inset 0 0 0 1px rgba(90, 146, 184, 0.2);
                    }
                    #resultadoDetallado h4:contains("Valoración General") + p strong {
                        color: #1e3a8a;
                        background: none !important;
                        padding: 0 !important;
                        font-size: 1.35rem;
                        font-weight: 700;
                        text-align: center;
                    }
                    .categoria-badge {
                        display: inline-block;
                        padding: 0.4rem 0.9rem;
                        border-radius: 18px;
                        font-size: 0.85rem;
                        font-weight: 600;
                        color: white;
                        text-align: center;
                        min-width: 90px;
                        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
                        background: linear-gradient(135deg, var(--badge-start), var(--badge-end));
                    }
                    .categoria-badge.muy-bajo { --badge-start: #c0392b; --badge-end: #e74c3c; }
                    .categoria-badge.bajo { --badge-start: #d35400; --badge-end: #f39c12; }
                    .categoria-badge.promedio { --badge-start: #27ae60; --badge-end: #8bc34a; }
                    .categoria-badge.alto { --badge-start: #0288d1; --badge-end: #81d4fa; }
                    .categoria-badge.muy-alto { --badge-start: #1565c0; --badge-end: #1e88e5; }
                    /* Estilos para el gráfico */
                    .container { max-width: 100%; margin: 2rem auto; }
                    .chart-card {
                        background: white;
                        border-radius: 12px; /* var(--border-radius, 12px); */
                        box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* var(--shadow, 0 4px 12px rgba(0,0,0,0.1)); */
                        padding: 24px;
                        margin-bottom: 30px;
                    }
                    .chart-header { margin-bottom: 20px; }
                    .chart-title { font-size: 1.5rem; font-weight: 600; color: #1e293b; } /* var(--text-primary, #1e293b); */
                    .chart-subtitle { font-size: 0.9rem; color: #64748b; } /* var(--text-secondary, #64748b); */
                    .chart-container { height: 400px; display: flex; align-items: center; justify-content: center; }
                    /* Estilos para resultados detallados (si se incluyen) */
                    .test-result {
                        display: flex;
                        align-items: center;
                        margin: 15px 0;
                        padding: 18px 20px;
                        border-radius: 14px;
                        background: linear-gradient(145deg, #ffffff, #f6f6f6);
                        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
                        flex-wrap: wrap;
                    }
                    .test-info { flex: 1; min-width: 250px; padding-right: 25px; }
                    .test-value { font-size: 26px; font-weight: 700; color: #222; }
                    .test-scale { flex: 2; height: 30px; background-color: rgba(255, 255, 255, 0.2); border-radius: 5px; overflow: visible; margin-bottom: 5px; box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2); }
                    .progress-segments { display: flex; height: 100%; border-radius: 5px; overflow: hidden; }
                    .segment { height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; transition: all 0.3s ease; position: relative; font-size: 0.8rem; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); }
                    .segment-labels { display: flex; justify-content: space-between; margin-top: 3px; margin-bottom: 5px; font-size: 0.9rem; }
                    .segment-label { text-align: center; font-weight: bold; flex: 1; color: #333; }
                    .arrow-indicator { position: absolute; top: -20px; width: 100%; height: 50px; pointer-events: none; color: black; z-index: 10; }
                    .arrow { width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 15px solid #080808; position: absolute; top: 0; filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5)); z-index: 10; }
                    .arrow-value { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background-color: #ffffff; color: #333; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; white-space: nowrap; z-index: 11; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }
                    .zone-indicator { display: inline-block; width: 14px; height: 14px; border-radius: 50%; margin-right: 6px; box-shadow: 0 0 3px rgba(0, 0, 0, 0.2); }
                    .category-badge { display: inline-block; padding: 3px 8px; border-radius: 15px; font-size: 12px; font-weight: bold; margin-left: 8px; color: white; min-width: 80px; text-align: center; }
                    .category-muy-bajo  { background: #e74c3c; }
                    .category-bajo      { background: #f39c12; }
                    .category-promedio  { background: #8bc34a; }
                    .category-alto      { background: #81d4fa; }
                    .category-muy-alto  { background: #1e88e5; }
        `;
        tempContainer.appendChild(styleTag);

        // Ahora, el contenido del body (sin las etiquetas <html>, <head>, <body>)
        tempContainer.innerHTML += `
                <h2>Resultados de Evaluación</h2>
                <h3>Evaluación Individual</h3>
                <div id="resultadoDetallado">
                    ${resultadoDetalladoElement.innerHTML}
                </div>
        `;

        // Añadir el gráfico de comparación si existe una imagen capturada
        if (chartDataURL) {
            tempContainer.innerHTML += `
                <div class="container">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div>
                                <h2 class="chart-title">Comparación de Resultados ALPHA-Fitness</h2>
                                <p class="chart-subtitle">Resultados del usuario vs. valores de referencia según el manual ALPHA-Fitness</p>
                            </div>
                        </div>
                        <div class="chart-container">
                            <img src="${chartDataURL}" alt="Gráfico de Comparación de Resultados" style="width: 100%; height: auto;">
                        </div>
                    </div>
                </div>
            `;
        } else {
            tempContainer.innerHTML += `<p style="text-align: center; color: red;">(Gráfico de Comparación no disponible)</p>`;
        }

        // Añadir los resultados visuales detallados si existen
        if (testResultsContainerElement && testResultsContainerElement.innerHTML.trim() !== "") {
             tempContainer.innerHTML += `<div id="testResultsContainer">${testResultsContainerElement.innerHTML}</div>`;
        }


        // Añadir el contenedor temporal al body
        document.body.appendChild(tempContainer);

        // Capturar el contenedor con html2canvas
        // Usar una escala adecuada para la calidad del PDF
        const canvas = await html2canvas(tempContainer, { scale: 2, useCORS: true }); // Aumentar escala para mejor calidad
        const imgData = canvas.toDataURL('image/jpeg', 0.95); // Convertir a JPEG con calidad 95%

        // Calcular dimensiones para el PDF
        const pdf = new jsPDF('p', 'mm', 'a4'); // Orientación vertical, unidades milímetros, tamaño A4
        const imgWidth = 210; // Ancho A4 en mm
        const pageHeight = 295; // Alto A4 en mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width; // Calcular altura proporcional
        let heightLeft = imgHeight;
        let position = 0;

        // Añadir la primera página
        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        // Si la imagen es más larga que una página, agregar nuevas páginas
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }

        // Guardar el PDF
        pdf.save('informe_evaluacion_individual.pdf');

    } catch (error) {
        console.error("Error generando el PDF del informe:", error);
        alert("Hubo un error al generar el PDF del informe. Por favor, inténtalo de nuevo. Detalles: " + error.message);
    } finally {
        // Ocultar el spinner (opcional)
         document.getElementById('pdf-spinner-container').style.display = 'none';

        // Eliminar el contenedor temporal del DOM
        const tempContainer = document.getElementById('temp-pdf-content');
        if (tempContainer && tempContainer.parentNode) {
            tempContainer.parentNode.removeChild(tempContainer);
        }
    }
}



// Función para generar el PDF de Estadísticas (Corregida)
async function generarPDFEstadisticasV2() {
    // Mostrar el spinner INMEDIATAMENTE
    document.getElementById('pdf-spinner-container').style.display = 'flex';

    try {
        const statsGridElement = document.getElementById('statsGrid');
        const distribucionChartElement = document.getElementById('distribucionEdadChart');
        const rendimientoChartElement = document.getElementById('rendimientoChart');
        const comparacionGeneroChartElement = document.getElementById('comparacionGeneroChart');

        if (!statsGridElement) {
            alert('No se encontró el contenedor de estadísticas.');
            return; // Importante: salir si no hay statsGrid
        }

        // Forzar actualización de gráficos si es necesario
        // Esto asegura que los canvas estén disponibles y dibujados
        actualizarAnalisis(); // Asegura que comparacionGeneroChart esté generado
        await new Promise(resolve => setTimeout(resolve, 1500)); // Aumentar el tiempo de espera a 1.5 segundos

        // Crear un contenedor temporal para el contenido a capturar
        const tempContainer = document.createElement('div');
        tempContainer.id = 'temp-pdf-content';
        tempContainer.style.position = 'absolute';
        tempContainer.style.left = '-9999px'; // Ocultar fuera de la vista
        tempContainer.style.top = '0';
        tempContainer.style.width = '210mm'; // A4 width
        tempContainer.style.backgroundColor = 'white';
        tempContainer.style.padding = '20px';
        tempContainer.style.boxSizing = 'border-box';
        tempContainer.style.display = 'flex'; // Usar flexbox para organizar elementos
        tempContainer.style.flexDirection = 'column'; // Apilar elementos verticalmente
        tempContainer.style.alignItems = 'center'; // Centrar elementos horizontalmente

        // Copiar el contenido de statsGrid
        const statsDiv = document.createElement('div');
        statsDiv.style.width = '100%'; // Ocupar ancho completo del contenedor
        statsDiv.style.marginBottom = '20px';
        statsDiv.innerHTML = `
            <h2 style="text-align: center; color: #2c3e50;">Estadísticas Generales - ALPHA Fitness</h2>
            ${statsGridElement.innerHTML}
        `;
        tempContainer.appendChild(statsDiv);

        // --- CAPTURAR Y AÑADIR GRÁFICOS INDIVIDUALMENTE (CORREGIDO) ---
        const chartElements = [
            { element: distribucionChartElement, title: 'Distribución por Edad' },
            { element: rendimientoChartElement, title: 'Rendimiento Promedio' },
            { element: comparacionGeneroChartElement, title: 'Comparación por Género' }
        ];

        for (const chart of chartElements) {
            // Añadir verificación de existencia y contexto del canvas
            if (chart.element && chart.element.getContext && chart.element.getContext('2d')) {
                try {
                    // Esperar un poco más para asegurar renderizado después de llamar a actualizarAnalisis
                    await new Promise(resolve => setTimeout(resolve, 800));
                    // Capturar directamente el canvas del gráfico con escala
                    const chartCanvas = await html2canvas(chart.element, { scale: 2, useCORS: true }); // Escala 2
                    const chartImgData = chartCanvas.toDataURL('image/jpeg', 0.95);

                    // Verificar si la imagen generada no está vacía
                    if (chartImgData && chartImgData !== 'data:,') {
                        // Crear un div para insertar la imagen capturada en el contenedor principal
                        const imgDiv = document.createElement('div');
                        imgDiv.style.textAlign = 'center';
                        imgDiv.style.width = '100%';
                        imgDiv.style.marginBottom = '20px';
                        imgDiv.innerHTML = `<h3 style="color: #34495e; margin-bottom: 10px;">${chart.title}</h3><img src="${chartImgData}" style="width: 100%; max-width: 600px; height: auto; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);" />`;
                        tempContainer.appendChild(imgDiv);
                    } else {
                        console.warn(`La imagen capturada para ${chart.title} está vacía.`);
                        const errorDiv = document.createElement('div');
                        errorDiv.style.textAlign = 'center';
                        errorDiv.style.width = '100%';
                        errorDiv.style.marginBottom = '20px';
                        errorDiv.innerHTML = `<h3 style="color: #34495e;">${chart.title}</h3><p style="color: red;">(Imagen no disponible)</p>`;
                        tempContainer.appendChild(errorDiv);
                    }

                } catch (e) {
                    console.error(`Error capturando imagen de ${chart.title}:`, e);
                    const errorDiv = document.createElement('div');
                    errorDiv.style.textAlign = 'center';
                    errorDiv.style.width = '100%';
                    errorDiv.style.marginBottom = '20px';
                    errorDiv.innerHTML = `<h3 style="color: #34495e;">${chart.title}</h3><p style="color: red;">Error al capturar imagen</p>`;
                    tempContainer.appendChild(errorDiv);
                }
            } else {
                 console.warn(`El canvas para ${chart.title} no se encontró o no es válido.`);
                 const errorDiv = document.createElement('div');
                 errorDiv.style.textAlign = 'center';
                 errorDiv.style.width = '100%';
                 errorDiv.style.marginBottom = '20px';
                 errorDiv.innerHTML = `<h3 style="color: #34495e;">${chart.title}</h3><p style="color: red;">Canvas no encontrado o inválido</p>`;
                 tempContainer.appendChild(errorDiv);
            }
        }


        // --- GENERACIÓN DE DATOS Y INSIGHTS ADICIONALES ---
        // CORRECCIÓN: Verificar el cálculo de promedioEdad
        console.log("Evaluaciones.length:", evaluaciones.length); // Debug
        if (evaluaciones.length === 0) {
            alert('No hay datos de evaluación para calcular estadísticas.');
            return; // Importante: salir si no hay evaluaciones
        }
        let edadSum = 0;
        let edadCountValid = 0;
        for (const e of evaluaciones) {
            const edad = getEdad(e.fechaNacimiento);
            console.log("Fecha Nacimiento:", e.fechaNacimiento, "Edad Calculada:", edad); // Debug
            if (!isNaN(edad) && edad > 0) { // Asegurar que la edad sea un número válido y positivo
                 edadSum += edad;
                 edadCountValid++;
            } else {
                 console.warn("Edad inválida encontrada:", e.fechaNacimiento, edad);
            }
        }
        const promedioEdad = edadCountValid > 0 ? edadSum / edadCountValid : 0; // Cálculo corregido
        console.log("Promedio Edad Calculado:", promedioEdad); // Debug

        const total = evaluaciones.length;
        const masculino = evaluaciones.filter(e => e.genero === 'masculino').length;
        const femenino = evaluaciones.filter(e => e.genero === 'femenino').length;
        const promedioIMC = evaluaciones.reduce((sum, e) => sum + calcularIMC(e.peso, e.altura), 0) / total;
        const promedioCardio = evaluaciones.reduce((sum, e) => sum + e.shuttle20m, 0) / total;
        const promedioSalto = evaluaciones.reduce((sum, e) => sum + e.salto, 0) / total;
        const promedioFuerza = evaluaciones.reduce((sum, e) => sum + e.fuerza, 0) / total;
        const promedioShuttle4x10 = evaluaciones.reduce((sum, e) => sum + e.shuttle4x10m, 0) / total;

        // Distribución por categorías
        let estadoFisicoCount = { 'Muy Deficiente': 0, 'Deficiente': 0, 'Adecuado': 0, 'Bueno': 0, 'Excelente': 0 };
        evaluaciones.forEach(e => {
            const edad = getEdad(e.fechaNacimiento);
            const edadRef = Math.max(edad, 13);
            const clasificacionCardio = getClasificacionCardio(e.shuttle20m, e.genero, edadRef);
            const clasificacionSalto = getClasificacionSalto(e.salto, e.genero, edadRef);
            const clasificacionFuerza = getClasificacionFuerza(e.fuerza, e.genero, edadRef);
            const clasificacionIMC = getClasificacionIMC(calcularIMC(e.peso, e.altura), e.genero, edadRef);
            const estado = evaluarEstadoFisico(clasificacionCardio, clasificacionSalto, clasificacionFuerza, clasificacionIMC);
            estadoFisicoCount[estado] = (estadoFisicoCount[estado] || 0) + 1;
        });
        const totalEvaluaciones = evaluaciones.length;
        let distribucionCategoriasHTML = '<h4 style="color: #3d566e;">Distribución por Categorías</h4><ul style="padding-left: 20px;">';
        for (const [categoria, count] of Object.entries(estadoFisicoCount)) {
             const porcentaje = totalEvaluaciones > 0 ? ((count / totalEvaluaciones) * 100).toFixed(1) : 0;
             distribucionCategoriasHTML += `<li>${categoria}: ${count} (${porcentaje}%)</li>`;
        }
        distribucionCategoriasHTML += '</ul>';

        // Área más desarrollada y área a mejorar (basado en promedios generales)
        const areasComparables = {
            'Cardio': promedioCardio,
            'Fuerza': promedioFuerza,
            'Salto': promedioSalto,
            'Shuttle 4x10m': promedioShuttle4x10 // "Menos es mejor", se invierte la lógica para interpretar fortaleza
        };
        const puntosAreas = {
            'Cardio': promedioCardio,
            'Fuerza': promedioFuerza,
            'Salto': promedioSalto,
            'Agilidad 4x10m': 30 - promedioShuttle4x10 // Renombrado para claridad
        };
        const areaMasDesarrollada = Object.keys(puntosAreas).reduce((a, b) => puntosAreas[a] > puntosAreas[b] ? a : b);
        const areaMejorar = Object.keys(puntosAreas).reduce((a, b) => puntosAreas[a] < puntosAreas[b] ? a : b);

        // Puntuación General Promedio (simplificada)
        const puntuacionCardio = (promedioCardio / 9) * 100;
        const puntuacionFuerza = (promedioFuerza / 50) * 100;
        const puntuacionSalto = (promedioSalto / 200) * 100;
        const puntuacionAgilidad = ((30 - promedioShuttle4x10) / 20) * 100;
        const puntuacionGeneralPromedio = (puntuacionCardio + puntuacionFuerza + puntuacionSalto + puntuacionAgilidad) / 4;

        // Insights y Recomendaciones (más específicos)
        let insightsHTML = '<h4 style="color: #3d566e;">Insights y Recomendaciones</h4><ul style="padding-left: 20px;">';
        insightsHTML += `<li><strong>Fortaleza Principal:</strong> El grupo muestra un rendimiento destacado en <em>${areaMasDesarrollada}</em>, lo cual es positivo para su desarrollo físico.</li>`;
        insightsHTML += `<li><strong>Oportunidad de Mejora:</strong> El rendimiento en <em>${areaMejorar}</em> presenta una oportunidad de mejora. Se recomienda enfocar intervenciones específicas en esta área.</li>`;
        const mejorCategoria = Object.keys(estadoFisicoCount).reduce((a, b) => estadoFisicoCount[a] > estadoFisicoCount[b] ? a : b);
        const porcentajeMejorCategoria = ((estadoFisicoCount[mejorCategoria] / totalEvaluaciones) * 100).toFixed(1);
        insightsHTML += `<li><strong>Mayor Nivel General:</strong> El ${porcentajeMejorCategoria}% del grupo alcanza la categoría de condición física "${mejorCategoria}".</li>`;
        const peorCategoria = Object.keys(estadoFisicoCount).reduce((a, b) => estadoFisicoCount[a] < estadoFisicoCount[b] ? a : b);
        const porcentajePeorCategoria = ((estadoFisicoCount[peorCategoria] / totalEvaluaciones) * 100).toFixed(1);
        insightsHTML += `<li><strong>Área General a Reforzar:</strong> Un ${porcentajePeorCategoria}% del grupo se encuentra en la categoría "${peorCategoria}". Es fundamental trabajar para mejorar este porcentaje.</li>`;
        insightsHTML += '</ul>';

        // --- FIN DE GENERACIÓN DE DATOS Y INSIGHTS ---

        const insightsDiv = document.createElement('div');
        insightsDiv.style.width = '100%'; // Ocupar ancho completo del contenedor
        insightsDiv.style.marginTop = '25px';
        insightsDiv.style.padding = '15px';
        insightsDiv.style.background = '#f9f9f9';
        insightsDiv.style.borderRadius = '8px';
        insightsDiv.style.borderLeft = '4px solid #3498db';
        insightsDiv.innerHTML = `
            <div style="margin-bottom: 25px; padding: 15px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #3498db;">
                <h3 style="color: #34495e;">Resultados Generales por Edad y Sexo</h3>
                <ul style="padding-left: 20px;">
                    <li><strong>Edad Promedio:</strong> ${promedioEdad.toFixed(1)} años</li>
                    <li><strong>Hombres:</strong> ${masculino} (${((masculino/total)*100).toFixed(1)}%)</li>
                    <li><strong>Mujeres:</strong> ${femenino} (${((femenino/total)*100).toFixed(1)}%)</li>
                </ul>
            </div>
            <div style="margin-bottom: 25px; padding: 15px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #3498db;">
                <h3 style="color: #34495e;">Panel de Rendimiento Físico</h3>
                <ul style="padding-left: 20px;">
                    <li><strong>Área más desarrollada:</strong> ${areaMasDesarrollada}</li>
                    <li><strong>Área a mejorar:</strong> ${areaMejorar}</li>
                    <li><strong>Puntuación General Promedio (sobre 100):</strong> ${puntuacionGeneralPromedio.toFixed(1)} </li>
                </ul>
            </div>
            ${distribucionCategoriasHTML}
            ${insightsHTML}
        `;
        tempContainer.appendChild(insightsDiv);

        // Añadir el contenedor temporal al body
        document.body.appendChild(tempContainer);

        // Usar html2canvas para capturar el contenedor temporal con escala
        // Asegurar que el contenedor esté completamente renderizado antes de capturar
        await new Promise(resolve => setTimeout(resolve, 500)); // Pequeña espera adicional
        const canvas = await html2canvas(tempContainer, { scale: 1.5, useCORS: true }); // Escala 1.5
        const imgData = canvas.toDataURL('image/jpeg', 0.95);

        // Crear el PDF con jsPDF en orientación VERTICAL ('p')
        const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' para portrait
        const imgWidth = 210; // Ancho A4 en mm
        const pageHeight = 295; // Alto A4 en mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width; // Calcula la altura proporcional

        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        // Si la imagen es más larga que una página, agregar nuevas páginas
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }

        // Guardar el PDF
        pdf.save('estadisticas_alpha_fitness.pdf');

    } catch (error) {
        console.error("Error generando el PDF:", error);
        alert("Hubo un error al generar el PDF. Por favor, inténtalo de nuevo. Detalles: " + error.message);
    } finally {
        // Ocultar el spinner SIEMPRE, ocurra o no un error
        document.getElementById('pdf-spinner-container').style.display = 'none';
        // Eliminar el contenedor temporal del DOM (dentro del finally para asegurar limpieza)
        const tempContainer = document.getElementById('temp-pdf-content');
        if (tempContainer && tempContainer.parentNode) {
            tempContainer.parentNode.removeChild(tempContainer);
        }
    }
}

// ... (otras funciones) ...

// Función para generar una vista temporal del Análisis y usar window.print() (Corregida)
async function generarPDFAnalisisV3() {
    // Mostrar el spinner INMEDIATAMENTE (usamos el mismo contenedor de spinner si es aceptable)
    document.getElementById('pdf-spinner-container').style.display = 'flex';

    try {
        // Forzar actualización de gráficos de análisis si es necesario
        // Usamos el filtro actual del select
        const filtroGeneroActual = document.getElementById('filtroGenero').value;
        actualizarAnalisis(); // Esto actualiza ambos gráficos en la pestaña de análisis

        // Esperar un tiempo para que se rendericen los gráficos
        await new Promise(resolve => setTimeout(resolve, 2000)); // Aumentar espera a 2 segundos

        // Capturar imágenes de los gráficos de análisis
        const analisisEdadChartCanvas = document.getElementById('analisisEdadChart');
        const comparacionGeneroChartCanvas = document.getElementById('comparacionGeneroChart');

        let analisisEdadDataURL = null;
        let comparacionGeneroDataURL = null;

        // Función auxiliar para esperar a que un gráfico de Chart.js termine de renderizar
        // Chart.js no tiene un evento "onrender" global, pero podemos esperar a que el contexto 2d tenga datos dibujados
        // o usar técnicas más avanzadas si es necesario. Por ahora, la espera + verificación de imagen vacía es un enfoque razonable.
        // Otra opción es usar Chart.js plugins o promesas personalizadas si se vuelve complejo.

        if (analisisEdadChartCanvas && analisisEdadChartCanvas.getContext('2d')) {
            try {
                // Espera adicional específica para este canvas
                await new Promise(resolve => setTimeout(resolve, 800));
                analisisEdadDataURL = analisisEdadChartCanvas.toDataURL('image/png');
                // Verificar si la imagen generada no está vacía
                if (!analisisEdadDataURL || analisisEdadDataURL === 'data:,') {
                    console.warn("La imagen de analisisEdadChart está vacía.");
                    analisisEdadDataURL = null; // Marcar como no disponible
                }
            } catch (e) {
                console.error("Error capturando imagen de analisisEdadChart:", e);
                analisisEdadDataURL = null; // Marcar como no disponible
            }
        } else {
             console.warn("analisisEdadChart no encontrado o no es un canvas.");
        }

        if (comparacionGeneroChartCanvas && comparacionGeneroChartCanvas.getContext('2d')) {
            try {
                await new Promise(resolve => setTimeout(resolve, 800)); // Espera adicional específica
                comparacionGeneroDataURL = comparacionGeneroChartCanvas.toDataURL('image/png');
                if (!comparacionGeneroDataURL || comparacionGeneroDataURL === 'data:,') {
                    console.warn("La imagen de comparacionGeneroChart está vacía.");
                    comparacionGeneroDataURL = null; // Marcar como no disponible
                }
            } catch (e) {
                console.error("Error capturando imagen de comparacionGeneroChart:", e);
                comparacionGeneroDataURL = null; // Marcar como no disponible
            }
        } else {
             console.warn("comparacionGeneroChart no encontrado o no es un canvas.");
        }

        // Verificar si hay imágenes para imprimir (opcional: si no hay imágenes, se puede continuar o detener)
        if (!analisisEdadDataURL && !comparacionGeneroDataURL) {
            console.warn("No se pudieron capturar las imágenes de los gráficos de análisis.");
            // Podrías mostrar un mensaje al usuario aquí si es crítico
            // alert("No se pudieron capturar los gráficos de análisis para la impresión.");
            // return; // O continuar sin gráficos si es aceptable
        }

        // Crear el contenedor temporal para la vista de impresión de análisis
        const tempPrintContainer = document.createElement('div');
        tempPrintContainer.id = 'analisis-imprimir-temp';
        tempPrintContainer.className = 'container';
        tempPrintContainer.style.display = 'none'; // Inicialmente oculto

        // Construir el HTML para impresión de análisis
        let htmlParaImpresion = `
            <h2>Análisis Detallado - ALPHA Fitness</h2>
            <div class="form-group">
                <label>Filtrado por Género:</label>
                <select disabled> <!-- Deshabilitar para la impresión -->
                    <option value="${filtroGeneroActual}" selected>${filtroGeneroActual.charAt(0).toUpperCase() + filtroGeneroActual.slice(1)}</option>
                </select>
            </div>
        `;

        // Añadir los gráficos de análisis si se capturaron imágenes
        if (analisisEdadDataURL) {
            htmlParaImpresion += `
                <div class="chart-container">
                    <h3>Rendimiento por Edad y Prueba (Filtrado: ${filtroGeneroActual})</h3>
                    <img src="${analisisEdadDataURL}" alt="Gráfico de Rendimiento por Edad y Prueba" />
                </div>
            `;
        } else {
            htmlParaImpresion += `<div class="chart-container"><h3>Rendimiento por Edad y Prueba (Filtrado: ${filtroGeneroActual})</h3><p>(Gráfico no disponible)</p></div>`;
        }

        if (comparacionGeneroDataURL) {
            htmlParaImpresion += `
                <div class="chart-container">
                    <h3>Comparación por Género (Filtrado: ${filtroGeneroActual})</h3>
                    <img src="${comparacionGeneroDataURL}" alt="Gráfico de Comparación por Género" />
                </div>
            `;
        } else {
            htmlParaImpresion += `<div class="chart-container"><h3>Comparación por Género (Filtrado: ${filtroGeneroActual})</h3><p>(Gráfico no disponible)</p></div>`;
        }

        tempPrintContainer.innerHTML = htmlParaImpresion;

        // Añadir el contenedor temporal al body
        document.body.appendChild(tempPrintContainer);

        // Ocultar el spinner ANTES de llamar a window.print()
        document.getElementById('pdf-spinner-container').style.display = 'none';

        // Llamar a window.print()
        window.print();

    } catch (error) {
        console.error("Error generando la vista de impresión para Análisis:", error);
        // Ocultar el spinner en caso de error
        document.getElementById('pdf-spinner-container').style.display = 'none';
        alert("Hubo un error al preparar la vista de impresión para Análisis. Por favor, inténtalo de nuevo. Detalles: " + error.message);
    } finally {
        // Remover el contenedor temporal después de la impresión (esperar un poco)
        // Importante: Esto ocurre DESPUÉS de window.print(), pero el diálogo de impresión puede estar abierto
        // La limpieza se hará de todas formas
        setTimeout(() => {
            const tempPrintContainer = document.getElementById('analisis-imprimir-temp');
            if (tempPrintContainer && tempPrintContainer.parentNode) {
                tempPrintContainer.parentNode.removeChild(tempPrintContainer);
            }
        }, 1000); // 1 segundo debería ser suficiente
    }
}

	


// Función para calcular y mostrar el siguiente ID disponible
function actualizarContadorSiguienteID() {
    // Reutiliza la lógica de generarID para encontrar el próximo número
    // Se basa en el array 'evaluaciones' que se carga desde Firestore
    const idsNumericos = evaluaciones
        .map(e => e.nombre)
        .filter(n => n && /^\d{5}$/.test(n)) // Asegura que sea exactamente 5 dígitos
        .map(n => parseInt(n, 10))
        .filter(n => !isNaN(n));

    const ultimoID = idsNumericos.length > 0
        ? Math.max(...idsNumericos) // Encuentra el número más alto
        : 0;

    const siguienteID = String(ultimoID + 1).padStart(5, '0'); // Ej: 10 -> "00010"

    // Actualiza el texto del span
    document.getElementById('contadorSiguienteID').innerHTML = `<strong>Próximo Test Usuario Nº: ${siguienteID}</strong>`;
}

// Función para validar si el formulario de registro está completo
function esFormularioRegistroCompleto() {
    const form = document.getElementById('fitnessForm');
    const requiredFields = form.querySelectorAll('input[required], select[required]');
    for (let field of requiredFields) {
        if (!field.value.trim()) {
            return false; // Si algún campo requerido está vacío, el formulario no está completo
        }
    }
    return true; // Todos los campos requeridos tienen valor
}


// --- Función de Autocompletado para el campo Nombre (ID) ---
function iniciarAutocompletado() {
    const inputNombre = document.getElementById("nombre");
    const modal = document.getElementById("modalSeleccionUsuario");
    const filtroInput = document.getElementById("filtroUsuarios");
    const listaUsuarios = document.getElementById("listaUsuarios");
    const cerrarBtn = document.getElementById("cerrarModalBtn");

    // Función para abrir el modal y llenar la lista
    function abrirModal() {
        modal.style.display = "block";
        // Llenar la lista con todos los IDs al abrir el modal
        llenarListaUsuarios("");
        filtroInput.value = ""; // Limpiar filtro al abrir
        filtroInput.focus(); // Enfocar el filtro
    }

    // Función para llenar la lista de usuarios en el modal
    function llenarListaUsuarios(filtro) {
        listaUsuarios.innerHTML = ""; // Limpiar lista anterior

        // Filtrar y ordenar evaluaciones
        let evaluacionesFiltradas = evaluaciones;
        if (filtro) {
            evaluacionesFiltradas = evaluaciones.filter(e => e.nombre.toLowerCase().includes(filtro.toLowerCase()));
        }

        // Ordenar por el número del ID (convertido a número para ordenar correctamente)
        evaluacionesFiltradas.sort((a, b) => {
            const numA = parseInt(a.nombre.match(/\d+/)[0], 10);
            const numB = parseInt(b.nombre.match(/\d+/)[0], 10);
            return numA - numB;
        });

        // Mostrar los resultados ordenados
        mostrarItemsEnLista(evaluacionesFiltradas);
    }

    // Función auxiliar para mostrar los items en la lista
    function mostrarItemsEnLista(evaluacionesArray) {
        evaluacionesArray.forEach(eval => {
            // Calcular edad a partir de la fecha de nacimiento
            const edad = getEdad(eval.fechaNacimiento);

            // Crear el texto a mostrar: ID - Género (Edad)
            const textoMostrar = `${eval.nombre} - ${eval.genero} (${edad} años)`;

            const itemDiv = document.createElement("div");
				itemDiv.textContent = textoMostrar;
				itemDiv.className = "lista-usuarios-item"; // Añadir la clase CSSm = "1px solid #eee";
				itemDiv.addEventListener("click", function() {
                // Rellenar el input con el ID (solo el nombre, no el texto adicional)
                inputNombre.value = eval.nombre;
                // Cerrar el modal
                modal.style.display = "none";
                // Rellenar el formulario con los datos del usuario seleccionado
                rellenarFormularioConDatos(eval);
                // Ir directamente a la pestaña de Resultados
                showTab('resultados');
                // Opcional: Procesar los resultados para mostrarlos inmediatamente
                procesarResultados(eval);
            });
            listaUsuarios.appendChild(itemDiv);
        });

        if (evaluacionesArray.length === 0) {
            const mensajeDiv = document.createElement("div");
            mensajeDiv.textContent = "No se encontraron usuarios.";
            mensajeDiv.style.padding = "10px";
            mensajeDiv.style.textAlign = "center";
            mensajeDiv.style.color = "#999";
            listaUsuarios.appendChild(mensajeDiv);
        }
    }

    // Evento para abrir el modal al hacer clic en el input
    inputNombre.addEventListener("click", function (e) {
        e.preventDefault(); // Evitar comportamiento por defecto del input
        abrirModal();
    });

    // Evento para filtrar la lista mientras se escribe en el filtro del modal
    filtroInput.addEventListener("input", function (e) {
        llenarListaUsuarios(this.value);
    });

    // Evento para cerrar el modal
    cerrarBtn.addEventListener("click", function() {
        modal.style.display = "none";
    });

    // Cerrar el modal si se hace clic fuera del contenido
    window.addEventListener("click", function(e) {
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });
}

// --- Función para rellenar el formulario con datos de una evaluación ---
function rellenarFormularioConDatos(datos) {
    // Asumiendo que el objeto 'datos' tiene las mismas claves que los IDs de los inputs
    document.getElementById("nombre").value = datos.nombre || "";
    document.getElementById("fechaNacimiento").value = datos.fechaNacimiento || "";
    document.getElementById("genero").value = datos.genero || "";
    document.getElementById("fechaEvaluacion").value = datos.fechaEvaluacion || "";
    document.getElementById("altura").value = datos.altura || "";
    document.getElementById("peso").value = datos.peso || "";
    document.getElementById("cintura").value = datos.cintura || "";
    document.getElementById("shuttle20m").value = datos.shuttle20m || "";
    document.getElementById("salto").value = datos.salto || "";
    document.getElementById("fuerza").value = datos.fuerza || "";
    document.getElementById("shuttle4x10m").value = datos.shuttle4x10m || "";
    // No se rellena el ID del documento Firestore (datos.id)
}

// Iniciar la funcionalidad de autocompletado cuando se haya cargado todo
document.addEventListener('DOMContentLoaded', iniciarAutocompletado);

async function importardata() {
    // Crear input de archivo si no existe
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.csv';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);

    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) {
            document.body.removeChild(fileInput);
            return;
        }

        // Mostrar spinner
        const spinnerContainer = document.getElementById('pdf-spinner-container');
        if (spinnerContainer) {
            spinnerContainer.querySelector('p').textContent = 'Procesando datos del CSV...';
            spinnerContainer.style.display = 'flex';
        }

        try {
            const text = await file.text();
            const lines = text.trim().split('\n');
            if (lines.length < 2) {
                alert('El archivo CSV está vacío o no tiene datos válidos.');
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim());
            const requiredFields = ['fechaNacimiento', 'genero', 'fechaEvaluacion', 'altura', 'peso', 'cintura', 'shuttle20m', 'salto', 'fuerza', 'shuttle4x10m'];
            const missingFields = requiredFields.filter(field => !headers.includes(field));
            if (missingFields.length > 0) {
                alert(`El CSV no contiene los campos obligatorios: ${missingFields.join(', ')}`);
                return;
            }

            // Obtener IDs numéricos existentes para determinar el próximo ID
            const idsNumericos = evaluaciones
                .map(e => e.nombre)
                .filter(n => n && /^\d{5}$/.test(n))
                .map(n => parseInt(n, 10))
                .filter(n => !isNaN(n));
            let nextID = idsNumericos.length > 0 ? Math.max(...idsNumericos) + 1 : 1;

            const nuevosRegistros = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length !== headers.length) continue;

				const row = {};
				headers.forEach((header, idx) => {
					let value = values[idx];
					if (header === 'fechaNacimiento' || header === 'fechaEvaluacion') {
						value = parseDDMMYYYY(value);
					}
					row[header] = value;
				});

                // Validar campos obligatorios
                if (requiredFields.some(field => !row[field])) continue;

                // Generar nombre/ID si no existe o está vacío
                let nombre = row['nombre'] || '';
                if (!nombre || !/^\d{5}$/.test(nombre)) {
                    nombre = String(nextID).padStart(5, '0');
                    nextID++;
                }

                const datos = {
                    nombre: nombre,
                    fechaNacimiento: row['fechaNacimiento'],
                    genero: row['genero'],
                    fechaEvaluacion: row['fechaEvaluacion'],
                    altura: parseFloat(row['altura']),
                    peso: parseFloat(row['peso']),
                    cintura: parseFloat(row['cintura']),
                    shuttle20m: parseFloat(row['shuttle20m']),
                    salto: parseInt(row['salto']),
                    fuerza: parseFloat(row['fuerza']),
                    shuttle4x10m: parseFloat(row['shuttle4x10m'])
                };

                // Validar tipos numéricos
                if (
                    isNaN(datos.altura) || isNaN(datos.peso) || isNaN(datos.cintura) ||
                    isNaN(datos.shuttle20m) || isNaN(datos.salto) || isNaN(datos.fuerza) || isNaN(datos.shuttle4x10m)
                ) {
                    console.warn(`Fila ${i + 1} omitida por datos numéricos inválidos.`);
                    continue;
                }

                nuevosRegistros.push(datos);
            }

            if (nuevosRegistros.length === 0) {
                alert('No se encontraron registros válidos para importar.');
                return;
            }

            // Guardar en Firestore
            for (const datos of nuevosRegistros) {
                try {
                    const docRef = await db.collection('evaluaciones').add(datos);
                    datos.id = docRef.id;
                    evaluaciones.push(datos);
                } catch (err) {
                    console.error('Error al guardar registro:', datos, err);
                }
            }

            // Actualizar contador de ID
            actualizarContadorSiguienteID();

            alert(`Se importaron ${nuevosRegistros.length} registros correctamente.`);
        } catch (error) {
            console.error('Error al procesar el archivo CSV:', error);
            alert('Ocurrió un error al procesar el archivo CSV. Revisa el formato.');
        } finally {
            // Ocultar spinner
            if (spinnerContainer) spinnerContainer.style.display = 'none';
            document.body.removeChild(fileInput);
        }
    };

    fileInput.click();
}

function parseDDMMYYYY(dateStr) {
    if (!dateStr) return '';
    const parts = dateStr.split('/');
    if (parts.length === 3) {
        const [day, month, year] = parts.map(Number);
        // Validar rango básico
        if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 1900 && year <= 2100) {
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }
    }
    return dateStr; // devolver tal cual si no coincide
}

function descargarModeloCSV() {
    const modelo = `nombre,fechaNacimiento,genero,fechaEvaluacion,altura,peso,cintura,shuttle20m,salto,fuerza,shuttle4x10m
,15/05/2010,masculino,06/10/2025,150.5,45.2,70,6,175,40,12
,22/08/2011,femenino,06/10/2025,145,40,65.5,4.5,130,25.5,13.2
,03/12/2009,masculino,06/10/2025,160,55,80,8,200,45,11.5`;

    const blob = new Blob([modelo], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', 'modelo_importar_alpha_fitness.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
    </script>
	
	


    <!-- Modal para buscar y seleccionar usuario -->
    <div id="modalSeleccionUsuario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Seleccionar Usuario</h3>
                <button id="cerrarModalBtn" class="close-modal">&times;</button>
            </div>
            <input type="text" id="filtroUsuarios" placeholder="Buscar por ID...">
            <div id="listaUsuarios">
                <!-- Aquí se llenará la lista de usuarios -->
            </div>
        </div>
    </div>

<!-- Contenedor del Spinner -->
    <div id="pdf-spinner-container" class="spinner-container" style="display: none;">
        <div class="spinner"></div>
        <p>Generando PDF, por favor espere...</p>
    </div>
</body>
</html>




