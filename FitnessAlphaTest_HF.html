
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPHA Fitness Test - Sistema de Evaluación</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        overflow: hidden;
    }
    .header {
        background: linear-gradient(90deg, #2c3e50, #3498db);
        color: white;
        padding: 20px;
        text-align: center;
    }
    .nav-tabs {
        display: flex;
        background: #ecf0f1;
        border-bottom: 2px solid #bdc3c7;
    }
    .tab-btn {
        flex: 1;
        padding: 15px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
    }
    .tab-btn.active {
        background: #3498db;
        color: white;
    }
    .tab-content {
        display: none;
        padding: 30px;
    }
    .tab-content.active {
        display: block;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .form-group input, .form-group select {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
    }
    .btn {
        background: #3498db;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
    }
    .btn:hover {
        background: #2980b9;
    }
    .btn-success {
        background: #27ae60;
    }
    .btn-warning {
        background: #f39c12;
    }
    .btn-danger {
        background: #e74c3c;
    }
    .result-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 20px;
        margin: 10px 0;
    }
    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    .stat-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 15px;
    }
    .hidden {
        display: none;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
    }
    th {
        background-color: #3498db;
        color: white;
    }
    tr:nth-child(even) {
        background-color: #f2f2f2;
    }
    .login-section {
        max-width: 400px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .login-section input {
        width: 100%;
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    .recommendations {
        background: #e8f5e8;
        border: 1px solid #27ae60;
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
    }
    .health-info {
        background: #f0f8ff;
        border: 1px solid #3498db;
        border-radius: 10px;
        padding: 15px;
        margin: 15px 0;
    }
    .comparison-chart {
        height: 300px;
        margin: 20px 0;
    }

   /* === Estilos base === */
.test-result {
    display: flex;
    align-items: center;
    margin: 15px 0;
    padding: 18px 20px;
    border-radius: 14px;
    background: linear-gradient(145deg, #ffffff, #f6f6f6);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    flex-wrap: wrap;
}

.test-result:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
}

/* === Información del test === */
.test-info {
    flex: 1;
    min-width: 250px;
    padding-right: 25px;
}

.test-value {
    font-size: 26px;
    font-weight: 700;
    color: #222;
}

/* === Barra principal === */
.test-scale {
    flex: 2;
    position: relative;
    height: 24px;
    border-radius: 12px;
    overflow: hidden;
    background: #e9ecef;
    box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.08);
}

.test-scale-inner {
    height: 100%;
    display: flex;
}

/* === Segmentos === */
.scale-segment {
    flex-grow: 1;
    height: 100%;
    position: relative;
    transition: background 0.3s ease;
}

.scale-segment::after {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    width: 1px;
    background: rgba(255, 255, 255, 0.4);
    right: 0;
}

.scale-segment:last-child::after {
    display: none;
}

/* === Paleta de colores refinada === */
.segment-very-low {
    background: linear-gradient(90deg, #ff5f6d, #ffc371);
}
.segment-low {
    background: linear-gradient(90deg, #ffcc00, #ffe066);
}
.segment-average {
    background: linear-gradient(90deg, #8bc34a, #b3ff66);
}
.segment-high {
    background: linear-gradient(90deg, #4dd0e1, #4db6ac);
}
.segment-very-high {
    background: linear-gradient(90deg, #42a5f5, #1e88e5);
}

/* === Marcador === */
.test-pointer {
    position: absolute;
    top: -3px;
    bottom: -3px;
    width: 4px;
    background: #222;
    border-radius: 2px;
    z-index: 10;
    transform: translateX(-50%);
    box-shadow: 0 0 6px rgba(0, 0, 0, 0.2);
    transition: left 0.4s ease;
}

/* === Etiquetas === */
.test-labels {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    margin-top: 8px;
    color: #555;
    font-weight: 500;
}

/* === Indicadores de zona === */
.zone-indicator {
    display: inline-block;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    margin-right: 6px;
    box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
}
/* === Indicadores de zona (5 niveles) === */
.zone-muy-bajo { background: #ff5f6d; }      /* rojo */
.zone-bajo { background: #ff9800; }         /* naranja */
.zone-promedio { background: #8bc34a; }     /* verde */
.zone-alto { background: #4dd0e1; }         /* azul claro */
.zone-muy-alto { background: #42a5f5; }     /* azul */

    .advice-box {
        background: #fff;
        border-left: 4px solid #3498db;
        padding: 15px;
        margin: 15px 0;
        border-radius: 5px;
    }
    .advice-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    .score-box {
        display: inline-block;
        background: #eee;
        padding: 5px 10px;
        border-radius: 5px;
        font-weight: bold;
        margin-left: 10px;
    }
   .category-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 8px;
    color: white;
    min-width: 80px;
    text-align: center;
}
.category-muy-bajo  { background: #ff5f6d; }  /* rojo */
.category-bajo      { background: #ff9800; }  /* naranja */
.category-promedio  { background: #8bc34a; }  /* verde */
.category-alto      { background: #4dd0e1; }  /* azul claro */
.category-muy-alto  { background: #42a5f5; }  /* azul */
       
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ALPHA Fitness Test - Sistema de Evaluación</h1>
            <p>Sistema de evaluación de condición física para niños y adolescentes</p>
        </div>

        <div id="loginSection" class="login-section">
            <h2>Inicio de Sesión (Admin)</h2>
            <input type="password" id="adminPassword" placeholder="Contraseña de administrador">
            <button class="btn" onclick="loginAdmin()">Iniciar Sesión</button>
        </div>

        <div id="mainContent" class="hidden">
            <div class="nav-tabs">
                <button class="tab-btn active" onclick="showTab('registro')">Registro</button>
                <button class="tab-btn" onclick="showTab('resultados')">Resultados</button>
                <button class="tab-btn" onclick="showTab('estadisticas')">Estadísticas</button>
                <button class="tab-btn" onclick="showTab('analisis')">Análisis Detallado</button>
            </div>

            <!-- Pestaña de Registro -->
            <div id="registro" class="tab-content active">
                <h2>Registro de Evaluación Física</h2>
                <form id="fitnessForm">
                    <div class="form-group">
                        <label>Nombre (ID):</label>
                        <input type="text" id="nombre" maxlength="30" placeholder="Opcional - Se generará ID automático si está vacío">
                    </div>
                    <div class="form-group">
                        <label>Fecha de Nacimiento:</label>
                        <input type="date" id="fechaNacimiento" required>
                    </div>
                    <div class="form-group">
                        <label>Género:</label>
                        <select id="genero" required>
                            <option value="">Seleccionar</option>
                            <option value="masculino">Masculino</option>
                            <option value="femenino">Femenino</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha de Evaluación:</label>
                        <input type="date" id="fechaEvaluacion" required>
                    </div>
                    <div class="form-group">
                        <label>Altura (cm):</label>
                        <input type="number" id="altura" step="0.1" min="80" max="220" required>
                    </div>
                    <div class="form-group">
                        <label>Peso (kg):</label>
                        <input type="number" id="peso" step="0.1" min="8" max="200" required>
                    </div>
                    <div class="form-group">
                        <label>Perímetro de Cintura (cm):</label>
                        <input type="number" id="cintura" step="0.1" min="40" max="130" required>
                    </div>
                    <div class="form-group">
                        <label>Test de 20m (etapas):</label>
                        <input type="number" id="shuttle20m" step="0.5" min="0" max="21" required>
                    </div>
                    <div class="form-group">
                        <label>Salto Horizontal (cm):</label>
                        <input type="number" id="salto" min="15" max="330" required>
                    </div>
                    <div class="form-group">
                        <label>Fuerza de Presión Manual (kg):</label>
                        <input type="number" id="fuerza" step="0.1" min="0" max="80" required>
                    </div>
                    <div class="form-group">
                        <label>4x10m Shuttle Run (seg):</label>
                        <input type="number" id="shuttle4x10m" step="0.1" min="10" max="30" required>
                    </div>
                    <button type="submit" class="btn btn-success">Guardar Evaluación</button>
                </form>
            </div>

            <!-- Pestaña de Resultados -->
                <div id="resultados" class="tab-content">
                    <h2>Resultados de Evaluación</h2>
                    <div id="resultadosIndividuales" class="result-card">
                        <h3>Evaluación Individual</h3>
                        <div id="resultadoDetallado"></div>
                        
                        <!-- Añadir este canvas para el gráfico de comparación -->
                        <div class="chart-container">
                            <canvas id="comparacionResultadosChart"></canvas>
                        </div>
                        
                        <div id="testResultsContainer"></div>
                        <div id="recomendaciones" class="recommendations"></div>
                        <div id="infoSalud" class="health-info"></div>
                    </div>
                </div>

            <!-- Pestaña de Estadísticas -->
            <div id="estadisticas" class="tab-content">
                <h2>Estadísticas Generales</h2>
                <button class="btn btn-warning" onclick="exportToCSV()">Exportar a CSV</button>
                <div class="stats-grid" id="statsGrid"></div>
                <div class="chart-container">
                    <canvas id="distribucionEdadChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="rendimientoChart"></canvas>
                </div>
            </div>

            <!-- Pestaña de Análisis -->
            <div id="analisis" class="tab-content">
                <h2>Análisis Detallado</h2>
                <div class="form-group">
                    <label>Filtrar por Género:</label>
                    <select id="filtroGenero" onchange="actualizarAnalisis()">
                        <option value="todos">Todos</option>
                        <option value="masculino">Masculino</option>
                        <option value="femenino">Femenino</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="analisisEdadChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="comparacionGeneroChart"></canvas>
                </div>
            </div>
        </div>
    </div>

   <script>
    // Inicializar Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyB7_2xZ9nkbXLftOoXoLoOsHMc2nikjBU8",
        authDomain: "alphatest-3ca83.firebaseapp.com",
        projectId: "alphatest-3ca83",
        storageBucket: "alphatest-3ca83.firebasestorage.app",
        messagingSenderId: "679232754727",
        appId: "1:679232754727:web:6c2a6f8ab9ad188814aa02",
        measurementId: "G-B2BC0HZ5HY"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let evaluaciones = [];
    let distribucionEdadChart, rendimientoChart, analisisEdadChart, comparacionGeneroChart, comparacionResultadosChart;
    let isAdmin = false;

    // Función de login
    function loginAdmin() {
        const password = document.getElementById('adminPassword').value;
        // Contraseña de ejemplo - en producción usar autenticación segura
        if (password === 'admin123') {
            isAdmin = true;
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').classList.remove('hidden');
            cargarEvaluaciones();
        } else {
            alert('Contraseña incorrecta');
        }
    }

    // Generar ID único si el nombre está vacío
    function generarID() {
        const idsExistentes = evaluaciones.map(e => e.nombre).filter(n => n && n.startsWith('0000'));
        const ultimoID = idsExistentes
            .map(id => parseInt(id.replace('0000', '')))
            .sort((a, b) => b - a)[0] || 0;
        const nuevoNumero = ultimoID + 1;
        return `0000${nuevoNumero}`.slice(-5);
    }

    // Cálculo del IMC
    function calcularIMC(peso, altura) {
        const alturaM = altura / 100;
        return peso / (alturaM * alturaM);
    }

    // Cálculo de la clasificación de IMC según el documento
    function getClasificacionIMC(imc, genero, edad) {
        // Si la edad es menor a 13, usar los valores de 13
        const edadParaClasificacion = Math.max(edad, 13);
        const clasificaciones = {
            'masculino': {
                13: { muy_bajo_max: 16.7, bajo_max: 18.0, promedio_max: 22.2, alto_max: 25.7 },
                14: { muy_bajo_max: 17.5, bajo_max: 19.0, promedio_max: 23.3, alto_max: 26.5 },
                15: { muy_bajo_max: 17.9, bajo_max: 19.5, promedio_max: 23.8, alto_max: 26.7 },
                16: { muy_bajo_max: 18.0, bajo_max: 19.6, promedio_max: 23.7, alto_max: 26.4 },
                17: { muy_bajo_max: 19.0, bajo_max: 20.5, promedio_max: 24.6, alto_max: 27.5 }
            },
            'femenino': {
                13: { muy_bajo_max: 17.5, bajo_max: 19.0, promedio_max: 23.2, alto_max: 26.4 },
                14: { muy_bajo_max: 17.6, bajo_max: 18.9, promedio_max: 22.8, alto_max: 25.6 },
                15: { muy_bajo_max: 18.1, bajo_max: 19.4, promedio_max: 23.0, alto_max: 25.6 },
                16: { muy_bajo_max: 18.3, bajo_max: 19.6, promedio_max: 23.1, alto_max: 25.8 },
                17: { muy_bajo_max: 18.2, bajo_max: 19.5, promedio_max: 23.2, alto_max: 25.8 }
            }
        };

        if (!clasificaciones[genero] || !clasificaciones[genero][edadParaClasificacion]) {
            return 'No clasificado';
        }

        const lim = clasificaciones[genero][edadParaClasificacion];

        if (imc <= lim.muy_bajo_max) return 'Muy Bajo';
        if (imc <= lim.bajo_max) return 'Bajo';
        if (imc <= lim.promedio_max) return 'Promedio';
        if (imc <= lim.alto_max) return 'Alto';
        return 'Muy Alto';
    }

    // Cálculo de la clasificación del perímetro de cintura
    function getClasificacionCintura(valor, genero, edad) {
        // Si la edad es menor a 13, usar los valores de 13
        const edadParaClasificacion = Math.max(edad, 13);
        const clasificaciones = {
            'masculino': {
                13: { muy_bajo_max: 62, bajo_max: 66, promedio_max: 78, alto_max: 87 },
                14: { muy_bajo_max: 65, bajo_max: 69, promedio_max: 80, alto_max: 88 },
                15: { muy_bajo_max: 67, bajo_max: 71, promedio_max: 81, alto_max: 89 },
                16: { muy_bajo_max: 67, bajo_max: 71, promedio_max: 81, alto_max: 88 },
                17: { muy_bajo_max: 70, bajo_max: 73, promedio_max: 83, alto_max: 91 }
            },
            'femenino': {
                13: { muy_bajo_max: 61, bajo_max: 65, promedio_max: 75, alto_max: 83 },
                14: { muy_bajo_max: 61, bajo_max: 64, promedio_max: 73, alto_max: 80 },
                15: { muy_bajo_max: 63, bajo_max: 66, promedio_max: 75, alto_max: 81 },
                16: { muy_bajo_max: 63, bajo_max: 66, promedio_max: 75, alto_max: 81 },
                17: { muy_bajo_max: 62, bajo_max: 65, promedio_max: 74, alto_max: 80 }
            }
        };

        if (!clasificaciones[genero] || !clasificaciones[genero][edadParaClasificacion]) {
            return 'No clasificado';
        }

        const lim = clasificaciones[genero][edadParaClasificacion];

        if (valor <= lim.muy_bajo_max) return 'Muy Bajo';
        if (valor <= lim.bajo_max) return 'Bajo';
        if (valor <= lim.promedio_max) return 'Promedio';
        if (valor <= lim.alto_max) return 'Alto';
        return 'Muy Alto';
    }

    // Cálculo de la clasificación del test de cardio
    function getClasificacionCardio(valor, genero, edad) {
        // Si la edad es menor a 13, usar los valores de 13
        const edadParaClasificacion = Math.max(edad, 13);
        const clasificaciones = {
            'masculino': {
                13: { muy_bajo_max: 3.0, bajo_max: 4.5, promedio_max: 6.0, alto_max: 7.5 },
                14: { muy_bajo_max: 3.5, bajo_max: 5.5, promedio_max: 6.5, alto_max: 8.5 },
                15: { muy_bajo_max: 4.0, bajo_max: 5.5, promedio_max: 7.0, alto_max: 8.5 },
                16: { muy_bajo_max: 4.0, bajo_max: 5.5, promedio_max: 7.0, alto_max: 8.5 },
                17: { muy_bajo_max: 4.5, bajo_max: 6.0, promedio_max: 7.5, alto_max: 9.0 }
            },
            'femenino': {
                13: { muy_bajo_max: 2.0, bajo_max: 2.5, promedio_max: 3.5, alto_max: 4.5 },
                14: { muy_bajo_max: 2.0, bajo_max: 3.0, promedio_max: 4.0, alto_max: 5.0 },
                15: { muy_bajo_max: 2.0, bajo_max: 3.0, promedio_max: 4.0, alto_max: 5.0 },
                16: { muy_bajo_max: 2.0, bajo_max: 3.0, promedio_max: 4.0, alto_max: 5.0 },
                17: { muy_bajo_max: 2.0, bajo_max: 3.0, promedio_max: 4.0, alto_max: 5.0 }
            }
        };

        if (!clasificaciones[genero] || !clasificaciones[genero][edadParaClasificacion]) {
            return 'No clasificado';
        }

        const lim = clasificaciones[genero][edadParaClasificacion];

        if (valor <= lim.muy_bajo_max) return 'Muy Bajo';
        if (valor <= lim.bajo_max) return 'Bajo';
        if (valor <= lim.promedio_max) return 'Promedio';
        if (valor <= lim.alto_max) return 'Alto';
        return 'Muy Alto';
    }

    // Cálculo de la clasificación de fuerza manual
    function getClasificacionFuerza(valor, genero, edad) {
        // Si la edad es menor a 13, usar los valores de 13
        const edadParaClasificacion = Math.max(edad, 13);
        const clasificaciones = {
            'masculino': {
                13: { muy_bajo_max: 21.4, bajo_max: 24.7, promedio_max: 27.8, alto_max: 31.8 },
                14: { muy_bajo_max: 26.3, bajo_max: 30.4, promedio_max: 34.0, alto_max: 38.5 },
                15: { muy_bajo_max: 31.3, bajo_max: 35.7, promedio_max: 39.7, alto_max: 44.3 },
                16: { muy_bajo_max: 35.9, bajo_max: 40.0, promedio_max: 43.7, alto_max: 48.1 },
                17: { muy_bajo_max: 39.9, bajo_max: 43.5, promedio_max: 46.7, alto_max: 50.6 }
            },
            'femenino': {
                13: { muy_bajo_max: 19.9, bajo_max: 22.5, promedio_max: 24.8, alto_max: 27.6 },
                14: { muy_bajo_max: 21.5, bajo_max: 24.1, promedio_max: 26.4, alto_max: 29.2 },
                15: { muy_bajo_max: 22.5, bajo_max: 25.1, promedio_max: 27.4, alto_max: 30.3 },
                16: { muy_bajo_max: 22.9, bajo_max: 25.4, promedio_max: 27.8, alto_max: 30.8 },
                17: { muy_bajo_max: 23.9, bajo_max: 26.4, promedio_max: 28.9, alto_max: 32.1 }
            }
        };

        if (!clasificaciones[genero] || !clasificaciones[genero][edadParaClasificacion]) {
            return 'No clasificado';
        }

        const lim = clasificaciones[genero][edadParaClasificacion];

        if (valor <= lim.muy_bajo_max) return 'Muy Bajo';
        if (valor <= lim.bajo_max) return 'Bajo';
        if (valor <= lim.promedio_max) return 'Promedio';
        if (valor <= lim.alto_max) return 'Alto';
        return 'Muy Alto';
    }

    // Cálculo de la clasificación del salto
    function getClasificacionSalto(valor, genero, edad) {
        // Si la edad es menor a 13, usar los valores de 13
        const edadParaClasificacion = Math.max(edad, 13);
        const clasificaciones = {
            'masculino': {
                13: { muy_bajo_max: 135, bajo_max: 152, promedio_max: 167, alto_max: 184 },
                14: { muy_bajo_max: 151, bajo_max: 169, promedio_max: 183, alto_max: 200 },
                15: { muy_bajo_max: 165, bajo_max: 182, promedio_max: 196, alto_max: 212 },
                16: { muy_bajo_max: 175, bajo_max: 192, promedio_max: 206, alto_max: 221 },
                17: { muy_bajo_max: 184, bajo_max: 201, promedio_max: 215, alto_max: 229 }
            },
            'femenino': {
                13: { muy_bajo_max: 118, bajo_max: 133, promedio_max: 147, alto_max: 163 },
                14: { muy_bajo_max: 121, bajo_max: 137, promedio_max: 151, alto_max: 167 },
                15: { muy_bajo_max: 123, bajo_max: 138, promedio_max: 151, alto_max: 167 },
                16: { muy_bajo_max: 126, bajo_max: 141, promedio_max: 154, alto_max: 169 },
                17: { muy_bajo_max: 129, bajo_max: 144, promedio_max: 157, alto_max: 172 }
            }
        };

        if (!clasificaciones[genero] || !clasificaciones[genero][edadParaClasificacion]) {
            return 'No clasificado';
        }

        const lim = clasificaciones[genero][edadParaClasificacion];

        if (valor <= lim.muy_bajo_max) return 'Muy Bajo';
        if (valor <= lim.bajo_max) return 'Bajo';
        if (valor <= lim.promedio_max) return 'Promedio';
        if (valor <= lim.alto_max) return 'Alto';
        return 'Muy Alto';
    }

    // Cálculo de la clasificación del shuttle 4x10m (menores tiempos son mejores)
    function getClasificacionShuttle4x10(valor, genero, edad) {
        // Si la edad es menor a 13, usar los valores de 13
        const edadParaClasificacion = Math.max(edad, 13);
        const clasificaciones = {
            'masculino': {
                13: { muy_bajo_min: 13.0, bajo_min: 12.3, promedio_min: 11.8, alto_min: 11.2 },
                14: { muy_bajo_min: 12.6, bajo_min: 11.9, promedio_min: 11.4, alto_min: 10.9 },
                15: { muy_bajo_min: 12.1, bajo_min: 11.5, promedio_min: 11.0, alto_min: 10.5 },
                16: { muy_bajo_min: 11.8, bajo_min: 11.1, promedio_min: 10.7, alto_min: 10.2 },
                17: { muy_bajo_min: 11.8, bajo_min: 11.1, promedio_min: 10.7, alto_min: 10.2 }
            },
            'femenino': {
                13: { muy_bajo_min: 13.9, bajo_min: 13.1, promedio_min: 12.5, alto_min: 11.9 },
                14: { muy_bajo_min: 13.8, bajo_min: 13.0, promedio_min: 12.4, alto_min: 11.8 },
                15: { muy_bajo_min: 13.7, bajo_min: 13.0, promedio_min: 12.4, alto_min: 11.8 },
                16: { muy_bajo_min: 13.6, bajo_min: 12.9, promedio_min: 12.3, alto_min: 11.7 },
                17: { muy_bajo_min: 13.5, bajo_min: 12.9, promedio_min: 12.4, alto_min: 11.8 }
            }
        };

        if (!clasificaciones[genero] || !clasificaciones[genero][edadParaClasificacion]) {
            return 'No clasificado';
        }

        const lim = clasificaciones[genero][edadParaClasificacion];

        if (valor >= lim.muy_bajo_min) return 'Muy Bajo';
        if (valor >= lim.bajo_min) return 'Bajo';
        if (valor >= lim.promedio_min) return 'Promedio';
        if (valor >= lim.alto_min) return 'Alto';
        return 'Muy Alto';
    }

    // Obtener edad a partir de fecha de nacimiento
    function getEdad(fechaNacimiento) {
        const nacimiento = new Date(fechaNacimiento);
        const hoy = new Date();
        let edad = hoy.getFullYear() - nacimiento.getFullYear();
        const mes = hoy.getMonth() - nacimiento.getMonth();
        if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
            edad--;
        }
        return edad;
    }
    // Función para obtener la edad de referencia (mínimo 13 años)
    function getEdadReferencia(edad) {
        return Math.max(edad, 13);
    }
    // Procesar y mostrar resultados
   // Procesar y mostrar resultados
function procesarResultados(datos) {
    const edad = getEdad(datos.fechaNacimiento);
    const edadRef = Math.max(edad, 13); // <-- NUEVO: mapear a 13 si es menor

    const imc = calcularIMC(datos.peso, datos.altura);
    const clasificacionIMC = getClasificacionIMC(imc, datos.genero, edadRef);
    const clasificacionCintura = getClasificacionCintura(datos.cintura, datos.genero, edadRef);
    const clasificacionCardio = getClasificacionCardio(datos.shuttle20m, datos.genero, edadRef);
    const clasificacionSalto = getClasificacionSalto(datos.salto, datos.genero, edadRef);
    const clasificacionFuerza = getClasificacionFuerza(datos.fuerza, datos.genero, edadRef);
    const clasificacionShuttle4x10 = getClasificacionShuttle4x10(datos.shuttle4x10m, datos.genero, edadRef);

    const resultado = `
        <h4>Evaluación de: ${datos.nombre}</h4>
        <p><strong>Edad:</strong> ${edad} años</p>
        <p><strong>Género:</strong> ${datos.genero}</p>
        <h4>Resultados y Clasificaciones:</h4>
        <p><strong>IMC:</strong> ${imc.toFixed(2)} - Categoría: ${clasificacionIMC}</p>
        <p><strong>Perímetro de Cintura:</strong> ${datos.cintura} cm - Categoría: ${clasificacionCintura}</p>
        <p><strong>Cardiorespiratorio:</strong> ${datos.shuttle20m} etapas - Categoría: ${clasificacionCardio}</p>
        <p><strong>Salto Horizontal:</strong> ${datos.salto} cm - Categoría: ${clasificacionSalto}</p>
        <p><strong>Fuerza Manual:</strong> ${datos.fuerza} kg - Categoría: ${clasificacionFuerza}</p>
        <p><strong>Shuttle 4x10m:</strong> ${datos.shuttle4x10m} seg - Categoría: ${clasificacionShuttle4x10}</p>
        <h4>Valoración General:</h4>
        <p>El estado físico general del usuario se clasifica como: <strong>${evaluarEstadoFisico(clasificacionCardio, clasificacionSalto, clasificacionFuerza, clasificacionIMC)}</strong></p>
    `;
    document.getElementById('resultadoDetallado').innerHTML = resultado;

    // Mostrar gráfico de comparación (usando edadRef)
    mostrarGraficoComparacion(datos, edadRef);
    mostrarRecomendaciones(datos, clasificacionCardio, clasificacionSalto, clasificacionFuerza, clasificacionIMC, clasificacionCintura, clasificacionShuttle4x10);
    mostrarInfoSalud(datos, clasificacionCardio, clasificacionSalto, clasificacionFuerza, clasificacionIMC, clasificacionCintura, clasificacionShuttle4x10);
    
    // Mostrar resultados detallados (usando edadRef)
    mostrarResultadosDetallados(datos, edadRef);
}

    // Mostrar resultados detallados con barras de progreso
    function mostrarResultadosDetallados(datos, edadRef) {
        const container = document.getElementById('testResultsContainer');
        container.innerHTML = '';

        const genero = datos.genero;

        // Test de 20m Shuttle Run
        const cardioResult = crearResultadoTest(
            '20-m Shuttle run',
            '20 metros de ida y vuelta',
            datos.shuttle20m,
            'etapas',
            genero,
            edad,
            'cardio'
        );
        container.appendChild(cardioResult);

        // Salto Horizontal
        const saltoResult = crearResultadoTest(
            'Standing long jump',
            'Salto de longitud a pies juntos',
            datos.salto,
            'cm',
            genero,
            edad,
            'salto'
        );
        container.appendChild(saltoResult);

        // Fuerza de prensión manual
        const fuerzaResult = crearResultadoTest(
            'Handgrip',
            'Fuerza de presión manual',
            datos.fuerza,
            'kg',
            genero,
            edad,
            'fuerza'
        );
        container.appendChild(fuerzaResult);

        // Perímetro de cintura
        const cinturaResult = crearResultadoTest(
            'Waist circumference',
            'Perímetro de cintura',
            datos.cintura,
            'cm',
            genero,
            edad,
            'cintura'
        );
        container.appendChild(cinturaResult);

        // IMC
        const imcResult = crearResultadoTest(
            'Body Mass Index',
            'Índice de Masa Corporal',
            calcularIMC(datos.peso, datos.altura),
            '',
            genero,
            edad,
            'imc'
        );
        container.appendChild(imcResult);

        // Shuttle 4x10m
        const shuttle4x10Result = crearResultadoTest(
            '4x10m shuttle run',
            'Test de velocidad/agilidad',
            datos.shuttle4x10m,
            'seg',
            genero,
            edad,
            'shuttle4x10'
        );
        container.appendChild(shuttle4x10Result);
    }

    // Crear elemento de resultado de test con barra de progreso
   // Crear elemento de resultado de test con escala visual
// Crear elemento de resultado de test con escala visual
function crearResultadoTest(nombre, descripcion, valor, unidad, genero, edad, tipo) {
    const div = document.createElement('div');
    div.className = 'test-result';

    // Información del test
    const infoDiv = document.createElement('div');
    infoDiv.className = 'test-info';
    const titulo = document.createElement('h4');
    titulo.textContent = nombre;
    infoDiv.appendChild(titulo);
    const desc = document.createElement('p');
    desc.textContent = descripcion;
    infoDiv.appendChild(desc);
    const valorDiv = document.createElement('div');
    valorDiv.className = 'test-value';
    valorDiv.innerHTML = `${valor} ${unidad}`;
    infoDiv.appendChild(valorDiv);

    // === Obtener clasificación real usando la edad de referencia ===
    const edadRef = Math.max(edad, 13); // Mapear edades <13 a 13
    let clasificacion = '';
    switch (tipo) {
        case 'cardio':       clasificacion = getClasificacionCardio(valor, genero, edadRef); break;
        case 'salto':        clasificacion = getClasificacionSalto(valor, genero, edadRef); break;
        case 'fuerza':       clasificacion = getClasificacionFuerza(valor, genero, edadRef); break;
        case 'cintura':      clasificacion = getClasificacionCintura(valor, genero, edadRef); break;
        case 'imc':          clasificacion = getClasificacionIMC(valor, genero, edadRef); break;
        case 'shuttle4x10':  clasificacion = getClasificacionShuttle4x10(valor, genero, edadRef); break;
        default:             clasificacion = 'No clasificado';
    }

    // Badge de clasificación con color alineado
    const badge = document.createElement('span');
    const categoriaAClase = {
        'Muy Bajo': 'muy-bajo',
        'Bajo': 'bajo',
        'Promedio': 'promedio',
        'Alto': 'alto',
        'Muy Alto': 'muy-alto'
    };
    const claseBadge = categoriaAClase[clasificacion] || 'muy-bajo';
    badge.className = `category-badge category-${claseBadge}`;
    badge.textContent = clasificacion;
    infoDiv.appendChild(badge);
    div.appendChild(infoDiv);

    // === Escala visual con 5 segmentos coloreados ===
    const scaleDiv = document.createElement('div');
    scaleDiv.className = 'test-scale';

    // Definir min/max para cálculo de posición (usar edadRef)
    let minVal, maxVal;
    switch(tipo) {
        case 'cardio':      minVal = 0;   maxVal = 21; break;
        case 'salto':       minVal = 15;  maxVal = 330; break;
        case 'fuerza':      minVal = 0;   maxVal = 80; break;
        case 'cintura':     minVal = 40;  maxVal = 130; break;
        case 'imc':         minVal = 15;  maxVal = 30; break;
        case 'shuttle4x10': minVal = 10;  maxVal = 15; break;
        default:            minVal = 0;   maxVal = 100;
    }

    // Posición del puntero
    const posicion = ((valor - minVal) / (maxVal - minVal)) * 100;
    const pointer = document.createElement('div');
    pointer.className = 'test-pointer';
    pointer.style.left = `${posicion}%`;
    scaleDiv.appendChild(pointer);

    // Contenedor de los 5 segmentos coloreados
    const scaleInner = document.createElement('div');
    scaleInner.className = 'test-scale-inner';
    ['very-low', 'low', 'average', 'high', 'very-high'].forEach(seg => {
        const segDiv = document.createElement('div');
        segDiv.className = `scale-segment segment-${seg}`;
        scaleInner.appendChild(segDiv);
    });
    scaleDiv.appendChild(scaleInner);

    // Etiquetas de la escala
    const labelsDiv = document.createElement('div');
    labelsDiv.className = 'test-labels';
    labelsDiv.innerHTML = `<span>${minVal}</span><span>${maxVal}</span>`;
    scaleDiv.appendChild(labelsDiv);
    div.appendChild(scaleDiv);

    // === Zona de salud con 5 colores ===
    const zonaDiv = document.createElement('div');
    zonaDiv.style.display = 'flex';
    zonaDiv.style.alignItems = 'center';
    zonaDiv.style.marginTop = '10px';

    const zonaIndicator = document.createElement('div');
    const claseZona = categoriaAClase[clasificacion] || 'muy-bajo';
    zonaIndicator.className = `zone-indicator zone-${claseZona}`;

    const zonaText = document.createElement('span');
    zonaText.textContent = `Categoría: ${clasificacion}`;

    // Puntuación numérica
    const scoreMap = { 'Muy Bajo': 0, 'Bajo': 25, 'Promedio': 50, 'Alto': 75, 'Muy Alto': 100 };
    const score = scoreMap[clasificacion] || 0;
    const scoreSpan = document.createElement('span');
    scoreSpan.className = 'score-box';
    scoreSpan.textContent = `${score} Puntos`;

    zonaDiv.appendChild(zonaIndicator);
    zonaDiv.appendChild(zonaText);
    zonaDiv.appendChild(scoreSpan);
    div.appendChild(zonaDiv);

    // === Consejo basado en la categoría ===
    const adviceDiv = document.createElement('div');
    adviceDiv.className = 'advice-box';
    const adviceTitle = document.createElement('div');
    adviceTitle.className = 'advice-title';
    adviceTitle.textContent = 'Consejo:';
    let adviceText = '';

    if (clasificacion === 'Muy Bajo' || clasificacion === 'Bajo') {
        adviceText = 'Tu puntuación está en la zona de mejora. Es importante trabajar en este componente de la condición física. Habla con tu profesor/a de Educación Física para diseñar un plan de mejora personalizado.';
    } else if (clasificacion === 'Promedio') {
        adviceText = 'Tu puntuación es adecuada. ¡Sigue practicando actividades físicas regularmente para mantener y mejorar tu nivel!';
    } else {
        adviceText = '¡Excelente! Has obtenido una puntuación alta en este componente. Sigue así y considera retos más avanzados para seguir progresando.';
    }

    const adviceContent = document.createElement('div');
    adviceContent.textContent = adviceText;
    adviceDiv.appendChild(adviceTitle);
    adviceDiv.appendChild(adviceContent);
    div.appendChild(adviceDiv);

    return div;
}

    // Mostrar gráfico de comparación de resultados
    function mostrarGraficoComparacion(datos, edadRef) {
        const ctx = document.getElementById('comparacionResultadosChart').getContext('2d');
        if (comparacionResultadosChart) comparacionResultadosChart.destroy();

        const genero = datos.genero;

        // Incluir shuttle4x10m en los resultados
        const resultados = [
            calcularIMC(datos.peso, datos.altura),
            datos.cintura,
            datos.shuttle20m,
            datos.salto,
            datos.fuerza,
            datos.shuttle4x10m // <-- Añadido aquí
        ];

        // Obtener valores de referencia para la edad y género (usando el punto medio de la categoría "Promedio")
        let refIMC, refCintura, refCardio, refSalto, refFuerza, refShuttle4x10;

        if (genero === 'masculino') {
        switch(edadRef) {
            case 13: refIMC = 22.2; refCintura = 78; refCardio = 6.0; refSalto = 167; refFuerza = 27.8; refShuttle4x10 = 12.0; break;
            case 14: refIMC = 23.3; refCintura = 80; refCardio = 6.5; refSalto = 183; refFuerza = 34.0; refShuttle4x10 = 11.6; break;
            case 15: refIMC = 23.8; refCintura = 81; refCardio = 7.0; refSalto = 196; refFuerza = 39.7; refShuttle4x10 = 11.2; break;
            case 16: refIMC = 23.7; refCintura = 81; refCardio = 7.0; refSalto = 206; refFuerza = 43.7; refShuttle4x10 = 10.85; break;
            case 17: refIMC = 24.6; refCintura = 83; refCardio = 7.5; refSalto = 215; refFuerza = 46.7; refShuttle4x10 = 10.85; break;
            default: 
                // ✅ Si edad no es 13-17, usar 13 (para edades <13)
                refIMC = 22.2; refCintura = 78; refCardio = 6.0; refSalto = 167; refFuerza = 27.8; refShuttle4x10 = 12.0;
        }
    } else {
        switch(edadRef) {
            case 13: refIMC = 23.2; refCintura = 75; refCardio = 3.5; refSalto = 147; refFuerza = 24.8; refShuttle4x10 = 12.75; break;
            case 14: refIMC = 22.8; refCintura = 73; refCardio = 4.0; refSalto = 151; refFuerza = 26.4; refShuttle4x10 = 12.65; break;
            case 15: refIMC = 23.0; refCintura = 75; refCardio = 4.0; refSalto = 151; refFuerza = 27.4; refShuttle4x10 = 12.65; break;
            case 16: refIMC = 23.1; refCintura = 75; refCardio = 4.0; refSalto = 154; refFuerza = 27.8; refShuttle4x10 = 12.55; break;
            case 17: refIMC = 23.2; refCintura = 74; refCardio = 4.0; refSalto = 157; refFuerza = 28.9; refShuttle4x10 = 12.6; break;
            default: 
                refIMC = 23.2; refCintura = 75; refCardio = 3.5; refSalto = 147; refFuerza = 24.8; refShuttle4x10 = 12.75;
        }
    }


        const valoresRef = [refIMC, refCintura, refCardio, refSalto, refFuerza, refShuttle4x10]; // <-- Añadido aquí

        comparacionResultadosChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [
                    'IMC',
                    'Perímetro Cintura',
                    'Cardiorespiratorio',
                    'Salto Horizontal',
                    'Fuerza Manual',
                    'Shuttle 4x10m' // <-- Etiqueta añadida
                ],
                datasets: [
                    {
                        label: 'Resultado del Usuario',
                        data: resultados, // <-- Aquí ya están todos los datos
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Valor de Referencia',
                        data: valoresRef, // <-- Aquí también
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Comparación de Resultados con Valores de Referencia'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    }

    // Mostrar recomendaciones
    function mostrarRecomendaciones(datos, cardio, salto, fuerza, imc, cintura, shuttle4x10) {
        let recomendaciones = '<h4>Recomendaciones:</h4><ul>';
        if (cardio.includes('Muy Bajo') || cardio.includes('Bajo')) {
            recomendaciones += '<li><strong>Capacidad Cardiorespiratoria:</strong> Realizar actividades aeróbicas como correr, nadar o andar en bicicleta 3-4 veces por semana para mejorar la resistencia cardiovascular. Un bajo nivel de capacidad aeróbica es un predictor independiente del desarrollo futuro de síndrome metabólico, diabetes tipo 2 y enfermedades cardiovasculares. Mejorar la capacidad cardiorrespiratoria te permitirá mantenerte activo todo el día sin cansarte demasiado, disfrutar más de juegos y deportes con amigos y alcanzar metas deportivas que te importan.</li>';
        }
        if (salto.includes('Muy Bajo') || salto.includes('Bajo')) {
            recomendaciones += '<li><strong>Potencia Muscular:</strong> Practicar ejercicios de salto y plyometría para mejorar la fuerza explosiva de las piernas. La fuerza muscular está asociada inversamente con factores de riesgo cardiovascular y dolor lumbar. Mejorar la potencia muscular te ayudará en actividades diarias como subir escaleras, correr o jugar deportes, fortalecerá huesos y músculos, y mejorará tu salud general.</li>';
        }
        if (fuerza.includes('Muy Bajo') || fuerza.includes('Bajo')) {
            recomendaciones += '<li><strong>Fuerza Muscular:</strong> Incluir ejercicios de fuerza con peso corporal como flexiones, dominadas y agarres para mejorar la fuerza de brazos y manos. La fuerza muscular está asociada con mejor salud cardiovascular y menor mortalidad. Entrenar fuerza regularmente te ayudará a realizar actividades de vida diaria con mayor facilidad, mejorarás el desarrollo de habilidades motrices, aumentarás tu rendimiento deportivo y evitarás lesiones.</li>';
        }
        if (imc.includes('Muy Alto') || imc.includes('Alto') || cintura.includes('Muy Alto') || cintura.includes('Alto')) {
            recomendaciones += '<li><strong>Composición Corporal:</strong> Mantener una dieta equilibrada y aumentar la actividad física para lograr un peso saludable. El IMC elevado junto con el perímetro de cintura indican mayor riesgo cardiometabólico. Para mejorar la composición corporal, se recomienda fijar metas realistas y pequeñas, quemar más calorías con actividad física (hacer al menos 1 hora diaria de actividad física variada), comer menos calorías y seguir una dieta saludable, reducir el tiempo frente a pantallas y dormir lo suficiente.</li>';
        }
        if (imc.includes('Muy Bajo') || imc.includes('Bajo')) {
            recomendaciones += '<li><strong>Composición Corporal:</strong> Consultar con un nutricionista para asegurar una nutrición adecuada y un crecimiento saludable.</li>';
        }
        if (shuttle4x10.includes('Muy Bajo') || shuttle4x10.includes('Bajo')) {
            recomendaciones += '<li><strong>Velocidad/Agilidad:</strong> Mejorar la velocidad y agilidad a través de ejercicios de coordinación y desplazamiento. Las mejoras en velocidad/agilidad tienen un efecto positivo en la salud esquelética. Se recomienda combinar actividades divertidas y sociales, incorporar actividad en la rutina diaria y practicar entrenamientos que incluyan intervalos de alta intensidad.</li>';
        }
        recomendaciones += '</ul>';
        document.getElementById('recomendaciones').innerHTML = recomendaciones;
    }

    // Mostrar información sobre salud
    function mostrarInfoSalud(datos, cardio, salto, fuerza, imc, cintura, shuttle4x10) {
        const info = `
            <h4>Importancia de los Tests para la Salud:</h4>
            <p><strong>Importancia General:</strong> Un bajo fitness se asocia con una peor salud cardiovascular, con una peor salud ósea y una mayor probabilidad de una enfermedad incapacitante en el futuro (Henriksson et al., 2019). Cálculos recientes revelan que los costes sanitarios directos de la inactividad física en Europa ascienden a 11.685 millones de euros al año, y que se pierden otros 3.795 millones de euros debido a la disminución de la productividad (Ding et al., 2016). La condición física es un marcador muy importante relacionado con la salud a lo largo de la vida (García-Hermoso et al., 2019). Conseguir un alto nivel de condición física es beneficioso para la salud física y mental, así como para la salud cerebral (Ortega et al., 2008).</p>
            <p><strong>Test de Resistencia Cardiorespiratoria:</strong> La capacidad aeróbica está fuertemente asociada con una mejor salud cardiovascular actual y futura. Niveles bajos se relacionan con riesgo aumentado de enfermedades cardiovasculares, síndrome metabólico y diabetes tipo 2. La condición física es la capacidad de llevar a cabo las tareas diarias con vigor y agilidad, sin fatiga y con energía suficiente para disfrutar de las actividades de ocio y para hacer frente a emergencias inesperadas (Clarke, 1979).</p>
            <p><strong>Test de Salto Horizontal:</strong> Mide la fuerza explosiva de las piernas, importante para la salud ósea y muscular. La fuerza muscular está inversamente asociada con factores de riesgo cardiovascular y dolor lumbar. La potencia muscular se define como la capacidad de generar fuerza rápidamente, y mejorarla requiere entrenamiento progresivo, técnica correcta y velocidad en los movimientos.</p>
            <p><strong>Test de Fuerza de Prehensión Manual:</strong> Indicador de la fuerza general y salud muscular. Se ha relacionado con mejores resultados en salud cardiovascular y menor mortalidad por todas las causas. La fuerza muscular es la capacidad de ejercer fuerza o resistir una resistencia externa, y entrenarla regularmente mejora la capacidad de realizar actividades de vida diaria.</p>
            <p><strong>Índice de Masa Corporal (IMC) y Perímetro de Cintura:</strong> Indicadores de composición corporal. El IMC es útil pero el perímetro de cintura es un marcador directo de grasa visceral, que es metabólicamente activa y se asocia con inflamación sistémica y resistencia a la insulina. La composición corporal está estrechamente relacionada con el rendimiento físico y la salud.</p>
            <p><strong>Test de Shuttle 4x10m:</strong> Evalúa velocidad, agilidad y coordinación, aspectos importantes para la salud esquelética. Las mejoras en velocidad/agilidad parecen tener un efecto positivo en la salud esquelética. Este test mide la capacidad de cambiar de dirección rápidamente, lo cual es importante para prevenir lesiones y mejorar el rendimiento deportivo.</p>
            <p><strong>Proyecto ALPHA:</strong> En 2003, la Comisión Europea financió el proyecto ALPHA con el objetivo de disponer de una batería de test válida y fiable para medir la condición física de forma armonizada internacionalmente. La batería final recomendaba el test de carrera de ida y vuelta de 20m, los tests de prensión manual y salto de longitud, y el IMC y perímetro de cintura como indicadores de obesidad total y central.</p>
        `;
        document.getElementById('infoSalud').innerHTML = info;
    }

    // Evaluar estado físico general
    function evaluarEstadoFisico(cardio, salto, fuerza, imc) {
        const clasificaciones = [cardio, salto, fuerza, imc];
        let muyBajo = 0, bajo = 0, promedio = 0, alto = 0, muyAlto = 0;
        clasificaciones.forEach(cat => {
            if (cat.includes('Muy Bajo')) muyBajo++;
            else if (cat.includes('Bajo')) bajo++;
            else if (cat.includes('Promedio')) promedio++;
            else if (cat.includes('Alto')) alto++;
            else if (cat.includes('Muy Alto')) muyAlto++;
        });
        if (muyBajo >= 2) return 'Muy Deficiente';
        if (muyBajo + bajo >= 3) return 'Deficiente';
        if (muyAlto + alto >= 3) return 'Excelente';
        if (muyAlto + alto >= 2) return 'Bueno';
        return 'Adecuado';
    }

    // Cargar evaluaciones desde Firestore
    async function cargarEvaluaciones() {
        try {
            const snapshot = await db.collection('evaluaciones').get();
            evaluaciones = [];
            snapshot.forEach(doc => {
                evaluaciones.push({ id: doc.id, ...doc.data() });
            });
        } catch (error) {
            console.error("Error al cargar evaluaciones: ", error);
        }
    }

    // Guardar evaluación en Firestore
    document.getElementById('fitnessForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        // Obtener el nombre o generar ID
        let nombre = document.getElementById('nombre').value.trim();
        if (!nombre) {
            nombre = generarID();
        }
        const datos = {
            nombre: nombre,
            fechaNacimiento: document.getElementById('fechaNacimiento').value,
            genero: document.getElementById('genero').value,
            fechaEvaluacion: document.getElementById('fechaEvaluacion').value,
            altura: parseFloat(document.getElementById('altura').value),
            peso: parseFloat(document.getElementById('peso').value),
            cintura: parseFloat(document.getElementById('cintura').value),
            shuttle20m: parseFloat(document.getElementById('shuttle20m').value),
            salto: parseInt(document.getElementById('salto').value),
            fuerza: parseFloat(document.getElementById('fuerza').value),
            shuttle4x10m: parseFloat(document.getElementById('shuttle4x10m').value)
        };
        try {
            const docRef = await db.collection('evaluaciones').add(datos);
            datos.id = docRef.id;
            evaluaciones.push(datos);
            procesarResultados(datos);
            alert(`Evaluación registrada exitosamente! ID: ${nombre}`);
        } catch (error) {
            console.error("Error al guardar evaluación: ", error);
            alert('Error al guardar la evaluación');
        }
    });

    // Mostrar pestañas
    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
        if (tabId === 'estadisticas') {
            actualizarEstadisticas();
        }
        if (tabId === 'analisis') {
            actualizarAnalisis();
        }
    }

    // Actualizar estadísticas
    function actualizarEstadisticas() {
        if (evaluaciones.length === 0) return;
        // Calcular estadísticas
        const total = evaluaciones.length;
        const masculino = evaluaciones.filter(e => e.genero === 'masculino').length;
        const femenino = evaluaciones.filter(e => e.genero === 'femenino').length;
        const promedioEdad = evaluaciones.reduce((sum, e) => sum + getEdad(e.fechaNacimiento), 0) / total;
        const promedioIMC = evaluaciones.reduce((sum, e) => sum + calcularIMC(e.peso, e.altura), 0) / total;
        const promedioCardio = evaluaciones.reduce((sum, e) => sum + e.shuttle20m, 0) / total;
        const promedioSalto = evaluaciones.reduce((sum, e) => sum + e.salto, 0) / total;
        const promedioFuerza = evaluaciones.reduce((sum, e) => sum + e.fuerza, 0) / total;
        const promedioShuttle4x10 = evaluaciones.reduce((sum, e) => sum + e.shuttle4x10m, 0) / total;
        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card">
                <h3>Total Evaluaciones</h3>
                <p>${total}</p>
            </div>
            <div class="stat-card">
                <h3>Hombres</h3>
                <p>${masculino}</p>
            </div>
            <div class="stat-card">
                <h3>Mujeres</h3>
                <p>${femenino}</p>
            </div>
            <div class="stat-card">
                <h3>Edad Promedio</h3>
                <p>${promedioEdad.toFixed(1)} años</p>
            </div>
            <div class="stat-card">
                <h3>IMC Promedio</h3>
                <p>${promedioIMC.toFixed(2)}</p>
            </div>
            <div class="stat-card">
                <h3>Cardio Promedio</h3>
                <p>${promedioCardio.toFixed(1)} etapas</p>
            </div>
            <div class="stat-card">
                <h3>Salto Promedio</h3>
                <p>${promedioSalto.toFixed(1)} cm</p>
            </div>
            <div class="stat-card">
                <h3>Fuerza Promedio</h3>
                <p>${promedioFuerza.toFixed(1)} kg</p>
            </div>
            <div class="stat-card">
                <h3>Shuttle 4x10m Promedio</h3>
                <p>${promedioShuttle4x10.toFixed(1)} seg</p>
            </div>
        `;
        // Actualizar gráficos
        actualizarGraficos();
    }

    // Actualizar gráficos
    function actualizarGraficos() {
        // Gráfico de distribución por edad
        const edades = evaluaciones.map(e => getEdad(e.fechaNacimiento));
        const edadCount = {};
        edades.forEach(edad => {
            edadCount[edad] = (edadCount[edad] || 0) + 1;
        });
        const ctx1 = document.getElementById('distribucionEdadChart').getContext('2d');
        if (distribucionEdadChart) distribucionEdadChart.destroy();
        distribucionEdadChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: Object.keys(edadCount),
                datasets: [{
                    label: 'Número de Evaluaciones',
                    data: Object.values(edadCount),
                    backgroundColor: 'rgba(52, 152, 219, 0.6)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Distribución por Edad'
                    }
                }
            }
        });
        // Gráfico de rendimiento promedio (radar)
        const ctx2 = document.getElementById('rendimientoChart').getContext('2d');
        if (rendimientoChart) rendimientoChart.destroy();
        rendimientoChart = new Chart(ctx2, {
            type: 'radar',
            data: {
                labels: ['Cardiorespiratorio', 'Fuerza', 'Salto', 'IMC', 'Shuttle 4x10m'],
                datasets: [{
                    label: 'Promedio General',
                    data: [
                        evaluaciones.reduce((sum, e) => sum + e.shuttle20m, 0) / evaluaciones.length,
                        evaluaciones.reduce((sum, e) => sum + e.fuerza, 0) / evaluaciones.length,
                        evaluaciones.reduce((sum, e) => sum + e.salto, 0) / evaluaciones.length,
                        evaluaciones.reduce((sum, e) => sum + calcularIMC(e.peso, e.altura), 0) / evaluaciones.length,
                        evaluaciones.reduce((sum, e) => sum + e.shuttle4x10m, 0) / evaluaciones.length
                    ],
                    backgroundColor: 'rgba(46, 204, 113, 0.2)',
                    borderColor: 'rgba(46, 204, 113, 1)',
                    borderWidth: 3,
                    pointBackgroundColor: 'rgba(46, 204, 113, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(46, 204, 113, 1)'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Rendimiento Promedio'
                    }
                },
                scales: {
                    r: {
                        angleLines: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        },
                        pointLabels: {
                            font: {
                                size: 14
                            }
                        }
                    }
                }
            }
        });
    }

    // Actualizar análisis detallado
    function actualizarAnalisis() {
        const filtroGenero = document.getElementById('filtroGenero').value;
        const datosFiltrados = filtroGenero === 'todos' ?
            evaluaciones :
            evaluaciones.filter(e => e.genero === filtroGenero);
        if (datosFiltrados.length === 0) return;
        // Gráfico por edad para todas las pruebas
        const edades = [...new Set(datosFiltrados.map(e => getEdad(e.fechaNacimiento)))].sort();
        const cardioPorEdad = edades.map(edad => {
            const datosEdad = datosFiltrados.filter(e => getEdad(e.fechaNacimiento) === edad);
            return datosEdad.reduce((sum, e) => sum + e.shuttle20m, 0) / datosEdad.length;
        });
        const saltoPorEdad = edades.map(edad => {
            const datosEdad = datosFiltrados.filter(e => getEdad(e.fechaNacimiento) === edad);
            return datosEdad.reduce((sum, e) => sum + e.salto, 0) / datosEdad.length;
        });
        const fuerzaPorEdad = edades.map(edad => {
            const datosEdad = datosFiltrados.filter(e => getEdad(e.fechaNacimiento) === edad);
            return datosEdad.reduce((sum, e) => sum + e.fuerza, 0) / datosEdad.length;
        });
        const ctx3 = document.getElementById('analisisEdadChart').getContext('2d');
        if (analisisEdadChart) analisisEdadChart.destroy();
        analisisEdadChart = new Chart(ctx3, {
            type: 'line',
            data: {
                labels: edades,
                datasets: [
                    {
                        label: 'Rendimiento Cardiorespiratorio',
                        data: cardioPorEdad,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    },
                    {
                        label: 'Salto Horizontal',
                        data: saltoPorEdad,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    },
                    {
                        label: 'Fuerza Manual',
                        data: fuerzaPorEdad,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Rendimiento por Edad y Prueba'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
        // Comparación por género
        const hombres = evaluaciones.filter(e => e.genero === 'masculino');
        const mujeres = evaluaciones.filter(e => e.genero === 'femenino');
        const ctx4 = document.getElementById('comparacionGeneroChart').getContext('2d');
        if (comparacionGeneroChart) comparacionGeneroChart.destroy();
        comparacionGeneroChart = new Chart(ctx4, {
            type: 'bar',
            data: {
                labels: ['Cardio', 'Fuerza', 'Salto', 'IMC', 'Shuttle 4x10m'], // Sin coma al final
                datasets: [
                    {
                        label: 'Hombres',
                        data: [
                            hombres.length ? hombres.reduce((sum, e) => sum + e.shuttle20m, 0) / hombres.length : 0,
                            hombres.length ? hombres.reduce((sum, e) => sum + e.fuerza, 0) / hombres.length : 0,
                            hombres.length ? hombres.reduce((sum, e) => sum + e.salto, 0) / hombres.length : 0,
                            hombres.length ? hombres.reduce((sum, e) => sum + calcularIMC(e.peso, e.altura), 0) / hombres.length : 0,
                            hombres.length ? hombres.reduce((sum, e) => sum + e.shuttle4x10m, 0) / hombres.length : 0
                        ],
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    },
                    {
                        label: 'Mujeres',
                        data: [
                            mujeres.length ? mujeres.reduce((sum, e) => sum + e.shuttle20m, 0) / mujeres.length : 0,
                            mujeres.length ? mujeres.reduce((sum, e) => sum + e.fuerza, 0) / mujeres.length : 0,
                            mujeres.length ? mujeres.reduce((sum, e) => sum + e.salto, 0) / mujeres.length : 0,
                            mujeres.length ? mujeres.reduce((sum, e) => sum + calcularIMC(e.peso, e.altura), 0) / mujeres.length : 0,
                            mujeres.length ? mujeres.reduce((sum, e) => sum + e.shuttle4x10m, 0) / mujeres.length : 0
                        ],
                        backgroundColor: 'rgba(255, 99, 132, 0.6)'
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Comparación por Género'
                    }
                }
            }
        });
    }

    // Exportar a CSV
    function exportToCSV() {
        if (evaluaciones.length === 0) {
            alert('No hay datos para exportar');
            return;
        }
        
            const headers = ['ID', 'Nombre', 'Fecha Nacimiento', 'Género', 'Fecha Evaluación', 
                           'Altura', 'Peso', 'Cintura', 'Shuttle 20m', 'Salto', 'Fuerza', 'Shuttle 4x10m', 
                           'IMC', 'Edad', 'Clasificación IMC', 'Clasificación Cintura', 
                           'Clasificación Cardiorespiratorio', 'Clasificación Salto', 
                           'Clasificación Fuerza', 'Clasificación Shuttle 4x10m'];
            
            const csvContent = [
                headers.join(','),
                ...evaluaciones.map(e => {
                    const edad = getEdad(e.fechaNacimiento);
                    const imc = calcularIMC(e.peso, e.altura);
                    return [
                        e.id,
                        e.nombre,
                        e.fechaNacimiento,
                        e.genero,
                        e.fechaEvaluacion,
                        e.altura,
                        e.peso,
                        e.cintura,
                        e.shuttle20m,
                        e.salto,
                        e.fuerza,
                        e.shuttle4x10m,
                        imc.toFixed(2),
                        edad,
                        getClasificacionIMC(imc, e.genero, edad),
                        getClasificacionCintura(e.cintura, e.genero, edad),
                        getClasificacionCardio(e.shuttle20m, e.genero, edad),
                        getClasificacionSalto(e.salto, e.genero, edad),
                        getClasificacionFuerza(e.fuerza, e.genero, edad),
                        getClasificacionShuttle4x10(e.shuttle4x10m, e.genero, edad)
                    ].join(',');
                })
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'evaluaciones_fitness.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Inicializar
        actualizarGraficos();
    </script>
</body>
</html>

















