<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuestionario KIDMED - Calidad de la Dieta Mediterránea</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SDK de Firebase v9.x para navegadores (UMD) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-color: #27ae60;
            --primary-dark: #219653;
            --secondary-color: #f39c12;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
            --light-text: #ecf0f1;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark-text);
            background: linear-gradient(135deg, #e0f7fa, #f5f5f5);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .instructions {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            border-left: 4px solid var(--primary-color);
        }

        .instructions p {
            margin: 5px 0;
        }

        .datos-personales {
            background-color: #e3f2fd;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            border: 1px solid #bbdefb;
        }

        .datos-personales h3 {
            color: var(--primary-dark);
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-text);
        }

        select, input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        select:focus, input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.2);
        }

        .question {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            background-color: #fafafa;
            transition: var(--transition);
        }

        .question:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .question label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark-text);
        }

        .options {
            display: flex;
            gap: 15px;
        }

        .option {
            display: flex;
            align-items: center;
        }

        .option input[type="radio"] {
            margin-right: 5px;
        }

        .info-box {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: var(--border-radius);
            margin-top: 10px;
            font-size: 0.9rem;
            border-left: 3px solid var(--secondary-color);
        }

        .button-container {
            text-align: center;
            margin: 25px 0;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 0 10px;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
        }

        #exportBtn, #exportAllBtn, #reportBtn {
            background-color: #3498db;
        }

        #exportBtn:hover, #exportAllBtn:hover, #reportBtn:hover {
            background-color: #2980b9;
        }

        #resetBtn {
            background-color: #e74c3c;
        }

        #resetBtn:hover {
            background-color: #c0392b;
        }

        #reportBtn {
            background-color: #9b59b6;
        }

        #reportBtn:hover {
            background-color: #8e44ad;
        }

        #result {
            margin-top: 25px;
            padding: 20px;
            border-radius: var(--border-radius);
            display: none;
        }

        .result-high {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .result-medium {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .result-low {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .result-content h3 {
            margin-bottom: 15px;
            color: inherit;
        }

        .recommendation {
            margin-top: 15px;
            padding: 15px;
            border-radius: var(--border-radius);
            background-color: rgba(255, 255, 255, 0.7);
        }

        .recommendation ul {
            padding-left: 20px;
        }

        .recommendation li {
            margin-bottom: 8px;
        }

        .hidden {
            display: none;
        }

        .progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin: 20px 0;
            height: 10px;
        }

        .progress {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Ajustes para pantallas pequeñas */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            .options {
                flex-direction: column;
                gap: 8px;
            }

            .button-container {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            button {
                width: 100%;
                margin: 5px 0;
            }
        }

        /* Accesibilidad */
        button:focus, select:focus, input:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Estilo para inputs no válidos */
        input:invalid, select:invalid {
            border-color: #e74c3c;
        }

        .report-section {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
        }

        .chart-container {
            margin: 20px 0;
            height: 300px;
        }

        .report-content h3 {
            color: var(--primary-dark);
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background-color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            margin-top: 10px;
            color: var(--dark-text);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--primary-color);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Cuestionario KIDMED - Calidad de la Dieta Mediterránea en Niños y Adolescentes</h1>

    <!-- Página de introducción -->
    <div id="introPage" class="page active">
        <div class="instructions">
            <p><strong>Instrucciones:</strong> Este cuestionario evalúa la calidad de tu dieta según los principios de la dieta mediterránea.</p>
            <p><strong>Interpretación:</strong> Puntuación ≥8: Calidad dietética óptima. Puntuación 4-7: Calidad dietética intermedia. Puntuación ≤3: Calidad dietética muy baja.</p>
            <p><strong>Importancia:</strong> La dieta mediterránea es beneficiosa para la salud cardiovascular, cognitiva y el desarrollo general.</p>
        </div>

        <div class="datos-personales">
            <h3>Datos del Participante</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="edad">Edad:</label>
                    <select id="edad" required>
                        <option value="">Seleccionar</option>
                        <!-- Opciones generadas por JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="genero">Género:</label>
                    <select id="genero" required>
                        <option value="">Seleccionar</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Femenino">Femenino</option>
                        <option value="Otro">Otro</option>
                        <option value="Prefiero no decirlo">Prefiero no decirlo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="curso">Curso:</label>
                    <select id="curso" required>
                        <option value="">Seleccionar</option>
                        <option value="1º ESO">1º ESO</option>
                        <option value="2º ESO">2º ESO</option>
                        <option value="3º ESO">3º ESO</option>
                        <option value="4º ESO">4º ESO</option>
                        <option value="1º Bachillerato">1º Bachillerato</option>
                        <option value="2º Bachillerato">2º Bachillerato</option>
                        <option value="1º FP Básica">1º FP Básica</option>
                        <option value="2º FP Básica">2º FP Básica</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="fecha">Fecha:</label>
                    <input type="date" id="fecha" required>
                </div>
            </div>
        </div>

        <div class="button-container">
            <button onclick="startTest()">Comenzar Test</button>
        </div>
    </div>

    <!-- Formulario principal con páginas -->
    <form id="kidmedForm">
        <!-- Página 1 -->
        <div id="page1" class="page">
            <div class="progress-bar">
                <div class="progress" id="progress1"></div>
            </div>
            <h2>Página 1 de 4</h2>

            <div class="question">
                <label>1. ¿Tomas una fruta todos los días?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q1" value="1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q1" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">La fruta es una fuente clave de vitaminas, minerales y fibra. Es recomendable consumir al menos 2 piezas al día.</div>
            </div>

            <div class="question">
                <label>2. ¿Tomas una segunda fruta todos los días?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q2" value="1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q2" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">Consumir más fruta aporta mayor variedad de nutrientes y energía natural.</div>
            </div>

            <div class="question">
                <label>3. ¿Tomas verduras frescas o cocinadas regularmente todos los días?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q3" value="1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q3" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">Las verduras son esenciales para aportar vitaminas, minerales y fibra que ayudan al crecimiento y al sistema inmunológico.</div>
            </div>

            <div class="question">
                <label>4. ¿Tomas verduras frescas o cocinadas más de una vez al día?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q4" value="1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q4" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">Más verduras significan más nutrientes y una mejor salud digestiva.</div>
            </div>

            <div class="button-container">
                <button type="button" onclick="nextPage(1)">Siguiente</button>
            </div>
        </div>

        <!-- Página 2 -->
        <div id="page2" class="page">
            <div class="progress-bar">
                <div class="progress" id="progress2"></div>
            </div>
            <h2>Página 2 de 4</h2>

            <div class="question">
                <label>5. ¿Tomas pescado regularmente (al menos 2-3 veces/semana)?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q5" value="1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q5" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">El pescado, especialmente el azul, es rico en ácidos grasos omega-3, esenciales para el cerebro y el corazón.</div>
            </div>

            <div class="question">
                <label>6. ¿Acudes a un restaurante de comida rápida (por ejemplo, hamburguesería) una o más veces a la semana?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q6" value="-1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q6" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">La comida rápida suele contener mucha grasa, sal y azúcar, lo que puede afectar negativamente la salud si se consume con frecuencia.</div>
            </div>

            <div class="question">
                <label>7. ¿Tomas legumbres más de una vez a la semana?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q7" value="1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q7" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">Las legumbres son una gran fuente de proteínas vegetales, fibra y minerales, y forman parte fundamental de la dieta mediterránea.</div>
            </div>

            <div class="question">
                <label>8. ¿Tomas pasta integral o arroz integral casi a diario (5 o más veces a la semana)?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q8" value="1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q8" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">Los cereales integrales aportan fibra y nutrientes que ayudan a mantener la energía y la saciedad.</div>
            </div>

            <div class="button-container">
                <button type="button" onclick="prevPage(2)">Anterior</button>
                <button type="button" onclick="nextPage(2)">Siguiente</button>
            </div>
        </div>

        <!-- Página 3 -->
        <div id="page3" class="page">
            <div class="progress-bar">
                <div class="progress" id="progress3"></div>
            </div>
            <h2>Página 3 de 4</h2>

            <div class="question">
                <label>9. ¿Desayunas un cereal integral o derivado integral (por ejemplo, pan integral)?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q9" value="1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q9" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">Un desayuno integral proporciona energía sostenible para comenzar el día y mejora la concentración.</div>
            </div>

            <div class="question">
                <label>10. ¿Tomas frutos secos regularmente (al menos 2-3 veces/semana)?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q10" value="1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q10" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">Los frutos secos contienen grasas saludables, proteínas y vitaminas que son buenos para el corazón y el cerebro.</div>
            </div>

            <div class="question">
                <label>11. ¿En casa se utiliza aceite de oliva?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q11" value="1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q11" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">El aceite de oliva virgen extra es un pilar de la dieta mediterránea, rico en grasas saludables y antioxidantes.</div>
            </div>

            <div class="question">
                <label>12. ¿No desayunas a diario?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q12" value="-1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q12" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">Saltarse el desayuno puede afectar el rendimiento escolar y el estado de ánimo. Es la comida más importante del día.</div>
            </div>

            <div class="button-container">
                <button type="button" onclick="prevPage(3)">Anterior</button>
                <button type="button" onclick="nextPage(3)">Siguiente</button>
            </div>
        </div>

        <!-- Página 4 -->
        <div id="page4" class="page">
            <div class="progress-bar">
                <div class="progress" id="progress4"></div>
            </div>
            <h2>Última Página</h2>

            <div class="question">
                <label>13. ¿Desayunas un lácteo (yogur, leche...)?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q13" value="1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q13" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">Los lácteos aportan calcio y proteínas necesarios para el crecimiento y la salud ósea.</div>
            </div>

            <div class="question">
                <label>14. ¿Desayunas bollería industrial (galletas, pasteles, cruasanes...)?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q14" value="-1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q14" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">La bollería industrial contiene mucha azúcar y grasas saturadas, poco recomendables para el desayuno.</div>
            </div>

            <div class="question">
                <label>15. ¿Tomas 2 yogures y/o queso (40g) todos los días?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q15" value="1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q15" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">Los productos lácteos aportan calcio, proteínas y probióticos que fortalecen huesos y sistema digestivo.</div>
            </div>

            <div class="question">
                <label>16. ¿Tomas dulces y golosinas varias veces al día?</label>
                <div class="options">
                    <div class="option">
                        <input type="radio" name="q16" value="-1" required> <label>Sí</label>
                    </div>
                    <div class="option">
                        <input type="radio" name="q16" value="0" required> <label>No</label>
                    </div>
                </div>
                <div class="info-box">El exceso de azúcar puede causar caries, sobrepeso y afectar la energía y el estado de ánimo.</div>
            </div>

            <div class="button-container">
                <button type="button" onclick="prevPage(4)">Anterior</button>
                <button type="button" onclick="calculateScore()">Calcular Puntuación</button>
            </div>
        </div>
    </form>

    <div id="result"></div>

    <div class="button-container">
        <button id="exportBtn" class="hidden" onclick="exportData()">Exportar Resultados</button>
        <button id="exportAllBtn" class="hidden" onclick="exportAllData()">Exportar Todos los Resultados</button>
        <button id="reportBtn" class="hidden" onclick="generateReport()">Informe Estadístico</button>
        <button id="resetBtn" class="hidden" onclick="resetTest()">Nuevo Test</button>
    </div>
    
    <!-- Sección para el informe -->
    <div id="reportSection" class="report-section hidden">
        <h2>Informe Estadístico de Resultados</h2>
        <div id="reportContent" class="report-content"></div>
    </div>
</div>

<script>
    // Generar opciones de edad (10 a 18 años)
    const edadSelect = document.getElementById('edad');
    for (let i = 10; i <= 18; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        edadSelect.appendChild(option);
    }

    // Establecer fecha actual por defecto
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('fecha').value = today;

    // Almacenamiento en memoria de los resultados
    let allResults = JSON.parse(localStorage.getItem('allKIDMEDResults')) || [];

    // Inicializar Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyC1Uzw-sS7wW2vhAUXPRIhRDSZ8wKJyd6c",
        authDomain: "kidmed-e8320.firebaseapp.com",
        projectId: "kidmed-e8320",
        storageBucket: "kidmed-e8320.firebasestorage.app",
        messagingSenderId: "566899185119",
        appId: "1:566899185119:web:254d46d7ab4f0666cf206a",
        measurementId: "G-2TNGWBRLKL"
    };

    // Inicializar la aplicación de Firebase
    firebase.initializeApp(firebaseConfig);
    const analytics = firebase.analytics();
    const db = firebase.firestore(); // Obtener la instancia de Firestore

    function startTest() {
        const edad = document.getElementById('edad').value;
        const genero = document.getElementById('genero').value;
        const curso = document.getElementById('curso').value;
        const fecha = document.getElementById('fecha').value;

        if (!edad || !genero || !curso || !fecha) {
            alert('Por favor, completa todos los datos personales.');
            return;
        }

        document.getElementById('introPage').classList.remove('active');
        document.getElementById('page1').classList.add('active');
        updateProgress(1);
    }

    function nextPage(currentPage) {
        if (!validatePage(currentPage)) {
            alert('Por favor, responde todas las preguntas de esta página.');
            return;
        }

        document.getElementById(`page${currentPage}`).classList.remove('active');
        document.getElementById(`page${currentPage + 1}`).classList.add('active');
        updateProgress(currentPage + 1);
    }

    function prevPage(currentPage) {
        document.getElementById(`page${currentPage}`).classList.remove('active');
        document.getElementById(`page${currentPage - 1}`).classList.add('active');
        updateProgress(currentPage - 1);
    }

    function validatePage(pageNum) {
        const page = document.getElementById(`page${pageNum}`);
        const questions = page.querySelectorAll('.question');
        let allAnswered = true;
        
        questions.forEach(question => {
            const radios = question.querySelectorAll('input[type="radio"]');
            const checked = Array.from(radios).some(radio => radio.checked);
            if (!checked) {
                allAnswered = false;
            }
        });
        
        return allAnswered;
    }

    function updateProgress(pageNum) {
        const progressPercent = (pageNum / 4) * 100;
        document.getElementById(`progress${pageNum}`).style.width = `${progressPercent}%`;
    }

    async function calculateScore() {
        // Validar última página
        if (!validatePage(4)) {
            alert('Por favor, responde todas las preguntas de esta página.');
            return;
        }

        // --- Captura de respuestas individuales ---
        const respuestas = {};
        for (let i = 1; i <= 16; i++) {
            const selectedRadio = document.querySelector(`input[name="q${i}"]:checked`);
            if (selectedRadio) {
                respuestas[`q${i}`] = selectedRadio.value; // Guardamos el valor: "1", "0", "-1"
            }
        }
        // --- Fin de captura ---

        // Cálculo de la puntuación (como antes)
        let score = 0;
        for (let i = 1; i <= 16; i++) {
            score += parseInt(respuestas[`q${i}`]); // Usamos las respuestas capturadas
        }

        // Limitar puntuación a 0 si es negativa
        if (score < 0) score = 0;

        let interpretation = "";
        let recommendations = [];
        let resultClass = "";

        if (score >= 8) {
            interpretation = "¡Felicidades! Tu dieta tiene una calidad muy buena y se ajusta bien a los principios de la dieta mediterránea.";
            recommendations = [
                "Sigue manteniendo estos hábitos saludables.",
                "Continúa consumiendo frutas, verduras, pescado y cereales integrales.",
                "¡Eres un gran ejemplo de alimentación saludable!"
            ];
            resultClass = "result-high";
        } else if (score >= 4 && score <= 7) {
            interpretation = "Tu dieta tiene una calidad intermedia. Hay aspectos positivos, pero puedes mejorar para acercarte más a la dieta mediterránea.";
            recommendations = [
                "Intenta incluir una fruta más en tu dieta diaria si solo consumes una.",
                "Aumenta la ingesta de verduras, especialmente en la comida y la cena.",
                "Incorpora pescado al menos 2 veces por semana.",
                "Evita la comida rápida y los dulces industriales con frecuencia.",
                "Cocina con aceite de oliva en lugar de mantequilla o margarina."
            ];
            resultClass = "result-medium";
        } else if (score <= 3) {
            interpretation = "Tu dieta tiene una calidad baja. Es importante hacer cambios para mejorar tu salud y bienestar.";
            recommendations = [
                "Haz del desayuno una comida obligatoria y nutritiva (lácteo, fruta, cereal integral).",
                "Come fruta y verdura todos los días. Empieza con una porción al día y aumenta gradualmente.",
                "Reduce la ingesta de dulces, bollería y comida rápida.",
                "Bebe mucha agua en lugar de refrescos azucarados.",
                "Incluye pescado y legumbres en la dieta semanalmente.",
                "Consulta con un nutricionista si necesitas ayuda para planificar comidas saludables."
            ];
            resultClass = "result-low";
        }

        const resultDiv = document.getElementById('result');
        let recHTML = "<div class='recommendation'><h4>Recomendaciones:</h4><ul>";
        recommendations.forEach(rec => {
            recHTML += `<li>${rec}</li>`;
        });
        recHTML += "</ul></div>";

        resultDiv.innerHTML = `<div class="result-content"><h3>Resultado</h3><p><strong>Puntuación Total: ${score}</strong></p><p>${interpretation}</p>${recHTML}</div>`;
        resultDiv.className = resultClass;
        resultDiv.style.display = "block";

        // Guardar datos para exportar
        const edad = document.getElementById('edad').value;
        const genero = document.getElementById('genero').value;
        const curso = document.getElementById('curso').value;
        const fecha = document.getElementById('fecha').value;

        // --- Incluir respuestas en el objeto a guardar ---
        const currentResult = {
            edad: edad,
            genero: genero,
            curso: curso,
            fecha: fecha,
            score: score, // Puntuación total calculada
            respuestas: respuestas, // <-- Nuevo: Incluimos las respuestas individuales
            interpretation: interpretation,
            recommendations: recommendations
        };
        // --- Fin de inclusión ---

        // Almacenar en memoria y localStorage
        allResults.push(currentResult);
        localStorage.setItem('allKIDMEDResults', JSON.stringify(allResults));

        // Almacenar en Firebase usando la instancia `db` obtenida previamente
        try {
            await db.collection("kidmedResults").add(currentResult); // Usar `db.collection`
            console.log("Documento guardado en Firebase con éxito, incluyendo respuestas detalladas");
        } catch (error) {
            console.error("Error al guardar en Firebase: ", error);
            alert("Hubo un error al guardar los datos en la base de datos. Los resultados se han almacenado localmente.");
        }

        // Mostrar botones de exportar y reset
        document.getElementById('exportBtn').classList.remove('hidden');
        document.getElementById('exportAllBtn').classList.remove('hidden');
        document.getElementById('reportBtn').classList.remove('hidden');
        document.getElementById('resetBtn').classList.remove('hidden');
    }

    function exportData() {
        if (allResults.length === 0) {
            alert('No hay resultados para exportar.');
            return;
        }

        const latestResult = allResults[allResults.length - 1];
        const dataStr = JSON.stringify(latestResult, null, 2);
        const dataUri = 'application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

        const exportFileDefaultName = `KIDMED_Resultado_${latestResult.fecha}.json`;

        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
    }

    function exportAllData() {
        if (allResults.length === 0) {
            alert('No hay resultados para exportar.');
            return;
        }

        // Convertir a CSV
        const csvContent = convertToCSV(allResults);
        const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);

        const exportFileDefaultName = `KIDMED_Todos_Resultados_${new Date().toISOString().split('T')[0]}.csv`;

        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
    }

    function convertToCSV(data) {
        if (!data.length) return '';
        
        const headers = Object.keys(data[0]);
        const csvRows = [headers.join(',')];

        data.forEach(row => {
            const values = headers.map(header => {
                const value = row[header];
                return `"${value}"`;
            });
            csvRows.push(values.join(','));
        });

        return csvRows.join('\n');
    }

    async function generateReport() {
        // Cargar datos desde Firebase
        try {
            // Usar la instancia `db` para obtener los documentos
            const querySnapshot = await db.collection("kidmedResults").orderBy("fecha").get(); // Usar `db.collection`
            
            allResults = [];
            querySnapshot.forEach((doc) => {
                allResults.push({ id: doc.id, ...doc.data() });
            });
            
            console.log("Datos cargados desde Firebase para el informe");
        } catch (error) {
            console.error("Error al cargar datos desde Firebase: ", error);
            alert("Hubo un error al cargar los datos para el informe. Se usarán los datos locales.");
        }

        if (allResults.length === 0) {
            alert('No hay resultados para generar el informe.');
            return;
        }

        // Calcular estadísticas generales
        const totalResults = allResults.length;
        const scores = allResults.map(r => r.score);
        
        // Contar resultados por categoría
        const highQuality = scores.filter(s => s >= 8).length;
        const mediumQuality = scores.filter(s => s >= 4 && s <= 7).length;
        const lowQuality = scores.filter(s => s <= 3).length;
        
        // Calcular porcentajes
        const highPercent = ((highQuality / totalResults) * 100).toFixed(1);
        const mediumPercent = ((mediumQuality / totalResults) * 100).toFixed(1);
        const lowPercent = ((lowQuality / totalResults) * 100).toFixed(1);
        
        // Contar por género
        const genderCounts = {};
        allResults.forEach(r => {
            if (!genderCounts[r.genero]) {
                genderCounts[r.genero] = 0;
            }
            genderCounts[r.genero]++;
        });
        
        // Contar por curso
        const courseCounts = {};
        allResults.forEach(r => {
            if (!courseCounts[r.curso]) {
                courseCounts[r.curso] = 0;
            }
            courseCounts[r.curso]++;
        });

        // --- Análisis detallado de respuestas ---
        // Contadores para cada pregunta
        const contadoresSi = {};
        const contadoresNo = {};

        for (let i = 1; i <= 16; i++) {
            contadoresSi[i] = 0;
            contadoresNo[i] = 0;
        }

        // Recorremos todos los resultados
        allResults.forEach(resultado => {
            const respuestas = resultado.respuestas;
            for (let i = 1; i <= 16; i++) {
                const valor = respuestas[`q${i}`];
                if (valor === "1") {
                    contadoresSi[i]++;
                } else {
                    contadoresNo[i]++; // Incluye tanto "0" como "-1"
                }
            }
        });
        // --- Fin del análisis detallado ---

        // Crear contenido del informe
        const reportContent = document.getElementById('reportContent');
        
        reportContent.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">${totalResults}</div>
                    <div class="stat-label">Total de Encuestados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${highQuality} (${highPercent}%)</div>
                    <div class="stat-label">Calidad Óptima</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${mediumQuality} (${mediumPercent}%)</div>
                    <div class="stat-label">Calidad Intermedia</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${lowQuality} (${lowPercent}%)</div>
                    <div class="stat-label">Calidad Baja</div>
                </div>
            </div>
            
            <h3>Resultados por Categoría</h3>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
            
            <h3>Resultados por Género</h3>
            <div class="chart-container">
                <canvas id="genderChart"></canvas>
            </div>
            
            <h3>Resultados por Curso</h3>
            <div class="chart-container">
                <canvas id="courseChart"></canvas>
            </div>

            <h3>Detalles de Respuestas por Pregunta</h3>
            <div class="chart-container">
                <canvas id="detallePreguntasChart"></canvas>
            </div>
            <p>Este gráfico muestra cuántas veces se respondió "Sí" o "No" a cada pregunta del cuestionario. Las preguntas con más respuestas "No" pueden indicar áreas donde se necesitan mejorar los hábitos alimenticios.</p>
        `;
        
        // Mostrar sección de informe
        document.getElementById('reportSection').classList.remove('hidden');
        
        // Crear gráficos
        createCategoryChart(highQuality, mediumQuality, lowQuality);
        createGenderChart(genderCounts);
        createCourseChart(courseCounts);
        createDetallePreguntasChart(contadoresSi, contadoresNo); // Nuevo gráfico
    }

    function createCategoryChart(high, medium, low) {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
             {
                labels: [
                    `Calidad Óptima (≥8): ${high} (${((high / (high + medium + low)) * 100).toFixed(1)}%)`,
                    `Calidad Intermedia (4-7): ${medium} (${((medium / (high + medium + low)) * 100).toFixed(1)}%)`,
                    `Calidad Baja (≤3): ${low} (${((low / (high + medium + low)) * 100).toFixed(1)}%)`
                ],
                datasets: [{
                     [high, medium, low],
                    backgroundColor: [
                        '#27ae60',
                        '#f39c12',
                        '#e74c3c'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Distribución de Calidad Dietética'
                    }
                }
            }
        });
    }

    function createGenderChart(genderCounts) {
        const ctx = document.getElementById('genderChart').getContext('2d');
        const labels = Object.keys(genderCounts);
        const data = Object.values(genderCounts);
        
        const percentageData = data.map(count => ((count / data.reduce((a, b) => a + b, 0)) * 100).toFixed(1));
        
        new Chart(ctx, {
            type: 'pie',
             {
                labels: labels.map((label, i) => `${label}: ${data[i]} (${percentageData[i]}%)`),
                datasets: [{
                     data,
                    backgroundColor: [
                        '#3498db',
                        '#e91e63',
                        '#9b59b6',
                        '#34495e'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Distribución por Género'
                    }
                }
            }
        });
    }

    function createCourseChart(courseCounts) {
        const ctx = document.getElementById('courseChart').getContext('2d');
        const labels = Object.keys(courseCounts);
        const data = Object.values(courseCounts);
        
        const total = data.reduce((a, b) => a + b, 0);
        const percentageData = data.map(count => ((count / total) * 100).toFixed(1));
        
        new Chart(ctx, {
            type: 'bar',
             {
                labels: labels.map((label, i) => `${label}\n(${data[i]} - ${percentageData[i]}%)`),
                datasets: [{
                    label: 'Número de Encuestados',
                     data,
                    backgroundColor: '#27ae60',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Distribución por Curso'
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Función para crear el gráfico de detalle de preguntas
    function createDetallePreguntasChart(contadoresSi, contadoresNo) {
        const ctx = document.getElementById('detallePreguntasChart').getContext('2d');
        
        // Etiquetas para las preguntas
        const labels = [
            "Q1: Fruta diaria", "Q2: Segunda fruta", "Q3: Verduras diarias", "Q4: Más de una verdura",
            "Q5: Pescado semanal", "Q6: Comida rápida", "Q7: Legumbres semanal", "Q8: Cereal integral",
            "Q9: Desayuno integral", "Q10: Frutos secos", "Q11: Aceite oliva", "Q12: No desayunar",
            "Q13: Lácteo desayuno", "Q14: Bollería desayuno", "Q15: Lácteos diarios", "Q16: Dulces diarios"
        ];

        // Datos para "Sí" y "No"
        const dataSi = Object.values(contadoresSi);
        const dataNo = Object.values(contadoresNo);

        new Chart(ctx, {
            type: 'bar',
             {
                labels: labels,
                datasets: [
                    {
                        label: 'Respuestas "Sí"',
                        data: dataSi,
                        backgroundColor: '#27ae60',
                    },
                    {
                        label: 'Respuestas "No"',
                         dataNo,
                        backgroundColor: '#e74c3c',
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Distribución de Respuestas por Pregunta'
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 90, // Rotar etiquetas si es necesario
                            minRotation: 45
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Número de Respuestas'
                        }
                    }
                }
            }
        });
    }

    function resetTest() {
        document.getElementById('edad').value = '';
        document.getElementById('genero').value = '';
        document.getElementById('curso').value = '';
        document.getElementById('fecha').value = today;
        
        // Resetear todas las páginas
        for (let i = 1; i <= 4; i++) {
            document.getElementById(`page${i}`).classList.remove('active');
            document.getElementById(`page${i}`).querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
            });
        }
        
        document.getElementById('introPage').classList.add('active');
        document.getElementById('result').style.display = 'none';
        document.getElementById('reportSection').classList.add('hidden');
        document.getElementById('exportBtn').classList.add('hidden');
        document.getElementById('exportAllBtn').classList.add('hidden');
        document.getElementById('reportBtn').classList.add('hidden');
        document.getElementById('resetBtn').classList.add('hidden');
        
        // Resetear barras de progreso
        for (let i = 1; i <= 4; i++) {
            document.getElementById(`progress${i}`).style.width = '0%';
        }
    }
</script>

</body>
</html>
