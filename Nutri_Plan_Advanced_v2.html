<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/11.7.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.7.3/firebase-auth-compat.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <title>Plan Dietético Personalizado - NutriPlan v2</title>
	  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
	  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	  
	  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-docx-js/0.4.0/html-docx.min.js"></script>
	  
	  



    <style>
    /* --- General Styles --- */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        margin: 0;
        padding: 0;
        background-color: #f8f9fa;
        color: #212529;
        line-height: 1.6;
        font-size: 16px;
        padding-bottom: 80px;
    }

    /* --- Header & Navigation --- */
    header {
        background-color: #ffffff;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border-bottom: 1px solid #dee2e6;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1000;
        box-sizing: border-box;
    }

   .logo a {
            color: #4CAF50;
            text-decoration: none;
            font-size: 1.75em;
            font-weight: 600;
        }
	.dropdown {
            display: none;
            position: absolute;
            top: 60px;
            left: 30px;
            background-color: #ffffff;
            border: 1px solid #ced4da;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.07);
            z-index: 1000;
        }

        .dropdown a {
            display: block;
            padding: 10px 15px;
            color: #343a40;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 500;
        }

        .dropdown a:hover {
            background-color: #e9f5e9;
            color: #388e3c;
        }

    nav ul { list-style: none; padding: 0; margin: 0; display: flex; align-items: center; }
    nav ul li { margin-left: 25px; }
    nav ul li a {
        text-decoration: none;
        color: #495057;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 4px;
        transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
    }
    nav ul li a:hover, nav ul li a.active {
        background-color: #e9f5e9;
        color: #388e3c;
    }
    nav ul li a.active {
        background-color: #c8e6c9;
        color: #2e7d32;
        font-weight: 600;
    }

    /* --- Main Content & Sections --- */
    main {
        padding: 30px 10px;
        max-width: 900px;
        margin: 20px auto;
        padding-top: 100px; /* Adjusted for fixed header */
        padding-bottom: 40px;
        box-sizing: border-box;
    }
    h1, h2, h3, h4 { color: #388E3C; margin-bottom: 20px; font-weight: 600; }
    h1 { font-size: 2.2em; text-align: center; margin-bottom: 30px;}
    h2 { font-size: 1.8em; border-bottom: 2px solid #a5d6a7; padding-bottom: 8px;}
    h3 { font-size: 1.5em; }
    h4 { font-size: 1.2em; color: #1B5E20; margin-top: 25px; }
    section {
        background-color: #ffffff;
        padding: 25px 30px;
        margin-bottom: 30px;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.07);
        border: 1px solid #e0e0e0;
        box-sizing: border-box;
    }
    .intro-section {
        box-shadow: none;
        border: none;
        background-color: transparent; /* Make intro background transparent */
        padding-top: 0;
        margin-bottom: 15px;
    }
	/* --- Lists & Links --- */
        p { color: #495057; margin-bottom: 15px; }
        ul { padding-left: 25px; margin-bottom: 15px; }
        li { margin-bottom: 10px; color: #333; }
        a { color: #0275d8; text-decoration: none; }
        a:hover { text-decoration: underline; }

    /* --- Forms & Inputs --- */
    label { display: block; margin-bottom: 8px; font-weight: 500; color: #343a40; }
    select, input[type="number"], input[type="text"], button { width: 100%; padding: 12px 15px; margin-bottom: 18px; border: 1px solid #ced4da; border-radius: 5px; box-sizing: border-box; font-size: 1em; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
    input[type="number"]:focus, select:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
    input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
    button { background-color: #5cb85c; color: white; cursor: pointer; font-weight: 500; border: none; transition: background-color 0.3s ease, transform 0.1s ease; border-radius: 5px; }
    button:hover { background-color: #4cae4c; transform: translateY(-1px); }
    button:disabled { background-color: #cccccc; cursor: not-allowed; transform: none; }

    /* --- Plan Steps & Results --- */
    #plan-container { display: grid; grid-template-columns: 1fr; gap: 25px; }
    .plan-step { border: 1px solid #e0e0e0; padding: 20px; border-radius: 6px; background-color: #fdfdfd; }
    .plan-step p { color: #495057; margin-bottom: 15px; }

    /* Results divs styling */
    #calorie-result, #weight-goal-result, #energy-balance-result, #macro-result, #meal-result, #time-estimation-result, #step-5-results { /* Updated ID */
        margin-top: 20px; padding: 18px; background-color: #e9f5e9; border: 1px solid #c8e6c9; border-radius: 5px; line-height: 1.7; color: #1B5E20;
        min-height: 30px;
    }
    #calorie-result p, #weight-goal-result p, #time-estimation-result p { margin-bottom: 10px; }
    #calorie-result strong, #weight-goal-result strong, #time-estimation-result strong { color: #388E3C; }

    #macro-result ul, #meal-result ul { padding-left: 25px; margin-top: 10px; }
    #macro-result li, #meal-result li { margin-bottom: 10px; color: #333; }
    #macro-result strong, #meal-result strong { color: #388E3C; }
    #meal-result h3 { margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #c8e6c9; padding-bottom: 10px; }
    #meal-result .plan-step { background-color: #f5fbf5 !important; border: 1px solid #d4eed5; }
    #meal-result h4 { margin-bottom: 10px; }

    /* Chart Containers */
    #chart-container, #weight-chart-container, #time-estimation-chart-container {
        margin-top: 20px;
        padding: 0;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        width: 95%;
        height: 350px;
        position: center;
        display: none; /* Initially hidden */
        box-sizing: border-box;
    }
    #chart-container canvas, #weight-chart-container canvas, #time-estimation-chart-container canvas {
        display: block;
        width: 95% !important;
        height: 100% !important;
    }

    /* Percentage inputs section styling */
    #macro-percentage-inputs, #meal-percentage-inputs { margin-top: 20px; margin-bottom: 15px; padding: 15px; border: 1px dashed #ced4da; border-radius: 4px; background-color: #f8f9fa; }
    #macro-percentage-inputs > label, #meal-percentage-inputs > label { font-weight: 600; margin-bottom: 15px; display: block; }
    #macro-percentage-inputs div, #meal-percentage-inputs div { display: flex; align-items: center; margin-bottom: 10px; }
    #macro-percentage-inputs div label, #meal-percentage-inputs div label { width: 130px; margin-right: 10px; margin-bottom: 0; font-weight: normal; text-align: right; color: #495057; }
    #macro-percentage-inputs div input, #meal-percentage-inputs div input { flex-grow: 1; margin-bottom: 0; padding: 8px 10px; max-width: 100px; }
    #macro-percentage-inputs div span, #meal-percentage-inputs div span { margin-left: 8px; font-weight: 500; }
    #macro-percentage-total, #meal-percentage-total { font-size: 1.1em; text-align: center; margin-top: 15px; font-weight: bold; min-height: 1.2em; }

    /* Notes & Monitoring Section specific styling */
    .notes-section, .monitoring-section {
        margin-top: 25px;
        padding-top: 15px;
        border-top: 1px dashed #a5d6a7;
    }
    .notes-section h4, .monitoring-section h4 {
        margin-bottom: 10px;
        color: #388E3C;
    }
    .notes-section ul, .monitoring-section ul {
        list-style: disc;
        padding-left: 20px;
        margin: 0;
    }
    .notes-section li, .monitoring-section li {
        margin-bottom: 8px;
        color: #1B5E20;
    }
    .notes-section li strong, .monitoring-section li strong {
        color: #1B5E20;
    }
    .monitoring-section h5 {
        color: #388E3C;
        font-weight: 600;
        margin-top: 15px;
        margin-bottom: 5px;
        font-size: 1.1em;
    }
    .monitoring-section ul ul {
        list-style: circle;
        margin-top: 5px;
        margin-left: 15px;
    }
    .monitoring-section ul ul li {
        color: #333;
    }

    /* Detailed Cycle Table Styling (Step 5 - Auto) */
    #detailed-cycle-table-container {
        margin-top: 20px;
        overflow-x: auto; /* Allow horizontal scroll on small screens */
    }
    #detailed-cycle-table {
        width: 85%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 0.9em;
        min-width: 600px; /* Minimum width before scroll appears */
    }
    #detailed-cycle-table th, #detailed-cycle-table td {
        border: 1px solid #c8e6c9;
        padding: 8px 10px;
        text-align: center;
        vertical-align: middle;
    }
    #detailed-cycle-table th {
        background-color: #dcedc8;
        color: #1B5E20;
        font-weight: 600;
        white-space: nowrap; /* Prevent header text wrapping */
    }
    #detailed-cycle-table tr:nth-child(even) {
        background-color: #f1f8e9;
    }
    #detailed-cycle-table td {
        color: #333;
    }
    #detailed-cycle-table td:nth-child(2), /* Fase */
    #detailed-cycle-table td:nth-child(4) { /* Peso */
        text-align: left;
    }
    #detailed-cycle-table .phase-deficit {
        color: #c62828; /* Red for deficit */
    }
    #detailed-cycle-table .phase-surplus {
        color: #2e7d32; /* Dark green for surplus */
    }
    #detailed-cycle-table .phase-break {
        background-color: #fff9c4; /* Light yellow for break */
        color: #5f4300; /* Dark yellow text */
    }

    /* Error message styling */
    .error-message {
        color: #c62828; /* Red */
        font-weight: bold;
        margin-top: 10px;
    }
    /* Info message styling */
    .info-message {
        color: #0275d8; /* Blue */
        font-style: italic;
        margin-top: 10px;
    }

    /* --- Footer --- */
    footer {
        background-color: #e9ecef;
        text-align: center;
        padding: 25px 20px;
        color: #6c757d;
        border-top: 1px solid #dee2e6;
        margin-top: 40px;
        font-size: 0.9em;
    }

    /* Responsive adjustments */
    @media (max-width: 1000px) {
        main {
            max-width: 90%;
            padding: 20px 10px; /* Slightly more padding */
            padding-top: 90px; /* Adjust for header */
            padding-bottom: 30px;
        }
        section {
            padding: 20px 15px;
            margin-bottom: 20px;
        }
        #chart-container, #weight-chart-container, #time-estimation-chart-container {
            height: 300px;
        }
    }

    @media (max-width: 768px) {
        header {
            padding: 10px 15px;
            flex-direction: column;
            align-items: flex-start; /* Align logo left */
            position: static; /* Header scrolls with content */
            width: 100%;
        }
        .logo a {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        nav ul {
            justify-content: flex-start; /* Align nav items left */
            flex-wrap: wrap;
        }
        nav ul li {
            margin: 5px 10px 5px 0; /* Adjust nav item margin */
        }
        main {
            padding-top: 20px; /* Less top padding when header scrolls */
        }
        #macro-percentage-inputs div, #meal-percentage-inputs div {
            flex-direction: column;
            align-items: flex-start;
        }
        #macro-percentage-inputs div label, #meal-percentage-inputs div label {
            width: auto;
            text-align: left;
            margin-bottom: 5px;
        }
        #macro-percentage-inputs div input, #meal-percentage-inputs div input {
            max-width: none; /* Allow inputs to fill width */
        }
        #detailed-cycle-table, #hyperprotein-cycle-table { /* Apply to both tables */
            min-width: 400px;
            font-size: 0.85em;
        }
        #detailed-cycle-table th, #detailed-cycle-table td,
        #hyperprotein-cycle-table th, #hyperprotein-cycle-table td {
            padding: 6px 8px;
			vertical-align: top;
			white-space: pre-line;
			line-height: 1.5;
			
        }
			
    }

    @media (max-width: 480px) {
        nav ul li a {
            padding: 6px 8px;
            font-size: 0.9em;
        }
        h1 { font-size: 1.8em; }
        h2 { font-size: 1.5em; }
        h3 { font-size: 1.3em; }
        #detailed-cycle-table, #hyperprotein-cycle-table { /* Apply to both tables */
            font-size: 0.8em; /* Smaller font for very small screens */
        }
        #detailed-cycle-table th, #detailed-cycle-table td,
        #hyperprotein-cycle-table th, #hyperprotein-cycle-table td {
            padding: 5px 6px;
        }
    }
	  /* Styling for the hyperprotein cycle table (Step 7 - Manual) */
    #hyperprotein-cycle-table-container {
        margin-top: 20px;
        overflow-x: auto; /* Allow horizontal scroll on small screens */
    }
    #hyperprotein-cycle-table {
        width: 90%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 0.9em;
        min-width: 600px; /* Minimum width before scroll appears */
    }
    #hyperprotein-cycle-table th, #hyperprotein-cycle-table td {
        border: 1px solid #c8e6c9;
        padding: 8px 10px;
        text-align: center;
        vertical-align: middle;
    }
    #hyperprotein-cycle-table th {
        background-color: #dcedc8;
        color: #1B5E20;
        font-weight: 600;
        white-space: nowrap; /* Prevent header text wrapping */
    }
    #hyperprotein-cycle-table tr:nth-child(even) {
        background-color: #f1f8e9;
    }
    #hyperprotein-cycle-table td {
        color: #333;
    }
    #hyperprotein-cycle-table td:nth-child(2), /* Fase */
    #hyperprotein-cycle-table td:nth-child(7) { /* Notas */
        text-align: left;
    }
    #hyperprotein-cycle-table .phase-hyperprotein {
        color: #0275d8; /* Blue for hyperprotein */
    }
    #hyperprotein-cycle-table .phase-break {
        background-color: #fff9c4; /* Light yellow for break */
        color: #5f4300; /* Dark yellow text */
    }
	#hyperprotein-cycle-table th:nth-child(6),
			#hyperprotein-cycle-table td:nth-child(6) {
			width: 200px;
			min-width: 200px;
			white-space: pre-line;
			vertical-align: top;
			line-height: 1.5;
		}



		.grid { display: grid; gap: 14px; }
    .grid.cols-2 { grid-template-columns: 1fr 1fr; }
    .grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
    .muted { color: #6c757d; }
    .btn {
        display:inline-flex; align-items:center; gap:8px;
        border:1px solid #c0e0c2; background:#e9f5e9; padding:8px 12px; border-radius:8px;
        cursor:pointer; font-weight:600;
        transition: all 0.2s ease-in-out;
    }
    .btn:hover { background:#dff0df; transform: translateY(-1px); }
    .btn.secondary { background:#fff; border-color:#d0d7de; }
    .btn.danger { background:#fdecea; border-color:#f5c2c7; color:#c92a2a; }
    .btn.danger:hover { background:#fce0e3;}
    .btn-primary {
        background-color: #4CAF50;
        border-color: #4CAF50;
        color: white;
    }
    .btn-primary:hover {
        background-color: #45a049;
        border-color: #45a049;
    }
    .btn-lg {
        padding: 12px 24px;
        font-size: 1.1em;
    }
    input, select { 
        width:100%; 
        padding:8px 10px; 
        border:1px solid #ced4da; 
        border-radius:8px; 
        box-sizing:border-box; 
        font-family: inherit;
        font-size: 0.95em;
    }
    input:focus, select:focus {
        outline: none;
        border-color: #4CAF50;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }
    table { 
        width:100%; 
        border-collapse: collapse; 
        font-size: 0.95em; 
        margin-top:10px; 
    }
    th, td { 
        border-bottom:1px solid #eee; 
        padding:10px; 
        text-align:left; 
        vertical-align: middle; 
    }
    th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    tr:hover td { background:#fafdf9; }
    tfoot td { font-weight:700; background-color: #f8f9fa;}
    .right { text-align:right; }
    .center { text-align: center; }
    .ratio-badge { 
        display:inline-block; 
        padding:6px 10px; 
        border-radius:8px; 
        font-weight:700; 
        font-size: 1.2em; 
    }
    .ratio-high { background:#e3f2fd; border:1px solid #90caf9; }
    .ratio-ok { background:#e8f5e9; border:1px solid #a5d6a7; }
    .ratio-low { background:#fff3cd; border:1px solid #ffecb5; }
    .footer { 
        position:fixed; 
        bottom:0; 
        left:0; 
        right:0; 
        background:#fff; 
        border-top:1px solid #e0e0e0; 
        padding:10px 16px; 
        display:flex; 
        justify-content:space-between; 
        align-items:center; 
        font-size:0.85em; 
    }
    .small { font-size: 0.9em; }
		/* FIX: Estilos añadidos para la sección de ratio y distribución */
    .kpi {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
    }
    .card {
        background-color: #fdfdfd;
        padding: 16px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .card b { font-size: 1.2em; color: #2e7d32; }
    .chip {
        display: inline-block;
        padding: 2px 8px;
        background-color: #e9ecef;
        border-radius: 12px;
        font-size: 0.85em;
    }
    
	
	
	
    /* Estilos específicos para la calculadora nutricional */
    .form-control {
        margin-bottom: 15px;
    }
    .form-control label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #495057;
    }
    .row {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -10px;
    }
    .col-md-4, .col-md-6, .col-md-12 {
        padding: 0 10px;
        margin-bottom: 15px;
    }
    .col-md-4 { flex: 0 0 33.333333%; max-width: 33.333333%; }
    .col-md-6 { flex: 0 0 50%; max-width: 50%; }
    .col-md-12 { flex: 0 0 100%; max-width: 100%; }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        font-weight: 600;
        color: #388E3C;
    }
    
    .alert {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid transparent;
    }
    .alert-info {
        background-color: #e3f2fd;
        border-color: #bbdefb;
        color: #1976d2;
    }
    
    #resultados {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .macro-value {
        font-weight: 700;
        color: #388E3C;
    }
    
    .percentage-bar {
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        margin: 8px 0;
        overflow: hidden;
    }
    
    .percentage-fill {
        height: 100%;
        border-radius: 4px;
    }
    
    .fat-fill { background-color: #4CAF50; }
    .protein-fill { background-color: #2196F3; }
    .carb-fill { background-color: #FF9800; }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .col-md-4, .col-md-6 {
            flex: 0 0 100%;
            max-width: 100%;
        }
        
        header {
            flex-direction: column;
            gap: 15px;
            padding: 15px;
        }
        
        nav ul {
            flex-wrap: wrap;
            justify-content: center;
        }
        
        nav ul li {
            margin: 5px 10px;
        }
        
        h1 {
            font-size: 1.8em;
        }
        
        .kpi {
            grid-template-columns: 1fr;
        }
    }
		/* FIX: Estilos añadidos para mejorar la UI */
    #recipeTable input.edit-grams {
      text-align: right;
      width: 80px;
    }
    #weeklyPlanTable ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    #weeklyPlanTable li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9em;
        background: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
    }
    #weeklyPlanTable li button {
        padding: 2px 6px;
        font-size: 0.8em;
    }
    
    /* Canvas chart container */
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        margin: 20px 0;
    }
    
    /* Loading spinner */
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4CAF50;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

        
        .table-responsive { margin-top: 20px; }
        .macro-input { width: 70px; display: inline-block; margin-right: 5px; }
        .strategy-note { font-size: 0.9em; color: #555; }
  
        .error-message { display: none; color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .form-control:invalid { border-color: #dc3545; }
        .table-responsive { margin-top: 20px; }
        .macro-input { width: 70px; display: inline-block; margin-right: 5px; }
        .strategy-note { font-size: 0.9em; color: #555; }
        .strategy-checkboxes { max-height: 200px; overflow-y: auto; }
</style>
</head>

<body>
    <header>
        <div class="logo">
	  <a href="#" id="logo">NutriPlan_v2</a>
	</div>
	    <div class="dropdown" id="dropdown">
	        <a href="#" onclick="logout()">Cerrar Sesión</a>
	    </div>
        <nav>
            <ul>
                <li><a href="https://fermagil.github.io/Nutri_Plan_v2/Inicio_NutriPlan_v2.html">Inicio</a></li>
				<li><a href="https://fermagil.github.io/Nutri_Plan_v2/Valoracion_Antropometrica_1.html">Valoración Antropometrica</a></li>
                <li><a href="#" class="active">Planificación Avanzada</a></li>
                <li><a href="https://fermagil.github.io/Nutri_Plan_v2/Calculadora_keto_recetas.html">Calculadora</a></li> 
            </ul>
        </nav>
    </header>
	
    <main>
        <section>
            <h1>Crea tu Plan Dietético Personalizado</h1>
            <p style="text-align: center; max-width: 700px; margin: 0 auto 30px auto; color: #495057;">
                Sigue estos pasos guiados para obtener una estimación de tus necesidades nutricionales y generar un plan de comidas orientativo.
                Antes de utilizar los datos obtenidos con esta herramienta, consulta con su Dietista-Nutricionista.
            </p>
        </section>
        <section>
            <div class="plan-step" id="step-1">
                <h2>1. Calcula tus Necesidades y Balance Energético</h2>
                <p>Introduce tus datos básicos para estimar tu Gasto Energético Total (GET) y, si lo deseas, tu ingesta actual para ver tu balance energético.</p>
                <form id="calorie-form">
                    <label for="age">Edad (años):</label>
                    <input type="number" id="age" name="age" required min="1" max="120">

                    <label for="gender">Género Biológico:</label>
                    <select id="gender" name="gender">
                        <option value="male">Masculino</option>
                        <option value="female">Femenino</option>
                    </select>

                    <label for="weight">Peso Actual (kg):</label>
                    <input type="number" id="weight" name="weight" required min="1" step="0.1">

                    <label for="height">Altura (m):</label>
                    <input type="number" id="height" name="height" step="0.01" required min="0.5" max="3" placeholder="Ej: 1.75">

                    <label for="activity">Nivel de Actividad Física Semanal:</label>
                    <select id="activity" name="activity">
                        <option value="sedentary">Sedentario</option>
                        <option value="light">Ligero (1-3 días/sem)</option>
                        <option value="moderate">Moderado (3-5 días/sem)</option>
                        <option value="active">Activo (6-7 días/sem)</option>
                        <option value="very_active">Muy Activo (Intenso/Diario)</option>
                    </select>

                    <label for="estimated-intake">Tu Ingesta Calórica Estimada Actual (kcal/día, opcional):</label>
                    <input type="number" id="estimated-intake" name="estimated-intake" min="0" step="1" placeholder="Si la conoces, ej: 2100">

                    <button type="submit">Calcular GET y Balance</button>
                </form>
                <div id="errorMessage" class="error-message" style="display:none;"></div>
                <div id="errorMeals" class="error-message" style="display:none;"></div>
                <div id="errorMacros" class="error-message" style="display:none;"></div>
                <div id="calorie-result"></div>
                <div id="energy-balance-result"></div>
            </div>

            <div class="plan-step" id="step-2">
                <h2>2. Establece tu Objetivo de Peso y Composición Corporal</h2>
                <p>Define tu objetivo de composición corporal (% grasa). Puedes estimar tu % de grasa actual con básculas de bioimpedancia o calculadoras online.</p>
                <p><em>Si no conoces tu % de grasa actual, puedes usar una <a href="https://www.calculator.net/body-fat-calculator.html" target="_blank" rel="noopener noreferrer">calculadora online</a> (en inglés) o buscar alternativas en español.</em></p>
                <h3>Objetivo Nutricional</h3>
                <label for="objetivo" class="form-label">Selecciona tu objetivo:</label>
                <select id="objetivo" class="form-control" aria-label="Objetivo nutricional" required>
                    <option value="perdida">1. Pérdida de Peso</option>
                    <option value="ganancia">2. Ganancia de Peso</option>
                    <option value="mantenimiento">3. Mantenimiento</option>
                    <option value="mixto">4. Mixto/Combinado</option>
                </select>
                <form id="weight-goal-form">
                    <label for="current-fat-percentage">Grasa Corporal Actual (%):</label>
                    <input type="number" id="current-fat-percentage" name="current-fat-percentage" step="0.1" min="3" max="60" required placeholder="Ej: 25">

                    <label for="target-fat-percentage">Grasa Corporal Objetivo (%):</label>
                    <input type="number" id="target-fat-percentage" name="target-fat-percentage" step="0.1" min="3" max="60" required placeholder="Ej: 15">

                    <label for="desired-lean-mass-gain">Ganancia de Masa Magra/Muscular Deseada (kg, opcional):</label>
                    <input type="number" id="desired-lean-mass-gain" name="desired-lean-mass-gain" step="0.1" min="0" placeholder="Ej: 2 (Dejar en blanco o 0 si no buscas ganar músculo)">

                    <label for="is-athlete">¿Te consideras deportista/atleta?</label>
                    <select id="is-athlete" name="is-athlete">
                        <option value="no">No</option>
                        <option value="yes">Sí</option>
                    </select>

                    <button type="submit" id="calculate-goal-button">Calcular Objetivo y Recomendaciones</button>
                </form>
                <div id="weight-goal-result">
                    <p class="info-message">Completa el Paso 1 para habilitar este cálculo.</p>
                    <div id="weight-chart-container">
                        <canvas id="weightEvolutionChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="plan-step" id="step-3">
                <h2>3. Calcula tus Macronutrientes</h2>
                <p>Define tu objetivo calórico (basado en tu GET y si quieres perder, mantener o ganar peso) y distribuye los macronutrientes.</p>
                <p>Se recomienda para pérdida de peso gradual y sostenible reducir un aporte calórico de entre un 10-20% de tu GET, el cálculo automático lo realiza sobre un 10%. Para ganancia de peso la recomendación sería un aumento del GET entre un 5%-15%, el cálculo automático lo realiza sobre un 5%.</p>
                <p>Tu ingesta objetivo por día puede variar en función de tus necesidades personales de AF y de los ciclos de carga-descarga proteica en un plan de pérdida de peso.</p>
                <form id="macro-form">
                    <label for="goal-calories">Calorías Objetivo Diarias (kcal):</label>
                    <input type="number" id="goal-calories" name="goal-calories" required min="500" placeholder="Introduce las kcal calculadas o deseadas">

                    <div id="macro-percentage-inputs">
                        <label>Distribución de Macronutrientes (% del total calórico):</label>
                        <div>
                            <label for="protein-percentage">Proteína (%):</label>
                            <input type="number" id="protein-percentage" name="protein-percentage" value="30" min="10" max="50" step="1"> <span>%</span>
                        </div>
                        <div>
                            <label for="carb-percentage">Carbohidratos (%):</label>
                            <input type="number" id="carb-percentage" name="carb-percentage" value="40" min="10" max="80" step="1"> <span>%</span>
                        </div>
                        <div>
                            <label for="fat-percentage">Grasas (%):</label>
                            <input type="number" id="fat-percentage" name="fat-percentage" value="30" min="10" max="50" step="1"> <span>%</span>
                        </div>
                        <p id="macro-percentage-total"></p>
                    </div>

                    <button type="button" class="btn btn-primary" id="calculate-macros-button">Calcular Macronutrientes</button>
                </form>
                <div id="macro-result">
                    <p class="info-message">Completa los Pasos 1 y 2 para habilitar este cálculo.</p>
                </div>
                <div id="chart-container">
                    <canvas id="macroChart"></canvas>
                </div>
            </div>

            <div class="plan-step" id="step-4">
                <h2>4. Genera tu Plan de Comidas Orientativo</h2>
                <p>Distribuye tus macronutrientes calculados en diferentes comidas a lo largo del día.</p>
                <form id="meal-form">
                    <div id="meal-percentage-inputs">
                        <label>Distribución de Calorías por Comida (% del total diario):</label>
                        <div><label for="breakfast-perc">Desayuno:</label><input type="number" id="breakfast-perc" value="25" min="0" max="100" step="1"><span>%</span></div>
                        <div><label for="snack1-perc">Media Mañana:</label><input type="number" id="snack1-perc" value="10" min="0" max="100" step="1"><span>%</span></div>
                        <div><label for="lunch-perc">Almuerzo:</label><input type="number" id="lunch-perc" value="30" min="0" max="100" step="1"><span>%</span></div>
                        <div><label for="snack2-perc">Merienda:</label><input type="number" id="snack2-perc" value="10" min="0" max="100" step="1"><span>%</span></div>
                        <div><label for="dinner-perc">Cena:</label><input type="number" id="dinner-perc" value="25" min="0" max="100" step="1"><span>%</span></div>
                        <p id="meal-percentage-total"></p>
                    </div>
                    <button type="submit" id="generate-meals-button">Generar Distribución por Comida</button>
                </form>
                <div id="meal-result">
                    <p class="info-message">Completa el Paso 3 para habilitar este cálculo.</p>
                </div>
            </div>

            <div class="plan-step" id="step-5">
                <h2>5. Tabla de Ciclos y Breaks (Automática)</h2>
                <p>Esta tabla muestra una estructura detallada y orientativa de ciclos de carga-descarga proteica, incluyendo fases de déficit o superávit y descansos (breaks) a mantenimiento. Los valores se basan en los cálculos automáticos de los Pasos 1, 2 y 3.</p>
                <div id="step-5-results">
                    <div id="detailed-cycle-table-container">
                        <p class="info-message"><em>Completa los Pasos 1, 2 y 3 para generar esta tabla.</em></p>
                    </div>
                </div>
            </div>

            <div class="plan-step" id="step-6">
                <h2>6. Estimación de Tiempo (Manual y Opcional)</h2>
                <p>Estima cuánto tiempo podría llevarte alcanzar un cambio de peso específico basándote en un déficit o superávit calórico semanal <strong>que tú definas</strong>. Este cálculo es independiente de la tabla automática del Paso 5 y se usa para la tabla manual del Paso 7.</p>
                <form id="time-estimation-form">
                    <label for="weight-change-goal">Cambio de Peso Total Deseado (kg):</label>
                    <input type="number" id="weight-change-goal" name="weight-change-goal" step="0.1" required placeholder="Ej: -10 para perder, 5 para ganar">

                    <label for="weekly-calorie-diff">Diferencia Calórica Semanal Estimada (kcal):</label>
                    <input type="number" id="weekly-calorie-diff" name="weekly-calorie-diff" step="100" required placeholder="Ej: -3500 para perder 0.5kg/sem, 2000 para ganar">
                    <small>Nota: Se estima que 7700 kcal equivalen a 1 kg de grasa corporal. Para pérdida gradual y sostenible no se aconseja pérdidas de más de 0.5kg/sem (3500kcal/sem). Para ganancia no se aconseja ganancias de más de 0.3kg/sem (2000Kcal/sem)</small>

                    <button type="submit" id="estimate-time-button">Estimar Tiempo</button>
                </form>
                <div id="time-estimation-result">
                    <p class="info-message">Completa el Paso 1 para habilitar esta estimación.</p>
                </div>
                <div id="time-estimation-chart-container">
                    <canvas id="timeEstimationChart"></canvas>
                </div>
            </div>

            <section id="step-7" class="plan-step">
                <h2>7. Tabla de Ciclos Hiperproteicos (Manual)</h2>
                <p>Esta tabla organiza ciclos hiperproteicos (Consumo alto, entre 30-40%) y breaks (Consumo moderado, entre 15-25%), cuya duración se basa en la estimación temporal manual del Paso 6. La cantidad de proteína objetivo para cada fase se calcula aplicando porcentajes específicos sobre las Kcal/día asignadas (un porcentaje más alto para la fase hiperproteica (35%) y uno más bajo para la fase de break (20%)).</p>
                <p>La velocidad de pérdida indicada en kg/semana está basada en el ajuste constante de déficit calórico semanal, señalado en el paso 6. Para la fase hiperproteica se mantiene ese ritmo de pérdida semanal y se reduce a la mitad en la fase de Descanso. El progreso real puede variar.</p>
                <div id="hyperprotein-cycle-table-container">
                    <p id="hyperprotein-info-message" class="info-message">Completa el Paso 6 para generar esta tabla.</p>
                    <table id="hyperprotein-cycle-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Ciclo</th>
                                <th>Fase</th>
                                <th>Semanas</th>
                                <th>Peso (kg) <br>(Inicio → Fin)</th>
                                <th>Kcal/día/AF</th>
                                <th>Proteínas (g/kg)</th>
                                <th>Notas</th>
                            </tr>
                        </thead>
                        <tbody id="hyperprotein-cycle-table-body"></tbody>
                    </table>
                    <div id="hyperprotein-note-container"></div>
                </div>
                <button id="generate-hyperprotein-button" style="margin-top: 15px;">Generar Tabla de Ciclos Hiperproteicos (Manual)</button>
            </section>

            <div>
                <button id="save-pdf-button" style="margin-top: 30px; background-color: #0275d8; width: auto; padding: 12px 25px; display: block; margin-left: auto; margin-right: auto;">Guardar Plan como PDF</button>
            </div>

            <h2>Ciclos Dietéticos</h2>

            <div id="perdidaSection">
                <div class="card my-4">
                    <div class="card-body">
                        <h3>Pérdida de Peso</h3>
                        <form>
                            <div class="mb-3">
                                <label for="fasePerdida" class="form-label">Fase del Ciclo:</label>
                                <select class="form-select" id="fasePerdida">
                                    <option value="induccion_cetogenica">Inducción Cetogénica</option>
                                    <option value="ciclado_metabolico">Ciclado Metabólico</option>
                                    <option value="transicion_mantenimiento">Transición a Mantenimiento</option>
                                    <option value="ketoadaptation">Ketoadaptation</option>
                                </select>
                            </div>
                            <p id="infoMacronutrientes"></p>
                            <div class="mb-3">
                                <label class="form-label">Estrategias Especiales:</label>
                                <div class="strategy-checkboxes">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="ninguna" id="ninguna">
                                        <label class="form-check-label" for="ninguna">Ninguna (Cetosis estricta)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="tkd" id="tkd">
                                        <label class="form-check-label" for="tkd">TKD (25-50g HC pre/post entreno)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="ckd" id="ckd">
                                        <label class="form-check-label" for="ckd">CKD (2 días carb-loading 150-200g HC)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="if_16_8" id="if_16_8">
                                        <label class="form-check-label" for="if_16_8">IF 16:8 (Ventana de alimentación 8 horas)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="refeed" id="refeed">
                                        <label class="form-check-label" for="refeed">Refeed (1-2 días/semana HC alto)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="hiperproteica" id="hiperproteica">
                                        <label class="form-check-label" for="hiperproteica">Hiperproteica (2.5-3.0 g/kg peso proteína)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="carb_cycling" id="carb_cycling">
                                        <label class="form-check-label" for="carb_cycling">Carb Cycling (Días altos/bajos HC)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="protein_cycling" id="protein_cycling">
                                        <label class="form-check-label" for="protein_cycling">Protein Cycling (4 semanas altas + 1 baja proteína)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="timing" id="timing">
                                        <label class="form-check-label" for="timing">Timing Nutricional (HC post-entreno)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="flexible_dieting" id="flexible_dieting">
                                        <label class="form-check-label" for="flexible_dieting">Flexible Dieting (80/20 regla)</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="modoSimplificadoSwitch">
                                <label class="form-check-label" for="modoSimplificadoSwitch">Modo Simplificado</label>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="gananciaSection">
                <div class="card my-4">
                    <div class="card-body">
                        <h3>Ganancia Muscular</h3>
                        <form>
                            <div class="mb-3">
                                <label for="faseGanancia" class="form-label">Fase del Ciclo:</label>
                                <select class="form-select" id="faseGanancia">
                                    <option value="volumen_muscular">Volumen Muscular</option>
                                    <option value="enfocado_masa">Enfocado en Masa</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Estrategias Especiales:</label>
                                <div class="strategy-checkboxes">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="ninguna" id="ningunaGanancia">
                                        <label class="form-check-label" for="ningunaGanancia">Ninguna (Balance HC/proteína)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="carb_cycling" id="carb_cyclingGanancia">
                                        <label class="form-check-label" for="carb_cyclingGanancia">Carb Cycling (Días altos/moderados HC)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="refeed" id="refeedGanancia">
                                        <label class="form-check-label" for="refeedGanancia">Refeed (Días altos HC semanales)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="timing" id="timingGanancia">
                                        <label class="form-check-label" for="timingGanancia">Timing Nutricional (HC post-entreno)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="flexible_dieting" id="flexible_dietingGanancia">
                                        <label class="form-check-label" for="flexible_dietingGanancia">Flexible Dieting (80/20 regla)</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="modoSimplificadoSwitchGanancia">
                                <label class="form-check-label" for="modoSimplificadoSwitchGanancia">Modo Simplificado</label>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="mantenimientoSection">
                <div class="card my-4">
                    <div class="card-body">
                        <h3>Mantenimiento</h3>
                        <form>
                            <div class="mb-3">
                                <label for="faseMantenimiento" class="form-label">Enfoque:</label>
                                <select class="form-select" id="faseMantenimiento">
                                    <option value="equilibrio_flexible">Equilibrio Flexible</option>
                                    <option value="adherencia_social">Adherencia Social</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Estrategias Especiales:</label>
                                <div class="strategy-checkboxes">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="ninguna" id="ningunaMantenimiento">
                                        <label class="form-check-label" for="ningunaMantenimiento">Ninguna (Equilibrio nutricional)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="flexible_dieting" id="flexible_dietingMantenimiento">
                                        <label class="form-check-label" for="flexible_dietingMantenimiento">Flexible Dieting (80/20 regla)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="if_16_8" id="if_16_8Mantenimiento">
                                        <label class="form-check-label" for="if_16_8Mantenimiento">IF 16:8 (Ventana de alimentación 8 horas)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="refeed" id="refeedMantenimiento">
                                        <label class="form-check-label" for="refeedMantenimiento">Refeed (Días altos HC)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="carb_cycling" id="carb_cyclingMantenimiento">
                                        <label class="form-check-label" for="carb_cyclingMantenimiento">Carb Cycling (Días altos/bajos HC)</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="modoSimplificadoSwitchMantenimiento">
                                <label class="form-check-label" for="modoSimplificadoSwitchMantenimiento">Modo Simplificado</label>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="actualSection">
                <div class="card my-4">
                    <div class="card-body">
                        <h3>Plan Actual</h3>
                        <form>
                            <div class="mb-3">
                                <label for="faseActual" class="form-label">Fase Actual:</label>
                                <select class="form-select" id="faseActual">
                                    <option value="volumen">Volumen</option>
                                    <option value="definicion">Definición</option>
                                    <option value="mantenimiento">Mantenimiento</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Estrategias Especiales:</label>
                                <div class="strategy-checkboxes">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="ninguna" id="ningunaActual">
                                        <label class="form-check-label" for="ningunaActual">Ninguna (Balance nutricional)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="carb_cycling" id="carb_cyclingActual">
                                        <label class="form-check-label" for="carb_cyclingActual">Carb Cycling (Días altos/bajos HC)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="refeed" id="refeedActual">
                                        <label class="form-check-label" for="refeedActual">Refeed (Días altos HC)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="flexible_dieting" id="flexible_dietingActual">
                                        <label class="form-check-label" for="flexible_dietingActual">Flexible Dieting (80/20 regla)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="timing" id="timingActual">
                                        <label class="form-check-label" for="timingActual">Timing Nutricional (HC post-entreno)</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="modoSimplificadoSwitchActual">
                                <label class="form-check-label" for="modoSimplificadoSwitchActual">Modo Simplificado</label>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="mixtoSection" style="display: none;">
                <div class="card my-4">
                    <div class="card-body">
                        <h3>Mixto/Combinado</h3>
                        <form>
                            <div class="mb-3">
                                <label for="faseMixto" class="form-label">Fase:</label>
                                <select class="form-select" id="faseMixto">
                                    <option value="volumen">Volumen</option>
                                    <option value="definicion">Definición</option>
                                    <option value="mantenimiento">Mantenimiento</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Estrategias Especiales:</label>
                                <div class="strategy-checkboxes">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="ninguna" id="ningunaMixto">
                                        <label class="form-check-label" for="ningunaMixto">Ninguna</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="carb_cycling" id="carb_cyclingMixto">
                                        <label class="form-check-label" for="carb_cyclingMixto">Carb Cycling</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="refeed" id="refeedMixto">
                                        <label class="form-check-label" for="refeedMixto">Refeed</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="timing" id="timingMixto">
                                        <label class="form-check-label" for="timingMixto">Timing Nutricional</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" value="flexible_dieting" id="flexible_dietingMixto">
                                        <label class="form-check-label" for="flexible_dietingMixto">Flexible Dieting</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="modoSimplificadoSwitchMixto">
                                <label class="form-check-label" for="modoSimplificadoSwitchMixto">Modo Simplificado</label>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <h2>Planificación Temporal</h2>
            <div class="card my-4">
                <div class="card-body">
                    <form>
                        <div class="mb-3">
                            <label for="periodoPlanificacion" class="form-label">Período de Planificación:</label>
                            <select class="form-select" id="periodoPlanificacion">
                                <option value="semanal">Semanal (4 semanas)</option>
                                <option value="mensual">Mensual (12 semanas)</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>

            <button type="button" class="btn btn-primary my-3" id="calculate-macros-button">🧮 Calcular Macronutrientes</button>

            <h2>📊 Resultados de tu Plan Nutricional</h2>
            <div class="card my-4">
                <div class="card-body">
                    <h3>📈 Datos Calculados</h3>
                    <p>Gasto Energético: <span id="gastoEnergetico"></span> kcal/día</p>
                    <p>Calorías Diarias: <span id="caloriasDiarias"></span> kcal</p>
                    <p>Proteínas: <span id="proteinas"></span> g (%)</p>
                    <p>Carbohidratos: <span id="carbohidratos"></span> g (%)</p>
                    <p>Grasas: <span id="grasas"></span> g (%)</p>
                </div>
            </div>

            <div class="card my-4">
                <div class="card-body">
                    <h3>📋 Recomendaciones Específicas</h3>
                    <p id="recomendaciones"></p>
                </div>
            </div>

            <h2>📅 Planificación Temporal</h2>
            <div class="card my-4">
                <div class="card-body">
                    <table class="table" id="tablaPlanificacion">
                        <thead>
                            <tr>
                                <th>Semana</th>
                                <th>Fase</th>
                                <th>Estrategias</th>
                                <th>Calorías (kcal)</th>
                                <th>Proteínas (%)</th>
                                <th>Carbohidratos (%)</th>
                                <th>Grasas (%)</th>
                                <th>PT (g)</th>
                                <th>CH (g)</th>
                                <th>GR (g)</th>
                                <th>Entreno/Días</th>
                                <th>Notas</th>
                            </tr>
                        </thead>
                        <tbody id="tablaPlanificacionBody"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 NutriPlan - Herramienta de planificación dietética orientativa. Consulta siempre a un profesional.</p>
    </footer>

    <script>
(function() {
    // --- Global Variables ---
    let userAge = null;
    let userGender = 'male';
    let userHeightCm = null;
    let userActivityLevel = 'sedentary';
    let currentWeightKg = null;
    let calculatedBMR = null;
    let calculatedTDEE = null;
    let targetWeightKgGlobal = null;
    let goalTypeGlobal = 'maintenance';
    let estimatedWeeksGlobal = 0;
    let targetWeeklyRateKgGlobal = 0;
    let calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0, proteinPerc: 0, carbPerc: 0, fatPerc: 0 };
    let estimatedWeeksManualGlobal = null;
    let weightChangeGoalManualGlobal = null;
    let weeklyCalorieDiffManualGlobal = null;
    let macroChartInstance = null;
    let weightEvolutionChartInstance = null;
    let timeEstimationChartInstance = null;
    const activityMultipliers = {
        male: { sedentary: 1.2, light: 1.56, moderate: 1.78, active: 2.1, very_active: 2.3 },
        female: { sedentary: 1.2, light: 1.55, moderate: 1.64, active: 1.82, very_active: 2 }
    };
    let weeklyMacros = [];

    // --- Mapeo de estrategias permitidas ---
    const estrategiasPermitidas = {
        'induccion_cetogenica': ['ninguna', 'tkd', 'if_16_8', 'refeed'],
        'ciclado_metabolico': ['ninguna', 'tkd', 'ckd', 'carb_cycling', 'timing', 'flexible_dieting'],
        'transicion_mantenimiento': ['ninguna', 'carb_cycling', 'timing', 'flexible_dieting'],
        'ketoadaptation': ['ninguna', 'tkd', 'if_16_8', 'refeed'],
        'volumen_muscular': ['ninguna', 'carb_cycling', 'refeed', 'timing', 'flexible_dieting'],
        'enfocado_masa': ['ninguna', 'carb_cycling', 'refeed', 'timing', 'flexible_dieting'],
        'equilibrio_flexible': ['ninguna', 'flexible_dieting', 'if_16_8', 'refeed', 'carb_cycling'],
        'adherencia_social': ['ninguna', 'flexible_dieting', 'if_16_8', 'refeed', 'carb_cycling'],
        'volumen': ['ninguna', 'carb_cycling', 'refeed', 'flexible_dieting', 'timing'],
        'definicion': ['ninguna', 'carb_cycling', 'refeed', 'flexible_dieting', 'timing'],
        'mantenimiento': ['ninguna', 'carb_cycling', 'refeed', 'flexible_dieting', 'timing']
    };

    // --- Mapeo de descripciones de macronutrientes ---
    const infoMacros = {
        'induccion_cetogenica': '5-10% HC | 65-70% Grasas | 20-25% Proteínas',
        'ciclado_metabolico': '10-25% HC | 40-50% Grasas | 25-30% Proteínas',
        'transicion_mantenimiento': '26-40% HC | 30-35% Grasas | 20-25% Proteínas',
        'ketoadaptation': '60-70% Grasas | Más Proteína',
        'volumen_muscular': '40-50% HC | 20-30% Grasas | 20-30% Proteínas',
        'enfocado_masa': '45-55% HC | 20-25% Grasas | 25-30% Proteínas',
        'equilibrio_flexible': '35-45% HC | 25-35% Grasas | 20-25% Proteínas',
        'adherencia_social': '40-50% HC | 25-30% Grasas | 20-25% Proteínas',
        'volumen': '40-50% HC | 20-30% Grasas | 20-30% Proteínas',
        'definicion': '30-40% HC | 30-35% Grasas | 25-35% Proteínas',
        'mantenimiento': '35-45% HC | 25-35% Grasas | 20-25% Proteínas'
    };

    // --- DOMContentLoaded Listener ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Element References ---
        const calorieForm = document.getElementById('calorie-form');
        const weightGoalForm = document.getElementById('weight-goal-form');
        const macroForm = document.getElementById('macro-form');
        const mealForm = document.getElementById('meal-form');
        const timeEstimationForm = document.getElementById('time-estimation-form');
        const calculateGoalButton = document.getElementById('calculate-goal-button');
        const calculateMacrosButton = document.getElementById('calculate-macros-button');
        const generateMealsButton = document.getElementById('generate-meals-button');
        const estimateTimeButton = document.getElementById('estimate-time-button');
        const generateHyperproteinButton = document.getElementById('generate-hyperprotein-button');
        const savePdfButton = document.getElementById('save-pdf-button');
        const macroPercentageInputs = document.querySelectorAll('#macro-percentage-inputs input[type="number"]');
        const mealPercentageInputs = document.querySelectorAll('#meal-percentage-inputs input[type="number"]');
        const calorieResultDiv = document.getElementById('calorie-result');
        const energyBalanceResultDiv = document.getElementById('energy-balance-result');
        const weightGoalResultDiv = document.getElementById('weight-goal-result');
        const weightChartContainer = document.getElementById('weight-chart-container');
        const macroResultDiv = document.getElementById('macro-result');
        const chartContainer = document.getElementById('chart-container');
        const mealResultDiv = document.getElementById('meal-result');
        const timeEstimationResultDiv = document.getElementById('time-estimation-result');
        const timeChartContainer = document.getElementById('time-estimation-chart-container');
        const step5TableContainer = document.getElementById('detailed-cycle-table-container');
        const hyperproteinTableContainer = document.getElementById('hyperprotein-cycle-table-container');
        const hyperproteinTable = document.getElementById('hyperprotein-cycle-table');
        const hyperproteinTableBody = document.getElementById('hyperprotein-cycle-table-body');
        const hyperproteinInfoMessage = document.getElementById('hyperprotein-info-message');
        const hyperproteinNoteContainer = document.getElementById('hyperprotein-note-container');
        const macroPercentageTotalDiv = document.getElementById('macro-percentage-total');
        const mealPercentageTotalDiv = document.getElementById('meal-percentage-total');
        const goalCaloriesInput = document.getElementById('goal-calories');
        const proteinPercentageInput = document.getElementById('protein-percentage');
        const carbPercentageInput = document.getElementById('carb-percentage');
        const fatPercentageInput = document.getElementById('fat-percentage');
        const errorMessageDiv = document.getElementById('errorMessage');
        const tablaPlanificacionBody = document.getElementById('tablaPlanificacionBody');
        const gastoEnergeticoSpan = document.getElementById('gastoEnergetico');
        const caloriasDiariasSpan = document.getElementById('caloriasDiarias');
        const proteinasSpan = document.getElementById('proteinas');
        const carbohidratosSpan = document.getElementById('carbohidratos');
        const grasasSpan = document.getElementById('grasas');
        const recomendacionesP = document.getElementById('recomendaciones');
        const periodoPlanificacion = document.getElementById('periodoPlanificacion');

        // --- Phase/Strategy DOM Elements ---
        const fasePerdida = document.getElementById('fasePerdida');
        const estrategiasCheckboxesPerdida = document.querySelectorAll('#perdidaSection .strategy-checkboxes .form-check');
        const modoSimplificadoSwitchPerdida = document.getElementById('modoSimplificadoSwitch');
        const infoMacronutrientes = document.getElementById('infoMacronutrientes');
        const faseGanancia = document.getElementById('faseGanancia');
        const estrategiasCheckboxesGanancia = document.querySelectorAll('#gananciaSection .strategy-checkboxes .form-check');
        const modoSimplificadoSwitchGanancia = document.getElementById('modoSimplificadoSwitchGanancia');
        const faseMantenimiento = document.getElementById('faseMantenimiento');
        const estrategiasCheckboxesMantenimiento = document.querySelectorAll('#mantenimientoSection .strategy-checkboxes .form-check');
        const modoSimplificadoSwitchMantenimiento = document.getElementById('modoSimplificadoSwitchMantenimiento');
        const faseActual = document.getElementById('faseActual');
        const estrategiasCheckboxesActual = document.querySelectorAll('#actualSection .strategy-checkboxes .form-check');
        const modoSimplificadoSwitchActual = document.getElementById('modoSimplificadoSwitchActual');
        const faseMixto = document.getElementById('faseMixto');
        const estrategiasCheckboxesMixto = document.querySelectorAll('#mixtoSection .strategy-checkboxes .form-check');
        const modoSimplificadoSwitchMixto = document.getElementById('modoSimplificadoSwitchMixto');

        // --- Utility Functions ---
        function displayError(container, message) {
            if (container) {
                container.innerHTML = `<p class="error-message">${message}</p>`;
                container.style.display = 'block';
            } else {
                console.error("Error container not found for message:", message);
            }
        }

        function displayInfo(container, message) {
            if (container) {
                container.innerHTML = `<p class="info-message">${message}</p>`;
                container.style.display = 'block';
            } else {
                console.error("Info container not found for message:", message);
            }
        }

        function clearContainer(container) {
            if (container) {
                container.innerHTML = '';
                container.style.display = 'none';
            }
        }

        function updateButtonStates() {
            const step1Done = calculatedTDEE !== null && currentWeightKg !== null;
            const step2Done = step1Done && targetWeightKgGlobal !== null;
            const step3Done = step2Done && calculatedMacros.goalCalories > 0;
            const step6Done = step1Done && estimatedWeeksManualGlobal !== null && estimatedWeeksManualGlobal > 0;

            if (calculateGoalButton) calculateGoalButton.disabled = !step1Done;
            if (calculateMacrosButton) calculateMacrosButton.disabled = !step2Done;
            if (generateMealsButton) generateMealsButton.disabled = !step3Done;
            if (estimateTimeButton) estimateTimeButton.disabled = !step1Done;
            if (generateHyperproteinButton) generateHyperproteinButton.disabled = !step6Done;
            if (savePdfButton) savePdfButton.disabled = !step1Done;
        }

        // --- Calculate TMB ---
        function calcularTMB(peso, altura, edad, sexo) {
            return sexo === 'male' ? 10 * peso + 6.25 * altura - 5 * edad + 5 : 10 * peso + 6.25 * altura - 5 * edad - 161;
        }

        // --- Step 1: Calculate Calories ---
        function calculateCalories() {
            clearContainer(calorieResultDiv);
            clearContainer(energyBalanceResultDiv);
            clearContainer(errorMessageDiv);

            userAge = parseInt(calorieForm?.elements['age']?.value);
            userGender = calorieForm?.elements['gender']?.value;
            currentWeightKg = parseFloat(calorieForm?.elements['weight']?.value);
            const heightM = parseFloat(calorieForm?.elements['height']?.value);
            userActivityLevel = calorieForm?.elements['activity']?.value;
            const estimatedIntake = parseInt(calorieForm?.elements['estimated-intake']?.value) || null;

            if (isNaN(userAge) || isNaN(currentWeightKg) || isNaN(heightM) || userAge <= 0 || currentWeightKg <= 0 || heightM <= 0) {
                displayError(calorieResultDiv, 'Por favor, introduce valores válidos para edad, peso y altura.');
                calculatedTDEE = null;
                calculatedBMR = null;
                resetStep2onwards();
                updateButtonStates();
                return;
            }
            userHeightCm = heightM * 100;

            calculatedBMR = calcularTMB(currentWeightKg, userHeightCm, userAge, userGender);
            calculatedTDEE = calculatedBMR * activityMultipliers[userGender][userActivityLevel] * 1.1;

            calorieResultDiv.innerHTML = `
                <h3>Resultados del Gasto Energético:</h3>
                <p>Tu Tasa Metabólica Basal (TMB) estimada es: <strong>${calculatedBMR.toFixed(0)} kcal/día</strong>.</p>
                <p>Tu Gasto Energético Total (GET/TDEE) estimado (con buffer +10%) es: <strong>${calculatedTDEE.toFixed(0)} kcal/día</strong>.</p>
                <p>Este es el número aproximado de calorías que tu cuerpo quema diariamente, incluyendo un margen.</p>`;

            if (estimatedIntake && estimatedIntake > 0) {
                const balance = estimatedIntake - calculatedTDEE;
                let balanceInterpretation = '';
                if (balance > 100) {
                    balanceInterpretation = `Estás en un <strong>superávit calórico</strong> de aproximadamente <strong>${balance.toFixed(0)} kcal/día</strong>. Esto generalmente conduce a una ganancia de peso.`;
                } else if (balance < -100) {
                    balanceInterpretation = `Estás en un <strong>déficit calórico</strong> de aproximadamente <strong>${Math.abs(balance).toFixed(0)} kcal/día</strong>. Esto generalmente conduce a una pérdida de peso.`;
                } else {
                    balanceInterpretation = `Estás cerca de tu <strong>mantenimiento calórico</strong> (balance de <strong>${balance.toFixed(0)} kcal/día</strong>). Tu peso debería mantenerse estable.`;
                }
                energyBalanceResultDiv.innerHTML = `
                    <h3>Balance Energético Estimado:</h3>
                    <p>Tu ingesta estimada (${estimatedIntake} kcal) comparada con tu GET con buffer (${calculatedTDEE.toFixed(0)} kcal):</p>
                    <p>${balanceInterpretation}</p>`;
            } else {
                clearContainer(energyBalanceResultDiv);
            }

            resetStep2onwards();
            updateButtonStates();
        }

        // --- Step 2: Calculate Weight Goal ---
        function calculateWeightGoal() {
            clearContainer(weightGoalResultDiv);
            clearContainer(errorMessageDiv);

            const currentFatPercentage = parseFloat(weightGoalForm?.elements['current-fat-percentage']?.value);
            const targetFatPercentage = parseFloat(weightGoalForm?.elements['target-fat-percentage']?.value);
            const desiredLeanMassGain = parseFloat(weightGoalForm?.elements['desired-lean-mass-gain']?.value) || 0;
            const isAthlete = weightGoalForm?.elements['is-athlete']?.value === 'yes';

            if (!calculatedTDEE || !currentWeightKg) {
                displayError(weightGoalResultDiv, 'Completa el Paso 1 primero.');
                return;
            }

            if (isNaN(currentFatPercentage) || isNaN(targetFatPercentage) || currentFatPercentage < 3 || currentFatPercentage > 60 || targetFatPercentage < 3 || targetFatPercentage > 60) {
                displayError(weightGoalResultDiv, 'Introduce porcentajes de grasa válidos (3-60%).');
                return;
            }

            const currentFatMass = currentWeightKg * (currentFatPercentage / 100);
            const currentLeanMass = currentWeightKg - currentFatMass;
            const targetLeanMass = currentLeanMass + desiredLeanMassGain;
            const targetWeightKg = targetLeanMass / (1 - targetFatPercentage / 100);
            const weightChange = targetWeightKg - currentWeightKg;
            goalTypeGlobal = weightChange < -0.5 ? 'perdida' : weightChange > 0.5 ? 'ganancia' : 'mantenimiento';
            targetWeeklyRateKgGlobal = goalTypeGlobal === 'perdida' ? -0.5 : goalTypeGlobal === 'ganancia' ? 0.3 : 0;
            estimatedWeeksGlobal = targetWeeklyRateKgGlobal !== 0 ? Math.abs(Math.round(weightChange / targetWeeklyRateKgGlobal)) : 0;
            targetWeightKgGlobal = targetWeightKg;

            let goalCalories = calculatedTDEE;
            if (goalTypeGlobal === 'perdida') goalCalories *= 0.9; // 10% deficit
            else if (goalTypeGlobal === 'ganancia') goalCalories *= 1.05; // 5% surplus

            weightGoalResultDiv.innerHTML = `
                <h3>Objetivo de Peso:</h3>
                <p>Peso Actual: ${currentWeightKg.toFixed(1)} kg (${currentFatPercentage}% grasa)</p>
                <p>Peso Objetivo: ${targetWeightKg.toFixed(1)} kg (${targetFatPercentage}% grasa)</p>
                <p>Cambio de Peso: ${weightChange.toFixed(1)} kg</p>
                <p>Tiempo Estimado: ${estimatedWeeksGlobal} semanas</p>
                <p>Calorías Recomendadas: ${goalCalories.toFixed(0)} kcal/día</p>
                <p>Tipo de Objetivo: ${goalTypeGlobal.charAt(0).toUpperCase() + goalTypeGlobal.slice(1)}</p>`;

            if (weightChartContainer && typeof Chart !== 'undefined') {
                if (weightEvolutionChartInstance) weightEvolutionChartInstance.destroy();
                const ctx = document.getElementById('weightEvolutionChart')?.getContext('2d');
                if (ctx) {
                    const weeks = Array.from({ length: estimatedWeeksGlobal + 1 }, (_, i) => i);
                    const weights = weeks.map(i => currentWeightKg + targetWeeklyRateKgGlobal * i);
                    weightEvolutionChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: weeks,
                            datasets: [{
                                label: 'Peso (kg)',
                                data: weights,
                                borderColor: '#36A2EB',
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: { display: true, text: 'Evolución del Peso' }
                            },
                            scales: {
                                x: { title: { display: true, text: 'Semanas' } },
                                y: { title: { display: true, text: 'Peso (kg)' } }
                            }
                        }
                    });
                }
            }

            resetStep3onwards();
            updateButtonStates();
        }

        // --- Calculate Macronutrients ---
        function calcularMacronutrientes(goalCalories, proteinPerc, carbPerc, fatPerc, objetivo, peso) {
            if (proteinPerc + carbPerc + fatPerc !== 100) {
                return null;
            }

            const proteinGrams = (goalCalories * (proteinPerc / 100)) / 4;
            const carbGrams = (goalCalories * (carbPerc / 100)) / 4;
            const fatGrams = (goalCalories * (fatPerc / 100)) / 9;

            let adjustedProteinPerc = proteinPerc;
            let adjustedCarbPerc = carbPerc;
            let adjustedFatPerc = fatPerc;

            const selectedPhase = objetivo === 'perdida' ? fasePerdida?.value :
                                objetivo === 'ganancia' ? faseGanancia?.value :
                                objetivo === 'mantenimiento' ? faseMantenimiento?.value :
                                objetivo === 'mixto' ? faseMixto?.value :
                                faseActual?.value;

            if (selectedPhase && infoMacros[selectedPhase]) {
                const [carbRange, fatRange, proteinRange] = infoMacros[selectedPhase].split(' | ').map(s => s.match(/\d+-\d+%/)[0]);
                adjustedProteinPerc = parseInt(proteinRange.split('-')[1]);
                adjustedCarbPerc = parseInt(carbRange.split('-')[0]);
                adjustedFatPerc = parseInt(fatRange.split('-')[0]);
            }

            return {
                proteinGrams: (goalCalories * (adjustedProteinPerc / 100)) / 4,
                carbGrams: (goalCalories * (adjustedCarbPerc / 100)) / 4,
                fatGrams: (goalCalories * (adjustedFatPerc / 100)) / 9,
                goalCalories,
                proteinPerc: adjustedProteinPerc,
                carbPerc: adjustedCarbPerc,
                fatPerc: adjustedFatPerc
            };
        }

        // --- Update UI ---
        function actualizarUI(macros, gastoEnergetico, objetivo, selectedStrategies) {
            if (!macros) {
                displayError(errorMessageDiv, 'Error al calcular macronutrientes. Verifica los porcentajes.');
                return;
            }

            // Update Datos Calculados
            if (gastoEnergeticoSpan) gastoEnergeticoSpan.textContent = gastoEnergetico.toFixed(0);
            if (caloriasDiariasSpan) caloriasDiariasSpan.textContent = macros.goalCalories.toFixed(0);
            if (proteinasSpan) proteinasSpan.textContent = `${macros.proteinGrams.toFixed(0)} (${macros.proteinPerc}%)`;
            if (carbohidratosSpan) carbohidratosSpan.textContent = `${macros.carbGrams.toFixed(0)} (${macros.carbPerc}%)`;
            if (grasasSpan) grasasSpan.textContent = `${macros.fatGrams.toFixed(0)} (${macros.fatPerc}%)`;

            // Update Recommendations
            let recomendacion = '';
            if (objetivo === 'perdida') {
                recomendacion = 'Mantén un déficit calórico moderado y prioriza proteínas para preservar masa muscular.';
            } else if (objetivo === 'ganancia') {
                recomendacion = 'Asegura un superávit calórico y entrena con intensidad para maximizar la ganancia muscular.';
            } else if (objetivo === 'mantenimiento') {
                recomendacion = 'Equilibra tu ingesta calórica con tu GET para mantener tu peso actual.';
            } else if (objetivo === 'mixto') {
                recomendacion = 'Alterna fases de volumen y definición según tu plan de entrenamiento.';
            }
            if (recomendacionesP) recomendacionesP.textContent = recomendacion;

            // Update Planificación Temporal Table
            if (tablaPlanificacionBody) {
                tablaPlanificacionBody.innerHTML = '';
                const weeks = periodoPlanificacion?.value === 'mensual' ? 12 : 4;
                weeklyMacros = [];
                for (let i = 1; i <= weeks; i++) {
                    const phase = objetivo === 'mixto' ? (i % 2 === 1 ? 'volumen' : 'definicion') : objetivo;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${i}</td>
                        <td>${phase.charAt(0).toUpperCase() + phase.slice(1)}</td>
                        <td>${selectedStrategies.join(', ') || 'Ninguna'}</td>
                        <td>${macros.goalCalories.toFixed(0)}</td>
                        <td>${macros.proteinPerc}</td>
                        <td>${macros.carbPerc}</td>
                        <td>${macros.fatPerc}</td>
                        <td>${macros.proteinGrams.toFixed(0)}</td>
                        <td>${macros.carbGrams.toFixed(0)}</td>
                        <td>${macros.fatGrams.toFixed(0)}</td>
                        <td>-</td>
                        <td>-</td>`;
                    tablaPlanificacionBody.appendChild(row);
                    weeklyMacros.push({ week: i, phase, macros });
                }
            }

            // Update Macro Result
            displayInfo(macroResultDiv, `
                <h3>Macronutrientes Calculados:</h3>
                <p>Proteínas: ${macros.proteinGrams.toFixed(0)} g (${macros.proteinPerc}%)</p>
                <p>Carbohidratos: ${macros.carbGrams.toFixed(0)} g (${macros.carbPerc}%)</p>
                <p>Grasas: ${macros.fatGrams.toFixed(0)} g (${macros.fatPerc}%)</p>
            `);

            // Update Macro Chart
            if (chartContainer && typeof Chart !== 'undefined') {
                if (macroChartInstance) macroChartInstance.destroy();
                const ctx = document.getElementById('macroChart')?.getContext('2d');
                if (ctx) {
                    macroChartInstance = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: ['Proteínas', 'Carbohidratos', 'Grasas'],
                            datasets: [{
                                data: [macros.proteinGrams, macros.carbGrams, macros.fatGrams],
                                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                                borderColor: ['#fff', '#fff', '#fff'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'top' },
                                title: { display: true, text: 'Distribución de Macronutrientes (g)' }
                            }
                        }
                    });
                }
            }
        }

        // --- Step 3: Calculate Macros ---
        function calcularMacros() {
            clearContainer(errorMessageDiv);
            clearContainer(macroResultDiv);

            const ids = ['weight', 'height', 'age', 'gender', 'activity', 'objetivo', 'periodoPlanificacion'];
            for (const id of ids) {
                const element = document.getElementById(id);
                if (!element) {
                    displayError(errorMessageDiv, `Error: No se encontró el elemento con ID "${id}".`);
                    return;
                }
            }

            const peso = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value);
            const altura = height * 100;
            const edad = parseInt(document.getElementById('age').value);
            const sexo = document.getElementById('gender').value;
            const actividad = document.getElementById('activity').value;
            const objetivo = document.getElementById('objetivo').value;
            const goalCalories = parseFloat(goalCaloriesInput?.value);
            const proteinPerc = parseFloat(proteinPercentageInput?.value);
            const carbPerc = parseFloat(carbPercentageInput?.value);
            const fatPerc = parseFloat(fatPercentageInput?.value);

            if (isNaN(peso) || isNaN(altura) || isNaN(edad) || !sexo || !actividad || !objetivo) {
                displayError(errorMessageDiv, 'Por favor, completa todos los campos obligatorios en el Paso 1.');
                return;
            }

            if (isNaN(goalCalories) || goalCalories < 500) {
                displayError(errorMessageDiv, 'Por favor, introduce un valor válido para las calorías objetivo (mínimo 500 kcal).');
                return;
            }

            if (isNaN(proteinPerc) || isNaN(carbPerc) || isNaN(fatPerc) || proteinPerc + carbPerc + fatPerc !== 100) {
                displayError(errorMessageDiv, 'Los porcentajes de macronutrientes deben sumar 100%.');
                return;
            }

            const gastoEnergetico = Math.round(calcularTMB(peso, altura, edad, sexo) * activityMultipliers[sexo][actividad]);
            if (isNaN(gastoEnergetico) || gastoEnergetico <= 0) {
                displayError(errorMessageDiv, 'Error al calcular el gasto energético. Verifica los datos personales.');
                return;
            }

            const selectedStrategies = [];
            const checkboxes = objetivo === 'perdida' ? estrategiasCheckboxesPerdida :
                              objetivo === 'ganancia' ? estrategiasCheckboxesGanancia :
                              objetivo === 'mantenimiento' ? estrategiasCheckboxesMantenimiento :
                              objetivo === 'mixto' ? estrategiasCheckboxesMixto :
                              estrategiasCheckboxesActual;
            checkboxes.forEach(div => {
                const checkbox = div.querySelector('input');
                if (checkbox.checked) selectedStrategies.push(checkbox.value);
            });

            const macros = calcularMacronutrientes(goalCalories, proteinPerc, carbPerc, fatPerc, objetivo, peso);
            if (macros) {
                calculatedMacros = macros;
                actualizarUI(macros, gastoEnergetico, objetivo, selectedStrategies);
                generateCycleTable();
                updateButtonStates();
            }
        }

        // --- Step 4: Generate Meals ---
        function generateMeals() {
            clearContainer(mealResultDiv);
            clearContainer(errorMessageDiv);

            const percentages = {
                breakfast: parseFloat(document.getElementById('breakfast-perc')?.value),
                snack1: parseFloat(document.getElementById('snack1-perc')?.value),
                lunch: parseFloat(document.getElementById('lunch-perc')?.value),
                snack2: parseFloat(document.getElementById('snack2-perc')?.value),
                dinner: parseFloat(document.getElementById('dinner-perc')?.value)
            };

            const totalPercentage = Object.values(percentages).reduce((sum, p) => sum + (p || 0), 0);
            if (totalPercentage !== 100) {
                displayError(mealResultDiv, 'Los porcentajes de las comidas deben sumar 100%.');
                return;
            }

            if (!calculatedMacros.goalCalories) {
                displayError(mealResultDiv, 'Completa el Paso 3 primero.');
                return;
            }

            const meals = {};
            for (const [meal, perc] of Object.entries(percentages)) {
                const calories = calculatedMacros.goalCalories * (perc / 100);
                meals[meal] = {
                    calories: calories.toFixed(0),
                    protein: (calories * (calculatedMacros.proteinPerc / 100) / 4).toFixed(0),
                    carbs: (calories * (calculatedMacros.carbPerc / 100) / 4).toFixed(0),
                    fats: (calories * (calculatedMacros.fatPerc / 100) / 9).toFixed(0)
                };
            }

            mealResultDiv.innerHTML = `
                <h3>Distribución de Comidas:</h3>
                <ul>
                    <li>Desayuno: ${meals.breakfast.calories} kcal (P: ${meals.breakfast.protein}g, C: ${meals.breakfast.carbs}g, G: ${meals.breakfast.fats}g)</li>
                    <li>Media Mañana: ${meals.snack1.calories} kcal (P: ${meals.snack1.protein}g, C: ${meals.snack1.carbs}g, G: ${meals.snack1.fats}g)</li>
                    <li>Almuerzo: ${meals.lunch.calories} kcal (P: ${meals.lunch.protein}g, C: ${meals.lunch.carbs}g, G: ${meals.lunch.fats}g)</li>
                    <li>Merienda: ${meals.snack2.calories} kcal (P: ${meals.snack2.protein}g, C: ${meals.snack2.carbs}g, G: ${meals.snack2.fats}g)</li>
                    <li>Cena: ${meals.dinner.calories} kcal (P: ${meals.dinner.protein}g, C: ${meals.dinner.carbs}g, G: ${meals.dinner.fats}g)</li>
                </ul>`;
        }

        // --- Step 5: Generate Cycle Table ---
        function generateCycleTable() {
            clearContainer(step5TableContainer);

            if (!calculatedMacros.goalCalories || !weeklyMacros.length) {
                displayError(step5TableContainer, 'Completa el Paso 3 primero.');
                return;
            }

            const weeks = periodoPlanificacion?.value === 'mensual' ? 12 : 4;
            let tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Semana</th>
                            <th>Fase</th>
                            <th>Calorías (kcal)</th>
                            <th>Proteínas (g)</th>
                            <th>Carbohidratos (g)</th>
                            <th>Grasas (g)</th>
                        </tr>
                    </thead>
                    <tbody>`;
            weeklyMacros.forEach(({ week, phase, macros }) => {
                tableHTML += `
                    <tr>
                        <td>${week}</td>
                        <td>${phase.charAt(0).toUpperCase() + phase.slice(1)}</td>
                        <td>${macros.goalCalories.toFixed(0)}</td>
                        <td>${macros.proteinGrams.toFixed(0)}</td>
                        <td>${macros.carbGrams.toFixed(0)}</td>
                        <td>${macros.fatGrams.toFixed(0)}</td>
                    </tr>`;
            });
            tableHTML += '</tbody></table>';
            step5TableContainer.innerHTML = tableHTML;
        }

        // --- Step 6: Estimate Time ---
        function estimateTime() {
            clearContainer(timeEstimationResultDiv);
            clearContainer(errorMessageDiv);

            weightChangeGoalManualGlobal = parseFloat(timeEstimationForm?.elements['weight-change-goal']?.value);
            weeklyCalorieDiffManualGlobal = parseFloat(timeEstimationForm?.elements['weekly-calorie-diff']?.value);

            if (!calculatedTDEE || isNaN(weightChangeGoalManualGlobal) || isNaN(weeklyCalorieDiffManualGlobal)) {
                displayError(timeEstimationResultDiv, 'Completa el Paso 1 y proporciona valores válidos.');
                return;
            }

            const kgPerWeek = weeklyCalorieDiffManualGlobal / 7700; // 7700 kcal = 1 kg
            estimatedWeeksManualGlobal = Math.abs(Math.round(weightChangeGoalManualGlobal / kgPerWeek));

            timeEstimationResultDiv.innerHTML = `
                <h3>Estimación de Tiempo:</h3>
                <p>Cambio de Peso Deseado: ${weightChangeGoalManualGlobal.toFixed(1)} kg</p>
                <p>Diferencia Calórica Semanal: ${weeklyCalorieDiffManualGlobal} kcal</p>
                <p>Tiempo Estimado: ${estimatedWeeksManualGlobal} semanas</p>`;

            if (timeChartContainer && typeof Chart !== 'undefined') {
                if (timeEstimationChartInstance) timeEstimationChartInstance.destroy();
                const ctx = document.getElementById('timeEstimationChart')?.getContext('2d');
                if (ctx) {
                    const weeks = Array.from({ length: estimatedWeeksManualGlobal + 1 }, (_, i) => i);
                    const weights = weeks.map(i => currentWeightKg + (weightChangeGoalManualGlobal * i / estimatedWeeksManualGlobal));
                    timeEstimationChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: weeks,
                            datasets: [{
                                label: 'Peso (kg)',
                                data: weights,
                                borderColor: '#FF6384',
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: { display: true, text: 'Progreso del Peso' }
                            },
                            scales: {
                                x: { title: { display: true, text: 'Semanas' } },
                                y: { title: { display: true, text: 'Peso (kg)' } }
                            }
                        }
                    });
                }
            }

            updateButtonStates();
        }

        // --- Step 7: Generate Hyperprotein Cycles ---
        function generateHyperproteinCycles() {
            clearContainer(hyperproteinTableContainer);
            clearContainer(hyperproteinInfoMessage);
            if (hyperproteinTable) hyperproteinTable.style.display = 'none';

            if (!estimatedWeeksManualGlobal || !weightChangeGoalManualGlobal || !weeklyCalorieDiffManualGlobal) {
                displayError(hyperproteinTableContainer, 'Completa el Paso 6 primero.');
                return;
            }

            const weeks = Math.min(estimatedWeeksManualGlobal, 12);
            let currentWeight = currentWeightKg;
            const weeklyRate = weeklyCalorieDiffManualGlobal / 7700;
            let tableHTML = '';
            let cycle = 1;
            let weekCounter = 1;

            while (weekCounter <= weeks) {
                // High-protein phase (4 weeks)
                const highProteinWeeks = Math.min(4, weeks - weekCounter + 1);
                const highProteinCalories = calculatedTDEE + (weeklyCalorieDiffManualGlobal / 7);
                const highProteinMacros = calcularMacronutrientes(highProteinCalories, 35, 35, 30, goalTypeGlobal, currentWeight);
                const highProteinWeightChange = weeklyRate * highProteinWeeks;
                tableHTML += `
                    <tr>
                        <td>${cycle}</td>
                        <td>Hiperproteica</td>
                        <td>${weekCounter}-${weekCounter + highProteinWeeks - 1}</td>
                        <td>${currentWeight.toFixed(1)} → ${(currentWeight + highProteinWeightChange).toFixed(1)}</td>
                        <td>${highProteinCalories.toFixed(0)}</td>
                        <td>${(highProteinMacros.proteinGrams / currentWeight).toFixed(1)}</td>
                        <td>Proteína alta (35%)</td>
                    </tr>`;
                currentWeight += highProteinWeightChange;
                weekCounter += highProteinWeeks;

                // Break phase (1 week)
                if (weekCounter <= weeks) {
                    const breakCalories = calculatedTDEE;
                    const breakMacros = calcularMacronutrientes(breakCalories, 20, 45, 35, goalTypeGlobal, currentWeight);
                    const breakWeightChange = weeklyRate / 2;
                    tableHTML += `
                        <tr>
                            <td>${cycle}</td>
                            <td>Descanso</td>
                            <td>${weekCounter}</td>
                            <td>${currentWeight.toFixed(1)} → ${(currentWeight + breakWeightChange).toFixed(1)}</td>
                            <td>${breakCalories.toFixed(0)}</td>
                            <td>${(breakMacros.proteinGrams / currentWeight).toFixed(1)}</td>
                            <td>Proteína moderada (20%)</td>
                        </tr>`;
                    currentWeight += breakWeightChange;
                    weekCounter++;
                }
                cycle++;
            }

            if (hyperproteinTableBody) {
                hyperproteinTableBody.innerHTML = tableHTML;
                hyperproteinTable.style.display = 'table';
            }
            displayInfo(hyperproteinNoteContainer, 'Nota: Los ciclos hiperproteicos alternan 4 semanas de alta proteína con 1 semana de descanso.');
        }

        // --- Save as PDF ---
        function saveAsPDF() {
            if (!calculatedTDEE) {
                displayError(errorMessageDiv, 'Completa al menos el Paso 1 para guardar el plan.');
                return;
            }

            if (typeof jsPDF === 'undefined') {
                displayError(errorMessageDiv, 'No se pudo cargar jsPDF. Incluye la librería jsPDF.');
                return;
            }

            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text('Plan Nutricional Personalizado', 10, 10);
            doc.setFontSize(12);
            let y = 20;

            if (calculatedTDEE) {
                doc.text(`TMB: ${calculatedBMR.toFixed(0)} kcal/día`, 10, y);
                doc.text(`GET (TDEE): ${calculatedTDEE.toFixed(0)} kcal/día`, 10, y + 10);
                y += 20;
            }

            if (targetWeightKgGlobal) {
                doc.text(`Peso Actual: ${currentWeightKg.toFixed(1)} kg`, 10, y);
                doc.text(`Peso Objetivo: ${targetWeightKgGlobal.toFixed(1)} kg`, 10, y + 10);
                doc.text(`Tiempo Estimado: ${estimatedWeeksGlobal} semanas`, 10, y + 20);
                y += 30;
            }

            if (calculatedMacros.goalCalories) {
                doc.text(`Calorías Objetivo: ${calculatedMacros.goalCalories.toFixed(0)} kcal`, 10, y);
                doc.text(`Proteínas: ${calculatedMacros.proteinGrams.toFixed(0)} g (${calculatedMacros.proteinPerc}%)`, 10, y + 10);
                doc.text(`Carbohidratos: ${calculatedMacros.carbGrams.toFixed(0)} g (${calculatedMacros.carbPerc}%)`, 10, y + 20);
                doc.text(`Grasas: ${calculatedMacros.fatGrams.toFixed(0)} g (${calculatedMacros.fatPerc}%)`, 10, y + 30);
                y += 40;
            }

            if (weeklyMacros.length) {
                doc.text('Planificación Temporal:', 10, y);
                weeklyMacros.forEach(({ week, phase, macros }, i) => {
                    doc.text(`Semana ${week}: ${phase} - ${macros.goalCalories.toFixed(0)} kcal`, 10, y + 10 + i * 10);
                });
            }

            doc.save('NutriPlan.pdf');
        }

        // --- Reset Functions ---
        function resetStep2onwards() {
            targetWeightKgGlobal = null;
            goalTypeGlobal = 'maintenance';
            estimatedWeeksGlobal = 0;
            targetWeeklyRateKgGlobal = 0;
            resetStep3onwards();
        }

        function resetStep3onwards() {
            calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0, proteinPerc: 0, carbPerc: 0, fatPerc: 0 };
            weeklyMacros = [];
            clearContainer(macroResultDiv);
            clearContainer(mealResultDiv);
            clearContainer(step5TableContainer);
            clearContainer(hyperproteinTableContainer);
            if (hyperproteinTable) hyperproteinTable.style.display = 'none';
            if (macroChartInstance) {
                macroChartInstance.destroy();
                macroChartInstance = null;
            }
            updateButtonStates();
        }

        // --- Toggle Objective Sections ---
        function toggleOpcionesObjetivo() {
            const objetivo = document.getElementById('objetivo')?.value;
            const contenedores = {
                perdida: document.getElementById('perdidaSection'),
                ganancia: document.getElementById('gananciaSection'),
                mantenimiento: document.getElementById('mantenimientoSection'),
                mixto: document.getElementById('mixtoSection'),
                actual: document.getElementById('actualSection')
            };

            Object.values(contenedores).forEach(contenedor => {
                if (contenedor) contenedor.style.display = 'none';
            });

            if (contenedores[objetivo]) contenedores[objetivo].style.display = 'block';
        }

        // --- Update Strategies ---
        function actualizarEstrategias(faseSelect, checkboxes, modoSimplificadoSwitch) {
            if (!faseSelect || !checkboxes || !modoSimplificadoSwitch) return;
            const faseSeleccionada = faseSelect.value;
            const permitidas = estrategiasPermitidas[faseSeleccionada] || [];

            checkboxes.forEach(div => {
                const checkbox = div.querySelector('input');
                const estrategia = checkbox.value;
                const esSimplificada = ['ninguna', 'tkd', 'if_16_8', 'ckd'].includes(estrategia);

                if (modoSimplificadoSwitch.checked && !esSimplificada) {
                    div.style.display = 'none';
                } else {
                    div.style.display = 'block';
                }

                if (permitidas.includes(estrategia)) {
                    checkbox.disabled = false;
                    div.style.opacity = 1;
                } else {
                    checkbox.disabled = true;
                    checkbox.checked = false;
                    div.style.opacity = 0.5;
                }
            });

            if (faseSelect.id === 'fasePerdida' && infoMacronutrientes) {
                infoMacronutrientes.textContent = infoMacros[faseSeleccionada] || '';
            }
        }

        // --- Update Macro Percentage Total ---
        function updateMacroPercentageTotal() {
            const total = Array.from(macroPercentageInputs).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
            if (macroPercentageTotalDiv) {
                macroPercentageTotalDiv.textContent = `Total: ${total}%`;
                macroPercentageTotalDiv.style.color = total === 100 ? 'green' : 'red';
            }
        }

        // --- Update Meal Percentage Total ---
        function updateMealPercentageTotal() {
            const total = Array.from(mealPercentageInputs).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
            if (mealPercentageTotalDiv) {
                mealPercentageTotalDiv.textContent = `Total: ${total}%`;
                mealPercentageTotalDiv.style.color = total === 100 ? 'green' : 'red';
            }
        }

        // --- Event Listeners ---
        if (calorieForm) {
            calorieForm.addEventListener('submit', (e) => {
                e.preventDefault();
                calculateCalories();
            });
        }

        if (weightGoalForm) {
            weightGoalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                calculateWeightGoal();
            });
        }

        if (macroForm) {
            macroForm.addEventListener('submit', (e) => {
                e.preventDefault();
                calcularMacros();
            });
            macroPercentageInputs.forEach(input => {
                input.addEventListener('input', updateMacroPercentageTotal);
            });
            updateMacroPercentageTotal();
        }

        if (mealForm) {
            mealForm.addEventListener('submit', (e) => {
                e.preventDefault();
                generateMeals();
            });
            mealPercentageInputs.forEach(input => {
                input.addEventListener('input', updateMealPercentageTotal);
            });
            updateMealPercentageTotal();
        }

        if (timeEstimationForm) {
            timeEstimationForm.addEventListener('submit', (e) => {
                e.preventDefault();
                estimateTime();
            });
        }

        if (calculateMacrosButton) {
            calculateMacrosButton.addEventListener('click', calcularMacros);
        }

        if (generateMealsButton) {
            generateMealsButton.addEventListener('click', generateMeals);
        }

        if (estimateTimeButton) {
            estimateTimeButton.addEventListener('click', estimateTime);
        }

        if (generateHyperproteinButton) {
            generateHyperproteinButton.addEventListener('click', generateHyperproteinCycles);
        }

        if (savePdfButton) {
            savePdfButton.addEventListener('click', saveAsPDF);
        }

        const objetivoSelect = document.getElementById('objetivo');
        if (objetivoSelect) {
            objetivoSelect.addEventListener('change', toggleOpcionesObjetivo);
            toggleOpcionesObjetivo();
        }

        if (fasePerdida) {
            fasePerdida.addEventListener('change', () => actualizarEstrategias(fasePerdida, estrategiasCheckboxesPerdida, modoSimplificadoSwitchPerdida));
            modoSimplificadoSwitchPerdida.addEventListener('change', () => actualizarEstrategias(fasePerdida, estrategiasCheckboxesPerdida, modoSimplificadoSwitchPerdida));
            actualizarEstrategias(fasePerdida, estrategiasCheckboxesPerdida, modoSimplificadoSwitchPerdida);
        }

        if (faseGanancia) {
            faseGanancia.addEventListener('change', () => actualizarEstrategias(faseGanancia, estrategiasCheckboxesGanancia, modoSimplificadoSwitchGanancia));
            modoSimplificadoSwitchGanancia.addEventListener('change', () => actualizarEstrategias(faseGanancia, estrategiasCheckboxesGanancia, modoSimplificadoSwitchGanancia));
            actualizarEstrategias(faseGanancia, estrategiasCheckboxesGanancia, modoSimplificadoSwitchGanancia);
        }

        if (faseMantenimiento) {
            faseMantenimiento.addEventListener('change', () => actualizarEstrategias(faseMantenimiento, estrategiasCheckboxesMantenimiento, modoSimplificadoSwitchMantenimiento));
            modoSimplificadoSwitchMantenimiento.addEventListener('change', () => actualizarEstrategias(faseMantenimiento, estrategiasCheckboxesMantenimiento, modoSimplificadoSwitchMantenimiento));
            actualizarEstrategias(faseMantenimiento, estrategiasCheckboxesMantenimiento, modoSimplificadoSwitchMantenimiento);
        }

        if (faseActual) {
            faseActual.addEventListener('change', () => actualizarEstrategias(faseActual, estrategiasCheckboxesActual, modoSimplificadoSwitchActual));
            modoSimplificadoSwitchActual.addEventListener('change', () => actualizarEstrategias(faseActual, estrategiasCheckboxesActual, modoSimplificadoSwitchActual));
            actualizarEstrategias(faseActual, estrategiasCheckboxesActual, modoSimplificadoSwitchActual);
        }

        if (faseMixto) {
            faseMixto.addEventListener('change', () => actualizarEstrategias(faseMixto, estrategiasCheckboxesMixto, modoSimplificadoSwitchMixto));
            modoSimplificadoSwitchMixto.addEventListener('change', () => actualizarEstrategias(faseMixto, estrategiasCheckboxesMixto, modoSimplificadoSwitchMixto));
            actualizarEstrategias(faseMixto, estrategiasCheckboxesMixto, modoSimplificadoSwitchMixto);
        }

        if (typeof Chart === 'undefined') {
            console.error('Chart.js no está disponible.');
            if (errorMessageDiv) {
                displayError(errorMessageDiv, 'No se pudo cargar Chart.js. Algunas funcionalidades estarán limitadas.');
            }
        }

        updateButtonStates();
    });
})();

</body>
</html>
























































