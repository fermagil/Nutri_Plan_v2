<!DOCTYPE html>
<html lang="es">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/11.7.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.7.3/firebase-auth-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <title>Plan Dietético Personalizado - NutriPlan v2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-docx-js/0.4.0/html-docx.min.js"></script>
   
	

    
	  



    <style>
 /* --- NutriPlan Advanced v2 - Hoja de Estilos Principal --- */
/* --- 1. Estilos Base y Globales --- */
{
    box-sizing: border-box;
}
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    margin: 0;
    padding: 0;
    background-color: #f8f9fa;
    color: #212529;
    line-height: 1.6;
    font-size: 16px;
    padding-bottom: 80px;
}
a {
    text-decoration: none;
    color: #4CAF50; /* Verde principal */
}
a:hover {
    text-decoration: underline;
}
h1, h2, h3, h4, h5, h6 {
    color: #388E3C; /* Verde secundario */
    margin-bottom: 20px;
    font-weight: 600;
}
h1 { font-size: 2.2em; text-align: center; margin-bottom: 30px; }
h2 { font-size: 1.8em; border-bottom: 2px solid #a5d6a7; padding-bottom: 8px; }
h3 { font-size: 1.5em; }
h4 { font-size: 1.2em; color: #1B5E20; margin-top: 25px; }
p { margin: 0 0 1rem 0; }
/* --- 2. Encabezado y Navegación --- */
header {
    background-color: #ffffff;
    padding: 15px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    border-bottom: 1px solid #dee2e6;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
}
.logo a {
    color: #4CAF50;
    text-decoration: none;
    font-size: 1.75em;
    font-weight: 600;
}
nav ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    align-items: center;
}
nav ul li {
    margin-left: 25px;
}
nav ul li a {
    text-decoration: none;
    color: #495057;
    font-weight: 500;
    padding: 8px 12px;
    border-radius: 4px;
    transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
}
nav ul li a:hover,
nav ul li a.active {
    background-color: #e9f5e9;
    color: #388e3c;
}
nav ul li a.active {
    background-color: #c8e6c9;
    color: #2e7d32;
    font-weight: 600;
}
/* --- 3. Contenido Principal --- */
main {
    padding: 30px 10px;
    max-width: 950px;
    margin: 20px auto;
    padding-top: 100px; /* Ajustado para el encabezado fijo */
    padding-bottom: 40px;
    box-sizing: border-box;
	
}
h1, h2, h3, h4 { color: #388E3C; margin-bottom: 20px; font-weight: 600; }
    h1 { font-size: 2.2em; text-align: center; margin-bottom: 30px;}
    h2 { font-size: 1.8em; border-bottom: 2px solid #a5d6a7; padding-bottom: 8px;}
    h3 { font-size: 1.5em; }
    h4 { font-size: 1.2em; color: #1B5E20; margin-top: 25px; }
	
/* --- 4. Secciones y Tarjetas --- */
section, .intro-section {
    background-color: #ffffff;
    padding: 25px 30px;
    margin-bottom: 30px;
    border-radius: 8px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.07);
    border: 1px solid #e0e0e0;
    box-sizing: border-box;
}
.intro-section {
    box-shadow: none;
    border: none;
    background-color: transparent;
    padding-top: 0;
    margin-bottom: 15px;
}
.plan-step {
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: box-shadow 0.3s ease;
}
.plan-step:hover {
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.plan-step h2 {
    color: #388E3C;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9ecef;
}
.plan-step h3 {
    color: #495057;
    margin-top: 20px;
    margin-bottom: 15px;
}
.plan-step p {
    color: #495057;
    margin-bottom: 15px;
}
.plan-step p em {
    color: #6c757d;
}
/* --- 5. Formularios y Controles --- */
form {
    margin-top: 15px;
}
label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #495057;
    font-size: 0.9rem;
}
.form-control, .form-select, select, input[type="number"], input[type="text"] {
    display: block;
    width: 100%;
    padding: 0.375rem 0.75rem;
    font-size: 0.9rem;
    font-weight: 400;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid #ced4da;
    appearance: none;
    border-radius: 0.375rem;
    transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    margin-bottom: 15px;
}
.form-control:focus, .form-select:focus, select:focus, input[type="number"]:focus, input[type="text"]:focus {
    color: #495057;
    background-color: #fff;
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
}
.form-check {
    display: block;
    min-height: 1.5rem;
    padding-left: 1.5em;
    margin-bottom: 0.125rem;
}
.form-check .form-check-input {
    float: left;
    margin-left: -1.5em;
}
.form-check-input {
    width: 1em;
    height: 1em;
    margin-top: 0.25em;
    vertical-align: top;
    background-color: #fff;
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
    border: 1px solid rgba(0,0,0,.25);
    appearance: none;
    print-color-adjust: exact;
}
.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
.form-check-label {
    font-weight: 400;
    color: #495057;
    font-size: 0.9rem;
}
.strategy-checkboxes {
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
}
/* --- 6. Botones --- */
button, .btn, input[type="submit"], input[type="button"] {
    display: inline-block;
    font-weight: 400;
    line-height: 1.5;
    color: #212529;
    text-align: center;
    text-decoration: none;
    vertical-align: middle;
    cursor: pointer;
    user-select: none;
    background-color: transparent;
    border: 1px solid transparent;
    padding: 0.375rem 0.75rem;
    font-size: 0.9rem;
    border-radius: 0.375rem;
    transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    margin-top: 10px;
}
/* --- Botones Primarios (Verde) --- */
.btn-primary, button[type="submit"], #calculate-macros-button, #calculate-goal-button, #estimate-time-button, #generate-meals-button, #generate-hyperprotein-button {
    color: #fff;
    background-color: #4CAF50; /* Verde principal */
    border-color: #4CAF50;    /* Verde principal */
}
.btn-primary:hover, button[type="submit"]:hover, #calculate-macros-button:hover, #calculate-goal-button:hover, #estimate-time-button:hover, #generate-meals-button:hover, #generate-hyperprotein-button:hover {
    background-color: #45a049; /* Verde más oscuro al pasar el ratón */
    border-color: #45a049;    /* Verde más oscuro al pasar el ratón */
    color: #fff;              /* Asegurar color blanco en hover */
}
/* --- Botones Grandes --- */
.btn-lg {
    padding: 0.5rem 1rem;
    font-size: 1.1rem;
    border-radius: 0.5rem;
}
/* --- Botones Pequeños --- */
.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8125rem;
    border-radius: 0.25rem;
}
/* --- Botones Outline Primarios (Verde) --- */
.btn-outline-primary {
    color: #4CAF50;       /* Verde para el texto */
    border-color: #4CAF50; /* Verde para el borde */
    background-color: transparent;
}
.btn-outline-primary:hover {
    color: #fff;          /* Texto blanco al pasar el ratón */
    background-color: #4CAF50; /* Fondo verde al pasar el ratón */
    border-color: #4CAF50;     /* Borde verde al pasar el ratón */
}
/* --- Botón Guardar PDF (Especial) --- */
#save-pdf-button {
    margin-top: 30px;
    background-color: #4CAF50; /* Verde principal */
    width: auto;
    padding: 12px 25px;
    display: block;
    margin-left: auto;
    margin-right: auto;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
}
#save-pdf-button:hover {
    background-color: #45a049; /* Verde más oscuro al pasar el ratón */
    color: white;
}
/* --- 7. Tarjetas y Contenedores --- */
.card {
    position: relative;
    display: flex;
    flex-direction: column;
    min-width: 0;
    word-wrap: break-word;
    background-color: #fff;
    background-clip: border-box;
    border: 1px solid rgba(0, 0, 0, 0.125);
    border-radius: 0.375rem; /* Bordes redondeados */
    margin-bottom: 1.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); /* Sombra ligera para profundidad */
}
.card-header {
    padding: 0.75rem 1.25rem;
    margin-bottom: 0;
    /* Color de fondo y borde actualizados para mejor contraste visual */
    background-color: #f8f9fa; /* Fondo gris muy claro */
    border-bottom: 1px solid rgba(0, 0, 0, 0.08); /* Borde inferior sutil */
    font-weight: 500; /* Negrita ligera para el encabezado */
    color: #495057; /* Color de texto gris oscuro */
    border-top-left-radius: calc(0.375rem - 1px); /* Bordes redondeados superiores */
    border-top-right-radius: calc(0.375rem - 1px);
}
.card-body {
    flex: 1 1 auto;
    padding: 1.25rem;
}
/* Asegurar margen consistente cuando se usa la clase mb-4 */
.card.mb-4 {
    margin-bottom: 1.5rem !important;
}
/* --- Sección 6: Ciclos Dietéticos - Estilos para selects de fase --- */

/* 1. Ocultar por defecto todos los selects y labels de fase */
#fasePerdida1, #labelFasePerdida1,
#faseGanancia1, #labelFaseGanancia1,
#enfoqueMantenimiento1, #labelEnfoqueMantenimiento1,
#faseMixto1, #labelFaseMixto1 {
    display: none; /* Elemento completamente oculto e inactivo en el layout */
    margin: 15px 0 10px 0; /* Espaciado vertical al aparecer */
    padding: 10px 15px; /* Relleno interno */
    border: 2px solid #4CAF50; /* Borde verde principal */
    border-radius: 8px; /* Bordes redondeados */
    background-color: #f1f8e9; /* Fondo verde muy claro */
    font-size: 1rem; /* Tamaño de fuente base */
    font-weight: normal;
    color: #2E7D32; /* Color de texto verde oscuro */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Sombra sutil */
    transition: all 0.3s ease-in-out; /* Transición suave para la aparición */
    width: 100%; /* Ancho completo del contenedor */
    max-width: 500px; /* Ancho máximo razonable */
}

/* 2. Asegurar que los labels tengan un estilo consistente */
#labelFasePerdida1, #labelFaseGanancia1,
#labelEnfoqueMantenimiento1, #labelFaseMixto1 {
    font-weight: 600; /* Negrita ligera para labels */
    color: #1B5E20; /* Color de texto verde más oscuro para labels */
    background-color: transparent; /* Fondo transparente para labels */
    border: none; /* Sin borde para labels */
    box-shadow: none; /* Sin sombra para labels */
    padding: 0 0 5px 0; /* Padding solo abajo para separar del select */
    margin-top: 25px; /* Margen superior para separar del contenido anterior */
    margin-bottom: 8px; /* Menor margen inferior */
}

/* 3. Estilos cuando los elementos están destinados a mostrarse */
/* Esta parte requiere que el JS añada una clase o cambie el estilo inline a 'display: block;'
   El CSS solo puede aplicar estilos basados en estados o clases existentes.
   Asumiremos que el JS cambia 'display: none' a 'display: block' */


/* 4. Opcional: Estilos para el contenedor general de estrategias si no los tienes */
#opcionesPerdida1, #opcionesGanancia1,
#opcionesMantenimiento1, #opcionesMixto1 {
    margin-top: 20px;
    padding: 20px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background-color: #fafafa;
}

/* 5. Asegurar que los checkboxes dentro tengan buen espaciado */
.strategy-checkboxes .form-check {
    margin-bottom: 8px; /* Espacio entre checkboxes */
}

/* 6. Estilo para el contenedor principal de la sección 6 */
/* Si quieres un estilo específico para la sección que contiene todo esto */
.card.mb-4 { /* Asumiendo que este es el contenedor de la sección 6 */
    margin-top: 30px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border: 1px solid #e0e0e0;
}

.card.mb-4 .card-header {
    background-color: #e8f5e9; /* Fondo verde muy claro para el encabezado */
    border-bottom: 1px solid #c8e6c9;
    color: #1B5E20;
}

.card.mb-4 .card-header h5 {
    color: #1B5E20;
    margin-bottom: 0;
}
/* --- 8. Tablas --- */
/* Hacer que la tabla sea responsive envolviéndola en un contenedor */
.table-responsive {
    overflow-x: auto; /* Scroll horizontal si el contenido es ancho */
    -webkit-overflow-scrolling: touch; /* Mejor experiencia táctil en dispositivos móviles */
}
/* Estilo base de la tabla */
.table {
    width: 100%;
    margin-bottom: 1rem;
    color: #212529; /* Color de texto base */
    vertical-align: top;
    border-color: #dee2e6; /* Color de borde base */
    /* Eliminar border-collapse por defecto para permitir bordes de celda */
}
/* Celdas de la tabla */
.table th,
.table td {
    padding: 0.5rem; /* Padding interno */
    vertical-align: top; /* Alinear contenido al inicio */
    border-top: 1px solid #dee2e6; /* Borde superior sutil */
}
/* Encabezado de la tabla */
.table thead th {
    vertical-align: bottom;
    border-bottom: 2px solid #dee2e6; /* Borde inferior más grueso para encabezados */
    /* Colores actualizados para encabezados */
    background-color: #93c47d; /* Fondo gris claro para encabezados */
    color: #495057; /* Color de texto gris oscuro */
    text-align: center; /* Centrar texto del encabezado */
    font-weight: 600; /* Negrita para encabezados */
    white-space: nowrap; /* Evitar salto de línea en encabezados si es posible */
}
/* Efecto hover en filas del cuerpo */
.table tbody tr:hover {
    background-color: #f1f3f5; /* Fondo gris muy claro al pasar el ratón */
    transition: background-color 0.15s ease-in-out; /* Transición suave */
}
/* Tabla con filas rayadas */
.table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(0, 0, 0, 0.025); /* Rayas gris muy claro */
}
/* Tabla con bordes */
.table-bordered {
    border: 1px solid #dee2e6; /* Borde exterior */
}
.table-bordered th,
.table-bordered td {
    border: 1px solid #dee2e6; /* Borde para celdas */
}
.table-bordered thead th,
.table-bordered thead td {
    border-bottom-width: 2px; /* Borde inferior más grueso para encabezados */
}
/* --- Estilos Generales para las Tablas de Planificación --- */
.card.tabla-planificacion {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    border: 1px solid rgba(0,0,0,.125);
    border-radius: 0.375rem;
}
.card.tabla-planificacion .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0,0,0,.125);
    padding: 0.75rem 1.25rem;
}
.card.tabla-planificacion .card-body {
    padding: 0;
}
.table-responsive.tabla-planificacion-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border: 0;
    margin: 0;
}
.table.tabla-planificacion {
    width: 100%;
    margin-bottom: 0;
    table-layout: auto;
    font-size: 0.875rem;
    border: 0;
}
.table.tabla-planificacion thead th {
    background-color: #e9ecef;
    color: #495057;
    font-weight: 600;
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    padding: 0.5rem;
    border-bottom: 2px solid #dee2e6;
}
.table.tabla-planificacion tbody tr {
    transition: background-color 0.15s ease-in-out;
}
.table.tabla-planificacion tbody tr:hover {
    background-color: #f1f3f5;
}
.table.tabla-planificacion tbody td {
    padding: 0.4rem 0.5rem;
    vertical-align: top;
    border-top: 1px solid #dee2e6;
    word-break: break-word;
}
/* --- Estilos para Badges dentro de las tablas --- */
.badge {
    display: inline-block;
    padding: 0.35em 0.65em;
    font-size: 0.75em;
    font-weight: 700;
    line-height: 1;
    color: #fff;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.375rem;
    margin: 0.1rem;
}
.bg-danger { background-color: #dc3545 !important; }
.bg-warning { background-color: #ffc107 !important; color: #000 !important; }
.bg-success { background-color: #198754 !important; }
.bg-info { background-color: #0dcaf0 !important; color: #000 !important; }
.bg-secondary { background-color: #6c757d !important; }
.bg-primary { background-color: #0d6efd !important; }
.bg-dark { background-color: #212529 !important; }
/* --- Estilos específicos para la Tabla General del Proceso --- */
#tablaGeneralProcesoContainer .table.tabla-planificacion thead th {
    background-color: #d1ecf1;
    color: #0c5460;
    border-bottom-color: #bee5eb;
}
/* --- Estilos específicos para la Tabla Específica (Planificación Temporal) --- */
#planificacionTemporal .table.tabla-planificacion thead th {
    background-color: #d4edda; /* Verde claro para distinguirla */
    color: #155724;
    border-bottom-color: #c3e6cb;
}
#planificacionTemporal .macro-input {
    width: 60px;
    padding: 0.25rem 0.5rem;
    font-size: 0.8125rem;
    text-align: center;
}
/* --- Estilos Específicos para la Tabla Planificación Temporal Específica --- */

/* 1. Asegurar que el contenedores de la tarjeta tenga el fondo verde claro */
#planificacionTemporal .card {
    background-color: #e8f5e9; /* Fondo verde claro para toda la tarjeta */
    border: 1px solid #c8e6c9; /* Borde verde claro */
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* 2. Estilo para el encabezado de la tarjeta */
#planificacionTemporal .card-header {
    background-color: #e8f5e9; /* Fondo verde claro */
    border-bottom: 1px solid #c8e6c9; /* Borde inferior verde claro */
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: #2e7d32; /* Texto verde oscuro */
}

/* 3. Eliminar la clase 'table-dark' del HTML generado y aplicar estilos directamente */
/* No uses <thead class="table-dark"> */
/* Usa solo <thead> y luego define sus estilos aquí */

/* 4. Estilo para el encabezado de la tabla */
#planificacionTemporal .table thead th {
    background-color: #E6F4EA; /* Fondo verde pistacho claro */
    color: #2E7D32;            /* Letras verdes oscuras */
    border-bottom: 2px solid #C8E6C9; /* Borde inferior verde más oscuro */
    padding: 0.75rem;
    text-align: center;
    font-weight: 600;
}

/* 5. Estilo para el contenedores responsive */
#planificacionTemporal .table-responsive {
    border: 1px solid #c8e6c9; /* Borde verde claro */
    border-radius: 0.375rem; /* Bordes redondeados */
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

/* 6. Estilo para el cuerpo de la tabla */
#planificacionTemporal .table tbody tr:nth-child(even) {
    background-color: #f1f8e9; /* Fondo verde muy claro para filas pares */
}
/* --- Estilos específicos para la Tabla Detallada de Fase --- */
#tablaDetalladaFaseContainer .table.tabla-planificacion thead th {
    background-color: #d4edda; /* Verde claro */
    color: #155724; /* Texto verde oscuro para contraste */
    border-bottom-color: #c3e6cb; /* Borde inferior verde más oscuro */
}
#tablaDetalladaFaseContainer .form-select,
#tablaDetalladaFaseContainer .form-control {
    font-size: 0.8125rem;
    padding: 0.25rem 0.5rem;
    height: auto;
    width: 100%;
}
#tablaDetalladaFaseContainer .form-control-sm {
    min-width: 80px;
}
.table.tabla-planificacion .small-note {
    font-size: 0.75rem;
    color: #6c757d;
    font-style: italic;
    margin: 0;
}
/* --- Estilos Específicos para las Tablas de Planificación --- */

/* --- 1. Tabla General del Proceso --- */
#tablaGeneralProcesoContainer .card.tabla-planificacion .card-header {
    /* Opcional: Estilo del encabezado de la tarjeta */
    background-color: #f1f8e9; /* Fondo verde muy claro para la tarjeta */
    border-bottom: 1px solid #c8e6c9;
}
#tablaGeneralProcesoContainer .table.tabla-planificacion thead th {
    background-color: #E6F4EA; /* Verde pistacho claro */
    color: #2E7D32;            /* Verde oscuro para el texto */
    border-bottom-color: #C8E6C9; /* Verde más oscuro para el borde inferior */
}

/* --- 2. Tabla Específica (Planificación Temporal) --- */
#planificacionTemporal .card.tabla-planificacion .card-header {
    /* Opcional: Estilo del encabezado de la tarjeta */
    background-color: #f1f8e9; /* Fondo verde muy claro para la tarjeta */
    border-bottom: 1px solid #c8e6c9;
}
#planificacionTemporal .table.tabla-planificacion thead th {
    background-color: #E6F4EA; /* Verde pistacho claro */
    color: #2E7D32;            /* Verde oscuro para el texto */
    border-bottom-color: #C8E6C9; /* Verde más oscuro para el borde inferior */
}

/* --- 3. Tabla Detallada de Fase --- */
#tablaDetalladaFaseContainer .card.tabla-planificacion .card-header {
    /* Opcional: Estilo del encabezado de la tarjeta */
    background-color: #f1f8e9; /* Fondo verde muy claro para la tarjeta */
    border-bottom: 1px solid #c8e6c9;
}
#tablaDetalladaFaseContainer .table.tabla-planificacion thead th {
    background-color: #E6F4EA; /* Verde pistacho claro */
    color: #2E7D32;            /* Verde oscuro para el texto */
    border-bottom-color: #C8E6C9; /* Verde más oscuro para el borde inferior */
}
/* --- 3. Tabla Detallada de Fase (Detalles Semanales) --- */

/* --- Contenedor principal de la tarjeta --- */
#tablaDetalladaFaseContainer .card.tabla-planificacion {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    border: 1px solid #d4edda; /* Borde verde claro */
    border-radius: 8px;
    overflow: hidden; /* Para que los bordes redondeados se apliquen correctamente a los hijos */
}

/* --- Encabezado de la tarjeta --- */
#tablaDetalladaFaseContainer .card-header {
    background-color: #e6f4ea; /* Fondo verde pistacho claro */
    border-bottom: 1px solid #c8e6c9; /* Borde inferior verde más oscuro */
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: #2e7d32; /* Texto verde oscuro */
}

/* --- Cuerpo de la tarjeta --- */
#tablaDetalladaFaseContainer .card-body {
    padding: 0; /* Eliminar padding para que la tabla llegue a los bordes */
}

/* --- Contenedor responsive de la tabla --- */
#tablaDetalladaFaseContainer .table-responsive.tabla-planificacion-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border: 0; /* Eliminar borde por defecto del wrapper */
    margin: 0; /* Eliminar margen por defecto */
}

/* --- Estilo base de la tabla --- */
#tablaDetalladaFaseContainer .table.tabla-planificacion {
    width: 100%;
    margin-bottom: 0; /* Eliminar margen inferior por defecto */
    table-layout: auto; /* Permitir que las columnas se ajusten */
    font-size: 0.875rem; /* Tamaño de fuente ligeramente más pequeño */
    border: 0; /* La tabla en sí no necesita borde si está dentro del card-body */
    border-collapse: collapse; /* Asegurar colapso de bordes */
}

/* --- Encabezado de la tabla --- */
#tablaDetalladaFaseContainer .table.tabla-planificacion thead th {
    background-color: #E6F4EA; /* Fondo verde pistacho claro */
    color: #2E7D32;            /* Letras verdes oscuras */
    border-bottom: 2px solid #C8E6C9; /* Borde inferior verde más oscuro */
    padding: 0.75rem;          /* Espaciado interno */
    text-align: center;        /* Texto centrado */
    font-weight: 600;          /* Negrita para encabezados */
    white-space: nowrap;       /* Evitar salto de línea en encabezados si es posible */
    vertical-align: middle;    /* Alineación vertical al centro */
}

/* --- Cuerpo de la tabla --- */
#tablaDetalladaFaseContainer .table.tabla-planificacion tbody td {
    padding: 0.6rem 0.75rem;    /* Espaciado interno reducido */
    vertical-align: top;       /* Alinear contenido al inicio */
    border-top: 1px solid #dee2e6; /* Borde superior sutil */
    word-break: break-word;    /* Romper palabras largas si es necesario */
}

/* --- Filas pares (rayas) --- */
#tablaDetalladaFaseContainer .table.tabla-planificacion tbody tr:nth-child(even) {
    background-color: #f1f8e9; /* Fondo verde muy claro para filas pares */
}

/* --- Efecto hover en filas --- */
#tablaDetalladaFaseContainer .table.tabla-planificacion tbody tr:hover {
    background-color: #e6f4ea; /* Fondo verde pistacho claro al pasar el ratón */
    transition: background-color 0.15s ease-in-out; /* Transición suave */
}

/* --- Notas pequeñas dentro de las celdas --- */
#tablaDetalladaFaseContainer .table.tabla-planificacion .small-note {
    font-size: 0.75rem; /* Fuente aún más pequeña para notas */
    color: #6c757d; /* Gris para notas */
    font-style: italic;
    margin: 0; /* Eliminar márgenes por defecto de párrafos */
}

/* --- Asegurar que los selects y inputs dentro de esta tabla se vean bien --- */
/* Seleccionar por ID de la tabla para mayor especificidad */
#tablaDetalladaInteractiva .form-select,
#tablaDetalladaInteractiva .form-control {
    font-size: 0.8125rem;
    padding: 0.25rem 0.5rem;
    height: auto; /* Permitir que se ajusten en altura */
    width: 100%; /* Ocupar todo el ancho de la celda */
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
}

#tablaDetalladaInteractiva .form-control-sm {
    min-width: 80px; /* Ancho mínimo para inputs de texto */
}

/* --- Media Queries para Responsividad (Opcional pero recomendado) --- */
@media (max-width: 767.98px) {
    #tablaDetalladaFaseContainer .table.tabla-planificacion {
        font-size: 0.75rem; /* Reducir aún más el tamaño de fuente en móviles */
    }
    #tablaDetalladaFaseContainer .table.tabla-planificacion thead th,
    #tablaDetalladaFaseContainer .table.tabla-planificacion tbody td {
        padding: 0.4rem 0.5rem; /* Reducir padding en móviles */
    }
    #tablaDetalladaFaseContainer .form-select,
    #tablaDetalladaFaseContainer .form-control {
        font-size: 0.75rem;
        padding: 0.2rem 0.4rem;
    }
}

/* --- 1. Tabla General del Proceso --- */

/* --- Contenedores de la tarjeta --- */
#tablaGeneralProcesoContainer .card.tabla-planificacion {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    border: 1px solid #d4edda; /* Borde verde claro */
    border-radius: 8px;
}

/* --- Encabezado de la tarjeta --- */
#tablaGeneralProcesoContainer .card-header {
    background-color: #e8f5e9; /* Fondo verde claro para la tarjeta */
    border-bottom: 1px solid #c8e6c9; /* Borde inferior verde más oscuro */
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: #2e7d32; /* Texto verde oscuro */
}

/* --- Cuerpo de la tarjeta --- */
#tablaGeneralProcesoContainer .card-body {
    padding: 0; /* Eliminar padding para que la tabla llegue a los bordes */
}

/* --- Contenedores responsive de la tabla --- */
#tablaGeneralProcesoContainer .table-responsive.tabla-planificacion-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border: 0;
    margin: 0;
    /* Ajustar la barra de desplazamiento */
    scrollbar-width: thin; /* Para Firefox */
    scrollbar-color: #c8e6c9 #e8f5e9; /* Color del thumb y track en Firefox */
}
/* Para Chrome, Edge y Safari */
#tablaGeneralProcesoContainer .table-responsive.tabla-planificacion-wrapper::-webkit-scrollbar {
    width: 8px; /* Ancho de la barra */
}
#tablaGeneralProcesoContainer .table-responsive.tabla-planificacion-wrapper::-webkit-scrollbar-track {
    background: #e8f5e9; /* Fondo del track */
}
#tablaGeneralProcesoContainer .table-responsive.tabla-planificacion-wrapper::-webkit-scrollbar-thumb {
    background-color: #c8e6c9; /* Color del thumb */
    border-radius: 4px; /* Bordes redondeados */
}
#tablaGeneralProcesoContainer .table-responsive.tabla-planificacion-wrapper::-webkit-scrollbar-thumb:hover {
    background-color: #9ccc65; /* Color del thumb al pasar el ratón */
}

/* --- Estilo base de la tabla --- */
#tablaGeneralProcesoContainer .table.tabla-planificacion {
    width: 100%;
    margin-bottom: 0;
    border-collapse: collapse;
    font-size: 0.9rem;
    color: #212529;
}

/* --- Encabezado de la tabla --- */
#tablaGeneralProcesoContainer .table.tabla-planificacion thead th {
    background-color: #E6F4EA; /* Fondo verde pistacho claro */
    color: #2E7D32;            /* Letras verdes oscuras */
    border-bottom: 2px solid #C8E6C9; /* Borde inferior más grueso */
    padding: 0.75rem;
    text-align: center;
    font-weight: 600;
    vertical-align: middle;
}

/* --- Cuerpo de la tabla --- */
#tablaGeneralProcesoContainer .table.tabla-planificacion tbody td {
    padding: 0.75rem;
    vertical-align: top;
    border-top: 1px solid #dee2e6;
    background-color: #f1f8e9; /* Fondo verde muy claro para todas las celdas del cuerpo */
}

/* --- Filas pares (rayas) --- */
#tablaGeneralProcesoContainer .table.tabla-planificacion tbody tr:nth-child(even) {
    background-color: #f1f8e9; /* El mismo fondo que las celdas para evitar rayas */
}

/* --- Efecto hover en filas --- */
#tablaGeneralProcesoContainer .table.tabla-planificacion tbody tr:hover {
    background-color: #e6f4ea; /* Fondo verde pistacho claro al pasar el ratón */
    transition: background-color 0.15s ease-in-out;
}

/* --- Notas pequeñas dentro de las celdas --- */
#tablaGeneralProcesoContainer .table.tabla-planificacion .small-note {
    font-size: 0.75rem;
    color: #6c757d;
    font-style: italic;
    margin: 0;
}
 /* --- Plan Steps & Results --- */
    #plan-container { display: grid; grid-template-columns: 1fr; gap: 25px; }
    .plan-step { border: 1px solid #e0e0e0; padding: 20px; border-radius: 6px; background-color: #fdfdfd; }
    .plan-step p { color: #495057; margin-bottom: 15px; }

    /* Results divs styling */
    #calorie-result, #weight-goal-result, #energy-balance-result, #macro-result, #meal-result, #time-estimation-result, #step-5-results { /* Updated ID */
        margin-top: 20px; padding: 18px; background-color: #e9f5e9; border: 1px solid #c8e6c9; border-radius: 5px; line-height: 1.7; color: #1B5E20;
        min-height: 30px;
    }
    #calorie-result p, #weight-goal-result p, #time-estimation-result p { margin-bottom: 10px; }
    #calorie-result strong, #weight-goal-result strong, #time-estimation-result strong { color: #388E3C; }

    #macro-result ul, #meal-result ul { padding-left: 25px; margin-top: 10px; }
    #macro-result li, #meal-result li { margin-bottom: 10px; color: #333; }
    #macro-result strong, #meal-result strong { color: #388E3C; }
    #meal-result h3 { margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #c8e6c9; padding-bottom: 10px; }
    #meal-result .plan-step { background-color: #f5fbf5 !important; border: 1px solid #d4eed5; }
    #meal-result h4 { margin-bottom: 10px; }
/* --- 9. Gráficos --- */
.chart-container, #chart-container, #weight-chart-container, #time-estimation-chart-container, #macroChart, #weightEvolutionChart, #timeEstimationChart {
    position: relative;
    height: 300px;
    width: 100%;
    margin: 20px 0;
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    display: none;
    box-sizing: border-box;
}
.chart-container canvas, #chart-container canvas, #weight-chart-container canvas, #time-estimation-chart-container canvas, #macroChart, #weightEvolutionChart, #timeEstimationChart {
    display: block;
    width: 95% !important;
    height: 95% !important;
    margin: auto;
}
/* === 📈 ESTILO ESPECÍFICO PARA EL GRÁFICO DE ESTIMACIÓN DE TIEMPO === */
#timeEstimationChart-container {
    position: relative;
    width: 100%;
    height: 400px; /* Más alto para mejor visualización de ambas líneas */
    margin: 25px 0;
    background-color: #ffffff;
    border: 1px solid #a5d6a7;
    border-radius: 12px;
    box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.12),
        0 1px 3px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.4); /* Brillo interno */
    overflow: hidden;
    transition: box-shadow 0.3s ease, transform 0.2s ease;
}

/* Efecto hover: levantar el gráfico al pasar el ratón */
#timeEstimationChart-container:hover {
    box-shadow: 
        0 8px 20px rgba(0, 0, 0, 0.18),
        0 2px 6px rgba(0, 0, 0, 0.12);
    transform: translateY(-2px);
}

/* Canvas interno */
#timeEstimationChart-container canvas {
    display: block;
    width: 98% !important;
    height: 98% !important;
    margin: 1% auto;
    border-radius: 10px; /* Asegura que el canvas no toque el borde */
}

/* Fuente de etiquetas y títulos (mejora legibilidad) */
#timeEstimationChart-container .chartjs-tooltip {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
    border-radius: 6px;
    opacity: 0.95;
}

/* Fondo del canvas (opcional: gradiente suave) */
#timeEstimationChart-container canvas {
    background: linear-gradient(to bottom, #f8fdf9 0%, #ffffff 100%) !important;
}

/* === 🔦 FORZAR VISIBILIDAD DEL CANVAS === */
#timeEstimationChart {
    outline: 2px solid #FFD54F !important; /* Borde amarillo para ver si existe */
    filter: none !important;
    opacity: 1 !important;
    visibility: visible !important;
}

#timeEstimationChart-container canvas {
    border: 1px solid transparent; /* Solo para debugging */
    image-rendering: -webkit-optimize-contrast;
    transform: translateZ(0); /* Fuerza aceleración por hardware */
}
    /* Detailed Cycle Table Styling (Step 5 - Auto) */
    #detailed-cycle-table-container {
        margin-top: 20px;
        overflow-x: auto; /* Allow horizontal scroll on small screens */
    }
    #detailed-cycle-table {
        width: 85%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 0.9em;
        min-width: 600px; /* Minimum width before scroll appears */
    }
    #detailed-cycle-table th, #detailed-cycle-table td {
        border: 1px solid #c8e6c9;
        padding: 8px 10px;
        text-align: center;
        vertical-align: middle;
    }
    #detailed-cycle-table th {
        background-color: #dcedc8;
        color: #1B5E20;
        font-weight: 600;
        white-space: nowrap; /* Prevent header text wrapping */
    }
    #detailed-cycle-table tr:nth-child(even) {
        background-color: #f1f8e9;
    }
    #detailed-cycle-table td {
        color: #333;
    }
    #detailed-cycle-table td:nth-child(2), /* Fase */
    #detailed-cycle-table td:nth-child(4) { /* Peso */
        text-align: left;
    }
    #detailed-cycle-table .phase-deficit {
        color: #c62828; /* Red for deficit */
    }
    #detailed-cycle-table .phase-surplus {
        color: #2e7d32; /* Dark green for surplus */
    }
    #detailed-cycle-table .phase-break {
        background-color: #fff9c4; /* Light yellow for break */
        color: #5f4300; /* Dark yellow text */
    }
	/* Styling for the hyperprotein cycle table (Step 7 - Manual) */
    #hyperprotein-cycle-table-container {
        margin-top: 20px;
        overflow-x: auto; /* Allow horizontal scroll on small screens */
    }
    #hyperprotein-cycle-table {
        width: 90%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 0.9em;
        min-width: 600px; /* Minimum width before scroll appears */
    }
    #hyperprotein-cycle-table th, #hyperprotein-cycle-table td {
        border: 1px solid #c8e6c9;
        padding: 8px 10px;
        text-align: center;
        vertical-align: middle;
    }
    #hyperprotein-cycle-table th {
        background-color: #dcedc8;
        color: #1B5E20;
        font-weight: 600;
        white-space: nowrap; /* Prevent header text wrapping */
    }
    #hyperprotein-cycle-table tr:nth-child(even) {
        background-color: #f1f8e9;
    }
    #hyperprotein-cycle-table td {
        color: #333;
    }
    #hyperprotein-cycle-table td:nth-child(2), /* Fase */
    #hyperprotein-cycle-table td:nth-child(7) { /* Notas */
        text-align: left;
    }
    #hyperprotein-cycle-table .phase-hyperprotein {
        color: #0275d8; /* Blue for hyperprotein */
    }
    #hyperprotein-cycle-table .phase-break {
        background-color: #fff9c4; /* Light yellow for break */
        color: #5f4300; /* Dark yellow text */
    }
	#hyperprotein-cycle-table th:nth-child(6),
			#hyperprotein-cycle-table td:nth-child(6) {
			width: 200px;
			min-width: 200px;
			white-space: pre-line;
			vertical-align: top;
			line-height: 1.5;
		}
 /* Chart Containers */
    #chart-container, #weight-chart-container, #time-estimation-chart-container {
        margin-top: 20px;
        padding: 0;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        width: 95%;
        height: 350px;
        position: center;
        display: none; /* Initially hidden */
        box-sizing: border-box;
    }
    #chart-container canvas, #weight-chart-container canvas, #time-estimation-chart-container canvas {
        display: block;
        width: 95% !important;
        height: 100% !important;
    }

    /* Percentage inputs section styling */
    #macro-percentage-inputs, #meal-percentage-inputs { margin-top: 20px; margin-bottom: 15px; padding: 15px; border: 1px dashed #ced4da; border-radius: 4px; background-color: #f8f9fa; }
    #macro-percentage-inputs > label, #meal-percentage-inputs > label { font-weight: 600; margin-bottom: 15px; display: block; }
    #macro-percentage-inputs div, #meal-percentage-inputs div { display: flex; align-items: center; margin-bottom: 10px; }
    #macro-percentage-inputs div label, #meal-percentage-inputs div label { width: 130px; margin-right: 10px; margin-bottom: 0; font-weight: normal; text-align: right; color: #495057; }
    #macro-percentage-inputs div input, #meal-percentage-inputs div input { flex-grow: 1; margin-bottom: 0; padding: 8px 10px; max-width: 100px; }
    #macro-percentage-inputs div span, #meal-percentage-inputs div span { margin-left: 8px; font-weight: 500; }
    #macro-percentage-total, #meal-percentage-total { font-size: 1.1em; text-align: center; margin-top: 15px; font-weight: bold; min-height: 1.2em; }
/* --- 10. Mensajes --- */
.info-message {
    padding: 12px 20px;
    margin: 15px 0;
    border-radius: 4px;
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}
.alert {
    position: relative;
    padding: 1rem 1rem;
    margin-bottom: 1rem;
    border: 1px solid transparent;
    border-radius: 0.375rem;
}
.alert-info {
    color: #055160;
    background-color: #cff4fc;
    border-color: #b6effb;
}
.alert-danger {
    color: #842029;
    background-color: #f8d7da;
    border-color: #f5c2c7;
}
.error-message, #errorMessage {
    display: none;
    color: #721c24;
    background-color: #f8d7da;
    border: 1px solid #f5c2c7;
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
}
/* --- 11. Elementos Específicos --- */
.percentage-bar-container {
    width: 100%;
    height: 20px;
    background-color: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin: 8px 0;
}
.percentage-fill {
    height: 100%;
    border-radius: 4px;
}
.fat-fill { background-color: #4CAF50; }
.protein-fill { background-color: #2196F3; }
.carb-fill { background-color: #FF9800; }
.fase-container {
    background-color: #e8f5e9;
    border-left: 4px solid #4CAF50;
    padding: 15px;
    margin: 20px 0;
    border-radius: 0 8px 8px 0;
}
.fase-container h4 {
    color: #2E7D32;
    margin-top: 0;
}
/* Labels de los selects de fase */
#labelFasePerdida1, #labelFaseGanancia1, #labelEnfoqueMantenimiento1, #labelFaseMixto1 {
    display: none;
    font-weight: bold;
    color: #2E7D32;
    margin: 15px 0 5px 0;
    font-size: 16px;
}
/* --- 12. Sección de Resultados --- */
#resultados .row {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -15px;
}
#resultados .col-md-6 {
    flex: 0 0 50%;
    max-width: 50%;
    padding: 0 15px;
}
#resultados canvas {
    width: 100% !important;
    height: auto !important;
}
/* --- 13. Sección de Ciclos Diéteticos --- */
.notes-section {
    background-color: #fff3e0;
    border-left: 4px solid #ff9800;
    padding: 15px;
    margin: 15px 0;
    border-radius: 0 8px 8px 0;
}
.notes-section h4 {
    color: #ef6c00;
    margin-top: 0;
}
.notes-section ul {
    padding-left: 20px;
}
.notes-section li {
    margin: 8px 0;
    line-height: 1.5;
}
/* --- 14. Media Queries para Responsividad --- */
@media (max-width: 992px) {
    main {
        padding: 0 10px;
        margin: 10px auto;
        padding-top: 80px;
    }
    .plan-step {
        padding: 20px 15px;
    }
    header {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
    }
    nav ul {
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
    }
    nav ul li {
        margin: 5px 10px;
    }
    nav ul li a {
        padding: 6px 10px;
        font-size: 0.9rem;
    }
    .logo a {
        font-size: 1.3rem;
    }
    #resultados .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
    }
}
@media (max-width: 768px) {
    body {
        font-size: 0.85rem;
    }
    h1 {
        font-size: 1.5rem;
    }
    h2 {
        font-size: 1.3rem;
    }
    .plan-step {
        padding: 15px 10px;
    }
    .card-body {
        padding: 1rem;
    }
    .table th,
    .table td {
        padding: 0.4rem 0.5rem;
        font-size: 0.8rem;
    }
    #save-pdf-button {
        padding: 10px 20px;
        font-size: 0.9rem;
    }
    button, .btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.85rem;
    }
    .btn-sm {
        padding: 0.2rem 0.4rem;
        font-size: 0.75rem;
    }
    .strategy-checkboxes {
        max-height: 250px;
    }
    .chart-container, #chart-container, #weight-chart-container, #time-estimation-chart-container, #macroChart, #weightEvolutionChart, #timeEstimationChart {
        height: 300px;
    }
    footer {
        padding: 15px;
        font-size: 0.8rem;
    }
    .btn-lg {
        padding: 0.4rem 0.8rem;
        font-size: 1rem;
    }
    .table.tabla-planificacion {
        font-size: 0.75rem;
    }
    .table.tabla-planificacion thead th,
    .table.tabla-planificacion tbody td {
        padding: 0.3rem 0.4rem;
    }
    .badge {
        font-size: 0.65em;
        padding: 0.25em 0.5em;
    }
}
@media (max-width: 576px) {
    header {
        flex-direction: column;
        align-items: flex-start;
    }
    nav ul {
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
    }
    nav ul li {
        margin: 5px 0;
        width: 100%;
    }
    nav ul li a {
        display: block;
        padding: 10px;
        border-radius: 0;
        border-bottom: 1px solid #e0e0e0;
    }
    main {
        padding-top: 70px;
    }
    .percentage-bar-container {
        height: 15px;
    }
    #macro-percentage-total, #meal-percentage-total {
        font-size: 0.8rem;
    }
}
/* --- 15. Correcciones y Mejoras Visuales --- */
#macro-percentage-total.valid, #meal-percentage-total.valid {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}
#macro-percentage-total.invalid, #meal-percentage-total.invalid {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c2c7;
}
/* Asegurar que los inputs de número tengan un ancho razonable */
.input-macro-manual {
    width: 100px;
}
/* Estilos para el botón de cerrar si no usas Bootstrap */
/*.btn-close::before {
    content: '×';
    color: black;
}*/
/* FIX: Estilos añadidos para mejorar la UI */
#recipeTable input.edit-grams {
    text-align: right;
    width: 80px;
}
#weeklyPlanTable ul {
    list-style-type: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
}
#weeklyPlanTable li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9em;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
}
#weeklyPlanTable li button {
    padding: 2px 6px;
    font-size: 0.8em;
}
/* Loading spinner */
.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #4CAF50;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
    display: none;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
/* Animación de fade in */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
/* Cuando se muestran los selects */
#fasePerdida1[style*="block"],
#faseGanancia1[style*="block"],
#enfoqueMantenimiento1[style*="block"],
#faseMixto1[style*="block"] {
    display: block !important;
    animation: fadeIn 0.3s ease-in;
}
#labelFasePerdida1[style*="block"],
#labelFaseGanancia1[style*="block"],
#labelEnfoqueMantenimiento1[style*="block"],
#labelFaseMixto1[style*="block"] {
    display: block !important;
    animation: fadeIn 0.3s ease-in;
}
/* --- 16. Sección de Ciclos y Breaks (Automática) --- */
#step-5-results, #hyperprotein-cycle-table-container {
    margin-top: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 5px;
}
#hyperprotein-cycle-table {
    width: 100%;
    margin-top: 15px;
    border-collapse: collapse;
}
#hyperprotein-cycle-table th,
#hyperprotein-cycle-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}
#hyperprotein-cycle-table th {
    background-color: #e9ecef;
    font-weight: bold;
    text-align: center;
}
#hyperprotein-cycle-table tr:nth-child(even) {
    background-color: #f2f2f2;
}
#hyperprotein-cycle-table tr:hover {
    background-color: #ddd;
}
/* --- 17. Pie de Página --- */
footer {
    text-align: center;
    padding: 20px;
    background-color: #f1f3f5;
    color: #6c757d;
    border-top: 1px solid #e0e0e0;
    margin-top: 40px;
    font-size: 0.9rem;
}
/* --- Forzar color verde unificado para todos los encabezados --- */
h1, h2, h3, h4 {
    color: #388E3C !important; /* El !important fuerza la aplicación */
}
.plan-step h2,
.plan-step h3,
.plan-step h4 {
    color: #388E3C;
    /* Asegúrate de que estos no tengan !important en sus otras propiedades
       que quieras mantener, como margin o font-weight */
}
/* --- Estilos Específicos para las Tablas de Planificación --- */

/* --- 1. Tabla General del Proceso --- */
#tablaGeneralProcesoContainer .card.tabla-planificacion {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    border: 1px solid #d4edda; /* Borde verde claro */
    border-radius: 8px;
}

#tablaGeneralProcesoContainer .card-header {
    background-color: #e6f4ea; /* Verde pistacho claro */
    border-bottom: 1px solid #c8e6c9; /* Borde inferior verde más oscuro */
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: #2e7d32; /* Texto verde oscuro */
}

#tablaGeneralProcesoContainer .table.tabla-planificacion {
    width: 100%;
    margin-bottom: 0;
    border-collapse: collapse;
    font-size: 0.9rem;
    color: #212529;
}

#tablaGeneralProcesoContainer .table.tabla-planificacion thead th {
    background-color: #e6f4ea; /* Fondo verde pistacho claro */
    color: #2e7d32; /* Texto verde oscuro */
    border-bottom: 2px solid #c8e6c9; /* Borde inferior más grueso */
    padding: 0.75rem;
    text-align: center;
    font-weight: 600;
}

#tablaGeneralProcesoContainer .table.tabla-planificacion tbody tr:nth-child(even) {
    background-color: #f1f8e9; /* Fondo verde muy claro para filas pares */
}

#tablaGeneralProcesoContainer .table.tabla-planificacion tbody tr:hover {
    background-color: #e6f4ea; /* Fondo verde pistacho claro al pasar el ratón */
}

#tablaGeneralProcesoContainer .table.tabla-planificacion td {
    padding: 0.75rem;
    vertical-align: middle;
    border-top: 1px solid #dee2e6;
}

/* --- 2. Tabla Específica (Planificación Temporal) --- */
#planificacionTemporal .card.tabla-planificacion {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    border: 1px solid #d4edda; /* Borde verde claro */
    border-radius: 8px;
}

#planificacionTemporal .card-header {
    background-color: #e6f4ea; /* Verde pistacho claro */
    border-bottom: 1px solid #c8e6c9; /* Borde inferior verde más oscuro */
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: #2e7d32; /* Texto verde oscuro */
}

#planificacionTemporal .table.tabla-planificacion {
    width: 100%;
    margin-bottom: 0;
    border-collapse: collapse;
    font-size: 0.9rem;
    color: #212529;
}

#planificacionTemporal .table.tabla-planificacion thead th {
    background-color: #e6f4ea; /* Fondo verde pistacho claro */
    color: #2e7d32; /* Texto verde oscuro */
    border-bottom: 2px solid #c8e6c9; /* Borde inferior más grueso */
    padding: 0.75rem;
    text-align: center;
    font-weight: 600;
}

#planificacionTemporal .table.tabla-planificacion tbody tr:nth-child(even) {
    background-color: #f1f8e9; /* Fondo verde muy claro para filas pares */
}

#planificacionTemporal .table.tabla-planificacion tbody tr:hover {
    background-color: #e6f4ea; /* Fondo verde pistacho claro al pasar el ratón */
}

#planificacionTemporal .table.tabla-planificacion td {
    padding: 0.75rem;
    vertical-align: middle;
    border-top: 1px solid #dee2e6;
}

/* --- 3. Tabla Detallada de Fase --- */
#tablaDetalladaFaseContainer .card.tabla-planificacion {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    border: 1px solid #d4edda; /* Borde verde claro */
    border-radius: 8px;
}

#tablaDetalladaFaseContainer .card-header {
    background-color: #e6f4ea; /* Verde pistacho claro */
    border-bottom: 1px solid #c8e6c9; /* Borde inferior verde más oscuro */
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: #2e7d32; /* Texto verde oscuro */
}

#tablaDetalladaFaseContainer .table.tabla-planificacion {
    width: 100%;
    margin-bottom: 0;
    border-collapse: collapse;
    font-size: 0.9rem;
    color: #212529;
}

#tablaDetalladaFaseContainer .table.tabla-planificacion thead th {
    background-color: #e6f4ea; /* Fondo verde pistacho claro */
    color: #2e7d32; /* Texto verde oscuro */
    border-bottom: 2px solid #c8e6c9; /* Borde inferior más grueso */
    padding: 0.75rem;
    text-align: center;
    font-weight: 600;
}

#tablaDetalladaFaseContainer .table.tabla-planificacion tbody tr:nth-child(even) {
    background-color: #f1f8e9; /* Fondo verde muy claro para filas pares */
}

#tablaDetalladaFaseContainer .table.tabla-planificacion tbody tr:hover {
    background-color: #e6f4ea; /* Fondo verde pistacho claro al pasar el ratón */
}

#tablaDetalladaFaseContainer .table.tabla-planificacion td {
    padding: 0.75rem;
    vertical-align: middle;
    border-top: 1px solid #dee2e6;
}
/* --- 4. Tabla de Ciclos Hiperproteicos (Manual) --- */

/* Estilo para el contenedor principal de la tabla */
#hyperprotein-cycle-table-container {
    background-color: #ffffff;
    border: 1px solid #d4edda; /* Borde verde claro */
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* Estilo para el encabezado de la sección (opcional, si hay un h2/h3) */
#step-7.plan-step h2 { /* Ajusta el selector si es diferente */
    color: #2E7D32; /* Verde oscuro para el título */
    border-bottom: 2px solid #E6F4EA; /* Línea divisoria verde muy claro */
    padding-bottom: 10px;
    margin-bottom: 20px;
}

/* Estilo base de la tabla */
#hyperprotein-cycle-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
    color: #212529;
    background-color: #ffffff;
    margin-top: 15px; /* Espacio arriba de la tabla */
}

/* Encabezado de la tabla */
#hyperprotein-cycle-table thead th {
    background-color: #E6F4EA; /* Fondo verde pistacho claro */
    color: #2E7D32;            /* Letras verdes oscuras */
    border: 1px solid #C8E6C9; /* Bordes verdes */
    border-bottom: 2px solid #C8E6C9; /* Borde inferior más grueso */
    padding: 0.75rem;          /* Espaciado interno */
    text-align: center;        /* Texto centrado */
    font-weight: 600;          /* Negrita para encabezados */
    vertical-align: middle;    /* Alineación vertical */
}

/* Cuerpo de la tabla */
#hyperprotein-cycle-table tbody td {
    border: 1px solid #dee2e6; /* Bordes gris claro */
    padding: 0.6rem 0.75rem;    /* Espaciado interno */
    vertical-align: top;       /* Alineación vertical */
}

/* Filas pares */
#hyperprotein-cycle-table tbody tr:nth-child(even) {
    background-color: #f1f8e9; /* Fondo verde muy claro para filas pares */
}

/* Efecto hover en filas */
#hyperprotein-cycle-table tbody tr:hover {
    background-color: #e6f4ea; /* Fondo verde pistacho claro al pasar el ratón */
    transition: background-color 0.15s ease-in-out; /* Transición suave */
}

/* Asegurar que la tabla sea responsive */
#hyperprotein-cycle-table-container {
    overflow-x: auto; /* Scroll horizontal si es necesario */
    -webkit-overflow-scrolling: touch; /* Mejor scroll táctil */
}

/* Ajustar el ancho mínimo si es necesario */
#hyperprotein-cycle-table {
    min-width: 800px; /* O el ancho que mejor se adapte a tus columnas */
}

.accordion-button {
    background-color: #e8f5e9;
    color: #2e7d32;
}
.accordion-button:not(.collapsed) {
    background-color: #c8e6c9;
    color: #1b5e20;
}
.tabla-planificacion-wrapper {
    max-height: 400px;
    overflow-y: auto;
}
.tabla-planificacion th, .tabla-planificacion td {
    font-size: 0.9rem;
    vertical-align: middle;
}
.form-select-sm {
    font-size: 0.85rem;
}
.error-message {
    color: #dc3545;
    font-weight: bold;
}

.text-with-icon {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .text-with-icon p {
            margin-bottom: 0;
            margin-right: 8px;
        }
        .target-icon {
            color: #e63946;
            font-size: 1.4rem;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        .target-icon:hover {
            color: #d00000;
            transform: scale(1.2);
        }
        .info-box {
            background-color: #e8f5e9;
            border-left: 4px solid #49bd3e;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 15px;
            font-size: 16px;
        }
        .info-box a {
            color: #305df0;
            text-decoration: none;
        }
        .info-box a:hover {
            text-decoration: underline;
        }
        .form-label {
            font-weight: 600;
            color: #097a18;
            margin-top: 10px;
        }
        .form-select, .form-control {
            border-radius: 8px;
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            transition: all 0.3s;
        }
        .form-select:focus, .form-control:focus {
            border-color: #4fe357;
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }
        .modal-content {
            border-radius: 12px;
            border: none;
        }
        .modal-header {
            background-color: #156108;
            color: #ffffff;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .btn-close {
            filter: invert(1);
        }
        .modal-body {
            padding: 20px;
        }
        .modal-body p {
            margin-bottom: 15px;
        }
		.modal-xl {
    max-width: 1100px; /* Adjust to a wider width if needed */
}
.modal-body {
    padding: 20px;
    overflow-x: auto; /* Ensures horizontal scrolling if table exceeds width */
}
.table {
    width: 100%; /* Ensures table takes full available width */
    min-width: 1200px; /* Minimum width to prevent collapse */
}
#recommendationResultDiv {
    background-color: #d8f3dc; /* Verde pastel suave (similar a "mint cream" con tono verde) */
    border-radius: 16px;       /* Bordes suavemente redondeados */
    padding: 20px 25px;        /* Espaciado interno */
    border: 1px solid #c7e9c0; /* Borde ligeramente más oscuro para definición */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* Sombra sutil */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #2d6a4f;            /* Texto en verde oscuro para contraste */
    line-height: 1.6;
    margin-top: 20px;
    max-width: 100%;
    overflow: hidden;
}

#recommendationResultDiv h3 {
    color: #1b4332;            /* Verde más oscuro para títulos */
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.4em;
    font-weight: 600;
}

#recommendationResultDiv ul {
    margin: 10px 0;
    padding-left: 20px;
}

#recommendationResultDiv li {
    margin-bottom: 6px;
}

#recommendationResultDiv strong {
    color: #1b4332;
</style>
</head>

<body>
    <header>
        <div class="logo">
	  <a href="#" id="logo">NutriPlan_v2</a>
	</div>
	    <div class="dropdown" id="dropdown">
	        <a href="#" onclick="logout()">Cerrar Sesión</a>
	    </div>
        <nav>
            <ul>
                <li><a href="https://fermagil.github.io/Nutri_Plan_v2/Inicio_NutriPlan_v2.html">Inicio</a></li>
				<li><a href="https://fermagil.github.io/Nutri_Plan_v2/Valoracion_Antropometrica_1.html">Valoración Antropometrica</a></li>
                <li><a href="#" class="active">Planificación Avanzada</a></li>
                <li><a href="https://fermagil.github.io/Nutri_Plan_v2/Calculadora_keto_recetas.html">Calculadora</a></li>
            </ul>
        </nav>
    </header>
	
    <main>
				<section>
					<h1>Crea tu Plan Dietético Personalizado</h1>
					<p style="text-align: center; max-width: 700px; margin: 0 auto 30px auto; color: #495057;">
						Sigue estos pasos guiados para obtener una estimación de tus necesidades nutricionales y generar un plan de comidas orientativo.
						Antes de utilizar los datos obtenidos con esta herramienta, consulta con su Dietista-Nutricionista.
					</p>
			</section>
	    <section>		
            
	
                <div class="plan-step" id="step-1">
                    <h2>1. Calcula tus Necesidades y Balance Energético</h2>
                    <p>Introduce tus datos básicos para estimar tu Gasto Energético Total (GET) y, si lo deseas, tu ingesta actual para ver tu balance energético.</p>
                    <form id="calorie-form">
                        <label for="age">Edad (años):</label>
                         <input type="number" id="age" name="age" required min="1" max="120">

                        <label for="gender">Género Biológico:</label>
                        <select id="gender" name="gender">
                            <option value="male">Masculino</option>
                            <option value="female">Femenino</option>
                        </select>

                        <label for="weight">Peso Actual (kg):</label>
                        <input type="number" id="weight" name="weight" required min="1" step="0.1">

                        <label for="height">Altura (m):</label>
                        <input type="number" id="height" name="height" step="0.01" required min="0.5" max="3" placeholder="Ej: 1.75">

                        <label for="activity">Nivel de Actividad Física Semanal:</label>
                        <select id="activity" name="activity">
                            <option value="sedentary">Sedentario</option>
                            <option value="light">Ligero (1-3 días/sem)</option>
                            <option value="moderate">Moderado (3-5 días/sem)</option>
                            <option value="active">Activo (6-7 días/sem)</option>
                            <option value="very_active">Muy Activo (Intenso/Diario)</option>
                        </select>

                        <label for="estimated-intake">Tu Ingesta Calórica Estimada Actual (kcal/día, opcional):</label>
                        <input type="number" id="estimated-intake" name="estimated-intake" min="0" step="1" placeholder="Si la conoces, ej: 2100">

                        <button type="submit">Calcular GET y Balance</button>
                    </form>
						<div id="errorMeals" class="error-message" style="display:none;"></div>
						<div id="errorMacros" class="error-message" style="display:none;"></div>
						<div id="calorie-result"></div>
						<div id="energy-balance-result"></div>
						<div id="recommendationResultDiv"></div>
						
                </div>
		</section>
        <section>
    <div class="plan-step" id="step-2">
        <h2>2. Establece tu Objetivo de Peso y Composición Corporal</h2>

        <!-- Texto con icono integrado en línea -->
        <div class="mb-3">
            <h5 class="form-label">Objetivo General Mejora Composición Corporal</h5>
            <select id="objetivoGeneral" class="form-select">
                <option value="salud">Salud</option>
                <option value="estetico">Estético</option>
                <option value="rendimiento">Rendimiento (Deportivo)</option>
            </select>
        </div>

        <div class="text-with-icon">
            <p>Define tu objetivo de composición corporal (% GR). Puedes estimar tu % GR actual con básculas de bioimpedancia o calculadoras online.</p>
            <a href="#" data-bs-toggle="modal" data-bs-target="#evidenciaModal" class="target-icon">🎯</a>
        </div>

        <div class="info-box">
            <p><em>Si no conoces tu % de GR y/o tu % MLG actual, ve a la sección <a href="https://fermagil.github.io/Nutri_Plan_v2/Valoracion_Antropometrica_1.html" target="_blank" rel="noopener noreferrer">Valoración Antropométrica</a> de NutriPlan_v2. Si aún no estás listo para usarla, puedes usar una <a href="https://www.calculator.net/body-fat-calculator.html" target="_blank" rel="noopener noreferrer">calculadora online</a> (en inglés) o buscar alternativas en español.</em></p>
        </div>

								
									<h3>Objetivo Nutricional</h3>
										<div class="info-notice" style="display: none; background-color: #e8f5e9; padding: 15px; border-left: 4px solid #2e7d32; border-radius: 4px; font-style: italic;">
											<p>ℹ️ <strong>Información importante:</strong></p>
											<p>Los valores asignados en los campos son <strong>estimaciones orientativas</strong> basadas en tu perfil. Pueden servir como punto de partida, pero <strong>no sustituyen una evaluación precisa</strong>.</p>
											<p>Para una valoración más exacta, te recomendamos utilizar la herramienta <strong>Valoración Antropométrica de NutriPlan_v2</strong>, que permite introducir medidas reales (pliegues, perímetros) para calcular tu %grasa y masa magra con mayor precisión.</p>
											<p><em>Puedes modificar estos valores en cualquier momento según tus objetivos o tras una evaluación profesional.</em></p>
										</div>

				                        <label for="objetivo" class="form-label">Selecciona tu objetivo:</label>
				                         <select id="objetivo" class="form-control" aria-label="Objetivo nutricional" required>
											<option value="sel">Selecciona segun Objetivo</option> 
				                            <option value="perdida1">1. Pérdida de Peso</option>
				                            <option value="ganancia1">2. Ganancia de Peso</option>
				                            <option value="mantenimiento1">3. Mantenimiento</option>
				                            <option value="mixto1">4. Mixto/Combinado</option>
				                        </select>
										
								
							
						<!-- Modal for Evidence Table with Increased Width -->
						<div class="modal fade" id="evidenciaModal" tabindex="-1" aria-labelledby="evidenciaModalLabel" aria-hidden="true">
							<div class="modal-dialog modal-xl">
								<div class="modal-content">
									<div class="modal-header" style="background-color: #2a6621;">
										<h5 class="modal-title" id="evidenciaModalLabel" style="color: #ffffff;">Evidencia Científica de los Rangos</h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
									</div>
									<div class="modal-body">
										<div class="table-responsive">
											<table class="table table-striped">
												<thead>
													<tr>
														<th>Objetivo</th>
														<th>Categoría de AF</th>
														<th>Rango (% GR, % MLG)</th>
														<th>Justificación Científica</th>
														<th>Referencias</th>
													</tr>
												</thead>
												<tbody>
													<tr>
														<td>Salud</td>
														<td>♂️ Sedentarios</td>
														<td>15-25% GR, 75-85% MLG</td>
														<td>Según ACSM, el rango saludable para ♂️ sedentarios es 18-24% GR, con 15-25% aceptable según edad.</td>
														<td><a href="https://www.nejm.org/doi/full/10.1056/NEJMoa1503824" target="_blank">NEJM (2016)</a></td>
													</tr>
													<tr>
														<td>Salud</td>
														<td>♀️ Sedentarias</td>
														<td>20-30% GR, 70-80% MLG</td>
														<td>♀️ tienen mayor GR esencial; ACSM sugiere 25-31%, con 20-30% como subconjunto saludable.</td>
														<td><a href="https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(18)31310-2/fulltext" target="_blank">Lancet (2018)</a></td>
													</tr>
													<tr>
														<td>Salud</td>
														<td>♂️ con AF Leve</td>
														<td>10-18% GR, 82-90% MLG</td>
														<td>Individuos activos muestran menor GR por mayor gasto energético; 10-18% es óptimo con AF leve.</td>
														<td><a href="https://www.nature.com/articles/s41591-019-0565-1" target="_blank">Nature Medicine (2019)</a></td>
													</tr>
													<tr>
														<td>Salud</td>
														<td>♀️ con AF Leve</td>
														<td>18-25% GR, 75-82% MLG</td>
														<td>Alineado con rangos atléticos saludables, preservando GR esencial y mayor MLG.</td>
														<td><a href="https://jamanetwork.com/journals/jama/article-abstract/2768357" target="_blank">JAMA (2020)</a></td>
													</tr>
													<tr>
														<td>Salud</td>
														<td>♂️ con AF Moderada</td>
														<td>8-15% GR, 85-92% MLG</td>
														<td>Rango común en ♂️ moderadamente activos, respaldado por evaluaciones de fitness.</td>
														<td><a href="https://www.nejm.org/doi/full/10.1056/NEJMoa2034577" target="_blank">NEJM (2021)</a></td>
													</tr>
													<tr>
														<td>Salud</td>
														<td>♀️ con AF Moderada</td>
														<td>15-22% GR, 78-85% MLG</td>
														<td>Refleja un balance de GR esencial y MLG en ♀️ moderadamente activas.</td>
														<td><a href="https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(19)32531-2/fulltext" target="_blank">Lancet (2019)</a></td>
													</tr>
													<tr>
														<td>Estético</td>
														<td>♂️ Sedentarios</td>
														<td>12-20% GR, 80-88% MLG</td>
														<td>Rango estéticamente agradable donde comienza a definirse la musculatura sin extrema delgadez.</td>
														<td><a href="https://www.nature.com/articles/s41591-018-0278-4" target="_blank">Nature Medicine (2018)</a></td>
													</tr>
													<tr>
														<td>Estético</td>
														<td>♀️ Sedentarias</td>
														<td>20-28% GR, 72-80% MLG</td>
														<td>♀️ buscan 20-28% GR para balancear curvas con aspecto tonificado.</td>
														<td><a href="https://jamanetwork.com/journals/jama/article-abstract/2763084" target="_blank">JAMA (2019)</a></td>
													</tr>
													<tr>
														<td>Estético</td>
														<td>♂️ con AF Leve</td>
														<td>10-15% GR, 85-90% MLG</td>
														<td>AF leve reduce GR a 10-15%, mejorando visibilidad muscular.</td>
														<td><a href="https://www.nature.com/articles/s41591-020-01189-4" target="_blank">Nature Medicine (2020)</a></td>
													</tr>
													<tr>
														<td>Estético</td>
														<td>♀️ con AF Leve</td>
														<td>18-24% GR, 76-82% MLG</td>
														<td>Refleja un aspecto estético más delgado con AF leve.</td>
														<td><a href="https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(20)30185-9/fulltext" target="_blank">Lancet (2020)</a></td>
													</tr>
													<tr>
														<td>Estético</td>
														<td>♂️ con AF Moderada-Intensa</td>
														<td>8-12% GR, 88-92% MLG</td>
														<td>Competidores de fisicoculturismo apuntan a 8-12% GR para definición.</td>
														<td><a href="https://www.nejm.org/doi/full/10.1056/NEJMoa2109730" target="_blank">NEJM (2021)</a></td>
													</tr>
													<tr>
														<td>Estético</td>
														<td>♀️ con AF Moderada-Intensa</td>
														<td>15-20% GR, 80-85% MLG</td>
														<td>Competidoras femeninas mantienen 15-20% GR para look esculpido.</td>
														<td><a href="https://www.nature.com/articles/s41591-021-01467-4" target="_blank">Nature Medicine (2021)</a></td>
													</tr>
													<tr>
														<td>Rendimiento (Deportivo)</td>
														<td>♂️ con AF Moderada-Intensa</td>
														<td>10-18% GR, 82-90% MLG</td>
														<td>Atletas generales equilibran potencia y resistencia en este rango.</td>
														<td><a href="https://jamanetwork.com/journals/jama/article-abstract/2776377" target="_blank">JAMA (2021)</a></td>
													</tr>
													<tr>
														<td>Rendimiento (Deportivo)</td>
														<td>♀️ con AF Moderada-Intensa</td>
														<td>18-25% GR, 75-82% MLG</td>
														<td>Refleja necesidades de rendimiento y salud en ♀️ atletas.</td>
														<td><a href="https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(21)00753-5/fulltext" target="_blank">Lancet (2021)</a></td>
													</tr>
													<tr>
														<td>Rendimiento (Deportivo)</td>
														<td>♂️ Atletas de Fuerza</td>
														<td>8-15% GR, 85-92% MLG</td>
														<td>Atletas de fuerza optimizan relación potencia-peso con 8-15% GR.</td>
														<td><a href="https://www.nejm.org/doi/full/10.1056/NEJMoa2115133" target="_blank">NEJM (2022)</a></td>
													</tr>
													<tr>
														<td>Rendimiento (Deportivo)</td>
														<td>♀️ Atletas de Fuerza</td>
														<td>15-22% GR, 78-85% MLG</td>
														<td>♀️ atletas de fuerza balancean fuerza con GR esencial (15-22%)</td>
														<td><a href="https://www.nature.com/articles/s41591-022-01845-6" target="_blank">Nature Medicine (2022)</a></td>
													</tr>
												</tbody>
											</table>
										</div>
									</div>
									<div class="modal-footer">
											<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
										</div>
								</div>
							</div>
						</div>

						<form id="weight-goal-form">
							<label for="current-fat-percentage">Grasa Corporal Actual (%):</label>
							<input type="number" id="current-fat-percentage" name="current-fat-percentage" step="0.1" min="3" max="60" required placeholder="Ej: 25">

							<label for="target-fat-percentage">Grasa Corporal Objetivo (%):</label>
							<input type="number" id="target-fat-percentage" name="target-fat-percentage" step="0.1" min="3" max="60" required placeholder="Ej: 15">
							
							<label for="target-muscle-percentage">Masa Muscular (%)</label>
							<input type="number" id="target-muscle-percentage" name="target-muscle-percentage" step="0.1" min="20" max="95"  placeholder="Ej: 70">

							<label for="desired-lean-mass-gain">Masa Muscular Objetivo Kg (	opcional):</label>
							<input type="number" id="desired-lean-mass-gain" name="desired-lean-mass-gain" step="0.1" min="0" placeholder="Ej: 2 (Dejar en blanco o 0 si no buscas ganar músculo)">

							<label for="is-athlete">¿Te consideras deportista/atleta?</label>
							<select id="is-athlete" name="is-athlete">
								<option value="no">No</option>
								<option value="yes">Sí</option>
							</select>

							<button type="submit" id="calculate-goal-button">Calcular Objetivo y Recomendaciones</button>
						</form>

						<div id="weight-goal-result">
							<p class="info-message">Completa el Paso 1 para habilitar este cálculo.</p>
							
						</div>
					</div>
				</section>

			<section>
				
				<div class="plan-step" id="step-6"> <h2>3. Estimación de Tiempo (Manual y Opcional)</h2>
                    <p>Estima cuánto tiempo podría llevarte alcanzar un cambio de peso específico basándote en un déficit o superávit calórico semanal <strong>que tú definas</strong>. Este cálculo es independiente de la tabla automática del Paso 5 y se usa para la tabla manual del Paso 7.</p>
                    <form id="time-estimation-form">
                        <label for="weight-change-goal">Cambio de Peso Total Deseado (kg):</label>
                        <input type="number" id="weight-change-goal" name="weight-change-goal" step="0.1" required placeholder="Ej: -10 para perder, 5 para ganar">

                        <label for="weekly-calorie-diff">Diferencia Calórica Semanal Estimada (kcal):</label>
                        <input type="number" id="weekly-calorie-diff" name="weekly-calorie-diff" step="100" required placeholder="Ej: -3500 para perder 0.5kg/sem, 2000 para ganar">
                        

                       <button type="submit" id="estimate-time-button" >Estimar Tiempo</button>  
                    </form>
					<small><strong>Nota:</strong> Se estima que 7700 kcal equivalen a 1 kg de grasa corporal. Para perdida gradual y sostenible no se aconseja perdidas de mas de 0.5kg/sem (3500kcal/sem). Para ganacia no se aconseja ganacias de mas de 0.3kg/sem (2000Kcal/sem) </small>
                    <div id="time-estimation-result">
                         <p class="info-message">Completa los pasos 1 y 2 para habilitar esta estimación.</p>
                    </div>
                    <div id="time-estimation-chart-container">
						<canvas id="timeEstimationChart"></canvas>
					</div>
                </div>
			</section>
				
				
			<section>
                <div class="plan-step" id="step-3">
                    <h2>4. Calcula tus Macronutrientes</h2>

					<p>
						Una vez definido tu <strong>objetivo calórico diario</strong> (basado en tu Gasto Energético Total - GET y tu meta de pérdida, mantenimiento o ganancia de peso), 
						es momento de distribuir esas calorías entre los tres macronutrientes esenciales: 
						<strong>proteínas, carbohidratos y grasas</strong>.
					</p>

					<p>
						<strong style="color: #468A45;">Para pérdida de peso:</strong> 
						Se recomienda un déficit moderado del <strong>10–20%</strong> respecto a tu GET, 
						lo que permite una pérdida gradual, sostenible y con buena preservación de masa muscular. 
						<em>Nuestro cálculo automático se basa en un déficit del 10%, ideal para comenzar sin impactos metabólicos extremos.</em>
					</p>

					<p>
						<strong style="color: #468A45;">Para ganancia de peso:</strong> 
						Un superávit del <strong>5–15%</strong> sobre tu GET favorece la hipertrofia muscular con un control adecuado del aumento de grasa. 
						<em>El cálculo automático utiliza un superávit del 5%, óptimo para una ganancia muscular progresiva y de calidad.</em>
					</p>

					<p>
						<strong style="color: #468A45;">Tu ingesta diaria puede ajustarse dinámicamente</strong> según:
						<ul>
							<li>Tu nivel de Actividad Física (AF) y tipo de entrenamiento</li>
							<li>El <strong>ciclo nutricional</strong> en el que te encuentres (carga, mantenimiento, descarga)</li>
							<li>La <strong>estrategia específica</strong> adaptada a tu objetivo:</li>
						</ul>
					</p>

					<!-- Tabla de estrategias por objetivo -->
					<!-- Tabla de rangos y estrategias por objetivo -->
					<div style="margin: 16px 0; font-size: 0.95em; line-height: 1.6;">
						<strong style="color: #468A45;">Según tu objetivo, se recomiendan los siguientes rangos y estrategias nutricionales:</strong>

						<table style="
							width: 100%; 
							border-collapse: collapse; 
							margin: 10px 0; 
							font-size: 0.9em;
							background: #f9f9f9;
							border-radius: 10px;
							overflow: hidden;
							box-shadow: 
								0 4px 12px rgba(245, 124, 0, 0.15),   /* Sombra naranja suave */
								0 1px 3px rgba(0, 0, 0, 0.1);
							border: 1px solid #FFCC80; /* Borde naranja claro */
						">
							<thead>
								<tr style="background: #108215; color: white; box-shadow: 0 1px 0 rgba(0,0,0,0.1);">
									<th style="padding: 12px 14px; text-align: left; font-weight: 600;">Objetivo</th>
									<th style="padding: 12px 14px; text-align: left; font-weight: 600;">Rangos Recomendados</th>
									<th style="padding: 12px 14px; text-align: left; font-weight: 600;">Estrategia Nutricional</th>
								</tr>
							</thead>
							<tbody>
								<!-- PÉRDIDA DE PESO -->
								<tr>
									<td rowspan="2" style="padding: 14px; background: #F1F8E9; font-weight: 700; color: #2E7D32;">
										Pérdida de peso
									</td>
									<td style="padding: 12px 14px; background: #F1F8E9; border-bottom: 1px dashed #108215;">
										<strong>Cetogénica inicial:</strong><br>
										<strong>GR: 65–75%</strong><br>
										<strong>PT: 20–25%</strong> (1.8–2.6 g/kg)<br>
										<strong>HC: 5–10%</strong> (<50 g/día)
									</td>
									<td style="padding: 12px 14px; background: #F1F8E9; border-bottom: 1px dashed #108215;">
										<strong>🎯 Enfoque:</strong> Cetosis inicial + hiperproteica<br>
										<strong>• Clave:</strong> Preservar masa muscular con proteína alta<br>
										<strong>• Estrategias:</strong> TKD, ciclos proteicos, ayuno intermitente
									</td>
								</tr>
								<tr style="background: #F1F8E9;">
									<td style="padding: 12px 14px; border-bottom: 1px dashed #108215;">
										<strong>Transición:</strong><br>
										<strong>GR: 40–50%</strong><br>
										<strong>PT: 25–30%</strong><br>
										<strong>HC: 20–25%</strong> (100–150 g/día)
									</td>
									<td style="padding: 12px 14px; border-bottom: 1px dashed #108215;">
										<strong>🎯 Enfoque:</strong> Recarga metabólica controlada<br>
										<strong>• Clave:</strong> Restablecer sensibilidad a la insulina y glucógeno<br>
										<strong>• Estrategias:</strong> Ciclado de carbohidratos, carga semanal, flexibilidad sostenible
									</td>
								</tr>

								<!-- GANANCIA DE PESO -->
								<tr style="background: #F9F9F9;">
									<td style="padding: 14px; font-weight: 500; color: #2E7D32;">
										<strong>Ganancia de peso</strong>
									</td>
									<td style="padding: 12px 14px;">
										<strong>Volumen muscular:</strong><br>
										<strong>GR: 25–35%</strong><br>
										<strong>PT: 25–30%</strong> (1.6–2.2 g/kg)<br>
										<strong>HC: 40–50%</strong> (300–500 g/día)
									</td>
									<td style="padding: 12px 14px;">
										<strong>💪 Enfoque:</strong> Superávit controlado con HC adecuados<br>
										<strong>• Clave:</strong> Optimizar síntesis proteica post-entreno<br>
										<strong>• Estrategias:</strong> CKD, timing nutricional, carb-loading
									</td>
								</tr>

								<!-- MANTENIMIENTO -->
								<tr style="background: #F1F8E9;">
									<td style="padding: 14px; font-weight: 500; color: #2E7D32;">
										<strong>Mantenimiento</strong>
									</td>
									<td style="padding: 12px 14px;">
										<strong>Equilibrio flexible:</strong><br>
										<strong>GR: 30–35%</strong><br>
										<strong>PT: 20–25%</strong> (1.6–2.0 g/kg)<br>
										<strong>HC: 35–45%</strong> (200–300 g/día)
									</td>
									<td style="padding: 12px 14px;">
										<strong>⚖️ Enfoque:</strong> Equilibrio flexible y sostenible<br>
										<strong>• Clave:</strong> Adherencia a largo plazo<br>
										<strong>• Estrategias:</strong> Flexibilidad selectiva, escucha corporal, comidas sociales planificadas
									</td>
								</tr>

								<!-- MIXTO/COMBINADO -->
								<tr>
									<td style="padding: 14px; font-weight: 500; color: #2E7D32;">
										<strong>Plan mixto/combinado</strong>
									</td>
									<td style="padding: 12px 14px; background: #F9F9F9;">
										<strong>Periodización nutricional:</strong><br>
										• <strong>Volumen:</strong> HC 40–50%, PT 25–30%<br>
										• <strong>Definición:</strong> HC 10–25%, PT 25–35%<br>
										• <strong>Mantenimiento:</strong> HC 30–40%, PT 20–25%
									</td>
									<td style="padding: 12px 14px;">
										<strong>🔄 Enfoque:</strong> Periodización nutricional<br>
										<strong>• Clave:</strong> Adaptación continua según objetivos<br>
										<strong>• Estrategias:</strong> CKD avanzado, ciclado metabólico, fases de carga-descarga
									</td>
								</tr>
							</tbody>
						</table>

    

													
													
													
						<p>
							Estas fases no son estáticas: evolucionan con tu progreso. Por ejemplo, puedes comenzar con una <strong>Inducción Cetogénica</strong> 
							para romper el estancamiento, luego pasar a <strong>Ciclado Metabólico</strong> para mantener el metabolismo activo, 
							y finalizar en <strong>Transición a Mantenimiento</strong> para evitar el efecto rebote.
						</p>

					
					</div>

					<div style="
								background-color: #FFF3E0; /* Naranja pastel suave */
								border: 1px solid #FFCC80;
								border-radius: 8px;
								padding: 14px 16px;
								margin: 16px 0;
								font-size: 0.95em;
								line-height: 1.6;
								box-shadow: 0 1px 3px rgba(0,0,0,0.1);
							">
								<em>
									<strong style="color: #468A45;">💡 Recuerda:</strong> 
									las calorías definen la dirección (subir, bajar, mantener), 
									pero los macronutrientes determinan la <strong>calidad</strong> del cambio: 
									cuánto músculo ganas, cuánta grasa pierdes y cómo te sientes durante el proceso.
								</em>
								<br>
								<em style="display: block; margin-top: 6px;">
									Tu plan se adapta a ti, no al revés. La nutrición inteligente combina ciencia, flexibilidad y sostenibilidad.
								</em>
							</div>
                     <form id="macro-form">
                        <label for="goal-calories">Calorías Objetivo Diarias (kcal):</label>
                        <input type="number" id="goal-calories" name="goal-calories" required min="500" placeholder="Introduce las kcal calculadas o deseadas">

                        <div id="macro-percentage-inputs">
                            <label>Distribución de Macronutrientes (% del total calórico):</label>
                            <div>
                                <label for="protein-percentage">Proteína (%):</label>
                                <input type="number" id="protein-percentage" name="protein-percentage" value="30" min="10" max="50" step="1"> 
                            </div>
                            <div>
                                <label for="carb-percentage">Carbohidratos (%):</label>
                                <input type="number" id="carb-percentage" name="carb-percentage" value="40" min="1" max="80" step="1"> <
                            </div>
                            <div>
                                <label for="fat-percentage">Grasas (%):</label>
                                <input type="number" id="fat-percentage" name="fat-percentage" value="30" min="10" max="90" step="1"> 
                            </div>
                             <p id="macro-percentage-total"></p>
                        </div>

                        <button type="submit" id="calculate-macros-button" >Calcular Gramos de Macronutrientes</button>
                    </form>
                    <div id="macro-result">
                        <p class="info-message">Completa los Pasos 2 y 3 para habilitar este cálculo.</p>
                    </div>
                    <div id="chart-container">
                        <canvas id="macroChart"></canvas>
                    </div>
                </div>
			</section>
			<section>
                <div class="plan-step" id="step-4">
                     <h2>5. Genera tu Plan de Comidas Orientativo</h2>
                     <p>Distribuye tus macronutrientes calculados en diferentes comidas a lo largo del día.</p>
                     <form id="meal-form">
                         <div id="meal-percentage-inputs">
                             <label>Distribución de Calorías por Comida (% del total diario):</label>
                             <div><label for="breakfast-perc">Desayuno:</label><input type="number" id="breakfast-perc" value="25" min="0" max="100" step="1"></div>
                             <div><label for="snack1-perc">Media Mañana:</label><input type="number" id="snack1-perc" value="10" min="0" max="100" step="1"></div>
                             <div><label for="lunch-perc">Almuerzo:</label><input type="number" id="lunch-perc" value="30" min="0" max="100" step="1"></div>
                             <div><label for="snack2-perc">Merienda:</label><input type="number" id="snack2-perc" value="10" min="0" max="100" step="1"></div>
                             <div><label for="dinner-perc">Cena:</label><input type="number" id="dinner-perc" value="25" min="0" max="100" step="1"></div>
                             <p id="meal-percentage-total"></p>
                         </div>
                         <button type="submit" id="generate-meals-button" >Generar Distribución por Comida</button>
                     </form>
                     <div id="meal-result">
                         <p class="info-message">Completa el Paso 4 para habilitar este cálculo.</p>
                     </div>
                </div>
			</section>
                




			
		<section>
			<div class="plan-step" id="step-4">
					<h2>6.Ciclos Diéteticos</h2>
					<p>La sección "Ciclos Dietéticos" te permite personalizar tu plan nutricional definiendo fases específicas (como Inducción Cetogénica, Volumen Muscular, Mantenimiento) y seleccionando estrategias dietéticas avanzadas (como Carb Cycling, Refeed, Ayuno Intermitente). Su propósito es adaptar tu ingesta a diferentes objetivos en distintos períodos, optimizando resultados como la pérdida de grasa, la ganancia muscular o el mantenimiento del peso, mientras se mejora la adherencia y se pueden sortear mesetas. Esta personalización se refleja en las tablas de planificación temporal detalladas que se generan posteriormente.</p>
				 
				</div>
				
				 <!-- Selects de Fase (inicialmente ocultos) -->
					                <label for="fasePerdida1" class="form-label" id="labelFasePerdida1" style="display:none;">Fase del Ciclo (Pérdida de Peso):</label>
					                <select id="fasePerdida1" class="form-control" aria-label="Fase de pérdida de peso">
										<option value="sel1">Selecciona Fase</option> 
					                    <option value="induccion_cetogenica1">Inducción Cetogénica</option>
					                    <option value="ciclado_metabolico1">Ciclado Metabólico</option>
					                    <option value="transicion_mantenimiento1">Transición a Mantenimiento</option>
					                </select>
									 <label for="faseGanancia1" class="form-label" id="labelFaseGanancia1" style="display:none;">Fase del Ciclo (Ganancia de Peso):</label>
					                <select id="faseGanancia1" class="form-control" aria-label="Fase de ganancia de peso">
										<option value="sel2">Selecciona Fase</option> 
					                    <option value="volumen1">Volumen Muscular</option>
					                    <option value="masa1">Enfocado en Masa Muscular</option>
					                </select>
					
					                <label for="enfoqueMantenimiento1" class="form-label" id="labelEnfoqueMantenimiento1" style="display:none;">Enfoque (Mantenimiento):</label>
					                <select id="enfoqueMantenimiento1" class="form-control" aria-label="Enfoque de mantenimiento">
										<option value="sel3">Selecciona Fase</option> 
					                    <option value="equilibrio1">Equilibrio Flexible</option>
					                    <option value="social1">Adherencia Social</option>
					                </select>
					
					                <label for="faseMixto1" class="form-label" id="labelFaseMixto1" style="display:none;">Fase del Ciclo (Mixto/Combinado):</label>
					                <select id="faseMixto1" class="form-control" aria-label="Fase de plan mixto">
										<option value="sel4">Selecciona Fase</option> 
					                    <option value="volumen1">Volumen</option>
					                    <option value="definicion1">Definición</option>
					                    <option value="mantenimiento1">Mantenimiento</option>
					                </select>
					<div class="card-body">
						<div id="opcionesPerdida1" class="mt-3">
							<div class="row">
							   
								<div class="col-md-6">
									<label class="form-label">Estrategias Especiales:</label>
									<div class="strategy-checkboxes" id="opcionesPerdida1"> <!-- ID del contenedor -->
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_ninguna" value="ninguna" checked>
											<label class="form-check-label" for="estrategia_ninguna">Cetosis estricta (<50g HC/día)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_tkd" value="tkd">
											<label class="form-check-label" for="estrategia_tkd">TKD (25-50g HC pre/post entreno)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_ckd" value="ckd">
											<label class="form-check-label" for="estrategia_ckd">CKD (2 días carb-loading 150-500g HC)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_if_16_8" value="if_16_8">
											<label class="form-check-label" for="estrategia_if_16_8">IF 16:8 (Ventana de alimentación 8 horas)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_refeed" value="refeed">
											<label class="form-check-label" for="estrategia_refeed">Refeed (1-2 días/semana HC alto)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_hiperproteica" value="hiperproteica">
											<label class="form-check-label" for="estrategia_hiperproteica">Hiperproteica (1.8-2.5 g/kg peso proteína)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_carb_cycling" value="carb_cycling">
											<label class="form-check-label" for="estrategia_carb_cycling">Carb Cycling (Días altos/bajos HC)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_protein_cycling" value="protein_cycling">
											<label class="form-check-label" for="estrategia_protein_cycling">Protein Cycling (4 semanas altas + 1 baja proteína)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_timing" value="timing">
											<label class="form-check-label" for="estrategia_timing">Timing Nutricional (HC post-entreno)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_flexible_dieting" value="flexible_dieting">
											<label class="form-check-label" for="estrategia_flexible_dieting">Flexible Dieting (80/20 regla)</label>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div id="opcionesGanancia1" class="mt-3" style="display:none;">
							<div class="row">
							   
								<div class="col-md-6">
									<label class="form-label">Estrategias Especiales:</label>
									<div class="strategy-checkboxes" id="opcionesGanancia1"> <!-- ID del contenedor -->
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_ganancia_ninguna" value="ninguna" checked>
											<label class="form-check-label" for="estrategia_ganancia_ninguna">Ninguna (Balance HC/proteína)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_ganancia_carb_cycling" value="carb_cycling">
											<label class="form-check-label" for="estrategia_ganancia_carb_cycling">Carb Cycling (Días altos/moderados HC)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_ganancia_refeed" value="refeed">
											<label class="form-check-label" for="estrategia_ganancia_refeed">Refeed (Días altos HC semanales)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_ganancia_timing" value="timing">
											<label class="form-check-label" for="estrategia_ganancia_timing">Timing Nutricional (HC post-entreno)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_ganancia_flexible_dieting" value="flexible_dieting">
											<label class="form-check-label" for="estrategia_ganancia_flexible_dieting">Flexible Dieting (80/20 regla)</label>
										</div>
										<div class="form-check">
									  <input class="form-check-input" type="checkbox" id="estrategia_ganancia_ckd" value="ckd_ganancia">
									  <label class="form-check-label" for="estrategia_ganancia_ckd">CKD: 5+2 approach para optimizar glucógeno</label>
									</div>
									<div class="form-check">
									  <input class="form-check-input" type="checkbox" id="estrategia_ganancia_timing_nutricional" value="timing_nutricional_ganancia">
									  <label class="form-check-label" for="estrategia_ganancia_timing_nutricional">Timing nutricional: Proteína post-entreno</label>
									</div>
									<div class="form-check">
									  <input class="form-check-input" type="checkbox" id="estrategia_ganancia_carb_loading" value="carb_loading_ganancia">
									  <label class="form-check-label" for="estrategia_ganancia_carb_loading">Carb-loading: Días previos a entrenos intensos</label>
									</div>
									</div>
								</div>
							</div>
						</div>

						<div id="opcionesMantenimiento1" class="mt-3" style="display:none;">
							<div class="row">
								
								<div class="col-md-6">
									<label class="form-label">Estrategias Especiales:</label>
									<div class="strategy-checkboxes" id="opcionesMantenimiento1"> <!-- ID del contenedor -->
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_mantenimiento_ninguna" value="ninguna" checked>
											<label class="form-check-label" for="estrategia_mantenimiento_ninguna">Ninguna (Equilibrio nutricional)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_mantenimiento_flexible_dieting" value="flexible_dieting">
											<label class="form-check-label" for="estrategia_mantenimiento_flexible_dieting">Flexible Dieting (80/20 regla)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_mantenimiento_if_16_8" value="if_16_8">
											<label class="form-check-label" for="estrategia_mantenimiento_if_16_8">IF 16:8 (Ventana de alimentación 8 horas)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_mantenimiento_refeed" value="refeed">
											<label class="form-check-label" for="estrategia_mantenimiento_refeed">Refeed (Días altos HC)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_mantenimiento_carb_cycling" value="carb_cycling">
											<label class="form-check-label" for="estrategia_mantenimiento_carb_cycling">Carb Cycling (Días altos/bajos HC)</label>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div id="opcionesMixto1" class="mt-3" style="display:none;">
							<div class="row">
								
								<div class="col-md-6">
									<label class="form-label">Estrategias Especiales:</label>
									<div class="strategy-checkboxes" id="opcionesMixto1"> <!-- ID del contenedor -->
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_mixto_ninguna" value="ninguna" checked>
											<label class="form-check-label" for="estrategia_mixto_ninguna">Ninguna (Balance nutricional)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_mixto_carb_cycling" value="carb_cycling">
											<label class="form-check-label" for="estrategia_mixto_carb_cycling">Carb Cycling (Días altos/bajos HC)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_mixto_refeed" value="refeed">
											<label class="form-check-label" for="estrategia_mixto_refeed">Refeed (Días altos HC)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_mixto_flexible_dieting" value="flexible_dieting">
											<label class="form-check-label" for="estrategia_mixto_flexible_dieting">Flexible Dieting (80/20 regla)</label>
										</div>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" id="estrategia_mixto_timing" value="timing">
											<label class="form-check-label" for="estrategia_mixto_timing">Timing Nutricional (HC post-entreno)</label>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
			<section>
				<div class="card mb-4">
					<div class="card-header">
						<h5>Planificación Temporal</h5>
					</div>
					<div class="card-body">
						<div class="row">
							<div class="col-md-12">
								<label for="periodoPlanificacion" class="form-label">Período de Planificación:</label>
								<select id="periodoPlanificacion" class="form-control" aria-label="Período de planificación">
									<option value="semanal">Semanal (4 semanas)</option>
									<option value="mensual">Mensual (12 semanas)</option>
								</select>
							</div>
						</div>
					</div>
				</div>
			</section>
				<div class="text-center mb-4">
					<button onclick="abrirModalMacros();" class="btn btn-primary btn-lg" aria-label="Ajustar y calcular macronutrientes">
						🧮 Calcular Planificación
					</button>
					<div id="errorMessage" style="display: none; color: red; background-color: #ffebee; padding: 10px; border-radius: 4px; margin: 10px 0;"></div>
				</div>
				
			<!-- Resultados y Planificación Temporal (HTML existente) -->
			<div id="resultados" class="card" style="display:none;">
				<div class="card-header">
					<h5>📊 Resultados de tu Plan Nutricional</h5>
				</div>
				<div class="card-body">
					<div class="row">
						<div class="col-md-6">
							<h6>📈 Datos Calculados</h6>
							<p><strong>Gasto Energético:</strong> <span id="gastoEnergetico"></span> kcal/día</p>
							<p><strong>Calorías Diarias:</strong> <span id="calorias"></span> kcal</p>
							<p><strong>Proteínas:</strong> <span id="proteinas"></span>g (<span id="proteinasPct"></span>%)</p>
							<p><strong>Carbohidratos:</strong> <span id="carbohidratos"></span>g (<span id="carbohidratosPct"></span>%)</p>
							<p><strong>Grasas:</strong> <span id="grasas"></span>g (<span id="grasasPct"></span>%)</p>
						</div>
						<div class="col-md-6">
							<canvas id="chartMacros" width="300" height="300" aria-label="Gráfico de distribución de macronutrientes"></canvas>
						</div>
					</div>
					<div class="mt-3">
						<h6>📋 Recomendaciones Específicas</h6>
						<div id="recomendaciones" class="alert alert-info"></div>
					</div>
				</div>
			</div>

			<!-- Sección para la Tabla General del Proceso -->
			<div id="tablaGeneralProcesoContainer" class="card mb-4">
				<div class="card-header">
					<h5>📅 Planificación General del Proceso</h5>
					<p class="mb-0"><small>Basada en tu objetivo y el tiempo estimado del Paso 3.</small></p>
				</div>
				
				
			</div>

			<!-- Sección para la Tabla Específica (Planificación Temporal Original) -->
			<div id="planificacionTemporal" class="card" style="display:none;">
				<div class="card-header">
					<h5>📅 Planificación Temporal Específica</h5> <!-- Título modificado para diferenciar -->
					<p class="mb-0"><small>Basada en el período seleccionado (semanal/mensual).</small></p> <!-- Subtítulo añadido -->
				</div>
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-striped table-bordered" aria-label="Tabla de planificación nutricional">
							<thead class="table-dark"> <!-- Añadido estilo de encabezado oscuro -->
								<tr>
									<th scope="col">Semana</th>
									<th scope="col">Fase</th>
									<th scope="col">Estrategias</th>
									<th scope="col">Calorías (kcal)</th>
									<th scope="col">Proteinas (%)</th>
									<th scope="col">CarboHid (%)</th>
									<th scope="col">Grasas (%)</th>
									<th scope="col">PT (g)</th>
									<th scope="col">CH (g)</th>
									<th scope="col">GR (g)</th>
									<th scope="col">Entreno/Días</th>
									<th scope="col">Notas</th>
								</tr>
							</thead>
							<tbody id="tablaPlanificacionBody"></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- Contenedor para la Tabla Detallada de Fase Seleccionada -->
			<div id="tablaDetalladaFaseContainer" class="mt-4 card" style="display:none;"> <!-- Añadido estilo de tarjeta y oculto por defecto -->
				<div class="card-header">
					<h5>🔍 Detalles de la Fase Seleccionada</h5> <!-- Título del contenedor -->
					<p class="mb-0"><small>Desglose semanal detallado basado en la fase general.</small></p> <!-- Subtítulo -->
					<p class="info-message">Selecciona una fase en la "Planificación General del Proceso" para ver su desglose semanal detallado.</p>
				</div>
				<div class="card-body">
					<!-- El contenido de la tabla detallada se generará aquí -->
					
				</div>
			</div
		
			<section>	
			
                <div class="plan-step" > <h2>7. Tabla de Ciclos y Breaks (Automática)</h2>
                    <p>Esta tabla muestra una estructura detallada y orientativa de ciclos de carga-descarga proteica, incluyendo fases de déficit o superávit y descansos (breaks) a mantenimiento. Los valores se basan en los cálculos automáticos de los Pasos 1, 2 y 3.</p>
                    <div id="step-5-results"> <div id="detailed-cycle-table-container">
                             
                             </div>
                    </div>
                </div>
			</section>	
			                <section id="step-7" class="plan-step">
                    <h2>8. Tabla de Ciclos Hiperproteicos (Manual)</h2>
                    <p>Esta tabla organiza ciclos hiperproteicos (Consumo alto, entre 30-40%) y breaks (Consumo moderado, entre 15-25%), cuya duración se basa en la estimación temporal manual del Paso 6. La cantidad de proteína objetivo para cada fase se calcula aplicando porcentajes específicos sobre las Kcal/día asignadas (un porcentaje más alto para la fase hiperproteica (35%) y uno más bajo para la fase de break(20%)).".</p>
					<p>la velocidad de perdida indicada en kg/semana está basada en el ajuste constante de deficit calorico semanal, señalado en el paso 6. Para la fase hiperproteica se mantiene ese ritmo de perdida semanal y se reduduce a la mitad en la fase de Descanso. El progreso real puede variar.</p>
                    <div id="hyperprotein-cycle-table-container">
                        
                        <table id="hyperprotein-cycle-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Ciclo</th>
                                    <th>Fase</th>
                                    <th>Semanas</th>
                                    <th>Peso (kg) <br>(Inicio → Fin)</th>
									<th>Kcal/día/AF</th>
                                    <th>Proteínas (g/kg)</th>
                                    <th>Notas</th>
                                </tr>
                            </thead>
                            <tbody id="hyperprotein-cycle-table-body">
                                </tbody>
                        </table>
                        <div id="hyperprotein-note-container"></div> </div>
                     <button id="generate-hyperprotein-button" onclick="generateHyperproteinCycles()" style="margin-top: 15px;" >
                        Generar Tabla de Ciclos Hiperproteicos (Manual)
                    </button>
                </section>
				<div><button id="save-pdf-button" style="margin-top: 30px; background-color: #0275d8; width: auto; padding: 12px 25px; display: block; margin-left: auto; margin-right: auto;" >Guardar Plan como PDF</button></div>
		

						<!-- SECCION MODALS-->		
						<!-- Modal para ajuste manual de macros -->
						<div class="modal fade" id="modalMacros" tabindex="-1" aria-labelledby="modalMacrosLabel" aria-hidden="true">
							<div class="modal-dialog modal-lg">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title" id="modalMacrosLabel">Ajuste de Macronutrientes</h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
									</div>
									<div class="modal-body">
										<p><strong>Objetivo:</strong> <span id="modal-objetivo">No seleccionado</span></p>
										<p><strong>Fase:</strong> <span id="modal-fase">No seleccionada</span></p>

										<div id="modal-warning" class="alert alert-warning" style="display:none;">
											Por favor, selecciona primero un objetivo y una fase.
										</div>

										<div id="modal-content" style="display:none;">
											<p>Arrastra los controles para ajustar los porcentajes. Recomendamos valores cercanos al rango óptimo para tu fase.</p>

											<div class="mb-3">
												<label for="proteinasRange">Proteínas <span id="proteinasValue">25</span>%</label>
												<input type="range" class="form-range" id="proteinasRange" min="10" max="50" value="25">
												<small>Rango recomendado: <span id="proteinasRango">20-30%</span></small>
											</div>

											<div class="mb-3">
												<label for="carbohidratosRange">Carbohidratos <span id="carbohidratosValue">40</span>%</label>
												<input type="range" class="form-range" id="carbohidratosRange" min="10" max="70" value="40">
												<small>Rango recomendado: <span id="carbohidratosRango">30-50%</span></small>
											</div>

											<div class="mb-3">
												<label for="grasasRange">Grasas <span id="grasasValue">35</span>%</label>
												<input type="range" class="form-range" id="grasasRange" min="15" max="60" value="35">
												<small>Rango recomendado: <span id="grasasRango">25-40%</span></small>
											</div>

											<div class="alert alert-info">
												<strong>Consejo:</strong> <span id="modal-consejo">Selecciona una fase para ver recomendaciones.</span>
											</div>
										</div>
									</div>
									<div class="modal-footer">
										<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
										<button type="button" class="btn btn-primary" id="guardarMacros">Guardar y Calcular</button>
									</div>
								</div>
							</div>
						</div>
						<!-- Modal para Incompatibilidad de Estrategias -->
<div id="modalIncompatibilidad" class="modal" tabindex="-1" role="dialog" style="display: none;">
  <div class="modal-dialog modal-lg" role="document"> <!-- modal-lg para más espacio -->
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">⚠️ Estrategias Incompatibles Seleccionadas</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar" onclick="cerrarModal('modalIncompatibilidad')"></button>
      </div>
      <div class="modal-body">
        <p id="mensajeIncompatibilidad">
          <!-- El mensaje se llenará dinámicamente -->
        </p>
        <hr>
        <h6>Guía de Compatibilidad Sugerida:</h6>
        <div id="guiaCompatibilidad">
            <!-- La guía se llenará dinámicamente -->
        </div>
        <hr>
        <p><strong>¿Quieres definir manualmente los macronutrientes para tus estrategias?</strong></p>
        <p>Puedes hacerlo pulsando el botón de abajo. Esto te permitirá personalizar los valores incluso si las estrategias iniciales son incompatibles según nuestra lógica automática.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalIncompatibilidad')">Aceptar y Corregir</button>
        <button type="button" class="btn btn-primary" onclick="abrirModalConfiguracionManual()">Configurar Macros Manualmente</button>
        <!-- Botón oculto por ahora, se puede activar si se implementa "Forzar Combinación"
        <button type="button" class="btn btn-warning" style="display:none;">Forzar Combinación (Avanzado)</button>
        -->
      </div>
    </div>
  </div>
</div>

<!-- Modal para Configuración Manual de Macronutrientes -->
<div id="modalConfiguracionManual" class="modal" tabindex="-1" role="dialog" style="display: none;">
  <div class="modal-dialog modal-xl" role="document"> <!-- modal-xl para mucho contenido -->
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">⚙️ Configuración Manual de Macronutrientes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar" onclick="cerrarModal('modalConfiguracionManual')"></button>
      </div>
      <div class="modal-body">
        <p>Define los porcentajes de macronutrientes para tus estrategias seleccionadas. <strong>La suma debe ser 100% para cada estrategia.</strong></p>
        <form id="formConfiguracionManual">
            <div id="contenedorEntradasManuales">
                <!-- Los bloques de entrada se generarán aquí dinámicamente -->
                <!-- Ejemplo de bloque (se generará por JS):
                <div class="bloque-estrategia-manual mb-3 p-3 border rounded" data-estrategia="nombre_estrategia">
                    <h6>Estrategia: <span class="nombre-estrategia">nombre_estrategia</span></h6>
                    <div class="row">
                        <div class="col-md-4">
                            <label for="manual_proteina_nombre_estrategia" class="form-label">Proteína (%)</label>
                            <input type="number" class="form-control input-macro-manual" id="manual_proteina_nombre_estrategia" name="manual_proteina_nombre_estrategia" min="0" max="100" value="25" required>
                        </div>
                        <div class="col-md-4">
                            <label for="manual_carbohidratos_nombre_estrategia" class="form-label">Carbohidratos (%)</label>
                            <input type="number" class="form-control input-macro-manual" id="manual_carbohidratos_nombre_estrategia" name="manual_carbohidratos_nombre_estrategia" min="0" max="100" value="40" required>
                        </div>
                        <div class="col-md-4">
                            <label for="manual_grasas_nombre_estrategia" class="form-label">Grasas (%)</label>
                            <input type="number" class="form-control input-macro-manual" id="manual_grasas_nombre_estrategia" name="manual_grasas_nombre_estrategia" min="0" max="100" value="35" required>
                        </div>
                    </div>
                    <div class="total-macro-manual mt-2">
                        <strong>Total: <span class="valor-total">100</span>%</strong>
                        <span class="estado-total text-success" style="display:none;">✓ Correcto</span>
                        <span class="estado-total text-danger" style="display:none;">✗ Debe ser 100%</span>
                    </div>
                </div>
                -->
            </div>
        </form>
        <div id="errorConfiguracionManual" class="alert alert-danger mt-3" style="display: none;">
            <!-- Mensajes de error específicos se mostrarán aquí -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalConfiguracionManual')">Cancelar</button>
        <button type="button" class="btn btn-success" onclick="aplicarConfiguracionManual()">Aplicar y Calcular</button>
      </div>
    </div>
  </div>
</div>
    </main>
<!-- Coloca este div en tu archivo HTML -->

    <footer>
        <p>&copy; 2024 NutriPlan - Herramienta de planificación dietética orientativa. Consulta siempre a un profesional.</p>
    </footer>
	
	
    

    <script>
        // --- Global variables ---
        // Basic user data
        let userAge = null;
        let userGender = 'male';
        let userHeightCm = null;
        let userActivityLevel = 'sedentary';
        let currentWeightKg = null;

        // Calculated values from Step 1 & 2
        let calculatedBMR = null;
        let calculatedTDEE = null; // Total Daily Energy Expenditure (GET) from Step 1 
        let targetWeightKgGlobal = null;
        let goalTypeGlobal = 'maintenance'; // 'loss', 'gain', 'maintenance'
        let estimatedWeeksGlobal = 0; // Automatically estimated weeks from Step 2 (for Step 5 table)
        let targetWeeklyRateKgGlobal = 0; // Automatically estimated weekly rate from Step 2 (for Step 5 table)

        // Calculated values from Step 3
        let calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0 };

        // Calculated values from Step 6 (Manual Estimation)
        let estimatedWeeksManualGlobal = null; // Weeks from manual estimation
        let weightChangeGoalManualGlobal = null; // Weight change goal from manual estimation
        let weeklyCalorieDiffManualGlobal = null; // Weekly calorie diff from manual estimation

        // Chart instances
        let macroChartInstance = null;
        let weightEvolutionChartInstance = null; // For Step 2 chart
        let timeEstimationChartInstance = null; // For Step 6 chart

        // Activity multipliers (defined globally for reuse)
        //const activityMultipliers = { sedentary: 1.2, light: 1.56, moderate: 1.78, active: 2.1, very_active: 2.3 };
		//const activityMultipliers = userGender === 'male' ? [1.2, 1.56, 1.78, 2.1, 2.3] : [1.2, 1.55, 1.64, 1.82, 2];
		// Define multiplicadores por género usando valores numéricos
			const maleActivityMultipliers = {
			    '1.2': 1.2,    // sedentary
			    '1.375': 1.56, // light
			    '1.55': 1.78,  // moderate
			    '1.725': 2.1,  // active
			    '1.9': 2.3     // very_active
			};
			
			const femaleActivityMultipliers = {
			    '1.2': 1.2,    // sedentary
			    '1.375': 1.55, // light
			    '1.55': 1.64,  // moderate
			    '1.725': 1.82, // active
			    '1.9': 2.0     // very_active
			};
			
			// Selecciona el objeto según el género
			const activityMultipliers = userGender === 'male' ? maleActivityMultipliers : femaleActivityMultipliers;
        // --- Wait for the DOM to be fully loaded ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM Element References ---
            // Forms
            const calorieForm = document.getElementById('calorie-form');
            const weightGoalForm = document.getElementById('weight-goal-form');
            const macroForm = document.getElementById('macro-form');
            const mealForm = document.getElementById('meal-form');
            const timeEstimationForm = document.getElementById('time-estimation-form');
            // Buttons
            const calculateGoalButton = document.getElementById('calculate-goal-button');
            const calculateMacrosButton = document.getElementById('calculate-macros-button');
            const generateMealsButton = document.getElementById('generate-meals-button');
            const estimateTimeButton = document.getElementById('estimate-time-button');
            const generateHyperproteinButton = document.getElementById('generate-hyperprotein-button'); // Reference to the button
            const savePdfButton = document.getElementById('save-pdf-button');
            // Percentage Inputs (for live update listeners)
            const macroPercentageInputs = document.querySelectorAll('#macro-percentage-inputs input[type="number"]');
            const mealPercentageInputs = document.querySelectorAll('#meal-percentage-inputs input[type="number"]');
            // Result Divs
            const calorieResultDiv = document.getElementById('calorie-result');
            const energyBalanceResultDiv = document.getElementById('energy-balance-result');
            const weightGoalResultDiv = document.getElementById('weight-goal-result');
            const weightChartContainer = document.getElementById('weight-chart-container');
            const macroResultDiv = document.getElementById('macro-result');
            const chartContainer = document.getElementById('chart-container'); // For macro chart
            const mealResultDiv = document.getElementById('meal-result');
            const timeEstimationResultDiv = document.getElementById('time-estimation-result');
            const timeChartContainer = document.getElementById('time-estimation-chart-container'); // For manual estimation chart
            const step5TableContainer = document.getElementById('detailed-cycle-table-container'); // Auto table container (Step 5)
            // Step 7 Elements
            const hyperproteinTableContainer = document.getElementById('hyperprotein-cycle-table-container');
            const hyperproteinTable = document.getElementById('hyperprotein-cycle-table');
            const hyperproteinTableBody = document.getElementById('hyperprotein-cycle-table-body');
            const hyperproteinInfoMessage = document.getElementById('hyperprotein-info-message');
            const hyperproteinNoteContainer = document.getElementById('hyperprotein-note-container');
            // Percentage Total Displays
            const macroPercentageTotalDiv = document.getElementById('macro-percentage-total');
            const mealPercentageTotalDiv = document.getElementById('meal-percentage-total');
            // Input Fields to Update
            const goalCaloriesInput = document.getElementById('goal-calories');
            const proteinPercentageInput = document.getElementById('protein-percentage');
            const carbPercentageInput = document.getElementById('carb-percentage');
            const fatPercentageInput = document.getElementById('fat-percentage');
			const targetMusclePercInput = document.getElementById('target-muscle-percentage');
			const targetMusclePerc = parseFloat(targetMusclePercInput.value);

            // --- Utility Functions ---
            /**
             * Displays an error message in a specified container.
             * @param {HTMLElement} container - The DOM element to display the message in.
             * @param {string} message - The error message text.
             */
            function displayError(container, message) {
                if (container) {
                    container.innerHTML = `<p class="error-message">${message}</p>`;
                } else {
                    console.error("Error container not found for message:", message);
                }
            }

            /**
             * Displays an informational message in a specified container.
             * @param {HTMLElement} container - The DOM element to display the message in.
             * @param {string} message - The info message text.
             */
            function displayInfo(container, message) {
                if (container) {
                    container.innerHTML = `<p class="info-message">${message}</p>`;
                } else {
                     console.error("Info container not found for message:", message);
                }
            }

            /**
             * Clears the content of a specified container.
             * @param {HTMLElement} container - The DOM element to clear.
             */
            function clearContainer(container) {
                if (container) {
                    container.innerHTML = '';
                }
            }

            /**
             * Updates the enabled/disabled state of buttons based on completed steps.
             */
            function updateButtonStates() {
                const step1Done = calculatedTDEE !== null && currentWeightKg !== null;
                const step2Done = step1Done && targetWeightKgGlobal !== null;
                const step3Done = step2Done && calculatedMacros.goalCalories > 0;
                const step6Done = step1Done && estimatedWeeksManualGlobal !== null && estimatedWeeksManualGlobal > 0; // Step 6 (Manual Estimation) is done

                // Enable/disable step buttons
                if (calculateGoalButton) calculateGoalButton.disabled = !step1Done;
                if (calculateMacrosButton) calculateMacrosButton.disabled = !step2Done;
                if (generateMealsButton) generateMealsButton.disabled = !step3Done;
                if (estimateTimeButton) estimateTimeButton.disabled = !step1Done; // Step 6 only needs Step 1
                if (generateHyperproteinButton) generateHyperproteinButton.disabled = !step6Done; // Step 7 needs Step 6

                // Enable/disable PDF button if at least Step 1 is done
                if (savePdfButton) savePdfButton.disabled = !step1Done;
            }

            // --- Step 1: Calculate TDEE and Energy Balance ---
            // --- Step 1: Calculate TDEE and Energy Balance ---


	function calculateCalories() {
			
			
			// Clear previous results
			clearContainer(calorieResultDiv);
			clearContainer(energyBalanceResultDiv);
			clearContainer(recommendationResultDiv); // Asumimos que existe un div para recomendaciones

			// Get values from form
			userAge = parseInt(calorieForm.elements['age'].value);
			userGender = calorieForm.elements['gender'].value;
			currentWeightKg = parseFloat(calorieForm.elements['weight'].value);
			const heightM = parseFloat(calorieForm.elements['height'].value);
			userActivityLevel = calorieForm.elements['activity'].value;
			const estimatedIntake = parseInt(calorieForm.elements['estimated-intake'].value) || null;

			// Basic validation
			if (isNaN(userAge) || isNaN(currentWeightKg) || isNaN(heightM) || userAge <= 0 || currentWeightKg <= 0 || heightM <= 0) {
				displayError(calorieResultDiv, 'Por favor, introduce valores válidos para edad, peso y altura.');
				calculatedTDEE = null;
				calculatedBMR = null;
				resetStep2onwards();
				updateButtonStates();
				return;
			}

			// Validación de nivel de actividad
			const activityMultiplier = activityMultipliers[userActivityLevel];
			if (activityMultiplier === undefined) {
				displayError(calorieResultDiv, 'Nivel de actividad no válido.');
				calculatedTDEE = null;
				calculatedBMR = null;
				resetStep2onwards();
				updateButtonStates();
				return;
			}
	
			userHeightCm = heightM * 100; // Store height in cm

			// Calculate BMR (Harris-Benedict Revised)
			if (userGender === 'male') {
				calculatedBMR = (10 * currentWeightKg) + (6.25 * userHeightCm) - (5 * userAge) + 5;
			} else {
				calculatedBMR = (10 * currentWeightKg) + (6.25 * userHeightCm) - (5 * userAge) - 161;
			}

			// Calculate TDEE (Added 10% buffer as per original code)
			calculatedTDEE = calculatedBMR * activityMultiplier; // Including 10% buffer

			// Display TDEE results
			calorieResultDiv.innerHTML = `
				<h3>Resultados del Gasto Energético:</h3>
				<p>Tu Tasa Metabólica Basal (TMB) estimada es: <strong>${calculatedBMR.toFixed(0)} kcal/día</strong>.</p>
				<p>Tu Gasto Energético Total (GET/TDEE) estimado es: <strong>${calculatedTDEE.toFixed(0)} kcal/día</strong>.</p>
				<p>Este es el número aproximado de calorías que tu cuerpo quema diariamente, incluyendo un margen.</p>`;

			// Display Energy Balance (con ingesta estimada si no se proporciona)
			let actualIntake = estimatedIntake;
			let intakeSource = 'ingesta estimada';

			// Si no se proporciona ingesta, generar una estimación basada en características personales
			if (!estimatedIntake || estimatedIntake <= 0) {
				let intakeMultiplier;
				if (userActivityLevel === '1.2' || userActivityLevel === 'sedentary') {
					intakeMultiplier = 0.90;
				} else if (userActivityLevel === '1.375' || userActivityLevel === 'light') {
					intakeMultiplier = 0.95;
				} else if (userActivityLevel === '1.55' || userActivityLevel === 'moderate') {
					intakeMultiplier = 1.00;
				} else if (userActivityLevel === '1.725' || userActivityLevel === 'active') {
					intakeMultiplier = 1.05;
				} else if (userActivityLevel === '1.9' || userActivityLevel === 'very_active') {
					intakeMultiplier = 1.10;
				} else {
					intakeMultiplier = 1.00;
				}
				actualIntake = calculatedTDEE * intakeMultiplier;
				intakeSource = 'ingesta estimada (basada en tus características)';
			} else {
				intakeSource = 'tu ingesta proporcionada';
			}

			// Calcular balance energético
			const balance = actualIntake - calculatedTDEE;
			let balanceInterpretation = '';

			// Variables para el select de objetivo
			const objetivoSelect = document.getElementById('objetivo');

			if (balance > 100) {
				balanceInterpretation = `Estás en un <strong>superávit calórico</strong> de aproximadamente <strong>${balance.toFixed(0)} kcal/día</strong>. Esto generalmente conduce a una ganancia de peso.`;
			} else if (balance < -100) {
				balanceInterpretation = `Estás en un <strong>déficit calórico</strong> de aproximadamente <strong>${Math.abs(balance).toFixed(0)} kcal/día</strong>. Esto generalmente conduce a una pérdida de peso.`;
			} else {
				balanceInterpretation = `Estás cerca de tu <strong>mantenimiento calórico</strong> (balance de <strong>${balance.toFixed(0)} kcal/día</strong>). Tu peso debería mantenerse relativamente estable.`;
			}

			energyBalanceResultDiv.innerHTML = `
				<h3>Balance Energético Estimado:</h3>
				<p>Basado en tu ${intakeSource} <strong>(${actualIntake.toFixed(0)} kcal)</strong> comparada con tu GET strong>(${calculatedTDEE.toFixed(0)} kcal)</strong></p>
				<p>${balanceInterpretation}</p>`;

				// === Estimación REALISTA del % de grasa corporal (basado en IMC, edad, sexo) ===
				const bmi = currentWeightKg / (heightM * heightM);
				const estimatedBodyFat = estimateBodyFat(bmi, userAge, userGender);
				const leanMassKg = currentWeightKg * (1 - estimatedBodyFat / 100);
			// Llamar a la función y asignar el resultado (una sola vez)
			
			// Declarar la función ANTES de usarla (mejor práctica)
			function estimateBodyFat(bmi, userAge, userGender) {
				let estimatedBodyFat;
				if (userGender === 'male') {
					estimatedBodyFat = (1.20 * bmi) + (0.23 * userAge) - 16.2;
				} else {
					estimatedBodyFat = (1.20 * bmi) + (0.23 * userAge) - 5.4;
				}
				// Ajustar a rangos realistas
				return userGender === 'male'
					? Math.max(6, Math.min(40, estimatedBodyFat)) // Hombre: 8–40%
					: Math.max(16, Math.min(50, estimatedBodyFat)); // Mujer: 18–50%
			}

			// === Detectar si es "activo" (deportista o AF intensa) ===
			const isActive = ['active', 'very_active'].includes(userActivityLevel);



		// === Clasificación de %grasa ===
		let bodyFatCategory = '';
		let recommendationTitle = '';
		let finalObjective = 'perdida1';

		if (userGender === 'male') {
			if (estimatedBodyFat < 10) {
				bodyFatCategory = isActive ? 'Excelente (nivel atleta)' : 'Muy bajo';
			} else if (estimatedBodyFat <= 20) {
				bodyFatCategory = 'Saludable';
			} else if (estimatedBodyFat <= 25) {
				bodyFatCategory = 'Sobrepeso leve';
			} else {
				bodyFatCategory = 'Obesidad';
			}
		} else {
			if (estimatedBodyFat < 18) {
				bodyFatCategory = isActive ? 'Excelente (nivel atleta)' : 'Muy bajo';
			} else if (estimatedBodyFat <= 28) {
				bodyFatCategory = 'Saludable';
			} else if (estimatedBodyFat <= 33) {
				bodyFatCategory = 'Sobrepeso leve';
			} else {
				bodyFatCategory = 'Obesidad';
			}
		}

		// === Recomendaciones por objetivo (ajustadas por nivel de AF) ===

		// Caso 1: Pérdida de grasa (exceso de peso)
		if (estimatedBodyFat > (userGender === 'male' ? 20 : 28) || bmi >= 25) {
			recommendationTitle = '🎯 Objetivo Recomendado: Pérdida de Grasa (Definición)';

			// Rangos y estrategia según nivel de AF
			const fatTarget = isActive 
				? (userGender === 'male' ? '6–13%' : '14–20%') 
				: (userGender === 'male' ? '15–25%' : '20–30%');
			const proteinRange = isActive 
				? '1.8–2.4' 
				: '1.6–2.2';
			const trainingFreq = isActive 
				? '3–5 veces/semana' 
				: '2–3 veces/semana';
			const deficit = isActive 
				? '300–500' 
				: '300–500'; // igual, pero se puede ajustar
			const cardio = isActive 
				? 'cardio de alta intensidad ocasional (HIIT) o moderado 2–3 veces/semana' 
				: 'caminar rápido, bicicleta 2–3 veces/semana';

			recommendation = `
				<p><strong>Análisis de composición corporal:</strong></p>
				<p>• Tu IMC es <strong>${bmi.toFixed(1)}</strong> (${bmi < 18.5 ? 'bajo peso' : bmi < 25 ? 'normal' : bmi < 30 ? 'sobrepeso' : 'obesidad'})</p>
				<p>• Tu porcentaje de grasa corporal estimado es <strong>${estimatedBodyFat.toFixed(1)}%</strong> (${bodyFatCategory})</p>
				<p>• Tu masa magra es aproximadamente <strong>${leanMassKg.toFixed(1)} kg</strong></p>

				<p><strong>Objetivo: Reducir %grasa hasta ${fatTarget} mientras preservas masa muscular.</strong></p>
				<p><strong>Estrategia personalizada ${isActive ? '(Deportista/AF intensa)' : '(AF leve o moderada)'}:</strong></p>
				<ul>
					<li>Mantén un <strong>déficit calórico de ${deficit} kcal/día</strong>.</li>
					<li>Ingiere <strong>${proteinRange} g de proteína por kg</strong> (~${Math.round(1.8 * currentWeightKg)}–${Math.round(2.4 * currentWeightKg)} g/día).</li>
					<li>Entrena con <strong>fuerza ${trainingFreq}</strong> (enfócate en progresión).</li>
					<li>Incluye <strong>${cardio}</strong>.</li>
				</ul>
				<p><strong>💡 Tip:</strong> Pierde entre 0.3–0.6 kg por semana. Si eres activo, prioriza recuperación y sueño para mantener rendimiento.</p>`;
			finalObjective = 'perdida1';
		}

		// Caso 2: Ganancia de masa muscular (solo si %grasa es bajo)
		else if (estimatedBodyFat <= (userGender === 'male' ? 15 : 23) && bmi < 22) {
			recommendationTitle = '🎯 Objetivo Recomendado: Ganancia de Masa Muscular';

			const leanTarget = isActive 
				? (userGender === 'male' ? '85–92%' : '78–85%') 
				: (userGender === 'male' ? '80–90%' : '72–82%');
			const proteinRange = isActive 
				? '1.8–2.4' 
				: '1.6–2.2';
			const surplus = isActive 
				? '+300–500 kcal/día' 
				: '+250–300 kcal/día';
			const trainingFreq = isActive 
				? '4–5 veces/semana (dividido por grupos musculares)' 
				: '3–4 veces/semana (full body o split)';
			const tip = isActive 
				? 'Gana 0.5–1% de tu peso corporal por mes para máximo rendimiento.' 
				: 'Gana 0.25–0.5 kg por semana para evitar exceso de grasa.';

			recommendation = `
				<p><strong>Análisis de composición corporal:</strong></p>
				<p>• Tu IMC es <strong>${bmi.toFixed(1)}</strong> (${bmi < 18.5 ? 'bajo peso' : 'normal'})</p>
				<p>• Tu porcentaje de grasa corporal estimado es <strong>${estimatedBodyFat.toFixed(1)}%</strong> (${bodyFatCategory})</p>
				<p>• Tu masa magra es aproximadamente <strong>${leanMassKg.toFixed(1)} kg</strong></p>

				<p><strong>Objetivo: Aumentar masa magra hasta alcanzar ${leanTarget}% de tu peso.</strong></p>
				<p><strong>Estrategia personalizada ${isActive ? '(Deportista/AF intensa)' : '(AF leve o moderada)'}:</strong></p>
				<ul>
					<li>Crea un <strong>superávit de ${surplus}</strong>.</li>
					<li>Consume <strong>${proteinRange} g de proteína por kg</strong> (~${Math.round(1.8 * currentWeightKg)}–${Math.round(2.4 * currentWeightKg)} g/día).</li>
					<li>Entrena con <strong>resistencia ${trainingFreq}</strong>.</li>
					<li>Descansa <strong>7–9 horas/noche</strong> y gestiona el estrés.</li>
				</ul>
				<p><strong>💡 Tip:</strong> ${tip}</p>`;
			finalObjective = 'ganancia1';
		}

		// Caso 3: Mantenimiento con mejora de composición
		else {
			recommendationTitle = '🎯 Objetivo Recomendado: Mantenimiento con Recomposición Corporal';

			const targetRange = isActive 
				? (userGender === 'male' ? '8–15%' : '15–22%') 
				: (userGender === 'male' ? '12–20%' : '20–28%');
			const proteinIntake = isActive 
				? '2.0–2.4 g/kg' 
				: '1.8–2.2 g/kg';
			const trainingFreq = isActive 
				? '4–5 veces/semana (split o push/pull/legs)' 
				: '3 veces/semana (full body)';
			const tip = isActive 
				? 'Espera cambios lentos. Monitorea fuerza y medidas semanales.' 
				: 'Ideal para principiantes o quienes retoman entrenamiento.';

			recommendation = `
				<p><strong>Análisis de composición corporal:</strong></p>
				<p>• Tu IMC es <strong>${bmi.toFixed(1)}</strong> (normal)</p>
				<p>• Tu porcentaje de grasa corporal estimado es <strong>${estimatedBodyFat.toFixed(1)}%</strong> (${bodyFatCategory})</p>
				<p>• Tu masa magra es aproximadamente <strong>${leanMassKg.toFixed(1)} kg</strong></p>

				<p><strong>Objetivo: Perder grasa y ganar músculo simultáneamente. Mantén peso y mejora tu composición hasta alcanzar ~${targetRange}% grasa.</strong></p>
				<p><strong>Estrategia personalizada ${isActive ? '(Deportista/AF intensa)' : '(AF leve o moderada)'}:</strong></p>
				<ul>
					<li>Mantén ingesta en <strong>equilibrio (~${calculatedTDEE.toFixed(0)} kcal/día)</strong>.</li>
					<li>Ingiere <strong>${proteinIntake}</strong> de proteína.</li>
					<li>Entrena con <strong>fuerza ${trainingFreq}</strong>.</li>
					<li>Evita déficits grandes para no perder rendimiento.</li>
				</ul>
				<p><strong>💡 Tip:</strong> ${tip} Usa progresión de carga y alimentación consistente.</p>`;
			finalObjective = 'mantenimiento1';
		}

		// Mostrar recomendación
		if (typeof recommendationResultDiv !== 'undefined' && recommendationResultDiv) {
			recommendationResultDiv.innerHTML = `<h3>${recommendationTitle}</h3>${recommendation}`;
		}


			// === Autocompletar formulario de metas según objetivo ===
		const goalForm = document.getElementById('weight-goal-form');

		if (goalForm) {
			const currentFatInput = document.getElementById('current-fat-percentage');
			const targetFatInput = document.getElementById('target-fat-percentage');
			const targetMuscleInput = document.getElementById('target-muscle-percentage');
			const leanMassGainInput = document.getElementById('desired-lean-mass-gain');

			// Solo autocompletar si los campos están vacíos o no han sido editados
			if (finalObjective === 'perdida1') {
				// Autocompletar %grasa actual y objetivo
				if (currentFatInput && !currentFatInput.value) {
					currentFatInput.value = estimatedBodyFat.toFixed(0); // Usar el %grasa estimado
				}
				if (targetFatInput && !targetFatInput.value) {
					// Objetivo saludable: 15-20% hombre, 20-25% mujer
					const defaultTargetFat = userGender === 'male' 
						? (isActive ? 12 : 18) 
						: (isActive ? 18 : 22);
					targetFatInput.value = defaultTargetFat.toFixed(0);
				}
				// Autocompletar %masa muscular objetivo
				
				if (targetMuscleInput && !targetMuscleInput.value) {
					let defaultMusclePercent;

					if (userGender === 'male') {
						// Hombres
						if (isActive) {
							// Deportista o activo: 40-45%
							defaultMusclePercent = 42; // Valor objetivo medio-alto
						} else {
							// Sedentario: 34-38%
							defaultMusclePercent = 38; // Promedio realista
						}
					} else {
						// Mujeres
						if (isActive) {
							// Deportista: 33-38%
							defaultMusclePercent = 35; // Objetivo saludable y alcanzable
						} else {
							// Sedentaria: 28-32%
							defaultMusclePercent = 30; // Promedio
						}
					}

					// Asignar valor redondeado
					targetMuscleInput.value = defaultMusclePercent.toFixed(0); // Ej: "42"
				}
			}

			else if (finalObjective === 'ganancia1') {
				// Autocompletar %masa muscular objetivo
				 if (targetMuscleInput && !targetMuscleInput.value) {
					const defaultMusclePercent = userGender === 'male'
						? (isActive ? 42 : 36)  // Hombre deportista: 42%, sedentario: 36%
						: (isActive ? 35 : 30); // Mujer deportista: 35%, sedentaria: 30%

					targetMuscleInput.value = defaultMusclePercent.toFixed(0);
				}
				// Autocompletar ganancia de masa magra
				if (leanMassGainInput && !leanMassGainInput.value) {
					// Sugerir ganancia moderada: 2–5 kg
					const suggestedGain = isActive ? 3.0 : 2.0;
					leanMassGainInput.value = suggestedGain.toFixed(0);
				}
			}

					// Opcional: disparar eventos para que otros scripts detecten el cambio
					//['current-fat-percentage', 'target-fat-percentage', 'target-muscle-percentage', 'desired-lean-mass-gain'].forEach(id => {
						//const el = document.getElementById(id);
						///if (el) el.dispatchEvent(new Event('input'));
					//});
		}	
			// === Ajustar automáticamente el objetivo según salud, no solo balance ===
			if (objetivoSelect) {
				// Solo cambiamos si el usuario no ha elegido manualmente antes
				if (!objetivoSelect.dataset.manual) {
					objetivoSelect.value = finalObjective;
					objetivoSelect.dispatchEvent(new Event('change'));
				}
			}
			// === Mostrar el mensaje .info-notice solo cuando hay recomendación ===
				const infoNotice = document.querySelector('.info-notice');
				if (infoNotice) {
					infoNotice.style.display = 'block'; // o 'flex'/'grid' si lo necesitas
					// Opcional: añadir animación suave
					infoNotice.style.opacity = '0';
					setTimeout(() => {
						infoNotice.style.transition = 'opacity 0.4s ease';
						infoNotice.style.opacity = '1';
					}, 100);
				}
				energyBalanceResultDiv.innerHTML = `
				<h3>Balance Energético Estimado:</h3>
				<p>Basado en ${intakeSource} <strong>(${actualIntake.toFixed(0)} kcal</strong>comparada con tu GET <strong> (${calculatedTDEE.toFixed(0)} kcal)</strong></p>
				<p>${balanceInterpretation}</p>`;
			// Reset subsequent steps as Step 1 results changed
			resetStep2onwards();
			updateButtonStates(); // Enable next step button
			
			
			if (calculateGoalButton) {
				calculateGoalButton.disabled = false;
			}
			console.log('calculateGoalButton.disabled:', calculateGoalButton.disabled);
	}

			// Agrega estas funciones en tu código (fuera de otras funciones)



            // --- Step 2: Calculate Weight Goal and Recommendations ---
				function calculateWeightGoal() {
					let targetMusclePercValid = true;
					const objetivoSelect = document.getElementById('objetivo');
					
					// Suponiendo que tienes estas variables:
					const activityLevel = document.getElementById('nivel-actividad')?.value || 'sedentario';
					// userAge, currentLeanMassPerc, currentFatPerc, userGender ya los tienes

					
								// --- Validación del % de masa muscular objetivo ---
					if (objetivoSelect.value === 'ganancia1') {
						const targetMusclePercInput = weightGoalForm.elements['target-muscle-percentage'];
						const targetMusclePerc = parseFloat(targetMusclePercInput.value);

						// Validar rango REALISTA para masa muscular (NO masa magra)
						if (isNaN(targetMusclePerc) || targetMusclePerc < 28 || targetMusclePerc > 45) {
							console.error('Por favor, introduce un valor válido para el porcentaje de masa muscular objetivo (28–45%).');
							alert('⚠️ Para ganar músculo, el porcentaje de masa muscular objetivo debe estar entre 28% y 45% (valores realistas).');
							targetMusclePercValid = false;
						}
					}

					clearContainer(weightGoalResultDiv);
					if (weightChartContainer) weightChartContainer.style.display = 'none';

					if (weightEvolutionChartInstance) {
						weightEvolutionChartInstance.destroy();
						weightEvolutionChartInstance = null;
					}

					// Check prerequisite
					if (!currentWeightKg || !calculatedTDEE) {
						displayError(weightGoalResultDiv, 'Error: Completa el Paso 1 antes de calcular el objetivo de peso.');
						updateButtonStates();
						return;
					}

					// Get values from form
					const currentFatPerc = parseFloat(weightGoalForm.elements['current-fat-percentage'].value);
					const targetFatPerc = parseFloat(weightGoalForm.elements['target-fat-percentage'].value);
					const targetMusclePerc = parseFloat(weightGoalForm.elements['target-muscle-percentage'].value) || 0;
					const desiredLeanGainKg = parseFloat(weightGoalForm.elements['desired-lean-mass-gain'].value) || 0;
					const isAthlete = weightGoalForm.elements['is-athlete'].value === 'yes';
					const currentFatMassKg = currentWeightKg * (currentFatPerc / 100);
					const currentLeanMassKg = currentWeightKg - currentFatMassKg;
					const currentLeanMassPerc = (currentLeanMassKg / currentWeightKg) * 100;
					const targetLeanMassKg = currentLeanMassKg + desiredLeanGainKg;
					const isBeginner = isLikelyBeginner(userAge, activityLevel, currentLeanMassPerc, currentFatPerc, userGender);
					// Validate fat percentages
					if (isNaN(currentFatPerc) || isNaN(targetFatPerc) ||
						currentFatPerc <= 0 || currentFatPerc >= 100 ||
						targetFatPerc <= 0 || targetFatPerc >= 100) {
						displayError(weightGoalResultDiv, 'Por favor, introduce porcentajes de grasa válidos (entre 0.1% y 99.9%).');
						targetWeightKgGlobal = null;
						resetStep3onwards();
						updateButtonStates();
						return;
					}
					// === Estimar si el usuario es "principiante" para recomposición ===
					function isLikelyBeginner(userAge, activityLevel, currentLeanMassPerc, currentFatPerc, userGender) {
						// 1. Nivel de actividad baja o leve → probablemente no entrena con fuerza
						const isLowActivity = ['sedentario', 'leve'].includes(activityLevel.toLowerCase());

						// 2. Masa magra baja para su género
						const leanLowForGender = (userGender === 'male' && currentLeanMassPerc < 70) ||
												 (userGender === 'female' && currentLeanMassPerc < 65);

						// 3. Alta grasa corporal (más de 25% hombre / 32% mujer)
						const isHighFat = (userGender === 'male' && currentFatPerc > 25) ||
										  (userGender === 'female' && currentFatPerc > 32);

						// 4. Edad: si es joven (<50), más fácil adaptarse
						const isYounger = userAge < 50;

						// Criterio: si tiene baja actividad + baja masa magra + alta grasa → muy probable que sea principiante
						return isLowActivity && leanLowForGender && isHighFat && isYounger;
					}
					// --- Calculations ---
					
					targetWeightKgGlobal = targetLeanMassKg / (1 - (targetFatPerc / 100));

					if (targetWeightKgGlobal <= 0 || !isFinite(targetWeightKgGlobal) || targetWeightKgGlobal > 500) {
						displayError(weightGoalResultDiv, 'No se pudo calcular un peso objetivo válido. Revisa los datos.');
						targetWeightKgGlobal = null;
						resetStep3onwards();
						updateButtonStates();
						return;
					}

					const targetFatMassKg = targetWeightKgGlobal * (targetFatPerc / 100);
					const fatMassToLoseGainKg = currentFatMassKg - targetFatMassKg;
					const totalWeightChangeKg = targetWeightKgGlobal - currentWeightKg;
					
					// --- Determine Goal Type ---
					goalTypeGlobal = 'maintenance';
					if (totalWeightChangeKg < -0.1) {
						goalTypeGlobal = 'perdida1';
					} else if (totalWeightChangeKg > 0.1) {
						goalTypeGlobal = 'ganancia1';
					}

					// --- Weekly Rate & Duration ---
					estimatedWeeksGlobal = 0;
					targetWeeklyRateKgGlobal = 0;
					let targetWeeklyRatePerc = 0;

					if (goalTypeGlobal === 'perdida1') {
						targetWeeklyRatePerc = 0.004;
						targetWeeklyRateKgGlobal = Math.max(currentWeightKg * targetWeeklyRatePerc, 0.2);
						targetWeeklyRateKgGlobal = Math.min(targetWeeklyRateKgGlobal, currentWeightKg * 0.01, 1.2);
						estimatedWeeksGlobal = Math.abs(totalWeightChangeKg) / targetWeeklyRateKgGlobal;
					} else if (goalTypeGlobal === 'ganancia1') {
						targetWeeklyRatePerc = 0.003;
						targetWeeklyRateKgGlobal = Math.max(currentWeightKg * targetWeeklyRatePerc, 0.1);
						targetWeeklyRateKgGlobal = Math.min(targetWeeklyRateKgGlobal, currentWeightKg * 0.005, 0.6);
						estimatedWeeksGlobal = totalWeightChangeKg / targetWeeklyRateKgGlobal;
					}

					estimatedWeeksGlobal = Math.max(0, Math.round(estimatedWeeksGlobal));

					// === 🔍 PROYECCIÓN DE GANANCIA MUSCULAR (solo si es ganancia1 y se ingresó % músculo) ===
					let muscleProjectionHTML = '';
					if (goalTypeGlobal === 'ganancia1' && targetMusclePerc > 0) {
						const currentMuscleKg = currentLeanMassKg * 0.75; // Aprox: músculo es ~70-80% de masa magra
						const targetMuscleKg = targetWeightKgGlobal * (targetMusclePerc / 100);
						const netMuscleGainKg = Math.max(0, targetMuscleKg - currentMuscleKg);

						// Velocidad realista de ganancia muscular
						let monthlyGain = userAge < 35 ? 1.0 : (userAge < 50 ? 0.6 : 0.3);
						const monthsToGain = netMuscleGainKg > 0 ? netMuscleGainKg / monthlyGain : 0;

						muscleProjectionHTML = `
						<div class="notes-section">
							<h4>🎯 Proyección Realista de Ganancia Muscular</h4>
							<p><strong>Masa muscular actual estimada:</strong> ${currentMuscleKg.toFixed(1)} kg (~75% de tu masa magra)</p>
							<p><strong>Masa muscular objetivo:</strong> ${targetMuscleKg.toFixed(1)} kg (${targetMusclePerc}% del peso corporal)</p>
							<p><strong>Ganancia neta estimada:</strong> <strong>${netMuscleGainKg.toFixed(1)} kg</strong></p>
							<p><strong>Tiempo estimado (ganancia natural):</strong> ~${monthsToGain.toFixed(1)} meses</p>
							<p><em>Nota: La ganancia muscular realista es de 0.3–1.2 kg/mes, más rápida en principiantes. El resto del peso ganado será grasa y agua.</em></p>
						</div>`;
					}

					// === 📊 EVALUACIÓN DE MASA MUSCULAR (mejorada) ===
					
					let muscleAssessmentHTML = `<div class="notes-section"><h4>Evaluación de Composición Corporal</h4>`;
					muscleAssessmentHTML += `<p><strong>Masa magra actual:</strong> ${currentLeanMassKg.toFixed(1)} kg (${currentLeanMassPerc.toFixed(1)}%)</p>`;
					muscleAssessmentHTML += `<p><em>⚠️ Nota: La masa magra incluye músculo, huesos, órganos y agua. No es igual a masa muscular.</em></p>`;

					const ranges = {
						male: { nonAthlete: [70, 85], athlete: [75, 90] },
						female: { nonAthlete: [60, 75], athlete: [65, 80] }
					};
					const relevantRange = isAthlete ? ranges[userGender].athlete : ranges[userGender].nonAthlete;

					if (currentLeanMassPerc < relevantRange[0]) {
						muscleAssessmentHTML += `<p>Estás por debajo del rango típico (${relevantRange[0]}–${relevantRange[1]}%). <strong>Enfócate en ganar masa muscular con entrenamiento de fuerza y superávit calórico moderado</strong>.</p>`;
					} else if (currentLeanMassPerc > relevantRange[1]) {
						muscleAssessmentHTML += `<p>¡Tienes una masa magra excelente! Por encima del rango general. Ideal para definición o mantenimiento.</p>`;
					} else {
						muscleAssessmentHTML += `<p>Estás dentro del rango saludable de masa magra para tu perfil.</p>`;
					}
					muscleAssessmentHTML += `</div>`;

					// === 🧾 RESULTADOS ===
					let resultsHTML = `<h3>Resultados del Objetivo de Composición Corporal:</h3>`;
					resultsHTML += `<p><strong>Peso Actual:</strong> ${currentWeightKg.toFixed(2)} kg</p>`;
					resultsHTML += `<p><strong>Grasa Actual:</strong> ${currentFatMassKg.toFixed(2)} kg (${currentFatPerc}%)</p>`;
					resultsHTML += `<p><strong>Masa Magra Actual:</strong> ${currentLeanMassKg.toFixed(1)} kg (${currentLeanMassPerc.toFixed(1)}%)</p>`;
					resultsHTML += `<hr style="border: 0; border-top: 1px dashed #a5d6a7; margin: 15px 0;">`;
					resultsHTML += `<p><strong>Peso Objetivo:</strong> ${targetWeightKgGlobal.toFixed(2)} kg</p>`;
					resultsHTML += `<p><strong>Grasa Objetivo:</strong> ${targetFatMassKg.toFixed(2)} kg (${targetFatPerc}%)</p>`;
					resultsHTML += `<p><strong>Masa Magra Objetivo:</strong> ${targetLeanMassKg.toFixed(1)} kg</p>`;
					resultsHTML += `<p><strong>Ganancia Magra Deseada:</strong> ${desiredLeanGainKg.toFixed(1)} kg</p>`;

					if (fatMassToLoseGainKg > 0) {
						resultsHTML += `<p><strong>Grasa a Perder:</strong> ${fatMassToLoseGainKg.toFixed(2)} kg</p>`;
					} else if (fatMassToLoseGainKg < 0) {
						resultsHTML += `<p><strong>Grasa a Ganar:</strong> ${Math.abs(fatMassToLoseGainKg).toFixed(2)} kg</p>`;
					}

					resultsHTML += `<p><strong>Cambio Total de Peso:</strong> ${totalWeightChangeKg.toFixed(2)} kg</p>`;
					resultsHTML += `<p><strong>Ritmo Semanal Objetivo:</strong> ~${targetWeeklyRateKgGlobal.toFixed(2)} kg/semana</p>`;
					if (estimatedWeeksGlobal > 0) {
						resultsHTML += `<p><strong>Duración Estimada:</strong> ~${estimatedWeeksGlobal} semanas (${(estimatedWeeksGlobal / 4.3).toFixed(1)} meses)</p>`;
					}

					// === 🔎 AÑADIR PROYECCIÓN Y EVALUACIÓN ===
					resultsHTML += muscleAssessmentHTML;
					if (muscleProjectionHTML) resultsHTML += muscleProjectionHTML;
					
					// === 🔎 DETERMINAR FASE RECOMENDADA (sin necesidad de hasTrainedBefore) ===
						// --- Determinar fase(objetivo) recomendada ---
						const userWantsGain = objetivoSelect.value === 'ganancia1';
						const userWantsLoss = objetivoSelect.value === 'perdida1';
						//const isAthlete = document.getElementById('is-athlete')?.value === 'yes';
						
						//	const activityLevel = document.getElementById('nivel-actividad')?.value?.toLowerCase();

						const isModerateActivity = ['moderate', 'active', 'very-active'].includes(activityLevel);

						// === Definir umbrales y condiciones clave ===
						const fatThresholdForGain = userGender === 'male' ? 25 : 32;
						const fatThresholdForUrgentLoss = userGender === 'male' ? 30 : 38;
						const isVeryHighFat = currentFatPerc >= fatThresholdForUrgentLoss;

						const isHighFat = (userGender === 'male' && currentFatPerc > 25) ||
										  (userGender === 'female' && currentFatPerc > 32);

						const isLowLean = (userGender === 'male' && currentLeanMassPerc < 70) ||
										  (userGender === 'female' && currentLeanMassPerc < 65);

						const isBeginnerLike = (userGender === 'male' && currentLeanMassPerc < 70) ||
											   (userGender === 'female' && currentLeanMassPerc < 65);

						// Variables de salida
						let recommendedPhase = '';
						let phaseExplanation = '';
						let isMixedPhase = false;

						// === 🔥 MÁXIMA PRIORIDAD: PÉRDIDA DE PESO (GRASA) ===
						if (
							userWantsLoss || 
							(isVeryHighFat && (isBeginnerLike || !isModerateActivity))
						) {
							recommendedPhase = 'Pérdida de Grasa (prioridad máxima)';
							phaseExplanation = `
								<p><strong>🎯 Recomendación principal:</strong> Tu situación requiere una <strong>prioridad en la pérdida de grasa corporal</strong>.</p>
								${isVeryHighFat 
									? `<p>Con un <strong>${currentFatPerc}% de grasa corporal</strong> (por encima del 30% en hombres / 38% en mujeres), 
									   estás en un rango de riesgo metabólico. Reducir grasa mejora salud, movilidad y respuesta a entrenamiento.</p>`
									: `<p>Has seleccionado la pérdida de peso como tu objetivo principal. Este es el momento de enfocarte en reducir grasa corporal.</p>`
								}
								<p>Un <strong>déficit calórico moderado</strong> (~15–25% bajo tu gasto) + <strong>alta proteína (2.2–2.6 g/kg)</strong> + 
								<strong>entrenamiento de fuerza 3–4 veces/semana</strong> será clave para perder grasa sin perder músculo.</p>
								<p><em>💡 Aunque tu masa magra no sea baja, perder grasa ahora te permitirá ganar músculo después con mejor eficiencia.</em></p>
							`;
							isMixedPhase = false;
						}
						// 1. PRIORIDAD: Ganancia muscular para deportistas o con objetivo de ganancia (si grasa es baja)
						else if (
							(userWantsGain || isAthlete) &&
							currentFatPerc < fatThresholdForGain &&
							(isModerateActivity || isAthlete)
						) {
							recommendedPhase = 'Ganancia de Masa Muscular';
							phaseExplanation = `
								<p><strong>🎯 Recomendación principal:</strong> Tu perfil es ideal para una <strong>ganancia muscular controlada</strong>.</p>
								<p>Con un porcentaje de grasa corporal del <strong>${currentFatPerc}%</strong> (< 25% en hombres / 32% en mujeres), 
								puedes ganar músculo sin riesgo de acumular exceso de grasa.</p>
								<p>Un <strong>superávit calórico moderado</strong> (+10–15% sobre tu gasto) combinado con <strong>entrenamiento de fuerza progresivo</strong> maximizará tu hipertrofia.</p>
							`;
							isMixedPhase = false;
						}
						// 2. Recomposición: quiere ganar masa y perder grasa
						else if (desiredLeanGainKg > 0 && fatMassToLoseGainKg > 0) {
							recommendedPhase = 'Fase Mixta (Recomposición Corporal)';
							phaseExplanation = `
								<p><strong>🎯 Recomendación principal:</strong> Estás en una <strong>fase de recomposición corporal</strong>: perder grasa y ganar músculo al mismo tiempo.</p>
								<p>Aunque tu masa magra actual (${currentLeanMassPerc.toFixed(1)}%) está dentro del rango, tu objetivo es aumentarla a <strong>${targetLeanMassKg.toFixed(1)} kg</strong>, 
								mientras reduces la grasa del <strong>${currentFatPerc}%</strong> al <strong>${targetFatPerc}%</strong>.</p>
								<p>Este enfoque es ideal para mejorar tu físico sin grandes cambios de peso.</p>
							`;
							isMixedPhase = true;
						}
						// 3. Pérdida de grasa (tiene grasa alta pero buena masa magra)
						else if (isHighFat && !isLowLean) {
							recommendedPhase = 'Pérdida de Grasa (con preservación muscular)';
							phaseExplanation = `
								<p><strong>🎯 Recomendación principal:</strong> Enfócate en <strong>perder grasa</strong>, pero <strong>protegiendo tu músculo</strong>.</p>
								<p>Tienes una buena base muscular. Un déficit calórico moderado + alta proteína + entrenamiento de fuerza te ayudarán a definirte sin perder masa magra.</p>
							`;
						}
						// 4. Ganancia muscular (baja masa magra, grasa no alta)
						else if (!isHighFat && isLowLean) {
							recommendedPhase = 'Ganancia de Masa Muscular';
							phaseExplanation = `
								<p><strong>🎯 Recomendación principal:</strong> Tu prioridad es <strong>ganar músculo</strong>.</p>
								<p>Aunque tu peso no sea alto, tienes poca masa magra. Un superávit calórico moderado + entrenamiento de fuerza progresivo son clave para construir masa muscular.</p>
							`;
						}
						// 5. Mantenimiento
						else {
							recommendedPhase = 'Mantenimiento o Afinamiento';
							phaseExplanation = `
								<p><strong>🎯 Recomendación principal:</strong> Estás cerca de tu objetivo. Puedes mantener tu peso o hacer ajustes finos.</p>
								<p>Perfecto para consolidar hábitos, mejorar la calidad de vida o afinar tu definición sin cambios drásticos.</p>
							`;
						}
					// === 💡 RECOMENDACIONES PERSONALIZADAS ===
					resultsHTML += `<div class="notes-section"><h4>💡 Recomendaciones Clave</h4><ul>`;
					
					if (goalTypeGlobal === 'perdida1') {
						const deficit = Math.min(600, Math.max(400, targetWeeklyRateKgGlobal * 7700 / 7));
						resultsHTML += `<li><strong>Déficit calórico:</strong> ~${deficit.toFixed(0)} kcal/día</li>`;
						resultsHTML += `<li><strong>Proteína:</strong> 1.8–2.4 g/kg para preservar músculo</li>`;
						resultsHTML += `<li><strong>Entrenamiento:</strong> Fuerza 3–4 veces/semana + cardio moderado</li>`;
					} else if (goalTypeGlobal === 'ganancia1') {
						const surplus = Math.min(500, Math.max(250, targetWeeklyRateKgGlobal * 7700 / 7));
						resultsHTML += `<li><strong>Superávit calórico:</strong> ~${surplus.toFixed(0)} kcal/día</li>`;
						resultsHTML += `<li><strong>Proteína:</strong> 1.6–2.2 g/kg de peso corporal</li>`;
						resultsHTML += `<li><strong>Entrenamiento:</strong> Hipertrofia 4–5 veces/semana, progresión de carga</li>`;
						resultsHTML += `<li><strong>Realismo:</strong> Ganas músculo lentamente. El resto será grasa. Evita el “bulking” extremo.</li>`;
					} else {
						resultsHTML += `<li><strong>Mantenimiento calórico:</strong> Igual a tu GET</li>`;
						resultsHTML += `<li><strong>Proteína:</strong> 1.2–1.8 g/kg</li>`;
					}

					resultsHTML += `<li><strong>Monitorización:</strong> Pésate semanalmente y ajusta según progreso</li>`;
					resultsHTML += `</ul></div>`;
					// === 📌 FASE RECOMENDADA ===
					resultsHTML += `
					<div class="notes-section" style="border-left: 4px solid #ff9800; background: #fff3e0;">
						<h4>📌 Fase Recomendada: ${recommendedPhase}</h4>
						${phaseExplanation}
						${isMixedPhase ? `
						<p><strong>¿Cómo funciona?</strong></p>
						<ul>
							<li><strong>Alimentación:</strong> Calorías cercanas al mantenimiento o déficit leve (100–300 kcal)</li>
							<li><strong>Proteína:</strong> Alta (2.2–2.6 g/kg de peso corporal)</li>
							<li><strong>Entrenamiento:</strong> Fuerza progresiva 4–5 veces/semana</li>
							<li><strong>Progreso:</strong> Pérdida lenta de grasa (0.2–0.4 kg/semana) + ganancia muscular gradual</li>
						</ul>
						<p><em>💡 Nota: Puede que tu peso no baje rápido, pero tu físico cambiará: más definido y tonificado.</em></p>
						` : ''}
					</div>`;
					
					// === 🥗 ESTRATEGIAS DIETÉTICAS RECOMENDADAS POR FASE ===
					let dietStrategiesHTML = `<div class="notes-section"><h4>🥗 Estrategias Dietéticas Recomendadas</h4>`;

					// Definir estrategias por fase
					if (recommendedPhase.includes('Fase Mixta')) {
						dietStrategiesHTML += `
							<p><strong>Para tu perfil (alta grasa + baja masa magra), estas estrategias maximizan la recomposición:</strong></p>
							<ul>
								<li><strong>Hiperproteica (2.2–2.6 g/kg):</strong> Prioriza la construcción muscular. Ej: ${Math.round(currentWeightKg * 2.4)} g de proteína/día.</li>
								<li><strong>Carb Cycling (días altos/bajos HC):</strong> Más carbohidratos en días de entreno, menos en reposo. Mantiene energía sin acumular grasa.</li>
								<li><strong>TKD (25–50g HC pre/post entreno):</strong> Ideal si entrenas en déficit. Mejora rendimiento sin salir de cetosis metabólica.</li>
								<li><strong>Timing nutricional:</strong> Consume proteína (0.4 g/kg) y HC tras el entreno para maximizar recuperación.</li>
								<li><strong>Flexible Dieting (80/20):</strong> Enfócate en objetivos calóricos y de macros. Permite sostenibilidad a largo plazo.</li>
								<li><strong>Refeed semanal (1 día HC alto):</strong> Ayuda a regular hormonas del hambre y mantener el metabolismo.</li>
								<li><strong>🟡 Cetogénica (cetosis estricta, <50g HC/día):</strong> Puede acelerar la pérdida inicial de grasa y reducir apetito, pero <strong>solo recomendada si:</strong>
										<ul style="font-size: 0.9em; margin-top: 5px; padding-left: 20px;">
											<li>No realizas entrenamientos de alta intensidad o fuerza frecuentes</li>
											<li>Eres sedentario o tu nivel de actividad es leve</li>
											<li>Tienes buena tolerancia metabólica a las grasas</li>
										</ul>
										<em>⚠️ No recomendada para deportistas: puede reducir rendimiento, volumen de entrenamiento y retención muscular.</em>
								</li>
									<li><strong>🟡 Protein Cycling (4 semanas altas + 1 semana baja proteína):</strong> Enfoque experimental. Algunos teorizan que "resetea" la síntesis proteica, pero <strong>la evidencia es débil</strong>.
										<ul style="font-size: 0.9em; margin-top: 5px; padding-left: 20px;">
											<li>Puede usarse en fases largas de pérdida para variar estímulos</li>
											<li>No interrumpir en semanas clave de progreso</li>
										</ul>
										<em>💡 Si lo usas: semana baja = 1.2–1.4 g/kg, luego vuelve a 2.4+ g/kg.</em>
									</li>
								</ul>
							<p><em>Evita cetosis estricta o ayunos prolongados si afectan tu rendimiento.</em></p>
						`;
					} else if (recommendedPhase.includes('Pérdida de Grasa')) {
						dietStrategiesHTML += `
							<p><strong>Objetivo: perder grasa preservando músculo. Estrategias efectivas:</strong></p>
							<ul>
								<li><strong>✅ Hiperproteica (2.2–2.6 g/kg):</strong> Esencial para proteger masa muscular. Ej: ${Math.round(currentWeightKg * 2.4)} g de proteína/día.</li>
								<li><strong>✅ Flexible Dieting (80/20):</strong> Mayor adherencia. No necesitas alimentos "perfectos", solo equilibrio calórico y de macros.</li>
								<li><strong>✅ IF 16:8:</strong> Puede ayudar a controlar el apetito y simplificar la alimentación, especialmente si no tienes hambre por la mañana.</li>
								<li><strong>✅ Refeed (1 día/semana HC alto):</strong> Útil en déficits prolongados (>8 semanas). Ayuda a regular leptina, mejorar energía y mantener el metabolismo.</li>
								<li><strong>✅ TKD (25–50g HC pre/post entreno):</strong> Ideal si entrenas intenso y sigues bajo en carbohidratos. Mantiene rendimiento sin salir del objetivo de pérdida.</li>
								<li><strong>🟡 Cetogénica (cetosis estricta, <50g HC/día):</strong> Puede acelerar la pérdida inicial de grasa y reducir apetito, pero <strong>solo recomendada si:</strong>
									<ul style="font-size: 0.9em; margin-top: 5px; padding-left: 20px;">
										<li>No realizas entrenamientos de alta intensidad o fuerza frecuentes</li>
										<li>Eres sedentario o tu nivel de actividad es leve</li>
										<li>Tienes buena tolerancia metabólica a las grasas</li>
									</ul>
									<em>⚠️ No recomendada para deportistas: puede reducir rendimiento, volumen de entrenamiento y retención muscular.</em>
								</li>
								<li><strong>🟡 Protein Cycling (4 semanas altas + 1 semana baja proteína):</strong> Enfoque experimental. Algunos teorizan que "resetea" la síntesis proteica, pero <strong>la evidencia es débil</strong>.
									<ul style="font-size: 0.9em; margin-top: 5px; padding-left: 20px;">
										<li>Puede usarse en fases largas de pérdida para variar estímulos</li>
										<li>No interrumpir en semanas clave de progreso</li>
									</ul>
									<em>💡 Si lo usas: semana baja = 1.2–1.4 g/kg, luego vuelve a 2.4+ g/kg.</em>
								</li>
							</ul>
							<p><em>🔑 Clave: el déficit calórico es lo más importante. Las estrategias ayudan, pero no sustituyen el balance energético.</em></p>
						`;
				
					} else if (recommendedPhase.includes('Ganancia de Masa Muscular')) {
						dietStrategiesHTML += `
							<p><strong>Objetivo: ganar músculo con mínimo aumento de grasa. Estrategias clave:</strong></p>
							<ul>
								<li><strong>✅ Hiperproteica (1.8–2.2 g/kg):</strong> Base para la hipertrofia. Ej: ${Math.round(currentWeightKg * 2.0)} g/día.</li>
								<li><strong>✅ Carb Cycling:</strong> Días de entreno: HC altos (4–6 g/kg); reposo: moderados/bajos.</li>
								<li><strong>✅ CKD o 5+2 HC:</strong> 5 días moderados, 2 días altos (150–500g). Ideal para deportistas.</li>
								<li><strong>✅ Timing nutricional:</strong> HC + proteína post-entreno para máxima síntesis muscular.</li>
								<li><strong>✅ Carb-loading (pre-entrenos intensos):</strong> Aumenta rendimiento en sesiones clave.</li>
								<li><strong>✅ Flexible Dieting:</strong> Para mantener adherencia sin obsesionarse con "alimentos limpios".</li>
							</ul>
							<p><em>❌ Evita cetosis estricta: limita rendimiento y adaptaciones musculares.</em></p>
						`;
					} else {
						// Mantenimiento o afinamiento
						dietStrategiesHTML += `
							<p><strong>Objetivo: mantener tu composición corporal con hábitos sostenibles:</strong></p>
							<ul>
								<li><strong>✅ Flexible Dieting (80/20):</strong> Enfoque más realista y duradero. Prioriza disfrute y equilibrio.</li>
								<li><strong>✅ Hiperproteica (1.6–2.0 g/kg):</strong> Ayuda a mantener masa muscular. Ej: ${Math.round(currentWeightKg * 1.8)} g/día.</li>
								<li><strong>✅ IF 16:8 o Carb Cycling:</strong> Si encajan con tu rutina. No obligatorios, pero útiles para auto-regulación.</li>
								<li><strong>✅ Timing proteico:</strong> Distribuye proteína en 3–5 comidas (0.4 g/kg por comida).</li>
							</ul>
							<p><em>En mantenimiento, la sostenibilidad es más importante que la estrategia específica.</em></p>
						`;
					}

					dietStrategiesHTML += `</div>`;
					
					
					

					// Añadir al resultado final
					resultsHTML += dietStrategiesHTML;
					
					
					// === ⚠️ VALIDACIÓN DE OBJETIVOS IRREALISTAS (versión corregida) ===
					function showUnrealisticGoalWarning(message) {
						alert("⚠️ Advertencia: Objetivo poco realista\n\n" + message);
					}

					// --- 1. Detectar ganancia muscular excesiva ---
					if (goalTypeGlobal === 'ganancia1') {
						const leanGainKg = targetLeanMassKg - currentLeanMassKg;
						const weeks = estimatedWeeksGlobal || 16;
						const leanGainPerWeek = leanGainKg / weeks;

						// Estimar si es principiante (sin hasTrainedBefore)
						const isBeginner = (function() {
							const lowLean = (userGender === 'male' && currentLeanMassPerc < 70) ||
											(userGender === 'female' && currentLeanMassPerc < 65);
							const highFat = (userGender === 'male' && currentFatPerc > 25) ||
											(userGender === 'female' && currentFatPerc > 32);
							const isYoung = userAge < 50;
							const activityLevel = document.getElementById('nivel-actividad')?.value?.toLowerCase();
							const isLowActivity = ['sedentario', 'leve'].includes(activityLevel);
							return (lowLean || highFat) && isLowActivity && isYoung;
						})();

						// Ganancia máxima realista por semana (en kg)
						const maxGainPerWeek = isBeginner 
							? 0.8  // Principiante: mayor hipertrofia inicial
							: 0.5; // Intermedio/avanzado

						if (leanGainPerWeek > maxGainPerWeek * 1.5) {
							const realisticMaxGain = (maxGainPerWeek * weeks).toFixed(1);
							const timeNeeded = (leanGainKg / maxGainPerWeek).toFixed(1);
							
							showUnrealisticGoalWarning(
								`Estás buscando ganar ${leanGainKg.toFixed(1)} kg de masa magra en ${weeks} semanas.\n\n` +
								`La ganancia muscular realista es de ${maxGainPerWeek.toFixed(2)} kg/semana.\n\n` +
								`Máximo esperado en este tiempo: ~${realisticMaxGain} kg.\n\n` +
								`Para lograr ${leanGainKg.toFixed(1)} kg, necesitarías ~${timeNeeded} semanas (${(timeNeeded/4.3).toFixed(1)} meses) como mínimo.\n\n` +
								`Recuerda: no todo el peso ganado será músculo. Parte será grasa y agua.`
							);
						}
					}

					// --- 2. Pérdida de grasa demasiado rápida ---
					if (goalTypeGlobal === 'perdida1') {
						const fatToLoseKg = currentFatMassKg - targetFatMassKg;
						const weeks = estimatedWeeksGlobal || 16;
						const fatLossPerWeek = fatToLoseKg / weeks;

						const maxSafeLossPerWeek = currentWeightKg * 0.01; // 1% del peso corporal

						if (fatLossPerWeek > 1.0 || fatLossPerWeek > maxSafeLossPerWeek) {
							const maxPossible = (maxSafeLossPerWeek * weeks).toFixed(1);
							
							showUnrealisticGoalWarning(
								`Estás buscando perder ${fatToLoseKg.toFixed(1)} kg de grasa en ${weeks} semanas.\n\n` +
								`Una pérdida segura es de 0.5–1.0 kg/semana (máximo ~${maxSafeLossPerWeek.toFixed(1)} kg/semana).\n\n` +
								`Pérdidas más rápidas pueden causar pérdida muscular, bajos niveles de energía y rebote.\n\n` +
								`Te recomendamos no superar ${maxPossible} kg en este periodo para un proceso saludable.`
							);
						}
					}

					// --- 3. Recomposición imposible ---
					if (desiredLeanGainKg > 3 && fatMassToLoseGainKg > 3 && estimatedWeeksGlobal < 20) {
						showUnrealisticGoalWarning(
							`Tu objetivo combina una gran ganancia muscular (${desiredLeanGainKg.toFixed(1)} kg) ` +
							`con una pérdida significativa de grasa (${fatMassToLoseGainKg.toFixed(1)} kg) en solo ~${estimatedWeeksGlobal} semanas.\n\n` +
							`Esto es extremadamente difícil de lograr, incluso para principiantes.\n\n` +
							`Recomendamos enfocarte primero en una fase clara:\n` +
							`- Si tienes grasa >25%: pérdida de grasa\n` +
							`- Si tienes grasa <25%: ganancia muscular controlada\n\n` +
							`La recomposición corporal es lenta y solo viable en casos específicos.`
						);
					}

					// --- 4. Cambio de peso demasiado rápido ---
					const totalWeightChangePerWeek = Math.abs(totalWeightChangeKg) / (estimatedWeeksGlobal || 1);
					if (totalWeightChangePerWeek > 1.2) {
						showUnrealisticGoalWarning(
							`Tu objetivo implica un cambio de peso de ${totalWeightChangePerWeek.toFixed(2)} kg/semana.\n\n` +
							`Cambios mayores a 1.2 kg/semana no son sostenibles ni saludables.\n\n` +
							`Pueden causar pérdida muscular, problemas metabólicos o rebote.\n\n` +
							`Recomendamos un ritmo de 0.3–1.0 kg/semana para mejores resultados a largo plazo.`
						);
					}
					// === 🔁 ACTUALIZAR SELECT DE OBJETIVO SEGÚN FASE RECOMENDADA ===
						// === 🔁 FORZAR SELECT A OBJETIVO RECOMENDADO + MENSAJE EDUCATIVO ===
								//const objetivoSelect = document.getElementById('objetivo');
								const objectiveFeedbackContainer = document.getElementById('objective-feedback') || (() => {
									// Si no existe, crear contenedor bajo el select
									const container = document.createElement('div');
									container.id = 'objective-feedback';
									container.style.margin = '8px 0';
									container.style.fontSize = '0.9em';
									objetivoSelect.parentNode.insertBefore(container, objetivoSelect.nextSibling);
									return container;
								})();

								if (objetivoSelect && recommendedPhase) {
									let valueToSelect = 'sel';
									let displayName = 'Selecciona segun Objetivo';
									let explanation = '';

									if (recommendedPhase.includes('Pérdida') || recommendedPhase.includes('prioridad máxima')) {
										valueToSelect = 'perdida1';
										displayName = 'Pérdida de Peso';
										explanation = 'Te recomendamos perder grasa porque tienes un porcentaje elevado. Este enfoque mejora tu salud y prepara tu cuerpo para ganar músculo después.';
									} 
									else if (recommendedPhase.includes('Ganancia')) {
										valueToSelect = 'ganancia1';
										displayName = 'Ganancia de Peso';
										explanation = 'Tu nivel de grasa es adecuado para ganar músculo. Un superávit calórico moderado te ayudará a construir masa muscular eficientemente.';
									} 
									else if (recommendedPhase.includes('Mantenimiento')) {
										valueToSelect = 'mantenimiento1';
										displayName = 'Mantenimiento';
										explanation = 'Estás cerca de tu objetivo. Mantener tu peso actual te permite consolidar hábitos y prepararte para futuros cambios.';
									} 
									else if (recommendedPhase.includes('Mixta') || recommendedPhase.includes('Recomposición') || recommendedPhase.includes('Combinada')) {
										valueToSelect = 'mixto1';
										displayName = 'Mixto/Combinado';
										explanation = 'Puedes mejorar tu composición corporal perdiendo grasa y ganando músculo al mismo tiempo. Ideal si eres principiante o tienes grasa alta + poca masa muscular.';
									}

									// --- 1. Forzar el valor del select ---
									objetivoSelect.value = valueToSelect;
									objetivoSelect.dispatchEvent(new Event('change')); // Actualiza el resto de la interfaz

									// --- 2. Mostrar mensaje educativo ---
									objectiveFeedbackContainer.innerHTML = `
										<div style="
											background-color: #e3f2fd; 
											border: 1px solid #bbdefb; 
											border-radius: 6px; 
											padding: 12px; 
											font-size: 0.95em; 
											color: #1565c0; 
											line-height: 1.5;
										">
											<strong>🎯 Objetivo recomendado: ${displayName}</strong>
											<p style="margin: 8px 0; opacity: 0.9;">
												${explanation}
											</p>
											<small style="color: #555;">
												Puedes cambiarlo manualmente si lo deseas, pero esta opción es la más adecuada para tu perfil actual.
											</small>
										</div>
									`;
								}
					// === MOSTRAR RESULTADOS ===
					weightGoalResultDiv.innerHTML = resultsHTML;

					// Show chart if applicable
					if (goalTypeGlobal !== 'maintenance' && estimatedWeeksGlobal > 1 && weightChartContainer) {
						generateWeightEvolutionChart(currentWeightKg, targetWeightKgGlobal, estimatedWeeksGlobal);
						weightChartContainer.style.display = 'block';
					}

					// Set goal calories in Step 3
					if (calculatedTDEE && goalCaloriesInput) {
						let suggestedGoalCalories = calculatedTDEE;
						if (goalTypeGlobal === 'perdida1') suggestedGoalCalories *= 0.90;
						else if (goalTypeGlobal === 'ganancia1') suggestedGoalCalories *= 1.10;
						goalCaloriesInput.value = Math.round(suggestedGoalCalories);
					}

					// Update macros
					if (proteinPercentageInput && carbPercentageInput && fatPercentageInput) {
						setTimeout(() => actualizarMacrosPorFase(), 100);
					}
					
					// === 🌫️ MOSTRAR MODAL CON FADE IN/OUT + INFO NUTRICIONAL ===
					setTimeout(() => {
						const objetivoSelect = document.getElementById('objetivo');
						const selectedObjective = objetivoSelect?.value;

						if (!selectedObjective || selectedObjective === 'sel') return;

						// === 🔍 CONFIGURACIÓN DE FASES + INFO EDUCATIVA ===
						const faseConfig = {
							perdida1: {
								title: "Elige tu Fase (Pérdida de Peso)",
								options: [
									{
										value: "induccion_cetogenica1",
										label: "Inducción Cetogénica",
										info: `
											<strong>Muy baja en carbohidratos / Cetogénica (VLCKD)</strong><br>
											<strong>CH diarios:</strong> <50 g/día (20–30 g típico)<br>
											<strong>% Energía:</strong> 5–10% de HC<br>
											<strong>Características:</strong> Alta en grasas (70-80%), moderada en proteínas. Induce cetosis. Elimina cereales, azúcares, frutas, legumbres.<br>
											<strong>Relación grasa:(proteína+HC):</strong> 2:1 a 4:1<br>
											<strong>Cuándo usarla:</strong> Obesidad con síndrome metabólico, diabetes tipo 2, hígado graso. <em>Debe ser supervisada.</em>
										`
									},
									{
										value: "ciclado_metabolico1",
										label: "Ciclado Metabólico",
										info: `
											<strong>Ciclado de carbohidratos (Carb Cycling)</strong><br>
											<strong>Estrategia:</strong> Días de HC bajos (30–100g) en reposo, días altos (200–400g) en entrenos.<br>
											<strong>Características:</strong> Combina beneficios de cetosis y recarga de glucógeno. Mantiene rendimiento y flexibilidad metabólica.<br>
											<strong>Cuándo usarlo:</strong> Pérdida de grasa con preservación muscular, deportistas en déficit, personas con alta adherencia.
										`
									},
									{
										value: "transicion_mantenimiento1",
										label: "Transición a Mantenimiento",
										info: `
											<strong>Moderada en carbohidratos</strong><br>
											<strong>CH diarios:</strong> 100–150 g/día<br>
											<strong>% Energía:</strong> 26–45% de HC<br>
											<strong>Características:</strong> Flexible, incluye cereales integrales, frutas, legumbres. Déficit calórico leve.<br>
											<strong>Cuándo usarla:</strong> Fin de una fase de pérdida, para evitar el efecto rebote y estabilizar el metabolismo.
										`
									}
								],
								targetSelectId: "fasePerdida1",
								labelId: "labelFasePerdida1"
							},
							ganancia1: {
								title: "Elige tu Fase (Ganancia de Peso)",
								options: [
									{
										value: "volumen1",
										label: "Volumen Muscular",
										info: `
											<strong>Volumen Muscular</strong><br>
											<strong>Grasas:</strong> 25–35%<br>
											<strong>Proteínas:</strong> 25–30% (1.6–2.2 g/kg)<br>
											<strong>HC:</strong> 40–50% (300–500g/día)<br>
											<strong>Objetivo:</strong> Superávit moderado para hipertrofia con control de grasa.
										`
									},
									{
										value: "masa1",
										label: "Enfocado en Masa Muscular",
										info: `
											<strong>Enfocado en Masa Muscular</strong><br>
											<strong>Énfasis:</strong> HC complejos (arroz, avena, patata) y proteína post-entreno.<br>
											<strong>Superávit:</strong> 10–15% sobre el gasto.<br>
											<strong>Objetivo:</strong> Maximizar ganancia muscular, incluso con algo de grasa.
										`
									}
								],
								targetSelectId: "faseGanancia1",
								labelId: "labelFaseGanancia1"
							},
							mantenimiento1: {
								title: "Elige tu Enfoque (Mantenimiento)",
								options: [
									{
										value: "equilibrio1",
										label: "Equilibrio Flexible",
										info: `
											<strong>Equilibrio Flexible</strong><br>
											<strong>Grasas:</strong> 30–35%<br>
											<strong>Proteínas:</strong> 20–25% (1.6–2.0 g/kg)<br>
											<strong>HC:</strong> 35–45% (200–300g/día)<br>
											<strong>Objetivo:</strong> Sostenibilidad a largo plazo, sin déficit ni superávit.
										`
									},
									{
										value: "social1",
										label: "Adherencia Social",
										info: `
											<strong>Adherencia Social</strong><br>
											<strong>Flexibilidad:</strong> Mayor tolerancia a HC en comidas sociales.<br>
											<strong>Proteína:</strong> Moderada, distribuida.<br>
											<strong>Objetivo:</strong> Mantener hábitos sin rigidez, ideal para vida activa.
										`
									}
								],
								targetSelectId: "enfoqueMantenimiento1",
								labelId: "labelEnfoqueMantenimiento1"
							},
							mixto1: {
								title: "Elige tu Fase (Mixto/Combinado)",
								options: [
									{
										value: "volumen1",
										label: "Volumen",
										info: `
											<strong>Periodización: Volumen</strong><br>
											<strong>HC:</strong> 40–50%<br>
											<strong>Proteína:</strong> 25–30%<br>
											<strong>Objetivo:</strong> Ganancia muscular con déficit leve o mantenimiento.
										`
									},
									{
										value: "definicion1",
										label: "Definición",
										info: `
											<strong>Periodización: Definición</strong><br>
											<strong>HC:</strong> 10–25%<br>
											<strong>Proteína:</strong> 25–35%<br>
											<strong>Objetivo:</strong> Pérdida de grasa con preservación muscular.
										`
									},
									{
										value: "mantenimiento1",
										label: "Mantenimiento",
										info: `
											<strong>Periodización: Mantenimiento</strong><br>
											<strong>HC:</strong> 30–40%<br>
											<strong>Proteína:</strong> 20–25%<br>
											<strong>Objetivo:</strong> Estabilizar composición, recuperar hormonas, prevenir rebote.
										`
									}
								],
								targetSelectId: "faseMixto1",
								labelId: "labelFaseMixto1"
							}
						};

						const config = faseConfig[selectedObjective];
						if (!config) return;

						// === 🧱 CREAR MODAL CON INFO ===
						const modal = document.createElement('div');
						modal.id = 'phase-selection-modal';
						modal.style.cssText = `
							position: fixed; top: 0; left: 0; width: 100%; height: 100%;
							background: rgba(0, 0, 0, 0); display: flex; justify-content: center;
							align-items: center; z-index: 2000; font-family: Arial, sans-serif;
							transition: background 0.4s ease;
						`;

						modal.innerHTML = `
							<div class="modal-content" style="
								opacity: 0; transform: scale(0.9);
								transition: opacity 0.3s ease, transform 0.3s ease;
								background: white; border-radius: 12px; width: 90%; max-width: 600px;
								padding: 24px; box-shadow: 0 8px 30px rgba(0,0,0,0.2);
								max-height: 90vh; overflow-y: auto;
							">
								<h3 style="margin: 0 0 16px; color: #1976d2;">${config.title}</h3>
								<p style="color: #555; font-size: 0.95em; margin-bottom: 16px;">
									Selecciona la fase que mejor se adapte a tu estilo de vida y objetivos. 
									<strong>Desplaza para ver detalles de cada opción.</strong>
								</p>
								<ul style="list-style: none; padding: 0; margin: 16px 0;">
									${config.options.map(opt => `
										<li style="margin: 12px 0;">
											<label style="
												display: block; cursor: pointer; padding: 12px; border: 1px solid #ddd;
												border-radius: 8px; background: #f9f9f9; transition: background 0.2s;
											" onmouseover="this.style.background='#f0f4f8'" onmouseout="this.style.background='#f9f9f9'">
												<div style="display: flex; align-items: center; margin-bottom: 6px;">
													<input type="radio" name="phaseOption" value="${opt.value}" style="margin-right: 10px;">
													<strong style="font-size: 1.05em; color: #228720;">${opt.label}</strong>
												</div>
												<div style="font-size: 0.9em; color: #444; line-height: 1.5; padding-left: 28px;">
													${opt.info}
												</div>
											</label>
										</li>
									`).join('')}
								</ul>
								<div style="text-align: right; margin-top: 16px;">
									<button id="cancelModal" style="
										background: #e0e0e0; color: #333; border: none; padding: 8px 16px;
										border-radius: 4px; cursor: pointer; margin-right: 8px; font-size: 0.95em;
									">Cancelar</button>
									<button id="confirmPhase" style="
										background: #205e22; color: white; border: none; padding: 8px 16px;
										border-radius: 4px; cursor: pointer; font-size: 0.95em;
									">Seleccionar</button>
								</div>
							</div>
						`;

						document.body.appendChild(modal);

						// ✅ FADE IN
						setTimeout(() => {
							modal.style.background = 'rgba(0, 0, 0, 0.7)';
							modal.querySelector('.modal-content').style.opacity = '1';
							modal.querySelector('.modal-content').style.transform = 'scale(1)';
						}, 100);

						// ✅ FADE OUT + limpieza
						function closeModal() {
							modal.style.background = 'rgba(0, 0, 0, 0)';
							const content = modal.querySelector('.modal-content');
							content.style.opacity = '0';
							content.style.transform = 'scale(0.9)';
							setTimeout(() => modal.remove(), 300);
						}

						// Acciones
						const confirmBtn = modal.querySelector('#confirmPhase');
						const cancelBtn = modal.querySelector('#cancelModal');

						confirmBtn.onclick = function () {
							const selected = modal.querySelector('input[name="phaseOption"]:checked');
							if (!selected) {
								alert('⚠️ Por favor, selecciona una fase.');
								return;
							}
							const selectedValue = selected.value; // Ej: 'induccion_cetogenica1'
							const targetSelect = document.getElementById(config.targetSelectId);
							const targetLabel = document.getElementById(config.labelId);
							
							// === 1. Establecer el valor en el <select> correspondiente ===
							if (targetSelect) {
								targetSelect.value = selected.value;
								targetSelect.dispatchEvent(new Event('change'));
							}
							 // === 2. Mostrar el <label> si estaba oculto ===
							if (targetLabel) {
								targetLabel.style.display = 'block';
							}
							// === 3. Establecer goalTypeGlobal según el objetivo actual ===
							// selectedObjective ya está definido fuera (es el valor de 'objetivo')
							const selectedObjective = objetivoSelect.value;

							if (['perdida1', 'ganancia1', 'mantenimiento1', 'mixto1'].includes(selectedObjective)) {
								window.goalTypeGlobal = selectedObjective; // Aseguramos que sea global
							} else {
								window.goalTypeGlobal = 'maintenance'; // valor por defecto
							}

							// ✅ Opcional: depuración
								console.log("✅ Fase guardada:", selectedValue);
								console.log("✅ Objetivo (goalTypeGlobal):", window.goalTypeGlobal);

							closeModal();
						};

						cancelBtn.onclick = closeModal;
						modal.onclick = (e) => {
							if (e.target === modal) closeModal();
						};

					}, 500);					
					resetStep3onwards();
				}
// <-- Esta llave cierra correctamente la función calculateWeightGoal

            // --- Helper Function to Generate Weight Evolution Chart (Step 2) ---
            // NOTA: Esta función debe definirse FUERA de calculateWeightGoal
            function generateWeightEvolutionChart(startWeight, endWeight, weeks) {
                if (!weightChartContainer) return; // Exit if container not found
                weightChartContainer.innerHTML = '<canvas id="weightEvolutionChart"></canvas>'; // Ensure canvas exists
                const ctx = document.getElementById('weightEvolutionChart')?.getContext('2d');
                if (!ctx) {
                     console.error("Failed to get canvas context for weightEvolutionChart");
                     return;
                }
                // Destroy previous instance if exists
                if (weightEvolutionChartInstance) { weightEvolutionChartInstance.destroy(); }
                const labels = Array.from({ length: weeks + 1 }, (_, i) => `Sem ${i}`);
                const weightData = Array.from({ length: weeks + 1 }, (_, i) => {
                    // Linear interpolation between start and end weight
                    return startWeight + (endWeight - startWeight) * (i / weeks);
                });
                weightEvolutionChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Peso Estimado (kg) - Auto',
                             weightData,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            fill: true,
                            tension: 0.1 }]
                        },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            title: { display: true, text: `Evolución Estimada del Peso (${weeks} Semanas - Auto)` },
                            tooltip: { callbacks: { label: function(context) { return `Semana ${context.dataIndex}: ${context.parsed.y.toFixed(2)} kg`; } } }
                            },
                        scales: {
                            y: { title: { display: true, text: 'Peso (kg)' }, ticks: { callback: function(value) { return value.toFixed(1); } } },
                            x: { title: { display: true, text: 'Semanas' } }
                            }
                        }
                });
            }

            // --- Helper Function to Generate Monitoring Info HTML ---
            // NOTA: Esta función también debe definirse FUERA de calculateWeightGoal
            function generateMonitoringHTML() {
                // Static content, can be adjusted if needed
                let monitoringHTML = `<div class="monitoring-section"><h4>Monitorización y Ajustes Sugeridos</h4><h5>Análisis de Sangre</h5><ul><li><strong>Frecuencia:</strong> Cada 12-16 semanas (aproximadamente cada 2-3 ciclos).</li><li><strong>Parámetros a evaluar:</strong><ul><li>Función renal: Creatinina y TFG.</li><li>Función hepática: ALT, AST, bilirrubina.</li><li>Colesterol: Total, LDL, HDL, triglicéridos.</li></ul></li><li><strong>Momentos clave sugeridos (ejemplo para ~55 semanas):</strong><ul><li>Inicio (semana 0).</li><li>Mitad del plan (~semana 28).</li><li>Final (~semana 55).</li></ul><em>Ajusta estos momentos a la duración real de tu plan.</em></li></ul><h5>Reevaluación de Composición Corporal</h5><ul><li><strong>Frecuencia:</strong> Cada 8-12 semanas, idealmente al final de cada ciclo completo.</li><li><strong>Momentos sugeridos (ejemplo para ~55 semanas con ciclos de 7 sem):</strong><ul><li>Semana 7 (final Ciclo 1).</li><li>Semana 21 (final Ciclo 3).</li><li>Semana 35 (final Ciclo 5).</li><li>Semana 49 (final Ciclo 7).</li></ul><em>Ajusta estos momentos a la duración real de tu plan y tus ciclos.</em></li><li><strong>Método:</strong> Bioimpedancia o DEXA.</li><li><strong>Ajustes:</strong> Recalcular GET y ajustar calorías/macros según nuevo peso/composición.</li></ul></div>`;
                return monitoringHTML;
            }

            
            // --- Step 4: Calculate Macronutrients ---
            function calculateMacros() {
                clearContainer(macroResultDiv);
                if(chartContainer) chartContainer.style.display = 'none'; // Hide macro chart
                clearContainer(step5TableContainer); // Clear previous auto table (Step 5)
                displayInfo(step5TableContainer, '<em>Calculando tabla de ciclos automática...</em>'); // Show loading message for auto table

                if (macroChartInstance) { macroChartInstance.destroy(); macroChartInstance = null; }

                // Check prerequisites
                if (!calculatedTDEE || !targetWeightKgGlobal) {
                    displayError(macroResultDiv, 'Error: Completa los Pasos 1 y 2 antes de calcular macronutrientes.');
                    displayError(step5TableContainer, '<em>Error: Completa los Pasos 1 y 2 para generar la tabla de ciclos automática.</em>');
                    updateButtonStates();
                    return;
                }

                // Get values from form (using the potentially pre-filled values)
                const goalCalories = parseInt(goalCaloriesInput.value);
                const proteinPerc = parseInt(proteinPercentageInput.value);
                const carbPerc = parseInt(carbPercentageInput.value);
                const fatPerc = parseInt(fatPercentageInput.value);

                // Validate inputs
                if (isNaN(goalCalories) || goalCalories <= 0) {
                    displayError(macroResultDiv, 'Por favor, introduce un objetivo calórico válido.');
                    displayError(step5TableContainer, '<em>Error: Necesitas un objetivo calórico válido para generar la tabla de ciclos automática.</em>');
                    calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0 }; // Reset macros
                    resetStep4onwards(); // Reset subsequent steps
                    resetStep5Table(); // Reset Step 5 table
                    updateButtonStates();
                    return;
                }
                if (isNaN(proteinPerc) || isNaN(carbPerc) || isNaN(fatPerc) || proteinPerc < 0 || carbPerc < 0 || fatPerc < 0) {
                    displayError(macroResultDiv, 'Por favor, introduce porcentajes válidos para los macronutrientes.');
                    displayError(step5TableContainer, '<em>Error: Necesitas porcentajes de macros válidos para generar la tabla de ciclos automática.</em>');
                    calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0 }; // Reset macros
                    resetStep4onwards(); // Reset subsequent steps
                    resetStep5Table(); // Reset Step 5 table
                    updateButtonStates();
                    return;
                }

                const totalPercentage = proteinPerc + carbPerc + fatPerc;
                adjustMacroPercentages(); // Update total display

                if (totalPercentage !== 100) {
                    displayError(macroResultDiv, `La suma de los porcentajes debe ser 100%. Actualmente es ${totalPercentage}%.`);
                    displayError(step5TableContainer, '<em>Error: La suma de porcentajes de macros debe ser 100% para generar la tabla de ciclos automática.</em>');
                    calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0 }; // Reset macros
                    resetStep4onwards(); // Reset subsequent steps
                    resetStep5Table(); // Reset Step 5 table
                    updateButtonStates();
                    return;
                }

                // Calculate grams
                const proteinGrams = (goalCalories * (proteinPerc / 100)) / 4;
                const carbGrams = (goalCalories * (carbPerc / 100)) / 4;
                const fatGrams = (goalCalories * (fatPerc / 100)) / 9;

                // Store calculated macros globally
                calculatedMacros = { proteinGrams, carbGrams, fatGrams, goalCalories };

                // Display macro results
                macroResultDiv.innerHTML = `<h3>Distribución de Macronutrientes:</h3><p>Para un objetivo de <strong>${goalCalories} kcal/día</strong>:</p><ul><li><strong>Proteínas:</strong> ${proteinGrams.toFixed(1)} g (${proteinPerc}%)</li><li><strong>Carbohidratos:</strong> ${carbGrams.toFixed(1)} g (${carbPerc}%)</li><li><strong>Grasas:</strong> ${fatGrams.toFixed(1)} g (${fatPerc}%)</li></ul>`;

                // Generate and display macro chart
                if (chartContainer) {
                    chartContainer.style.display = 'block';
                    chartContainer.innerHTML = '<canvas id="macroChart"></canvas>'; // Ensure canvas exists
                    const ctx = document.getElementById('macroChart')?.getContext('2d');
                    if (ctx) {
						macroChartInstance = new Chart(ctx, {
							type: 'doughnut',
							data: {
								labels: ['Proteínas (g)', 'Carbohidratos (g)', 'Grasas (g)'],
								datasets: [{
									label: 'Gramos por Macronutriente',
									data: [proteinGrams.toFixed(1), carbGrams.toFixed(1), fatGrams.toFixed(1)],
									backgroundColor: [
										'rgba(46, 125, 50, 0.7)', // #2e7d32 (verde bosque oscuro para proteínas)
										'rgba(52, 199, 89, 0.7)', // #34c759 (verde manzana para carbohidratos)
										'rgba(32, 201, 151, 0.7)' // #20c997 (verde teal para grasas)
									],
									borderColor: [
										'rgba(46, 125, 50, 1)', // #2e7d32
										'rgba(52, 199, 89, 1)', // #34c759
										'rgba(32, 201, 151, 1)' // #20c997
									],
									borderWidth: 1
								}]
							},
							options: {
								responsive: true,
								maintainAspectRatio: false,
								plugins: {
									legend: { position: 'top' },
									title: {
										display: true,
										text: `Distribución de Macronutrientes (${goalCalories} kcal)`
									},
									tooltip: {
										callbacks: {
											label: function(context) {
												let label = context.label || '';
												if (label) {
													label += ': ';
												}
												if (context.parsed !== null) {
													label += context.parsed + ' g';
													const dataIndex = context.dataIndex;
													const percentages = [proteinPerc, carbPerc, fatPerc];
													if (dataIndex < percentages.length) {
														label += ` (${percentages[dataIndex]}%)`;
													}
												}
												return label;
											}
										}
									}
								}
							}
						});
					} else {
						console.error("Failed to get canvas context for macroChart");
					}
                }

                // --- Generate Detailed Cycle Table (Step 5 - Auto) ---
                if (goalTypeGlobal !== 'maintenance' && estimatedWeeksGlobal > 0 && currentWeightKg && targetWeightKgGlobal && calculatedTDEE) {
                    generateDetailedCycleTable(estimatedWeeksGlobal, currentWeightKg, targetWeightKgGlobal, calculatedTDEE, calculatedMacros.goalCalories, calculatedMacros, goalTypeGlobal, targetWeeklyRateKgGlobal);
                } else if (goalTypeGlobal === 'maintenance') {
                    displayInfo(step5TableContainer, '<em>No se requiere tabla de ciclos automática para un objetivo de mantenimiento.</em>');
                } else {
                    displayError(step5TableContainer, '<em>Faltan datos de Pasos 1 o 2 para generar la tabla de ciclos automática.</em>');
                    console.error("Missing data for detailed (auto) cycle table generation:", { estimatedWeeksGlobal, currentWeightKg, targetWeightKgGlobal, calculatedTDEE, goalTypeGlobal });
                }

                // Reset subsequent steps as Step 3 results changed
                resetStep4onwards();
                updateButtonStates(); // Enable next step button
            }

            // Helper function to adjust and display macro percentages total
            function adjustMacroPercentages() {
                if (!macroPercentageTotalDiv || !proteinPercentageInput || !carbPercentageInput || !fatPercentageInput) return; // Check if elements exist
                const p = parseInt(proteinPercentageInput.value) || 0;
                const c = parseInt(carbPercentageInput.value) || 0;
                const f = parseInt(fatPercentageInput.value) || 0;
                const total = p + c + f;
                macroPercentageTotalDiv.textContent = `Total: ${total}%`;
                macroPercentageTotalDiv.style.color = total === 100 ? '#388E3C' : '#c62828';
            }

            // --- Step 5: Generate Meal Plan ---
            function generateMealPlan() {
                clearContainer(mealResultDiv);

                // Check prerequisite
                if (calculatedMacros.goalCalories === 0) {
                    displayError(mealResultDiv, 'Por favor, calcula primero tus macronutrientes en el Paso 3.');
                    updateButtonStates();
                    return;
                }

                // Get percentages from form
                const mealPercentages = {
                    breakfast: parseInt(mealForm.elements['breakfast-perc'].value) || 0,
                    snack1: parseInt(mealForm.elements['snack1-perc'].value) || 0,
                    lunch: parseInt(mealForm.elements['lunch-perc'].value) || 0,
                    snack2: parseInt(mealForm.elements['snack2-perc'].value) || 0,
                    dinner: parseInt(mealForm.elements['dinner-perc'].value) || 0
                };
                const totalMealPerc = Object.values(mealPercentages).reduce((sum, perc) => sum + perc, 0);

                adjustMealPercentages(); // Update total display

                if (totalMealPerc !== 100) {
                    displayError(mealResultDiv, `La suma de los porcentajes de comida debe ser 100%. Actualmente es ${totalMealPerc}%.`);
                    return;
                }

                const { proteinGrams, carbGrams, fatGrams, goalCalories } = calculatedMacros;
                let mealPlanHTML = `<h3>Distribución Orientativa por Comida:</h3><p>Basado en ${goalCalories} kcal, ${proteinGrams.toFixed(1)}g Proteína, ${carbGrams.toFixed(1)}g Carbs, ${fatGrams.toFixed(1)}g Grasa.</p>`;

                // Calculate and display macros per meal
                for (const [mealName, percentage] of Object.entries(mealPercentages)) {
                    if (percentage > 0) {
                        const mealCalories = goalCalories * (percentage / 100);
                        const mealProtein = proteinGrams * (percentage / 100);
                        const mealCarbs = carbGrams * (percentage / 100);
                        const mealFat = fatGrams * (percentage / 100);
                        const displayName = mealName.charAt(0).toUpperCase() + mealName.slice(1).replace('snack1', 'Media Mañana').replace('snack2', 'Merienda');

                        mealPlanHTML += `
                            <div class="plan-step" style="margin-bottom: 15px; padding: 15px; background-color: #f5fbf5 !important; border: 1px solid #d4eed5;">
                                <h4>${displayName} (${percentage}%)</h4>
                                <ul>
                                    <li><strong>Calorías:</strong> ~${mealCalories.toFixed(0)} kcal</li>
                                    <li><strong>Proteínas:</strong> ~${mealProtein.toFixed(1)} g</li>
                                    <li><strong>Carbohidratos:</strong> ~${mealCarbs.toFixed(1)} g</li>
                                    <li><strong>Grasas:</strong> ~${mealFat.toFixed(1)} g</li>
                                </ul>
                            </div>`;
                    }
                }
                mealPlanHTML += `<p style="margin-top: 15px; font-style: italic;">Nota: Esta es una distribución matemática. Los alimentos específicos determinarán los macros exactos de cada comida. Consulta a un profesional para crear un plan de comidas detallado.</p>`;
                mealResultDiv.innerHTML = mealPlanHTML;
                updateButtonStates(); // No state changes expected here, but good practice
            }

            // Helper function to adjust and display meal percentages total
            function adjustMealPercentages() {
                 if (!mealPercentageTotalDiv) return;
                 const percentages = [
                    parseInt(mealForm.elements['breakfast-perc'].value) || 0,
                    parseInt(mealForm.elements['snack1-perc'].value) || 0,
                    parseInt(mealForm.elements['lunch-perc'].value) || 0,
                    parseInt(mealForm.elements['snack2-perc'].value) || 0,
                    parseInt(mealForm.elements['dinner-perc'].value) || 0
                 ];
                 const total = percentages.reduce((sum, perc) => sum + perc, 0);
                 mealPercentageTotalDiv.textContent = `Total: ${total}%`;
                 mealPercentageTotalDiv.style.color = total === 100 ? '#388E3C' : '#c62828';
            }


            // --- Step 7 Helper Function to Generate Detailed Cycle Table (Auto) ---
            function generateDetailedCycleTable(totalWeeks, startWeight, endWeight, initialTDEE, phaseCalories, phaseMacros, goalType, weeklyRateKg) {
			const step6TableContainer = document.getElementById('detailed-cycle-table-container');
			clearContainer(step6TableContainer);

			if (goalType === 'maintenance' || totalWeeks <= 0) {
				displayInfo(step6TableContainer, '<em>No se requiere tabla de ciclos para un objetivo de mantenimiento o duración cero.</em>');
				return;
			}
			if (!initialTDEE || !phaseCalories || !phaseMacros || !phaseMacros.proteinGrams || weeklyRateKg === undefined || !userAge || !userHeightCm) {
				displayError(step6TableContainer, '<em>Faltan datos necesarios (TDEE, Calorías/Macros Objetivo, Ritmo Semanal, Datos Usuario) para generar la tabla de ciclos. Asegúrate de completar los pasos 1, 2 y 3.</em>');
				console.error("Missing data for detailed table:", {initialTDEE, phaseCalories, phaseMacros, weeklyRateKg, userAge, userHeightCm});
				return;
			}

			const phaseWeeksPerCycle = 6;
			const breakWeeksPerCycle = 1;
			const cycleDuration = phaseWeeksPerCycle + breakWeeksPerCycle;
			const numFullCycles = Math.floor(totalWeeks / cycleDuration);
			const remainingPhaseWeeks = totalWeeks % cycleDuration;

			const activityMultipliers = userGender === 'male' ? [1.2, 1.56, 1.78, 2.1, 2.3] : [1.2, 1.55, 1.64, 1.82, 2];

			const macroForm = document.getElementById('macro-form');
			const proteinPerc = parseInt(macroForm.elements['protein-percentage'].value);
			const carbPerc = parseInt(macroForm.elements['carb-percentage'].value);
			const fatPerc = parseInt(macroForm.elements['fat-percentage'].value);

			let tableHTML = `
				<table id="detailed-cycle-table">
					<thead>
						<tr>
							<th>Ciclo</th>
							<th>Fase</th>
							<th>Semnanas</th>
							<th>Peso(kg) <br>(Inicio→Fin)</th>
							<th>Calorias/día/AF</th>
							<th>Proteína(g)</th>
							<th>Carbs(g)</th>
							<th>Grasas(g)</th>
						</tr>
					</thead>
					<tbody>`;

			let currentWeek = 0;
			let currentCycleWeight = startWeight;
			const phaseLabel = goalType === 'loss' ? 'Déficit' : 'Superávit';
			const phaseClass = goalType === 'loss' ? 'phase-deficit' : 'phase-surplus';
			const weeklyWeightChange = goalType === 'loss' ? -Math.abs(weeklyRateKg) : Math.abs(weeklyRateKg);

			for (let i = 1; i <= numFullCycles; i++) {
				let weightAtEndOfPhase = currentCycleWeight + (phaseWeeksPerCycle * weeklyWeightChange);
				weightAtEndOfPhase = (goalType === 'loss') ? Math.max(weightAtEndOfPhase, endWeight) : Math.min(weightAtEndOfPhase, endWeight);

				let bmr;
				if (userGender === 'male') {
					bmr = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) + 5;
				} else {
					bmr = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) - 161;
				}

				const tdeeAF = activityMultipliers.map(multiplier => bmr * multiplier * 1.1);
				const caloriesAF = tdeeAF.map(tdee => {
					if (goalType === 'loss') return Math.round(tdee * 0.90);
					else if (goalType === 'gain') return Math.round(tdee * 1.1);
					else return Math.round(tdee);
				});

				const macrosAF = caloriesAF.map(cal => {
					const proteinGrams = (cal * (proteinPerc / 100)) / 4;
					const carbGrams = (cal * (carbPerc / 100)) / 4;
					const fatGrams = (cal * (fatPerc / 100)) / 9;
					return { proteinGrams, carbGrams, fatGrams };
				});

				// Formatear calorías y macros como lista vertical
				const caloriesStr = caloriesAF.map((cal, index) => `${index}: ${cal} kcal`).join('<br>');
				const proteinStr = macrosAF.map((macro, index) => `${index}: ${macro.proteinGrams.toFixed(0)} g`).join('<br>');
				const carbsStr = macrosAF.map((macro, index) => `${index}: ${macro.carbGrams.toFixed(0)} g`).join('<br>');
				const fatsStr = macrosAF.map((macro, index) => `${index}: ${macro.fatGrams.toFixed(0)} g`).join('<br>');

				tableHTML += `<tr class="${phaseClass}">
					<td>${i}</td>
					<td>${phaseLabel}</td>
					<td>${phaseWeeksPerCycle}</td>
					<td>${currentCycleWeight.toFixed(1)} → ${weightAtEndOfPhase.toFixed(1)}</td>
					<td>${caloriesStr}</td>
					<td>${proteinStr}</td>
					<td>${carbsStr}</td>
					<td>${fatsStr}</td>
				</tr>`;

				currentCycleWeight = weightAtEndOfPhase;
				currentWeek += phaseWeeksPerCycle;

				if ((goalType === 'loss' && currentCycleWeight <= endWeight) || (goalType === 'gain' && currentCycleWeight >= endWeight)) break;

				let breakBMR;
				if (userGender === 'male') {
					breakBMR = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) + 5;
				} else {
					breakBMR = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) - 161;
				}

				const breakTDEEAF = activityMultipliers.map(multiplier => breakBMR * multiplier * 1.1);
				//const breakCaloriesAF = breakTDEEAF.map(tdee => Math.round(tdee));
				const breakCaloriesAF = breakTDEEAF.map(tdee => {
					if (goalType === 'loss') return Math.round(tdee * 0.95);
					else if (goalType === 'gain') return Math.round(tdee * 1.1);
					else return Math.round(tdee);
				});
				const breakMacrosAF = breakCaloriesAF.map(cal => {
					const proteinGrams = (cal * (proteinPerc / 100)) / 4;
					const carbGrams = (cal * (carbPerc / 100)) / 4;
					const fatGrams = (cal * (fatPerc / 100)) / 9;
					return { proteinGrams, carbGrams, fatGrams };
				});

				// Formatear calorías y macros de break como lista vertical
				const breakCaloriesStr = breakCaloriesAF.map((cal, index) => `${index}: ${cal} kcal`).join('<br>');
				const breakProteinStr = breakMacrosAF.map((macro, index) => `${index}: ${macro.proteinGrams.toFixed(0)} g`).join('<br>');
				const breakCarbsStr = breakMacrosAF.map((macro, index) => `${index}: ${macro.carbGrams.toFixed(0)} g`).join('<br>');
				const breakFatsStr = breakMacrosAF.map((macro, index) => `${index}: ${macro.fatGrams.toFixed(0)} g`).join('<br>');

				tableHTML += `<tr class="phase-break">
					<td>${i}</td>
					<td>Break (Mantenimiento)</td>
					<td>${breakWeeksPerCycle}</td>
					<td>~ ${currentCycleWeight.toFixed(1)}</td>
					<td>${breakCaloriesStr}</td>
					<td>${breakProteinStr}</td>
					<td>${breakCarbsStr}</td>
					<td>${breakFatsStr}</td>
				</tr>`;

				currentWeek += breakWeeksPerCycle;

				if ((goalType === 'loss' && currentCycleWeight <= endWeight) || (goalType === 'gain' && currentCycleWeight >= endWeight)) break;
			}

			if (remainingPhaseWeeks > 0 && ((goalType === 'loss' && currentCycleWeight > endWeight) || (goalType === 'gain' && currentCycleWeight < endWeight))) {
				let weightAtEndFinal = currentCycleWeight + (remainingPhaseWeeks * weeklyWeightChange);
				weightAtEndFinal = (goalType === 'loss') ? Math.max(weightAtEndFinal, endWeight) : Math.min(weightAtEndFinal, endWeight);

				let bmrFinal;
				if (userGender === 'male') {
					bmrFinal = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) + 5;
				} else {
					bmrFinal = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) - 161;
				}

				const tdeeAFFinal = activityMultipliers.map(multiplier => bmrFinal * multiplier* 1.1);
				const caloriesAFFinal = tdeeAFFinal.map(tdee => {
					if (goalType === 'loss') return Math.round(tdee * 0.90);
					else if (goalType === 'gain') return Math.round(tdee * 1.1);
					else return Math.round(tdee);
				});

				const macrosAFFinal = caloriesAFFinal.map(cal => {
					const proteinGrams = (cal * (proteinPerc / 100)) / 4;
					const carbGrams = (cal * (carbPerc / 100)) / 4;
					const fatGrams = (cal * (fatPerc / 100)) / 9;
					return { proteinGrams, carbGrams, fatGrams };
				});

				// Formatear calorías y macros finales como lista vertical
				const caloriesStrFinal = caloriesAFFinal.map((cal, index) => `${index}: ${cal} kcal`).join('<br>');
				const proteinStrFinal = macrosAFFinal.map((macro, index) => `${index}: ${macro.proteinGrams.toFixed(0)} g`).join('<br>');
				const carbsStrFinal = macrosAFFinal.map((macro, index) => `${index}: ${macro.carbGrams.toFixed(0)} g`).join('<br>');
				const fatsStrFinal = macrosAFFinal.map((macro, index) => `${index}: ${macro.fatGrams.toFixed(0)} g`).join('<br>');

				tableHTML += `<tr class="${phaseClass}">
					<td>${numFullCycles + 1}</td>
					<td>${phaseLabel} (Final)</td>
					<td>${remainingPhaseWeeks}</td>
					<td>${currentCycleWeight.toFixed(1)} → ${weightAtEndFinal.toFixed(1)}</td>
					<td>${caloriesStrFinal}</td>
					<td>${proteinStrFinal}</td>
					<td>${carbsStrFinal}</td>
					<td>${fatsStrFinal}</td>
				</tr>`;
			}

			tableHTML += `</tbody></table>`;
			tableHTML += `<p style="font-size: 0.9em; font-style: italic; margin-top: 10px;">Nota: Esta tabla es una simulación basada en los cálculos automáticos de los Pasos 1-3. Las calorías y macros se ajustan según el nivel de actividad física (AF: 0=Sedentario, 1=Leve, 2=Moderado, 3=Intenso). El progreso real puede variar. Ajusta según sea necesario y consulta a un profesional.</p>`;

			step6TableContainer.innerHTML = tableHTML;
		}

		document.addEventListener('DOMContentLoaded', function() {
		calculateGoalButton.addEventListener('click', function(event) {
			event.preventDefault(); // Prevent form submission
			calculateWeightGoal();
		});
	});
           
/////////////////// --- Step 3: Estimate Time (Manual Calculation) ---////////////////////////////////////
function estimateTimeManually() {
    clearContainer(timeEstimationResultDiv);
    if (timeChartContainer) timeChartContainer.style.display = 'none';
    resetStep7();

    if (timeEstimationChartInstance) {
        timeEstimationChartInstance.destroy();
        timeEstimationChartInstance = null;
    }

    // Reset global variables
    estimatedWeeksManualGlobal = null;
    weightChangeGoalManualGlobal = null;
    weeklyCalorieDiffManualGlobal = null;

    // Check prerequisite
    if (!currentWeightKg) {
        displayError(timeEstimationResultDiv, 'Error: Completa el Paso 1 antes de realizar esta estimación.');
        updateButtonStates();
        return;
    }

    // Get values from form
    const weightChangeGoal = parseFloat(timeEstimationForm.elements['weight-change-goal'].value);
    const weeklyCalorieDiff = parseInt(timeEstimationForm.elements['weekly-calorie-diff'].value);

    console.log("Step 6 Inputs - weightChangeGoal:", weightChangeGoal, "weeklyCalorieDiff:", weeklyCalorieDiff, "currentWeightKg:", currentWeightKg);

    // Validate inputs
    if (isNaN(weightChangeGoal)) {
        displayError(timeEstimationResultDiv, 'Por favor, introduce un cambio de peso deseado válido.');
        updateButtonStates();
        return;
    }
    if (isNaN(weeklyCalorieDiff) || weeklyCalorieDiff === 0) {
        displayError(timeEstimationResultDiv, 'Por favor, introduce una diferencia calórica semanal válida y distinta de cero.');
        updateButtonStates();
        return;
    }
    if ((weightChangeGoal > 0 && weeklyCalorieDiff < 0) || (weightChangeGoal < 0 && weeklyCalorieDiff > 0)) {
        displayError(timeEstimationResultDiv, 'El signo del cambio de peso debe coincidir con el signo de la diferencia calórica.');
        updateButtonStates();
        return;
    }
	
    // === 🔢 CÁLCULO LINEAL (teórico) ===
    const kcalPerKg = 7700;
    const totalKcalChangeNeeded = Math.abs(weightChangeGoal) * kcalPerKg;
    const dailyAdjustmentAbs = Math.abs(weeklyCalorieDiff) / 7;
    let estimatedWeeksLinear = 0;

    if (dailyAdjustmentAbs > 0) {
        const daysNeeded = totalKcalChangeNeeded / dailyAdjustmentAbs;
        estimatedWeeksLinear = Math.ceil(daysNeeded / 7);
    }

    if (weightChangeGoal === 0) {
        estimatedWeeksLinear = 0;
    }
	const currentFatPerc = parseFloat(weightGoalForm.elements['current-fat-percentage'].value);
	const isAthlete = weightGoalForm.elements['is-athlete'].value === 'yes';
	console.log("currentFatPerc:", currentFatPerc);
	console.log("Tipo:", typeof currentFatPerc);
	console.log("¿Es NaN?", isNaN(currentFatPerc));
    // === 🔬 CÁLCULO NO LINEAL (realista) - MEPNL v2.1 ===
		function calcularTiempoNoLineal(weightChangeGoal, weeklyCalorieDiff, currentWeightKg, userData) {
			const { userGender, userAge, currentFatPerc, isAthlete, activityLevel } = userData;
			const esHombre = userGender === 'male';
			const esPerdida = weightChangeGoal < 0;
			const metaAbs = Math.abs(weightChangeGoal);
			const kcalPerKg = 7700;

			// --- 1. Estimar TDEE y NEAT (simplificado) ---
			const AF_FACTORS = {
				'sedentario': 1.2,
				'leve': 1.4,
				'moderate': 1.6,
				'active': 1.75,
				'very-active': 1.9
			};
			const afFactor = AF_FACTORS[activityLevel] || 1.4;

			// BMR (Mifflin-St Jeor - asumiendo altura promedio si no está disponible)
			const alturaEstimada = esHombre ? 175 : 162; // cm
			const bmr = esHombre 
				? (10 * currentWeightKg) + (6.25 * alturaEstimada) - (5 * userAge) + 5
				: (10 * currentWeightKg) + (6.25 * alturaEstimada) - (5 * userAge) - 161;

			const neatExtra = isAthlete ? 500 : (afFactor >= 1.6 ? 300 : 150);
			const tdee = bmr * afFactor + neatExtra;
			const weeklyEnergyExpenditure = tdee * 7;

			// --- 2. Ajustes personalizados ---
			const esDeportista = isAthlete;
			const porcentajeGrasa = currentFatPerc;

			// Factor de adherencia (puedes hacerlo configurable)
			const adherencia = 0.8;

			// Factor de corrección por tipo de tejido
			const fc = esPerdida 
				? 1.0 
				: (goalTypeGlobal === 'ganancia1' ? 1.25 : 0.85); // 1.25 para ganancia muscular, 0.85 para mixto

			// Caloría efectiva semanal (ajustada por adherencia)
			const weeklyCalorieDiffEffective = adherencia * weeklyCalorieDiff;

			// Tasa inicial (kg/semana)
			const r0 = Math.abs(weeklyCalorieDiffEffective) / (kcalPerKg * fc);

			// --- 3. Parámetros personalizados por usuario ---
			let k, alpha, beta;

			if (esPerdida) {
				// Pérdida: adaptación metabólica
				// === Pérdida ===
				// Para personas con >25% grasa (respuesta más estable)
				alpha = Math.max(0.5, 0.4 * (1 - 0.01 * porcentajeGrasa)); // → ~0.5 para 28%
				k = 0.02; // Ralentización más lenta
			} else {
				// Ganancia: progresión decreciente
				beta = Math.max(0.3, 0.4 * (1 - 0.004 * userAge + (esDeportista ? 0.1 : 0)));
				k = 0.06 * (1 + (userData.isAdvanced ? 0.4 : 0) - (esDeportista ? 0.2 : 0));
			}

			// --- 4. Simular semana a semana ---
			const semanas = [];
			let pesoAcumulado = 0;
			let semana = 0;
			let currentTDEE = tdee; // Para simular adaptación del TDEE

			while (pesoAcumulado < metaAbs && semana < 100) {
				semana++;

				// Ajuste del TDEE por pérdida de peso (adaptación metabólica)
				if (esPerdida && semana > 4) {
					const pesoPerdidoHastaAhora = (pesoAcumulado / metaAbs) * Math.abs(weightChangeGoal);
					currentTDEE = tdee * (1 - 0.15 * (pesoPerdidoHastaAhora / currentWeightKg));
				}

				// Tasa semanal con decaimiento
				let factorProgresion;
				if (esPerdida) {
					factorProgresion = Math.max(alpha, 1 - k * (semana - 1));
				} else {
					factorProgresion = Math.max(beta || 0.4, 1 - k * (semana - 1));
				}

				let tasaSemanal = r0 * factorProgresion;

				// Ajuste adicional para deportistas en ganancia
				if (!esPerdida && esDeportista) {
					tasaSemanal *= 1.15;
				}

				pesoAcumulado += tasaSemanal;
				semanas.push({
					numero: semana,
					pesoAcumulado: parseFloat(pesoAcumulado.toFixed(2)),
					tasa: parseFloat(tasaSemanal.toFixed(2)),
					tdee: parseFloat(currentTDEE.toFixed(0))
				});
			}

			return {
				semanas,
				totalSemanas: semana,
				metaAlcanzada: pesoAcumulado >= metaAbs,
				tasaInicial: r0,
				finalTDEE: currentTDEE
			};
		}

			// === ✅ DATOS DEL USUARIO (userData) ===
			const userData = {
				userGender,
				userAge,
				currentFatPerc,
				isAthlete: document.getElementById('is-athlete')?.value === 'yes',
				activityLevel: document.getElementById('nivel-actividad')?.value?.toLowerCase(),
				isAdvanced: document.getElementById('is-athlete')?.value === 'yes' // ejemplo simple
			};

			// === 🔗 LLAMADA A LA FUNCIÓN NO LINEAL ===
			const noLineal = calcularTiempoNoLineal(weightChangeGoal, weeklyCalorieDiff, currentWeightKg, userData);
			const estimatedWeeksRealistic = noLineal.totalSemanas;
			
			// === 📊 DEBUG: Mostrar evolución semanal en consola ===
			console.log("%c📊 MEPNL v2.1 - Evolución No Lineal", "font-weight: bold; color: #1976d2; font-size: 16px;");
			console.log("🎯 Objetivo:", weightChangeGoal > 0 ? "Ganancia" : "Pérdida", Math.abs(weightChangeGoal), "kg");
			console.log("👤 Usuario:", userGender, "| Edad:", userAge, "| % Grasa:", currentFatPerc, "| Deportista:", isAthlete ? "Sí" : "No");
			console.log("⚡ Diferencia calórica semanal:", weeklyCalorieDiff, "kcal");
			console.log("📅 Semanas estimadas (realista):", estimatedWeeksRealistic);
			console.log("📉 Tasa inicial estimada:", noLineal.tasaInicial.toFixed(3), "kg/semana");

			// Crear tabla con datos semanales
			const tableData = noLineal.semanas.map(semana => ({
				Semana: semana.numero,
				"Peso Acumulado (kg)": semana.pesoAcumulado,
				"Tasa Semanal (kg)": semana.tasa,
				"TDEE Estimado (kcal/día)": semana.tdee,
			}));

			console.table(tableData);

			// === 📈 Estadísticas finales ===
			console.log("%c📈 Resultados Finales", "font-weight: bold; color: #d84315; font-size: 14px;");
			console.log("✅ Meta alcanzada:", noLineal.metaAlcanzada ? "Sí" : "No");
			console.log("⏱️  Duración:", estimatedWeeksRealistic, "semanas (~" + (estimatedWeeksRealistic / 4.3).toFixed(1) + " meses)");
			console.log("💡 Consejo: Usa esta tabla para ajustar parámetros como 'k', 'alpha', 'beta' o 'adherencia' si el modelo no coincide con casos reales.");

			// === ✅ Almacenar resultados globales con el valor realista como principal ===
			if (isFinite(estimatedWeeksLinear)) {
				estimatedWeeksManualGlobal = estimatedWeeksRealistic;
				weightChangeGoalManualGlobal = weightChangeGoal;
				weeklyCalorieDiffManualGlobal = weeklyCalorieDiff;
			} else {
				estimatedWeeksManualGlobal = null;
				weightChangeGoalManualGlobal = null;
				weeklyCalorieDiffManualGlobal = null;
			}
			

    // === 📊 GENERAR RESULTADOS EDUCATIVOS ===
    let resultHTML = `<h3>Estimación de Tiempo (Manual):</h3>`;
    resultHTML += `<p>Para un cambio de peso de <strong>${weightChangeGoal} kg</strong> con una diferencia calórica semanal de <strong>${weeklyCalorieDiff} kcal</strong>:</p>`;

    if (isFinite(estimatedWeeksLinear) && estimatedWeeksLinear > 0) {
        const esPerdida = weightChangeGoal < 0;
        const rateLinear = Math.abs(weightChangeGoal) / estimatedWeeksLinear;

        // --- Estimación Lineal (teórica) ---
        resultHTML += `
            <div style="margin: 15px 0; padding: 12px; border: 1px solid #bbdefb; border-radius: 6px; background: #e3f2fd;">
                <strong>📊 Estimación Lineal (teórica):</strong>
                <p>Tiempo estimado: <strong>${estimatedWeeksLinear} semanas</strong> (~${(estimatedWeeksLinear / 4.3).toFixed(1)} meses)</p>
                <p><small>Esta estimación asume una pérdida o ganancia <strong>constante de ~${rateLinear.toFixed(2)} kg/semana</strong>, como si tu cuerpo respondiera igual cada semana.</small></p>
                <p><em> Es un cálculo matemático simple, pero <strong>no refleja cómo funciona tu fisiología en la realidad</strong>.</em></p>
            </div>
        `;

				// --- Estimación No Lineal (realista) - CON FEEDBACK AVANZADO ---
					resultHTML += `
						<div style="margin: 15px 0; padding: 12px; border: 1px solid #ffcc80; border-radius: 6px; background: #fff3e0;">
							<strong>🧠 Estimación No Lineal (realista):</strong>
							<p>Tiempo estimado: <strong>${estimatedWeeksRealistic} semanas</strong> (~${(estimatedWeeksRealistic / 4.3).toFixed(1)} meses)</p>
					`;

					// === 🔍 Variables para personalización ===
					//const esPerdida = weightChangeGoal < 0;
					const porcentajeGrasa = currentFatPerc;
					const edad = userAge;
					const esHombre = userGender === 'male';
					const esDeportista = document.getElementById('is-athlete')?.value === 'yes';
					const nivelActividad = document.getElementById('nivel-actividad')?.value?.toLowerCase();
					const esSedentario = !esDeportista && ['sedentario', 'leve'].includes(nivelActividad);
					const ritmoPromedio = Math.abs(weightChangeGoal) / estimatedWeeksRealistic;

					if (esPerdida) {
						// --- 🔽 PÉRDIDA DE PESO: Feedback hiperpersonalizado ---
						resultHTML += `<p><small>Esta estimación considera cómo <strong>tu cuerpo responde al déficit calórico</strong>, basado en tu perfil único:</small></p>
						<ul style="font-size: 0.95em; margin: 10px 0; padding-left: 20px;">`;

						// 1. SEXO: Diferencias fisiológicas clave
						if (esHombre) {
							resultHTML += `
								<li><strong>Perfil masculino:</strong> 
									Tienes mayor masa magra y testosterona, lo que favorece una pérdida más eficiente al inicio.
									<em> Pero también mayor tendencia a acumular grasa visceral, que se pierde rápido al principio.</em>
								</li>`;
						} else {
							resultHTML += `
								<li><strong>Perfil femenino:</strong> 
									Tu cuerpo prioriza la conservación energética, especialmente con grasa baja. 
									Las hormonas como el estrógeno ralentizan la pérdida por debajo del 25%.
									<em> Es normal que el progreso se detenga en ciertos puntos del ciclo menstrual.</em>
								</li>`;
						}

						// 2. NIVEL DE ACTIVIDAD: Sedentario vs Deportista
						if (esDeportista) {
							resultHTML += `
								<li><strong>Deportista activo:</strong> 
									Tu NEAT y gasto energético son altos, lo que acelera la pérdida al inicio.
									<em> Pero con el tiempo, tu cuerpo se adapta más rápido (efecto de entrenamiento).</em>
								</li>`;
						} else if (esSedentario) {
							resultHTML += `
								<li><strong>Sedentario o baja actividad:</strong> 
									Tu cuerpo tiene menos gasto energético y se adapta más rápido al déficit.
									<em> Pequeñas mejoras en movimiento diario (caminar, moverte) pueden acelerar tu progreso.</em>
								</li>`;
						}

						// 3. % GRASA: Nivel de dificultad
						if (porcentajeGrasa < 18 && esHombre) {
							resultHTML += `
								<li><strong>Definición extrema (<18% H):</strong> 
									Cada % de grasa por debajo del 15% es extremadamente difícil de perder.
									<em> El cuerpo activa mecanismos de supervivencia: baja testosterona, caída del T3.</em>
								</li>`;
						} else if (porcentajeGrasa < 25 && !esHombre) {
							resultHTML += `
								<li><strong>Definición femenina (<25% M):</strong> 
									El cuerpo defiende el tejido adiposo por razones hormonales y reproductivas.
									<em> La pérdida se vuelve muy lenta: ~0.1–0.2 kg/semana es normal.</em>
								</li>`;
						} else if (porcentajeGrasa >= 30) {
							resultHTML += `
								<li><strong>Alta grasa corporal (>30%):</strong> 
									Perderás rápido al inicio (agua, glucógeno, grasa visceral), pero el ritmo se ralentizará.
									<em> Es normal que después de perder 10–15%, el progreso parezca "estancado".</em>
								</li>`;
						}

						// 4. EDAD
						if (edad >= 45) {
							resultHTML += `
								<li><strong>Edad (${edad} años):</strong> 
									El metabolismo basal disminuye ~2–3% por década. La pérdida se vuelve más lenta.
									<em> Necesitas más proteína y entrenamiento de fuerza para preservar músculo.</em>
								</li>`;
						}

						// 5. ADAPTACIÓN METABÓLICA (siempre aplicable)
						resultHTML += `
							<li><strong>Adaptación metabólica:</strong> 
								Tu cuerpo gasta menos energía con el tiempo. Incluso si comes igual, quemas menos.
								<em> Es un mecanismo de supervivencia: el cuerpo se defiende contra la pérdida de peso.</em>
							</li>`;

						resultHTML += `</ul>`;

						// === Conclusión personalizada para pérdida ===
						if (porcentajeGrasa < 20) {
							resultHTML += `<p><em>📌 Aunque empieces perdiendo ~0.5 kg/semana, al final perderás ~${ritmoPromedio.toFixed(2)} kg/semana. Es normal y esperado.</em></p>`;
						} else {
							resultHTML += `<p><em>📌 Al principio perderás rápido, pero el progreso se ralentizará. Este ritmo es sostenible y saludable.</em></p>`;
						}

					} else {
						// --- 🔼 GANANCIA DE PESO: Feedback hiperpersonalizado ---
						resultHTML += `<p><small>Esta estimación considera cómo <strong>tu cuerpo responde al superávit calórico</strong>, basado en tu perfil:</small></p>
						<ul style="font-size: 0.95em; margin: 10px 0; padding-left: 20px;">`;

						// 1. SEXO
						if (esHombre) {
							resultHTML += `
								<li><strong>Perfil masculino:</strong> 
									Tienes mayor capacidad anabólica (testosterona, masa magra), lo que favorece la ganancia muscular.
									<em> Pero también mayor tendencia a acumular grasa si el superávit es alto o descontrolado.</em>
								</li>`;
						} else {
							resultHTML += `
								<li><strong>Perfil femenino:</strong> 
									Tu cuerpo prioriza el almacenamiento energético (grasa) por razones hormonales.
									<em> Ganarás menos músculo y más grasa que un hombre con el mismo superávit.</em>
								</li>`;
						}

						// 2. NIVEL DE ACTIVIDAD
						if (esDeportista) {
							resultHTML += `
								<li><strong>Deportista activo:</strong> 
									Tu músculo está "entrenado" para responder al superávit, pero ya no estás en fase de novato.
									<em> La hipertrofia se vuelve más lenta: ~0.1–0.3 kg músculo/mes es realista.</em>
								</li>`;
						} else if (esSedentario) {
							resultHTML += `
								<li><strong>Sedentario o principiante:</strong> 
									Si es tu primera vez entrenando, tendrás un "efecto novato" fuerte al inicio.
									<em> Ganarás rápido (agua, glucógeno), pero después el progreso se ralentizará mucho.</em>
								</li>`;
						}

						// 3. % GRASA
						if (porcentajeGrasa > 25) {
							resultHTML += `
								<li><strong>Grasa moderada/alta (>25%):</strong> 
									Tu cuerpo almacena más calorías como grasa que como músculo.
									<em> Un superávit que en un magro da músculo, en ti dará más grasa.</em>
								</li>`;
						} else if (porcentajeGrasa <= 18) {
							resultHTML += `
								<li><strong>Baja grasa corporal (<18%):</strong> 
									Estás en un rango ideal para ganancia muscular controlada.
									<em> Puedes aprovechar el superávit para hipertrofia sin acumular mucha grasa.</em>
								</li>`;
						}

						// 4. EDAD
						if (edad >= 45) {
							resultHTML += `
								<li><strong>Edad (${edad} años):</strong> 
									La anabolización muscular disminuye (anarcabolia sarcopénica).
									<em> Necesitas más proteína (1.8–2.4 g/kg) y estimulación para ganar músculo.</em>
								</li>`;
						}

						// 5. ALMACENAMIENTO GRASO
						resultHTML += `
							<li><strong>Mayor almacenamiento graso:</strong> 
								Con el tiempo, más calorías del superávit se almacenan como grasa, no como músculo.
								<em> Solo ~20–30% del peso ganado será músculo puro en fases avanzadas.</em>
							</li>`;

						resultHTML += `</ul>`;

						// === Conclusión personalizada para ganancia ===
						if (esDeportista && edad <= 35) {
							resultHTML += `<p><em>📌 No puedes ganar 0.5 kg de músculo por semana durante meses. La realidad es: rápido al inicio, muy lento después. Este ritmo es óptimo para minimizar grasa.</em></p>`;
						} else {
							resultHTML += `<p><em>📌 El progreso será más lento de lo esperado, pero sostenible. La clave es la constancia, no la velocidad.</em></p>`;
						}
					}

					resultHTML += `</div>`;

					// --- Conclusión educativa ---
					resultHTML += `
						<p style="font-style: italic; color: #555; font-size: 0.95em;">
							<strong>💡 Conclusión:</strong> 
							La composición corporal <strong>no cambia de forma lineal</strong>. 
							Esta estimación realista se usará para generar tu tabla de ciclos (Paso 7).
						</p>
					`;
    } else if (weightChangeGoal === 0) {
        resultHTML += `<p>El cambio de peso deseado es 0 kg (mantenimiento). No se requiere estimación de tiempo.</p>`;
    } else {
        resultHTML += `<p>No se pudo calcular el tiempo estimado con los valores proporcionados.</p>`;
    }

    timeEstimationResultDiv.innerHTML = resultHTML;

    // === 📈 GENERAR GRÁFICO (Linear + Non-Linear) ===
    if (isFinite(estimatedWeeksLinear) && estimatedWeeksLinear > 0 && weightChangeGoal !== 0 && timeChartContainer) {
        const startWeight = currentWeightKg;
        const endWeight = startWeight + weightChangeGoal;
        const maxWeeksToShow = 104;
        const actualWeeks = Math.min(Math.max(estimatedWeeksLinear, estimatedWeeksRealistic), maxWeeksToShow);

        // --- Generar datos para el gráfico (lineal + no lineal) ---
			const chartLabels = [];
			const linearData = [];
			const nonlinearData = [];

			let lastNonlinearWeight = startWeight; // Inicia en el peso actual

			for (let w = 0; w <= actualWeeks; w++) {
				// Etiquetas (menos frecuentes si hay muchas semanas)
				let showLabel = false;
				if (actualWeeks <= 20) showLabel = true;
				else if (actualWeeks <= 52) showLabel = (w % 2 === 0);
				else showLabel = (w % 4 === 0);
				chartLabels.push(showLabel ? `Sem ${w}` : '');

				// === Línea Lineal (teórica) ===
				const progressLinear = w / estimatedWeeksLinear;
				const projectedWeightLinear = startWeight + (weightChangeGoal * Math.min(progressLinear, 1));
				const clampedWeightLinear = (weightChangeGoal < 0)
					? Math.max(projectedWeightLinear, endWeight)
					: Math.min(projectedWeightLinear, endWeight);
				linearData.push(parseFloat(clampedWeightLinear.toFixed(1)));

				// === Línea No Lineal (realista) ===
				const weekData = noLineal.semanas.find(s => s.numero === w);
				
				if (weekData) {
					// Si hay dato para esta semana
					const weightNonlinear = startWeight + (weightChangeGoal < 0 
						? -weekData.pesoAcumulado 
						: weekData.pesoAcumulado);
					lastNonlinearWeight = weightNonlinear; // Guárdalo como número, sin toFixed
				}
				// Si no hay dato (antes de empezar o después), mantener el último valor
				// (esto evita saltos o undefined)
				nonlinearData.push(lastNonlinearWeight);
			}

			// === Asegurar que ambas líneas terminen en el peso objetivo ===
			
				if (estimatedWeeksLinear <= maxWeeksToShow) {
					linearData[actualWeeks] = Math.round(endWeight * 10) / 10;
				}
				if (estimatedWeeksRealistic <= maxWeeksToShow) {
					nonlinearData[actualWeeks] = Math.round(endWeight * 10) / 10;
				}

				console.log("🚀 Datos no lineales generados:", {
			totalSemanas: actualWeeks + 1,
			nonlinearDataLength: nonlinearData.length,
			nonlinearData: nonlinearData,
			hasUndefined: nonlinearData.some(v => v === undefined || v === null),
			startWeight: startWeight,
			endWeight: endWeight
		});

        timeChartContainer.innerHTML = '<canvas id="timeEstimationChart"></canvas>';
        const ctx = document.getElementById('timeEstimationChart')?.getContext('2d');
        if (!ctx) {
            console.error("Failed to get canvas context for timeEstimationChart");
            displayError(timeEstimationResultDiv, "Error: No se pudo renderizar el gráfico.");
            updateButtonStates();
            return;
        }

        try {
            timeEstimationChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                   datasets: [
						{
							label: 'Proyección Lineal (Teórica)',
							 data:linearData,
							borderColor: '#2E7D32', // Verde oscuro
							backgroundColor: 'rgba(46, 125, 50, 0.2)',
							fill: false,
							tension: 0.1,
							borderWidth: 3,        // Línea más gruesa
							pointRadius: 2,        // Puntos más grandes
							pointHoverRadius: 4,
							//pointBackgroundColor: '#2E7D32'
						},
						{
							label: 'Proyección No Lineal (Realista)',
							 data:nonlinearData,
							borderColor: '#F57C00',
							backgroundColor: 'rgba(245, 124, 0, 0.1)',
							fill: false,
							tension: 0.1,
							borderWidth: 3,        // ¡Más gruesa que la otra!
							borderDash: [5, 5],    // Línea punteada para diferenciar
							pointRadius: 2,
							pointHoverRadius: 4,
							//pointBackgroundColor: '#D84315'
						}
					]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top', labels: { usePointStyle: true } },
                        title: {
                            display: true,
                            text: `Comparación: Proyección Lineal vs. Realista (${startWeight.toFixed(1)} kg → ${endWeight.toFixed(1)} kg)`,
                            font: { size: 16 },
                            color: '#1B5E20'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const dataIndex = tooltipItems[0].dataIndex;
                                    let weekNum = '?';
                                    for (let i = dataIndex; i >= 0; i--) {
                                        const label = chartLabels[i];
                                        if (label && label.startsWith('Sem ')) {
                                            weekNum = label.substring(4);
                                            break;
                                        }
                                    }
                                    return `Semana ${weekNum}`;
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} kg`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Peso (kg)', color: '#1B5E20' },
                            ticks: { color: '#1B5E20', callback: value => value.toFixed(1) },
                            min: Math.min(startWeight, endWeight) - 2,
                            max: Math.max(startWeight, endWeight) + 2
                        },
                        x: {
                            title: { display: true, text: 'Semanas', color: '#1B5E20' },
                            ticks: { color: '#1B5E20', maxRotation: 0, minRotation: 0 }
                        }
                    }
                }
            });
            timeChartContainer.style.display = 'block';
            console.log("Step 6 Chart rendered with linear and non-linear projections");
        } catch (error) {
            console.error("Error rendering Step 6 chart:", error);
            displayError(timeEstimationResultDiv, "Error al renderizar el gráfico de estimación.");
        }
    } else {
        if (timeChartContainer) timeChartContainer.style.display = 'none';
    }

    updateButtonStates();
}


            // --- Step 7: Generate Hyperprotein Cycle Table (Manual) ---
            // Function definition moved outside DOMContentLoaded for onclick

            // --- PDF Generation ---
            function guardarComoPDF() {
                if (!calculatedTDEE) {
                    alert("Por favor, completa al menos el Paso 1 (Cálculo de Necesidades) antes de generar el PDF.");
                    return;
                }

                const mainElement = document.querySelector('main');
                const headerElement = document.querySelector('header');
                const footerElement = document.querySelector('footer');
                const allButtons = document.querySelectorAll('button'); // Select all buttons

                // Store original display styles
                const originalDisplays = new Map();
                const elementsToHide = [headerElement, footerElement, ...allButtons];
                elementsToHide.forEach(el => {
                    if (el) {
                        originalDisplays.set(el, el.style.display);
                        el.style.display = 'none';
                    }
                });


                // Temporarily make chart containers visible if they have content
                const chartContainers = document.querySelectorAll('#chart-container, #weight-chart-container, #time-estimation-chart-container');
                chartContainers.forEach(container => {
                    if (container) {
                        originalDisplays.set(container, container.style.display);
                        // Only make visible if it actually contains a chart canvas
                        if (container.querySelector('canvas') && container.style.display === 'none') {
                            container.style.display = 'block';
                        }
                    }
                });

                // Make tables visible if they have content
                const tableContainers = document.querySelectorAll('#detailed-cycle-table-container, #hyperprotein-cycle-table-container');
                 tableContainers.forEach(container => {
                     if (container) {
                         const table = container.querySelector('table');
                         // Check if table exists and is not already visible but has rows
                         if (table) {
                             originalDisplays.set(table, table.style.display);
                             if (table.style.display === 'none' && table.querySelector('tbody tr')) {
                                 table.style.display = 'table'; // Make visible for PDF
                             }
                         }
                     }
                 });


                const opt = {
                    margin: [15, 10, 15, 10], // top, left, bottom, left margins in mm
                    filename: 'NutriPlan_Plan_Dietetico_Personalizado.pdf',
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        // Try to capture full width/height
                        windowWidth: mainElement.scrollWidth,
                        windowHeight: mainElement.scrollHeight
                        },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'], before: '.plan-step' } // Try to avoid breaking inside steps
                };

                console.log("Generating PDF...");
                html2pdf().from(mainElement).set(opt).save().then(() => {
                    console.log("PDF generated successfully.");
                    // Restore original display styles
                    originalDisplays.forEach((display, element) => {
                        if (element) {
                            element.style.display = display;
                        }
                    });
                }).catch(err => {
                    console.error("Error generating PDF:", err);
                    alert("Hubo un error al generar el PDF. Revisa la consola del navegador (F12) para más detalles.");
                    // Restore original display styles even on error
                     originalDisplays.forEach((display, element) => {
                        if (element) {
                            element.style.display = display;
                        }
                    });
                });
            }

            // --- Reset Functions ---
            /** Resets Step 2 results and dependent steps */
            function resetStep2onwards() {
                clearContainer(weightGoalResultDiv);
                displayInfo(weightGoalResultDiv, 'Completa el Paso 1 para habilitar este cálculo.');
                if(weightChartContainer) weightChartContainer.style.display = 'none';
                if (weightEvolutionChartInstance) { weightEvolutionChartInstance.destroy(); weightEvolutionChartInstance = null; }
                targetWeightKgGlobal = null;
                goalTypeGlobal = 'maintenance';
                estimatedWeeksGlobal = 0;
                targetWeeklyRateKgGlobal = 0;
                if (goalCaloriesInput) goalCaloriesInput.value = ''; // Clear goal calories input
                // Reset macro percentages to default initial values
                if (proteinPercentageInput) proteinPercentageInput.value = 30;
                if (carbPercentageInput) carbPercentageInput.value = 40;
                if (fatPercentageInput) fatPercentageInput.value = 30;
                adjustMacroPercentages(); // Update total display
                resetStep3onwards(); // Also reset subsequent steps
            }

            /** Resets Step 3 results and dependent steps */
            function resetStep3onwards() {
                clearContainer(macroResultDiv);
                displayInfo(macroResultDiv, 'Completa los Pasos 1 y 2 para habilitar este cálculo.');
                if(chartContainer) chartContainer.style.display = 'none'; // Hide macro chart
                if (macroChartInstance) { macroChartInstance.destroy(); macroChartInstance = null; }
                calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0 };
                resetStep4onwards(); // Also reset subsequent steps
                resetStep5Table(); // Reset Step 5 table
            }

            /** Resets Step 4 results */
            function resetStep4onwards() {
                clearContainer(mealResultDiv);
                displayInfo(mealResultDiv, 'Completa el Paso 3 para habilitar este cálculo.');
            }

             /** Resets Step 5 (Auto Table) results */
            function resetStep5Table() {
                clearContainer(step5TableContainer);
                displayInfo(step5TableContainer, '<em>Completa los Pasos 1, 2 y 3 para generar esta tabla automática.</em>');
            }

            /** Resets Step 6 (Manual Estimation) results */
            function resetStep6() {
                clearContainer(timeEstimationResultDiv);
                displayInfo(timeEstimationResultDiv, 'Completa el Paso 1 para habilitar esta estimación.');
                if(timeChartContainer) timeChartContainer.style.display = 'none';
                if (timeEstimationChartInstance) { timeEstimationChartInstance.destroy(); timeEstimationChartInstance = null; }
                // Reset related globals
                estimatedWeeksManualGlobal = null;
                weightChangeGoalManualGlobal = null;
                weeklyCalorieDiffManualGlobal = null;
                resetStep7(); // Reset manual table as well
                updateButtonStates(); // Update button states after reset
            }

            /** Resets Step 7 (Manual Table) results */
            function resetStep7() {
                if (hyperproteinTableBody) hyperproteinTableBody.innerHTML = '';
                if (hyperproteinTable) hyperproteinTable.style.display = 'none';
                if (hyperproteinInfoMessage) hyperproteinInfoMessage.style.display = 'block';
                if (hyperproteinInfoMessage) hyperproteinInfoMessage.innerHTML = '<em>Completa el Paso 6 para generar esta tabla.</em>';
                if (hyperproteinNoteContainer) hyperproteinNoteContainer.innerHTML = ''; // Clear the note
                // Button state is handled by updateButtonStates called in resetStep6
            }


            // --- Event Listeners Setup ---
            if (calorieForm) {
                calorieForm.addEventListener('submit', (event) => {
                    event.preventDefault(); // Prevent default form submission
                    calculateCalories();
                });
            }
             if (weightGoalForm) {
                weightGoalForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    calculateWeightGoal();
                });
            }
             if (macroForm) {
                macroForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    calculateMacros();
					//calcularMacros(); 
                });
            }
            if (mealForm) {
                 mealForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    generateMealPlan();
                });
            }
             if (timeEstimationForm) {
                 timeEstimationForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    estimateTimeManually();
                });
            }
             if (savePdfButton) {
                 savePdfButton.addEventListener('click', guardarComoPDF);
             }
			event.preventDefault();
			
			calcularMacros(); 
             // Listeners for live percentage updates
             if(proteinPercentageInput && carbPercentageInput && fatPercentageInput) { // Check if elements exist before adding listeners
                 proteinPercentageInput.addEventListener('input', adjustMacroPercentages);
                 carbPercentageInput.addEventListener('input', adjustMacroPercentages);
                 fatPercentageInput.addEventListener('input', adjustMacroPercentages);
             }
             if(mealPercentageInputs) {
                 mealPercentageInputs.forEach(input => {
                     input.addEventListener('input', adjustMealPercentages);
                 });
             }


            // --- Initial Setup Calls ---
            adjustMacroPercentages(); // Initial calculation for macro total
            adjustMealPercentages();  // Initial calculation for meal total
            updateButtonStates();     // Set initial button disabled states

        }); 
		
		// End of DOMContentLoaded listener


        // --- Step 7: Generate Hyperprotein Cycle Table (Manual) ---
        // Needs to be globally accessible for the onclick attribute
        /**
 * Generates a hyperprotein cycle table based on manual estimations from Step 6.
 * Requires global variables from Step 1 (user data) and Step 6 (manual estimation).
 */
/**
 * Generates a hyperprotein cycle table based on manual estimations from Step 6.
 * Shows Kcal/day and protein intake for all activity levels (0: Sedentary, 1: Light, 2: Moderate, 3: Active, 4: Very Active).
 */
/**
 * Generates a hyperprotein cycle table based on manual estimations from Step 6.
 * Shows Kcal/day and protein intake (g and g/kg) for all activity levels (0: Sedentary, 1: Light, 2: Moderate, 3: Active, 4: Very Active).
 * Table columns: Ciclo, Fase, Semanas, Peso (kg), Kcal/día/AF, Proteínas (g/kg), Ajuste Calórico.
 */
/**
 * Generates a hyperprotein cycle table based on manual estimations from Step 6.
 * Shows Kcal/day and protein intake (g and g/kg) for all activity levels (0: Sedentary, 1: Light, 2: Moderate, 3: Active, 4: Very Active).
 * Limits protein intake to a maximum of 2.5 g/kg of body weight.
 * Table columns: Ciclo, Fase, Semanas, Peso (kg), Kcal/día/AF, Proteínas (g/kg), Notas.
 */
function generateHyperproteinCycles() {
    // DOM references
    const tableContainer = document.getElementById('hyperprotein-cycle-table-container');
    const table = document.getElementById('hyperprotein-cycle-table');
    const tableBody = document.getElementById('hyperprotein-cycle-table-body');
    const infoMessage = document.getElementById('hyperprotein-info-message');
    const noteContainer = document.getElementById('hyperprotein-note-container');

    // Clear previous content
    if (tableBody) tableBody.innerHTML = '';
    if (table) table.style.display = 'none';
    if (infoMessage) infoMessage.style.display = 'block';
    if (noteContainer) noteContainer.innerHTML = '';

    // Validate prerequisites
    if (!currentWeightKg || !userAge || !userHeightCm || !userGender || !userActivityLevel ||
        estimatedWeeksManualGlobal === null || estimatedWeeksManualGlobal <= 0 ||
        weightChangeGoalManualGlobal === null || weeklyCalorieDiffManualGlobal === null ||
        isNaN(weeklyCalorieDiffManualGlobal) || weeklyCalorieDiffManualGlobal === 0) {
        if (infoMessage) {
            infoMessage.innerHTML = '<em>Completa el Paso 6 (Estimación Manual) con valores válidos (tiempo > 0 semanas, diferencia calórica distinta de cero) y asegúrate de haber completado el Paso 1.</em>';
        }
        console.warn("Prerequisites for Step 7 not met:", {
            currentWeightKg, userAge, userHeightCm, userGender, userActivityLevel,
            estimatedWeeksManualGlobal, weightChangeGoalManualGlobal, weeklyCalorieDiffManualGlobal
        });
        return;
    }

    // Additional input validations
    if (currentWeightKg <= 0 || isNaN(currentWeightKg)) {
        if (infoMessage) infoMessage.innerHTML = '<em>El peso actual debe ser un valor positivo válido.</em>';
        return;
    }
    if (Math.abs(weightChangeGoalManualGlobal) < 0.1 && goalType !== 'maintenance') {
        if (infoMessage) infoMessage.innerHTML = '<em>El cambio de peso debe ser significativo para generar ciclos.</em>';
        return;
    }

    // Define multiplicadores por género usando valores numéricos como strings
    const maleActivityMultipliers = {
        '1.2': 1.2,    // sedentary
        '1.375': 1.56, // light
        '1.55': 1.78,  // moderate
        '1.725': 2.1,  // active
        '1.9': 2.3     // very_active
    };

    const femaleActivityMultipliers = {
        '1.2': 1.2,    // sedentary
        '1.375': 1.55, // light
        '1.55': 1.64,  // moderate
        '1.725': 1.82, // active
        '1.9': 2.0     // very_active
    };

    // Selecciona el objeto según el género
    const activityMultipliers = userGender === 'male' ? maleActivityMultipliers : femaleActivityMultipliers;

    // Define activity levels array based on available multipliers
    const activityLevels = Object.keys(activityMultipliers); // ['1.2', '1.375', '1.55', '1.725', '1.9']

    // Map activity levels to descriptive names for better UX
    const activityLevelNames = {
        '1.2': 'Sedentario',
        '1.375': 'Ligero',
        '1.55': 'Moderado',
        '1.725': 'Activo',
        '1.9': 'Muy Activo'
    };

    // Validate activity level with detailed error handling
    const activityMultiplier = activityMultipliers[userActivityLevel];
    if (activityMultiplier === undefined) {
        const errorMessage = `Nivel de actividad no válido: "${userActivityLevel}". Valores permitidos: ${Object.keys(activityMultipliers).join(', ')}`;
        
        if (infoMessage) {
            infoMessage.innerHTML = `<em>Error: ${errorMessage}</em>`;
        }
        
        console.error("Invalid activity level:", userActivityLevel);
        console.log("Available activity levels:", Object.keys(activityMultipliers));
        console.log("User gender:", userGender);
        
        return;
    }

    // Use stored global values
    const totalWeeks = estimatedWeeksManualGlobal;
    const weightChangeGoal = weightChangeGoalManualGlobal;
    const weeklyCalorieDiff = weeklyCalorieDiffManualGlobal;
    const goalType = weightChangeGoal < 0 ? 'loss' : (weightChangeGoal > 0 ? 'gain' : 'maintenance');

    if (goalType === 'maintenance') {
        if (infoMessage) infoMessage.innerHTML = '<em>No se requiere tabla de ciclos hiperproteicos para un objetivo de mantenimiento.</em>';
        return;
    }

    // Calculate weekly weight change
    const weeklyRateKg = weightChangeGoal / totalWeeks;
    const dailyCalorieDiff = weeklyCalorieDiff / 7;
    const dailyCalorieDiffBreak = (weeklyCalorieDiff * 0.5) / 7; // Reduced deficit for break phase

    // Cycle configuration
    const phaseWeeksPerCycle = 4;
    const breakWeeksPerCycle = 1;
    const cycleDuration = phaseWeeksPerCycle + breakWeeksPerCycle;

    let currentWeek = 0;
    let currentWeight = currentWeightKg;
    let cycleCount = 1;

    console.log("Generating Step 7 Table:", { totalWeeks, weightChangeGoal, weeklyCalorieDiff, weeklyRateKg, goalType, dailyCalorieDiff, dailyCalorieDiffBreak });

    // Helper function to round to nearest multiple
    const roundToNearest = (value, multiple) => Math.round(value / multiple) * multiple;

    // Helper function to format calories and proteins for all activity levels
    const formatCaloriesAndProteins = (bmr, calorieDiff, proteinPercentage, weight) => {
        const calories = activityLevels.map((level, index) => {
            const tdee = bmr * activityMultipliers[level] + calorieDiff;
            return roundToNearest(tdee, 10);
        });
        const proteins = calories.map(kcal => {
            let proteinGrams = roundToNearest((kcal * proteinPercentage) / 4, 1);
            // Limit gPerKg to 2.5 g/kg
            const maxProteinGrams = weight > 0 ? roundToNearest(2.5 * weight, 1) : proteinGrams;
            if (weight > 0 && proteinGrams / weight > 2.5) {
                proteinGrams = maxProteinGrams;
            }
            return proteinGrams;
        });
        const proteinsText = proteins.map((g, index) => {
            const gPerKg = weight > 0 ? (g / weight).toFixed(1) : '0.0';
            return `${index}: ${g} g / ${gPerKg} g/kg`;
        }).join('<br>');
        return { calories, proteinsText };
    };

    // ... resto de tu código ...

    while (currentWeek < totalWeeks) {
        // --- Hyperprotein Phase ---
        const phaseDuration = Math.min(phaseWeeksPerCycle, totalWeeks - currentWeek);
        if (phaseDuration <= 0) break;

        const phaseWeightChange = weeklyRateKg * phaseDuration;
        let phaseEndWeight = currentWeight + phaseWeightChange;
        phaseEndWeight = goalType === 'loss'
            ? Math.max(phaseEndWeight, currentWeightKg + weightChangeGoal)
            : Math.min(phaseEndWeight, currentWeightKg + weightChangeGoal);

        // Calculate BMR
        let phaseStartBMR;
        if (userGender === 'male') {
            phaseStartBMR = (10 * currentWeight) + (6.25 * userHeightCm) - (5 * userAge) + 5;
        } else {
            phaseStartBMR = (10 * currentWeight) + (6.25 * userHeightCm) - (5 * userAge) - 161;
        }

        // Calculate calories and proteins for all activity levels
        const { calories: phaseCalories, proteinsText: phaseProteinsText } = formatCaloriesAndProteins(phaseStartBMR, dailyCalorieDiff, 0.35, currentWeight);

        // Validate calorie range
        if (phaseCalories.some(kcal => kcal < 1000 || kcal > 5000)) {
            if (infoMessage) infoMessage.innerHTML = '<em>Las calorías calculadas para la fase hiperproteica no son realistas. Revisa la diferencia calórica semanal.</em>';
            console.warn("Unrealistic phase calories:", phaseCalories);
            return;
        }

        // Format calories for display
        const phaseCaloriesText = phaseCalories.map((kcal, index) => `${index}: ${kcal} kcal`).join('<br>');

        const hyperproteinRow = document.createElement('tr');
        hyperproteinRow.classList.add('phase-hyperprotein');
        hyperproteinRow.innerHTML = `
            <td>${cycleCount}</td>
            <td>Hiperproteico</td>
            <td>${phaseDuration}</td>
            <td>${currentWeight.toFixed(1)} → ${phaseEndWeight.toFixed(1)}</td>
            <td>${phaseCaloriesText}</td>
            <td>${phaseProteinsText}</td>
            <td>${goalType === 'loss' ? `Déficit (${dailyCalorieDiff.toFixed(0)} kcal/d)` : `Superávit (+${dailyCalorieDiff.toFixed(0)} kcal/d)`}</td>
        `;
        if (tableBody) tableBody.appendChild(hyperproteinRow);

        currentWeek += phaseDuration;
        currentWeight = phaseEndWeight;

        // Exit if target weight reached (tolerance 0.05)
        if ((goalType === 'loss' && currentWeight <= currentWeightKg + weightChangeGoal + 0.05) ||
            (goalType === 'gain' && currentWeight >= currentWeightKg + weightChangeGoal - 0.05)) {
            break;
        }

        // --- Break Phase ---
        if (currentWeek < totalWeeks) {
            const breakDuration = Math.min(breakWeeksPerCycle, totalWeeks - currentWeek);
            if (breakDuration <= 0) break;

            let breakBMR;
            if (userGender === 'male') {
                breakBMR = (10 * currentWeight) + (6.25 * userHeightCm) - (5 * userAge) + 5;
            } else {
                breakBMR = (10 * currentWeight) + (6.25 * userHeightCm) - (5 * userAge) - 161;
            }

            // Calculate calories and proteins for all activity levels
            const { calories: breakCalories, proteinsText: breakProteinsText } = formatCaloriesAndProteins(breakBMR, dailyCalorieDiffBreak, 0.25, currentWeight);

            // Validate calorie range
            if (breakCalories.some(kcal => kcal < 1000 || kcal > 5000)) {
                if (infoMessage) infoMessage.innerHTML = '<em>Las calorías calculadas para la fase de break no son realistas. Revisa los datos de entrada.</em>';
                console.warn("Unrealistic break calories:", breakCalories);
                return;
            }

            // Format calories for display
            const breakCaloriesText = breakCalories.map((kcal, index) => `${kcal} kcal`).join('<br>');

            const breakRow = document.createElement('tr');
            breakRow.classList.add('phase-break');
            breakRow.innerHTML = `
                <td>${cycleCount}</td>
                <td>Break (Pérdida Reducida)</td>
                <td>${breakDuration}</td>
                <td>~ ${currentWeight.toFixed(1)}</td>
                <td>${breakCaloriesText}</td>
                <td>${breakProteinsText}</td>
                <td>Déficit reducido (${dailyCalorieDiffBreak.toFixed(0)} kcal/d)</td>
            `;
            if (tableBody) tableBody.appendChild(breakRow);

            // Update weight for reduced loss in break phase
            const breakWeightChange = (weeklyRateKg * 0.5) * breakDuration;
            currentWeight += breakWeightChange;

            currentWeek += breakDuration;
            cycleCount++;
        }

        // Exit if target weight reached during break
        if ((goalType === 'loss' && currentWeight <= currentWeightKg + weightChangeGoal + 0.05) ||
            (goalType === 'gain' && currentWeight >= currentWeightKg + weightChangeGoal - 0.05)) {
            break;
        }
    }

    // Correct final weight display directly
    if (tableBody && tableBody.lastElementChild) {
        const lastRowCells = tableBody.lastElementChild.cells;
        if (lastRowCells && lastRowCells.length > 3) {
            const weightCell = lastRowCells[3];
            const finalTargetWeight = currentWeightKg + weightChangeGoal;
            const currentText = weightCell.textContent;
            const startWeightMatch = currentText.match(/^(-?\d+\.\d)/); // Match start weight
            if (startWeightMatch && Math.abs(currentWeight - finalTargetWeight) > 0.05) {
                weightCell.innerHTML = `${startWeightMatch[1]} → ${finalTargetWeight.toFixed(1)}`;
                console.log(`Corrected final weight display to ${finalTargetWeight.toFixed(1)}`);
            }
        }
    }

    // Show table and hide info message
    if (table) table.style.display = 'table';
    if (infoMessage) infoMessage.style.display = 'none';

    // Add note
    if (noteContainer) {
        const note = document.createElement('p');
        note.style.fontSize = '0.9em';
        note.style.fontStyle = 'italic';
        note.style.marginTop = '10px';
        note.textContent = 'Nota: Esta tabla es una simulación basada en la estimación manual del Paso 6. Las calorías y proteínas se muestran para todos los niveles de actividad (0: Sedentario, 1: Leve, 2: Moderado, 3: Activo, 4: Muy Activo). Proteínas limitadas a un máximo de 2.5 g/kg. Ajusta según progreso real y consulta a un profesional.';
        noteContainer.appendChild(note);
    }
}

    
	




// FUNCIONALIDAD PDF
document.getElementById("save-pdf-button").addEventListener("click", async function () {
    // Convertir gráficos a imágenes
    const charts = document.querySelectorAll('canvas');
    const promises = Array.from(charts).map(chart => {
        return new Promise(resolve => {
            const image = new Image();
            image.src = chart.toDataURL();
            image.onload = () => {
                const img = document.createElement('img');
                img.src = image.src;
                img.style.maxWidth = '90%';
                chart.parentNode.replaceChild(img, chart);
                resolve();
            };
        });
    });

    await Promise.all(promises);

    const opt = {
        margin: [5, 5, 5, 5],
        filename: 'Plan_Nutricional.pdf',
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { 
            scale: 2,
            scrollY: 0,
            useCORS: true,
            allowTaint: true,
            logging: true
        },
        jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait' 
        },
        pagebreak: { mode: 'avoid-all' }
    };

    const element = document.documentElement;
    html2pdf().set(opt).from(element).save().then(() => {
        // Restaurar los canvas después de la exportación
        charts.forEach((chart, index) => {
            const img = chart.parentNode.querySelector('img');
            if(img) img.replaceWith(chart);
        });
    });
});

 // --- PDF Generation ---
            function guardarComoPDF2() {
                if (!calculatedTDEE) {
                    alert("Por favor, completa al menos el Paso 1 (Cálculo de Necesidades) antes de generar el PDF.");
                    return;
                }

                const mainElement = document.querySelector('main');
                const headerElement = document.querySelector('header');
                const footerElement = document.querySelector('footer');
                const allButtons = document.querySelectorAll('button'); // Select all buttons

                // Hide elements not needed in PDF
                if (headerElement) headerElement.style.display = 'none';
                if (footerElement) footerElement.style.display = 'none';
                allButtons.forEach(btn => btn.style.display = 'none');

                // Temporarily make chart containers visible if they have content
                const chartContainers = document.querySelectorAll('#chart-container, #weight-chart-container, #time-estimation-chart-container');
                const originalDisplayStyles = [];
                chartContainers.forEach(container => {
                    originalDisplayStyles.push(container.style.display);
                    if (container.querySelector('canvas') && container.style.display === 'none') {
                        container.style.display = 'block';
                    }
                });

                const opt = {
                    margin: [15, 10, 15, 10],
                    filename: 'NutriPlan_Plan_Dietetico_Personalizado.pdf',
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: { scale: 2, useCORS: true, logging: false, windowWidth: mainElement.scrollWidth, windowHeight: mainElement.scrollHeight },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'], before: '.plan-step' }
                };

                console.log("Generating PDF...");
                html2pdf().from(mainElement).set(opt).save().then(() => {
                    console.log("PDF generated successfully.");
                    // Restore visibility
                    if (headerElement) headerElement.style.display = 'flex';
                    if (footerElement) footerElement.style.display = 'block';
                    allButtons.forEach(btn => btn.style.display = 'block');
                    chartContainers.forEach((container, index) => { container.style.display = originalDisplayStyles[index]; });
                }).catch(err => {
                    console.error("Error generating PDF:", err);
                    alert("Hubo un error al generar el PDF. Revisa la consola del navegador (F12) para más detalles.");
                    // Restore visibility even on error
                    if (headerElement) headerElement.style.display = 'flex';
                    if (footerElement) footerElement.style.display = 'block';
                    allButtons.forEach(btn => btn.style.display = 'block');
                    chartContainers.forEach((container, index) => { container.style.display = originalDisplayStyles[index]; });
                });
            }

	
   // Ensure Firebase is loaded
    if (typeof firebase === 'undefined') {
        console.error('Firebase SDK not loaded. Ensure firebase-app.js and firebase-auth.js are included in the <head>.');
        var errorDiv = document.createElement('div');
        errorDiv.style.color = 'red';
        errorDiv.style.marginBottom = '10px';
        errorDiv.style.fontSize = '14px';
        errorDiv.style.textAlign = 'center';
        errorDiv.textContent = 'Error: No se pudo cargar Firebase. Contacta al administrador.';
        document.querySelector('main').insertBefore(errorDiv, document.querySelector('main').firstChild);
    } else {
        // Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyChC7s5NN-z-dSjqeXDaks7gaNaVCJAu7Q",
            authDomain: "nutriplanv2.firebaseapp.com",
            projectId: "nutriplanv2",
            storageBucket: "nutriplanv2.firebasestorage.app",
            messagingSenderId: "653707489758",
            appId: "1:653707489758:web:9133d1d1620825c385ed4f",
            measurementId: "G-NWER69E8B6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var auth = firebase.auth();

        // Logout
        function logout() {
            auth.signOut().then(function() {
                console.log('Sesión cerrada');
                window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
            }).catch(function(error) {
                console.error('Error al cerrar sesión:', error.code, error.message);
                var main = document.querySelector('main');
                var errorDiv = document.createElement('div');
                errorDiv.style.color = 'red';
                errorDiv.style.marginBottom = '10px';
                errorDiv.style.fontSize = '14px';
                errorDiv.textContent = 'Error al cerrar sesión: ' + error.message;
                main.insertBefore(errorDiv, main.firstChild);
                setTimeout(function() { errorDiv.remove(); }, 5000);
            });
        }

        // Initialize UI
        function initializeUI() {
            document.getElementById('logo').addEventListener('click', function(event) {
                event.preventDefault();
                var dropdown = document.getElementById('dropdown');
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            });

            document.addEventListener('click', function(event) {
                var dropdown = document.getElementById('dropdown');
                var logo = document.getElementById('logo');
                if (!logo.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.style.display = 'none';
                }
            });

            window.logout = logout;
        }

        // Handle auth state
        auth.onAuthStateChanged(function(user) {
            var dropdown = document.getElementById('dropdown');
            if (user) {
                console.log('Auth state: User signed in', user.displayName, user.email);
                if (dropdown) dropdown.style.display = 'none'; // Initially hidden, shown on logo click
            } else {
                console.log('Auth state: No user signed in');
                window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
            }
        });

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeUI);
    }
//--------------- Funciones para las Tablas de la Seccion Ciclos Dieteticos---------------------------------//

		// --- Definición de estructura de fases por objetivo ---
// Esta estructura define las fases típicas, su duración relativa y macros base.
// Se puede ampliar para ganancia, mantenimiento, mixto.
const estructuraFasesPorObjetivo = {
    // --- Pérdida de Peso ---
    perdida: [
        {
            nombre: "Inducción Cetogénica",
            // Duración relativa: un número que representa la proporción de tiempo.
            // Por ejemplo, si Induccion=2, Ciclado=3, Transicion=1, la proporcion es 2:3:1
            duracionRelativa: 2, 
            // Macros base para la fase (%)
            macros: { proteinas: [20, 25], carbohidratos: [5, 10], grasas: [65, 75] },
            objetivoPrincipal: "Reset metabólico, inicio de pérdida de grasa, reducción de insulina.",
            observaciones: "Monitorizar lípidos, electrolitos, presión arterial. Priorizar grasas insaturadas."
        },
        {
            nombre: "Ciclado Metabólico",
            duracionRelativa: 3,
            macros: { proteinas: [25, 30], carbohidratos: [10, 25], grasas: [40, 65] },
            objetivoPrincipal: "Continuar pérdida de peso, mantener rendimiento físico y evitar estancamiento.",
            observaciones: "Carbohidratos estratégicos antes/después del ejercicio."
        },
        {
            nombre: "Transición a Mantenimiento",
            duracionRelativa: 1, // Proporcional al resto
            macros: { proteinas: [20, 25], carbohidratos: [26, 40], grasas: [30, 45] },
            objetivoPrincipal: "Mantener peso, favorecer adherencia social y equilibrio nutricional.",
            observaciones: "Seguir entrenando, ajustar según objetivos. Revaluar analíticas y composición corporal."
        }
    ],
    // --- Ganancia de Peso (Volumen Muscular) ---
    ganancia: [
         {
            nombre: "Volumen Muscular Inicial",
            duracionRelativa: 2,
            macros: { proteinas: [25, 30], carbohidratos: [40, 50], grasas: [20, 30] },
            objetivoPrincipal: "Establecer base calórica alta, favorecer síntesis proteica.",
            observaciones: "Priorizar calidad de alimentos. Monitorizar digestión."
        },
        {
            nombre: "Volumen Muscular Avanzado",
            duracionRelativa: 3,
            macros: { proteinas: [25, 35], carbohidratos: [45, 55], grasas: [15, 25] },
            objetivoPrincipal: "Maximizar aporte energético para entrenos intensos, ganar masa muscular.",
            observaciones: "Ajustar calorías según progreso. Timing post-entreno."
        },
        {
            nombre: "Definición/Recomposición Corporal",
            duracionRelativa: 1,
            macros: { proteinas: [30, 35], carbohidratos: [20, 30], grasas: [35, 45] },
            objetivoPrincipal: "Reducir ganancia de grasa mientras se mantiene/masa muscular ganada.",
            observaciones: "Control más estricto de HC. Posible inclusión de ciclos de déficit ligero."
        }
    ],
    // --- Mantenimiento ---
    mantenimiento: [
        {
            nombre: "Estabilización",
            duracionRelativa: 1, // En mantenimiento, el tiempo es más lineal o cíclico
            macros: { proteinas: [20, 25], carbohidratos: [35, 45], grasas: [30, 35] },
            objetivoPrincipal: "Consolidar hábitos, equilibrar energía.",
            observaciones: "Flexible Dieting (80/20). Monitoreo de peso y sensación de saciedad."
        }
        // Se podría añadir un ciclo anual aquí si se desea
    ],
     // --- Mixto/Combinado ---
    mixto: [
        // El mixto puede ser una combinación de bloques de las otras fases
        // Por ejemplo: 3 meses de Volumen, 2 meses de Definición, 1 mes de Mantenimiento
        // Lo definiremos más específicamente cuando se genere la tabla, basándonos en estimatedWeeksManualGlobal
        // y posiblemente en weightChangeGoalManualGlobal para determinar la proporción.
         {
            nombre: "Fase Variable (Mixta)",
            duracionRelativa: 1, // Placeholder
            macros: { proteinas: [20, 35], carbohidratos: [10, 55], grasas: [15, 45] }, // Rango muy amplio
            objetivoPrincipal: "Alternar entre objetivos de volumen, definición y mantenimiento.",
            observaciones: "Planificación cíclica. Ajustar macros y calorías según fase del ciclo."
        }
    ]
    // Se pueden añadir más objetivos si es necesario
};

/**
 * Calcula la distribución de semanas para cada fase basándose en el tiempo total y la estructura.
 * @param {number} totalWeeks - Las semanas totales estimadas (estimatedWeeksManualGlobal).
 * @param {string} objetivo - El objetivo del usuario ('perdida', 'ganancia', 'mantenimiento', 'mixto').
 * @returns {ArrayObject>} Un array de objetos, cada uno representando una fase con su nombre, semanas asignadas, etc.
 */
function calcularDistribucionSemanas(totalWeeks, objetivo) {
    const estructura = estructuraFasesPorObjetivo[objetivo];
    if (!estructura || totalWeeks <= 0) {
        console.error("Datos insuficientes para calcular distribución de semanas.");
        return [];
    }

    // Calcular la suma total de las duraciones relativas
    const sumaDuracionesRelativas = estructura.reduce((suma, fase) => suma + fase.duracionRelativa, 0);
    
    // Si la suma es 0, evitar división por cero
    if (sumaDuracionesRelativas === 0) {
         console.warn("Suma de duraciones relativas es 0. Asignando tiempo igualitariamente.");
         return estructura.map(fase => ({
             ...fase,
             semanasAsignadas: Math.ceil(totalWeeks / estructura.length)
         }));
    }

    // Calcular semanas para cada fase
    let semanasAsignadasAcumuladas = 0;
    const fasesConSemanas = estructura.map((fase, index) => {
        // Calcular semanas proporcionales
        let semanasParaEstaFase = Math.round((fase.duracionRelativa / sumaDuracionesRelativas) * totalWeeks);
        
        // Ajuste para el último elemento: asegurar que la suma sea exactamente totalWeeks
        // Esto corrige errores de redondeo.
        if (index === estructura.length - 1) {
            semanasParaEstaFase = totalWeeks - semanasAsignadasAcumuladas;
        }
        semanasAsignadasAcumuladas += semanasParaEstaFase;

        return {
            ...fase,
            semanasAsignadas: semanasParaEstaFase
        };
    });

    return fasesConSemanas;
}
/**
 * Calcula el cambio de peso estimado para una fase dada su duración y la diferencia calórica semanal.
 * @param {number} semanasEnFase - Número de semanas que dura la fase.
 * @param {number} weeklyCalorieDiff - Diferencia calórica semanal estimada (puede ser negativa para pérdida).
 * @returns {number} El cambio de peso estimado en kg para esa fase.
 */
function calcularCambioPesoPorFase(semanasEnFase, weeklyCalorieDiff) {
    const KCAL_POR_KG_GRASA = 7700;
    // Cambio de peso por semana = (Diferencia semanal en kcal) / (kcal por kg)
    const cambioPorSemanaKg = weeklyCalorieDiff / KCAL_POR_KG_GRASA;
    // Cambio total de peso en la fase = cambio por semana * número de semanas
    return cambioPorSemanaKg * semanasEnFase;
}

/**
 * Genera un array con el peso estimado al inicio y al final de cada fase.
 * @param {ArrayObject>} fasesConSemanas - Array de fases con semanas asignadas.
 * @param {number} pesoInicial - Peso inicial del usuario (currentWeightKg).
 * @param {number} weeklyCalorieDiff - Diferencia calórica semanal (weeklyCalorieDiffManualGlobal).
 * @returns {ArrayObject>} Array de fases con propiedades adicionales: pesoInicioFase, pesoFinFase.
 */
function calcularPesosPorFase(fasesConSemanas, pesoInicial, weeklyCalorieDiff) {
    let pesoActual = pesoInicial;
    return fasesConSemanas.map(fase => {
        const cambioPesoEnFase = calcularCambioPesoPorFase(fase.semanasAsignadas, weeklyCalorieDiff);
        const pesoInicioFase = pesoActual;
        const pesoFinFase = pesoActual + cambioPesoEnFase;
        pesoActual = pesoFinFase; // Actualizar para la siguiente fase

        return {
            ...fase,
            pesoInicioFase: pesoInicioFase,
            pesoFinFase: pesoFinFase
        };
    });
}
function calcularPesosPorFaseGanacia(fases, pesoInicial, cambioTotal) {
    const distribucion = [0.4, 0.3, 0.2, 0.1]; // Mayor ganancia al inicio
    let pesoActual = pesoInicial;
    return fases.map((fase, index) => {
        const cambio = cambioTotal * distribucion[index];
        const pesoFin = pesoActual + cambio;
        const faseData = { ...fase, pesoInicioFase: pesoActual, pesoFinFase: pesoFin };
        pesoActual = pesoFin;
        return faseData;
    });
}
/**
 * Genera los datos para la Tabla General del Proceso Nutricional.
 * @returns {ArrayObject>|null} Un array de objetos representando cada bloque de la fase, o null si hay error.
 */
/**
 * Genera los datos para la Tabla General del Proceso Nutricional,
 * adaptando las fases según el objetivo del usuario (pérdida, ganancia, mantenimiento, mixto).
 * @returns {ArrayObject>|null} Un array de objetos representando cada fase, o null si hay error.
 */

		function generarDatosTablaGeneral() {
    // --- 1. Validar que los datos del Paso 6 estén disponibles ---
    if (estimatedWeeksManualGlobal === null || weightChangeGoalManualGlobal === null ||
        currentWeightKg === null || !goalTypeGlobal || goalTypeGlobal === 'sel') {
        console.warn("Datos del Paso 6 no disponibles. No se puede generar la Tabla General.", {
            estimatedWeeksManualGlobal,
            weightChangeGoalManualGlobal,
            currentWeightKg,
            goalTypeGlobal
        });
        return null;
    }

    // --- 2. Mapear goalTypeGlobal a objetivo interno ---
    const objetivoActual = window.goalTypeGlobal;
    const objetivosReconocidos = ['perdida1', 'ganancia1', 'mantenimiento1', 'mixto1'];
    if (!objetivosReconocidos.includes(objetivoActual)) {
        console.error("Objetivo no reconocido para generar tabla general:", objetivoActual);
        return null;
    }
    console.log("Objetivo mapeado:", objetivoActual);

    const semanasTotalesEstimadas = estimatedWeeksManualGlobal;
    const cambioPesoTotal = weightChangeGoalManualGlobal;
    const pesoActualUsuario = currentWeightKg;

    // --- 3. Definir estructura de fases para Ganancia de Peso/Muscular ---
    const fasesGananciaMuscular = [
        {
            id: 'evaluacion_base',
            nombre: "Fase 1: Evaluación y Base",
            duracionPredeterminadaSemanas: 4,
            mesesTexto: "1–1",
            macrosBase: {
                proteinasPct: "16-22%",
                carbohidratosPct: "40-50%",
                grasasPct: "25-35%",
                proteinas_g_kg_dia: "1.6-2.2",
                carbohidratos_g_kg_dia: "4-6",
                grasas_g_kg_dia: "0.8-1.0"
            },
            objetivoPrincipal: "Evaluar estado inicial, establecer hábitos, preparar el cuerpo",
            observaciones: "Superávit moderado: +10-15% sobre GET (300-500 kcal/día). Iniciar entrenamiento de fuerza progresivo, priorizar alimentos integrales, sueño 7-9 h."
        },
        {
            id: 'volumen_progresivo',
            nombre: "Fase 2: Volumen Progresivo",
            duracionPredeterminadaSemanas: 8,
            mesesTexto: "2–4",
            macrosBase: {
                proteinasPct: "16-22%",
                carbohidratosPct: "50-60%",
                grasasPct: "20-30%",
                proteinas_g_kg_dia: "1.6-2.2",
                carbohidratos_g_kg_dia: "5-7",
                grasas_g_kg_dia: "0.8-1.2"
            },
            objetivoPrincipal: "Maximizar hipertrofia con superávit controlado",
            observaciones: "Superávit: +10-20% sobre GET. Ajustar según ganancia (0.5-1 kg/mes). Aumentar intensidad del entrenamiento. Composición corporal cada 4-6 semanas."
        },
        {
            id: 'mantenimiento_reajuste',
            nombre: "Fase 3: Mantenimiento y Reajuste",
            duracionPredeterminadaSemanas: 8,
            mesesTexto: "5–6",
            macrosBase: {
                proteinasPct: "18-22%",
                carbohidratosPct: "40-50%",
                grasasPct: "25-35%",
                proteinas_g_kg_dia: "1.8-2.2",
                carbohidratos_g_kg_dia: "4-5",
                grasas_g_kg_dia: "0.8-1.0"
            },
            objetivoPrincipal: "Consolidar ganancias, prevenir exceso de grasa",
            observaciones: "Superávit leve: +5-10% o mantenimiento si %grasa >15-20%. Evaluar fuerza, composición corporal, rendimiento. Considerar ciclado calórico."
        },
        {
            id: 'optimizacion_avanzada',
            nombre: "Fase 4: Optimización y Volumen Avanzado",
            duracionPredeterminadaSemanas: 16,
            mesesTexto: "7–9+",
            macrosBase: {
                proteinasPct: "18-22%",
                carbohidratosPct: "50-65%",
                grasasPct: "15-25%",
                proteinas_g_kg_dia: "1.8-2.2",
                carbohidratos_g_kg_dia: "Variable (6-8g entreno, 3-4g descanso)",
                grasas_g_kg_dia: "0.8-1.0"
            },
            objetivoPrincipal: "Afinar hipertrofia en atletas intermedios/avanzados",
            observaciones: "Superávit moderado: +10-15% o cíclico. Progreso cada 6-8 semanas. Periodización avanzada, suplementos (beta-alanina, citrulina), gestionar estrés."
        }
    ];

    // --- 4. Definir estructura de fases para Pérdida de Peso ---
    const fasesPerdida = [
        {
            id: 'induccion_cetogenica',
            nombre: "Fase 1: Inducción Cetogénica",
            duracionPredeterminadaSemanas: 6,
            mesesTexto: "1–2",
            macrosBase: {
                proteinasPct: "20-25%",
                carbohidratosPct: "5-10%",
                grasasPct: "65-75%",
                proteinas_g_kg_dia: "1.6-2.0",
                carbohidratos_g_kg_dia: "0.4-0.8",
                grasas_g_kg_dia: "1.2-1.5"
            },
            objetivoPrincipal: "Reset metabólico, inicio de pérdida de grasa, reducción de insulina",
            observaciones: "Déficit: 15-20% bajo GET (300-500 kcal/día). VLCKD:  ↓50g HC/día. 80/20 Rule: 80% alimentos integrales (carnes magras, huevos, vegetales bajos en HC), 20% flexibles. Timing: 20-40g proteína post-entreno. Intuitivo: Ajustar por hambre. Suplementos: Electrolitos, fibra. Monitorizar lípidos, glucosa, cetonas (0.5-3 mmol/L)."
        },
        {
            id: 'ciclado_metabolico',
            nombre: "Fase 2: Ciclado Metabólico",
            duracionPredeterminadaSemanas: 10,
            mesesTexto: "2–4",
            macrosBase: {
                proteinasPct: "25-30%",
                carbohidratosPct: "10-25%",
                grasasPct: "50-65%",
                proteinas_g_kg_dia: "1.8-2.2",
                carbohidratos_g_kg_dia: "0.8-1.6",
                grasas_g_kg_dia: "1.0-1.3"
            },
            objetivoPrincipal: "Continuar pérdida de peso, mantener rendimiento físico, evitar estancamiento",
            observaciones: "Déficit: 10-15% bajo GET (300-400 kcal/día). TKD: 20-50g HC pre/post entreno para atletas de fuerza. Carb Cycling: 80-120g HC días de entreno, 30-50g descanso. Periodización: Ajustar HC según intensidad entreno. 80/20 Rule. Intuitivo: Ajustar por hambre/saciedad. Fraccionamiento: 4-5 comidas/día."
        },
        {
            id: 'transicion_mantenimiento',
            nombre: "Fase 3: Transición a Mantenimiento",
            duracionPredeterminadaSemanas: 8,
            mesesTexto: "4–6",
            macrosBase: {
                proteinasPct: "22-25%",
                carbohidratosPct: "33-40%",
                grasasPct: "40-45%",
                proteinas_g_kg_dia: "1.6-2.0",
                carbohidratos_g_kg_dia: "2.0-2.5",
                grasas_g_kg_dia: "0.8-1.0"
            },
            objetivoPrincipal: "Mantener peso perdido, favorecer adherencia social y equilibrio nutricional",
            observaciones: "Déficit: 0-5% bajo GET (0-100 kcal/día). Moderate-carb: 100-150g HC/día. Intuitivo: Ajustar por necesidades sociales. 80/20 Rule. Timing: 20-40g proteína post-entreno. Evaluar composición corporal (bioimpedancia, plicometría). Suplementos: Creatina (3-5g/día), omega-3 (1-2g/día)."
        }
    ];

    // --- 5. Definir estructura de fases para Mantenimiento de Peso Corporal ---
    const fasesMantenimiento = [
        {
            id: 'transicion_mantenimiento',
            nombre: "Subfase 1: Transición al Mantenimiento",
            duracionPredeterminadaSemanas: 3,
            mesesTexto: "1–1",
            macrosBase: {
                proteinasPct: "18-22%",
                carbohidratosPct: "30-40%",
                grasasPct: "30-40%",
                proteinas_g_kg_dia: "1.8-2.2",
                carbohidratos_g_kg_dia: "3-5",
                grasas_g_kg_dia: "0.8-1.2"
            },
            objetivoPrincipal: "Estabilizar peso corporal tras volumen o definición",
            observaciones: "Calorías: 0% superávit (igual al GET). Flexibilidad selectiva (80/20): 80% alimentos integrales, 20% flexibles. Timing: 20-40g proteína post-entreno. Intuitivo: Ajustar por hambre/saciedad. Fraccionamiento: 4-5 comidas/día."
        },
        {
            id: 'mantenimiento_estable',
            nombre: "Subfase 2: Mantenimiento Estable",
            duracionPredeterminadaSemanas: 6,
            mesesTexto: "2–3",
            macrosBase: {
                proteinasPct: "18-22%",
                carbohidratosPct: "40-50%",
                grasasPct: "25-35%",
                proteinas_g_kg_dia: "1.8-2.2",
                carbohidratos_g_kg_dia: "4-6",
                grasas_g_kg_dia: "0.8-1.0"
            },
            objetivoPrincipal: "Preservar masa muscular y optimizar rendimiento",
            observaciones: "Calorías: 0% superávit, ajustar ±100-200 kcal si peso varía ↑ 1 kg. CKD (5+2): 5 días 3-4g/kg HC, 2 días 6-8g/kg. TKD: 20-50g HC pre-entreno para atletas de fuerza. Ciclado CH suave: ±10% kcal según entreno. Periodización: Ajustar HC a intensidad. 80/20 Rule. Intuitivo. Timing: 20-40g proteína + 30-60g HC post-entreno."
        },
        {
            id: 'reevaluacion_preparacion',
            nombre: "Subfase 3: Reevaluación y Preparación",
            duracionPredeterminadaSemanas: 3,
            mesesTexto: "3–4",
            macrosBase: {
                proteinasPct: "18-22%",
                carbohidratosPct: "30-40%",
                grasasPct: "30-40%",
                proteinas_g_kg_dia: "1.8-2.2",
                carbohidratos_g_kg_dia: "3-5",
                grasas_g_kg_dia: "0.8-1.2"
            },
            objetivoPrincipal: "Evaluar progreso y preparar próximo ciclo (volumen o definición)",
            observaciones: "Calorías: 0% superávit, ajustar según próximo objetivo. Flexibilidad selectiva (80/20). Intuitivo: Ajustar por señales corporales. Periodización: Ajustar HC según próximo ciclo. Suplementos: Creatina (3-5g/día), omega-3 (1-2g/día)."
        }
    ];

    // --- 6. Definir estructura de fases para Mixto ---
    const fasesMixto = [
        {
            id: 'mixto_placeholder',
            nombre: "Fase Mixta",
            duracionPredeterminadaSemanas: 12,
            mesesTexto: "1–3",
            macrosBase: {
                proteinasPct: "20-25%",
                carbohidratosPct: "40-45%",
                grasasPct: "30-35%",
                proteinas_g_kg_dia: "1.6-2.0",
                carbohidratos_g_kg_dia: "3-5",
                grasas_g_kg_dia: "0.8-1.0"
            },
            objetivoPrincipal: "Equilibrio entre ganancia muscular y control de grasa",
            observaciones: "Ajustar calorías según progreso. Flexibilidad selectiva (80/20). Timing: 20-40g proteína post-entreno."
        }
    ];

    // --- 7. Seleccionar el conjunto de fases basado en el objetivo ---
    let fasesParaPlan = [];
    if (objetivoActual === 'perdida1') {
        console.log("Seleccionando fases para pérdida de peso.");
        if (semanasTotalesEstimadas < 12) {
            console.log("Periodo corto (12 semanas) para pérdida. Usando Fase 1 o Fase 1+2.");
            fasesParaPlan = fasesPerdida.slice(0, semanasTotalesEstimadas <= 8 ? 1 : 2);
        } else {
            console.log("Periodo medio o largo ( >=12 semanas) para pérdida. Usando las 3 fases.");
            fasesParaPlan = fasesPerdida;
        }
    } else if (objetivoActual === 'ganancia1') {
        console.log("Seleccionando fases para ganancia de peso.");
        if (semanasTotalesEstimadas < 12) {
            console.log("Periodo corto (<12 semanas) para ganancia. Usando Fase 1 y Fase 2.");
            fasesParaPlan = fasesGananciaMuscular.slice(0, 2);
        } else {
            console.log("Periodo largo (>=12 semanas) para ganancia. Usando las 4 fases completas.");
            fasesParaPlan = fasesGananciaMuscular;
        }
    } else if (objetivoActual === 'mantenimiento1') {
        console.log("Seleccionando fases para mantenimiento.");
        if (semanasTotalesEstimadas < 8) {
            console.log("Periodo corto (<8 semanas) para mantenimiento. Usando Subfase 1 y Subfase 2.");
            fasesParaPlan = fasesMantenimiento.slice(0, 2);
        } else {
            console.log("Periodo largo (>=8 semanas) para mantenimiento. Usando las 3 subfases.");
            fasesParaPlan = fasesMantenimiento;
        }
    } else if (objetivoActual === 'mixto1') {
        console.log("Seleccionando fases para objetivo mixto.");
        fasesParaPlan = fasesMixto;
    }

    // --- 8. Calcular la distribución de semanas y pesos para cada fase ---
    const datosTabla = [];
    let semanasAsignadasAcumuladas = 0;
    let pesoAcumulado = pesoActualUsuario;

    const numeroFases = fasesParaPlan.length;
    if (numeroFases === 0) {
        console.error("No hay fases definidas para el objetivo seleccionado.");
        return null;
    }

    // --- 9. Distribuir semanas y calcular datos ---
    if (objetivoActual === 'perdida1') {
        const proporcionTotal = numeroFases === 1 ? 2 : (numeroFases === 2 ? 2 + 3 : 2 + 3 + 2);
        const minSemanasPorFase = [4, 6, 4];
        const maxSemanasPorFase = [12, 18, 12];

        fasesParaPlan.forEach((fase, index) => {
            let semanasParaEstaFase;
            let factorProporcion;
            switch(index) {
                case 0: factorProporcion = 2; break;
                case 1: factorProporcion = 3; break;
                case 2: factorProporcion = 2; break;
                default: factorProporcion = 1;
            }
            const proporcion = factorProporcion / proporcionTotal;
            semanasParaEstaFase = Math.round(proporcion * semanasTotalesEstimadas);

            semanasParaEstaFase = Math.max(minSemanasPorFase[index] || 4, Math.min(semanasParaEstaFase, maxSemanasPorFase[index] || 12));
            semanasParaEstaFase = Math.max(0, Math.min(semanasParaEstaFase, semanasTotalesEstimadas - semanasAsignadasAcumuladas));

            if (index === numeroFases - 1) {
                semanasParaEstaFase = semanasTotalesEstimadas - semanasAsignadasAcumuladas;
            }

            semanasAsignadasAcumuladas += semanasParaEstaFase;

            let cambioPesoEnEstaFase = 0;
            if (semanasTotalesEstimadas > 0) {
                const proporcionSemanas = semanasParaEstaFase / semanasTotalesEstimadas;
                cambioPesoEnEstaFase = cambioPesoTotal * proporcionSemanas;
            }

            const pesoInicioFaseCalculado = parseFloat(pesoAcumulado.toFixed(2));
            const pesoFinFaseCalculado = parseFloat((pesoAcumulado + cambioPesoEnEstaFase).toFixed(2));

            datosTabla.push({
                mesesTexto: fase.mesesTexto,
                nombreFase: fase.nombre,
                proteinasPct: fase.macrosBase.proteinasPct,
                proteinas_g_dia: fase.macrosBase.proteinas_g_kg_dia,
                carbohidratosPct: fase.macrosBase.carbohidratosPct,
                carbohidratos_g_dia: fase.macrosBase.carbohidratos_g_kg_dia,
                grasasPct: fase.macrosBase.grasasPct,
                grasas_g_dia: fase.macrosBase.grasas_g_kg_dia,
                pesoInicioFase: pesoInicioFaseCalculado,
                pesoFinFase: pesoFinFaseCalculado,
                objetivoPrincipal: fase.objetivoPrincipal,
                observaciones: fase.observaciones,
                semanasAsignadas: semanasParaEstaFase // Añadir duración de la fase
            });

            pesoAcumulado = pesoFinFaseCalculado;
        });
    } else if (objetivoActual === 'ganancia1') {
        const proporcionTotal = numeroFases === 2 ? 1 + 2 : 1 + 2 + 2 + 4;
        const proporcionTotalCorto = 1 + 2;

        fasesParaPlan.forEach((fase, index) => {
            let semanasParaEstaFase;
            if (semanasTotalesEstimadas < 12) {
                let factorProporcion;
                switch(index) {
                    case 0: factorProporcion = 1; break;
                    case 1: factorProporcion = 2; break;
                    default: factorProporcion = 1;
                }
                const proporcion = factorProporcion / proporcionTotalCorto;
                semanasParaEstaFase = Math.round(proporcion * semanasTotalesEstimadas);
            } else {
                let factorProporcion;
                switch(index) {
                    case 0: factorProporcion = 1; break;
                    case 1: factorProporcion = 2; break;
                    case 2: factorProporcion = 2; break;
                    case 3: factorProporcion = 4; break;
                    default: factorProporcion = 1;
                }
                const proporcion = factorProporcion / proporcionTotal;
                semanasParaEstaFase = Math.round(proporcion * semanasTotalesEstimadas);
            }

            semanasParaEstaFase = Math.max(0, Math.min(semanasParaEstaFase, semanasTotalesEstimadas - semanasAsignadasAcumuladas));
            if (index === numeroFases - 1) {
                semanasParaEstaFase = semanasTotalesEstimadas - semanasAsignadasAcumuladas;
            }

            semanasAsignadasAcumuladas += semanasParaEstaFase;

            let cambioPesoEnEstaFase = 0;
            if (semanasTotalesEstimadas > 0) {
                const proporcionSemanas = semanasParaEstaFase / semanasTotalesEstimadas;
                cambioPesoEnEstaFase = cambioPesoTotal * proporcionSemanas;
            }

            const pesoInicioFaseCalculado = parseFloat(pesoAcumulado.toFixed(2));
            const pesoFinFaseCalculado = parseFloat((pesoAcumulado + cambioPesoEnEstaFase).toFixed(2));

            datosTabla.push({
                mesesTexto: fase.mesesTexto,
                nombreFase: fase.nombre,
                proteinasPct: fase.macrosBase.proteinasPct,
                proteinas_g_dia: fase.macrosBase.proteinas_g_kg_dia,
                carbohidratosPct: fase.macrosBase.carbohidratosPct,
                carbohidratos_g_dia: fase.macrosBase.carbohidratos_g_kg_dia,
                grasasPct: fase.macrosBase.grasasPct,
                grasas_g_dia: fase.macrosBase.grasas_g_kg_dia,
                pesoInicioFase: pesoInicioFaseCalculado,
                pesoFinFase: pesoFinFaseCalculado,
                objetivoPrincipal: fase.objetivoPrincipal,
                observaciones: fase.observaciones,
                semanasAsignadas: semanasParaEstaFase
            });

            pesoAcumulado = pesoFinFaseCalculado;
        });
    } else if (objetivoActual === 'mantenimiento1') {
        const proporcionTotal = numeroFases === 2 ? 1 + 2 : 1 + 2 + 1;
        const proporcionTotalCorto = 1 + 2;

        fasesParaPlan.forEach((fase, index) => {
            let semanasParaEstaFase;
            if (semanasTotalesEstimadas < 8) {
                if (index > 1) return;
                let factorProporcion;
                switch(index) {
                    case 0: factorProporcion = 1; break;
                    case 1: factorProporcion = 2; break;
                    default: factorProporcion = 1;
                }
                const proporcion = factorProporcion / proporcionTotalCorto;
                semanasParaEstaFase = Math.round(proporcion * semanasTotalesEstimadas);
            } else {
                let factorProporcion;
                switch(index) {
                    case 0: factorProporcion = 1; break;
                    case 1: factorProporcion = 2; break;
                    case 2: factorProporcion = 1; break;
                    default: factorProporcion = 1;
                }
                const proporcion = factorProporcion / proporcionTotal;
                semanasParaEstaFase = Math.round(proporcion * semanasTotalesEstimadas);
            }

            semanasParaEstaFase = Math.max(0, Math.min(semanasParaEstaFase, semanasTotalesEstimadas - semanasAsignadasAcumuladas));
            if (index === numeroFases - 1) {
                semanasParaEstaFase = semanasTotalesEstimadas - semanasAsignadasAcumuladas;
            }

            semanasAsignadasAcumuladas += semanasParaEstaFase;

            let cambioPesoEnEstaFase = 0;
            if (semanasTotalesEstimadas > 0) {
                const proporcionSemanas = semanasParaEstaFase / semanasTotalesEstimadas;
                cambioPesoEnEstaFase = cambioPesoTotal * proporcionSemanas;
            }

            const pesoInicioFaseCalculado = parseFloat(pesoAcumulado.toFixed(2));
            const pesoFinFaseCalculado = parseFloat((pesoAcumulado + cambioPesoEnEstaFase).toFixed(2));

            datosTabla.push({
                mesesTexto: fase.mesesTexto,
                nombreFase: fase.nombre,
                proteinasPct: fase.macrosBase.proteinasPct,
                proteinas_g_dia: fase.macrosBase.proteinas_g_kg_dia,
                carbohidratosPct: fase.macrosBase.carbohidratosPct,
                carbohidratos_g_dia: fase.macrosBase.carbohidratos_g_kg_dia,
                grasasPct: fase.macrosBase.grasasPct,
                grasas_g_dia: fase.macrosBase.grasas_g_kg_dia,
                pesoInicioFase: pesoInicioFaseCalculado,
                pesoFinFase: pesoFinFaseCalculado,
                objetivoPrincipal: fase.objetivoPrincipal,
                observaciones: fase.observaciones,
                semanasAsignadas: semanasParaEstaFase
            });

            pesoAcumulado = pesoFinFaseCalculado;
        });
    } else if (objetivoActual === 'mixto1') {
        console.log("Generando plan para objetivo mixto.");
        const totalDuracionPredeterminada = fasesParaPlan.reduce((acc, f) => acc + f.duracionPredeterminadaSemanas, 0);

        fasesParaPlan.forEach((fase, index) => {
            let semanasParaEstaFase;
            if (totalDuracionPredeterminada > 0) {
                const proporcion = fase.duracionPredeterminadaSemanas / totalDuracionPredeterminada;
                semanasParaEstaFase = Math.round(proporcion * semanasTotalesEstimadas);
            } else {
                semanasParaEstaFase = Math.floor(semanasTotalesEstimadas / numeroFases);
            }

            semanasParaEstaFase = Math.max(0, Math.min(semanasParaEstaFase, semanasTotalesEstimadas - semanasAsignadasAcumuladas));
            if (index === numeroFases - 1) {
                semanasParaEstaFase = semanasTotalesEstimadas - semanasAsignadasAcumuladas;
            }

            semanasAsignadasAcumuladas += semanasParaEstaFase;

            let cambioPesoEnEstaFase = 0;
            if (semanasTotalesEstimadas > 0) {
                const proporcionSemanas = semanasParaEstaFase / semanasTotalesEstimadas;
                cambioPesoEnEstaFase = cambioPesoTotal * proporcionSemanas;
            }

            const pesoInicioFaseCalculado = parseFloat(pesoAcumulado.toFixed(2));
            const pesoFinFaseCalculado = parseFloat((pesoAcumulado + cambioPesoEnEstaFase).toFixed(2));

            datosTabla.push({
                mesesTexto: fase.mesesTexto,
                nombreFase: fase.nombre,
                proteinasPct: fase.macrosBase.proteinasPct,
                proteinas_g_dia: fase.macrosBase.proteinas_g_kg_dia,
                carbohidratosPct: fase.macrosBase.carbohidratosPct,
                carbohidratos_g_dia: fase.macrosBase.carbohidratos_g_kg_dia,
                grasasPct: fase.macrosBase.grasasPct,
                grasas_g_dia: fase.macrosBase.grasas_g_kg_dia,
                pesoInicioFase: pesoInicioFaseCalculado,
                pesoFinFase: pesoFinFaseCalculado,
                objetivoPrincipal: fase.objetivoPrincipal,
                observaciones: fase.observaciones,
                semanasAsignadas: semanasParaEstaFase
            });

            pesoAcumulado = pesoFinFaseCalculado;
        });
    }

    // --- 10. Validar y devolver datos ---
    if (datosTabla.length === 0) {
        console.error("No se generaron datos para la tabla general.");
        return null;
    }

    return datosTabla;
}
/**
 * Genera y muestra el HTML de la Tabla General del Proceso Nutricional.
 * @param {string} contenedorId - El ID del elemento HTML donde se insertará la tabla.
 */
/**
 * Genera y muestra la Tabla General del Proceso Nutricional.
 * @param {string} contenedorId - El ID del elemento HTML donde se insertará la tabla.
 */
/**
 * Genera y muestra la Tabla General del Proceso Nutricional.
 * @param {string} contenedorId - El ID del elemento HTML donde se insertará la tabla.
 */
/**
 * Genera y muestra la Tabla General del Proceso Nutricional.
 * @param {string} contenedorId - El ID del elemento HTML donde se insertará la tabla.
 */
	function mostrarTablaGeneralProceso(contenedorId = 'tablaGeneralProcesoContainer') {
    const contenedor = document.getElementById(contenedorId);
    if (!contenedor) {
        console.error(`No se encontró el contenedor con ID '${contenedorId}' para la Tabla General.`);
        return;
    }

    const datosTabla = generarDatosTablaGeneral();
    if (!datosTabla || datosTabla.length === 0) {
        contenedor.innerHTML = `
            <div class="card-header" style="background-color: #e8f5e9; border-bottom: 1px solid #c8e6c9;">
                <h5>📅 Planificación General del Proceso</h5>
                <p class="mb-0"><small>Basada en tu objetivo y el tiempo estimado del Paso 6.</small></p>
            </div>
            <div class="card-body">
                <p class="info-message">Completa el Paso 6 (Estimación Manual) para generar esta planificación.</p>
            </div>
        `;
        return;
    }

    let htmlCard = `
        <div class="card-header" style="background-color: #e8f5e9; border-bottom: 1px solid #c8e6c9;">
            <h5 class="mb-0">📅 Planificación General del Proceso</h5>
            <p class="mb-0"><small>Basada en tu objetivo y el tiempo estimado del Paso 6.</small></p>
        </div>
        <div class="card-body">
            <div class="table-responsive tabla-planificacion-wrapper">
                <table id="tablaGeneralProceso" class="table table-striped table-bordered align-middle tabla-planificacion">
                    <thead>
                        <tr>
                            <th scope="col">Meses</th>
                            <th scope="col">Fase</th>
                            <th scope="col">% Pt<br><small>(g/día)</small></th>
                            <th scope="col">% CH<br><small>(g/día)</small></th>
                            <th scope="col">% GR<br><small>(g/día)</small></th>
                            <th scope="col">Peso<br><small>Inicio → Fin (kg)</small></th>
                            <th scope="col">Objetivo Principal</th>
                            <th scope="col">Observaciones</th>
                            <th scope="col">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    datosTabla.forEach((faseData, index) => {
        if (faseData.semanasAsignadas === undefined || faseData.semanasAsignadas <= 0) {
            console.warn(`Fase '${faseData.nombreFase}' no tiene semanasAsignadas válido:`, faseData.semanasAsignadas);
            return;
        }

        const pesoInicio = faseData.pesoInicioFase !== undefined ? faseData.pesoInicioFase.toFixed(1) : 'N/A';
        const pesoFin = faseData.pesoFinFase !== undefined ? faseData.pesoFinFase.toFixed(1) : 'N/A';

        const datosFaseParaJS = encodeURIComponent(JSON.stringify({
            nombreFase: faseData.nombreFase,
            semanasAsignadas: faseData.semanasAsignadas,
            mesesTexto: faseData.mesesTexto,
            macrosBase: {
                proteinasPct: faseData.proteinasPct,
                carbohidratosPct: faseData.carbohidratosPct,
                grasasPct: faseData.grasasPct
            },
            proteinas_g_dia: faseData.proteinas_g_dia,
            carbohidratos_g_dia: faseData.carbohidratos_g_dia,
            grasas_g_dia: faseData.grasas_g_dia,
            pesoInicioFase: faseData.pesoInicioFase,
            pesoFinFase: faseData.pesoFinFase,
            objetivoPrincipal: faseData.objetivoPrincipal,
            observaciones: faseData.observaciones
        }));

        htmlCard += `
            <tr>
                <td>${faseData.mesesTexto}</td>
                <td><strong>${faseData.nombreFase}</strong></td>
                <td class="text-center">
                    <strong>${faseData.proteinasPct}%</strong><br>
                    <small>${faseData.proteinas_g_dia}g</small>
                </td>
                <td class="text-center">
                    <strong>${faseData.carbohidratosPct}%</strong><br>
                    <small>${faseData.carbohidratos_g_dia}g</small>
                </td>
                <td class="text-center">
                    <strong>${faseData.grasasPct}%</strong><br>
                    <small>${faseData.grasas_g_dia}g</small>
                </td>
                <td class="text-center">
                    <strong>${pesoInicio} → ${pesoFin}</strong><br>
                    <small>(${(faseData.pesoFinFase - faseData.pesoInicioFase).toFixed(1)} kg)</small>
                </td>
                <td>${faseData.objetivoPrincipal}</td>
                <td class="small">${faseData.observaciones}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary ver-detalles-fase-btn" 
                            data-fase-info="${datosFaseParaJS}"
                            onclick="verDetallesFase(this)">Ver Detalles Semanales</button>
                </td>
            </tr>
        `;
    });

    htmlCard += `
                    </tbody>
                </table>
            </div>
            <p class="text-muted small mt-2"><em>* Los valores de gramos por día son estimaciones basadas en el peso inicial de la fase y una aproximación del gasto energético. Pueden variar según la actividad diaria.</em></p>
        </div>
    `;

    contenedor.innerHTML = htmlCard;
}

	/**
	 * Se ejecuta cuando el usuario hace clic en "Ver Detalles Semanales" en la Tabla General.
	 * @param {HTMLElement} boton - El botón que fue clickeado.
	 */
	function verDetallesFase(boton) {
		// Obtener los datos de la fase del atributo data-fase-info
		const datosFaseEncoded = boton.getAttribute('data-fase-info');
		if (!datosFaseEncoded) {
			console.error("No se encontraron datos de fase en el botón.");
			return;
		}

		let datosFase;
		try {
			datosFase = JSON.parse(decodeURIComponent(datosFaseEncoded));
		} catch (e) {
			console.error("Error al parsear datos de fase:", e);
			return;
		}

		console.log("Fase seleccionada para detalles:", datosFase);

		// --- Llamar a la función que generará y mostrará la tabla detallada ---
		// Pasamos los datos de la fase y el ID del contenedor donde se mostrará
		generarYMostrarTablaDetallada(datosFase, 'tablaDetalladaFaseContainer');
	}
/**
 * Genera y muestra la Tabla Detallada por Semanas para una fase específica.
 * @param {Object} datosFase - Los datos de la fase seleccionada desde la Tabla General.
 * @param {string} contenedorId - El ID del elemento HTML donde se insertará la tabla detallada.
 */
/**
 * Genera y muestra la Tabla Detallada por Semanas para una fase específica, con controles interactivos.
 * @param {Object} datosFase - Los datos de la fase seleccionada desde la Tabla General.
 * @param {string} contenedorId - El ID del elemento HTML donde se insertará la tabla detallada.
 */
	/**
 * Genera y muestra la Tabla Detallada por Semanas para una fase específica, con controles interactivos.
 * @param {Object} datosFase - Los datos de la fase seleccionada desde la Tabla General.
 * @param {string} contenedorId - El ID del elemento HTML donde se insertará la tabla detallada.
 */
/**
 * Genera y muestra la Tabla Detallada por Semanas para una fase específica, con controles interactivos.
 * @param {Object} datosFase - Los datos de la fase seleccionada desde la Tabla General.
 * @param {string} contenedorId - El ID del elemento HTML donde se insertará la tabla detallada.
 */
/**
 * Genera y muestra la Tabla Detallada por Semanas para una fase específica, con controles interactivos.
 * @param {Object} datosFase - Los datos de la fase seleccionada desde la Tabla General.
 * @param {string} contenedorId - El ID del elemento HTML donde se insertará la tabla detallada.
 */
function generarYMostrarTablaDetallada(datosFase, contenedorId = 'tablaDetalladaFaseContainer') {
    // --- 1. Validar argumentos ---
    if (!datosFase || typeof datosFase !== 'object') {
        console.error("Error: datosFase no es un objeto válido en generarYMostrarTablaDetallada.", datosFase);
        return;
    }
    if (!contenedorId || typeof contenedorId !== 'string') {
        console.error("Error: contenedorId no es una cadena válida en generarYMostrarTablaDetallada.", contenedorId);
        return;
    }

    // --- 2. Obtener el contenedor donde se mostrará la tabla ---
    const contenedor = document.getElementById(contenedorId);
    if (!contenedor) {
        console.error(`No se encontró el contenedor con ID '${contenedorId}' para la Tabla Detallada.`);
        const errorMsgElement = document.getElementById('errorMessage');
        if (errorMsgElement) {
            errorMsgElement.textContent = `Error: No se encontró el contenedor para mostrar los detalles de la fase.`;
            errorMsgElement.style.display = 'block';
        }
        return;
    }

    // --- 3. Mostrar un mensaje de carga mientras se generan los datos ---
    contenedor.innerHTML = '<p class="info-message">Generando detalles de la fase... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span></p>';
    contenedor.style.display = 'block';

    try {
        // --- 4. Generar los datos para la tabla detallada ---
        const resultadoGeneracion = generarDatosTablaDetallada(datosFase);
        if (!resultadoGeneracion || typeof resultadoGeneracion !== 'object') {
            throw new Error("generarDatosTablaDetallada no devolvió un objeto válido.");
        }

        const datosPorMes = resultadoGeneracion.datosPorMes;
        const estrategiasDisponibles = resultadoGeneracion.estrategiasDisponibles || [];

        if (!Array.isArray(datosPorMes) || datosPorMes.length === 0) {
            throw new Error("No se generaron datos de meses para la tabla detallada o el array está vacío.");
        }

        // --- 5. Construir el HTML del accordion ---
        let htmlTablaDetallada = `
            <div class="card mb-4">
                <div class="card-header" style="background-color: #e8f5e9; border-bottom: 1px solid #c8e6c9;">
                    <h5 class="mb-0">📅 Detalles de la Fase: ${datosFase.nombreFase} (${datosFase.mesesTexto})</h5>
                    <p class="mb-0"><small>Peso estimado: ${datosFase.pesoInicioFase.toFixed(1)} kg → ${datosFase.pesoFinFase.toFixed(1)} kg | Objetivo: ${datosFase.objetivoPrincipal}</small></p>
                </div>
                <div class="card-body">
                    <div class="accordion" id="accordionMeses">
        `;

        datosPorMes.forEach((mesData, mesIndex) => {
            htmlTablaDetallada += `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingMes${mesData.mes}">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#collapseMes${mesData.mes}" aria-expanded="${mesIndex === 0 ? 'true' : 'false'}" 
                                aria-controls="collapseMes${mesData.mes}">
                            Mes ${mesData.mes}
                        </button>
                    </h2>
                    <div id="collapseMes${mesData.mes}" class="accordion-collapse collapse ${mesIndex === 0 ? 'show' : ''}" 
                         aria-labelledby="headingMes${mesData.mes}" data-bs-parent="#accordionMeses">
                        <div class="accordion-body">
                            <div class="accordion" id="accordionSemanasMes${mesData.mes}">
            `;

            mesData.semanas.forEach((semanaData, semanaIndex) => {
                htmlTablaDetallada += `
                    <div class="accordion-item">
                        <h3 class="accordion-header" id="headingSemana${semanaData.semana}">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapseSemana${semanaData.semana}" aria-expanded="${semanaIndex === 0 ? 'true' : 'false'}" 
                                    aria-controls="collapseSemana${semanaData.semana}">
                                Semana ${semanaData.semana} (Peso: ${semanaData.pesoInicioSemana} → ${semanaData.pesoFinSemana} kg)
                            </button>
                        </h3>
                        <div id="collapseSemana${semanaData.semana}" class="accordion-collapse collapse ${semanaIndex === 0 ? 'show' : ''}" 
                             aria-labelledby="headingSemana${semanaData.semana}" data-bs-parent="#accordionSemanasMes${mesData.mes}">
                            <div class="accordion-body">
                                <div class="table-responsive tabla-planificacion-wrapper">
                                    <table id="tablaDetalladaSemana${semanaData.semana}" class="table table-striped table-bordered align-middle tabla-planificacion">
                                        <thead>
                                            <tr>
                                                <th scope="col">Día</th>
                                                <th scope="col">Actividad</th>
                                                <th scope="col">Kcal/dia</th>
                                                <th scope="col">% Pt<br><small>(g/día)</small></th>
                                                <th scope="col">% CH<br><small>(g/día)</small></th>
                                                <th scope="col">% GR<br><small>(g/día)</small></th>
                                                <th scope="col">Peso Estimado (kg)</th>
                                                <th scope="col">Estrategias</th>
                                                <th scope="col">Notas</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                `;

                semanaData.dias.forEach((item, diaIndex) => {
                    const indiceFila = `${mesData.mes}-${semanaData.semana}-${diaIndex}`;
                    const selectActividadHTML = crearSelectActividad(indiceFila, item.actividad);
                    const estrategiasAplicadasArray = item.estrategias.split(', ').map(s => s.trim()).filter(s => s);
                    const selectEstrategiasHTML = crearControlEstrategias(indiceFila, estrategiasAplicadasArray, estrategiasDisponibles);

                    htmlTablaDetallada += `
                        <tr id="fila-detalle-${indiceFila}" data-indice-fila="${indiceFila}">
                            <td>${item.dia}</td>
                            <td>${selectActividadHTML}</td>
                            <td id="calorias-${indiceFila}">${item.calorias}</td>
                            <td class="text-center">
                                <strong>${item.proteinasPct}%</strong><br>
                                <small>${item.proteinas}g</small>
                            </td>
                            <td class="text-center">
                                <strong>${item.carbohidratosPct}%</strong><br>
                                <small>${item.carbohidratos}g</small>
                            </td>
                            <td class="text-center">
                                <strong>${item.grasasPct}%</strong><br>
                                <small>${item.grasas}g</small>
                            </td>
                            <td>${item.pesoEstimado.toFixed(1)}</td>
                            <td>${selectEstrategiasHTML}</td>
                            <td id="notas-${indiceFila}" class="small">${item.notas}</td>
                        </tr>
                    `;
                });

                htmlTablaDetallada += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            htmlTablaDetallada += `
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        htmlTablaDetallada += `
                    </div>
                    <p class="text-muted small mt-2"><em>* Los valores nutricionales se actualizan al cambiar el nivel de actividad o las estrategias. La columna 'Peso Estimado' refleja el valor al inicio de la semana.</em></p>
                </div>
            </div>
        `;

        // --- 6. Insertar el HTML en el contenedor ---
        contenedor.innerHTML = htmlTablaDetallada;
		
		// --- 7. Manual accordion initialization ---
        //new bootstrap.Accordion(document.getElementById('accordionMeses'));

        // --- 7. Adjuntar datos a las tablas para acceso futuro ---
        datosPorMes.forEach((mesData) => {
            mesData.semanas.forEach((semanaData) => {
                const tablaElement = document.getElementById(`tablaDetalladaSemana${semanaData.semana}`);
                if (tablaElement) {
                    tablaElement.datosFaseBase = datosFase;
                    tablaElement.datosFilasOriginales = semanaData.dias;
                    tablaElement.estrategiasDisponibles = estrategiasDisponibles;
                }
            });
        });
    } catch (error) {
        console.error("Error al generar o mostrar la tabla detallada:", error);
        contenedor.innerHTML = `<p class="error-message">❌ Error al generar los detalles para la fase <strong>${datosFase?.nombreFase || 'desconocida'}</strong>: ${error.message}</p>`;
        const errorMsgElement = document.getElementById('errorMessage');
        if (errorMsgElement) {
            errorMsgElement.textContent = `Error al generar la tabla detallada: ${error.message}`;
            errorMsgElement.style.display = 'block';
        }
    }
}
		
		// --- Funciones auxiliares para crear controles interactivos ---

/**
 * Crea el HTML para un desplegable de nivel de actividad.
 * @param {number} indiceFila - El índice de la fila en la tabla.
 * @param {number} actividadSeleccionada - El valor numérico de la actividad actual (e.g., 1.2).
 * @returns {string} El HTML del elemento //select>.
 */
function crearSelectActividad(indiceFila, actividadSeleccionada) {
    // Mapa de valores de actividad a nombres legibles
    const opcionesActividad = {
        1.2: 'Sedentario',
        1.375: 'Ligero (1-3 días/semana)',
        1.55: 'Moderado (3-5 días/semana)',
        1.725: 'Activo (6-7 días/semana)',
        1.9: 'Muy Activo (Intenso/Diario)'
    };

    let opcionesHTML = '';
    for (const [valor, nombre] of Object.entries(opcionesActividad)) {
        const valorNumerico = parseFloat(valor);
        const seleccionado = valorNumerico === actividadSeleccionada ? 'selected' : '';
        opcionesHTML += `<option value="${valorNumerico}" ${seleccionado}>${nombre}</option>`;
    }

    return `
        <select id="select-actividad-${indiceFila}" class="form-select form-select-sm" 
                onchange="actualizarFilaPorActividad(${indiceFila}, this.value)">
            ${opcionesHTML}
        </select>
    `;
}

/**
 * Crea el HTML para un control de estrategias (por ahora un input de texto para simplificar).
 * En una versión más avanzada, podría ser un grupo de checkboxes.
 * @param {number} indiceFila - El índice de la fila en la tabla.
 * @param {Array<string>} estrategiasAplicadas - Las estrategias aplicadas actualmente.
 * @param {Array<string>} estrategiasDisponibles - La lista de todas las estrategias posibles.
 * @returns {string} El HTML del control.
 */
function crearControlEstrategias(indiceFila, estrategiasAplicadas, estrategiasDisponibles) {
    // Por simplicidad, usamos un input de texto. En el futuro se puede cambiar por checkboxes.
    // Para checkboxes, se necesitaría un contenedor y lógica más compleja en `onchange`.
    return `
        <input type="text" id="input-estrategias-${indiceFila}" class="form-control form-control-sm" 
               value="${estrategiasAplicadas.join(', ')}" 
               onchange="actualizarFilaPorEstrategias(${indiceFila}, this.value)" 
               placeholder="Ej: refeed, carb_cycling"
               title="Separa múltiples estrategias con coma. Cambia y presiona Enter.">
        <small class="form-text text-muted">Disponibles: ${estrategiasDisponibles.join(', ')}</small>
    `;
    /*
    // Ejemplo de cómo podría ser con checkboxes (más complejo de implementar)
    // let checkboxesHTML = '';
    // estrategiasDisponibles.forEach(estrategia => {
    //     const checked = estrategiasAplicadas.includes(estrategia) ? 'checked' : '';
    //     checkboxesHTML += `
    //         <div class="form-check form-check-inline">
    //             <input class="form-check-input" type="checkbox" id="chk-${indiceFila}-${estrategia}" 
    //                    value="${estrategia}" ${checked} 
    //                    onchange="manejarCambioCheckboxEstrategia(${indiceFila}, '${estrategia}', this.checked)">
    //             <label class="form-check-label small" for="chk-${indiceFila}-${estrategia}">${estrategia}</label>
    //         </div>
    //     `;
    // });
    // return `<div>${checkboxesHTML}</div>`;
    */
}

		/**
		 * Genera los datos para la Tabla Detallada por Semanas de una fase específica.
		 * @param {Object} datosFase - Los datos de la fase seleccionada.
		 * @returns {Array<Object>} Un array de objetos, cada uno representando un día de una semana.
		 */
		function generarDatosTablaDetallada(datosFase) {
    console.log("1. generarDatosTablaDetallada recibió:", datosFase);
    
    // --- Datos necesarios del contexto global ---
    const pesoInicialFase = datosFase.pesoInicioFase;
    const cambioPesoTotalFase = datosFase.pesoFinFase - datosFase.pesoInicioFase;
    const semanasEnFase = datosFase.semanasAsignadas;
    const nombreFase = datosFase.nombreFase;
    const mesesTexto = datosFase.mesesTexto;

    // --- Validación de semanasAsignadas ---
    if (semanasEnFase === undefined || semanasEnFase === null || semanasEnFase <= 0) {
        console.error("Duración de fase inválida (semanasAsignadas) para generar detalles:", semanasEnFase);
        throw new Error(`Duración de fase inválida: semanasAsignadas=${semanasEnFase}`);
    }

    // --- Calcular cambio de peso por semana ---
    const cambioPesoPorSemana = cambioPesoTotalFase / semanasEnFase;

    // --- Obtener estrategias seleccionadas por el usuario ---
    const estrategiasSeleccionadas = getSelectedStrategies(); // Tu función existente
    const estrategiasDisponibles = [
        'ninguna', 'refeed', 'carb_cycling', 'protein_cycling', 'ckd', 'tkd',
        'if_16_8', 'timing', 'flexible_dieting', 'hiperproteica'
    ];

    // --- Calcular macros base de la fase ---
    const parsearRangoPorcentaje = (rangoStr) => {
        if (!rangoStr || typeof rangoStr !== 'string') return [25, 25];
        const partes = rangoStr.replace('%', '').split('-').map(Number);
        return partes.length === 2 ? partes : [partes[0], partes[0]];
    };

    let rangoProteinasPct = [25, 25];
    let rangoCarbohidratosPct = [40, 40];
    let rangoGrasasPct = [35, 35];
    try {
        rangoProteinasPct = parsearRangoPorcentaje(datosFase.macrosBase.proteinasPct);
        rangoCarbohidratosPct = parsearRangoPorcentaje(datosFase.macrosBase.carbohidratosPct);
        rangoGrasasPct = parsearRangoPorcentaje(datosFase.macrosBase.grasasPct);
    } catch (e) {
        console.warn("Error al parsear rangos de macros de la fase, usando valores por defecto.", e);
    }

    const proteinasPctPromedio = Math.round((rangoProteinasPct[0] + rangoProteinasPct[1]) / 2);
    const carbohidratosPctPromedio = Math.round((rangoCarbohidratosPct[0] + rangoCarbohidratosPct[1]) / 2);
    const grasasPctPromedio = 100 - proteinasPctPromedio - carbohidratosPctPromedio;

    // --- Determinar meses desde mesesTexto ---
    const meses = mesesTexto.split('–').map(m => parseInt(m.trim()));
    const mesInicio = meses[0];
    const mesFin = meses.length > 1 ? meses[1] : mesInicio;
    const datosPorMes = [];
    let semanaGlobal = 1;

    // --- Iterar por meses ---
    for (let mes = mesInicio; mes <= mesFin; mes++) {
        const semanasEnMes = Math.min(4, semanasEnFase - (semanaGlobal - 1)); // Máximo 4 semanas por mes
        if (semanasEnMes <= 0) break;

        const datosSemanas = [];
        for (let semana = 1; semana <= semanasEnMes; semana++) {
            const pesoEstimadoInicioSemana = pesoInicialFase + (cambioPesoPorSemana * (semanaGlobal - 1));
            const pesoEstimadoFinSemana = pesoEstimadoInicioSemana + cambioPesoPorSemana;
            const datosDias = [];

            // --- Generar datos por día ---
            for (let diaIndex = 0; diaIndex < 7; diaIndex++) {
                const diaNombre = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'][diaIndex];
                const diaNumero = diaIndex + 1;

                // --- Asignar nivel de actividad para este día ---
                const actividadDelDia = userActivityLevel; // Multiplicador (e.g., 1.55)

                // --- Calcular TMB para el peso de esta semana ---
                let tmbAproximado = 0;
                if (userGender === 'male') {
                    tmbAproximado = (10 * pesoEstimadoInicioSemana) + (6.25 * userHeightCm) - (5 * userAge) + 5;
                } else {
                    tmbAproximado = (10 * pesoEstimadoInicioSemana) + (6.25 * userHeightCm) - (5 * userAge) - 161;
                }

                // --- Calcular TDEE para este día ---
                const tdeeDelDia = tmbAproximado * actividadDelDia;

                // --- Calcular calorías objetivo para este día ---
                let caloriasDiarias = tdeeDelDia;
                if (weeklyCalorieDiffManualGlobal !== null) {
                    const ajusteDiarioKcal = weeklyCalorieDiffManualGlobal / 7;
                    caloriasDiarias = tdeeDelDia + ajusteDiarioKcal;
                }

                // --- Valores base de macros para este día ---
                let proteinasPctDia = proteinasPctPromedio;
                let carbohidratosPctDia = carbohidratosPctPromedio;
                let grasasPctDia = grasasPctPromedio;
                let notasEstrategias = [];

                // --- Aplicar modificaciones por estrategias seleccionadas ---
                if (estrategiasSeleccionadas.includes('refeed') && diaNombre === 'Domingo') {
                    carbohidratosPctDia = Math.min(95, carbohidratosPctDia + 20);
                    grasasPctDia = Math.max(5, 100 - proteinasPctDia - carbohidratosPctDia);
                    caloriasDiarias = Math.round(caloriasDiarias * 1.05);
                    notasEstrategias.push('Día de Refeed');
                }

                if (estrategiasSeleccionadas.includes('carb_cycling') && (diaNumero % 2 === 0)) {
                    carbohidratosPctDia = Math.min(90, carbohidratosPctDia + 15);
                    grasasPctDia = Math.max(5, 100 - proteinasPctDia - carbohidratosPctDia);
                    notasEstrategias.push('Día alto en HC (Carb Cycling)');
                }

                if (estrategiasSeleccionadas.includes('protein_cycling') && diaNombre === 'Domingo') {
                    proteinasPctDia = Math.max(15, proteinasPctDia - 10);
                    grasasPctDia = 100 - proteinasPctDia - carbohidratosPctDia;
                    notasEstrategias.push('Día bajo en proteína (Protein Cycling)');
                }

                if (estrategiasSeleccionadas.includes('ckd') && (diaNombre === 'Sábado' || diaNombre === 'Domingo')) {
                    carbohidratosPctDia = Math.min(95, carbohidratosPctDia + 30);
                    grasasPctDia = Math.max(2, 100 - proteinasPctDia - carbohidratosPctDia);
                    caloriasDiarias = Math.round(caloriasDiarias * 1.1);
                    notasEstrategias.push('Día de Carb-Loading (CKD)');
                }

                const diasEntrenoTKD = ['Lunes', 'Miércoles', 'Viernes'];
                if (estrategiasSeleccionadas.includes('tkd') && diasEntrenoTKD.includes(diaNombre)) {
                    carbohidratosPctDia = Math.min(85, carbohidratosPctDia + 10);
                    grasasPctDia = Math.max(5, 100 - proteinasPctDia - carbohidratosPctDia);
                    notasEstrategias.push('Targeted Keto (TKD)');
                }

                if (estrategiasSeleccionadas.includes('if_16_8')) {
                    notasEstrategias.push('IF 16:8 aplicado');
                }
                if (estrategiasSeleccionadas.includes('timing')) {
                    notasEstrategias.push('Timing Nutricional considerado');
                }
                if (estrategiasSeleccionadas.includes('flexible_dieting')) {
                    notasEstrategias.push('Flexible Dieting (80/20)');
                }

                // --- Asegurar que los porcentajes sumen 100% ---
                const totalPct = proteinasPctDia + carbohidratosPctDia + grasasPctDia;
                if (Math.abs(totalPct - 100) > 0.1) {
                    const diff = 100 - totalPct;
                    grasasPctDia += diff;
                    console.warn(`Porcentajes ajustados en Semana ${semanaGlobal}, Día ${diaNombre} para sumar 100%.`);
                }

                // --- Calcular gramos de macros ---
                const proteinas_g = Math.round((caloriasDiarias * proteinasPctDia / 100) / 4);
                const carbohidratos_g = Math.round((caloriasDiarias * carbohidratosPctDia / 100) / 4);
                const grasas_g = Math.round((caloriasDiarias * grasasPctDia / 100) / 9);

                // --- Asegurar un mínimo de calorías por seguridad ---
                const limiteCaloriasMin = userGender === 'female' ? 1200 : 1500;
                if (caloriasDiarias < limiteCaloriasMin) {
                    console.warn(`Calorías ajustadas en Semana ${semanaGlobal}, Día ${diaNombre} por debajo del límite (${limiteCaloriasMin}).`);
                    caloriasDiarias = limiteCaloriasMin;
                }

                // --- Generar notas para este día ---
                let notasDia = `Basado en TDEE estimado (${tdeeDelDia.toFixed(0)} kcal) y ajuste objetivo.`;
                if (weeklyCalorieDiffManualGlobal !== null) {
                    notasDia += ` Ajuste diario: ${weeklyCalorieDiffManualGlobal > 0 ? '+' : ''}${(weeklyCalorieDiffManualGlobal / 7).toFixed(0)} kcal.`;
                }
                if (notasEstrategias.length > 0) {
                    notasDia += ` Estrategias aplicadas: ${notasEstrategias.join(', ')}.`;
                }

                // --- Añadir datos del día ---
                datosDias.push({
                    dia: diaNombre,
                    actividad: actividadDelDia,
                    calorias: Math.round(caloriasDiarias),
                    proteinasPct: Math.round(proteinasPctDia),
                    carbohidratosPct: Math.round(carbohidratosPctDia),
                    grasasPct: Math.round(grasasPctDia),
                    proteinas: proteinas_g,
                    carbohidratos: carbohidratos_g,
                    grasas: grasas_g,
                    pesoEstimado: pesoEstimadoInicioSemana,
                    estrategias: notasEstrategias.join(', '),
                    notas: notasDia
                });
            }

            datosSemanas.push({
                semana: semanaGlobal,
                pesoInicioSemana: parseFloat(pesoEstimadoInicioSemana.toFixed(2)),
                pesoFinSemana: parseFloat(pesoEstimadoFinSemana.toFixed(2)),
                dias: datosDias
            });

            semanaGlobal++;
        }

        datosPorMes.push({
            mes: mes,
            semanas: datosSemanas
        });
    }

    return {
        datosPorMes: datosPorMes,
        estrategiasDisponibles: estrategiasDisponibles
    };
}	
	
///////!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!Ultima seccion Calculos segun Objetivo!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		let chartInstance = null;
    	let weeklyMacros = [];

    function toggleOpcionesObjetivo() {
		const objetivo = document.getElementById('objetivo').value;
		// IDs de las secciones a ocultar/mostrar
		const opciones = {
			'perdida1': 'opcionesPerdida1',
			'ganancia1': 'opcionesGanancia1',
			'mantenimiento1': 'opcionesMantenimiento1',
			'mixto1': 'opcionesMixto1'
		};

		// Ocultar todas las secciones primero
		Object.values(opciones).forEach(id => {
			const elemento = document.getElementById(id);
			if (elemento) {
				elemento.style.display = 'none';
			} else {
				console.warn(`Elemento con ID '${id}' no encontrado.`);
			}
		});

		
			Object.values(opciones).forEach(id => document.getElementById(id).style.display = 'none');
			if (opciones[objetivo]) document.getElementById(opciones[objetivo]).style.display = 'block';

			// Resetear checkboxes
			document.querySelectorAll('.strategy-checkboxes input[type="checkbox"]').forEach(checkbox => {
				checkbox.checked = checkbox.value === 'ninguna';
			});
   } 

    
		function validarEntradas() {
			let valido = true;

			// Verificar suma de macros = 100%
			const p = parseInt(document.getElementById("protein-percentage")?.value || 0);
			const c = parseInt(document.getElementById("carb-percentage")?.value || 0);
			const f = parseInt(document.getElementById("fat-percentage")?.value || 0);
			const total = p + c + f;

			const errorMacros = document.getElementById("errorMacros");
			if (total !== 100) {
				valido = false;
				if (errorMacros) {
					errorMacros.style.display = "block";
					errorMacros.innerText = "⚠️ La suma de macronutrientes debe ser 100% (actual: " + total + "%).";
				} else {
					console.warn("Falta el contenedor #errorMacros en el HTML");
				}
			} else if (errorMacros) {
				errorMacros.style.display = "none";
			}

			// Validar distribución de comidas = 100%
			const b = parseInt(document.getElementById("breakfast-perc")?.value || 0);
			const s1 = parseInt(document.getElementById("snack1-perc")?.value || 0);
			const l = parseInt(document.getElementById("lunch-perc")?.value || 0);
			const s2 = parseInt(document.getElementById("snack2-perc")?.value || 0);
			const d = parseInt(document.getElementById("dinner-perc")?.value || 0);
			const totalMeals = b + s1 + l + s2 + d;

			const errorMeals = document.getElementById("errorMeals");
			if (totalMeals !== 100) {
				valido = false;
				if (errorMeals) {
					errorMeals.style.display = "block";
					errorMeals.innerText = "⚠️ La distribución de comidas debe sumar 100% (actual: " + totalMeals + "%).";
				} else {
					console.warn("Falta el contenedor #errorMeals en el HTML");
				}
			} else if (errorMeals) {
				errorMeals.style.display = "none";
			}

			return valido;
		}

				

			function calcularTMB(peso, altura, edad, sexo) {
			return sexo === 'Masculino' ? 10 * peso + 6.25 * altura - 5 * edad + 5 : 10 * peso + 6.25 * altura - 5 * edad - 161;
		}

		//function getSelectedStrategies(prefix) {
			//return Array.from(document.querySelectorAll(`#${prefix} input[type="checkbox"]:checked`)).map(checkbox => checkbox.value).filter(val => val !== 'ninguna');
		//}
		
		// Corregido: Asegurarse de que el contenedor tiene un ID único y se usa correctamente
		//function getSelectedStrategies(containerId) {
	    // Selecciona checkboxes dentro del contenedor específico
	   // const container = document.getElementById(containerId);
	   // if (!container) {
	       // console.warn(`Contenedor ${containerId} no encontrado para estrategias.`);
	       // return ['ninguna']; // Valor por defecto si no se encuentra
	    //}
	   // const checkedBoxes = container.querySelectorAll('input[type="checkbox"]:checked');
	    //const strategies = Array.from(checkedBoxes).map(checkbox => checkbox.value).filter(val => val !== 'ninguna');
	   // return strategies.length > 0 ? strategies : ['ninguna'];
	//}
		/**
	 * Obtiene las estrategias seleccionadas según el objetivo.
	 * @returns {Array<string>} Un array con los valores de las estrategias seleccionadas.
	 *                          Si no hay ninguna seleccionada (además de 'ninguna'), devuelve ['ninguna'].
	 */
			function getSelectedStrategies() {
			    const objetivo = document.getElementById('objetivo').value;
			    let containerId = '';
			
			    // Determinar el ID del contenedor de checkboxes basado en el objetivo
			    switch (objetivo) {
			        case 'perdida1':
			            containerId = 'opcionesPerdida1';
			            break;
			        case 'ganancia1':
			            containerId = 'opcionesGanancia1';
			            break;
			        case 'mantenimiento1':
			            containerId = 'opcionesMantenimiento1';
			            break;
			        case 'mixto1':
			            containerId = 'opcionesMixto1';
			            break;
			        default:
			            console.warn('Objetivo no reconocido para obtener estrategias:', objetivo);
			            return ['ninguna'];
			    }
			
			    // Seleccionar el contenedor
			    const container = document.getElementById(containerId);
			    if (!container) {
			        console.error(`Contenedor de estrategias '${containerId}' no encontrado.`);
			        return ['ninguna'];
			    }
			
			    // Obtener checkboxes marcados dentro del contenedor
			    const checkedBoxes = container.querySelectorAll('input[type="checkbox"]:checked');
			    
			    // Extraer los valores, excluyendo 'ninguna'
			    const strategies = Array.from(checkedBoxes)
			        .map(checkbox => checkbox.value)
			        .filter(val => val !== 'ninguna');
			
			    // Si no hay estrategias seleccionadas (además de 'ninguna'), devolver ['ninguna']
			    return strategies.length > 0 ? strategies : ['ninguna'];
			}	

				/**
			 * Calcula los macronutrientes basados en objetivo, fase y estrategias.
			 * @param {number} peso - El peso del usuario en kg.
			 * @param {number} gastoEnergetico - El TDEE (Gasto Energético Total) calculado.
			 * @param {string} objetivo - El objetivo seleccionado ('perdida1', 'ganancia1', etc.).
			 * @returns {Object|null} Un objeto con los resultados del cálculo o null si hay error.
			 */
		function formatearNombreCodigo(codigo) {
			const mapaCodigos = {
				// Objetivos
				'perdida1': 'pérdida de peso',
				'ganancia1': 'ganancia de peso',
				'mantenimiento1': 'mantenimiento',
				'mixto1': 'plan mixto',
				'sel': 'no seleccionado',
				// Fases de Pérdida
				'induccion_cetogenica1': 'inducción cetogénica',
				'ciclado_metabolico1': 'ciclado metabólico',
				'transicion_mantenimiento1': 'transición a mantenimiento',
				'ketoadaptation': 'ketoadaptación',
				// Fases de Ganancia
				'volumen1': 'volumen muscular',
				'masa1': 'enfoque en masa muscular',
				// Enfoques de Mantenimiento
				'equilibrio1': 'equilibrio flexible',
				'social1': 'adherencia social',
				// Fases de Mixto (asumiendo que pueden reusar algunos nombres o tienen específicos)
				// Puedes añadir más mapeos aquí si es necesario
				// Por defecto, intentar formatear el código si no está en el mapa
			};

		if (mapaCodigos[codigo]) {
			return mapaCodigos[codigo];
		}

		// Formateo básico por si acaso: reemplazar guiones bajos por espacios y convertir a minúsculas
		// Esto ayuda si se añaden nuevas fases sin actualizar el mapa.
		return codigo ? codigo.replace(/_/g, ' ') : 'no especificado';
	}
					/**
					 * Calcula los macronutrientes basados en objetivo, fase y estrategias.
					 * @param {number} peso - El peso del usuario en kg.
					 * @param {number} gastoEnergetico - El TDEE (Gasto Energético Total) calculado.
					 * @param {string} objetivo - El objetivo seleccionado ('perdida1', 'ganancia1', etc.).
					 * @returns {Object|null} Un objeto con los resultados del cálculo o null si hay error.
					 */
 
				function calcularMacronutrientes(peso, gastoEnergetico, objetivo, fase) {
					// Validar entrada
					if (isNaN(peso) || isNaN(gastoEnergetico) || !objetivo || peso <= 0 || gastoEnergetico <= 0) {
						console.error("Entrada inválida en calcularMacronutrientes", { peso, gastoEnergetico, objetivo, fase });
						return null;
					}

					// === 1. Definir rangos de macronutrientes por OBJETIVO y FASE ===
					const macroRanges = {
						// --- Pérdida de peso ---
						perdida1: { proteinas: [20, 25], carbohidratos: [5, 10], grasas: [70, 75] },
						induccion_cetogenica1: { proteinas: [20, 25], carbohidratos: [5, 10], grasas: [70, 75] },
						ciclado_metabolico1: { proteinas: [22, 28], carbohidratos: [8, 20], grasas: [60, 70] },
						transicion_mantenimiento1: { proteinas: [25, 30], carbohidratos: [20, 25], grasas: [40, 50] },

						// --- Ganancia de peso ---
						ganancia1: { proteinas: [25, 30], carbohidratos: [40, 50], grasas: [25, 35] },
						volumen1: { proteinas: [25, 30], carbohidratos: [40, 50], grasas: [25, 35] },
						masa1: { proteinas: [25, 30], carbohidratos: [35, 45], grasas: [30, 35] },

						// --- Mantenimiento ---
						mantenimiento1: { proteinas: [20, 25], carbohidratos: [35, 45], grasas: [30, 35] },
						equilibrio1: { proteinas: [20, 25], carbohidratos: [35, 45], grasas: [30, 35] },
						social1: { proteinas: [20, 25], carbohidratos: [30, 50], grasas: [25, 40] }, // más flexible

						// --- Mixto/Combinado ---
						mixto1: { proteinas: [20, 25], carbohidratos: [30, 40], grasas: [35, 50] },
						definicion1: { proteinas: [25, 35], carbohidratos: [10, 25], grasas: [40, 55] },
						// 'volumen1' ya está definido arriba
						// 'mantenimiento1' también
					};

					// === 2. Decidir qué código usar: fase > objetivo
					const codigo = fase && fase !== 'sel' && macroRanges[fase] ? fase : objetivo;

					// === 3. Obtener rangos
					const ranges = macroRanges[codigo] || macroRanges[objetivo] || {
						proteinas: [25, 30],
						carbohidratos: [40, 50],
						grasas: [25, 35]
					};

					// === 4. Calcular porcentajes promedio (usamos el valor ajustado ya en gastoEnergetico)
					const proteinasPct = Math.round((ranges.proteinas[0] + ranges.proteinas[1]) / 2);
					const carbohidratosPct = Math.round((ranges.carbohidratos[0] + ranges.carbohidratos[1]) / 2);
					const grasasPct = 100 - proteinasPct - carbohidratosPct;

					// Validar grasas
					if (grasasPct < 15) {
						const diff = 15 - grasasPct;
						carbohidratosPct = Math.max(0, carbohidratosPct - diff);
						grasasPct = 15;
					}

					// === 5. Calorías: usamos el gastoEnergetico (ya ajustado por fase/objetivo)
					const calorias = gastoEnergetico; // ✅ Este es el valor final ajustado

					// === 6. Calcular gramos
					const proteinas = Math.round((calorias * proteinasPct / 100) / 4);
					const carbohidratos = Math.round((calorias * carbohidratosPct / 100) / 4);
					const grasas = Math.round((calorias * grasasPct / 100) / 9);

					// === 7. Validación
					if (isNaN(proteinas) || isNaN(carbohidratos) || isNaN(grasas) || proteinas < 0 || carbohidratos < 0 || grasas < 0) {
						console.error("Errores en cálculo de macros", { calorias, proteinasPct, carbohidratosPct, grasasPct });
						return null;
					}
					const mapaCodigos1 = {
						// Objetivos
						'perdida1': 'pérdida de peso',
						'ganancia1': 'ganancia de peso',
						'mantenimiento1': 'mantenimiento',
						'mixto1': 'plan mixto',
						'sel': 'no seleccionado',
						// Fases de Pérdida
						'induccion_cetogenica1': 'inducción cetogénica',
						'ciclado_metabolico1': 'ciclado metabólico',
						'transicion_mantenimiento1': 'transición a mantenimiento',
						'ketoadaptation': 'ketoadaptación',
						// Fases de Ganancia
						'volumen1': 'volumen muscular',
						'masa1': 'enfoque en masa muscular',
						// Fases de Mantenimiento
						'equilibrio1': 'equilibrio flexible',
						'social1': 'adherencia social'
					};
					// === 8. Recomendaciones personalizadas
					const objetivoLegible = mapaCodigos1[objetivo] || objetivo;
					const faseLegible = mapaCodigos1[codigo] || codigo;

					let recomendaciones = `Basado en tu objetivo de <strong>${objetivoLegible}</strong> y fase <strong>${faseLegible}</strong>.<br><br>`;
					recomendaciones += `<strong>Distribución de macronutrientes:</strong><br>`;
					recomendaciones += `• <strong>Proteínas:</strong> ${proteinasPct}% (${proteinas} g, ${peso ? (proteinas / peso).toFixed(1) : '?'} g/kg)<br>`;
					recomendaciones += `• <strong>Carbohidratos:</strong> ${carbohidratosPct}% (${carbohidratos} g)<br>`;
					recomendaciones += `• <strong>Grasas:</strong> ${grasasPct}% (${grasas} g)<br><br>`;

					// Notas por objetivo
					if (objetivo === 'perdida1') {
						recomendaciones += `<em>Enfoque en preservar masa muscular con proteína adecuada y ajuste progresivo del déficit.</em>`;
					} else if (objetivo === 'ganancia1') {
						recomendaciones += `<em>Superávit controlado para maximizar la hipertrofia con mínimo almacenamiento graso.</em>`;
					} else if (objetivo === 'mantenimiento1') {
						recomendaciones += `<em>Equilibrio sostenible con flexibilidad para mantener adherencia a largo plazo.</em>`;
					} else if (objetivo === 'mixto1') {
						recomendaciones += `<em>Plan cíclico: alterna fases de volumen, definición y mantenimiento para optimizar progresión.</em>`;
					}

					// === 9. Devolver resultados
					return {
						calorias,
						proteinas,
						carbohidratos,
						grasas,
						proteinasPct,
						carbohidratosPct,
						grasasPct,
						recomendaciones,
						faseUsada: faseLegible,
						codigoUsado: codigo
					};
				}


// --- Asegúrate de que getCombinedRangesConModal esté definida en el mismo archivo o cargada antes ---
// Si no la tienes definida por separado, aquí la incluyo para que funcione:

/**
 * (Definición de getCombinedRangesConModal)
 * Esta función debe estar disponible globalmente o definida antes de ser usada por calcularMacronutrientes.
 * Combina los rangos de macronutrientes de múltiples estrategias y maneja incompatibilidades con un modal.
 * @param {Array<string>} strategies - Array de nombres de estrategias seleccionadas.
 * @param {Object} estrategiaMap - El mapa de estrategias con sus rangos.
 * @param {string} contexto - "macros" o "plan" para determinar dónde mostrar el error.
 * @returns {Object|null} Un objeto con los rangos combinados o null si son incompatibles.
 */
function getCombinedRangesConModal(strategies, estrategiaMap, contexto = "plan") {
    if (!strategies || strategies.length === 0 || (strategies.length === 1 && strategies.includes('ninguna'))) {
        return estrategiaMap.ninguna;
    }

    const activeStrats = strategies.filter(s => s !== 'ninguna');
    if (activeStrats.length === 0) return estrategiaMap.ninguna;

    try {
        const combinedRanges = {
            grasas: [
                Math.max(...activeStrats.map(s => estrategiaMap[s].grasas[0])),
                Math.min(...activeStrats.map(s => estrategiaMap[s].grasas[1]))
            ],
            proteinas: [
                Math.max(...activeStrats.map(s => estrategiaMap[s].proteinas[0])),
                Math.min(...activeStrats.map(s => estrategiaMap[s].proteinas[1]))
            ],
            carbohidratos: [
                Math.max(...activeStrats.map(s => estrategiaMap[s].carbohidratos[0])),
                Math.min(...activeStrats.map(s => estrategiaMap[s].carbohidratos[1]))
            ],
            deficit: [ // Para déficit/superávit
                Math.min(...activeStrats.map(s => estrategiaMap[s].deficit[0])),
                Math.max(...activeStrats.map(s => estrategiaMap[s].deficit[1]))
            ],
            notas: activeStrats.map(s => estrategiaMap[s].nota).join('; ')
        };

        // Validar que los rangos combinados sean válidos
        const rangosInvalidos = {};
        let hayIncompatibilidad = false;
        for (const [macro, rango] of Object.entries(combinedRanges)) {
             // 'notas' y 'deficit' no se validan como rangos de porcentajes
             if (macro !== 'notas' && macro !== 'deficit' && rango[0] > rango[1]) {
                 rangosInvalidos[macro] = rango;
                 hayIncompatibilidad = true;
             }
        }

        if (hayIncompatibilidad) {
            console.error('Rangos de macronutrientes incompatibles detectados:', rangosInvalidos);
            // Llamar al modal de incompatibilidad SOLO si es para macros
            if (contexto === "macros") {
                 mostrarModalIncompatibilidad(activeStrats, rangosInvalidos);
            }
            // Devolver null para indicar error al código que llamó a esta función
            return null;
        }

        return combinedRanges;
    } catch (error) {
        console.error('Error al combinar rangos de estrategias:', error, strategies);
        return null;
    }
}

// --- Asegúrate también de que formatearNombreCodigo esté definida ---
// Si no la tienes, aquí la incluyo:

/**
 * Formatea los códigos internos de objetivo y fase a nombres legibles.
 * @param {string} codigo - El código interno (e.g., 'perdida1', 'induccion_cetogenica1').
 * @returns {string} El nombre formateado (e.g., 'pérdida de peso', 'inducción cetogénica').
 */
function formatearNombreCodigo(codigo) {
    const mapaCodigos = {
        // Objetivos
        'perdida1': 'pérdida de peso',
        'ganancia1': 'ganancia de peso',
        'mantenimiento1': 'mantenimiento',
        'mixto1': 'plan mixto',
        'sel': 'no seleccionado',
        // Fases de Pérdida
        'induccion_cetogenica1': 'inducción cetogénica',
        'ciclado_metabolico1': 'ciclado metabólico',
        'transicion_mantenimiento1': 'transición a mantenimiento',
        'ketoadaptation': 'ketoadaptación',
        // Fases de Ganancia
        'volumen1': 'volumen muscular',
        'masa1': 'enfoque en masa muscular',
        // Enfoques de Mantenimiento
        'equilibrio1': 'equilibrio flexible',
        'social1': 'adherencia social',
        // Fases de Mixto
        // Estrategias (si quieres que se formateen en las recomendaciones)
        'ninguna': 'Ninguna',
        'tkd': 'TKD',
        'ckd': 'CKD',
        'if_16_8': 'IF 16:8',
        'refeed': 'Refeed',
        'hiperproteica': 'Hiperproteica',
        'carb_cycling': 'Carb Cycling',
        'protein_cycling': 'Protein Cycling',
        'timing': 'Timing Nutricional',
        'flexible_dieting': 'Flexible Dieting'
        // Por defecto, intentar formatear el código si no está en el mapa
    };

    if (mapaCodigos[codigo]) {
        return mapaCodigos[codigo];
    }
    return codigo ? codigo.replace(/_/g, ' ') : 'no especificado';
}


    function crearGrafico(datos) {
        const ctx = document.getElementById('chartMacros').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Grasas', 'Proteínas', 'Carbohidratos'],
                datasets: [{
                    data: datos,
                    backgroundColor: ['#4CAF50', '#2196F3', '#FF9800'],
                    borderColor: ['#388E3C', '#1976D2', '#F57C00'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#333', font: { size: 12 } } },
                    tooltip: { callbacks: { label: function(context) { return `${context.label}: ${context.raw}%`; } } }
                }
            }
        });
    }

    function actualizarUI(resultados, gastoEnergetico) {
        if (!resultados) return;
        document.getElementById('gastoEnergetico').textContent = gastoEnergetico.toLocaleString('es-ES');
        document.getElementById('calorias').textContent = resultados.calorias.toLocaleString('es-ES');
        document.getElementById('proteinas').textContent = resultados.proteinas;
        document.getElementById('proteinasPct').textContent = resultados.proteinasPct;
        document.getElementById('carbohidratos').textContent = resultados.carbohidratos;
        document.getElementById('carbohidratosPct').textContent = resultados.carbohidratosPct;
        document.getElementById('grasas').textContent = resultados.grasas;
        document.getElementById('grasasPct').textContent = resultados.grasasPct;
        document.getElementById('recomendaciones').innerHTML = resultados.recomendaciones;
        document.getElementById('resultados').style.display = 'block';
        if (typeof Chart !== 'undefined') {
            crearGrafico([resultados.grasasPct, resultados.proteinasPct, resultados.carbohidratosPct]);
        } else {
            console.error('Chart.js no está disponible.');
            document.getElementById('errorMessage').textContent = 'No se pudo cargar el gráfico. Verifique su conexión a internet.';
            document.getElementById('errorMessage').style.display = 'block';
        }
        document.getElementById('planificacionTemporal').style.display = 'block';
        actualizarPlanificacion();
		// Mostrar/Ocultar sección de planificación
    document.getElementById('planificacionTemporal').style.display = 'block';

		// --- NUEVO: Mostrar la Tabla General del Proceso ---
		// Esta función creará/mostrará la tabla general SI los datos del Paso 6 están disponibles
		mostrarTablaGeneralProceso('tablaGeneralProcesoContainer');
		// -----------------------------------------------

		// Actualizar la tabla semanal detallada (la actual)
		actualizarPlanificacion();
    }

    function crearSemana(semanaNum, fase, dieta, estrategias, calorias, proteinasPct, carbohidratosPct, grasasPct, entrenoDias, notas) {
        if (!validarEntradas(parseFloat(document.getElementById('weight').value), parseFloat(document.getElementById('height').value), parseFloat(document.getElementById('age').value), calorias, proteinasPct, carbohidratosPct, grasasPct)) {
            return null;
        }
        const proteinas = Math.round((calorias * proteinasPct / 100) / 4);
        const carbohidratos = Math.round((calorias * carbohidratosPct / 100) / 4);
        const grasas = Math.round((calorias * grasasPct / 100) / 9);
        if (grasas < 0 || isNaN(grasas) || proteinas < 0 || isNaN(proteinas) || carbohidratos < 0 || isNaN(carbohidratos)) {
            document.getElementById('errorMessage').textContent = `Error en Semana ${semanaNum}: Error en el cálculo de macronutrientes. Verifique los valores.`;
            document.getElementById('errorMessage').style.display = 'block';
            return null;
        }
        return { semana: `Sem ${semanaNum}`, fase, dieta, estrategias, calorias, proteinasPct, carbohidratosPct, grasasPct, proteinas, carbohidratos, grasas, entrenoDias, notas };
    }

    // --- Reemplaza tu función generarPlanPerdida actual con esta ---
	function generarPlanPerdida(periodo, peso, gastoEnergetico) {
		const plan = [];
	   
		/// --- 1. Obtener selecciones del usuario ---
		const fasePerdida = document.getElementById('fasePerdida1')?.value || 'induccion_cetogenica1';
		const estrategiasPerdida = getSelectedStrategies(); // Asumiendo que esta función ya maneja el objetivo 'perdida1'
		
		// --- 2. Validación básica ---
		if (!gastoEnergetico || gastoEnergetico <= 0) {
			console.error("Gasto energético inválido para generar plan de pérdida.");
			return plan;
		}
		

    // --- 3. Definir constantes ---
    const semanas = periodo === 'mensual' ? 12 : 4;
    // Mapa de nombres formateados para las fases
    const nombresFase = {
        'induccion_cetogenica1': 'Inducción Cetogénica',
        'ciclado_metabolico1': 'Ciclado Metabólico',
        'transicion_mantenimiento1': 'Transición a Mantenimiento',
        'ketoadaptation': 'Ketoadaptation'
    };
    const nombreFaseLegible = nombresFase[fasePerdida] || 'Fase no especificada';

		// --- 4. Definir el mapa de estrategias (debe coincidir con el de calcularMacronutrientes) ---
    const estrategiaMap = {
        ninguna: { grasas: [70, 75], proteinas: [20, 25], carbohidratos: [5, 10], deficit: [0.8, 0.85], nota: 'Cetosis estricta <50g HC/día' },
        tkd: { grasas: [65, 70], proteinas: [20, 25], carbohidratos: [8, 12], deficit: [0.8, 0.85], nota: '25-50g HC pre/post entreno' },
        ckd: { grasas: [60, 65], proteinas: [20, 25], carbohidratos: [12, 18], deficit: [0.85, 0.9], nota: '2 días carb-loading (150-200g HC)' },
        if_16_8: { grasas: [70, 75], proteinas: [20, 25], carbohidratos: [5, 15], deficit: [0.75, 0.85], nota: 'Ventana de alimentación 8 horas' },
        refeed: { grasas: [60, 65], proteinas: [20, 25], carbohidratos: [12, 18], deficit: [0.9, 0.95], nota: '1-2 días/semana HC alto' },
        hiperproteica: { grasas: [60, 65], proteinas: [28, 32], carbohidratos: [5, 10], deficit: [0.8, 0.85], nota: '2.5-3.0 g/kg peso proteína' },
        carb_cycling: { grasas: [60, 70], proteinas: [22, 28], carbohidratos: [8, 20], deficit: [0.8, 0.9], nota: 'Días altos (100-130g)/bajos HC (<50g)' },
        protein_cycling: { grasas: [60, 70], proteinas: [18, 30], carbohidratos: [5, 15], deficit: [0.8, 0.9], nota: '4 semanas altas + 1 baja proteína' },
        timing: { grasas: [50, 60], proteinas: [28, 35], carbohidratos: [10, 20], deficit: [0.85, 0.9], nota: 'HC post-entreno' },
        flexible_dieting: { grasas: [30, 40], proteinas: [25, 35], carbohidratos: [30, 45], deficit: [0.9, 1.0], nota: '80/20 regla: 80% saludable, 20% flexible' }
    };
	
	
    // --- 5. Definir dietas base ---
    const dietasBase = {
        cetogenica: { nombre: 'Cetogénica', proteinasPct: 20, carbohidratosPct: 5, grasasPct: 75 },
        hiperproteica_dieta: { nombre: 'Hiperproteica', proteinasPct: 30, carbohidratosPct: 5, grasasPct: 65 }, // Valores base
        // Las demás se derivarán de las estrategias o se usarán valores por defecto
        flexible_dieting: { nombre: 'Flexible Dieting', proteinasPct: 25, carbohidratosPct: 40, grasasPct: 35 },
        carb_cycling: { nombre: 'Carb Cycling', proteinasPct: 25, carbohidratosPct: 20, grasasPct: 55 } // Valor base, se ajusta
         // Valor base, se ajusta
    };
	
	// --- 6. Determinar la dieta base principal ---
    // Prioridad: Hiperproteica y Protein Cycling como dietas base, luego Carb Cycling, luego Cetogénica por defecto.
    let dietaBaseKey = 'cetogenica'; // Valor por defecto para pérdida de peso
    if (estrategiasPerdida.includes('hiperproteica')) {
        dietaBaseKey = 'hiperproteica_dieta';
        // Esta estrategia define directamente la dieta base como Hiperproteica (2.5-3.0 g/kg peso proteína)
    } else if (estrategiasPerdida.includes('protein_cycling')) {
        dietaBaseKey = 'hiperproteica_dieta'; // Protein Cycling se basa en una dieta hiperproteica
        // La variación de proteína se manejará semana a semana
    } else if (estrategiasPerdida.includes('carb_cycling')) {
			
        dietaBaseKey = 'carb_cycling_dieta';
    } else if (estrategiasPerdida.includes('flexible_dieting')) {
        dietaBaseKey = 'flexible_dieting_dieta';
        // Para Carb Cycling en fase de pérdida, la base puede seguir siendo cetogenica o moderada
        // pero la estrategia implica variar los carbohidratos.
        // Mantenemos cetogenica como base y ajustamos según la estrategia.
        // Si prefieres una base específica para carb cycling, defínela en dietasBase y úsala aquí.
    }
    // Para otras estrategias como 'ninguna', 'if_16_8', 'timing', 'flexible_dieting',
    // la base sigue siendo cetogenica en el contexto de una fase de pérdida de peso cetogénica o similar.
    // Las modificaciones específicas se aplican semana a semana más adelante.

        const nombreDietaBase = dietasBase[dietaBaseKey] ? dietasBase[dietaBaseKey].nombre : dietasBase['cetogenica'].nombre;

	// --- 7. Combinar rangos de estrategias para obtener parámetros base ---
    function getCombinedParams(strategies) {
        if (!strategies || strategies.length === 0 || (strategies.length === 1 && strategies.includes('ninguna'))) {
            return estrategiaMap.ninguna;
        }
        const activeStrats = strategies.filter(s => s !== 'ninguna');
        if (activeStrats.length === 0) return estrategiaMap.ninguna;

        try {
            const combinedRanges = {
                grasas: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].grasas[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].grasas[1]))
                ],
                proteinas: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].proteinas[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].proteinas[1]))
                ],
                carbohidratos: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].carbohidratos[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].carbohidratos[1]))
                ],
                deficit: [
                    Math.min(...activeStrats.map(s => estrategiaMap[s].deficit[0])),
                    Math.max(...activeStrats.map(s => estrategiaMap[s].deficit[1]))
                ],
                notas: activeStrats.map(s => estrategiaMap[s].nota).join('; ')
            };
			
			if (combinedRanges.grasas[0] > combinedRanges.grasas[1] ||
                combinedRanges.proteinas[0] > combinedRanges.proteinas[1] ||
                combinedRanges.carbohidratos[0] > combinedRanges.carbohidratos[1]) {
                console.error('Rangos de macronutrientes incompatibles al generar plan:', combinedRanges);
                return null; // Indicar error
            }
            return combinedRanges;
        } catch (error) {
             console.error('Error al combinar rangos para el plan:', error, strategies);
             return null;
        }
    }
	
	
		const paramsBase = getCombinedParams(estrategiasPerdida);
		if (!paramsBase) {
			// Manejar error
			return plan;
		}

		// --- 8. Generar semanas ---
    for (let i = 0; i < semanas; i++) {
        const semanaNum = i + 1;
        
        // --- Valores iniciales para la semana basados en estrategias combinadas ---
        let faseSemana = nombreFaseLegible;
        let dietaSemana = nombreDietaBase; // Empieza con la dieta base
        let proteinasPct = Math.round((paramsBase.proteinas[0] + paramsBase.proteinas[1]) / 2);
        let carbohidratosPct = Math.round((paramsBase.carbohidratos[0] + paramsBase.carbohidratos[1]) / 2);
        let grasasPct = 100 - proteinasPct - carbohidratosPct; // Asegurar 100%
        
        // Ajustar si grasas es negativo
        if (grasasPct < 0) {
            const diff = -grasasPct;
            carbohidratosPct = Math.max(0, carbohidratosPct - diff);
            grasasPct = 0;
        }

        let calMult = (paramsBase.deficit[0] + paramsBase.deficit[1]) / 2;
        let calorias = Math.round(gastoEnergetico * calMult);
        let entrenoDias = '4 días entreno, 3 días descanso'; // Valor por defecto
        let notasSemana = paramsBase.notas || 'Sin estrategias especiales';
   
		// --- 9. Aplicar modificaciones por estrategias específicas en semanas específicas ---
        
        // --- Refeed Semanal ---
        if (estrategiasPerdida.includes('refeed') && (semanaNum % 4 === 0 || semanaNum === semanas)) {
            // Aumentar carbohidratos, reducir grasas
            carbohidratosPct = Math.min(95, carbohidratosPct + 20); // Ejemplo de ajuste
            grasasPct = Math.max(5, 100 - proteinasPct - carbohidratosPct);
            calMult = Math.min(1.0, calMult * 1.05); // Pequeño aumento de calorías
            calorias = Math.round(gastoEnergetico * calMult);
            dietaSemana = nombresDietas['refeed_dieta']; // Cambiar dieta para la semana
            notasSemana = `Día de Refeed (${carbohidratosPct}% HC). ` + notasSemana;
            entrenoDias = 'Día de Refeed';
        }
        // --- Carb Cycling (ej: semanas pares) ---
        else if (estrategiasPerdida.includes('carb_cycling') && (semanaNum % 2 === 0)) {
            // Día alto en carbohidratos
            carbohidratosPct = Math.min(90, carbohidratosPct + 15); // Ejemplo de ajuste
            grasasPct = Math.max(5, 100 - proteinasPct - carbohidratosPct);
            notasSemana = `Día alto HC (${carbohidratosPct}%). ` + notasSemana;
            entrenoDias = 'Día alto HC';
		}
		// --- Protein Cycling (ej: cada 5 semanas) ---
        else if (estrategiasPerdida.includes('protein_cycling') && (semanaNum % 5 === 0)) {
             // Reducir proteína
             const proteinasPctBaja = Math.max(15, proteinasPct - 10); // Ejemplo de ajuste
             proteinasPct = proteinasPctBaja;
             grasasPct = 100 - proteinasPct - carbohidratosPct; // Recalcular grasas
             notasSemana = `Semana baja proteína (${proteinasPct}%). ` + notasSemana;
             entrenoDias = 'Entreno ligero esta semana';
        }
        // --- CKD (ej: semanas 4, 8, 12) ---
        else if (estrategiasPerdida.includes('ckd') && (semanaNum % 4 === 0)) {
            // Similar a refeed, pero más extremo y específico
            carbohidratosPct = Math.min(95, carbohidratosPct + 30); // Aumento muy alto
            grasasPct = Math.max(2, 100 - proteinasPct - carbohidratosPct);
            calMult = Math.min(1.0, calMult * 1.1); // Aumento de calorías
            calorias = Math.round(gastoEnergetico * calMult);
            dietaSemana = nombresDietas['refeed_dieta']; // Tambien alta en HC
            notasSemana = `CKD - 2 días carb-loading (150-200g HC). ` + notasSemana;
            entrenoDias = '2 días carb-loading';
        }
		
			// --- IF 16:8, TKD, Timing, Flexible Dieting ---
			// Estas estrategias afectan más el timing o la adherencia que los macros brutos semanales.
			// Sus notas ya están incluidas en paramsBase.notas. Podemos enfatizarlas:
			// else if (estrategiasPerdida.includes('if_16_8')) { ... }
			// else if (estrategiasPerdida.includes('tkd')) { ... }
			// else if (estrategiasPerdida.includes('timing')) { ... }
			// else if (estrategiasPerdida.includes('flexible_dieting')) { ... }
			
			// --- 10. Validación final de calorías ---
			// (Opcional, puedes reutilizar la lógica de límites mínimos si la tenías)

			// --- 11. Crear objeto de semana ---
			const semanaObj = crearSemana(
				semanaNum,
				faseSemana, // Fase legible como "Inducción Cetogénica"
				dietaSemana, // Dieta derivada de estrategias como "Hiperproteica"
				estrategiasPerdida.join(', '), // Todas las estrategias aplicables
				calorias,
				proteinasPct,
				carbohidratosPct,
				grasasPct,
				entrenoDias,
				notasSemana // Notas específicas de la semana + generales
			);

			if (semanaObj) {
				plan.push(semanaObj);
			}
		}

		return plan;
	}
		
    
   
function generarPlanGanancia(periodo, peso, gastoEnergetico) {
    const plan = [];
    
    // --- 1. Obtener selecciones del usuario ---
    const estrategiasGanancia = getSelectedStrategies(); // Usar tu función que ya funciona
    // Para ganancia, no hay una "fase" como tal en tu HTML, pero podemos definir un nombre genérico
    const faseGanancia = 'Volumen Muscular'; // O como se defina en tu contexto

    // --- 2. Validación básica ---
    if (!gastoEnergetico || gastoEnergetico <= 0) {
        console.error("Gasto energético inválido para generar plan de ganancia.");
        return plan;
    }

    // --- 3. Definir constantes ---
    const semanas = periodo === 'mensual' ? 12 : 4;

    // --- 4. Definir el mapa de estrategias (debe coincidir con el de calcularMacronutrientes) ---
    const estrategiaMap = {
       
		ninguna: { grasas: [70, 75], proteinas: [20, 25], carbohidratos: [5, 10], deficit: [0.8, 0.85], nota: 'Cetosis estricta <50g HC/día' },
        tkd: { grasas: [65, 70], proteinas: [20, 25], carbohidratos: [8, 12], deficit: [0.8, 0.85], nota: '25-50g HC pre/post entreno' },
        ckd: { grasas: [60, 65], proteinas: [20, 25], carbohidratos: [12, 18], deficit: [0.85, 0.9], nota: '2 días carb-loading (150-200g HC)' },
        if_16_8: { grasas: [70, 75], proteinas: [20, 25], carbohidratos: [5, 15], deficit: [0.75, 0.85], nota: 'Ventana de alimentación 8 horas' },
        refeed: { grasas: [60, 65], proteinas: [20, 25], carbohidratos: [12, 18], deficit: [0.9, 0.95], nota: '1-2 días/semana HC alto' },
        hiperproteica: { grasas: [60, 65], proteinas: [28, 32], carbohidratos: [5, 10], deficit: [0.8, 0.85], nota: '1.8-2.5 g/kg peso proteína' },
        carb_cycling: { grasas: [60, 70], proteinas: [22, 28], carbohidratos: [8, 20], deficit: [0.8, 0.9], nota: 'Días altos (100-130g)/bajos HC (<50g)' },
        protein_cycling: { grasas: [60, 70], proteinas: [18, 30], carbohidratos: [5, 15], deficit: [0.8, 0.9], nota: '4 semanas altas + 1 baja proteína' },
        timing: { grasas: [50, 60], proteinas: [28, 35], carbohidratos: [10, 20], deficit: [0.85, 0.9], nota: 'HC post-entreno' },
        flexible_dieting: { grasas: [30, 40], proteinas: [25, 35], carbohidratos: [30, 45], deficit: [0.9, 1.0], nota: '80/20 regla: 80% saludable, 20% flexible' }
    
    };

    // --- 5. Definir dietas base ---
    const nombresDietas = {
		protein_cycling_dieta: 'Protein Cycling',
		carb_cycling_dieta: 'Carb Cycling',
		hiperproteica_dieta: 'Hiperproteica',
        moderada_en_hc: 'Moderada en HC',
        refeed_dieta: 'Refeed (Alta HC)',
        timing_dieta: 'Timing Nutricional',
        flexible_dieting_dieta: 'Flexible Dieting'
		
    };

    // --- 6. Determinar la dieta base principal ---
    let dietaBaseKey = ' protein_cycling_dieta'; // Valor por defecto para ganancia
    if (estrategiasGanancia.includes('carb_cycling')) {
        dietaBaseKey = 'carb_cycling_dieta';
    } else if (estrategiasGanancia.includes('refeed')) {
        dietaBaseKey = 'refeed_dieta';
    } else if (estrategiasGanancia.includes('timing')) {
        dietaBaseKey = 'timing_dieta';
    } else if (estrategiasGanancia.includes('flexible_dieting')) {
        dietaBaseKey = 'flexible_dieting_dieta';
    }else if (estrategiasGanancia.includes('protein_cycling')) {
        dietaBaseKey = 'moderada_en_hc';
    }
    const nombreDietaBase = nombresDietas[dietaBaseKey] || nombresDietas['protein_cycling_dieta'];

    // --- 7. Combinar rangos de estrategias para obtener parámetros base ---
    function getCombinedParams(strategies) {
        if (!strategies || strategies.length === 0 || (strategies.length === 1 && strategies.includes('ninguna'))) {
            return estrategiaMap.ninguna;
        }
        const activeStrats = strategies.filter(s => s !== 'ninguna');
        if (activeStrats.length === 0) return estrategiaMap.ninguna;

        try {
            const combinedRanges = {
                grasas: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].grasas[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].grasas[1]))
                ],
                proteinas: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].proteinas[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].proteinas[1]))
                ],
                carbohidratos: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].carbohidratos[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].carbohidratos[1]))
                ],
                deficit: [ // En este contexto, deficit es superávit
                    Math.min(...activeStrats.map(s => estrategiaMap[s].deficit[0])),
                    Math.max(...activeStrats.map(s => estrategiaMap[s].deficit[1]))
                ],
                notas: activeStrats.map(s => estrategiaMap[s].nota).join('; ')
            };

            if (combinedRanges.grasas[0] > combinedRanges.grasas[1] ||
                combinedRanges.proteinas[0] > combinedRanges.proteinas[1] ||
                combinedRanges.carbohidratos[0] > combinedRanges.carbohidratos[1]) {
                console.error('Rangos de macronutrientes incompatibles al generar plan de ganancia:', combinedRanges);
                return null;
            }
            return combinedRanges;
        } catch (error) {
            console.error('Error al combinar rangos para el plan de ganancia:', error, strategies);
            return null;
        }
    }

    const paramsBase = getCombinedParams(estrategiasGanancia);
    if (!paramsBase) {
        console.error("No se pudieron combinar los parámetros de las estrategias para el plan de ganancia.");
        return plan;
    }

    // --- 8. Generar semanas ---
    for (let i = 0; i < semanas; i++) {
        const semanaNum = i + 1;
        
        // --- Valores iniciales para la semana basados en estrategias combinadas ---
        let faseSemana = faseGanancia; // 'Volumen Muscular'
        let dietaSemana = nombreDietaBase;
        let proteinasPct = Math.round((paramsBase.proteinas[0] + paramsBase.proteinas[1]) / 2);
        let carbohidratosPct = Math.round((paramsBase.carbohidratos[0] + paramsBase.carbohidratos[1]) / 2);
        let grasasPct = 100 - proteinasPct - carbohidratosPct;
        
        if (grasasPct < 0) {
            const diff = -grasasPct;
            carbohidratosPct = Math.max(0, carbohidratosPct - diff);
            grasasPct = 0;
        }

        let calMult = (paramsBase.deficit[0] + paramsBase.deficit[1]) / 2;
        let calorias = Math.round(gastoEnergetico * calMult);
        let entrenoDias = '4 días entreno, 3 días descanso';
        let notasSemana = paramsBase.notas || 'Sin estrategias especiales';

        // --- 9. Aplicar modificaciones por estrategias específicas en semanas específicas ---
        
        // --- Refeed Semanal ---
        if (estrategiasGanancia.includes('refeed') && (semanaNum % 4 === 0 || semanaNum === semanas)) {
            carbohidratosPct = Math.min(95, carbohidratosPct + 15);
            grasasPct = Math.max(5, 100 - proteinasPct - carbohidratosPct);
            calMult = Math.min(1.25, calMult * 1.05);
            calorias = Math.round(gastoEnergetico * calMult);
            dietaSemana = nombresDietas['refeed_dieta'];
            notasSemana = `Día de Refeed (${carbohidratosPct}% HC). ` + notasSemana;
            entrenoDias = 'Día de Refeed';
        }
        // --- Carb Cycling (ej: semanas pares) ---
        else if (estrategiasGanancia.includes('carb_cycling') && (semanaNum % 2 === 0)) {
            carbohidratosPct = Math.min(90, carbohidratosPct + 10);
            grasasPct = Math.max(5, 100 - proteinasPct - carbohidratosPct);
            notasSemana = `Día alto HC (${carbohidratosPct}%). ` + notasSemana;
            entrenoDias = 'Día alto HC';
        }
        // --- Timing Nutricional ---
        // Se refleja en las notas generales y en la distribución de comidas
        // else if (estrategiasGanancia.includes('timing')) { ... }

        // --- 10. Crear objeto de semana ---
        const semanaObj = crearSemana(
            semanaNum,
            faseSemana,
            dietaSemana,
            estrategiasGanancia.join(', '),
            calorias,
            proteinasPct,
            carbohidratosPct,
            grasasPct,
            entrenoDias,
            notasSemana
        );

        if (semanaObj) {
            plan.push(semanaObj);
        }
    }

    return plan;
}

    function generarPlanMantenimiento(periodo, peso, gastoEnergetico) {
        const plan = [];
        const estrategiasMantenimiento = getSelectedStrategies('opcionesMantenimiento');
        const semanas = periodo === 'mensual' ? 12 : 4;

        const dietas = {
            flexible_dieting: { nombre: 'Flexible Dieting', proteinasPct: 30, carbohidratosPct: 35, grasasPct: 35 },
            if_16_8: { nombre: 'Intermittent Fasting (16:8)', proteinasPct: 25, carbohidratosPct: 30, grasasPct: 45 },
            refeed: { nombre: 'Refeed', proteinasPct: 24, carbohidratosPct: 40, grasasPct: 36 },
            carb_cycling: { nombre: 'Carb Cycling', proteinasPct: 25, carbohidratosPct: 35, grasasPct: 40 }
        };

        const estrategiaMap = {
            ninguna: { dieta: 'flexible_dieting', calMult: 1.0, notas: 'Equilibrio nutricional', entrenoDias: '4 días entreno, 3 días descanso' },
            flexible_dieting: { dieta: 'flexible_dieting', calMult: 1.0, notas: '80/20 regla: 80% saludable, 20% flexible', entrenoDias: '4 días entreno, 3 días descanso' },
            if_16_8: { dieta: 'if_16_8', calMult: 1.0, notas: 'Ventana de alimentación 8 horas', entrenoDias: '4 días entreno, 3 días descanso' },
            refeed: { dieta: 'refeed', calMult: 1.05, notas: 'Días altos HC (150-200g)', entrenoDias: '2 días refeed' },
            carb_cycling: { dieta: 'carb_cycling', calMult: 1.0, notas: 'Días altos/bajos HC', entrenoDias: '4 días entreno, 3 días descanso' }
        };

        for (let semana = 1; semana <= semanas; semana++) {
            let dieta = dietas[estrategiasMantenimiento.length ? estrategiaMap[estrategiasMantenimiento[0]].dieta : 'flexible_dieting'].nombre;
            let estrategias = estrategiasMantenimiento;
            let proteinasPct = dietas[estrategiasMantenimiento.length ? estrategiaMap[estrategiasMantenimiento[0]].dieta : 'flexible_dieting'].proteinasPct;
            let carbohidratosPct = dietas[estrategiasMantenimiento.length ? estrategiaMap[estrategiasMantenimiento[0]].dieta : 'flexible_dieting'].carbohidratosPct;
            let grasasPct = dietas[estrategiasMantenimiento.length ? estrategiaMap[estrategiasMantenimiento[0]].dieta : 'flexible_dieting'].grasasPct;
            let calMult = Math.max(...estrategiasMantenimiento.map(s => estrategiaMap[s].calMult));
            let entrenoDias = estrategiasMantenimiento.map(s => estrategiaMap[s].entrenoDias).join('; ');
            let notas = estrategiasMantenimiento.map(s => estrategiaMap[s].notas).join('; ');

            if (estrategias.includes('refeed') && (semana === 4 || semana === 8 || semana === 12)) {
                dieta = dietas.refeed.nombre;
                proteinasPct = dietas.refeed.proteinasPct;
                carbohidratosPct = dietas.refeed.carbohidratosPct;
                grasasPct = dietas.refeed.grasasPct;
                calMult = 1.05;
                notas = 'Días altos HC (150-200g)' + (notas ? '; ' + notas : '');
                entrenoDias = '2 días refeed';
            } else if (estrategias.includes('carb_cycling') && semana % 2 === 0) {
                dieta = dietas.carb_cycling.nombre;
                proteinasPct = dietas.carb_cycling.proteinasPct;
                carbohidratosPct = 45;
                grasasPct = 30;
                calMult = 1.05;
                notas = 'Días altos HC' + (notas ? '; ' + notas : '');
                entrenoDias = '4 días entreno';
            }

            const semanaObj = crearSemana(semana, 'Mantenimiento', dieta, estrategias.join(', '), Math.round(gastoEnergetico * calMult), proteinasPct, carbohidratosPct, grasasPct, entrenoDias, notas);
            if (semanaObj) plan.push(semanaObj);
        }

        return plan;
    }

    function generarPlanMixto(periodo, peso, gastoEnergetico) {
        const plan = [];
        const estrategiasMixto = getSelectedStrategies('opcionesMixto');
        const semanas = periodo === 'mensual' ? 12 : 4;

        const dietas = {
            moderada: { nombre: 'Moderada en HC', proteinasPct: 25, carbohidratosPct: 45, grasasPct: 30 },
            carb_cycling: { nombre: 'Carb Cycling', proteinasPct: 25, carbohidratosPct: 35, grasasPct: 40 },
            refeed: { nombre: 'Refeed', proteinasPct: 24, carbohidratosPct: 40, grasasPct: 36 },
            timing: { nombre: 'Timing Nutricional', proteinasPct: 28, carbohidratosPct: 35, grasasPct: 37 },
            flexible_dieting: { nombre: 'Flexible Dieting', proteinasPct: 30, carbohidratosPct: 35, grasasPct: 35 }
        };

        const estrategiaMap = {
            ninguna: { dieta: 'moderada', calMult: 1.0, notas: 'Balance nutricional', entrenoDias: '4 días entreno, 3 días descanso' },
            carb_cycling: { dieta: 'carb_cycling', calMult: 1.0, notas: 'Días altos/bajos HC', entrenoDias: '4 días entreno, 3 días descanso' },
            refeed: { dieta: 'refeed', calMult: 1.05, notas: 'Días altos HC (150-200g)', entrenoDias: '2 días refeed' },
            timing: { dieta: 'timing', calMult: 1.0, notas: 'HC post-entreno', entrenoDias: '4 días entreno, 3 días descanso' },
            flexible_dieting: { dieta: 'flexible_dieting', calMult: 1.0, notas: '80/20 regla: 80% saludable, 20% flexible', entrenoDias: '4 días entreno, 3 días descanso' }
        };

        const periodization = [
            { semana: 1, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 2, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 3, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 4, fase: 'Definición', dieta: estrategiasMixto.includes('carb_cycling') ? 'carb_cycling' : 'moderada', estrategias: estrategiasMixto, calMult: 0.85, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 5, fase: 'Definición', dieta: estrategiasMixto.includes('carb_cycling') ? 'carb_cycling' : 'moderada', estrategias: estrategiasMixto, calMult: 0.85, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 6, fase: 'Definición', dieta: estrategiasMixto.includes('carb_cycling') ? 'carb_cycling' : 'moderada', estrategias: estrategiasMixto, calMult: 0.85, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 7, fase: 'Mantenimiento', dieta: 'flexible_dieting', estrategias: estrategiasMixto, calMult: 1.0, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 8, fase: 'Mantenimiento', dieta: 'flexible_dieting', estrategias: estrategiasMixto, calMult: 1.0, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 9, fase: 'Mantenimiento', dieta: 'flexible_dieting', estrategias: estrategiasMixto, calMult: 1.0, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 10, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 11, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 12, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') }
        ];

        for (let semana = 1; semana <= semanas; semana++) {
            let semanaConfig = periodization[semana - 1] || periodization[periodization.length - 1];
            let dieta = dietas[semanaConfig.dieta].nombre;
            let estrategias = semanaConfig.estrategias;
            let proteinasPct = dietas[semanaConfig.dieta].proteinasPct;
            let carbohidratosPct = dietas[semanaConfig.dieta].carbohidratosPct;
            let grasasPct = dietas[semanaConfig.dieta].grasasPct;
            let calMult = semanaConfig.calMult;
            let entrenoDias = semanaConfig.entrenoDias;
            let notas = semanaConfig.notas;

            if (estrategias.includes('refeed') && (semana === 4 || semana === 8 || semana === 12)) {
                dieta = dietas.refeed.nombre;
                proteinasPct = dietas.refeed.proteinasPct;
                carbohidratosPct = dietas.refeed.carbohidratosPct;
                grasasPct = dietas.refeed.grasasPct;
                calMult = 1.05;
                notas = 'Días altos HC (150-200g)' + (notas ? '; ' + notas : '');
                entrenoDias = '2 días refeed';
            } else if (estrategias.includes('carb_cycling') && semana % 2 === 0) {
                dieta = dietas.carb_cycling.nombre;
                proteinasPct = dietas.carb_cycling.proteinasPct;
                carbohidratosPct = 45;
                grasasPct = 30;
                calMult = 1.05;
                notas = 'Días altos HC' + (notas ? '; ' + notas : '');
                entrenoDias = '4 días entreno';
            }

            const semanaObj = crearSemana(semana, semanaConfig.fase, dieta, estrategias.join(', '), Math.round(gastoEnergetico * calMult), proteinasPct, carbohidratosPct, grasasPct, entrenoDias, notas);
            if (semanaObj) plan.push(semanaObj);
        }

        return plan;
    }

  
   function ajustarEntrenoDias(semanaNum, valor) {
        const planificacion = JSON.parse(JSON.stringify(weeklyMacros));
        const semana = planificacion.find(item => item.semana === `Sem ${semanaNum}`);
        if (!semana) return;

        // Actualizar los días de entrenamiento
        semana.entrenoDias = valor;

        weeklyMacros = planificacion;
        actualizarPlanificacion();
    }

    function actualizarPlanificacion() {
        const tbody = document.getElementById('tablaPlanificacionBody');
        tbody.innerHTML = '';
        weeklyMacros.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.semana}</td>
                <td><span class="badge bg-${getBadgeClass(item.fase)}">${item.fase}</span><br><span class="badge bg-${getBadgeClass(item.dieta)}">${item.dieta}</span></td>
                <td><span class="badge bg-${getBadgeClass(item.estrategias)}">${item.estrategias || 'Ninguna'}</span></td>
                <td>${item.calorias.toLocaleString('es-ES')}</td>
                <td><input type="number" class="macro-input form-control" value="${item.proteinasPct}" min="0" max="100" oninput="ajustarMacros(${item.semana.replace('Sem ', '')}, 'proteinas', this.value)"></td>
                <td><input type="number" class="macro-input form-control" value="${item.carbohidratosPct}" min="0" max="100" oninput="ajustarMacros(${item.semana.replace('Sem ', '')}, 'carbohidratos', this.value)"></td>
                <td><input type="number" class="macro-input form-control" value="${item.grasasPct}" min="0" max="100" oninput="ajustarMacros(${item.semana.replace('Sem ', '')}, 'grasas', this.value)"></td>
                <td>${isNaN(item.proteinas) ? '-' : item.proteinas}</td>
                <td>${isNaN(item.carbohidratos) ? '-' : item.carbohidratos}</td>
                <td>${isNaN(item.grasas) ? '-' : item.grasas}</td>
                <td>
                    <select class="form-control" onchange="ajustarEntrenoDias(${item.semana.replace('Sem ', '')}, this.value)">
                        <option value="0 días entreno" ${item.entrenoDias === '0 días entreno' ? 'selected' : ''}>0 días</option>
                        <option value="1 día entreno, 6 días descanso" ${item.entrenoDias === '1 día entreno, 6 días descanso' ? 'selected' : ''}>1 día</option>
                        <option value="2 días entreno, 5 días descanso" ${item.entrenoDias === '2 días entreno, 5 días descanso' ? 'selected' : ''}>2 días</option>
                        <option value="3 días entreno, 4 días descanso" ${item.entrenoDias === '3 días entreno, 4 días descanso' ? 'selected' : ''}>3 días</option>
                        <option value="4 días entreno, 3 días descanso" ${item.entrenoDias === '4 días entreno, 3 días descanso' ? 'selected' : ''}>4 días</option>
                        <option value="5 días entreno, 2 días descanso" ${item.entrenoDias === '5 días entreno, 2 días descanso' ? 'selected' : ''}>5 días</option>
                        <option value="6 días entreno, 1 día descanso" ${item.entrenoDias === '6 días entreno, 1 día descanso' ? 'selected' : ''}>6 días</option>
                        <option value="7 días entreno" ${item.entrenoDias === '7 días entreno' ? 'selected' : ''}>7 días</option>
                    </select>
                </td>
                <td class="strategy-note">${item.notas}</td>
            `;
            tbody.appendChild(row);
            // Agregar div de error para cada fila
            const errorDiv = document.createElement('div');
            errorDiv.id = `errorMessageSem${item.semana.replace('Sem ', '')}`;
            errorDiv.className = 'alert alert-danger mt-2';
            errorDiv.style.display = 'none';
            row.appendChild(errorDiv);
        });
    }



    function ajustarMacros(semanaNum, macro, valor) {
        const planificacion = JSON.parse(JSON.stringify(weeklyMacros));
        const semana = planificacion.find(item => item.semana === `Sem ${semanaNum}`);
        if (!semana) return;

        // Actualizar el porcentaje según el macro ajustado
        if (macro === 'proteinas') semana.proteinasPct = parseInt(valor) || 0;
        if (macro === 'carbohidratos') semana.carbohidratosPct = parseInt(valor) || 0;
        if (macro === 'grasas') semana.grasasPct = parseInt(valor) || 0;

        // Calcular gramos de macronutrientes basados en los porcentajes actuales
        semana.proteinas = Math.round((semana.calorias * semana.proteinasPct / 100) / 4);
        semana.carbohidratos = Math.round((semana.calorias * semana.carbohidratosPct / 100) / 4);
        semana.grasas = Math.round((semana.calorias * semana.grasasPct / 100) / 9);

        const errorDiv = document.getElementById(`errorMessageSem${semanaNum}`);
        if (!errorDiv) {
            const newErrorDiv = document.createElement('div');
            newErrorDiv.id = `errorMessageSem${semanaNum}`;
            newErrorDiv.className = 'alert alert-danger mt-2';
            newErrorDiv.style.display = 'none';
            document.getElementById('tablaPlanificacionBody').querySelector(`tr:nth-child(${semanaNum})`).appendChild(newErrorDiv);
        }

        // Validar que los porcentajes sumen 100%
        const totalPct = semana.proteinasPct + semana.carbohidratosPct + semana.grasasPct;
        if (totalPct !== 100) {
            document.getElementById(`errorMessageSem${semanaNum}`).textContent = `Los porcentajes deben sumar 100% (actual: ${totalPct}%).`;
            document.getElementById(`errorMessageSem${semanaNum}`).style.display = 'block';
            return;
        } else {
            document.getElementById(`errorMessageSem${semanaNum}`).style.display = 'none';
        }

        const dietaRanges = {
            'Cetogénica': { carbohidratos: [5, 20], proteinas: [20, 35], grasas: [55, 75] },
            'Hiperproteica': { carbohidratos: [40, 50], proteinas: [25, 35], grasas: [30, 40] },
            'Carb Cycling': { carbohidratos: [20, 50], proteinas: [20, 35], grasas: [30, 60] },
            'Intermittent Fasting (16:8)': { carbohidratos: [5, 40], proteinas: [20, 35], grasas: [35, 75] },
            'Refeed': { carbohidratos: [20, 50], proteinas: [20, 32], grasas: [30, 60] },
            'Ketoadaptation': { carbohidratos: [5, 25], proteinas: [18, 30], grasas: [55, 75] },
            'Flexible Dieting': { carbohidratos: [25, 45], proteinas: [25, 40], grasas: [30, 50] },
            'Moderada en HC': { carbohidratos: [25, 45], proteinas: [20, 30], grasas: [30, 40] },
            'Timing Nutricional': { carbohidratos: [10, 20], proteinas: [28, 35], grasas: [50, 60] }
        };

        // Validar límite de proteínas (2.5 g/kg) para días altos de proteína
        const peso = parseFloat(document.getElementById('weight').value);
        const isHighProtein = semana.dieta === 'Hiperproteica' || semana.estrategias.includes('hiperproteica');
        if (isHighProtein && !isNaN(peso) && semana.proteinas > 2.5 * peso) {
            document.getElementById(`errorMessageSem${semanaNum}`).textContent = `Error en Semana ${semanaNum}: Las proteínas no deben exceder 2.5 g/kg de peso corporal (${(2.5 * peso).toFixed(1)} g).`;
            document.getElementById(`errorMessageSem${semanaNum}`).style.display = 'block';
            return;
        }

        // Validar rangos de macronutrientes
        const combinedRanges = dietaRanges[semana.dieta];
        if (
            semana.carbohidratosPct < combinedRanges.carbohidratos[0] || semana.carbohidratosPct > combinedRanges.carbohidratos[1] ||
            semana.proteinasPct < combinedRanges.proteinas[0] || semana.proteinasPct > combinedRanges.proteinas[1] ||
            semana.grasasPct < combinedRanges.grasas[0] || semana.grasasPct > combinedRanges.grasas[1]
        ) {
            document.getElementById(`errorMessageSem${semanaNum}`).textContent = `Error en Semana ${semanaNum}: Los porcentajes deben estar dentro de los rangos de ${semana.dieta} (Carbohidratos: ${combinedRanges.carbohidratos.join('-')}%, Proteínas: ${combinedRanges.proteinas.join('-')}%, Grasas: ${combinedRanges.grasas.join('-')}%).`;
            document.getElementById(`errorMessageSem${semanaNum}`).style.display = 'block';
            return;
        }

        if (semana.calorias < (document.getElementById('gender').value === 'Femenino' ? 1200 : 1500)) {
            document.getElementById(`errorMessageSem${semanaNum}`).textContent = `Error en Semana ${semanaNum}: Las calorías no pueden ser inferiores a ${document.getElementById('gender').value === 'Femenino' ? 1200 : 1500} kcal sin supervisión médica.`;
            document.getElementById(`errorMessageSem${semanaNum}`).style.display = 'block';
            return;
        }

        weeklyMacros = planificacion;
        actualizarPlanificacion();
    }



    function getBadgeClass(faseOrDieta) {
        const badgeClasses = {
            'Inducción Cetogénica': 'danger',
            'Ciclado Metabólico': 'warning',
            'Transición a Mantenimiento': 'success',
            'Ketoadaptation': 'info',
            'Volumen': 'primary',
            'Definición': 'info',
            'Mantenimiento': 'secondary',
            'Cetogénica': 'danger',
            'Hiperproteica': 'primary',
            'Carb Cycling': 'warning',
            'Intermittent Fasting (16:8)': 'info',
            'Refeed': 'success',
            'Flexible Dieting': 'secondary',
            'Moderada en HC': 'success',
            'Timing Nutricional': 'primary',
            'ninguna': 'secondary',
            'tkd': 'danger',
            'ckd': 'warning',
            'if_16_8': 'info',
            'refeed': 'success',
            'hiperproteica': 'primary',
            'carb_cycling': 'warning',
            'protein_cycling': 'primary',
            'timing': 'info',
            'flexible_dieting': 'secondary',
            'ketoadaptation_tkd': 'danger',
            'ketoadaptation_if': 'info',
            'ketoadaptation_refeed': 'success',
            'ketoadaptation_protein_cycling': 'primary'
        };
        return badgeClasses[faseOrDieta] || 'secondary';
    }

		 function calcularTMB(peso, altura, edad, sexo) {
				// Calculates TMB using Mifflin-St Jeor equation
				// peso: kilograms, altura: centimeters, edad: years
				return sexo === 'Masculino' ? 10 * peso + 6.25 * altura - 5 * edad + 5 : 10 * peso + 6.25 * altura - 5 * edad - 161;
			}

       //// CALCULAR MACROS -1º MODAL SEGUNDO AUTOMATICA///////////////////////////////////////


			function calcularMacros(useManual = false) {
    // Debug: Log all required elements
    console.log('Checking DOM elements:');
    const ids = ['weight', 'height', 'age', 'gender', 'activity', 'objetivo', 'periodoPlanificacion'];
    ids.forEach(id => {
        console.log(`${id} element:`, document.getElementById(id));
    });

	if (typeof window.macrosConfiguracionManual === 'undefined') {
		window.macrosConfiguracionManual = {};
	}
    // Retry if activity-level is not found (dynamic content)
    const activitySelect = document.getElementById('activity');
    if (!activitySelect) {
        console.warn('activity-level not found. Retrying in 100ms...');
        return;
    }

    // Check all required DOM elements
    for (const id of ids) {
        const element = document.getElementById(id);
        if (!element) {
            console.error(`Element with ID "${id}" not found.`);
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) {
                errorMessage.textContent = `Error: No se encontró el elemento con ID "${id}".`;
                errorMessage.style.display = 'block';
            }
            return;
        }
    }

    // Patch <select id="activity-level"> options
    activitySelect.innerHTML = `
        <option value="1.2">Sedentario (poco o nada)</option>
        <option value="1.375">Ligero (1-3 días/semana)</option>
        <option value="1.55" selected>Moderado (3-5 días/semana)</option>
        <option value="1.725">Activo (6-7 días/semana)</option>
        <option value="1.9">Muy activo (entrenamiento intenso)</option>
    `;

    // Get values from form
    const peso = parseFloat(document.getElementById('weight').value);
    const height = parseFloat(document.getElementById('height').value);
    const altura = height * 100; // Convert to centimeters
    const edad = parseInt(document.getElementById('age').value);
    const sexo = document.getElementById('gender').value;
    const actividad = parseFloat(document.getElementById('activity').value);
    const objetivo = document.getElementById('objetivo').value;

    // --- Validación de fase seleccionada ---
    let faseValida = true;
    let nombreSelectFase = '';

    switch (objetivo) {
        case 'perdida1':
            const fasePerdida = document.getElementById('fasePerdida1')?.value;
            if (!fasePerdida || fasePerdida.startsWith('sel')) {
                faseValida = false;
                nombreSelectFase = 'Fase de Pérdida de Peso';
            }
            break;
        case 'ganancia1':
            const faseGanancia = document.getElementById('faseGanancia1')?.value;
            if (!faseGanancia || faseGanancia.startsWith('sel')) {
                faseValida = false;
                nombreSelectFase = 'Fase de Ganancia de Peso';
            }
            break;
        case 'mantenimiento1':
            const enfoqueMantenimiento = document.getElementById('enfoqueMantenimiento1')?.value;
            if (!enfoqueMantenimiento || enfoqueMantenimiento.startsWith('sel')) {
                faseValida = false;
                nombreSelectFase = 'Enfoque de Mantenimiento';
            }
            break;
        case 'mixto1':
            const faseMixto = document.getElementById('faseMixto1')?.value;
            if (!faseMixto || faseMixto.startsWith('sel')) {
                faseValida = false;
                nombreSelectFase = 'Fase del Plan Mixto';
            }
            break;
        default:
            break;
    }

    if (!faseValida) {
        const errorMsg = `Por favor, selecciona una opción válida en "${nombreSelectFase}" antes de calcular.`;
        console.error(errorMsg);
        const errorMsgElement = document.getElementById('errorMessage');
        if (errorMsgElement) {
            errorMsgElement.textContent = errorMsg;
            errorMsgElement.style.display = 'block';
        }
        return;
    }

    // Validate inputs
    if (isNaN(peso) || isNaN(altura) || isNaN(edad) || !sexo || isNaN(actividad) || !objetivo) {
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
            errorMessage.textContent = 'Por favor, completa todos los campos obligatorios en el Paso 1.';
            errorMessage.style.display = 'block';
        }
        return;
    }

    // Validate activity level
    const validActivityLevels = [1.2, 1.375, 1.55, 1.725, 1.9];
    if (!validActivityLevels.includes(actividad)) {
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
            errorMessage.textContent = 'Nivel de actividad no válido.';
            errorMessage.style.display = 'block';
        }
        console.error("Invalid activity level:", actividad);
        return;
    }

    // === 1. Calcular TMB (Mifflin-St Jeor) ===
    function calcularTMB(peso, altura, edad, sexo) {
        if (isNaN(peso) || isNaN(altura) || isNaN(edad) || !peso || !altura || !edad) return NaN;
        return sexo === 'Masculino'
            ? 10 * peso + 6.25 * altura - 5 * edad + 5
            : 10 * peso + 6.25 * altura - 5 * edad - 161;
    }

    // === 2. Mapa de códigos a nombres legibles ===
    const mapaCodigos1 = {
        'perdida1': 'pérdida de peso',
        'ganancia1': 'ganancia de peso',
        'mantenimiento1': 'mantenimiento',
        'mixto1': 'plan mixto',
        'sel': 'no seleccionado',
        'induccion_cetogenica1': 'inducción cetogénica',
        'ciclado_metabolico1': 'ciclado metabólico',
        'transicion_mantenimiento1': 'transición a mantenimiento',
        'volumen1': 'volumen muscular',
        'masa1': 'enfoque en masa muscular',
        'equilibrio1': 'equilibrio flexible',
        'social1': 'adherencia social'
    };

    // === 3. Reglas de ajuste calórico por objetivo y fase ===
    const reglasTDEE = {
        perdida1: { factor: 0.85, nota: 'Déficit moderado' },
        induccion_cetogenica1: { factor: 0.80, nota: 'Déficit mayor' },
        ciclado_metabolico1: { factor: 0.85, nota: 'Déficit moderado' },
        transicion_mantenimiento1: { factor: 0.95, nota: 'Déficit ligero' },
        ganancia1: { factor: 1.05, nota: 'Superávit controlado' },
        volumen1: { factor: 1.10, nota: 'Superávit alto' },
        masa1: { factor: 1.07, nota: 'Superávit moderado' },
        mantenimiento1: { factor: 1.00, nota: 'Equilibrio' },
        equilibrio1: { factor: 1.00, nota: 'Equilibrio' },
        social1: { factor: 1.00, nota: 'Flexibilidad' },
        mixto1: { factor: 1.02, nota: 'Base para ciclado' }
    };

    // === 4. Función para obtener la fase ===
    function getSelectedPhase(objetivo) {
        switch (objetivo) {
            case 'perdida1': return document.getElementById('fasePerdida1')?.value || 'sel1';
            case 'ganancia1': return document.getElementById('faseGanancia1')?.value || 'sel2';
            case 'mantenimiento1': return document.getElementById('enfoqueMantenimiento1')?.value || 'sel3';
            case 'mixto1': return document.getElementById('faseMixto1')?.value || 'sel4';
            default: return 'sel';
        }
    }

    const faseRaw = getSelectedPhase(objetivo);
    const fase = faseRaw.startsWith('sel') ? 'sel' : faseRaw;

    // === 5. Calcular TMB y TDEE ===
    const tmb = calcularTMB(peso, altura, edad, sexo);
    if (isNaN(tmb) || tmb <= 0) {
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
            errorMessage.textContent = 'Error al calcular el TMB.';
            errorMessage.style.display = 'block';
        }
        return;
    }

    const tdeeBase = tmb * actividad;
    const codigo = fase !== 'sel' ? fase : objetivo;
    const regla = reglasTDEE[codigo] || { factor: 1.0 };
    const gastoEnergetico = Math.round(tdeeBase * regla.factor);

    if (isNaN(gastoEnergetico) || gastoEnergetico <= 0) {
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
            errorMessage.textContent = 'Error al calcular el gasto energético.';
            errorMessage.style.display = 'block';
        }
        return;
    }

    // Guardar en ventana global
    window.tmb = Math.round(tmb);
    window.tdeeBase = Math.round(tdeeBase);
    window.gastoEnergetico = gastoEnergetico;
    window.faseNombre = mapaCodigos1[codigo] || 'Sin fase';
    window.ajusteNota = regla.nota;

    // === 6. Calcular macros: Manual o Automático ===
    let resultados;
	
    if (useManual) {
    const config = window.macrosConfiguracionManual?.[objetivo]?.[fase];
    if (config) {
        console.log("✅ Cálculo MANUAL activado");
        console.log("Objetivo:", objetivo, "Fase:", fase);
        console.log("Config:", config);

        const proteinasPct = parseFloat(config.proteinas);
        const carbohidratosPct = parseFloat(config.carbohidratos);
        if (isNaN(proteinasPct) || isNaN(carbohidratosPct)) {
            console.error("Valores inválidos en config manual:", config);
            resultados = calcularMacronutrientes(peso, gastoEnergetico, objetivo, fase);
        } else {
            const grasasPct = Math.max(10, 100 - proteinasPct - carbohidratosPct);
            const proteinas = Math.round((gastoEnergetico * proteinasPct / 100) / 4);
            const carbohidratos = Math.round((gastoEnergetico * carbohidratosPct / 100) / 4);
            const grasas = Math.round((gastoEnergetico * grasasPct / 100) / 9);

            // Actualizar inputs
            document.getElementById('protein-percentage').value = proteinasPct;
            document.getElementById('carb-percentage').value = carbohidratosPct;
            document.getElementById('fat-percentage').value = grasasPct;

            resultados = {
                calorias: gastoEnergetico,
                proteinas,
                carbohidratos,
                grasas,
                proteinasPct,
                carbohidratosPct,
                grasasPct,
                recomendaciones: `<strong>🎯 Usando tu configuración manual para ${mapaCodigos1[fase] || mapaCodigos1[objetivo]}.</strong>`
            };
        }
    } else {
        console.log("⚠️ No hay configuración manual para este objetivo/fase. Usando automático.");
        resultados = calcularMacronutrientes(peso, gastoEnergetico, objetivo, fase);
    }
} else {
    console.log("📊 Cálculo AUTOMÁTICO activado");
    resultados = calcularMacronutrientes(peso, gastoEnergetico, objetivo, fase);
}

    // === 7. Generar plan semanal ===
    weeklyMacros = [];
    const periodo = document.getElementById('periodoPlanificacion').value;
    switch (objetivo) {
        case 'perdida1':
            weeklyMacros = generarPlanPerdida(periodo, peso, gastoEnergetico);
            break;
        case 'ganancia1':
            weeklyMacros = generarPlanGanancia(periodo, peso, gastoEnergetico);
            break;
        case 'mantenimiento1':
            weeklyMacros = generarPlanMantenimiento(periodo, peso, gastoEnergetico);
            break;
        case 'mixto1':
            weeklyMacros = generarPlanMixto(periodo, peso, gastoEnergetico);
            break;
        default:
            console.log("Objetivo no requiere plan semanal automático.");
            break;
    }

    // === 8. Actualizar UI ===
    actualizarUI(resultados, gastoEnergetico);

    // === 9. Guardar resultados globales ===
    window.macrosResult = resultados;
    window.weeklyMacros = weeklyMacros;
}


		////////////////////////////////////////////////////////////////////////////////
		
			function mostrarFasePorObjetivo(objetivo) {
				// Ocultar todos los selects y labels de fase
				const elementosFase = [
					'fasePerdida1', 'labelFasePerdida1',
					'faseGanancia1', 'labelFaseGanancia1',
					'enfoqueMantenimiento1', 'labelEnfoqueMantenimiento1',
					'faseMixto1', 'labelFaseMixto1'
				];
				
				elementosFase.forEach(id => {
					const elemento = document.getElementById(id);
					if (elemento) {
						elemento.style.display = 'none';
					}
				});

				// Mostrar el select correspondiente al objetivo
				
				switch(objetivo) {
					case 'perdida1':
						if (document.getElementById('fasePerdida1')) {
							document.getElementById('fasePerdida1').style.display = 'block';
							// Asegúrate de que el label también exista
							const label = document.getElementById('labelFasePerdida1');
							if (label) label.style.display = 'block';
						}
						break;
					case 'ganancia1':
						if (document.getElementById('faseGanancia1')) {
							document.getElementById('faseGanancia1').style.display = 'block';
							const label = document.getElementById('labelFaseGanancia1');
							if (label) label.style.display = 'block';
						}
						break;
					case 'mantenimiento1':
						if (document.getElementById('enfoqueMantenimiento1')) {
							document.getElementById('enfoqueMantenimiento1').style.display = 'block';
							const label = document.getElementById('labelEnfoqueMantenimiento1');
							if (label) label.style.display = 'block';
						}
						break;
					case 'mixto1':
						if (document.getElementById('faseMixto1')) {
							document.getElementById('faseMixto1').style.display = 'block';
							const label = document.getElementById('labelFaseMixto1');
							if (label) label.style.display = 'block';
						}
						break;
					case 'sel':
					default:
						// Opcional: Mostrar un mensaje indicando que deben seleccionar un objetivo
						// No es necesario hacer nada aquí ya que todos los selects están ocultos
						break;
				}
			}


				// Función para actualizar los porcentajes de macros según la fase seleccionada
				
				function actualizarMacrosPorFase() {
					const objetivoSelect = document.getElementById('objetivo');
					if (!objetivoSelect) return;
					
					const objetivo = objetivoSelect.value;
					let faseSeleccionada = '';
					
					// Corregido: usar los nuevos valores de objetivo
					if (objetivo === 'perdida1' && document.getElementById('fasePerdida1')) {
						faseSeleccionada = document.getElementById('fasePerdida1').value;
					} else if (objetivo === 'ganancia1' && document.getElementById('faseGanancia1')) {
						faseSeleccionada = document.getElementById('faseGanancia1').value;
					} else if (objetivo === 'mantenimiento1' && document.getElementById('enfoqueMantenimiento1')) {
						faseSeleccionada = document.getElementById('enfoqueMantenimiento1').value;
					} else if (objetivo === 'mixto1' && document.getElementById('faseMixto1')) {
						faseSeleccionada = document.getElementById('faseMixto1').value;
					}
					
					// Definir las distribuciones de macros para cada fase
					
				   const distribuciones = {
						// Pérdida de peso
						'induccion_cetogenica1': { protein: 20, carb: 10, fat: 70 },
						'ciclado_metabolico1': { protein: 25, carb: 20, fat: 55 },
						'transicion_mantenimiento1': { protein: 25, carb: 35, fat: 40 },
						
						// Ganancia de peso
						'volumen1': { protein: 20, carb: 55, fat: 25 },
						'masa1': { protein: 25, carb: 50, fat: 25 },
						
						// Mantenimiento
						'equilibrio1': { protein: 25, carb: 40, fat: 35 },
						'social1': { protein: 25, carb: 45, fat: 30 },
						
						// Mixto
						'volumen1_mixto': { protein: 25, carb: 50, fat: 25 },
						'definicion1': { protein: 30, carb: 25, fat: 45 },
						'mantenimiento1_mixto': { protein: 25, carb: 45, fat: 30 } // Cambiado para evitar conflicto
					};
					
					// Actualizar los valores en los inputs
					
					if (distribuciones[faseSeleccionada]) {
						if (document.getElementById('protein-percentage')) {
							document.getElementById('protein-percentage').value = distribuciones[faseSeleccionada].protein;
						}
						if (document.getElementById('carb-percentage')) {
							document.getElementById('carb-percentage').value = distribuciones[faseSeleccionada].carb;
						}
						if (document.getElementById('fat-percentage')) {
							document.getElementById('fat-percentage').value = distribuciones[faseSeleccionada].fat;
						}
						
						// Opcional: Actualizar el total de porcentajes
						const proteinValue = parseFloat(document.getElementById('protein-percentage').value) || 0;
						const carbValue = parseFloat(document.getElementById('carb-percentage').value) || 0;
						const fatValue = parseFloat(document.getElementById('fat-percentage').value) || 0;
						const total = proteinValue + carbValue + fatValue;
						
						const macroPercentageTotalDiv = document.getElementById('macro-percentage-total');
						if (macroPercentageTotalDiv) {
							macroPercentageTotalDiv.textContent = `Total: ${total}%`;
							macroPercentageTotalDiv.className = total === 100 ? 'total-valid' : 'total-invalid';
						}
					}
				}





		
		document.getElementById('objetivo').addEventListener('change', toggleOpcionesObjetivo);
			
	   document.addEventListener('DOMContentLoaded', () => {
			toggleOpcionesObjetivo();
			if (typeof Chart === 'undefined') {
				console.error('Chart.js no está disponible.');
				document.getElementById('errorMessage').textContent = 'No se pudo cargar Chart.js. Algunas funcionalidades estarán limitadas.';
				document.getElementById('errorMessage').style.display = 'block';
			}
			// Agregar event listeners a los selects de fase
			const selectsFase = ['fasePerdida1', 'faseGanancia1', 'enfoqueMantenimiento1', 'faseMixto1'];
			selectsFase.forEach(selectId => {
				const elemento = document.getElementById(selectId);
				if (elemento) {
					elemento.addEventListener('change', actualizarMacrosPorFase);
				}
		   });
			// Agregar event listener para el cambio de objetivo
			 // Agregar event listener para el cambio de objetivo
			const objetivoSelect = document.getElementById('objetivo');
			if (objetivoSelect) {
				objetivoSelect.addEventListener('change', function() {
					const objetivo = this.value;
					mostrarFasePorObjetivo(objetivo); // ← Descomentado y corregido
					// Aquí también puedes llamar a actualizarMacrosPorFase() si la tienes
				});
			}
		   
		});
// --- Variables Globales para Configuración Manual ---
// Almacena los valores de macros introducidos manualmente por el usuario.
// Formato: { estrategia1: { proteinas: X, carbohidratos: Y, grasas: Z }, estrategia2: {...} }
let macrosConfiguracionManual = {};

/**
 * Muestra el modal de incompatibilidad de estrategias.
 * @param {Array<string>} estrategias - Las estrategias seleccionadas.
 * @param {Object} rangosConflicto - (Opcional) Información detallada de los rangos que causan conflicto.
 */
	function mostrarModalIncompatibilidad(estrategias, rangosConflicto = null) {
		const modal = document.getElementById('modalIncompatibilidad');
		const mensajeElement = document.getElementById('mensajeIncompatibilidad');
		const guiaElement = document.getElementById('guiaCompatibilidad');

		if (!modal || !mensajeElement || !guiaElement) {
			console.error("No se encontraron los elementos del modal de incompatibilidad.");
			// Fallback: mostrar mensaje de error básico
			const errorMsgElement = document.getElementById('errorMessage');
			if (errorMsgElement) {
				errorMsgElement.textContent = 'Las estrategias seleccionadas son incompatibles. Por favor, selecciona una combinación válida.';
				errorMsgElement.style.display = 'block';
			}
			return;
		}

		// 1. Construir mensaje principal
		let mensaje = `<p>Las estrategias que has seleccionado (<strong>${estrategias.join(', ')}</strong>) tienen requerimientos nutricionales contradictorios y no se pueden combinar automáticamente para calcular un rango válido de macronutrientes.</p>`;
		
		// 2. (Opcional) Añadir detalles técnicos si se proporcionan
		if (rangosConflicto) {
			mensaje += `<p><strong>Detalles del conflicto:</strong></p><ul>`;
			for (const [macro, rango] of Object.entries(rangosConflicto)) {
				if (Array.isArray(rango) && rango[0] > rango[1]) {
					 mensaje += `<li><strong>${macro.charAt(0).toUpperCase() + macro.slice(1)}:</strong> Rango resultante inválido [${rango[0]}, ${rango[1]}].</li>`;
				}
			}
			mensaje += `</ul>`;
		}
		mensajeElement.innerHTML = mensaje;

		// 3. Construir guía de compatibilidad
		// Esta es una guía básica. Puedes ampliarla o hacerla más dinámica.
		let guiaHTML = `
			<p><strong>Para el objetivo de Pérdida de Peso:</strong></p>
			<ul>
				<li><code>ninguna</code> + <code>hiperproteica</code></li>
				<li><code>carb_cycling</code> (evitar combinar con <code>refeed</code>)</li>
				<li><code>refeed</code> (evitar combinar con <code>carb_cycling</code>)</li>
				<li><code>flexible_dieting</code> (mejor sin otras estrategias de extremos)</li>
			</ul>
			<p><strong>Para el objetivo de Ganancia de Peso:</strong></p>
			<ul>
				<li><code>ninguna</code> + <code>hiperproteica</code></li>
				<li><code>carb_cycling</code> (evitar combinar con <code>refeed</code>)</li>
				<li><code>refeed</code> (evitar combinar con <code>carb_cycling</code>)</li>
			</ul>
			<p><strong>Para el objetivo de Mantenimiento:</strong></p>
			<ul>
				<li><code>ninguna</code> + <code>flexibilidad_selectiva</code></li>
				<li><code>ciclado_ch_suave</code> (evitar combinar con <code>refeed</code>)</li>
				<li><code>refeed</code> (evitar combinar con <code>ciclado_ch_suave</code>)</li>
			</ul>
			<p><i>Nota: Las estrategias como <code>timing</code>, <code>if_16_8</code>, etc., suelen ser compatibles con varias otras.</i></p>
		`;
		guiaElement.innerHTML = guiaHTML;

		// 4. Mostrar el modal
		modal.style.display = 'flex'; // Usamos flex para centrarlo como en el CSS
	}

/**
 * Cierra un modal específico.
 * @param {string} modalId - El ID del modal a cerrar.
 */
function cerrarModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}

/**
 * Abre el modal de configuración manual de macronutrientes.
 */
	function abrirModalConfiguracionManual() {
		// Primero, cerrar el modal de incompatibilidad
		cerrarModal('modalIncompatibilidad');

		const modal = document.getElementById('modalConfiguracionManual');
		const contenedor = document.getElementById('contenedorEntradasManuales');
		const errorElement = document.getElementById('errorConfiguracionManual');

		if (!modal || !contenedor) {
			console.error("No se encontraron los elementos del modal de configuración manual.");
			return;
		}

		// Limpiar mensajes de error anteriores
		if (errorElement) {
			errorElement.style.display = 'none';
			errorElement.textContent = '';
		}

		// Obtener estrategias seleccionadas
		// Asumimos que getSelectedStrategies() ya sabe cómo obtenerlas basándose en el objetivo actual
		const estrategias = getSelectedStrategies();
		const estrategiasActivas = estrategias.filter(s => s !== 'ninguna');

		if (estrategiasActivas.length === 0) {
			if (errorElement) {
				errorElement.textContent = 'No hay estrategias seleccionadas para configurar.';
				errorElement.style.display = 'block';
			}
			modal.style.display = 'flex';
			return;
		}

		// 1. Generar bloques de entrada para cada estrategia
		contenedor.innerHTML = ''; // Limpiar contenido previo
		estrategiasActivas.forEach(estrategia => {
			const bloqueId = `bloque_${estrategia}`;
			const inputProteinaId = `manual_proteina_${estrategia}`;
			const inputCarbohidratosId = `manual_carbohidratos_${estrategia}`;
			const inputGrasasId = `manual_grasas_${estrategia}`;

			// Intentar obtener valores guardados previamente o usar valores por defecto razonables
			const configGuardada = macrosConfiguracionManual[estrategia];
			const valorProteina = configGuardada?.proteinas ?? 25;
			const valorCarbohidratos = configGuardada?.carbohidratos ?? 40;
			const valorGrasas = configGuardada?.grasas ?? 35;
			const totalInicial = valorProteina + valorCarbohidratos + valorGrasas;

			const bloqueHTML = `
				<div class="bloque-estrategia-manual mb-3 p-3 border rounded" id="${bloqueId}" data-estrategia="${estrategia}">
					<h6>Estrategia: <span class="nombre-estrategia fw-bold">${estrategia}</span></h6>
					<div class="row">
						<div class="col-md-4 mb-2">
							<label for="${inputProteinaId}" class="form-label">Proteína (%)</label>
							<input type="number" class="form-control input-macro-manual" id="${inputProteinaId}" name="${inputProteinaId}" 
								   data-estrategia="${estrategia}" data-macro="proteinas" 
								   min="0" max="100" value="${valorProteina}" required>
						</div>
						<div class="col-md-4 mb-2">
							<label for="${inputCarbohidratosId}" class="form-label">Carbohidratos (%)</label>
							<input type="number" class="form-control input-macro-manual" id="${inputCarbohidratosId}" name="${inputCarbohidratosId}" 
								   data-estrategia="${estrategia}" data-macro="carbohidratos" 
								   min="0" max="100" value="${valorCarbohidratos}" required>
						</div>
						<div class="col-md-4 mb-2">
							<label for="${inputGrasasId}" class="form-label">Grasas (%)</label>
							<input type="number" class="form-control input-macro-manual" id="${inputGrasasId}" name="${inputGrasasId}" 
								   data-estrategia="${estrategia}" data-macro="grasas" 
								   min="0" max="100" value="${valorGrasas}" required>
						</div>
					</div>
					<div class="total-macro-manual mt-2">
						<strong>Total: <span class="valor-total">${totalInicial}</span>%</strong>
						<span class="estado-total text-success" style="${totalInicial === 100 ? 'display:inline;' : 'display:none;'}">✓ Correcto</span>
						<span class="estado-total text-danger" style="${totalInicial !== 100 ? 'display:inline;' : 'display:none;'}">✗ Debe ser 100%</span>
					</div>
				</div>
			`;
			contenedor.insertAdjacentHTML('beforeend', bloqueHTML);
		});

		// 2. Añadir event listeners a los inputs recién creados para validación en tiempo real
		document.querySelectorAll('.input-macro-manual').forEach(input => {
			input.addEventListener('input', function() {
				// Encontrar el bloque padre de esta estrategia
				const bloque = this.closest('.bloque-estrategia-manual');
				if (!bloque) return;

				const estrategia = bloque.dataset.estrategia;
				const inputs = bloque.querySelectorAll('.input-macro-manual');
				let total = 0;
				inputs.forEach(inp => {
					const val = parseInt(inp.value) || 0; // Convertir a número, 0 si NaN
					// Asegurar que esté dentro del rango 0-100
					if (val < 0) inp.value = 0;
					if (val > 100) inp.value = 100;
					total += parseInt(inp.value) || 0;
				});

				const totalElement = bloque.querySelector('.valor-total');
				const estadoCorrecto = bloque.querySelector('.estado-total.text-success');
				const estadoError = bloque.querySelector('.estado-total.text-danger');

				if (totalElement) totalElement.textContent = total;
				if (estadoCorrecto) estadoCorrecto.style.display = total === 100 ? 'inline' : 'none';
				if (estadoError) estadoError.style.display = total !== 100 ? 'inline' : 'none';
			});
		});

		// 3. Mostrar el modal
		modal.style.display = 'flex';
	}

	/**
	 * Valida y aplica la configuración manual de macronutrientes.
	 * Almacena los valores en `macrosConfiguracionManual` y cierra el modal.
	 */
	function aplicarConfiguracionManual() {
		const contenedor = document.getElementById('contenedorEntradasManuales');
		const errorElement = document.getElementById('errorConfiguracionManual');
		const modal = document.getElementById('modalConfiguracionManual');

		if (!contenedor || !errorElement || !modal) {
			console.error("No se encontraron elementos necesarios para aplicar la configuración manual.");
			return;
		}

		// Limpiar mensajes de error
		errorElement.style.display = 'none';
		errorElement.textContent = '';

		// Obtener todos los bloques
		const bloques = contenedor.querySelectorAll('.bloque-estrategia-manual');
		const nuevaConfiguracion = {};

		let todoValido = true;

		bloques.forEach(bloque => {
			const estrategia = bloque.dataset.estrategia;
			const inputProteina = bloque.querySelector(`#manual_proteina_${estrategia}`);
			const inputCarbohidratos = bloque.querySelector(`#manual_carbohidratos_${estrategia}`);
			const inputGrasas = bloque.querySelector(`#manual_grasas_${estrategia}`);

			const p = parseInt(inputProteina.value) || 0;
			const c = parseInt(inputCarbohidratos.value) || 0;
			const g = parseInt(inputGrasas.value) || 0;
			const total = p + c + g;

			if (total !== 100) {
				todoValido = false;
				// Resaltar el bloque con error
				bloque.style.borderColor = '#dc3545'; // Rojo de Bootstrap
				bloque.style.backgroundColor = '#f8d7da'; // Fondo rojo claro
				// Asegurarse de que el mensaje de error del bloque sea visible
				const estadoError = bloque.querySelector('.estado-total.text-danger');
				if (estadoError) estadoError.style.display = 'inline';
			} else {
				// Restaurar estilo si es válido
				bloque.style.borderColor = '';
				bloque.style.backgroundColor = '';
				nuevaConfiguracion[estrategia] = {
					proteinas: p,
					carbohidratos: c,
					grasas: g
				};
			}
		});

		if (!todoValido) {
			errorElement.textContent = 'Por favor, corrige los errores. La suma de macros para cada estrategia debe ser 100%.';
			errorElement.style.display = 'block';
			return;
		}

		// Si todo es válido, almacenar la configuración
		macrosConfiguracionManual = nuevaConfiguracion;
		console.log("Configuración manual aplicada:", macrosConfiguracionManual);

		// Cerrar el modal
		modal.style.display = 'none';

		// Opcional: Mostrar un mensaje de confirmación o disparar el cálculo
		// Por ejemplo, podrías llamar a calcularMacros() aquí si quieres que se recalcule inmediatamente
		// calcularMacros(); 
		// O simplemente mostrar un mensaje
		const confirmMsg = document.getElementById('errorMessage'); // Reusamos el div de error para mensajes
		if (confirmMsg) {
			confirmMsg.textContent = 'Configuración manual de macronutrientes guardada. Puedes ahora calcular tus macros.';
			confirmMsg.className = 'alert alert-success'; // Cambiar clase para que parezca éxito
			confirmMsg.style.display = 'block';
			// Opcional: ocultar el mensaje después de unos segundos
			// setTimeout(() => { confirmMsg.style.display = 'none'; }, 5000);
		}
	}

	// /////////modal macros/////////////////////////////////


const mapaCodigos2= {
						// Objetivos
						'perdida1': 'pérdida de peso',
						'ganancia1': 'ganancia de peso',
						'mantenimiento1': 'mantenimiento',
						'mixto1': 'plan mixto',
						'sel': 'no seleccionado',
						// Fases de Pérdida
						'induccion_cetogenica1': 'inducción cetogénica',
						'ciclado_metabolico1': 'ciclado metabólico',
						'transicion_mantenimiento1': 'transición a mantenimiento',
						'ketoadaptation': 'ketoadaptación',
						// Fases de Ganancia
						'volumen1': 'volumen muscular',
						'masa1': 'enfoque en masa muscular',
						// Fases de Mantenimiento
						'equilibrio1': 'equilibrio flexible',
						'social1': 'adherencia social'
					};
					
					
			function getSelectedPhase2(objetivo) {
				switch (objetivo) {
					case 'perdida1':
						return document.getElementById('fasePerdida1')?.value || 'sel1';
					case 'ganancia1':
						return document.getElementById('faseGanancia1')?.value || 'sel2';
					case 'mantenimiento1':
						return document.getElementById('enfoqueMantenimiento1')?.value || 'sel3';
					case 'mixto1':
						return document.getElementById('faseMixto1')?.value || 'sel4';
					default:
						return 'sel';
				}
			}



		function abrirModalMacros() {
    const objetivo = document.getElementById('objetivo').value;
    const fase = getSelectedPhase2(objetivo);
    const faseLimpia = fase && fase.startsWith('sel') ? 'sel' : fase;

    const modal = new bootstrap.Modal(document.getElementById('modalMacros'));
    const modalWarning = document.getElementById('modal-warning');
    const modalContent = document.getElementById('modal-content');

    // Validar objetivo y fase
    if (objetivo === 'sel' || faseLimpia === 'sel') {
        modalWarning.style.display = 'block';
        modalContent.style.display = 'none';
        document.getElementById('modal-objetivo').textContent = 'No seleccionado';
        document.getElementById('modal-fase').textContent = 'No seleccionada';
        modal.show();
        return; // Salir temprano si no es válido
    }

    modalWarning.style.display = 'none';
    modalContent.style.display = 'block';

    // Mostrar objetivo y fase
    document.getElementById('modal-objetivo').textContent = mapaCodigos2[objetivo] || objetivo;
    document.getElementById('modal-fase').textContent = mapaCodigos2[faseLimpia] || faseLimpia;

    // === 1. Obtener valores de los inputs (si existen) ===
    let inputProteina = parseInt(document.getElementById('protein-percentage').value) || 30; // let en lugar de const
    let inputCarbo = parseInt(document.getElementById('carb-percentage').value) || 40;     // let en lugar de const
    let inputGrasa = parseInt(document.getElementById('fat-percentage').value) || 30;       // let en lugar de const

    // Validar que sumen 100%
    const total = inputProteina + inputCarbo + inputGrasa;
    if (Math.abs(total - 100) > 0.1) {
        console.warn("Los porcentajes no suman 100%. Ajustando grasas.");
        const diff = 100 - inputProteina - inputCarbo;
        const ajusteGrasa = Math.max(10, Math.min(80, diff)); // rango razonable
        document.getElementById('fat-percentage').value = ajusteGrasa;
        // Actualizamos inputGrasa para usarlo (ahora es let, por eso se puede reasignar)
        inputGrasa = ajusteGrasa;
    }

    // === 2. Mostrar rangos recomendados (igual que antes) ===
    const rangos = {
        // Pérdida
        perdida1: { p: [20, 30], c: [10, 25], g: [50, 70] },
        induccion_cetogenica1: { p: [20, 25], c: [5, 10], g: [70, 75] },
        ciclado_metabolico1: { p: [22, 28], c: [8, 20], g: [60, 70] },
        transicion_mantenimiento1: { p: [25, 30], c: [20, 25], g: [40, 50] },
        // Ganancia
        ganancia1: { p: [25, 30], c: [40, 50], g: [25, 35] },
        volumen1: { p: [25, 30], c: [40, 50], g: [25, 35] },
        masa1: { p: [25, 30], c: [35, 45], g: [30, 35] },
        // Mantenimiento
        mantenimiento1: { p: [20, 25], c: [35, 45], g: [30, 35] },
        equilibrio1: { p: [20, 25], c: [35, 45], g: [30, 35] },
        social1: { p: [20, 25], c: [30, 50], g: [25, 40] },
        // Mixto
        mixto1: { p: [20, 25], c: [30, 40], g: [35, 50] },
        definicion1: { p: [25, 35], c: [10, 25], g: [40, 55] }
    };

    const codigo = rangos[faseLimpia] ? faseLimpia : objetivo;
    const r = rangos[codigo] || { p: [25, 35], c: [30, 50], g: [25, 40] };

    // Mostrar rangos recomendados
    document.getElementById('proteinasRango').textContent = `${r.p[0]}-${r.p[1]}%`;
    document.getElementById('carbohidratosRango').textContent = `${r.c[0]}-${r.c[1]}%`;
    document.getElementById('grasasRango').textContent = `${r.g[0]}-${r.g[1]}%`;

    // === 3. Establecer valores iniciales desde los inputs ===
    document.getElementById('proteinasRange').value = inputProteina;
    document.getElementById('carbohidratosRange').value = inputCarbo;
    document.getElementById('grasasRange').value = inputGrasa;

    document.getElementById('proteinasValue').textContent = inputProteina;
    document.getElementById('carbohidratosValue').textContent = inputCarbo;
    document.getElementById('grasasValue').textContent = inputGrasa;

    // === 4. Consejo por objetivo ===
    const consejos = {
        perdida1: 'Prioriza proteína para preservar músculo.',
        ganancia1: 'Carbohidratos altos en días de entreno mejoran la hipertrofia.',
        mantenimiento1: 'Equilibrio flexible mejora la adherencia a largo plazo.',
        mixto1: 'Alterna días de HC alto y bajo para mantener metabolismo activo.'
    };
    document.getElementById('modal-consejo').textContent = consejos[objetivo] || 'Ajusta los macros según tu objetivo.';

    // === 5. Sincronizar sliders con inputs y total ===
    function actualizarSliders() {
        const p = +document.getElementById('proteinasRange').value;
        const c = +document.getElementById('carbohidratosRange').value;
        let g = 100 - p - c;

        if (g < 10) {
            g = 10;
            const diff = 10 - g;
            const restante = 100 - p - 10;
            if (c > restante) {
                document.getElementById('carbohidratosRange').value = restante;
                document.getElementById('carbohidratosValue').textContent = restante;
            }
        }

        document.getElementById('grasasRange').value = g;
        document.getElementById('proteinasValue').textContent = p;
        document.getElementById('carbohidratosValue').textContent = c;
        document.getElementById('grasasValue').textContent = g;

        // Actualizar input ocultos (opcional)
        document.getElementById('protein-percentage').value = p;
        document.getElementById('carb-percentage').value = c;
        document.getElementById('fat-percentage').value = g;

        // Actualizar total visual
        document.getElementById('macro-percentage-total').textContent = `Total: ${p + c + g}%`;
        if (p + c + g !== 100) {
            document.getElementById('macro-percentage-total').style.color = 'red';
        } else {
            document.getElementById('macro-percentage-total').style.color = 'green';
        }
    } // <--- CIERRA LA LLAVE DE actualizarSliders

    // Asignar eventos (ahora está claramente fuera de actualizarSliders)
    ['proteinas', 'carbohidratos', 'grasas'].forEach(nut => {
        document.getElementById(`${nut}Range`).oninput = actualizarSliders;
    });

    // Llamar una vez para inicializar
    actualizarSliders();

    modal.show();
} // <--- CIERRA LA LLAVE DE abrirModalMacros

	
	
				//////Guardar y llamar a calcularMacros()/////////////////
				document.getElementById('guardarMacros').addEventListener('click', function () {
				const objetivo = document.getElementById('objetivo').value;
				const fase = getSelectedPhase2(objetivo);
				const faseLimpia = fase && fase.startsWith('sel') ? 'sel' : fase;

				if (objetivo === 'sel' || faseLimpia === 'sel') {
					alert('Por favor, selecciona primero un objetivo y una fase.');
					return;
				}

				const proteinas = parseInt(document.getElementById('proteinasRange').value);
				const carbohidratos = parseInt(document.getElementById('carbohidratosRange').value);
				const grasas = parseInt(document.getElementById('grasasRange').value);

				// ✅ Actualizar inputs
				document.getElementById('protein-percentage').value = proteinas;
				document.getElementById('carb-percentage').value = carbohidratos;
				document.getElementById('fat-percentage').value = grasas;

				// ✅ Guardar en objeto global
				if (!window.macrosConfiguracionManual[objetivo]) {
					window.macrosConfiguracionManual[objetivo] = {};
				}
				window.macrosConfiguracionManual[objetivo][faseLimpia] = { proteinas, carbohidratos, grasas };

				// Cerrar modal
				bootstrap.Modal.getInstance(document.getElementById('modalMacros')).hide();

				// Llamar a calcularMacros con modo manual
				calcularMacros(true);
			});

</script>

</body>
</html>





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































