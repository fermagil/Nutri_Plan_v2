<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Salud Mental para Adolescentes</title>
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #6b8cbc;
            --light: #f5f7fa;
            --dark: #333;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --border-radius: 8px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .page {
            display: none;
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .active {
            display: block;
        }
        
        .question-group {
            margin-bottom: 25px;
        }
        
        .question {
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .option {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option:hover {
            background-color: #f0f4ff;
        }
        
        .option.selected {
            background-color: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .text-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-top: 5px;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
        }
        
        .btn-secondary {
            background-color: #e9ecef;
            color: var(--dark);
        }
        
        .btn-secondary:hover {
            background-color: #dde2e6;
        }
        
        .result-container {
            text-align: center;
        }
        
        .result-level {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 20px 0;
            padding: 15px;
            border-radius: var(--border-radius);
        }
        
        .adequate {
            background-color: var(--success);
            color: white;
        }
        
        .moderate {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .urgent {
            background-color: var(--danger);
            color: white;
        }
        
        .recommendations {
            text-align: left;
            margin-top: 30px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
        }
        
        .demographic-data {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }
        
        .stats-container {
            margin-top: 30px;
        }
        
        .stats-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: var(--primary);
            transition: width 0.3s;
        }
        
        .disclaimer {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 30px;
            text-align: center;
        }
        
        .stats-info {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #6c757d;
            text-align: center;
        }
        
        @media (max-width: 600px) {
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .navigation {
                flex-direction: column;
                gap: 10px;
            }
            
            button {
                width: 100%;
            }
            
            .stats-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CUESTIONARIO SOBRE TU ESTADO EMOCIONAL Y SALUD MENTAL</h1>
            <p>Confidencial y anónimo - Este cuestionario tiene como objetivo conocer cómo te sientes últimamente. No hay respuestas buenas o malas. Sé sincero/a contigo mismo/a.</p>
        </header>
        <div class="counters-container" id="counters-container" style="display: none;">
          <h3>Respuestas Almacenadas en Firebase</h3>
          <p><strong>Total de Usuarios:</strong> <span id="total-responses">0</span></p>
          <p><strong>Por Sexo:</strong></p>
          <ul style="list-style: none; padding: 0;">
            <li>Chicos: <span id="chicos-count">0</span></li>
            <li>Chicas: <span id="chicas-count">0</span></li>
            <li>Otro/No especificado: <span id="otro-count">0</span></li>
          </ul>
        </div>        
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        
        <!-- Página de bienvenida -->
        <div class="page active" id="page-welcome">
            <h2>Bienvenido/a al test de salud mental</h2>
            <p>Este cuestionario te ayudará a evaluar tu estado emocional actual. Responde con sinceridad para obtener un resultado más preciso.</p>
            <p>El test consta de 15 preguntas divididas en 4 páginas. Tu información será confidencial y anónima.</p>
            <div class="navigation">
                <div></div>
                <button class="btn-primary" onclick="nextPage('page-welcome', 'page-1')">Comenzar test</button>
            </div>
        </div>
        
        <!-- Página 1: Preguntas 1-4 -->
        <div class="page" id="page-1">
            <div class="question-group">
                <div class="question">1. ¿Cómo te sientes en general últimamente? (Puedes marcar más de una si lo necesitas)</div>
                <div class="checkbox-group" id="q1-options">
                    <label class="checkbox-option"><input type="checkbox" name="q1" value="Feliz"> Feliz</label>
                    <label class="checkbox-option"><input type="checkbox" name="q1" value="Triste"> Triste</label>
                    <label class="checkbox-option"><input type="checkbox" name="q1" value="Cansado/a"> Cansado/a</label>
                    <label class="checkbox-option"><input type="checkbox" name="q1" value="Nervioso/a"> Nervioso/a</label>
                    <label class="checkbox-option"><input type="checkbox" name="q1" value="Relajado/a"> Relajado/a</label>
                    <label class="checkbox-option"><input type="checkbox" name="q1" value="Enfadado/a"> Enfadado/a</label>
                    <label class="checkbox-option"><input type="checkbox" name="q1" value="Ansioso/a"> Ansioso/a</label>
                    <label class="checkbox-option"><input type="checkbox" name="q1" value="Motivado/a"> Motivado/a</label>
                    <label class="checkbox-option"><input type="checkbox" name="q1" value="Desmotivado/a"> Desmotivado/a</label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="q1" value="Otro" id="q1-otro-check"> Otro: 
                        <input type="text" id="q1-otro-text" class="text-input" placeholder="Especificar" style="display: none;">
                    </label>
                </div>
            </div>
            
            <div class="question-group">
                <div class="question">2. ¿Con qué frecuencia te sientes triste o decaído/a sin saber bien por qué?</div>
                <div class="options">
                    <div class="option" onclick="selectOption(this, 'q2')">Nunca</div>
                    <div class="option" onclick="selectOption(this, 'q2')">A veces</div>
                    <div class="option" onclick="selectOption(this, 'q2')">A menudo</div>
                    <div class="option" onclick="selectOption(this, 'q2')">Casi todos los días</div>
                </div>
            </div>
            
            <div class="question-group">
                <div class="question">3. ¿Te cuesta concentrarte en clase o al estudiar?</div>
                <div class="options">
                    <div class="option" onclick="selectOption(this, 'q3')">No</div>
                    <div class="option" onclick="selectOption(this, 'q3')">A veces</div>
                    <div class="option" onclick="selectOption(this, 'q3')">Sí, bastante</div>
                    <div class="option" onclick="selectOption(this, 'q3')">Sí, casi siempre</div>
                </div>
            </div>
            
            <div class="question-group">
                <div class="question">4. ¿Cómo describirías tu nivel de estrés en las últimas semanas?</div>
                <div class="options">
                    <div class="option" onclick="selectOption(this, 'q4')">Bajo</div>
                    <div class="option" onclick="selectOption(this, 'q4')">Moderado</div>
                    <div class="option" onclick="selectOption(this, 'q4')">Alto</div>
                    <div class="option" onclick="selectOption(this, 'q4')">Muy alto</div>
                </div>
            </div>
            
            <div class="navigation">
                <button class="btn-secondary" onclick="prevPage('page-1', 'page-welcome')">Anterior</button>
                <button class="btn-primary" onclick="nextPage('page-1', 'page-2')">Siguiente</button>
            </div>
        </div>
        
        <!-- Página 2: Preguntas 5-8 -->
        <div class="page" id="page-2">
            <div class="question-group">
                <div class="question">5. ¿Sientes que tienes a alguien con quien hablar cuando estás mal?</div>
                <div class="options">
                    <div class="option" onclick="selectOption(this, 'q5')">Sí, siempre</div>
                    <div class="option" onclick="selectOption(this, 'q5')">A veces</div>
                    <div class="option" onclick="selectOption(this, 'q5')">Rara vez</div>
                    <div class="option" onclick="selectOption(this, 'q5')">No, nunca</div>
                </div>
            </div>
            
            <div class="question-group">
                <div class="question">6. ¿Te resulta fácil hablar de cómo te sientes?</div>
                <div class="options">
                    <div class="option" onclick="selectOption(this, 'q6')">Sí, sin problema</div>
                    <div class="option" onclick="selectOption(this, 'q6')">Depende de la persona</div>
                    <div class="option" onclick="selectOption(this, 'q6')">Me cuesta un poco</div>
                    <div class="option" onclick="selectOption(this, 'q6')">Me resulta muy difícil</div>
                </div>
            </div>
            
            <div class="question-group">
                <div class="question">7. ¿Duermes bien por las noches?</div>
                <div class="options">
                    <div class="option" onclick="selectOption(this, 'q7')">Sí, duermo bien y me despierto descansado/a</div>
                    <div class="option" onclick="selectOption(this, 'q7')">Duermo, pero me despierto cansado/a</div>
                    <div class="option" onclick="selectOption(this, 'q7')">Me cuesta dormir</div>
                    <div class="option" onclick="selectOption(this, 'q7')">Duermo muy poco o mal casi siempre</div>
                </div>
            </div>
            
            <div class="question-group">
                <div class="question">8. ¿Cómo te sientes contigo mismo/a (autoestima)?</div>
                <div class="options">
                    <div class="option" onclick="selectOption(this, 'q8')">Me gusto como soy</div>
                    <div class="option" onclick="selectOption(this, 'q8')">A veces dudo de mí</div>
                    <div class="option" onclick="selectOption(this, 'q8')">Me cuesta aceptarme</div>
                    <div class="option" onclick="selectOption(this, 'q8')">No me siento bien conmigo mismo/a</div>
                </div>
            </div>
            
            <div class="navigation">
                <button class="btn-secondary" onclick="prevPage('page-2', 'page-1')">Anterior</button>
                <button class="btn-primary" onclick="nextPage('page-2', 'page-3')">Siguiente</button>
            </div>
        </div>
        
        <!-- Página 3: Preguntas 9-12 -->
        <div class="page" id="page-3">
            <div class="question-group">
                <div class="question">9. ¿Cómo son tus relaciones con tus compañeros/as de clase?</div>
                <div class="options">
                    <div class="option" onclick="selectOption(this, 'q9')">Muy buenas</div>
                    <div class="option" onclick="selectOption(this, 'q9')">Normales</div>
                    <div class="option" onclick="selectOption(this, 'q9')">Tengo algunos problemas</div>
                    <div class="option" onclick="selectOption(this, 'q9')">Me siento solo/a o excluido/a</div>
                </div>
            </div>
            
            <div class="question-group">
                <div class="question">10. ¿Alguna vez has sentido que no puedes más o que nada tiene sentido?</div>
                <div class="options">
                    <div class="option" onclick="selectOption(this, 'q10')">Nunca</div>
                    <div class="option" onclick="selectOption(this, 'q10')">Alguna vez</div>
                    <div class="option" onclick="selectOption(this, 'q10')">A menudo</div>
                    <div class="option" onclick="selectOption(this, 'q10')">Prefiero no responder</div>
                </div>
            </div>
            
            <div class="question-group">
                <div class="question">11. ¿Has pensado en hacerte daño alguna vez? (Recuerda que puedes pedir ayuda, no estás solo/a)</div>
                <div class="options">
                    <div class="option" onclick="selectOption(this, 'q11')">No</div>
                    <div class="option" onclick="selectOption(this, 'q11')">Sí, alguna vez</div>
                    <div class="option" onclick="selectOption(this, 'q11')">Sí, varias veces</div>
                    <div class="option" onclick="selectOption(this, 'q11')">Prefiero no responder</div>
                </div>
            </div>
            
            <div class="question-group">
                <div class="question">12. ¿Qué cosas te ayudan a sentirte mejor cuando estás mal? (Puedes marcar todas las que apliquen)</div>
                <div class="checkbox-group" id="q12-options">
                    <label class="checkbox-option"><input type="checkbox" name="q12" value="Hablar"> Hablar con amigos o familia</label>
                    <label class="checkbox-option"><input type="checkbox" name="q12" value="Musica"> Escuchar música</label>
                    <label class="checkbox-option"><input type="checkbox" name="q12" value="Peliculas/Series"> Ver películas o series</label>
                    <label class="checkbox-option"><input type="checkbox" name="q12" value="Ejercicio"> Hacer ejercicio o salir a caminar</label>
                    <label class="checkbox-option"><input type="checkbox" name="q12" value="Videojuegos"> Jugar videojuegos</label>
                    <label class="checkbox-option"><input type="checkbox" name="q12" value="Descansar"> Estar solo/a y descansar</label>
                    <label class="checkbox-option"><input type="checkbox" name="q12" value="Hobbies"> Leer, dibujar u otro hobby</label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="q12" value="Otro" id="q12-otro-check"> Otro: 
                        <input type="text" id="q12-otro-text" class="text-input" placeholder="Especificar" style="display: none;">
                    </label>
                </div>
            </div>
            
            <div class="navigation">
                <button class="btn-secondary" onclick="prevPage('page-3', 'page-2')">Anterior</button>
                <button class="btn-primary" onclick="nextPage('page-3', 'page-4')">Siguiente</button>
            </div>
        </div>
        
        <!-- Página 4: Preguntas 13-15 y datos demográficos -->
         <div class="page" id="page-4">
        <div class="question-group">
            <div class="question">13. ¿Qué te gustaría que mejorara en tu colegio o entorno para sentirte mejor emocionalmente? (Puedes marcar varias opciones)</div>
            <div class="checkbox-group" id="q13-options">
                <label class="checkbox-option"><input type="checkbox" name="q13" value="Mas apoyo de profesores"> Más apoyo y comprensión de los profesores.</label>
                <label class="checkbox-option"><input type="checkbox" name="q13" value="Menos presion academica"> Menos presión con los exámenes y deberes.</label>
                <label class="checkbox-option"><input type="checkbox" name="q13" value="Mas actividades relajantes"> Más actividades relajantes o creativas (deporte, arte, música).</label>
                <label class="checkbox-option"><input type="checkbox" name="q13" value="Mejor ambiente entre companeros"> Un mejor ambiente y menos conflictos entre compañeros.</label>
                <label class="checkbox-option"><input type="checkbox" name="q13" value="Espacios para hablar"> Más espacios seguros para hablar de emociones (con orientadores, etc.).</label>
                <label class="checkbox-option"><input type="checkbox" name="q13" value="Zonas de descanso"> Zonas de descanso o tranquilas para usar en los recreos.</label>
                <label class="checkbox-option">
                    <input type="checkbox" name="q13" value="Otro" id="q13-otro-check"> Otro:
                    <input type="text" id="q13-otro-text" class="text-input" placeholder="Especificar" style="display: none;">
                </label>
            </div>
        </div>
            
            <div class="question-group">
                <div class="question">14. ¿Te gustaría que hubiera más espacios para hablar sobre emociones y salud mental en clase?</div>
                <div class="options">
                    <div class="option" onclick="selectOption(this, 'q14')">Sí</div>
                    <div class="option" onclick="selectOption(this, 'q14')">No</div>
                    <div class="option" onclick="selectOption(this, 'q14')">No lo sé</div>
                </div>
            </div>
            
            <div class="question-group">
                <div class="question">15. ¿Quieres dejar algún mensaje o compartir algo más sobre cómo te sientes? (Respuesta abierta y opcional)</div>
                <textarea class="text-input" id="q15" rows="3" placeholder="Escribe tu respuesta aquí..."></textarea>
            </div>
            
            <div class="demographic-data">
                <h3>Datos demográficos (opcionales)</h3>
                <div class="form-group">
                    <label for="gender">Género:</label>
                    <select id="gender">
                        <option value="">Seleccionar</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Femenino">Femenino</option>
                        <option value="No binario">No binario</option>
                        <option value="Prefiero no responder">Prefiero no responder</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="age">Rango de edad:</label>
                    <select id="age">
                        <option value="">Seleccionar</option>
                        <option value="11-12">11-12 años</option>
                        <option value="13-14">13-14 años</option>
                        <option value="15-16">15-16 años</option>
                        <option value="17-18">17-18 años</option>
                    </select>
                </div>
            </div>
            
            <div class="navigation">
                <button class="btn-secondary" onclick="prevPage('page-4', 'page-3')">Anterior</button>
                <button class="btn-primary" onclick="calculateMentalScore()">Calcular Resultado</button>
            </div>
        </div>
        
        <!-- Página de resultados -->
        <div class="page" id="page-results">
            <div class="result-container">
                <h2>Resultados de tu evaluación</h2>
                <div id="result-level" class="result-level"></div>
                <div id="result-description"></div>
                
                <div class="recommendations">
                    <h3>Recomendaciones</h3>
                    <div id="recommendations-content"></div>
                </div>
                
                <div class="navigation">
                    <button class="btn-secondary" onclick="prevPage('page-results', 'page-4')">Volver al test</button>
                    <button class="btn-primary" onclick="showStats()">Ver Estadísticas</button>
                </div>
            </div>
        </div>
        
        <!-- Página de estadísticas -->
        <div class="page" id="page-stats">
            <h2>Estadísticas por género y edad</h2>
            <div class="stats-controls">
                <select id="stats-filter">
                    <option value="all">Todos los resultados</option>
                    <option value="gender">Filtrar por género</option>
                    <option value="age">Filtrar por edad</option>
                </select>
                <select id="gender-filter" style="display: none;">
                    <option value="Masculino">Masculino</option>
                    <option value="Femenino">Femenino</option>
                    <option value="No binario">No binario</option>
                </select>
                <select id="age-filter" style="display: none;">
                    <option value="11-12">11-12 años</option>
                    <option value="13-14">13-14 años</option>
                    <option value="15-16">15-16 años</option>
                    <option value="17-18">17-18 años</option>
                </select>
                <button class="btn-primary" onclick="loadStatistics()">Cargar estadísticas</button>
            </div>
            
            <div class="chart-container">
                <h3>Distribución de resultados</h3>
                <canvas id="results-chart" width="400" height="200"></canvas>
                <div class="stats-info" id="chart-info"></div>
            </div>
            
            <div class="chart-container">
                <h3>Porcentajes por categoría</h3>
                <canvas id="percentage-chart" width="400" height="200"></canvas>
            </div>
            
            <div class="navigation">
                <button class="btn-secondary" onclick="prevPage('page-stats', 'page-results')">Volver a resultados</button>
            </div>
        </div>
        
        <div class="disclaimer">
            <p><strong>Recuerda:</strong> Si estás pasando por un momento difícil, hablar con alguien puede ayudarte. Puedes acudir a tu tutor/a, a la orientadora del centro, a tus padres, o a alguien en quien confíes. No estás solo/a.</p>
            <p>Este test es una herramienta de autoevaluación y no sustituye el diagnóstico profesional.</p>
        </div>
    </div>

    <script type="module">
  // 1. Importar Firebase desde CDN (módulos)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, getIdTokenResult } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // 2. Configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyChC7s5NN-z-dSjqeXDaks7gaNaVCJAu7Q",
    authDomain: "nutriplanv2.firebaseapp.com",
    projectId: "nutriplanv2",
    storageBucket: "nutriplanv2.firebasestorage.app",
    messagingSenderId: "653707489758",
    appId: "1:653707489758:web:9133d1d1620825c385ed4f",
    measurementId: "G-NWER69E8B6"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // 3. Variables globales
  let currentPage = 'page-welcome';
  let answers = {};
  let statistics = {
    adequate: 0,
    moderate: 0,
    urgent: 0,
    total: 0
  };

  // 4. Funciones de navegación y lógica
  function nextPage(current, next) {
    document.getElementById(current).classList.remove('active');
    document.getElementById(next).classList.add('active');
    currentPage = next;
    updateProgress();
  }
  function prevPage(current, prev) {
    document.getElementById(current).classList.remove('active');
    document.getElementById(prev).classList.add('active');
    currentPage = prev;
    updateProgress();
  }
  function updateProgress() {
    const progress = document.getElementById('progress');
    let width = 0;
    switch(currentPage) {
      case 'page-welcome': width = 0; break;
      case 'page-1': width = 25; break;
      case 'page-2': width = 50; break;
      case 'page-3': width = 75; break;
      case 'page-4': width = 100; break;
      case 'page-results': width = 100; break;
      case 'page-stats': width = 100; break;
    }
    progress.style.width = width + '%';
  }
  function selectOption(element, questionId) {
    const parent = element.parentElement;
    const options = parent.querySelectorAll('.option');
    options.forEach(opt => opt.classList.remove('selected'));
    element.classList.add('selected');
    answers[questionId] = element.textContent;
  }
  function setupOtroCheckbox(checkId, textId) {
    const otroCheck = document.getElementById(checkId);
    const otroText = document.getElementById(textId);
    if (otroCheck) {
      otroCheck.addEventListener('change', function() {
        if (this.checked) {
          otroText.style.display = 'block';
        } else {
          otroText.style.display = 'none';
          otroText.value = '';
        }
      });
    }
  }

  // Función para iniciar el test
  function startTestMental() {
    answers = {};
    nextPage('page-welcome', 'page-1');
  }

  // Cálculo de resultados
 function calculateMentalScore() {
    // Recopilar respuestas de checkboxes para q1
    const q1Checkboxes = document.querySelectorAll('input[name="q1"]:checked');
    let q1Values = [];
    q1Checkboxes.forEach(checkbox => {
        if (checkbox.value === 'Otro') {
            const otroText = document.getElementById('q1-otro-text').value;
            if (otroText) q1Values.push(`Otro: ${otroText}`);
        } else {
            q1Values.push(checkbox.value);
        }
    });
    answers.q1 = q1Values.join(', ');

    // Recopilar otras respuestas de checkboxes
    const q12Checkboxes = document.querySelectorAll('input[name="q12"]:checked');
    let q12Values = [];
    q12Checkboxes.forEach(checkbox => {
        if (checkbox.value === 'Otro') {
            const otroText = document.getElementById('q12-otro-text').value;
            if (otroText) q12Values.push(`Otro: ${otroText}`);
        } else {
            q12Values.push(checkbox.value);
        }
    });
    answers.q12 = q12Values.join(', ');

    const q13Checkboxes = document.querySelectorAll('input[name="q13"]:checked');
    let q13Values = [];
    q13Checkboxes.forEach(checkbox => {
        if (checkbox.value === 'Otro') {
            const otroText = document.getElementById('q13-otro-text').value;
            if (otroText) q13Values.push(`Otro: ${otroText}`);
        } else {
            q13Values.push(checkbox.value);
        }
    });
    answers.q13 = q13Values.join(', ');
    answers.q14 = answers.q14 || '';
    answers.q15 = document.getElementById('q15').value;
    answers.gender = document.getElementById('gender').value;
    answers.age = document.getElementById('age').value;

    // Validación de campos requeridos
    let missing = [];
    if (!answers.gender) missing.push("Género");
    if (!answers.age) missing.push("Rango de Edad");
    for (let i = 2; i <= 11; i++) {
        const qId = 'q' + i;
        if (!answers[qId]) missing.push(qId.toUpperCase());
    }

    if (missing.length > 0) {
        alert("Por favor, responde a todas las preguntas requeridas y/o campos requeridos: " + missing.join(", "));
        return;
    }

    // Proceder con el cálculo si pasa la validación
    let score = 0;
    const scoreMap = {
      q2: {'A veces': 1, 'A menudo': 2, 'Casi todos los días': 3},
      q3: {'A veces': 1, 'Sí, bastante': 2, 'Sí, casi siempre': 3},
      q4: {'Moderado': 1, 'Alto': 2, 'Muy alto': 3},
      q5: {'A veces': 1, 'Rara vez': 2, 'No, nunca': 3},
      q6: {'Depende de la persona': 1, 'Me cuesta un poco': 2, 'Me resulta muy difícil': 3},
      q7: {'Duermo, pero me despierto cansado/a': 1, 'Me cuesta dormir': 2, 'Duermo muy poco o mal casi siempre': 3},
      q8: {'A veces dudo de mí': 1, 'Me cuesta aceptarme': 2, 'No me siento bien conmigo mismo/a': 3},
      q9: {'Normales': 0, 'Tengo algunos problemas': 2, 'Me siento solo/a o excluido/a': 3},
      q10: {'Alguna vez': 2, 'A menudo': 4, 'Prefiero no responder': 2},
      q11: {'Sí, alguna vez': 5, 'Sí, varias veces': 10, 'Prefiero no responder': 3}
    };
    for (const qId in scoreMap) {
      if (answers[qId] && scoreMap[qId][answers[qId]]) {
        score += scoreMap[qId][answers[qId]];
      }
    }

    let resultLevel, resultDescription, recommendations, resultLevelClass;
    const imminentRisk = 
      answers.q11 === 'Sí, alguna vez' || 
      answers.q11 === 'Sí, varias veces' ||
      (answers.q10 === 'A menudo' && answers.q2 === 'Casi todos los días');

    if (imminentRisk || score >= 22) {
      resultLevel = 'Atención Prioritaria';
      resultLevelClass = 'urgent';
      resultDescription = 'Tus respuestas sugieren que podrías estar pasando por un momento muy difícil. Es muy importante que hables con alguien de confianza o un profesional lo antes posible.';
      recommendations = `<p><strong>No estás solo/a. Por favor, considera estas acciones:</strong></p>
                         <ul>
                             <li>Habla inmediatamente con tus padres, un tutor/a, o la orientadora del centro.</li>
                             <li>Si sientes que no puedes hablar con nadie cercano, existen líneas de ayuda anónimas y gratuitas.</li>
                             <li>Recuerda que pedir ayuda es un acto de valentía y el primer paso para sentirte mejor.</li>
                         </ul>`;
      answers.resultLevel = 'Urgente';
    } else if (score >= 12) {
      resultLevel = 'Atención Moderada';
      resultLevelClass = 'moderate';
      resultDescription = 'Algunas de tus respuestas indican que podrías estar enfrentando algunos desafíos emocionales. Prestar atención a cómo te sientes es importante.';
      recommendations = `<p><strong>Aquí tienes algunas sugerencias que podrían ayudarte:</strong></p>
                         <ul>
                             <li>Intenta identificar qué situaciones te generan más estrés o tristeza y piensa en pequeños cambios que podrías hacer.</li>
                             <li>Asegúrate de dedicar tiempo a actividades que disfrutas y te relajan.</li>
                             <li>Considera hablar sobre cómo te sientes con amigos cercanos, familiares o el orientador/a del centro. A veces, compartirlo alivia mucho.</li>
                         </ul>`;
      answers.resultLevel = 'Moderado';
    } else {
      resultLevel = 'Bienestar Adecuado';
      resultLevelClass = 'adequate';
      resultDescription = 'Tus respuestas sugieren que, en general, tienes un buen manejo de tu bienestar emocional. ¡Sigue así!';
      recommendations = `<p><strong>Para mantener tu bienestar, te recomendamos:</strong></p>
                         <ul>
                             <li>Sigue practicando hábitos saludables como dormir lo suficiente, comer bien y hacer ejercicio.</li>
                             <li>Continúa apoyándote en tus amigos y familia. Las relaciones sociales son un pilar fundamental.</li>
                             <li>No dejes de dedicar tiempo a tus hobbies y a las cosas que te hacen feliz.</li>
                         </ul>`;
      answers.resultLevel = 'Adecuado';
    }

    const resultLevelElement = document.getElementById('result-level');
    resultLevelElement.textContent = resultLevel;
    resultLevelElement.className = 'result-level ' + resultLevelClass;
    document.getElementById('result-description').textContent = resultDescription;
    document.getElementById('recommendations-content').innerHTML = recommendations;
    saveResults(score, resultLevel);
    nextPage('page-4', 'page-results');
}

  // Guardar resultados en Firestore
  async function saveResults(score, classification) {
    const resultData = {
      answers: answers,
      score: score,
      classification: classification,
      timestamp: serverTimestamp(),
      gender: answers.gender,
      age: answers.age
    };
    try {
      await addDoc(collection(db, "resultadosSaludMental"), resultData);
      console.log("Resultado guardado");
    } catch (error) {
      console.error("Error al guardar resultado: ", error);
    }
  }

  // Resetear el test
  function resetMentalTest() {
    answers = {};
    currentPage = 'page-welcome';
    updateProgress();
    // Resetear selecciones en UI
    const options = document.querySelectorAll('.option.selected');
    options.forEach(opt => opt.classList.remove('selected'));
    const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
    checkboxes.forEach(cb => cb.checked = false);
    const inputs = document.querySelectorAll('input[type="text"], select');
    inputs.forEach(input => input.value = '');
    nextPage(currentPage, 'page-welcome');
  }

  // Exportar datos a CSV
  async function exportMentalData() {
    try {
      const querySnapshot = await getDocs(collection(db, "resultadosSaludMental"));
      let csv = 'Gender,Age,Score,Classification,Timestamp,ResultLevel\n';
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        csv += `${data.gender},${data.age},${data.score},${data.classification},${data.timestamp?.toDate()?.toISOString() || ''},${data.answers.resultLevel}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'mental_health_data.csv';
      a.click();
      URL.revokeObjectURL(url);
    } catch (error) {
      console.error("Error al exportar datos: ", error);
    }
  }

  // Estadísticas
function showStats() {
  let pass = prompt("Introduce la contraseña para ver estadísticas:");
  if (pass === "healthy_Friday_2025") {
    nextPage('page-results', 'page-stats');
    loadStatistics();
  } else {
    alert("Contraseña incorrecta");
  }
}
  async function loadStatistics() {
    let q = collection(db, "resultadosSaludMental");
    const filterType = document.getElementById('stats-filter').value;
    if (filterType === 'gender') {
      const gender = document.getElementById('gender-filter').value;
      if (gender) q = query(q, where('gender', '==', gender));
    } else if (filterType === 'age') {
      const age = document.getElementById('age-filter').value;
      if (age) q = query(q, where('age', '==', age));
    }
    try {
      const querySnapshot = await getDocs(q);
      statistics = { adequate: 0, moderate: 0, urgent: 0, total: 0 };
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        if (data.answers.resultLevel === 'Adecuado') statistics.adequate++;
        else if (data.answers.resultLevel === 'Moderado') statistics.moderate++;
        else if (data.answers.resultLevel === 'Urgente') statistics.urgent++;
        statistics.total++;
      });
      displayCharts();
    } catch (error) {
      console.error("Error al cargar estadísticas: ", error);
    }
  }

  // Cargar contadores (preload de estadísticas generales)
  async function loadCounters() {
    try {
      const querySnapshot = await getDocs(collection(db, "resultadosSaludMental"));
      statistics = { adequate: 0, moderate: 0, urgent: 0, total: 0 };
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        if (data.answers.resultLevel === 'Adecuado') statistics.adequate++;
        else if (data.answers.resultLevel === 'Moderado') statistics.moderate++;
        else if (data.answers.resultLevel === 'Urgente') statistics.urgent++;
        statistics.total++;
      });
      // Aquí podrías actualizar algún elemento UI con los contadores si es necesario
      console.log("Contadores cargados:", statistics);
    } catch (error) {
      console.error("Error al cargar contadores: ", error);
    }
  }

  // Gráficos
  function displayCharts() {
    const ctx = document.getElementById('results-chart').getContext('2d');
    if (window.resultsChart) window.resultsChart.destroy();
    const maxValue = Math.max(statistics.adequate, statistics.moderate, statistics.urgent);
    let suggestedMax = maxValue <= 10 ? 10 : 
                       maxValue <= 50 ? Math.ceil(maxValue / 10) * 10 :
                       maxValue <= 100 ? Math.ceil(maxValue / 25) * 25 :
                       Math.ceil(maxValue / 100) * 100;

    window.resultsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Salud Adecuada', 'Necesita Atención', 'Urgente'],
        datasets: [{
          label: 'Número de Personas',
          data: [statistics.adequate, statistics.moderate, statistics.urgent],
          backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
          borderColor: ['#218838', '#e0a800', '#c82333'],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Número de Personas' },
            suggestedMax: suggestedMax,
            ticks: { stepSize: suggestedMax <= 50 ? 5 : Math.ceil(suggestedMax / 10) }
          },
          x: {
            title: { display: true, text: 'Nivel de Salud Mental' }
          }
        },
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'Distribución de Resultados (Números Absolutos)' }
        }
      }
    });

    document.getElementById('chart-info').textContent = `Total de respuestas: ${statistics.total} `;

    const ctx2 = document.getElementById('percentage-chart').getContext('2d');
    if (window.percentageChart) window.percentageChart.destroy();
    const percentages = {
      adequate: statistics.total > 0 ? (statistics.adequate / statistics.total * 100).toFixed(1) : 0,
      moderate: statistics.total > 0 ? (statistics.moderate / statistics.total * 100).toFixed(1) : 0,
      urgent: statistics.total > 0 ? (statistics.urgent / statistics.total * 100).toFixed(1) : 0
    };
    window.percentageChart = new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: ['Salud Adecuada', 'Necesita Atención', 'Urgente'],
        datasets: [{
          data: [percentages.adequate, percentages.moderate, percentages.urgent],
          backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
          borderColor: ['#218838', '#e0a800', '#c82333'],
          borderWidth: 1
        }]
      },
      options: {
        plugins: {
          legend: { position: 'bottom' },
          title: { display: true, text: 'Distribución Porcentual' },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.label}: ${context.raw}%`;
              }
            }
          }
        }
      }
    });
  }

  // Manejo de filtros de estadísticas
  document.getElementById('stats-filter').addEventListener('change', function() {
    const genderFilter = document.getElementById('gender-filter');
    const ageFilter = document.getElementById('age-filter');
    genderFilter.style.display = 'none';
    ageFilter.style.display = 'none';
    if (this.value === 'gender') {
      genderFilter.style.display = 'inline-block';
    } else if (this.value === 'age') {
      ageFilter.style.display = 'inline-block';
    }
  });

  // Inicialización
  document.addEventListener('DOMContentLoaded', function() {
    updateProgress();
    setupOtroCheckbox('q1-otro-check', 'q1-otro-text');
    setupOtroCheckbox('q12-otro-check', 'q12-otro-text');
    setupOtroCheckbox('q13-otro-check', 'q13-otro-text');
  });

  // 6. Protección y arranque
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const token = await user.getIdTokenResult();
      if (token.claims.rol === "salud_escolar") {
        // ✅ Acceso permitido
        await loadCounters();
        // Exponer funciones globales
        window.startTestMental = startTestMental;
        window.nextPage = nextPage;
        window.prevPage = prevPage;
        window.calculateMentalScore = calculateMentalScore;
        window.exportMentalData = exportMentalData;
        window.resetMentalTest = resetMentalTest;
        window.showStats = showStats;
        window.loadStatistics = loadStatistics;
        window.selectOption = selectOption;
        window.logout = () => {
          signOut(auth).then(() => {
            window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
          }).catch((error) => {
            console.error("Error al cerrar sesión: ", error);
          });
        };
      } else {
        alert("Acceso denegado: solo profesores autorizados.");
        signOut(auth).then(() => {
          window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
        });
      }
    } else {
      window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
    }
  });
</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
